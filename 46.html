<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICE BofA Bond Indices - Premium Dashboard</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            /* Dark Theme (Default) */
            --bg-primary: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            --bg-secondary: rgba(20, 24, 44, 0.95);
            --bg-tertiary: rgba(255, 255, 255, 0.03);
            --bg-hover: rgba(0, 255, 136, 0.05);
            --border-primary: rgba(0, 255, 136, 0.2);
            --border-secondary: rgba(255, 255, 255, 0.1);
            --text-primary: #e0e0e0;
            --text-secondary: #888;
            --accent-green: #00ff88;
            --accent-blue: #00ccff;
            --accent-gold: #ffd700;
            --negative: #ff4444;
            --positive: #00ff88;
            --neutral: #888;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="light"] {
            --bg-primary: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.95);
            --bg-tertiary: rgba(0, 0, 0, 0.03);
            --bg-hover: rgba(0, 123, 255, 0.05);
            --border-primary: rgba(0, 123, 255, 0.3);
            --border-secondary: rgba(0, 0, 0, 0.1);
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --accent-green: #27ae60;
            --accent-blue: #3498db;
            --accent-gold: #f39c12;
            --negative: #e74c3c;
            --positive: #27ae60;
            --neutral: #95a5a6;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        /* Data Density Modes */
        [data-density="compact"] {
            --row-padding: 0.25rem;
            --font-size: 0.75rem;
            --header-height: 50px;
        }
        
        [data-density="comfortable"] {
            --row-padding: 0.75rem;
            --font-size: 0.875rem;
            --header-height: 70px;
        }
        
        [data-density="spacious"] {
            --row-padding: 1rem;
            --font-size: 1rem;
            --header-height: 90px;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: var(--font-size, 0.875rem);
            transition: all 0.3s ease;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 10000;
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 25px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-btn.active {
            border-color: var(--accent-green);
            background: var(--accent-green);
            color: #000;
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            height: var(--header-height, 70px);
            transition: all 0.3s;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, var(--accent-green), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* AI Search Bar */
        .ai-search-container {
            position: relative;
            flex: 1;
            max-width: 600px;
            margin: 0 2rem;
        }
        
        .ai-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 25px;
            color: var(--text-primary);
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .ai-search-input:focus {
            outline: none;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
        }
        
        .ai-search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .ai-search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 12px;
            margin-top: 0.5rem;
            box-shadow: 0 10px 20px var(--shadow);
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .ai-search-suggestions.active {
            display: block;
        }
        
        .search-suggestion {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .search-suggestion:hover {
            background: var(--bg-hover);
        }
        
        .search-highlight {
            background: var(--accent-gold);
            color: #000;
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            padding: 1rem;
            margin-top: 1rem;
        }
        
        .widget {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 12px;
            padding: 1rem;
            position: relative;
            transition: all 0.3s;
            cursor: move;
        }
        
        .widget.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-secondary);
        }
        
        .widget-title {
            font-weight: bold;
            color: var(--accent-green);
        }
        
        .widget-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .widget-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .widget-btn:hover {
            background: var(--accent-green);
            color: #000;
        }
        
        /* Quick Actions Menu */
        .quick-actions {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            display: none;
            gap: 0.25rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px var(--shadow);
        }
        
        tr:hover .quick-actions {
            display: flex;
        }
        
        .quick-action-btn {
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: var(--accent-green);
            color: #000;
            border-color: var(--accent-green);
        }
        
        /* Heatmap View */
        .heatmap-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 4px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin: 1rem 0;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 8px var(--shadow);
        }
        
        .heatmap-symbol {
            font-weight: bold;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        
        .heatmap-value {
            font-size: 0.625rem;
        }
        
        .heatmap-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            padding: 0.5rem;
            border-radius: 6px;
            white-space: nowrap;
            display: none;
            z-index: 1000;
        }
        
        .heatmap-cell:hover .heatmap-tooltip {
            display: block;
        }
        
        /* Historical Analysis Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
        }
        
        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: var(--negative);
        }
        
        /* Collaboration Features */
        .collab-panel {
            position: fixed;
            right: -400px;
            top: var(--header-height, 70px);
            bottom: 0;
            width: 400px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-secondary);
            transition: right 0.3s;
            z-index: 999;
            display: flex;
            flex-direction: column;
        }
        
        .collab-panel.active {
            right: 0;
        }
        
        .collab-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collab-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .annotation {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .annotation-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        .annotation-body {
            color: var(--text-primary);
        }
        
        /* AI Insights Panel */
        .ai-insights {
            background: linear-gradient(135deg, var(--bg-tertiary), transparent);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        .ai-insight-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-secondary);
        }
        
        .ai-insight-item:last-child {
            border-bottom: none;
        }
        
        .ai-insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent-green);
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .ai-insight-text {
            flex: 1;
        }
        
        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 600px;
            width: 90%;
        }
        
        .shortcut-group {
            margin-bottom: 1.5rem;
        }
        
        .shortcut-group-title {
            font-weight: bold;
            color: var(--accent-green);
            margin-bottom: 0.5rem;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-secondary);
        }
        
        .shortcut-key {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-secondary);
            border-radius: 4px;
            font-family: monospace;
            font-weight: bold;
        }
        
        /* Data Table Enhancements */
        .data-table {
            width: 100%;
            background: var(--bg-tertiary);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: var(--bg-secondary);
            padding: var(--row-padding);
            text-align: left;
            font-weight: bold;
            color: var(--accent-green);
            border-bottom: 1px solid var(--border-secondary);
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: var(--row-padding);
            border-bottom: 1px solid var(--border-secondary);
            position: relative;
        }
        
        .data-table tr {
            transition: background 0.2s;
        }
        
        .data-table tr:hover {
            background: var(--bg-hover);
        }
        
        /* Anomaly Detection Highlighting */
        .anomaly-indicator {
            position: absolute;
            top: 0;
            bottom: 0;
            left: -3px;
            width: 3px;
            background: var(--accent-gold);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Loading States */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
            height: 1rem;
            width: 100%;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                height: auto;
                padding: 0.5rem;
            }
            
            .ai-search-container {
                margin: 0.5rem 0;
                max-width: 100%;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .collab-panel {
                width: 100%;
                right: -100%;
            }
            
            .theme-toggle {
                top: auto;
                bottom: 1rem;
            }
        }
        
        /* Print Styles */
        @media print {
            .theme-toggle,
            .quick-actions,
            .widget-controls,
            .collab-panel {
                display: none !important;
            }
            
            body {
                background: white;
                color: black;
            }
        }
        
        /* Performance Optimizations */
        .will-change-transform {
            will-change: transform;
        }
        
        .gpu-accelerated {
            transform: translateZ(0);
            backface-visibility: hidden;
        }
    </style>
</head>
<body data-theme="dark" data-density="comfortable">
    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <button class="theme-btn active" onclick="setTheme('dark')" title="Dark Mode">🌙</button>
        <button class="theme-btn" onclick="setTheme('light')" title="Light Mode">☀️</button>
        <button class="theme-btn" onclick="setTheme('auto')" title="System Theme">🖥️</button>
    </div>
    
    <!-- Main Header -->
    <header class="header">
        <div class="logo">
            📊 ICE BofA Premium
        </div>
        
        <!-- AI-Powered Search -->
        <div class="ai-search-container">
            <span class="ai-search-icon">🔍</span>
            <input type="text" class="ai-search-input" id="aiSearch" placeholder='Try: "high yield bonds with spreads above 500" or "emerging markets performance"'>
            <div class="ai-search-suggestions" id="searchSuggestions"></div>
        </div>
        
        <!-- Header Controls -->
        <div style="display: flex; gap: 1rem; align-items: center;">
            <button onclick="toggleDensity()" title="Toggle Data Density">📏</button>
            <button onclick="toggleHeatmap()" title="Heatmap View">🗺️</button>
            <button onclick="openHistoricalAnalysis()" title="Historical Analysis">📈</button>
            <button onclick="toggleCollabPanel()" title="Collaboration">👥</button>
            <button onclick="showShortcuts()" title="Keyboard Shortcuts">⌨️</button>
        </div>
    </header>
    
    <!-- AI Insights Panel -->
    <div class="ai-insights" id="aiInsights" style="display: none;">
        <h3 style="margin-bottom: 1rem;">🤖 AI-Powered Market Insights</h3>
        <div id="insightsList"></div>
    </div>
    
    <!-- Dashboard Grid (Draggable Widgets) -->
    <div class="dashboard-grid" id="dashboardGrid">
        <!-- Market Overview Widget -->
        <div class="widget" data-widget-id="market-overview">
            <div class="widget-header">
                <span class="widget-title">Market Overview</span>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="refreshWidget('market-overview')">🔄</button>
                    <button class="widget-btn" onclick="expandWidget('market-overview')">⛶</button>
                    <button class="widget-btn" onclick="removeWidget('market-overview')">✕</button>
                </div>
            </div>
            <div class="widget-content" id="marketOverviewContent">
                <div class="skeleton"></div>
            </div>
        </div>
        
        <!-- Top Movers Widget -->
        <div class="widget" data-widget-id="top-movers">
            <div class="widget-header">
                <span class="widget-title">Top Movers</span>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="refreshWidget('top-movers')">🔄</button>
                    <button class="widget-btn" onclick="expandWidget('top-movers')">⛶</button>
                    <button class="widget-btn" onclick="removeWidget('top-movers')">✕</button>
                </div>
            </div>
            <div class="widget-content" id="topMoversContent">
                <div class="skeleton"></div>
            </div>
        </div>
        
        <!-- Anomalies Widget -->
        <div class="widget" data-widget-id="anomalies">
            <div class="widget-header">
                <span class="widget-title">🚨 Anomaly Detection</span>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="refreshWidget('anomalies')">🔄</button>
                    <button class="widget-btn" onclick="expandWidget('anomalies')">⛶</button>
                    <button class="widget-btn" onclick="removeWidget('anomalies')">✕</button>
                </div>
            </div>
            <div class="widget-content" id="anomaliesContent">
                <div class="skeleton"></div>
            </div>
        </div>
        
        <!-- Watchlist Widget -->
        <div class="widget" data-widget-id="watchlist">
            <div class="widget-header">
                <span class="widget-title">⭐ Watchlist</span>
                <div class="widget-controls">
                    <button class="widget-btn" onclick="refreshWidget('watchlist')">🔄</button>
                    <button class="widget-btn" onclick="expandWidget('watchlist')">⛶</button>
                    <button class="widget-btn" onclick="removeWidget('watchlist')">✕</button>
                </div>
            </div>
            <div class="widget-content" id="watchlistContent">
                <div class="skeleton"></div>
            </div>
        </div>
    </div>
    
    <!-- Heatmap View -->
    <div class="heatmap-container" id="heatmapView" style="display: none;"></div>
    
    <!-- Main Data Table -->
    <div style="padding: 1rem;">
        <div class="data-table">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('favorite')">⭐</th>
                        <th onclick="sortTable('id')">Series ID</th>
                        <th onclick="sortTable('name')">Description</th>
                        <th onclick="sortTable('value')">Value</th>
                        <th onclick="sortTable('wow')">WoW%</th>
                        <th onclick="sortTable('mom')">MoM%</th>
                        <th onclick="sortTable('qoq')">QoQ%</th>
                        <th onclick="sortTable('yoy')">YoY%</th>
                        <th onclick="sortTable('updated')">Updated</th>
                    </tr>
                </thead>
                <tbody id="mainTableBody">
                    <tr><td colspan="9" style="text-align: center; padding: 2rem;">Initializing premium dashboard...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Collaboration Panel -->
    <div class="collab-panel" id="collabPanel">
        <div class="collab-header">
            <h3>Team Collaboration</h3>
            <button onclick="toggleCollabPanel()">✕</button>
        </div>
        <div class="collab-content">
            <div style="margin-bottom: 1rem;">
                <button onclick="shareView()" style="width: 100%; padding: 0.75rem; background: var(--accent-green); color: #000; border: none; border-radius: 6px; cursor: pointer;">📤 Share Current View</button>
            </div>
            
            <h4 style="margin-bottom: 0.5rem;">Recent Annotations</h4>
            <div id="annotationsList">
                <div class="annotation">
                    <div class="annotation-header">
                        <span>John Doe</span>
                        <span>2 hours ago</span>
                    </div>
                    <div class="annotation-body">
                        Fed meeting impact visible on EM spreads - watching closely for further widening.
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <textarea placeholder="Add annotation..." style="width: 100%; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); border-radius: 6px; color: var(--text-primary); resize: vertical;"></textarea>
                <button onclick="addAnnotation()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: var(--accent-blue); color: #000; border: none; border-radius: 4px; cursor: pointer;">Post</button>
            </div>
        </div>
    </div>
    
    <!-- Historical Analysis Modal -->
    <div class="modal" id="historicalModal">
        <div class="modal-content" style="width: 90%; max-width: 1200px;">
            <button class="modal-close" onclick="closeHistoricalAnalysis()">✕</button>
            <h2 style="margin-bottom: 1rem;">Historical Analysis Suite</h2>
            
            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <button onclick="showBacktest()" style="padding: 0.5rem 1rem; background: var(--accent-green); color: #000; border: none; border-radius: 4px; cursor: pointer;">Backtesting</button>
                <button onclick="showEventImpact()" style="padding: 0.5rem 1rem; background: var(--accent-blue); color: #000; border: none; border-radius: 4px; cursor: pointer;">Event Impact</button>
                <button onclick="showSeasonality()" style="padding: 0.5rem 1rem; background: var(--accent-gold); color: #000; border: none; border-radius: 4px; cursor: pointer;">Seasonality</button>
                <button onclick="showRegimeChange()" style="padding: 0.5rem 1rem; background: var(--negative); color: #fff; border: none; border-radius: 4px; cursor: pointer;">Regime Detection</button>
            </div>
            
            <div id="historicalContent" style="min-height: 400px;">
                <div id="historicalChart"></div>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="shortcuts-modal">
            <button class="modal-close" onclick="closeShortcuts()">✕</button>
            <h2 style="margin-bottom: 1rem;">⌨️ Keyboard Shortcuts</h2>
            
            <div class="shortcut-group">
                <div class="shortcut-group-title">Navigation</div>
                <div class="shortcut-item">
                    <span>Search</span>
                    <span class="shortcut-key">/</span>
                </div>
                <div class="shortcut-item">
                    <span>Refresh Data</span>
                    <span class="shortcut-key">R</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Theme</span>
                    <span class="shortcut-key">T</span>
                </div>
                <div class="shortcut-item">
                    <span>Heatmap View</span>
                    <span class="shortcut-key">H</span>
                </div>
            </div>
            
            <div class="shortcut-group">
                <div class="shortcut-group-title">Data</div>
                <div class="shortcut-item">
                    <span>Export CSV</span>
                    <span class="shortcut-key">E</span>
                </div>
                <div class="shortcut-item">
                    <span>Clear Cache</span>
                    <span class="shortcut-key">C</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Density</span>
                    <span class="shortcut-key">D</span>
                </div>
            </div>
            
            <div class="shortcut-group">
                <div class="shortcut-group-title">Collaboration</div>
                <div class="shortcut-item">
                    <span>Share View</span>
                    <span class="shortcut-key">S</span>
                </div>
                <div class="shortcut-item">
                    <span>Add Annotation</span>
                    <span class="shortcut-key">A</span>
                </div>
                <div class="shortcut-item">
                    <span>Toggle Collaboration Panel</span>
                    <span class="shortcut-key">P</span>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ============================================
        // Enhanced Configuration
        // ============================================
        const API_BASE = 'https://lnd6erie7y4rw2u6r4dpv4enty0mhtua.lambda-url.us-east-1.on.aws';
        const WEBHOOK_URL = ''; // Add webhook URL for notifications
        const SLACK_WEBHOOK = ''; // Add Slack webhook
        
        // ============================================
        // Global State Management
        // ============================================
        const state = {
            theme: 'dark',
            density: 'comfortable',
            view: 'table',
            data: [],
            metadata: {},
            filters: [],
            searchHistory: [],
            annotations: [],
            anomalies: [],
            favorites: new Set(),
            widgets: ['market-overview', 'top-movers', 'anomalies', 'watchlist'],
            collaborators: [],
            naturalLanguageQueries: []
        };
        
        // ============================================
        // Theme Management
        // ============================================
        function setTheme(theme) {
            if (theme === 'auto') {
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                theme = prefersDark ? 'dark' : 'light';
            }
            
            document.body.setAttribute('data-theme', theme);
            state.theme = theme;
            localStorage.setItem('theme', theme);
            
            // Update theme buttons
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function toggleDensity() {
            const densities = ['compact', 'comfortable', 'spacious'];
            const current = document.body.getAttribute('data-density');
            const index = densities.indexOf(current);
            const next = densities[(index + 1) % densities.length];
            
            document.body.setAttribute('data-density', next);
            state.density = next;
            localStorage.setItem('density', next);
        }
        
        // ============================================
        // AI-Powered Search
        // ============================================
        class NaturalLanguageProcessor {
            constructor() {
                this.patterns = {
                    yields: /yield|ytm|ytw/i,
                    spreads: /spread|oas|basis points|bps/i,
                    highYield: /high yield|hy|junk/i,
                    emergingMarkets: /emerging|em|developing/i,
                    investmentGrade: /investment grade|ig/i,
                    above: /above|greater than|over|>|more than/i,
                    below: /below|less than|under|<|smaller than/i,
                    between: /between|from.*to|range/i,
                    performance: /performance|return|gain|loss/i,
                    volatility: /volatility|vol|variance|std/i
                };
            }
            
            parse(query) {
                const result = {
                    type: null,
                    filters: [],
                    comparisons: [],
                    timeframe: null
                };
                
                // Detect query type
                for (const [key, pattern] of Object.entries(this.patterns)) {
                    if (pattern.test(query)) {
                        result.type = key;
                        break;
                    }
                }
                
                // Extract numerical values
                const numbers = query.match(/\d+(\.\d+)?/g);
                if (numbers) {
                    result.values = numbers.map(n => parseFloat(n));
                }
                
                // Parse time references
                const timePatterns = {
                    today: /today/i,
                    week: /this week|week/i,
                    month: /this month|month/i,
                    year: /this year|year|ytd/i
                };
                
                for (const [key, pattern] of Object.entries(timePatterns)) {
                    if (pattern.test(query)) {
                        result.timeframe = key;
                        break;
                    }
                }
                
                return result;
            }
            
            executeQuery(query, data) {
                const parsed = this.parse(query);
                let filtered = [...data];
                
                // Apply filters based on parsed query
                if (parsed.type === 'highYield' && parsed.values) {
                    filtered = filtered.filter(item => {
                        const spread = parseFloat(item.spread);
                        return spread > (parsed.values[0] || 500);
                    });
                }
                
                // More filter logic here...
                
                return filtered;
            }
        }
        
        const nlp = new NaturalLanguageProcessor();
        
        // ============================================
        // Anomaly Detection
        // ============================================
        class AnomalyDetector {
            detectAnomalies(data) {
                const anomalies = [];
                
                data.forEach(series => {
                    // Z-score based anomaly detection
                    const values = [
                        series.changes?.['WoW%'],
                        series.changes?.['MoM%'],
                        series.changes?.['YoY%']
                    ].filter(v => v !== undefined);
                    
                    if (values.length > 0) {
                        const mean = values.reduce((a, b) => a + b, 0) / values.length;
                        const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                        const stdDev = Math.sqrt(variance);
                        
                        values.forEach((value, index) => {
                            const zScore = Math.abs((value - mean) / stdDev);
                            if (zScore > 2.5) { // Threshold for anomaly
                                anomalies.push({
                                    seriesId: series.id,
                                    type: ['WoW', 'MoM', 'YoY'][index],
                                    value: value,
                                    zScore: zScore,
                                    severity: zScore > 3 ? 'high' : 'medium'
                                });
                            }
                        });
                    }
                });
                
                return anomalies;
            }
            
            generateInsights(anomalies) {
                const insights = [];
                
                // Group anomalies by type
                const grouped = {};
                anomalies.forEach(a => {
                    if (!grouped[a.type]) grouped[a.type] = [];
                    grouped[a.type].push(a);
                });
                
                // Generate insights
                for (const [type, items] of Object.entries(grouped)) {
                    if (items.length > 3) {
                        insights.push({
                            icon: '⚠️',
                            text: `Unusual ${type} movements detected across ${items.length} indices`,
                            severity: 'high'
                        });
                    }
                }
                
                return insights;
            }
        }
        
        const anomalyDetector = new AnomalyDetector();
        
        // ============================================
        // Historical Analysis Functions
        // ============================================
        function openHistoricalAnalysis() {
            document.getElementById('historicalModal').classList.add('active');
            showBacktest(); // Default view
        }
        
        function closeHistoricalAnalysis() {
            document.getElementById('historicalModal').classList.remove('active');
        }
        
        function showBacktest() {
            const content = document.getElementById('historicalContent');
            
            // Mock backtesting interface
            content.innerHTML = `
                <h3>Strategy Backtesting</h3>
                <div style="margin: 1rem 0;">
                    <label>Strategy Type:</label>
                    <select style="margin-left: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); color: var(--text-primary);">
                        <option>Mean Reversion</option>
                        <option>Momentum</option>
                        <option>Spread Trading</option>
                        <option>Carry Trade</option>
                    </select>
                </div>
                <div id="backtestChart" style="height: 400px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <span>Backtest results will appear here</span>
                </div>
            `;
        }
        
        function showEventImpact() {
            const content = document.getElementById('historicalContent');
            
            content.innerHTML = `
                <h3>Event Impact Analysis</h3>
                <div style="margin: 1rem 0;">
                    <label>Select Event:</label>
                    <select style="margin-left: 0.5rem; padding: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-secondary); color: var(--text-primary);">
                        <option>Fed Rate Decision - Dec 2024</option>
                        <option>ECB Meeting - Nov 2024</option>
                        <option>China Stimulus - Oct 2024</option>
                        <option>Banking Crisis - Mar 2023</option>
                    </select>
                </div>
                <div style="height: 400px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <span>Event impact analysis will appear here</span>
                </div>
            `;
        }
        
        function showSeasonality() {
            const content = document.getElementById('historicalContent');
            
            content.innerHTML = `
                <h3>Seasonal Patterns</h3>
                <div style="height: 400px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <span>Seasonal pattern analysis will appear here</span>
                </div>
            `;
        }
        
        function showRegimeChange() {
            const content = document.getElementById('historicalContent');
            
            content.innerHTML = `
                <h3>Market Regime Detection</h3>
                <div style="height: 400px; background: var(--bg-tertiary); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <span>Regime change detection will appear here</span>
                </div>
            `;
        }
        
        // ============================================
        // Collaboration Features
        // ============================================
        function toggleCollabPanel() {
            document.getElementById('collabPanel').classList.toggle('active');
        }
        
        function shareView() {
            // Generate shareable URL with current filters and settings
            const params = new URLSearchParams({
                theme: state.theme,
                density: state.density,
                filters: JSON.stringify(state.filters),
                view: state.view
            });
            
            const shareUrl = `${window.location.origin}${window.location.pathname}?${params}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(shareUrl).then(() => {
                alert('View URL copied to clipboard!');
            });
        }
        
        function addAnnotation() {
            const textarea = document.querySelector('.collab-content textarea');
            const text = textarea.value.trim();
            
            if (!text) return;
            
            const annotation = {
                id: Date.now(),
                user: 'Current User',
                text: text,
                timestamp: new Date().toISOString()
            };
            
            state.annotations.push(annotation);
            
            // Update UI
            const annotationsList = document.getElementById('annotationsList');
            const annotationEl = document.createElement('div');
            annotationEl.className = 'annotation';
            annotationEl.innerHTML = `
                <div class="annotation-header">
                    <span>${annotation.user}</span>
                    <span>Just now</span>
                </div>
                <div class="annotation-body">${annotation.text}</div>
            `;
            annotationsList.insertBefore(annotationEl, annotationsList.firstChild);
            
            textarea.value = '';
            
            // Send to webhook if configured
            if (WEBHOOK_URL) {
                fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(annotation)
                });
            }
        }
        
        // ============================================
        // Heatmap View
        // ============================================
        function toggleHeatmap() {
            const heatmapView = document.getElementById('heatmapView');
            const mainTable = document.querySelector('.data-table').parentElement;
            
            if (state.view === 'heatmap') {
                heatmapView.style.display = 'none';
                mainTable.style.display = 'block';
                state.view = 'table';
            } else {
                heatmapView.style.display = 'grid';
                mainTable.style.display = 'none';
                state.view = 'heatmap';
                renderHeatmap();
            }
        }
        
        function renderHeatmap() {
            const container = document.getElementById('heatmapView');
            container.innerHTML = '';
            
            // Mock data for demonstration
            const mockData = [
                { id: 'H0A0', value: 5.67, change: 0.12 },
                { id: 'H0A1', value: 4.23, change: -0.08 },
                { id: 'H0A2', value: 6.89, change: 0.45 },
                { id: 'HY00', value: 423, change: 12 },
                { id: 'EM00', value: 567, change: -23 }
            ];
            
            mockData.forEach(item => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell';
                
                // Color based on performance
                const intensity = Math.min(Math.abs(item.change) * 20, 100);
                const color = item.change >= 0 
                    ? `rgba(0, 255, 136, ${intensity/100})`
                    : `rgba(255, 68, 68, ${intensity/100})`;
                
                cell.style.background = color;
                cell.innerHTML = `
                    <div class="heatmap-symbol">${item.id}</div>
                    <div class="heatmap-value">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)}%</div>
                    <div class="heatmap-tooltip">
                        <strong>${item.id}</strong><br>
                        Value: ${item.value}<br>
                        Change: ${item.change}%
                    </div>
                `;
                
                container.appendChild(cell);
            });
        }
        
        // ============================================
        // Widget Management
        // ============================================
        function initializeDragAndDrop() {
            const grid = document.getElementById('dashboardGrid');
            
            new Sortable(grid, {
                animation: 150,
                ghostClass: 'dragging',
                handle: '.widget-header',
                onEnd: function(evt) {
                    // Save widget order
                    const widgets = Array.from(grid.children).map(w => w.dataset.widgetId);
                    state.widgets = widgets;
                    localStorage.setItem('widgetOrder', JSON.stringify(widgets));
                }
            });
        }
        
        function refreshWidget(widgetId) {
            const content = document.querySelector(`[data-widget-id="${widgetId}"] .widget-content`);
            content.innerHTML = '<div class="skeleton"></div>';
            
            // Simulate data refresh
            setTimeout(() => {
                updateWidgetContent(widgetId);
            }, 1000);
        }
        
        function expandWidget(widgetId) {
            const widget = document.querySelector(`[data-widget-id="${widgetId}"]`);
            widget.style.gridColumn = widget.style.gridColumn === 'span 2' ? 'span 1' : 'span 2';
        }
        
        function removeWidget(widgetId) {
            const widget = document.querySelector(`[data-widget-id="${widgetId}"]`);
            widget.style.display = 'none';
            state.widgets = state.widgets.filter(id => id !== widgetId);
        }
        
        function updateWidgetContent(widgetId) {
            const content = document.getElementById(`${widgetId}Content`.replace('-', ''));
            
            switch(widgetId) {
                case 'market-overview':
                    content.innerHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>US IG</span>
                                <span style="color: var(--positive);">+0.23%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>US HY</span>
                                <span style="color: var(--negative);">-0.15%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>EM Debt</span>
                                <span style="color: var(--positive);">+0.45%</span>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'top-movers':
                    content.innerHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>HY00 📈</span>
                                <span style="color: var(--positive);">+2.34%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>EM00 📉</span>
                                <span style="color: var(--negative);">-1.87%</span>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'anomalies':
                    const anomalies = anomalyDetector.detectAnomalies(state.data);
                    if (anomalies.length > 0) {
                        content.innerHTML = `
                            <div style="display: grid; gap: 0.5rem;">
                                ${anomalies.slice(0, 3).map(a => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.25rem; background: rgba(255, 215, 0, 0.1); border-radius: 4px;">
                                        <span>${a.seriesId}</span>
                                        <span>${a.type}: ${a.value.toFixed(2)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    } else {
                        content.innerHTML = '<div style="color: var(--text-secondary); text-align: center;">No anomalies detected</div>';
                    }
                    break;
                    
                case 'watchlist':
                    content.innerHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="display: flex; justify-content: space-between;">
                                <span>⭐ H0A0</span>
                                <span>5.67%</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>⭐ HY00</span>
                                <span>423 bps</span>
                            </div>
                        </div>
                    `;
                    break;
            }
        }
        
        // ============================================
        // Keyboard Shortcuts
        // ============================================
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }
                
                switch(e.key.toLowerCase()) {
                    case '/':
                        e.preventDefault();
                        document.getElementById('aiSearch').focus();
                        break;
                    case 'r':
                        if (!e.ctrlKey && !e.metaKey) {
                            e.preventDefault();
                            location.reload();
                        }
                        break;
                    case 't':
                        e.preventDefault();
                        const themes = ['dark', 'light'];
                        const current = state.theme;
                        const next = themes[(themes.indexOf(current) + 1) % themes.length];
                        setTheme(next);
                        break;
                    case 'h':
                        e.preventDefault();
                        toggleHeatmap();
                        break;
                    case 'e':
                        e.preventDefault();
                        exportToCSV();
                        break;
                    case 'd':
                        e.preventDefault();
                        toggleDensity();
                        break;
                    case 's':
                        if (e.ctrlKey || e.metaKey) {
                            e.preventDefault();
                            shareView();
                        }
                        break;
                    case 'p':
                        e.preventDefault();
                        toggleCollabPanel();
                        break;
                    case '?':
                        e.preventDefault();
                        showShortcuts();
                        break;
                }
            });
        }
        
        function showShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
        }
        
        function closeShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('active');
        }
        
        // ============================================
        // Search Implementation
        // ============================================
        function initializeSearch() {
            const searchInput = document.getElementById('aiSearch');
            const suggestions = document.getElementById('searchSuggestions');
            
            // Initialize Fuse.js for fuzzy search
            const fuse = new Fuse([], {
                keys: ['id', 'name', 'description'],
                threshold: 0.3,
                includeMatches: true
            });
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                if (query.length < 2) {
                    suggestions.classList.remove('active');
                    return;
                }
                
                // Check if it's a natural language query
                if (query.includes(' ')) {
                    handleNaturalLanguageSearch(query);
                } else {
                    // Regular search
                    const results = fuse.search(query);
                    displaySearchSuggestions(results);
                }
                
                // Save to search history
                if (!state.searchHistory.includes(query)) {
                    state.searchHistory.unshift(query);
                    state.searchHistory = state.searchHistory.slice(0, 10);
                    localStorage.setItem('searchHistory', JSON.stringify(state.searchHistory));
                }
            });
            
            // Handle search submit
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    executeSearch(e.target.value);
                    suggestions.classList.remove('active');
                }
            });
        }
        
        function handleNaturalLanguageSearch(query) {
            // Parse the natural language query
            const results = nlp.executeQuery(query, state.data);
            
            // Display AI insights
            const insightsPanel = document.getElementById('aiInsights');
            const insightsList = document.getElementById('insightsList');
            
            insightsPanel.style.display = 'block';
            insightsList.innerHTML = `
                <div class="ai-insight-item">
                    <div class="ai-insight-icon">🔍</div>
                    <div class="ai-insight-text">
                        Found ${results.length} indices matching "${query}"
                    </div>
                </div>
            `;
            
            // Update main table with results
            displayFilteredData(results);
        }
        
        function displaySearchSuggestions(results) {
            const suggestions = document.getElementById('searchSuggestions');
            
            if (results.length === 0) {
                suggestions.classList.remove('active');
                return;
            }
            
            suggestions.innerHTML = results.slice(0, 5).map(result => {
                const item = result.item;
                const highlightedText = highlightMatches(item.name, result.matches);
                
                return `
                    <div class="search-suggestion" onclick="selectSuggestion('${item.id}')">
                        ${highlightedText}
                    </div>
                `;
            }).join('');
            
            suggestions.classList.add('active');
        }
        
        function highlightMatches(text, matches) {
            if (!matches) return text;
            
            // Simple highlight implementation
            return text.replace(/match/gi, '<span class="search-highlight">$&</span>');
        }
        
        function executeSearch(query) {
            console.log('Executing search:', query);
            // Implement search execution
        }
        
        function selectSuggestion(id) {
            console.log('Selected:', id);
            document.getElementById('searchSuggestions').classList.remove('active');
        }
        
        // ============================================
        // API Integration
        // ============================================
        async function pushToSlack(message) {
            if (!SLACK_WEBHOOK) return;
            
            try {
                await fetch(SLACK_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: message })
                });
            } catch (error) {
                console.error('Slack notification failed:', error);
            }
        }
        
        async function connectTradingPlatform() {
            // Implement trading platform connection
            console.log('Connecting to trading platform...');
        }
        
        // ============================================
        // Data Management
        // ============================================
        function sortTable(column) {
            console.log('Sorting by:', column);
            // Implement sorting
        }
        
        function displayFilteredData(data) {
            const tbody = document.getElementById('mainTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No data matches your criteria</td></tr>';
                return;
            }
            
            // Build table rows
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td>${state.favorites.has(item.id) ? '⭐' : '☆'}</td>
                    <td>${item.id}</td>
                    <td>${item.name || item.description || 'N/A'}</td>
                    <td>${item.value || 'N/A'}</td>
                    <td class="${item.wow >= 0 ? 'positive' : 'negative'}">${item.wow || 'N/A'}</td>
                    <td class="${item.mom >= 0 ? 'positive' : 'negative'}">${item.mom || 'N/A'}</td>
                    <td class="${item.qoq >= 0 ? 'positive' : 'negative'}">${item.qoq || 'N/A'}</td>
                    <td class="${item.yoy >= 0 ? 'positive' : 'negative'}">${item.yoy || 'N/A'}</td>
                    <td>${item.updated || 'N/A'}</td>
                </tr>
            `).join('');
        }
        
        function exportToCSV() {
            console.log('Exporting to CSV...');
            // Implement CSV export
        }
        
        // ============================================
        // Initialization
        // ============================================
        async function initialize() {
            console.log('🚀 Initializing Premium Dashboard...');
            
            // Load saved preferences
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const savedDensity = localStorage.getItem('density') || 'comfortable';
            
            document.body.setAttribute('data-theme', savedTheme);
            document.body.setAttribute('data-density', savedDensity);
            
            state.theme = savedTheme;
            state.density = savedDensity;
            
            // Initialize features
            initializeDragAndDrop();
            initializeKeyboardShortcuts();
            initializeSearch();
            
            // Load widgets
            state.widgets.forEach(widgetId => updateWidgetContent(widgetId));
            
            // Check system theme preference
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (state.theme === 'auto') {
                        document.body.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            }
            
            // Load initial data
            await loadInitialData();
        }
        
        async function loadInitialData() {
            try {
                // Mock data loading
                state.data = [
                    { id: 'H0A0', name: 'US Corp Master', value: 5.67, wow: 0.12, mom: 0.34, qoq: 0.89, yoy: 1.23 },
                    { id: 'HY00', name: 'US High Yield', value: 423, wow: 12, mom: -8, qoq: 23, yoy: 45 },
                    { id: 'EM00', name: 'Emerging Markets', value: 567, wow: -23, mom: -15, qoq: 34, yoy: 67 }
                ];
                
                displayFilteredData(state.data);
                
                // Detect anomalies
                const anomalies = anomalyDetector.detectAnomalies(state.data);
                if (anomalies.length > 0) {
                    const insights = anomalyDetector.generateInsights(anomalies);
                    console.log('Detected anomalies:', anomalies);
                    console.log('Generated insights:', insights);
                }
                
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
