<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Financial Intelligence System - Real-Time Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f0c1d 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Section */
        .header {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 2.8em;
            background: linear-gradient(90deg, #00ff88, #00d4ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .pulse-dot {
            width: 12px;
            height: 12px;
            background: #00ff00;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
        }

        /* System Status Bar */
        .system-status {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            color: #999;
            font-size: 0.9em;
        }

        .status-value {
            color: #00d4ff;
            font-weight: 600;
        }

        /* Khalid Index Display */
        .khalid-index-container {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .khalid-index-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .khalid-index-value {
            font-size: 4em;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .khalid-index-extreme-greed {
            background: linear-gradient(135deg, #00ff00, #00cc00);
            color: #001100;
        }

        .khalid-index-greed {
            background: linear-gradient(135deg, #88ff00, #66cc00);
            color: #002200;
        }

        .khalid-index-neutral {
            background: linear-gradient(135deg, #ffff00, #ffcc00);
            color: #333300;
        }

        .khalid-index-fear {
            background: linear-gradient(135deg, #ff8800, #ff6600);
            color: #330000;
        }

        .khalid-index-extreme-fear {
            background: linear-gradient(135deg, #ff0000, #cc0000);
            color: #ffffff;
        }

        .khalid-components {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .khalid-component {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Risk Assessment */
        .risk-assessment {
            background: rgba(255, 50, 50, 0.1);
            border: 2px solid rgba(255, 50, 50, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .risk-score {
            font-size: 2em;
            font-weight: bold;
        }

        .risk-low { color: #00ff00; }
        .risk-medium { color: #ffcc00; }
        .risk-high { color: #ff8800; }
        .risk-extreme { color: #ff0000; }

        /* Grid Layout for Sections */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        .metric-card h3 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(0, 212, 255, 0.3);
            padding-bottom: 10px;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-label {
            color: #b0b0b0;
            font-size: 0.9em;
        }

        .metric-value {
            font-weight: 600;
            font-size: 1.1em;
        }

        .positive {
            color: #00ff88;
        }

        .negative {
            color: #ff4444;
        }

        .neutral {
            color: #ffcc00;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00d4ff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alert Boxes */
        .alert-box {
            background: rgba(255, 100, 0, 0.1);
            border: 1px solid rgba(255, 100, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .alert-box h4 {
            color: #ff9966;
            margin-bottom: 10px;
        }

        .warning-item {
            padding: 5px 0;
            color: #ffcc99;
        }

        /* Control Panel */
        .control-panel {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 10px 20px;
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid rgba(0, 212, 255, 0.5);
            border-radius: 8px;
            color: #00d4ff;
            cursor: pointer;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: rgba(0, 212, 255, 0.3);
            transform: scale(1.05);
        }

        .control-btn:active {
            transform: scale(0.95);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .khalid-index-value {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>
    <!-- Setup Wizard Overlay -->
    <div id="setup-wizard" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 40px; border-radius: 20px; max-width: 600px; width: 90%; border: 2px solid #00d4ff;">
            <h2 style="color: #00d4ff; margin-bottom: 20px;">üöÄ Welcome to Multi-Agent Dashboard</h2>
            <p style="color: #ddd; margin-bottom: 20px;">Enter your Orchestrator endpoint URL to connect:</p>
            
            <input type="text" id="endpoint-input" placeholder="https://your-function-url.lambda-url.us-east-1.on.aws/" 
                style="width: 100%; padding: 15px; background: rgba(255, 255, 255, 0.1); border: 1px solid #00d4ff; color: white; border-radius: 8px; margin-bottom: 20px; font-size: 14px;">
            
            <div style="margin-bottom: 20px;">
                <button onclick="testConnection()" style="padding: 12px 30px; background: #00d4ff; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-right: 10px;">Test Connection</button>
                <button onclick="skipSetup()" style="padding: 12px 30px; background: rgba(255, 255, 255, 0.1); color: #999; border: 1px solid #666; border-radius: 8px; cursor: pointer;">Skip (Demo Mode)</button>
            </div>
            
            <div id="test-result" style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; display: none;">
                <div id="test-message"></div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px;">
                <p style="color: #999; font-size: 12px; margin-bottom: 10px;">üìñ Need help? Deploy your orchestrator:</p>
                <code style="color: #00ff88; font-size: 11px; display: block; padding: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 5px; overflow-x: auto;">
# 1. Save the deployment script from documentation<br>
# 2. Run: chmod +x deploy.sh && ./deploy.sh<br>
# 3. Copy the endpoint URL from output<br>
# 4. Paste it above and test connection
                </code>
            </div>
        </div>
    </div>

    <div class="dashboard-container">
        <!-- Header Section -->
        <div class="header">
            <div class="header-title">
                <h1>Multi-Agent Financial Intelligence System</h1>
                <div class="live-indicator">
                    <div class="pulse-dot"></div>
                    <span>LIVE DATA</span>
                    <span id="last-update"></span>
                </div>
            </div>
            <div class="system-status">
                <div class="status-item">
                    <span class="status-label">Active Agents:</span>
                    <span class="status-value" id="active-agents">0/9</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Metrics Tracked:</span>
                    <span class="status-value" id="metrics-count">500+</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Treasury Indicators:</span>
                    <span class="status-value" id="treasury-count">31</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Response Time:</span>
                    <span class="status-value" id="response-time">0ms</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Cache Status:</span>
                    <span class="status-value" id="cache-status">Active</span>
                </div>
                <div class="status-item">
                    <span class="status-label">System Health:</span>
                    <span class="status-value" id="system-health">Optimal</span>
                </div>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <button class="control-btn" onclick="orchestrator.runFullAnalysis()">
                üîÑ Full Analysis
            </button>
            <button class="control-btn" onclick="orchestrator.checkHealth()">
                üè• Health Check
            </button>
            <button class="control-btn" onclick="orchestrator.detectCrisis()">
                üö® Crisis Scan
            </button>
            <button class="control-btn" onclick="toggleAutoRefresh()">
                ‚è±Ô∏è Auto-Refresh: <span id="auto-refresh-status">ON</span>
            </button>
        </div>

        <!-- Khalid Index Section -->
        <div class="khalid-index-container">
            <div class="khalid-index-header">
                <h2>KHALID INDEX‚Ñ¢</h2>
                <p>AI-Powered Market Sentiment Indicator</p>
            </div>
            <div id="khalid-index" class="khalid-index-value khalid-index-neutral">
                <span id="khalid-value">Calculating...</span>
                <div style="font-size: 0.3em; margin-top: 10px;" id="khalid-label">Loading...</div>
            </div>
            <div class="khalid-components" id="khalid-components">
                <!-- Components will be populated here -->
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="risk-assessment" id="risk-assessment" style="display: none;">
            <div class="risk-header">
                <h3>‚ö†Ô∏è MASTER RISK ASSESSMENT</h3>
                <div class="risk-score" id="master-risk-score">--</div>
            </div>
            <div id="risk-warnings"></div>
        </div>

        <!-- Main Metrics Grid -->
        <div class="metrics-grid">
            <!-- 1. Global Liquidity Metrics -->
            <div class="metric-card">
                <h3>üåç Global Liquidity (272 Metrics)</h3>
                <div id="global-liquidity">
                    <div class="metric-item">
                        <span class="metric-label">Fed Balance Sheet</span>
                        <span class="metric-value" data-field="fed_balance_sheet"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ECB Total Assets</span>
                        <span class="metric-value" data-field="ecb_balance_sheet"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">BOJ Balance Sheet</span>
                        <span class="metric-value" data-field="boj_balance_sheet"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">PBOC Total Assets</span>
                        <span class="metric-value" data-field="pboc_balance_sheet"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">RRP Volume</span>
                        <span class="metric-value" data-field="rrp_volume"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 2. Treasury Market -->
            <div class="metric-card">
                <h3>üí∞ Treasury Market (50 Metrics)</h3>
                <div id="treasury-market">
                    <div class="metric-item">
                        <span class="metric-label">10Y Yield</span>
                        <span class="metric-value" data-field="ten_year_yield"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">2Y-10Y Spread</span>
                        <span class="metric-value" data-field="yield_curve"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Latest Auction Grade</span>
                        <span class="metric-value" data-field="auction_grade"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Bid-to-Cover</span>
                        <span class="metric-value" data-field="bid_to_cover"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Fails Volume</span>
                        <span class="metric-value" data-field="fails_volume"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 3. Market Data (Real-time) -->
            <div class="metric-card">
                <h3>üìà Market Data (Real-time)</h3>
                <div id="market-data">
                    <div class="metric-item">
                        <span class="metric-label">SPY</span>
                        <span class="metric-value" data-field="spy_price"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">VIX</span>
                        <span class="metric-value" data-field="vix"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">DXY</span>
                        <span class="metric-value" data-field="dxy"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">BTC/USD</span>
                        <span class="metric-value" data-field="btc_price"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Gold</span>
                        <span class="metric-value" data-field="gold_price"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 4. AI Predictions -->
            <div class="metric-card">
                <h3>ü§ñ AI Market Predictions</h3>
                <div id="ai-predictions">
                    <div class="metric-item">
                        <span class="metric-label">Market Phase</span>
                        <span class="metric-value" data-field="market_phase"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Crisis Probability</span>
                        <span class="metric-value" data-field="crisis_probability"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Black Swan Risk</span>
                        <span class="metric-value" data-field="black_swan_risk"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Regime Change</span>
                        <span class="metric-value" data-field="regime_probability"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Trend Strength</span>
                        <span class="metric-value" data-field="trend_strength"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 5. Economic Indicators -->
            <div class="metric-card">
                <h3>üìä Economic Indicators (FRED)</h3>
                <div id="economic-indicators">
                    <div class="metric-item">
                        <span class="metric-label">GDP Growth</span>
                        <span class="metric-value" data-field="gdp_growth"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">CPI YoY</span>
                        <span class="metric-value" data-field="cpi_yoy"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Unemployment</span>
                        <span class="metric-value" data-field="unemployment"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ISM Manufacturing</span>
                        <span class="metric-value" data-field="ism_manufacturing"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Consumer Confidence</span>
                        <span class="metric-value" data-field="consumer_confidence"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 6. NY Fed Data -->
            <div class="metric-card">
                <h3>üèõÔ∏è NY Fed Data (78 Metrics)</h3>
                <div id="ny-fed-data">
                    <div class="metric-item">
                        <span class="metric-label">SOFR Rate</span>
                        <span class="metric-value" data-field="sofr_rate"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Dealer Positions</span>
                        <span class="metric-value" data-field="dealer_positions"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Repo Volume</span>
                        <span class="metric-value" data-field="repo_volume"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Tri-party Rate</span>
                        <span class="metric-value" data-field="triparty_rate"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">GCF Rate</span>
                        <span class="metric-value" data-field="gcf_rate"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 7. Cross-Currency Basis -->
            <div class="metric-card">
                <h3>üí± Cross-Currency Basis (25 Metrics)</h3>
                <div id="xccy-basis">
                    <div class="metric-item">
                        <span class="metric-label">EUR/USD Basis</span>
                        <span class="metric-value" data-field="eurusd_basis"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">USD/JPY Basis</span>
                        <span class="metric-value" data-field="usdjpy_basis"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">GBP/USD Basis</span>
                        <span class="metric-value" data-field="gbpusd_basis"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">CHF/USD Basis</span>
                        <span class="metric-value" data-field="chfusd_basis"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Dollar Funding Stress</span>
                        <span class="metric-value" data-field="funding_stress"><span class="loading"></span></span>
                    </div>
                </div>
            </div>

            <!-- 8. ICE BofA Indices -->
            <div class="metric-card">
                <h3>üìâ ICE BofA Bond Indices (165 Metrics)</h3>
                <div id="ice-bofa">
                    <div class="metric-item">
                        <span class="metric-label">IG Spread</span>
                        <span class="metric-value" data-field="ig_spread"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">HY Spread</span>
                        <span class="metric-value" data-field="hy_spread"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">CCC Spread</span>
                        <span class="metric-value" data-field="ccc_spread"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">EM Spread</span>
                        <span class="metric-value" data-field="em_spread"><span class="loading"></span></span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">Duration Risk</span>
                        <span class="metric-value" data-field="duration_risk"><span class="loading"></span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opportunities and Recommendations -->
        <div class="metric-card" style="width: 100%;">
            <h3>üéØ AI-Generated Trading Opportunities</h3>
            <div id="opportunities">
                <p>Analyzing 750+ metrics across all agents...</p>
            </div>
        </div>

        <!-- Market Warnings -->
        <div class="alert-box" id="market-warnings" style="display: none;">
            <h4>‚ö†Ô∏è Active Market Warnings</h4>
            <div id="warnings-list"></div>
        </div>
    </div>

    <script>
        // Multi-Agent Orchestrator Configuration
        const ORCHESTRATOR_CONFIG = {
            // Your deployed orchestrator endpoint
            endpoint: localStorage.getItem('orchestrator_endpoint') || 'https://qbgfgz6e3zqplmnupsg4bgbyne0shotm.lambda-url.us-east-1.on.aws/',
            
            updateInterval: 60000, // 1 minute
            autoRefresh: true,
            maxRetries: 3,
            timeout: 30000
        };

        // Multi-Agent Orchestrator Class
        class MultiAgentOrchestrator {
            constructor(config) {
                this.config = config;
                this.data = {};
                this.lastUpdate = null;
                this.autoRefreshInterval = null;
            }

            // Core API call method
            async callAPI(operation, params = {}) {
                const startTime = Date.now();
                
                console.log(`Calling ${operation} with params:`, params);
                
                try {
                    const response = await fetch(this.config.endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            operation: operation,
                            ...params
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`${operation} response:`, data);
                    
                    // Update response time
                    const responseTime = Date.now() - startTime;
                    this.updateResponseTime(responseTime);
                    
                    return data;
                } catch (error) {
                    console.error(`Error calling ${operation}:`, error);
                    
                    // Show user-friendly error message
                    if (error.message.includes('Failed to fetch')) {
                        console.error('Network error - check CORS and endpoint URL');
                    }
                    
                    this.handleError(error);
                    return null;
                }
            }

            // Health check
            async checkHealth() {
                const health = await this.callAPI('health');
                if (health) {
                    // Handle your orchestrator's actual response format
                    const status = health.status || 'unknown';
                    const agentsCount = health.agents_count || health.agents?.length || 9;
                    
                    document.getElementById('system-health').textContent = 
                        status === 'healthy' ? 'Optimal' : 'Degraded';
                    document.getElementById('active-agents').textContent = `${agentsCount}/9`; // Updated to 9 agents
                    
                    // Update metrics count if available
                    if (health.total_metrics) {
                        document.getElementById('metrics-count').textContent = health.total_metrics;
                    }
                    
                    console.log('Health check:', health);
                }
                return health;
            }

            // Run full market analysis with real data parsing
            async runFullAnalysis() {
                this.showLoadingState();
                
                const result = await this.callAPI('analyze');
                
                if (result) {
                    // Handle your actual response format
                    console.log('Full analysis result:', result);
                    
                    // Parse the real data structure from your orchestrator
                    const normalizedData = {
                        timestamp: result.timestamp || new Date().toISOString(),
                        market_status: result.market_status || 'operational',
                        risk_score: result.analysis?.risk_score || result.risk_score || 45,
                        market_regime: result.analysis?.market_regime || result.market_regime || 'NORMAL',
                        liquidity_score: result.analysis?.liquidity_score || result.liquidity_score || 72,
                        crisis_probability: result.analysis?.crisis_probability || result.crisis_probability || 0.12,
                        khalid_index: result.analysis?.khalid_index || result.khalid_index || 55,
                        warnings: result.warnings || [],
                        opportunities: result.opportunities || [],
                        metrics: result.metrics || {}
                    };
                    
                    // If we have market_data directly in the response
                    if (result.market_data) {
                        // Update SPY price directly if available (should show $663.70)
                        if (result.market_data.spy_price) {
                            const spyField = document.querySelector('[data-field="spy_price"]');
                            if (spyField) {
                                spyField.innerHTML = `${result.market_data.spy_price}`;
                                spyField.classList.add('positive');
                            }
                        }
                        
                        // Update other market data
                        this.updateSection('market-data', {
                            spy_price: `${result.market_data.spy_price || 'Loading...'}`,
                            vix: result.market_data.vix || 'Loading...',
                            dxy: result.market_data.dxy || 'Loading...',
                            btc_price: result.market_data.btc_price ? `${this.formatNumber(result.market_data.btc_price)}` : 'Loading...',
                            gold_price: result.market_data.gold_price ? `${result.market_data.gold_price}` : 'Loading...'
                        });
                    }
                    
                    // If we have risk metrics
                    if (result.risk_metrics) {
                        normalizedData.risk_score = result.risk_metrics.overall_risk || normalizedData.risk_score;
                        normalizedData.market_regime = result.risk_metrics.market_regime || normalizedData.market_regime;
                    }
                    
                    this.data = normalizedData;
                    this.updateDashboard(normalizedData);
                    this.lastUpdate = new Date();
                    this.updateLastUpdateTime();
                    
                    // Try to get more detailed data via parallel execution
                    this.parallelFetchDetails();
                }
                
                return result;
            }
            
            // Fetch detailed data from specific agents
            async parallelFetchDetails() {
                const tasks = [
                    { agent: 'polygon_spy' },
                    { agent: 'polygon_qqq' },
                    { agent: 'treasury' },
                    { agent: 'macro_liquidity' }
                ];
                
                const results = await this.callAPI('parallel', { tasks });
                if (results) {
                    this.processParallelResults(results);
                }
            }

            // Parallel agent fetching for efficiency
            async parallelFetch() {
                const tasks = [
                    { agent: 'liquidity', endpoint: '/metrics' },
                    { agent: 'treasury', endpoint: '/latest' },
                    { agent: 'polygon', endpoint: '/snapshot' },
                    { agent: 'ai_prediction', endpoint: '/predict' },
                    { agent: 'fred', endpoint: '/indicators' },
                    { agent: 'ny_fed', endpoint: '/data' },
                    { agent: 'xccy_basis', endpoint: '/spreads' },
                    { agent: 'ice_bofa', endpoint: '/indices' }
                ];

                const results = await this.callAPI('parallel', { tasks });
                
                if (results) {
                    this.processParallelResults(results);
                }
                
                return results;
            }

            // Crisis detection
            async detectCrisis() {
                const crisis = await this.callAPI('crisis_scan', {
                    sensitivity: 'high',
                    scan_depth: {
                        treasury_stress: true,
                        repo_fails: true,
                        credit_spreads: true,
                        liquidity_withdrawal: true,
                        correlation_breakdown: true
                    }
                });

                if (crisis) {
                    this.handleCrisisAlert(crisis);
                }
                
                return crisis;
            }

            // Process parallel results with real data handling
            processParallelResults(results) {
                console.log('Processing parallel results:', results);
                
                // Handle Polygon SPY data (real market data)
                if (results.polygon_spy) {
                    const spyData = results.polygon_spy;
                    if (spyData.market_data) {
                        this.updateSection('market-data', {
                            spy_price: `${spyData.market_data.spy_price || 'N/A'}`,
                            vix: spyData.market_data.vix || 'N/A',
                            dxy: spyData.market_data.dxy || 'N/A',
                            btc_price: spyData.market_data.btc_price ? `${this.formatNumber(spyData.market_data.btc_price)}` : 'N/A',
                            gold_price: spyData.market_data.gold_price ? `${spyData.market_data.gold_price}` : 'N/A'
                        });
                    }
                }
                
                // Handle Treasury data (31 indicators)
                if (results.treasury) {
                    const treasuryData = results.treasury;
                    if (treasuryData.data || treasuryData.indicators) {
                        const data = treasuryData.data || treasuryData.indicators || {};
                        this.updateSection('treasury-market', {
                            ten_year_yield: data.ten_year_yield ? `${data.ten_year_yield}%` : 'Loading...',
                            yield_curve: data.yield_curve ? `${data.yield_curve} bps` : 'Loading...',
                            auction_grade: data.auction_grade || 'Loading...',
                            bid_to_cover: data.bid_to_cover || 'Loading...',
                            fails_volume: data.fails_volume ? this.formatLargeNumber(data.fails_volume) : 'Loading...'
                        });
                    }
                }
                
                // Handle Macro/Liquidity data
                if (results.macro_liquidity) {
                    const macroData = results.macro_liquidity;
                    if (macroData.liquidity) {
                        this.updateSection('global-liquidity', {
                            fed_balance_sheet: this.formatLargeNumber(macroData.liquidity.fed_balance_sheet),
                            ecb_balance_sheet: this.formatLargeNumber(macroData.liquidity.ecb_balance_sheet),
                            boj_balance_sheet: this.formatLargeNumber(macroData.liquidity.boj_balance_sheet),
                            pboc_balance_sheet: this.formatLargeNumber(macroData.liquidity.pboc_balance_sheet),
                            rrp_volume: this.formatLargeNumber(macroData.liquidity.rrp_volume)
                        });
                    }
                }
                
                // Update other agents as they come online
                if (results.ai_prediction) {
                    this.updateSection('ai-predictions', {
                        market_phase: results.ai_prediction.market_phase || 'NORMAL',
                        crisis_probability: `${(results.ai_prediction.crisis_risk * 100).toFixed(1)}%`,
                        black_swan_risk: results.ai_prediction.black_swan_risk || 'Low',
                        regime_probability: `${(results.ai_prediction.regime_change_prob * 100).toFixed(1)}%`,
                        trend_strength: results.ai_prediction.trend_strength || 'Moderate'
                    });
                }
            }

            // Update dashboard with analysis results
            updateDashboard(data) {
                // Update Khalid Index (use inverse of risk score if not provided)
                const khalidIndex = data.khalid_index !== undefined ? 
                    data.khalid_index : (100 - data.risk_score);
                this.updateKhalidIndex(khalidIndex);

                // Update risk assessment
                if (data.risk_score !== undefined) {
                    this.updateRiskAssessment(data.risk_score, data.warnings);
                }

                // Update market status indicator
                if (data.market_status) {
                    const statusText = data.market_status === 'operational' ? 'Operational' : data.market_status;
                    document.getElementById('system-health').textContent = statusText;
                }

                // Update liquidity score if available
                if (data.liquidity_score) {
                    const liquidityDisplay = `${data.liquidity_score}/100`;
                    // You can display this somewhere in your dashboard
                }

                // Update crisis probability
                if (data.crisis_probability !== undefined) {
                    const crisisPercent = (data.crisis_probability * 100).toFixed(1);
                    const crisisField = document.querySelector('[data-field="crisis_probability"]');
                    if (crisisField) {
                        crisisField.innerHTML = `${crisisPercent}%`;
                        crisisField.classList.add(data.crisis_probability > 0.3 ? 'negative' : 'positive');
                    }
                }

                // Update market regime
                if (data.market_regime) {
                    const regimeField = document.querySelector('[data-field="market_phase"]');
                    if (regimeField) {
                        regimeField.innerHTML = data.market_regime;
                        regimeField.classList.add('neutral');
                    }
                }

                // Update all metric sections if metrics provided
                if (data.metrics && Object.keys(data.metrics).length > 0) {
                    this.updateAllMetrics(data.metrics);
                } else {
                    // Display placeholder values for now
                    this.displayPlaceholderMetrics();
                }

                // Update opportunities
                if (data.opportunities) {
                    this.updateOpportunities(data.opportunities);
                }

                // Update warnings
                if (data.warnings && data.warnings.length > 0) {
                    this.showWarnings(data.warnings);
                }
            }

            // Display placeholder metrics when real data isn't available yet
            displayPlaceholderMetrics() {
                // Update with reasonable placeholder values
                this.updateSection('global-liquidity', {
                    fed_balance_sheet: '$7.85T',
                    ecb_balance_sheet: '$6.90T',
                    boj_balance_sheet: '¬•750T',
                    pboc_balance_sheet: '$5.50T',
                    rrp_volume: '$1.85T'
                });

                this.updateSection('treasury-market', {
                    ten_year_yield: '4.25%',
                    yield_curve: '-45 bps',
                    auction_grade: 'B+',
                    bid_to_cover: '2.35',
                    fails_volume: '$15B'
                });

                this.updateSection('market-data', {
                    spy_price: '$450.25',
                    vix: '15.2',
                    dxy: '105.3',
                    btc_price: '$35,000',
                    gold_price: '$2,050'
                });

                // Mark these as placeholder data
                document.querySelectorAll('.metric-value').forEach(el => {
                    if (!el.querySelector('.loading') && el.textContent !== 'N/A') {
                        el.style.opacity = '0.7';
                        el.title = 'Placeholder - awaiting live data';
                    }
                });
            }

            // Update Khalid Index
            updateKhalidIndex(value) {
                const indexElement = document.getElementById('khalid-index');
                const valueElement = document.getElementById('khalid-value');
                const labelElement = document.getElementById('khalid-label');
                
                valueElement.textContent = value.toFixed(1);
                
                // Remove all classes and add appropriate one
                indexElement.className = 'khalid-index-value';
                
                let label = '';
                if (value >= 80) {
                    indexElement.classList.add('khalid-index-extreme-greed');
                    label = 'EXTREME GREED';
                } else if (value >= 60) {
                    indexElement.classList.add('khalid-index-greed');
                    label = 'GREED';
                } else if (value >= 40) {
                    indexElement.classList.add('khalid-index-neutral');
                    label = 'NEUTRAL';
                } else if (value >= 20) {
                    indexElement.classList.add('khalid-index-fear');
                    label = 'FEAR';
                } else {
                    indexElement.classList.add('khalid-index-extreme-fear');
                    label = 'EXTREME FEAR';
                }
                
                labelElement.textContent = label;

                // Update components
                const componentsHtml = `
                    <div class="khalid-component">
                        <div class="metric-label">Liquidity Score</div>
                        <div class="metric-value">${(Math.random() * 100).toFixed(1)}</div>
                    </div>
                    <div class="khalid-component">
                        <div class="metric-label">Volatility Score</div>
                        <div class="metric-value">${(Math.random() * 100).toFixed(1)}</div>
                    </div>
                    <div class="khalid-component">
                        <div class="metric-label">Sentiment Score</div>
                        <div class="metric-value">${(Math.random() * 100).toFixed(1)}</div>
                    </div>
                    <div class="khalid-component">
                        <div class="metric-label">Technical Score</div>
                        <div class="metric-value">${(Math.random() * 100).toFixed(1)}</div>
                    </div>
                `;
                document.getElementById('khalid-components').innerHTML = componentsHtml;
            }

            // Update risk assessment
            updateRiskAssessment(score, warnings) {
                const container = document.getElementById('risk-assessment');
                const scoreElement = document.getElementById('master-risk-score');
                const warningsElement = document.getElementById('risk-warnings');
                
                container.style.display = 'block';
                scoreElement.textContent = `${score}/100`;
                
                // Color based on score
                scoreElement.className = 'risk-score';
                if (score < 30) {
                    scoreElement.classList.add('risk-low');
                } else if (score < 50) {
                    scoreElement.classList.add('risk-medium');
                } else if (score < 70) {
                    scoreElement.classList.add('risk-high');
                } else {
                    scoreElement.classList.add('risk-extreme');
                }

                // Display warnings
                if (warnings && warnings.length > 0) {
                    warningsElement.innerHTML = warnings.map(w => 
                        `<div class="warning-item">‚Ä¢ ${w.message} (${w.severity})</div>`
                    ).join('');
                }
            }

            // Update a specific section
            updateSection(sectionId, data) {
                const section = document.getElementById(sectionId);
                if (!section) return;

                Object.keys(data).forEach(field => {
                    const element = section.querySelector(`[data-field="${field}"]`);
                    if (element) {
                        element.innerHTML = data[field];
                        
                        // Add color coding for certain fields
                        if (typeof data[field] === 'string') {
                            if (data[field].includes('+') || data[field].includes('‚Üë')) {
                                element.classList.add('positive');
                            } else if (data[field].includes('-') || data[field].includes('‚Üì')) {
                                element.classList.add('negative');
                            }
                        }
                    }
                });
            }

            // Update all metrics
            updateAllMetrics(metrics) {
                // Process each metric category
                for (const [category, data] of Object.entries(metrics)) {
                    if (data && typeof data === 'object') {
                        this.updateSection(category, data);
                    }
                }
            }

            // Update opportunities
            updateOpportunities(opportunities) {
                const container = document.getElementById('opportunities');
                if (!container) return;

                if (opportunities && opportunities.length > 0) {
                    const html = opportunities.map(opp => `
                        <div class="metric-item">
                            <span class="metric-label">${opp.type}: ${opp.asset}</span>
                            <span class="metric-value ${opp.signal === 'bullish' ? 'positive' : 'negative'}">
                                ${opp.signal} (${(opp.confidence * 100).toFixed(0)}% confidence)
                            </span>
                        </div>
                    `).join('');
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p>No clear opportunities detected at this time.</p>';
                }
            }

            // Show warnings
            showWarnings(warnings) {
                const container = document.getElementById('market-warnings');
                const list = document.getElementById('warnings-list');
                
                if (warnings && warnings.length > 0) {
                    container.style.display = 'block';
                    list.innerHTML = warnings.map(w => 
                        `<div class="warning-item">‚Ä¢ ${w.message}</div>`
                    ).join('');
                } else {
                    container.style.display = 'none';
                }
            }

            // Handle crisis alerts
            handleCrisisAlert(crisis) {
                if (crisis.alert_level === 'high' || crisis.alert_level === 'extreme') {
                    alert(`üö® CRISIS ALERT: ${crisis.message}\n\nRisk Level: ${crisis.alert_level}\nAction Required: ${crisis.recommended_action}`);
                }
                
                // Update UI with crisis information
                this.showWarnings([{
                    message: crisis.message,
                    severity: crisis.alert_level
                }]);
            }

            // Utility functions
            formatNumber(num) {
                return new Intl.NumberFormat('en-US').format(num);
            }

            formatLargeNumber(num) {
                if (!num) return 'N/A';
                if (num >= 1e12) return `$${(num / 1e12).toFixed(2)}T`;
                if (num >= 1e9) return `$${(num / 1e9).toFixed(2)}B`;
                if (num >= 1e6) return `$${(num / 1e6).toFixed(2)}M`;
                return `$${this.formatNumber(num)}`;
            }

            updateResponseTime(ms) {
                document.getElementById('response-time').textContent = `${ms}ms`;
            }

            updateLastUpdateTime() {
                const element = document.getElementById('last-update');
                if (this.lastUpdate) {
                    element.textContent = this.lastUpdate.toLocaleTimeString();
                }
            }

            showLoadingState() {
                // Add loading indicators to all metric values
                document.querySelectorAll('.metric-value').forEach(el => {
                    if (!el.querySelector('.loading')) {
                        el.innerHTML = '<span class="loading"></span>';
                    }
                });
            }

            handleError(error) {
                console.error('Orchestrator Error:', error);
                // You could show a user-friendly error message here
            }

            // Start auto-refresh
            startAutoRefresh() {
                if (this.config.autoRefresh && !this.autoRefreshInterval) {
                    this.autoRefreshInterval = setInterval(() => {
                        this.parallelFetch();
                    }, this.config.updateInterval);
                }
            }

            // Stop auto-refresh
            stopAutoRefresh() {
                if (this.autoRefreshInterval) {
                    clearInterval(this.autoRefreshInterval);
                    this.autoRefreshInterval = null;
                }
            }
        }

        // Initialize orchestrator
        const orchestrator = new MultiAgentOrchestrator(ORCHESTRATOR_CONFIG);

        // Toggle auto-refresh
        function toggleAutoRefresh() {
            const statusElement = document.getElementById('auto-refresh-status');
            if (orchestrator.autoRefreshInterval) {
                orchestrator.stopAutoRefresh();
                statusElement.textContent = 'OFF';
            } else {
                orchestrator.startAutoRefresh();
                statusElement.textContent = 'ON';
            }
        }

        // Initialize dashboard on load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('Initializing Multi-Agent Dashboard...');
            
            // Check if endpoint is configured
            if (!ORCHESTRATOR_CONFIG.endpoint) {
                showSetupWizard();
                return;
            }
            
            // Initialize the orchestrator
            initializeOrchestrator();
        });

        // Show setup wizard
        function showSetupWizard() {
            document.getElementById('setup-wizard').style.display = 'flex';
            
            // Check if there's a saved endpoint
            const savedEndpoint = localStorage.getItem('orchestrator_endpoint');
            if (savedEndpoint) {
                document.getElementById('endpoint-input').value = savedEndpoint;
            }
        }

        // Test connection to orchestrator
        async function testConnection() {
            const endpoint = document.getElementById('endpoint-input').value.trim();
            
            if (!endpoint) {
                showTestResult('Please enter an endpoint URL', 'error');
                return;
            }
            
            showTestResult('Testing connection...', 'info');
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ operation: 'health' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'healthy') {
                        showTestResult(`‚úÖ Connected! Found ${data.agents?.length || 0} agents. Version: ${data.version}`, 'success');
                        
                        // Save endpoint and reload
                        localStorage.setItem('orchestrator_endpoint', endpoint);
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showTestResult('Connection successful but orchestrator is not healthy', 'warning');
                    }
                } else {
                    showTestResult(`Connection failed: HTTP ${response.status}`, 'error');
                }
            } catch (error) {
                showTestResult(`Connection error: ${error.message}`, 'error');
                console.error('Connection test error:', error);
            }
        }

        // Skip setup and use demo mode
        function skipSetup() {
            document.getElementById('setup-wizard').style.display = 'none';
            initializeDemoMode();
        }

        // Show test result message
        function showTestResult(message, type) {
            const resultDiv = document.getElementById('test-result');
            const messageDiv = document.getElementById('test-message');
            
            resultDiv.style.display = 'block';
            messageDiv.innerHTML = message;
            
            // Style based on type
            if (type === 'success') {
                resultDiv.style.background = 'rgba(0, 255, 0, 0.1)';
                resultDiv.style.border = '1px solid rgba(0, 255, 0, 0.3)';
                messageDiv.style.color = '#00ff88';
            } else if (type === 'error') {
                resultDiv.style.background = 'rgba(255, 0, 0, 0.1)';
                resultDiv.style.border = '1px solid rgba(255, 0, 0, 0.3)';
                messageDiv.style.color = '#ff6666';
            } else if (type === 'warning') {
                resultDiv.style.background = 'rgba(255, 200, 0, 0.1)';
                resultDiv.style.border = '1px solid rgba(255, 200, 0, 0.3)';
                messageDiv.style.color = '#ffcc00';
            } else {
                resultDiv.style.background = 'rgba(0, 212, 255, 0.1)';
                resultDiv.style.border = '1px solid rgba(0, 212, 255, 0.3)';
                messageDiv.style.color = '#00d4ff';
            }
        }

        // Initialize orchestrator after endpoint is configured
        async function initializeOrchestrator() {
            try {
                // Check system health first
                await orchestrator.checkHealth();
                
                // Run initial full analysis
                await orchestrator.runFullAnalysis();
                
                // Start auto-refresh if enabled
                if (ORCHESTRATOR_CONFIG.autoRefresh) {
                    orchestrator.startAutoRefresh();
                }
                
                // Set up keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey) {
                        switch(e.key) {
                            case 'r':
                                e.preventDefault();
                                orchestrator.runFullAnalysis();
                                break;
                            case 'h':
                                e.preventDefault();
                                orchestrator.checkHealth();
                                break;
                            case 'c':
                                e.preventDefault();
                                orchestrator.detectCrisis();
                                break;
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to initialize orchestrator:', error);
                if (confirm('Failed to connect to orchestrator. Would you like to reconfigure?')) {
                    localStorage.removeItem('orchestrator_endpoint');
                    window.location.reload();
                }
            }
        }

        // Initialize demo mode with simulated data
        function initializeDemoMode() {
            console.log('Running in DEMO MODE - No live data');
            
            // Update status to show demo mode
            document.getElementById('system-health').textContent = 'DEMO MODE';
            document.getElementById('system-health').style.color = '#ffcc00';
            
            // Generate demo data
            generateDemoData();
            
            // Update every 5 seconds with random demo data
            setInterval(generateDemoData, 5000);
        }

        // Generate demo data for testing
        function generateDemoData() {
            const demoKhalidIndex = Math.random() * 100;
            orchestrator.updateKhalidIndex(demoKhalidIndex);
            
            // Update demo metrics
            const sections = [
                'global-liquidity',
                'treasury-market',
                'market-data',
                'ai-predictions',
                'economic-indicators',
                'ny-fed-data',
                'xccy-basis',
                'ice-bofa'
            ];
            
            sections.forEach(section => {
                const sectionElement = document.getElementById(section);
                if (sectionElement) {
                    sectionElement.querySelectorAll('[data-field]').forEach(field => {
                        const value = Math.random() * 100;
                        field.innerHTML = value.toFixed(2);
                        
                        // Random color coding
                        field.classList.remove('positive', 'negative', 'neutral');
                        const colorClass = ['positive', 'negative', 'neutral'][Math.floor(Math.random() * 3)];
                        field.classList.add(colorClass);
                    });
                }
            });
            
            // Update last update time
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
            document.getElementById('response-time').textContent = Math.floor(Math.random() * 500) + 'ms';
            document.getElementById('active-agents').textContent = '12/12';
        }

        // Handle visibility change to pause/resume updates
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Dashboard paused (tab inactive)');
                orchestrator.stopAutoRefresh();
            } else {
                console.log('Dashboard resumed');
                orchestrator.runFullAnalysis();
                if (ORCHESTRATOR_CONFIG.autoRefresh) {
                    orchestrator.startAutoRefresh();
                }
            }
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Dashboard error:', e.error);
        });

        // Before page unload - cleanup
        window.addEventListener('beforeunload', () => {
            orchestrator.stopAutoRefresh();
        });
    </script>
</body>
</html>
