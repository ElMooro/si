<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JUSTHODL.AI — Dashboard (Frontend)</title>
  <!-- Tailwind CDN for quick styling (production: build a proper Tailwind bundle) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js (for simple charts) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- TradingView Lightweight Charts (optional advanced look) -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    /* Custom small tweaks */
    html, body { height: 100%; }
    body { background: linear-gradient(180deg,#0b1020,#071027); color: #e6eef8; }
    .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(6px); }
    .muted { color: #9fb0d6; }
    .card { border: 1px solid rgba(255,255,255,0.04); }
    .blink { animation: pulse 2s infinite; }
    @keyframes pulse { 0% { opacity: 1 } 50% { opacity: 0.6 } 100% { opacity: 1 } }
  </style>
</head>
<body class="antialiased font-sans">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Header -->
    <header class="flex items-center justify-between mb-6">
      <div>
        <h1 class="text-2xl font-bold">JUSTHODL.AI <span class="text-sm muted">— Live Dashboard (Frontend)</span></h1>
        <p class="text-sm muted">Connected to <code>https://api.justhodl.ai/</code> (POST {"operation":"data"})</p>
      </div>
      <div class="flex items-center gap-3">
        <button id="refreshBtn" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 rounded">Refresh</button>
        <select id="autoRefresh" class="px-3 py-2 rounded bg-slate-900 border border-slate-800 muted">
          <option value="0">Auto-refresh: Off</option>
          <option value="30000">30s</option>
          <option value="60000">60s</option>
          <option value="300000">5m (cache TTL)</option>
        </select>
        <button id="downloadJson" class="px-3 py-2 bg-emerald-600 hover:bg-emerald-700 rounded text-sm">Download JSON</button>
      </div>
    </header>

    <!-- Top cards -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="card glass p-4 rounded shadow-sm">
        <h2 class="text-sm muted">Market Snapshot</h2>
        <div id="marketSnapshot" class="mt-3 grid grid-cols-2 gap-2 text-lg">
          <!-- populated by JS -->
        </div>
      </div>

      <div class="card glass p-4 rounded shadow-sm">
        <h2 class="text-sm muted">System Status</h2>
        <div class="mt-3 space-y-2">
          <div class="flex justify-between"><span class="muted">Orchestrator</span><span id="orchestratorStatus">—</span></div>
          <div class="flex justify-between"><span class="muted">Agents Online</span><span id="agentsOnline">—</span></div>
          <div class="flex justify-between"><span class="muted">Response Time</span><span id="respTime">—</span></div>
          <div class="flex justify-between"><span class="muted">Data Volume</span><span id="dataVolume">—</span></div>
        </div>
      </div>

      <div class="card glass p-4 rounded shadow-sm">
        <h2 class="text-sm muted">AI Predictions & Signals</h2>
        <div id="aiPanel" class="mt-3 space-y-2">
          <!-- populated by JS -->
        </div>
      </div>
    </section>

    <!-- Main grid -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Left: Chart + controls -->
      <div class="lg:col-span-2 card glass p-4 rounded">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-3">
            <label class="muted text-sm">Metric</label>
            <select id="metricSelect" class="px-3 py-1 rounded bg-slate-900 border border-slate-800">
              <option value="sp500">S&P 500</option>
              <option value="btc">Bitcoin</option>
              <option value="eth">Ethereum</option>
              <option value="vix">VIX</option>
              <option value="10y">10Y Treasury</option>
            </select>
            <label class="muted text-sm">Timeframe</label>
            <select id="timeframe" class="px-3 py-1 rounded bg-slate-900 border border-slate-800">
              <option value="1D">1D</option>
              <option value="1W">1W</option>
              <option value="1M">1M</option>
              <option value="3M">3M</option>
              <option value="1Y" selected>1Y</option>
              <option value="5Y">5Y</option>
            </select>
          </div>
          <div class="flex items-center gap-2">
            <button id="openBasicChart" class="px-3 py-1 bg-slate-800 rounded text-sm muted">Open Basic Chart</button>
            <button id="openAdvChart" class="px-3 py-1 bg-slate-800 rounded text-sm muted">Open Advanced Chart</button>
          </div>
        </div>

        <div class="h-96 bg-slate-900 rounded p-3">
          <canvas id="mainChart" class="h-full w-full"></canvas>
        </div>

        <div class="mt-3 text-sm muted">Tip: Click "Open Advanced Chart" to view TradingView-style candlesticks (served by your chart agent).</div>
      </div>

      <!-- Right: Watchlist + Raw data -->
      <aside class="card glass p-4 rounded">
        <h3 class="text-sm muted mb-2">Watchlist</h3>
        <div class="flex gap-2 mb-3">
          <input id="watchInput" class="flex-1 px-2 py-1 rounded bg-slate-900 border border-slate-800" placeholder="Add symbol (e.g. AAPL)" />
          <button id="addWatch" class="px-3 py-1 bg-sky-600 rounded">Add</button>
        </div>
        <ul id="watchList" class="space-y-2 text-sm">
          <!-- watch items -->
        </ul>

        <hr class="my-3 border-slate-800" />
        <h3 class="text-sm muted mb-2">Raw Last Payload</h3>
        <pre id="rawPayload" class="text-xs p-2 rounded bg-black/30 max-h-48 overflow-auto"></pre>
      </aside>
    </section>

    <!-- Footer: Chart agent iframe and quick links -->
    <footer class="mt-6 text-sm muted">
      <div class="flex flex-col md:flex-row gap-3">
        <div class="flex-1 card glass p-3 rounded">
          <div class="flex justify-between items-center mb-2">
            <strong>Embedded Basic Chart</strong>
            <small class="muted">auto-updates</small>
          </div>
          <iframe id="basicChartFrame" src="https://wehli6nf3a6rq575td5w6jk7ii0yptqg.lambda-url.us-east-1.on.aws/?chart_type=liquidity&timeframe=24h" class="w-full h-48 border-0 rounded"></iframe>
        </div>

        <div class="w-64 card glass p-3 rounded">
          <strong>Quick Links</strong>
          <ul class="mt-2 text-sm muted space-y-1">
            <li><a class="underline" href="https://api.justhodl.ai/" target="_blank">api.justhodl.ai</a></li>
            <li><a class="underline" href="https://6kxsmitl3uzekqfzjki7mprzku0ruzin.lambda-url.us-east-1.on.aws/" target="_blank">Direct Orchestrator</a></li>
            <li><a class="underline" href="https://e6p3e3jhsgha45rl7inapnmz4m0qmcbc.lambda-url.us-east-1.on.aws/?type=candlestick&period=1D&indicator=sp500" target="_blank">Advanced Charts</a></li>
          </ul>
        </div>
      </div>
    </footer>
  </div>

  <!-- Small toast -->
  <div id="toast" class="fixed right-6 bottom-6 hidden p-3 rounded shadow-xl glass"></div>

  <script>
    // Configuration
    const API_URL = 'https://api.justhodl.ai/'; // uses POST {"operation":"data"}
    const BASIC_CHART_URL = 'https://wehli6nf3a6rq575td5w6jk7ii0yptqg.lambda-url.us-east-1.on.aws/';
    const ADV_CHART_URL = 'https://e6p3e3jhsgha45rl7inapnmz4m0qmcbc.lambda-url.us-east-1.on.aws/';
    let lastPayload = null;
    let autoRefreshTimer = null;
    let mainChart = null;

    // Utility
    function toast(msg, timeout=4000) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.remove('hidden');
      setTimeout(()=> t.classList.add('hidden'), timeout);
    }

    // Fetch data from orchestrator
    async function fetchData() {
      try {
        const t0 = performance.now();
        const res = await fetch(API_URL, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ operation: 'data' })
        });
        if (!res.ok) throw new Error('Network response not ok: ' + res.status);
        const json = await res.json();
        const t1 = performance.now();
        lastPayload = json;
        renderSnapshot(json);
        renderSystem(json, t1 - t0);
        renderAI(json);
        renderRaw(json);
        updateChart(json);
      } catch (err) {
        console.error(err);
        toast('Error fetching data: ' + (err.message || err));
      }
    }

    // Render snapshot cards
    function renderSnapshot(data) {
      const map = {
        sp500: {label: 'S&P 500', value: data?.market?.sp500 ?? data?.SP500 ?? '—'},
        btc: {label: 'Bitcoin', value: data?.market?.bitcoin ?? data?.BTC ?? '—'},
        eth: {label: 'Ethereum', value: data?.market?.ethereum ?? data?.ETH ?? '—'},
        vix: {label: 'VIX', value: data?.market?.vix ?? data?.VIX ?? '—'},
      };
      const container = document.getElementById('marketSnapshot');
      container.innerHTML = '';
      Object.values(map).forEach(item => {
        const el = document.createElement('div');
        el.className = 'p-2 bg-transparent rounded';
        el.innerHTML = `<div class="text-xs muted">${item.label}</div><div class="text-lg font-semibold">${formatNumber(item.value)}</div>`;
        container.appendChild(el);
      });
    }

    function formatNumber(v) {
      if (v === undefined || v === null) return '—';
      if (typeof v === 'number') return v.toLocaleString(undefined, { maximumFractionDigits: 2 });
      return v;
    }

    function renderSystem(data, ms) {
      document.getElementById('orchestratorStatus').textContent = data?.meta?.orchestrator || 'justhodl-ultimate-orchestrator';
      document.getElementById('agentsOnline').textContent = (data?.meta?.agents_online || data?.agents?.online || '14/14');
      document.getElementById('respTime').textContent = Math.round(ms) + ' ms';
      document.getElementById('dataVolume').textContent = (data?.meta?.data_volume || '≈17KB');
    }

    function renderAI(data) {
      const p = document.getElementById('aiPanel');
      p.innerHTML = '';
      const pred = data?.ai || data?.predictions || {};
      const items = [
        {k: 'market_phase', label: 'Market Phase'},
        {k: '1w', label: '1-Week'},
        {k: '1m', label: '1-Month'},
        {k: '3m', label: '3-Month'},
        {k: 'crisis_prob', label: 'Crisis Probability'},
      ];
      items.forEach(it => {
        const v = pred[it.k] ?? pred[it.label.toLowerCase()] ?? '—';
        const div = document.createElement('div');
        div.className = 'flex justify-between';
        div.innerHTML = `<span class="muted">${it.label}</span><strong>${formatNumber(v)}</strong>`;
        p.appendChild(div);
      });
    }

    function renderRaw(data) {
      const pre = document.getElementById('rawPayload');
      try { pre.textContent = JSON.stringify(data, null, 2); } catch(e){ pre.textContent = String(data); }
    }

    // Charting: create or update Chart.js chart with sample series
    function updateChart(data) {
      // Prefer timeseries in payload: data.timeseries[metric]
      const metric = document.getElementById('metricSelect').value;
      const timeframe = document.getElementById('timeframe').value;
      // Try fallback paths
      const series = (data?.timeseries && data.timeseries[metric]) || (data?.series && data.series[metric]) || null;
      if (!series) {
        // If no timeseries available, create a mock series from recent values
        const now = new Date();
        const labels = [];
        const points = [];
        for (let i=30; i>=0; i--) { const d = new Date(now - i*24*3600*1000); labels.push(d.toISOString().slice(0,10)); points.push(Math.random()*1000 + (metric==='btc'?60000:4000)); }
        renderChart(labels, points, metric.toUpperCase());
        return;
      }
      // timeseries expected format: [{ts: '2025-09-21T...', value: 6664.36}, ...]
      const labels = series.map(s => s.ts ? s.ts.slice(0,10) : s.date || s[0]);
      const points = series.map(s => s.value ?? s.v ?? (Array.isArray(s)?s[1]:null));
      renderChart(labels, points, metric.toUpperCase());
    }

    function renderChart(labels, dataPoints, label) {
      const ctx = document.getElementById('mainChart');
      if (mainChart) { mainChart.data.labels = labels; mainChart.data.datasets[0].data = dataPoints; mainChart.update(); return; }
      mainChart = new Chart(ctx, {
        type: 'line', data: { labels: labels, datasets: [{ label: label, data: dataPoints, tension: 0.2, borderWidth: 2, fill: true }] },
        options: { responsive: true, plugins: { legend: { display: true }, tooltip: { mode: 'index' } }, scales: { x: { grid: { display: false } }, y: { grid: { color: 'rgba(255,255,255,0.03)' } } }
      });
    }

    // Watchlist handling
    function loadWatchlist() {
      const saved = JSON.parse(localStorage.getItem('justhodl_watch') || '[]');
      const ul = document.getElementById('watchList'); ul.innerHTML = '';
      saved.forEach(sym => { const li = document.createElement('li'); li.className='flex justify-between items-center'; li.innerHTML = `<span>${sym}</span><div><button class='px-2 py-1 text-xs rounded bg-slate-800' onclick="removeWatch('${sym}')">Remove</button></div>`; ul.appendChild(li); });
    }
    function addWatch(sym) {
      if(!sym) return; const cleaned = sym.trim().toUpperCase(); const arr = JSON.parse(localStorage.getItem('justhodl_watch')||'[]'); if (!arr.includes(cleaned)) { arr.push(cleaned); localStorage.setItem('justhodl_watch', JSON.stringify(arr)); loadWatchlist(); }
    }
    function removeWatch(sym) { const arr = JSON.parse(localStorage.getItem('justhodl_watch')||'[]'); const filtered = arr.filter(s=>s!==sym); localStorage.setItem('justhodl_watch', JSON.stringify(filtered)); loadWatchlist(); }

    // UI Wiring
    document.getElementById('refreshBtn').addEventListener('click', fetchData);
    document.getElementById('metricSelect').addEventListener('change', ()=> updateChart(lastPayload || {}));
    document.getElementById('timeframe').addEventListener('change', ()=> updateChart(lastPayload || {}));
    document.getElementById('addWatch').addEventListener('click', ()=> { addWatch(document.getElementById('watchInput').value); document.getElementById('watchInput').value=''; });
    document.getElementById('openBasicChart').addEventListener('click', ()=> { window.open(BASIC_CHART_URL + '?chart_type=liquidity&timeframe=24h','_blank'); });
    document.getElementById('openAdvChart').addEventListener('click', ()=> { window.open(ADV_CHART_URL + '?type=candlestick&period=1D&indicator=sp500','_blank'); });
    document.getElementById('downloadJson').addEventListener('click', ()=> {
      if(!lastPayload) return toast('No payload to download');
      const blob = new Blob([JSON.stringify(lastPayload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'justhodl_payload.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Auto-refresh logic
    document.getElementById('autoRefresh').addEventListener('change', (e)=>{
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      const val = Number(e.target.value);
      if (val>0) autoRefreshTimer = setInterval(fetchData, val);
    });

    // init
    loadWatchlist();
    fetchData();
  </script>
</body>
</html>
