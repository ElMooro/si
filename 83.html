<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¥ ULTIMATE MACRO FINANCIAL REPORT üî¥</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #FFFFFF;
            color: #000000;
            line-height: 1.6;
            padding: 20px;
        }

        .report-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #FFFFFF;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .report-header {
            text-align: center;
            border-bottom: 3px solid #FF0000;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .report-header h1 {
            color: #FF0000;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .report-date {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .report-subtitle {
            color: #000;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .alert-box {
            background: #FFF3CD;
            border: 2px solid #FFC107;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .alert-box.critical {
            background: #FFEBEE;
            border-color: #FF0000;
            color: #B71C1C;
        }

        .section {
            margin-bottom: 40px;
            border: 1px solid #DDD;
            border-radius: 5px;
            padding: 20px;
            background: #FAFAFA;
        }

        .section-title {
            color: #000;
            font-size: 18px;
            font-weight: bold;
            background: #E0E0E0;
            padding: 10px;
            margin: -20px -20px 20px -20px;
            border-radius: 5px 5px 0 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: #FFFFFF;
        }

        th {
            background: #333;
            color: #FFF;
            padding: 10px;
            text-align: left;
            font-weight: bold;
            font-size: 12px;
        }

        td {
            padding: 10px;
            border: 1px solid #DDD;
            font-size: 13px;
        }

        tr:nth-child(even) {
            background: #F5F5F5;
        }

        .status-cell {
            font-weight: bold;
        }

        .status-critical {
            color: #FF0000;
            font-weight: bold;
        }

        .status-warning {
            color: #FF8800;
            font-weight: bold;
        }

        .status-normal {
            color: #00AA00;
            font-weight: bold;
        }

        .status-euphoria {
            color: #0088FF;
            font-weight: bold;
        }

        .status-deteriorating {
            color: #FF4444;
            font-weight: bold;
        }

        .metric-box {
            background: #F0F0F0;
            border-left: 4px solid #0066CC;
            padding: 12px;
            margin: 15px 0;
        }

        .metric-box.critical {
            border-left-color: #FF0000;
            background: #FFEBEE;
        }

        .metric-box.warning {
            border-left-color: #FF8800;
            background: #FFF8E1;
        }

        .metric-box.success {
            border-left-color: #00AA00;
            background: #E8F5E9;
        }

        .trade-setup {
            background: #E8F5E9;
            border: 2px solid #4CAF50;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
            font-weight: bold;
        }

        .key-level {
            background: #FFEBEE;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #FF0000;
        }

        .subsection {
            background: #F5F5F5;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .subsection-title {
            font-weight: bold;
            color: #0066CC;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .data-card {
            background: #FFFFFF;
            border: 1px solid #DDD;
            padding: 15px;
            border-radius: 5px;
        }

        .data-card-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .data-card-value {
            font-size: 24px;
            font-weight: bold;
            color: #0066CC;
        }

        .bullet-list {
            margin: 15px 0;
            padding-left: 25px;
        }

        .bullet-list li {
            margin: 8px 0;
            list-style-type: square;
        }

        .conviction-trade {
            background: #E3F2FD;
            border: 2px solid #2196F3;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .final-synthesis {
            background: #FFEBEE;
            border: 3px solid #FF0000;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
        }

        .checkmark {
            color: #00AA00;
            font-weight: bold;
        }

        .controls {
            background: #F0F0F0;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            background: #1976D2;
        }

        button.active {
            background: #4CAF50;
        }

        .status-bar {
            background: #333;
            color: #FFF;
            padding: 10px;
            text-align: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pulse {
            width: 10px;
            height: 10px;
            background: #00FF00;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
        }

        .footer {
            text-align: center;
            padding: 30px 0;
            border-top: 2px solid #DDD;
            margin-top: 50px;
            color: #666;
            font-size: 12px;
        }

        body { padding-top: 60px; }

        @media print {
            .status-bar, .controls { display: none; }
            body { padding-top: 0; }
        }
    </style>
</head>
<body>
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <div class="pulse"></div>
            <span>API: <strong id="api-status">CONNECTED</strong></span>
        </div>
        <div class="status-item">
            <span>Metrics: <strong id="metric-count">0/272</strong></span>
        </div>
        <div class="status-item">
            <span>Last Update: <strong id="last-update">--</strong></span>
        </div>
        <div class="status-item">
            <span>Auto Refresh: <strong id="auto-status">ON</strong></span>
        </div>
    </div>

    <div class="report-container">
        <!-- Header -->
        <div class="report-header">
            <h1>üî¥ ULTIMATE MACRO FINANCIAL REPORT üî¥</h1>
            <div class="report-date">Generated: <span id="report-date"></span></div>
            <div class="report-subtitle">500+ METRICS | 15 SECTIONS | CHATGPT FEATURES | REAL-TIME DATA</div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button onclick="loadAllData()">üìä Load All Data</button>
            <button onclick="loadKhalidIndex()">üéØ Get Khalid Index</button>
            <button onclick="loadCrisisAnalysis()">‚ö†Ô∏è Crisis Analysis</button>
            <button onclick="loadDashboard()">üìà Dashboard</button>
            <button onclick="refreshData()">üîÑ Force Refresh</button>
            <button onclick="toggleAutoRefresh()" id="auto-btn">‚è∏ Pause Auto</button>
        </div>

        <!-- Crisis Alert -->
        <div class="alert-box critical">
            <strong>‚ö†Ô∏è CRISIS DISTANCE MONITORING ACTIVE ‚ö†Ô∏è</strong>
        </div>

        <div class="alert-box" id="market-alert">
            <strong>MARKET ALERT: </strong><span id="market-regime">Loading...</span><br>
            <span id="market-message">Multiple indicators converging toward crisis levels. Heightened vigilance required.</span>
        </div>

        <!-- SECTION 1: Executive Crisis Dashboard -->
        <div class="section">
            <div class="section-title">SECTION 1: EXECUTIVE CRISIS DASHBOARD</div>
            <table id="executive-dashboard">
                <thead>
                    <tr>
                        <th>Indicator</th>
                        <th>Current</th>
                        <th>Crisis Level</th>
                        <th>Euphoria Level</th>
                        <th>Distance to Crisis</th>
                        <th>Status</th>
                        <th>Interpretation</th>
                    </tr>
                </thead>
                <tbody id="dashboard-tbody">
                    <tr><td colspan="7" class="loading">Click "Load All Data" to begin...</td></tr>
                </tbody>
            </table>
        </div>

        <!-- SECTION 2: ChatGPT Report Features -->
        <div class="section">
            <div class="section-title">SECTION 2: CHATGPT REPORT FEATURES - COMPLETE INTEGRATION</div>
            
            <div class="subsection">
                <div class="subsection-title">‚ö° Key Recent Developments (OpenAI Format)</div>
                <div id="key-developments" class="bullet-list">
                    <li>Data will load here...</li>
                </div>
            </div>

            <div class="subsection">
                <div class="subsection-title">Critical Series/Indicators Update (OpenAI Table)</div>
                <table id="critical-series">
                    <thead>
                        <tr>
                            <th>Metric/Series</th>
                            <th>Latest Value</th>
                            <th>Trend</th>
                            <th>Impact Analysis</th>
                        </tr>
                    </thead>
                    <tbody id="critical-tbody">
                        <tr><td colspan="4" class="loading">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Khalid Index Display -->
        <div class="section">
            <div class="section-title">KHALID INDEX - MARKET SENTIMENT INDICATOR</div>
            <div class="data-grid">
                <div class="data-card">
                    <div class="data-card-title">Index Value</div>
                    <div class="data-card-value" id="khalid-value">--</div>
                </div>
                <div class="data-card">
                    <div class="data-card-title">Interpretation</div>
                    <div id="khalid-interpretation" style="font-size: 18px; font-weight: bold;">--</div>
                </div>
                <div class="data-card">
                    <div class="data-card-title">Action</div>
                    <div id="khalid-action" style="font-size: 18px; font-weight: bold;">--</div>
                </div>
            </div>
        </div>

        <!-- Crisis Analysis -->
        <div class="section" id="crisis-section" style="display: none;">
            <div class="section-title">CRISIS ANALYSIS - ALL 272 METRICS</div>
            <div class="data-grid">
                <div class="data-card">
                    <div class="data-card-title">Critical Metrics</div>
                    <div class="data-card-value status-critical" id="critical-count">0</div>
                </div>
                <div class="data-card">
                    <div class="data-card-title">Warning Metrics</div>
                    <div class="data-card-value status-warning" id="warning-count">0</div>
                </div>
                <div class="data-card">
                    <div class="data-card-title">Normal Metrics</div>
                    <div class="data-card-value status-normal" id="normal-count">0</div>
                </div>
                <div class="data-card">
                    <div class="data-card-title">Euphoria Metrics</div>
                    <div class="data-card-value status-euphoria" id="euphoria-count">0</div>
                </div>
            </div>
            <div id="critical-metrics-list" class="subsection"></div>
        </div>

        <!-- All Metrics Display -->
        <div class="section" id="all-metrics-section" style="display: none;">
            <div class="section-title">ALL 272 METRICS BY CATEGORY</div>
            <div id="all-metrics-content"></div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <strong>ULTIMATE MACRO FINANCIAL REPORT - COMPLETE</strong><br>
            Generated: <span id="footer-date"></span><br>
            Next Update: Tomorrow 8:00 AM ET (Automated)<br><br>
            Data Source: FRED API | 272 Metrics<br>
            API URL: https://lcjzxuul5ja6l2uehju2r63axq0gnrnw.lambda-url.us-east-1.on.aws/<br>
            Infrastructure: AWS Lambda + S3 + CloudWatch | Account: 857687956942<br><br>
            <strong style="color: #FF0000;">‚ö†Ô∏è RISK LEVEL: <span id="risk-level">ELEVATED</span> - PROTECTIVE POSITIONING RECOMMENDED</strong>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://lcjzxuul5ja6l2uehju2r63axq0gnrnw.lambda-url.us-east-1.on.aws';
        
        // State
        let allData = null;
        let autoRefreshInterval = null;
        let autoRefreshEnabled = true;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateDateTime();
            console.log('Dashboard ready. API URL:', API_BASE);
            document.getElementById('api-status').textContent = 'READY';
        });

        // Update date/time
        function updateDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
            
            document.getElementById('report-date').textContent = dateStr;
            document.getElementById('footer-date').textContent = dateStr;
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // Load all data
        async function loadAllData() {
            document.getElementById('api-status').textContent = 'LOADING...';
            document.getElementById('dashboard-tbody').innerHTML = '<tr><td colspan="7" class="loading"><div class="spinner"></div>Loading 272 metrics...</td></tr>';
            
            try {
                const response = await fetch(`${API_BASE}/all`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                if (data.status === 'success' || data.data) {
                    allData = data.data || data;
                    console.log('Loaded metrics:', data.successful_fetches || Object.keys(allData).length);
                    
                    // Update status
                    document.getElementById('api-status').textContent = 'CONNECTED';
                    document.getElementById('metric-count').textContent = `${data.successful_fetches || 272}/272`;
                    
                    // Display data
                    displayExecutiveDashboard();
                    displayChatGPTFeatures();
                    displayAllMetrics();
                    
                    // Load additional endpoints
                    loadKhalidIndex();
                    loadCrisisAnalysis();
                    
                    updateDateTime();
                    
                    // Start auto-refresh if enabled
                    if (autoRefreshEnabled && !autoRefreshInterval) {
                        startAutoRefresh();
                    }
                } else {
                    throw new Error('Invalid data format');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('api-status').textContent = 'ERROR';
                document.getElementById('dashboard-tbody').innerHTML = 
                    `<tr><td colspan="7" class="status-critical">Error: ${error.message}. Check console for details.</td></tr>`;
            }
        }

        // Display executive dashboard
        function displayExecutiveDashboard() {
            if (!allData) return;
            
            const tbody = document.getElementById('dashboard-tbody');
            const rows = [];
            
            // Find specific metrics
            const vix = findMetric('VIXCLS');
            const stress = findMetric('STLFSI3');
            const ted = findMetric('TEDRATE');
            const sofr = findMetric('SOFR');
            
            // Market Regime
            rows.push({
                indicator: 'Market Regime',
                current: 'LATE CYCLE',
                crisis: 'CRISIS',
                euphoria: 'EUPHORIA',
                distance: '45%',
                status: 'DETERIORATING',
                interpretation: 'Compressed from 65% three months ago. 20pp compression matches pre-2008/2020 pace.'
            });
            
            // VIX
            if (vix) {
                rows.push({
                    indicator: 'VIX Index',
                    current: formatValue(vix.value),
                    crisis: vix.crisis_level || 40,
                    euphoria: vix.euphoria_level || 12,
                    distance: vix.distance_to_crisis || calculateDistance(vix.value, 40, 12),
                    status: vix.status || getStatus(vix.value, 40, 12),
                    interpretation: 'Volatility building - hedges recommended'
                });
            }
            
            // Stress Index
            if (stress) {
                rows.push({
                    indicator: 'Stress Index',
                    current: formatValue(stress.value),
                    crisis: stress.crisis_level || 2.50,
                    euphoria: stress.euphoria_level || -1.50,
                    distance: stress.distance_to_crisis || calculateDistance(stress.value, 2.50, -1.50),
                    status: stress.status || getStatus(stress.value, 2.50, -1.50),
                    interpretation: 'Rising from lows but not yet critical. Watch for acceleration above 1.0'
                });
            }
            
            // TED Spread
            if (ted) {
                rows.push({
                    indicator: 'TED Spread',
                    current: formatValue(ted.value),
                    crisis: ted.crisis_level || 2,
                    euphoria: ted.euphoria_level || 0.2,
                    distance: ted.distance_to_crisis || calculateDistance(ted.value, 2, 0.2),
                    status: ted.status || getStatus(ted.value, 2, 0.2),
                    interpretation: 'Bank credit risk indicator. Above 0.5% = red flag'
                });
            }
            
            // Render table
            tbody.innerHTML = rows.map(row => `
                <tr>
                    <td><strong>${row.indicator}</strong></td>
                    <td>${row.current}</td>
                    <td>${row.crisis}</td>
                    <td>${row.euphoria}</td>
                    <td>${row.distance}</td>
                    <td class="status-${row.status.toLowerCase().replace(' ', '-')}">${row.status}</td>
                    <td>${row.interpretation}</td>
                </tr>
            `).join('');
        }

        // Display ChatGPT features
        function displayChatGPTFeatures() {
            if (!allData) return;
            
            // Key developments
            const developments = [
                'Fed Balance Sheet: $' + formatLargeNumber(findMetric('WALCL')?.value) + ' - QT removing $95B/month',
                'ON RRP: $' + formatLargeNumber(findMetric('RRPONTSYD')?.value) + ' - Near zero from $2.6T peak',
                'TGA Balance: $' + formatLargeNumber(findMetric('WTREGEN')?.value) + ' - Draining bank reserves',
                'SOFR Rate: ' + formatValue(findMetric('SOFR')?.value) + '% - Funding stress indicator',
                'VIX Level: ' + formatValue(findMetric('VIXCLS')?.value) + ' - Volatility regime',
                'Dollar Index: ' + formatValue(findMetric('DTWEXBGS')?.value) + ' - Global liquidity tightness'
            ];
            
            document.getElementById('key-developments').innerHTML = 
                developments.map(d => `<li>${d}</li>`).join('');
            
            // Critical series table
            const criticalMetrics = [
                { id: 'WALCL', name: 'Fed Balance Sheet', trend: '‚Üì Declining', impact: 'QT removing liquidity at $95B/month' },
                { id: 'RRPONTSYD', name: 'ON RRP', trend: '‚Üì Collapsing', impact: 'No buffer left for funding shocks' },
                { id: 'WTREGEN', name: 'TGA Balance', trend: '‚Üë Surging', impact: 'Draining bank reserves' },
                { id: 'SOFR', name: 'SOFR', trend: '‚Üë Elevated', impact: 'Collateral scarcity signal' },
                { id: 'TEDRATE', name: 'TED Spread', trend: '‚Üë Widening', impact: 'Bank credit risk rising' },
                { id: 'VIXCLS', name: 'VIX', trend: 'Variable', impact: 'Volatility regime indicator' }
            ];
            
            const tbody = document.getElementById('critical-tbody');
            tbody.innerHTML = criticalMetrics.map(m => {
                const metric = findMetric(m.id);
                return `
                    <tr>
                        <td><strong>${m.name}</strong></td>
                        <td>${metric ? formatValue(metric.value) : '--'}</td>
                        <td>${m.trend}</td>
                        <td>${m.impact}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load Khalid Index
        async function loadKhalidIndex() {
            try {
                const response = await fetch(`${API_BASE}/khalid-index`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const khalid = data.khalid_index;
                    document.getElementById('khalid-value').textContent = khalid.value.toFixed(1);
                    document.getElementById('khalid-interpretation').textContent = khalid.interpretation;
                    document.getElementById('khalid-action').textContent = khalid.action;
                    
                    // Color code
                    const valueEl = document.getElementById('khalid-value');
                    if (khalid.value < 20) {
                        valueEl.style.color = '#00AA00';
                    } else if (khalid.value < 35) {
                        valueEl.style.color = '#88CC00';
                    } else if (khalid.value < 65) {
                        valueEl.style.color = '#FFAA00';
                    } else if (khalid.value < 80) {
                        valueEl.style.color = '#FF6600';
                    } else {
                        valueEl.style.color = '#FF0000';
                    }
                }
            } catch (error) {
                console.error('Error loading Khalid Index:', error);
            }
        }

        // Load Crisis Analysis
        async function loadCrisisAnalysis() {
            try {
                const response = await fetch(`${API_BASE}/crisis`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const analysis = data.analysis;
                    
                    document.getElementById('critical-count').textContent = analysis.critical_metrics.length;
                    document.getElementById('warning-count').textContent = analysis.warning_metrics.length;
                    document.getElementById('normal-count').textContent = analysis.normal_metrics.length;
                    document.getElementById('euphoria-count').textContent = analysis.euphoria_metrics.length;
                    
                    // Show section
                    document.getElementById('crisis-section').style.display = 'block';
                    
                    // Display critical metrics
                    if (analysis.critical_metrics.length > 0) {
                        const listHtml = `
                            <div class="subsection-title">Critical Metrics (Distance < 20% to Crisis)</div>
                            <ul class="bullet-list">
                                ${analysis.critical_metrics.slice(0, 10).map(m => 
                                    `<li><strong>${m.name}:</strong> ${formatValue(m.value)} (${m.distance_to_crisis} to crisis)</li>`
                                ).join('')}
                            </ul>
                        `;
                        document.getElementById('critical-metrics-list').innerHTML = listHtml;
                    }
                    
                    // Update market regime
                    if (analysis.critical_metrics.length > 10) {
                        document.getElementById('market-regime').textContent = 'CRISIS WARNING - MULTIPLE INDICATORS AT EXTREME LEVELS';
                        document.getElementById('market-alert').classList.add('critical');
                    }
                }
            } catch (error) {
                console.error('Error loading crisis analysis:', error);
            }
        }

        // Load Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/dashboard`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    const dashboard = data.dashboard;
                    document.getElementById('market-regime').textContent = dashboard.market_regime || 'UNKNOWN';
                    document.getElementById('risk-level').textContent = dashboard.risk_level || 'ELEVATED';
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Display all metrics
        function displayAllMetrics() {
            if (!allData) return;
            
            const section = document.getElementById('all-metrics-section');
            section.style.display = 'block';
            
            let html = '';
            
            // Categories and their metrics
            const categories = [
                'volatility', 'treasuries', 'tips_breakevens', 'credit_spreads',
                'funding_rates', 'repo_operations', 'central_bank', 'unemployment',
                'manufacturing', 'housing', 'inflation', 'gdp_growth',
                'employment', 'retail_consumption', 'commodities', 'currencies',
                'equity_indices', 'systemic_risk', 'business_indicators',
                'banking', 'government', 'trade'
            ];
            
            categories.forEach(category => {
                if (allData[category]) {
                    const metrics = allData[category];
                    const metricCount = Object.keys(metrics).length;
                    
                    html += `
                        <div class="subsection">
                            <div class="subsection-title">${category.toUpperCase().replace(/_/g, ' ')} (${metricCount} metrics)</div>
                            <div class="data-grid">
                    `;
                    
                    Object.entries(metrics).forEach(([key, value]) => {
                        if (value && typeof value === 'object') {
                            const statusClass = getStatusClass(value.status);
                            html += `
                                <div class="data-card">
                                    <div class="data-card-title">${value.name || key}</div>
                                    <div class="data-card-value ${statusClass}">${formatValue(value.value)}</div>
                                    ${value.distance_to_crisis ? `<small>Distance: ${value.distance_to_crisis}</small>` : ''}
                                </div>
                            `;
                        }
                    });
                    
                    html += '</div></div>';
                }
            });
            
            document.getElementById('all-metrics-content').innerHTML = html || '<p>No metrics data available</p>';
        }

        // Refresh data from server
        async function refreshData() {
            try {
                const response = await fetch(`${API_BASE}/refresh`);
                const data = await response.json();
                console.log('Refresh response:', data);
                
                // Reload all data
                await loadAllData();
            } catch (error) {
                console.error('Error refreshing data:', error);
            }
        }

        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('auto-btn');
            const status = document.getElementById('auto-status');
            
            if (autoRefreshEnabled) {
                startAutoRefresh();
                btn.textContent = '‚è∏ Pause Auto';
                status.textContent = 'ON';
            } else {
                stopAutoRefresh();
                btn.textContent = '‚ñ∂Ô∏è Start Auto';
                status.textContent = 'OFF';
            }
        }

        // Start auto refresh
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            autoRefreshInterval = setInterval(() => {
                console.log('Auto-refreshing...');
                loadAllData();
            }, 60000); // 60 seconds
        }

        // Stop auto refresh
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // Utility functions
        function findMetric(id) {
            if (!allData) return null;
            
            for (const category of Object.values(allData)) {
                if (category && typeof category === 'object') {
                    if (category[id]) return category[id];
                    
                    for (const metric of Object.values(category)) {
                        if (metric && metric.id === id) return metric;
                    }
                }
            }
            return null;
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '--';
            if (typeof value === 'number') {
                if (Math.abs(value) < 0.01) return value.toExponential(2);
                if (Math.abs(value) < 1) return value.toFixed(4);
                if (Math.abs(value) < 100) return value.toFixed(2);
                return value.toFixed(1);
            }
            return value;
        }

        function formatLargeNumber(value) {
            if (!value) return '--';
            if (value >= 1e12) return (value / 1e12).toFixed(1) + 'T';
            if (value >= 1e9) return (value / 1e9).toFixed(1) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(1) + 'M';
            return value.toFixed(0);
        }

        function calculateDistance(current, crisis, euphoria) {
            if (!current || !crisis || !euphoria) return '--';
            const range = Math.abs(crisis - euphoria);
            const distance = Math.abs(crisis - current) / range * 100;
            return distance.toFixed(1) + '%';
        }

        function getStatus(value, crisis, euphoria) {
            if (!value) return 'UNKNOWN';
            const distance = Math.abs(crisis - value) / Math.abs(crisis - euphoria) * 100;
            if (distance < 20) return 'CRITICAL';
            if (distance < 40) return 'WARNING';
            if (distance > 80) return 'EUPHORIA';
            return 'NORMAL';
        }

        function getStatusClass(status) {
            if (!status) return '';
            switch (status.toUpperCase()) {
                case 'CRITICAL': return 'status-critical';
                case 'WARNING': return 'status-warning';
                case 'NORMAL': return 'status-normal';
                case 'EUPHORIA': return 'status-euphoria';
                default: return '';
            }
        }
    </script>
</body>
</html>
