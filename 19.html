<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Financial Intelligence Platform - SDK v4.0</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <style>
        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary-green: #00ff88;
            --primary-blue: #00ccff;
            --bg-primary: #0a0a0a;
            --bg-secondary: #121212;
            --bg-tertiary: #1a1a1a;
            --border-color: #282828;
            --text-primary: #e0e0e0;
            --text-secondary: #aaa;
            --success: #00dd77;
            --error: #ff4444;
            --warning: #ffaa00;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }
        
        /* Navigation Bar */
        nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .nav-logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
            position: relative;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .nav-links a:hover {
            color: var(--primary-green);
            background: rgba(0, 255, 136, 0.1);
        }

        .nav-links a.active {
            color: var(--primary-green);
            background: rgba(0, 255, 136, 0.2);
        }

        /* Header with Enhanced Status */
        .header {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 999;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .system-stats {
            display: flex;
            gap: 20px;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stat-value {
            color: var(--primary-green);
            font-weight: bold;
        }
        
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 141px);
        }
        
        /* Enhanced Search Section */
        .search-section {
            background: var(--bg-secondary);
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }
        
        .search-container {
            position: relative;
            width: 100%;
            max-width: 900px;
        }
        
        .search-box {
            width: 100%;
            padding: 15px 50px 15px 20px;
            background: #222;
            border: 2px solid #333;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            font-size: 18px;
            pointer-events: none;
        }
        
        /* Enhanced Search Results */
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            margin-top: 5px;
            max-height: 600px;
            overflow-y: auto;
            background: #181818;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        .search-loading {
            padding: 20px;
            text-align: center;
            color: var(--primary-green);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .search-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.15s;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }
        
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { 
            background: #252525; 
            padding-left: 25px;
        }
        
        .search-item-left {
            flex: 1;
        }
        
        .search-item-symbol {
            font-weight: bold;
            color: var(--success);
            font-size: 16px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .search-item-name {
            font-size: 14px;
            color: #ddd;
            margin-bottom: 4px;
        }
        
        .search-item-metadata {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }
        
        .search-item-source {
            font-size: 11px;
            color: #888;
            background: #2a2a2a;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        /* Content Area */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        
        /* Watchlist Section */
        .watchlist-section {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            height: 500px;
            overflow-y: auto;
            position: relative;
            flex: 1;
        }
        
        .watchlist-header {
            background: var(--bg-tertiary);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .watchlist-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .watchlist-selector {
            background: #252525;
            color: #fff;
            border: 1px solid #333;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .watchlist-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .add-watchlist {
            background: var(--success);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Enhanced Table Styles */
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        
        .watchlist-table th {
            background: #f5f5f5;
            color: #333;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 57px;
            z-index: 5;
            cursor: default;
        }
        
        .watchlist-table tbody tr {
            transition: all 0.2s;
            cursor: pointer;
            background: #fff;
            color: #333;
            position: relative;
        }
        
        .watchlist-table tbody tr:hover {
            background: #f8f8f8;
            transform: translateX(2px);
        }
        
        .watchlist-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            color: #333;
        }
        
        .symbol-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .symbol-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-green), var(--primary-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }
        
        .symbol-info {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 0;
        }
        
        .symbol-name {
            font-weight: bold;
            color: #000;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .symbol-fullname {
            color: #666;
            font-size: 11px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .price-cell {
            font-weight: bold;
            color: #000;
            text-align: right;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .change-cell {
            text-align: right;
            font-weight: bold;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .positive { color: var(--success); }
        .negative { color: var(--error); }
        .neutral { color: #666; }
        
        .control-btn {
            background: #252525;
            border: 1px solid #383838;
            color: #ccc;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-btn:hover {
            background: #333;
            border-color: #555;
            color: #fff;
            transform: translateY(-1px);
        }
        
        .control-btn.primary {
            background: var(--primary-green);
            border-color: var(--primary-green);
            color: #000;
            font-weight: bold;
        }
        
        /* Loading States */
        .loading-pulse { 
            animation: pulse 1.5s infinite ease-in-out; 
            color: var(--primary-green);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-green);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.2); }
        }
        
        /* Message Popups */
        .message-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #222;
            border: 1px solid #333;
            padding: 15px 20px;
            border-radius: 6px;
            z-index: 2000;
            animation: slideInAndOut 3s ease-in-out forwards;
            max-width: 400px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        
        .message-popup.info { 
            border-color: var(--success); 
            background: linear-gradient(135deg, #222, #1a3a1a);
        }
        
        .message-popup.error { 
            border-color: var(--error); 
            color: #ff6666;
            background: linear-gradient(135deg, #222, #3a1a1a);
        }
        
        @keyframes slideInAndOut {
            0% { transform: translateX(120%); opacity: 0; }
            15%, 85% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(120%); opacity: 0; }
        }
        
        /* API Status Display */
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            transition: all 0.3s;
        }
        
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 10px rgba(0, 221, 119, 0.5);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary-green);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--error);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .search-section {
                padding: 15px;
            }
            
            .watchlist-section {
                height: 400px;
            }
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { 
            background: #333; 
            border-radius: 5px;
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-logo">
            <span>📊</span>
            <span>OPENBB FINANCIAL INTELLIGENCE</span>
        </div>
        <div class="nav-links">
            <a href="#" class="active" onclick="showSection('platform')">Platform</a>
            <a href="#" onclick="showSection('search')">Search</a>
            <a href="#" onclick="showSection('watchlists')">Watchlists</a>
            <a href="#" onclick="showSection('api')">API Explorer</a>
            <a href="#" onclick="showDocumentation()">Documentation</a>
            <a href="#" onclick="showSystemStatus()">System Status</a>
        </div>
    </nav>

    <!-- Main Header -->
    <div class="header">
        <div class="logo">
            <span>📊</span>
            <span>OPENBB SDK v4.0 - 66,204+ INDICATORS</span>
        </div>
        
        <div class="system-stats">
            <div class="stat-item">
                <span>System 1:</span>
                <span class="stat-value" id="system1Stat">6,204</span>
            </div>
            <div class="stat-item">
                <span>System 2:</span>
                <span class="stat-value" id="system2Stat">60,000</span>
            </div>
            <div class="stat-item">
                <span>Total:</span>
                <span class="stat-value">66,204+</span>
            </div>
        </div>
        
        <div class="header-controls">
            <div class="api-status">
                <div class="status-dot" id="apiStatus"></div>
                <span id="apiStatusText">Initializing SDK...</span>
            </div>
            <button class="control-btn primary" onclick="testAllSystems()">
                <span>🔍</span>
                <span>Test Systems</span>
            </button>
            <span id="clock" style="color: #888; font-size: 14px; font-family: monospace;"></span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Enhanced Search Section -->
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox"
                       placeholder="Search 66,204+ indicators: stocks (AAPL), economic data (GDP, inflation), rates (SOFR), currencies, crypto..."
                       autocomplete="off">
                <span class="search-icon">🔍</span>
                <div class="search-results" id="searchResults" style="display: none;"></div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content">
            <!-- Watchlist Section -->
            <div class="watchlist-section">
                <div class="watchlist-header">
                    <div class="watchlist-title">
                        <span>📋</span>
                        <select class="watchlist-selector" id="watchlistSelector" onchange="switchWatchlist(this.value)">
                            <option value="main">MAIN WATCHLIST</option>
                            <option value="economic">ECONOMIC INDICATORS</option>
                            <option value="rates">INTEREST RATES</option>
                            <option value="stocks">TOP STOCKS</option>
                        </select>
                    </div>
                    <div class="watchlist-controls">
                        <button class="add-watchlist" onclick="document.getElementById('searchBox').focus()">
                            <span>+</span>
                            <span>Add Symbol</span>
                        </button>
                        <button class="control-btn" onclick="refreshWatchlist()">
                            <span>🔄</span>
                            <span>Refresh</span>
                        </button>
                        <button class="control-btn" onclick="toggleAutoRefresh()">
                            <span id="autoRefreshIcon">⏸️</span>
                            <span id="autoRefreshText">Auto Refresh: OFF</span>
                        </button>
                    </div>
                </div>
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Symbol / Indicator</th>
                            <th style="text-align: right;">Current Value</th>
                            <th style="text-align: right;">Daily Change</th>
                            <th style="text-align: right;">% Change</th>
                            <th style="text-align: right;">Provider</th>
                            <th style="text-align: right;">Last Update</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #888;">
                                <div class="loading-pulse">Initializing OpenBB SDK v4.0...</div>
                                <div style="font-size: 12px; margin-top: 10px;">
                                    Connecting to 66,204+ financial indicators
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Load the SDK -->
    <script src="paste.txt"></script>
    
    <script>
        // Global variables
        let sdk = null;
        let currentWatchlist = 'main';
        let watchlistData = {};
        let searchTimeout = null;
        let autoRefreshEnabled = false;
        
        // Predefined watchlists
        const WATCHLISTS = {
            'main': {
                name: 'Main Dashboard',
                symbols: ['AAPL', 'FEDFUNDS', 'UNRATE', 'GDP', 'DGS10', 'CPIAUCSL', 'sofr']
            },
            'economic': {
                name: 'Economic Indicators',
                symbols: ['GDP', 'UNRATE', 'CPIAUCSL', 'PAYEMS', 'HOUST', 'INDPRO', 'M2SL']
            },
            'rates': {
                name: 'Interest Rates',
                symbols: ['FEDFUNDS', 'DGS1', 'DGS2', 'DGS10', 'DGS30', 'sofr', 'effr']
            },
            'stocks': {
                name: 'Top Stocks',
                symbols: ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'SPY', 'QQQ', 'NVDA']
            }
        };
        
        // Initialize the platform
        async function init() {
            console.log('🚀 Initializing OpenBB Platform with SDK v4.0...');
            
            // Initialize SDK
            try {
                sdk = new OpenBBSDK({
                    cache: true,
                    parallelRequests: true,
                    autoRefresh: false,
                    refreshInterval: 30000, // 30 seconds
                    useProxy: true // Enable proxy for CORS
                });
                
                console.log('✅ SDK initialized successfully');
                
                // Set up event listeners
                setupEventListeners();
                
                // Check system status
                await checkSystemStatus();
                
                // Start clock
                updateClock();
                setInterval(updateClock, 1000);
                
                // Load initial watchlist
                await loadWatchlist();
                
                showMessage('OpenBB SDK v4.0 initialized successfully!', 'info');
                
            } catch (error) {
                console.error('❌ SDK initialization error:', error);
                showMessage('Failed to initialize SDK: ' + error.message, 'error');
            }
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Search box
            const searchBox = document.getElementById('searchBox');
            searchBox.addEventListener('keyup', (e) => {
                handleSearch(e.target.value);
            });
            
            // SDK events
            sdk.on('watchlist:add', (e) => {
                console.log('Watchlist add event:', e.detail);
                renderWatchlist();
            });
            
            sdk.on('watchlist:update', (e) => {
                console.log('Watchlist update event:', e.detail);
                renderWatchlist();
            });
            
            sdk.on('watchlist:remove', (e) => {
                console.log('Watchlist remove event:', e.detail);
            });
            
            // Click outside to close search
            document.addEventListener('click', (e) => {
                const searchBox = document.getElementById('searchBox');
                const searchResults = document.getElementById('searchResults');
                
                if (!searchBox.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + K to focus search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    searchBox.focus();
                }
                
                // Escape to close modals
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay').forEach(m => m.remove());
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
        }
        
        // Check system status
        async function checkSystemStatus() {
            try {
                const status = await sdk.getSystemStatus();
                console.log('System status:', status);
                
                let connectedSystems = 0;
                if (status.systems.system1?.status === 'operational') connectedSystems++;
                if (status.systems.system2?.status === 'operational') connectedSystems++;
                if (status.systems.system3?.status === 'operational') connectedSystems++;
                
                const statusDot = document.getElementById('apiStatus');
                const statusText = document.getElementById('apiStatusText');
                
                if (connectedSystems === 3) {
                    statusDot.classList.add('connected');
                    statusText.textContent = 'All Systems Connected';
                } else if (connectedSystems > 0) {
                    statusDot.classList.add('connected');
                    statusText.textContent = `${connectedSystems}/3 Systems Connected`;
                } else {
                    statusText.textContent = 'No Systems Connected';
                }
                
                // Update stats
                if (status.systems.system1?.indicators) {
                    document.getElementById('system1Stat').textContent = status.systems.system1.indicators.toLocaleString();
                }
                if (status.systems.system2?.indicators) {
                    document.getElementById('system2Stat').textContent = status.systems.system2.indicators.toLocaleString();
                }
                
            } catch (error) {
                console.error('Status check error:', error);
                document.getElementById('apiStatusText').textContent = 'Status Check Failed';
            }
        }
        
        // Handle search
        async function handleSearch(query) {
            if (!query || query.trim().length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                await performSearch(query);
            }, 300);
        }
        
        // Perform search using SDK
        async function performSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = '<div class="search-loading"><span class="loading-spinner"></span>Searching 66,204+ indicators...</div>';
            resultsDiv.style.display = 'block';
            
            try {
                // Search all systems
                const results = await sdk.searchAllSystems(query, { limit: 50 });
                console.log('Search results:', results);
                
                if (results.results && results.results.length > 0) {
                    displaySearchResults(results.results);
                } else {
                    // Try fuzzy search
                    const fuzzyResults = await sdk.fuzzySearch(query, { limit: 50 });
                    if (fuzzyResults.results && fuzzyResults.results.length > 0) {
                        displaySearchResults(fuzzyResults.results);
                    } else {
                        resultsDiv.innerHTML = `
                            <div class="search-item" style="text-align:center; color:#888;">
                                No results found for "${query}"
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
                resultsDiv.innerHTML = `
                    <div class="search-item" style="text-align:center; color:#888;">
                        Search error: ${error.message}
                    </div>
                `;
            }
        }
        
        // Display search results
        function displaySearchResults(results) {
            const resultsDiv = document.getElementById('searchResults');
            
            let html = '';
            results.slice(0, 20).forEach(result => {
                html += `
                    <div class="search-item" onclick="addToWatchlist('${result.symbol}')">
                        <div class="search-item-left">
                            <div class="search-item-symbol">${result.symbol}</div>
                            <div class="search-item-name">${result.name || result.symbol}</div>
                            <div class="search-item-metadata">
                                <span class="search-item-source">${result.system || result.source || 'API'}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Add symbol to watchlist
        async function addToWatchlist(symbol) {
            try {
                await sdk.addToWatchlist(symbol, { source: 'manual' });
                
                // Clear search
                document.getElementById('searchBox').value = '';
                document.getElementById('searchResults').style.display = 'none';
                
                showMessage(`Added ${symbol} to watchlist`, 'info');
                
                // Re-render watchlist
                renderWatchlist();
                
            } catch (error) {
                console.error('Add to watchlist error:', error);
                showMessage(`Failed to add ${symbol}: ${error.message}`, 'error');
            }
        }
        
        // Load watchlist
        async function loadWatchlist() {
            const watchlist = WATCHLISTS[currentWatchlist];
            if (!watchlist) return;
            
            console.log(`Loading ${currentWatchlist} watchlist...`);
            
            // Clear current watchlist in SDK
            const currentItems = sdk.getWatchlist();
            currentItems.forEach(item => {
                sdk.removeFromWatchlist(item.symbol);
            });
            
            // Add new symbols
            for (const symbol of watchlist.symbols) {
                try {
                    await sdk.addToWatchlist(symbol, { source: 'preset' });
                    // Small delay to avoid overwhelming APIs
                    await new Promise(resolve => setTimeout(resolve, 100));
                } catch (error) {
                    console.error(`Failed to add ${symbol}:`, error);
                }
            }
            
            renderWatchlist();
        }
        
        // Render watchlist
        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            const watchlistItems = sdk.getWatchlist();
            
            if (watchlistItems.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #888;">
                            No symbols in watchlist. Use search to add indicators.
                        </td>
                    </tr>
                `;
                return;
            }
            
            const formatValue = (value) => {
                if (value === null || value === undefined) return '—';
                if (value >= 1000) return value.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                if (value >= 100) return value.toFixed(2);
                if (value >= 1) return value.toFixed(2);
                return value.toFixed(4);
            };
            
            const formatChange = (change) => {
                if (!change) return '—';
                const value = change.absolute || 0;
                return (value >= 0 ? '+' : '') + value.toFixed(2);
            };
            
            const formatPercent = (change) => {
                if (!change) return '—';
                const value = change.percentage || 0;
                return (value >= 0 ? '+' : '') + value.toFixed(2) + '%';
            };
            
            const getChangeClass = (change) => {
                if (!change) return 'neutral';
                const value = change.percentage || 0;
                if (value > 0) return 'positive';
                if (value < 0) return 'negative';
                return 'neutral';
            };
            
            const formatLastUpdate = (lastUpdate) => {
                if (!lastUpdate) return '—';
                const date = new Date(lastUpdate);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
                return date.toLocaleDateString();
            };
            
            const html = watchlistItems.map(item => {
                const latestData = item.data && item.data.length > 0 ? item.data[item.data.length - 1] : null;
                const currentValue = latestData ? latestData.value : null;
                const change = item.changes ? item.changes.daily : null;
                
                return `
                    <tr>
                        <td>
                            <div class="symbol-cell">
                                <div class="symbol-icon">${item.symbol.charAt(0)}</div>
                                <div class="symbol-info">
                                    <div class="symbol-name">${item.symbol}</div>
                                    <div class="symbol-fullname">${item.name || item.symbol}</div>
                                </div>
                            </div>
                        </td>
                        <td class="price-cell">${formatValue(currentValue)}</td>
                        <td class="change-cell ${getChangeClass(change)}">${formatChange(change)}</td>
                        <td class="change-cell ${getChangeClass(change)}">${formatPercent(change)}</td>
                        <td style="text-align: right;">${item.provider || 'API'}</td>
                        <td style="text-align: right; font-size: 11px; color: #666;">${formatLastUpdate(item.lastUpdate)}</td>
                        <td>
                            <button onclick="removeFromWatchlist('${item.symbol}')" 
                                    style="background: #f5f5f5; border: 1px solid #ddd; color: #333; 
                                           padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">×</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }
        
        // Remove from watchlist
        function removeFromWatchlist(symbol) {
            sdk.removeFromWatchlist(symbol);
            renderWatchlist();
            showMessage(`Removed ${symbol} from watchlist`, 'info');
        }
        
        // Switch watchlist
        async function switchWatchlist(name) {
            currentWatchlist = name;
            await loadWatchlist();
        }
        
        // Refresh watchlist
        async function refreshWatchlist() {
            showMessage('Refreshing watchlist...', 'info');
            
            const items = sdk.getWatchlist();
            for (const item of items) {
                try {
                    await sdk.getRealData(item.symbol, { limit: 1 });
                } catch (error) {
                    console.error(`Failed to refresh ${item.symbol}:`, error);
                }
            }
            
            renderWatchlist();
            showMessage('Watchlist refreshed', 'info');
        }
        
        // Toggle auto refresh
        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            
            const icon = document.getElementById('autoRefreshIcon');
            const text = document.getElementById('autoRefreshText');
            
            if (autoRefreshEnabled) {
                icon.textContent = '▶️';
                text.textContent = 'Auto Refresh: ON';
                
                // Start auto refresh for all symbols
                const items = sdk.getWatchlist();
                items.forEach(item => {
                    sdk.startAutoRefresh(item.symbol, 30000); // 30 seconds
                });
                
                showMessage('Auto refresh enabled (30s interval)', 'info');
            } else {
                icon.textContent = '⏸️';
                text.textContent = 'Auto Refresh: OFF';
                
                // Stop auto refresh for all symbols
                const items = sdk.getWatchlist();
                items.forEach(item => {
                    sdk.stopAutoRefresh(item.symbol);
                });
                
                showMessage('Auto refresh disabled', 'info');
            }
        }
        
        // Test all systems
        async function testAllSystems() {
            showMessage('Testing all systems...', 'info');
            
            try {
                // Get system status
                const status = await sdk.getSystemStatus();
                console.log('System status:', status);
                
                // Get stats
                const stats = await sdk.getStats();
                console.log('System stats:', stats);
                
                // Test search on each system
                console.log('Testing System 1 search...');
                const system1Results = await sdk.search('AAPL', { system: 'system1' });
                console.log('System 1 results:', system1Results);
                
                console.log('Testing System 2 search...');
                const system2Results = await sdk.search('GDP', { system: 'system2' });
                console.log('System 2 results:', system2Results);
                
                console.log('Testing System 3 search...');
                const system3Results = await sdk.search('inflation', { system: 'system3' });
                console.log('System 3 results:', system3Results);
                
                // Show results
                showSystemTestResults(status, stats);
                
            } catch (error) {
                console.error('System test error:', error);
                showMessage('System test failed: ' + error.message, 'error');
            }
        }
        
        // Show system test results
        function showSystemTestResults(status, stats) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">🔧 System Test Results</h2>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                    <div style="padding: 20px;">
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">System Status</h3>
                        <div style="margin-bottom: 20px;">
                            <div style="margin-bottom: 10px;">
                                <strong>System 1 (Lambda/OpenSearch):</strong> 
                                <span style="color: ${status.systems.system1?.status === 'operational' ? 'var(--success)' : 'var(--error)'};">
                                    ${status.systems.system1?.status || 'Unknown'}
                                </span>
                                ${status.systems.system1?.indicators ? ` - ${status.systems.system1.indicators.toLocaleString()} indicators` : ''}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>System 2 (Enhanced API):</strong> 
                                <span style="color: ${status.systems.system2?.status === 'operational' ? 'var(--success)' : 'var(--error)'};">
                                    ${status.systems.system2?.status || 'Unknown'}
                                </span>
                                ${status.systems.system2?.indicators ? ` - ${status.systems.system2.indicators.toLocaleString()} indicators` : ''}
                            </div>
                            <div style="margin-bottom: 10px;">
                                <strong>System 3 (Advanced Features):</strong> 
                                <span style="color: ${status.systems.system3?.status === 'operational' ? 'var(--success)' : 'var(--error)'};">
                                    ${status.systems.system3?.status || 'Unknown'}
                                </span>
                            </div>
                        </div>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">Platform Statistics</h3>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 6px;">
                            <div>Total Indicators: <strong>${status.totalIndicators.toLocaleString()}</strong></div>
                            <div>Operational Systems: <strong>${status.operational}</strong></div>
                            <div>Degraded Systems: <strong>${status.degraded}</strong></div>
                            <div>Offline Systems: <strong>${status.offline}</strong></div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Show documentation
        function showDocumentation() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h2 class="modal-title">📊 OpenBB SDK v4.0 Documentation</h2>
                        <button class="modal-close" onclick="this.parentElement.parentElement.parentElement.remove()">×</button>
                    </div>
                    <div style="padding: 20px; line-height: 1.6;">
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">Overview</h3>
                        <p style="margin-bottom: 20px;">
                            The OpenBB SDK provides access to <strong>66,204+ financial indicators</strong> 
                            through a unified JavaScript interface.
                        </p>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">Key Features</h3>
                        <ul style="margin-bottom: 20px; padding-left: 20px;">
                            <li>Access to all 3 systems (66,204+ indicators)</li>
                            <li>Real-time data fetching</li>
                            <li>Technical indicators calculation</li>
                            <li>Trading signals generation</li>
                            <li>URL data import support</li>
                            <li>Watchlist management</li>
                            <li>Multi-system parallel search</li>
                        </ul>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">Search Examples</h3>
                        <div style="background: #1a1a1a; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                            <code style="color: var(--primary-green);">
                                // Search all systems<br>
                                await sdk.searchAllSystems('inflation');<br><br>
                                
                                // Category search<br>
                                await sdk.categorySearch('employment');<br><br>
                                
                                // Fuzzy search with typo correction<br>
                                await sdk.fuzzySearch('unemploymnt');<br><br>
                                
                                // Get real-time data<br>
                                await sdk.getRealData('AAPL', { limit: 100 });
                            </code>
                        </div>
                        
                        <h3 style="color: var(--primary-green); margin-bottom: 15px;">Keyboard Shortcuts</h3>
                        <ul style="padding-left: 20px;">
                            <li><kbd>Ctrl/Cmd + K</kbd> - Focus search</li>
                            <li><kbd>Escape</kbd> - Close modals</li>
                        </ul>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Show system status
        function showSystemStatus() {
            checkSystemStatus().then(() => {
                testAllSystems();
            });
        }
        
        // Show section
        function showSection(section) {
            document.querySelectorAll('.nav-links a').forEach(a => a.classList.remove('active'));
            event.target.classList.add('active');
            showMessage(`Viewing ${section} section`, 'info');
        }
        
        // Utility functions
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour12: false });
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            document.getElementById('clock').textContent = `${dateStr} ${timeStr}`;
        }
        
        function showMessage(text, type = 'info') {
            const popup = document.createElement('div');
            popup.className = `message-popup ${type}`;
            popup.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${type === 'info' ? '✅' : type === 'error' ? '❌' : '⚠️'}
                    <span>${text}</span>
                </div>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 3000);
        }
        
        // Initialize on DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>