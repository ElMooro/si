<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Financial Intelligence Platform - v8.0 Enhanced</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Market Phase Indicator */
        .market-phase {
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
            animation: pulse 2s infinite;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .phase-bull-start {
            background: linear-gradient(45deg, #00ff88, #00ffaa);
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }
        
        .phase-bull {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
            border: 1px solid #00ff88;
        }
        
        .phase-top {
            background: linear-gradient(45deg, #ffaa00, #ff8800);
            color: #000;
            box-shadow: 0 0 20px rgba(255, 170, 0, 0.5);
            animation: warning-pulse 1s infinite;
        }
        
        .phase-bear {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border: 1px solid #ff4444;
        }
        
        @keyframes warning-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* Liquidity Indicator */
        .liquidity-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .liquidity-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .liquidity-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .liquidity-pumping {
            color: #00ff88;
            animation: pump 1s infinite;
        }
        
        .liquidity-contracting {
            color: #ff4444;
            animation: contract 1s infinite;
        }
        
        @keyframes pump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes contract {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(0.9); }
        }
        
        /* Alert Styles */
        .alert-flash {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            font-weight: bold;
            z-index: 9999;
            animation: flash 0.5s infinite;
        }
        
        .alert-good {
            background: #00ff88;
            color: #000;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.8);
        }
        
        .alert-bad {
            background: #ff4444;
            color: #fff;
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.8);
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Risk Probability Display */
        .risk-probability {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .risk-meter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .risk-percentage {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .risk-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .risk-fill {
            height: 100%;
            transition: width 1s ease, background 1s ease;
        }
        
        /* Editable Metric Names */
        .metric-title-editable {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 3px;
            transition: background 0.3s;
        }
        
        .metric-title-editable:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .metric-title-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ff88;
            color: #fff;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.875rem;
            width: 100%;
        }
        
        /* Metric Interpretation */
        .metric-interpretation {
            font-size: 0.75rem;
            color: #aaa;
            margin-top: 0.5rem;
            font-style: italic;
        }
        
        .interpretation-good {
            color: #00ff88;
        }
        
        .interpretation-bad {
            color: #ff4444;
        }
        
        .interpretation-neutral {
            color: #ffaa00;
        }
        
        /* Historical Data Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: #1a1a2e;
            margin: 50px auto;
            padding: 30px;
            width: 90%;
            max-width: 1200px;
            border-radius: 12px;
            border: 1px solid #00ff88;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            font-size: 30px;
            cursor: pointer;
            color: #888;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: #ff4444;
        }
        
        /* Chart Controls */
        .chart-advanced-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .control-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .control-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .control-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .control-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        /* Add Metric Button */
        .add-metric-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            color: #000;
            font-size: 30px;
            border: none;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.5);
            transition: all 0.3s;
            z-index: 100;
        }
        
        .add-metric-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.7);
        }
        
        /* Custom Metric Form */
        .custom-metric-form {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #00ff88;
            font-size: 0.875rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.5rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #fff;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #00ff88;
        }
        
        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .metric-card.spike-good {
            animation: spike-flash-good 1s infinite;
        }
        
        .metric-card.spike-bad {
            animation: spike-flash-bad 1s infinite;
        }
        
        @keyframes spike-flash-good {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.05);
                box-shadow: none;
            }
            50% { 
                background: rgba(0, 255, 136, 0.2);
                box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            }
        }
        
        @keyframes spike-flash-bad {
            0%, 100% { 
                background: rgba(255, 255, 255, 0.05);
                box-shadow: none;
            }
            50% { 
                background: rgba(255, 68, 68, 0.2);
                box-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
            }
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Alert Flash Container -->
    <div id="alertContainer"></div>
    
    <header class="header">
        <div class="logo">
            📊 OpenBB Platform
            <span style="font-size: 0.875rem; color: #888;">v8.0 Enhanced</span>
        </div>
        
        <!-- Market Phase Indicator -->
        <div class="market-phase phase-bull" id="marketPhase">
            BULL MARKET
        </div>
        
        <!-- Liquidity Indicator -->
        <div class="liquidity-indicator">
            <div class="liquidity-label">Liquidity</div>
            <div class="liquidity-value liquidity-pumping" id="liquidityStatus">PUMPING 💧</div>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="activeIndicators">143</div>
                <div class="stat-label">Active Indicators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="blackSwanProb">2.3%</div>
                <div class="stat-label">Black Swan Risk</div>
            </div>
        </div>
        
        <div class="api-status">
            <div class="api-indicator">
                <div class="status-dot loading" id="mainApiStatus"></div>
                <span>Main API</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="mlStatus"></div>
                <span>ML Engine</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Risk Probability Display -->
        <div class="risk-probability">
            <div class="risk-meter">
                <span>Overall Market Risk:</span>
                <span class="risk-percentage" id="riskPercentage">15.7%</span>
            </div>
            <div class="risk-bar">
                <div class="risk-fill" id="riskFill" style="width: 15.7%; background: linear-gradient(90deg, #00ff88, #ffaa00);"></div>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">📈 Overview</button>
            <button class="tab-btn" data-tab="fed">🏛️ Federal Reserve</button>
            <button class="tab-btn" data-tab="blackswan">🦢 Black Swan</button>
            <button class="tab-btn" data-tab="liquidity">💧 Liquidity</button>
            <button class="tab-btn" data-tab="currencies">💱 Currencies</button>
            <button class="tab-btn" data-tab="credit">📊 Credit Markets</button>
            <button class="tab-btn" data-tab="crisis">⚠️ Crisis Indicators</button>
            <button class="tab-btn" data-tab="predictions">🤖 ML Predictions</button>
            <button class="tab-btn" data-tab="signals">📡 Trading Signals</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Key Metrics -->
            <div class="metrics-grid" id="keyMetrics"></div>
            
            <!-- Main Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Market Overview - Full Historical Data</h2>
                </div>
                <div class="chart-advanced-controls">
                    <div class="control-group">
                        <div class="control-label">Time Range</div>
                        <div class="control-buttons">
                            <button class="control-btn" data-range="1M">1M</button>
                            <button class="control-btn" data-range="3M">3M</button>
                            <button class="control-btn" data-range="6M">6M</button>
                            <button class="control-btn" data-range="1Y">1Y</button>
                            <button class="control-btn" data-range="5Y">5Y</button>
                            <button class="control-btn" data-range="10Y">10Y</button>
                            <button class="control-btn active" data-range="ALL">ALL</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-label">Change View</div>
                        <div class="control-buttons">
                            <button class="control-btn active" data-change="price">Price</button>
                            <button class="control-btn" data-change="yoy">YoY %</button>
                            <button class="control-btn" data-change="qoq">QoQ %</button>
                            <button class="control-btn" data-change="mom">MoM %</button>
                            <button class="control-btn" data-change="wow">WoW %</button>
                        </div>
                    </div>
                    <div class="control-group">
                        <div class="control-label">Indicators</div>
                        <div class="control-buttons">
                            <button class="control-btn" data-indicator="sma">SMA</button>
                            <button class="control-btn" data-indicator="ema">EMA</button>
                            <button class="control-btn" data-indicator="bb">Bollinger</button>
                            <button class="control-btn" data-indicator="rsi">RSI</button>
                            <button class="control-btn" data-indicator="macd">MACD</button>
                        </div>
                    </div>
                </div>
                <div id="mainChart" style="height: 500px;"></div>
            </div>
            
            <!-- Dashboard Data Grid -->
            <div class="data-grid" id="overviewGrid"></div>
        </div>
        
        <!-- Black Swan Tab -->
        <div class="tab-content" id="blackswan">
            <div class="custom-metric-form">
                <h3 style="color: #00ff88; margin-bottom: 1rem;">Add Custom Black Swan Indicator</h3>
                <div class="form-group">
                    <label class="form-label">Indicator Name</label>
                    <input type="text" class="form-input" id="customIndicatorName" placeholder="e.g., Custom Volatility Index">
                </div>
                <div class="form-group">
                    <label class="form-label">FRED Symbol</label>
                    <input type="text" class="form-input" id="customFredSymbol" placeholder="e.g., VIXCLS">
                </div>
                <div class="form-group">
                    <label class="form-label">Weight (1-10)</label>
                    <input type="number" class="form-input" id="customWeight" min="1" max="10" value="5">
                </div>
                <div class="form-group">
                    <label class="form-label">Threshold for Alert</label>
                    <input type="number" class="form-input" id="customThreshold" placeholder="e.g., 30">
                </div>
                <button class="control-btn" onclick="addCustomIndicator()" style="background: #00ff88; color: #000;">
                    Add Indicator
                </button>
            </div>
            
            <div class="risk-probability">
                <h3 style="margin-bottom: 1rem;">Black Swan Probability Calculator</h3>
                <div class="risk-meter">
                    <span>Current Black Swan Probability:</span>
                    <span class="risk-percentage" id="blackSwanProbability">2.3%</span>
                </div>
                <div class="risk-bar">
                    <div class="risk-fill" id="blackSwanFill" style="width: 2.3%; background: #00ff88;"></div>
                </div>
            </div>
            
            <div class="data-grid" id="blackSwanGrid"></div>
        </div>
        
        <!-- Other tabs remain similar but enhanced -->
    </div>
    
    <!-- Historical Data Modal -->
    <div id="historicalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Historical Data</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalChart" style="height: 600px;"></div>
            <div id="modalStats" style="margin-top: 20px; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                <!-- Statistics will be displayed here -->
            </div>
        </div>
    </div>
    
    <!-- Add Metric Button -->
    <button class="add-metric-btn" onclick="showAddMetricForm()">+</button>
    
    <script>
        // Enhanced Configuration
        const OPENBB_CONFIG = {
            MAIN_API: {
                baseUrl: 'https://i70jxru6md.execute-api.us-east-1.amazonaws.com/prod/api/v1',
                endpoints: {
                    health: '/health',
                    overview: '/dashboard/overview',
                    mega: '/dashboard/mega',
                    dxy: '/dxy',
                    ice_bofa: '/ice_bofa',
                    fed: '/fed',
                    blackswan: '/blackswan',
                    liquidity: '/liquidity',
                    crisis: '/crisis'
                }
            },
            FRED_API: {
                baseUrl: 'https://api.stlouisfed.org/fred/series/observations',
                apiKey: 'YOUR_FRED_API_KEY' // Replace with actual key
            }
        };
        
        // Enhanced Global State
        let currentData = {
            overview: {},
            fed: {},
            blackswan: {},
            liquidity: {},
            currencies: {},
            credit: {},
            crisis: {},
            predictions: {},
            signals: [],
            historicalData: {},
            customIndicators: [],
            interpretations: {},
            spikeThresholds: {},
            marketPhase: 'BULL',
            liquidityStatus: 'PUMPING'
        };
        
        // Metric Interpretations
        const metricInterpretations = {
            'VIX': (value, change) => {
                if (value < 15) return { text: "Low volatility - Market complacent", class: "interpretation-good" };
                if (value > 30) return { text: "High fear - Potential buying opportunity", class: "interpretation-bad" };
                return { text: "Normal volatility levels", class: "interpretation-neutral" };
            },
            'S&P 500': (value, change) => {
                if (change > 1) return { text: "Strong upward momentum", class: "interpretation-good" };
                if (change < -1) return { text: "Selling pressure building", class: "interpretation-bad" };
                return { text: "Stable market conditions", class: "interpretation-neutral" };
            },
            'DXY': (value, change) => {
                if (value > 100) return { text: "Dollar strength - Risk-off sentiment", class: "interpretation-neutral" };
                if (value < 90) return { text: "Dollar weakness - Risk-on mode", class: "interpretation-good" };
                return { text: "Dollar at normal levels", class: "interpretation-neutral" };
            },
            '10Y Treasury': (value, change) => {
                if (value > 4.5) return { text: "Elevated yields - Tightening conditions", class: "interpretation-bad" };
                if (value < 3) return { text: "Low yields - Accommodative policy", class: "interpretation-good" };
                return { text: "Normal yield environment", class: "interpretation-neutral" };
            },
            'Fed Balance': (value, change) => {
                if (change < 0) return { text: "QT Active - Liquidity draining", class: "interpretation-bad" };
                if (change > 0) return { text: "Balance expanding - Liquidity injection", class: "interpretation-good" };
                return { text: "Balance sheet stable", class: "interpretation-neutral" };
            },
            'TED Spread': (value, change) => {
                if (value < 0.2) return { text: "No stress - Banking system healthy", class: "interpretation-good" };
                if (value > 0.5) return { text: "Credit stress emerging", class: "interpretation-bad" };
                return { text: "Normal interbank lending", class: "interpretation-neutral" };
            }
        };
        
        // Initialize Enhanced Platform
        async function initializePlatform() {
            console.log('🚀 Initializing Enhanced OpenBB Platform...');
            
            // Load saved custom metrics
            loadCustomMetrics();
            
            // Test API connections
            await testAPIConnections();
            
            // Load initial data
            await loadAllData();
            
            // Set up event listeners
            setupEnhancedEventListeners();
            
            // Initialize charts with full history
            await initializeEnhancedCharts();
            
            // Start monitoring for spikes
            startSpikeMonitoring();
            
            // Calculate market phase
            calculateMarketPhase();
            
            // Start auto-refresh
            startAutoRefresh();
            
            console.log('✅ Enhanced Platform initialized');
        }
        
        // Create Enhanced Metric Cards
        function createEnhancedMetricCard(key, data, customName = null) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            card.id = `metric-${key}`;
            
            const displayName = customName || getMetricDisplayName(key);
            const interpretation = getMetricInterpretation(key, data.value, data.change);
            
            // Check for spikes
            const spikeStatus = checkForSpike(key, data.value, data.change);
            if (spikeStatus) {
                card.classList.add(spikeStatus);
                showSpikeAlert(displayName, data.value, spikeStatus);
            }
            
            card.innerHTML = `
                <div class="metric-title metric-title-editable" onclick="editMetricName('${key}', this)">
                    ${displayName}
                </div>
                <div class="metric-value ${data.change >= 0 ? 'positive' : 'negative'}" id="${key}Value">
                    ${formatValue(key, data.value)}
                </div>
                <div class="metric-change ${data.change >= 0 ? 'positive' : 'negative'}">
                    <span>${data.change >= 0 ? '▲' : '▼'}</span> 
                    ${Math.abs(data.change).toFixed(2)}%
                </div>
                <div class="metric-interpretation ${interpretation.class}">
                    ${interpretation.text}
                </div>
            `;
            
            card.onclick = (e) => {
                if (!e.target.classList.contains('metric-title-editable')) {
                    showHistoricalData(key, displayName);
                }
            };
            
            return card;
        }
        
        // Edit Metric Name
        function editMetricName(key, element) {
            const currentName = element.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'metric-title-input';
            input.value = currentName;
            
            input.onblur = () => {
                saveMetricName(key, input.value);
                element.textContent = input.value;
                element.style.display = 'block';
                input.remove();
            };
            
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                }
            };
            
            element.style.display = 'none';
            element.parentNode.insertBefore(input, element);
            input.focus();
        }
        
        // Save Custom Metric Name
        function saveMetricName(key, name) {
            if (!currentData.customNames) {
                currentData.customNames = {};
            }
            currentData.customNames[key] = name;
            localStorage.setItem('customMetricNames', JSON.stringify(currentData.customNames));
        }
        
        // Get Metric Display Name
        function getMetricDisplayName(key) {
            if (currentData.customNames && currentData.customNames[key]) {
                return currentData.customNames[key];
            }
            
            const defaultNames = {
                'VIXCLS': 'VIX',
                'SP500': 'S&P 500',
                'DTWEXBGS': 'DXY',
                'DGS10': '10Y Treasury',
                'WALCL': 'Fed Balance',
                'TEDRATE': 'TED Spread',
                'UNRATE': 'Unemployment',
                'GDP': 'GDP',
                'CPIAUCSL': 'CPI',
                'GOLDAMGBD228NLBM': 'Gold Price'
            };
            
            return defaultNames[key] || key;
        }
        
        // Get Metric Interpretation
        function getMetricInterpretation(key, value, change) {
            const displayName = getMetricDisplayName(key);
            if (metricInterpretations[displayName]) {
                return metricInterpretations[displayName](value, change);
            }
            return { text: "Data available", class: "interpretation-neutral" };
        }
        
        // Check for Spikes
        function checkForSpike(key, value, change) {
            const thresholds = {
                'VIXCLS': { good: -10, bad: 10 },
                'SP500': { good: 3, bad: -3 },
                'DTWEXBGS': { good: -2, bad: 2 },
                'DGS10': { good: -0.2, bad: 0.2 },
                ...currentData.spikeThresholds
            };
            
            if (thresholds[key]) {
                if (change > thresholds[key].good && thresholds[key].good > 0) return 'spike-good';
                if (change < thresholds[key].good && thresholds[key].good < 0) return 'spike-good';
                if (change > thresholds[key].bad && thresholds[key].bad > 0) return 'spike-bad';
                if (change < thresholds[key].bad && thresholds[key].bad < 0) return 'spike-bad';
            }
            
            return null;
        }
        
        // Show Spike Alert
        function showSpikeAlert(name, value, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-flash alert-${type === 'spike-good' ? 'good' : 'bad'}`;
            alertDiv.textContent = `${name}: ${value} - ${type === 'spike-good' ? 'POSITIVE' : 'NEGATIVE'} SPIKE!`;
            
            document.getElementById('alertContainer').appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
        
        // Show Historical Data Modal
        async function showHistoricalData(key, displayName) {
            const modal = document.getElementById('historicalModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalChart = document.getElementById('modalChart');
            const modalStats = document.getElementById('modalStats');
            
            modalTitle.textContent = `${displayName} - Complete Historical Data`;
            modal.style.display = 'block';
            
            // Fetch full historical data
            const historicalData = await fetchHistoricalData(key);
            
            // Create advanced chart with all features
            createAdvancedChart(modalChart, historicalData, displayName);
            
            // Calculate and display statistics
            displayStatistics(modalStats, historicalData);
        }
        
        // Fetch Historical Data (Full FRED History)
        async function fetchHistoricalData(symbol) {
            // Simulated historical data - replace with actual FRED API call
            const endDate = new Date();
            const startDate = new Date('1970-01-01'); // Get all available history
            
            const data = [];
            let currentDate = new Date(startDate);
            let value = 100;
            
            while (currentDate <= endDate) {
                value += (Math.random() - 0.5) * 5;
                data.push({
                    date: currentDate.toISOString().split('T')[0],
                    value: value,
                    yoy: ((value / (value - 10)) - 1) * 100,
                    qoq: ((value / (value - 3)) - 1) * 100,
                    mom: ((value / (value - 1)) - 1) * 100,
                    wow: ((value / (value - 0.25)) - 1) * 100
                });
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            return data;
        }
        
        // Create Advanced Chart
        function createAdvancedChart(container, data, title) {
            const traces = [
                {
                    x: data.map(d => d.date),
                    y: data.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Price',
                    line: { color: '#00ff88', width: 2 }
                }
            ];
            
            // Add moving averages
            const sma20 = calculateSMA(data.map(d => d.value), 20);
            const sma50 = calculateSMA(data.map(d => d.value), 50);
            const sma200 = calculateSMA(data.map(d => d.value), 200);
            
            traces.push({
                x: data.map(d => d.date),
                y: sma20,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 20',
                line: { color: '#ffaa00', width: 1, dash: 'dot' }
            });
            
            traces.push({
                x: data.map(d => d.date),
                y: sma50,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 50',
                line: { color: '#00ccff', width: 1, dash: 'dot' }
            });
            
            traces.push({
                x: data.map(d => d.date),
                y: sma200,
                type: 'scatter',
                mode: 'lines',
                name: 'SMA 200',
                line: { color: '#ff4444', width: 1, dash: 'dot' }
            });
            
            const layout = {
                title: {
                    text: title,
                    font: { color: '#fff' }
                },
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    rangeslider: { visible: true }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.2
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true
            };
            
            Plotly.newPlot(container, traces, layout, config);
        }
        
        // Calculate Simple Moving Average
        function calculateSMA(data, period) {
            const sma = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    sma.push(null);
                } else {
                    const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    sma.push(sum / period);
                }
            }
            return sma;
        }
        
        // Display Statistics
        function displayStatistics(container, data) {
            const latest = data[data.length - 1];
            const yearAgo = data[data.length - 365] || data[0];
            const monthAgo = data[data.length - 30] || data[0];
            const weekAgo = data[data.length - 7] || data[0];
            
            const stats = `
                <h3 style="color: #00ff88; margin-bottom: 1rem;">Statistical Analysis</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">Current Value</div>
                        <div style="color: #fff; font-size: 1.5rem; font-weight: bold;">${latest.value.toFixed(2)}</div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">YoY Change</div>
                        <div style="color: ${latest.yoy >= 0 ? '#00ff88' : '#ff4444'}; font-size: 1.5rem; font-weight: bold;">
                            ${latest.yoy >= 0 ? '+' : ''}${latest.yoy.toFixed(2)}%
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">QoQ Change</div>
                        <div style="color: ${latest.qoq >= 0 ? '#00ff88' : '#ff4444'}; font-size: 1.5rem; font-weight: bold;">
                            ${latest.qoq >= 0 ? '+' : ''}${latest.qoq.toFixed(2)}%
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">MoM Change</div>
                        <div style="color: ${latest.mom >= 0 ? '#00ff88' : '#ff4444'}; font-size: 1.5rem; font-weight: bold;">
                            ${latest.mom >= 0 ? '+' : ''}${latest.mom.toFixed(2)}%
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">WoW Change</div>
                        <div style="color: ${latest.wow >= 0 ? '#00ff88' : '#ff4444'}; font-size: 1.5rem; font-weight: bold;">
                            ${latest.wow >= 0 ? '+' : ''}${latest.wow.toFixed(2)}%
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">52-Week High</div>
                        <div style="color: #00ff88; font-size: 1.5rem; font-weight: bold;">
                            ${Math.max(...data.slice(-365).map(d => d.value)).toFixed(2)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">52-Week Low</div>
                        <div style="color: #ff4444; font-size: 1.5rem; font-weight: bold;">
                            ${Math.min(...data.slice(-365).map(d => d.value)).toFixed(2)}
                        </div>
                    </div>
                    <div>
                        <div style="color: #888; font-size: 0.875rem;">Volatility (1Y)</div>
                        <div style="color: #ffaa00; font-size: 1.5rem; font-weight: bold;">
                            ${calculateVolatility(data.slice(-365).map(d => d.value)).toFixed(2)}%
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = stats;
        }
        
        // Calculate Volatility
        function calculateVolatility(data) {
            const returns = [];
            for (let i = 1; i < data.length; i++) {
                returns.push((data[i] - data[i-1]) / data[i-1]);
            }
            
            const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
            const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
            return Math.sqrt(variance * 252) * 100; // Annualized volatility
        }
        
        // Calculate Market Phase
        function calculateMarketPhase() {
            // Complex algorithm to determine market phase
            const vix = currentData.overview.indicators?.VIXCLS?.value || 20;
            const sp500Change = currentData.overview.indicators?.SP500?.change || 0;
            const fedBalance = currentData.overview.indicators?.WALCL?.change || 0;
            const tedSpread = currentData.overview.indicators?.TEDRATE?.value || 0.2;
            
            let phase = 'BULL';
            let liquidityStatus = 'PUMPING';
            
            // Market phase determination
            if (vix > 30 && sp500Change < -10) {
                phase = 'BEAR';
            } else if (vix > 25 && sp500Change < -5) {
                phase = 'TOP';
            } else if (vix < 15 && sp500Change > 5 && fedBalance > 0) {
                phase = 'BULL START';
            }
            
            // Liquidity status
            if (fedBalance < -1) {
                liquidityStatus = 'CONTRACTING';
            } else if (fedBalance > 1) {
                liquidityStatus = 'PUMPING';
            } else {
                liquidityStatus = 'STABLE';
            }
            
            updateMarketPhase(phase, liquidityStatus);
        }
        
        // Update Market Phase Display
        function updateMarketPhase(phase, liquidityStatus) {
            const phaseElement = document.getElementById('marketPhase');
            const liquidityElement = document.getElementById('liquidityStatus');
            
            // Update phase
            phaseElement.className = 'market-phase';
            if (phase === 'BULL START') {
                phaseElement.classList.add('phase-bull-start');
                phaseElement.textContent = '🚀 BULL RUN START';
            } else if (phase === 'BULL') {
                phaseElement.classList.add('phase-bull');
                phaseElement.textContent = '📈 BULL MARKET';
            } else if (phase === 'TOP') {
                phaseElement.classList.add('phase-top');
                phaseElement.textContent = '⚠️ MARKET TOP';
            } else if (phase === 'BEAR') {
                phaseElement.classList.add('phase-bear');
                phaseElement.textContent = '📉 BEAR MARKET';
            }
            
            // Update liquidity
            liquidityElement.className = 'liquidity-value';
            if (liquidityStatus === 'PUMPING') {
                liquidityElement.classList.add('liquidity-pumping');
                liquidityElement.textContent = 'PUMPING 💧';
            } else if (liquidityStatus === 'CONTRACTING') {
                liquidityElement.classList.add('liquidity-contracting');
                liquidityElement.textContent = 'CONTRACTING 🔥';
            } else {
                liquidityElement.textContent = 'STABLE ⚖️';
            }
            
            currentData.marketPhase = phase;
            currentData.liquidityStatus = liquidityStatus;
        }
        
        // Calculate Black Swan Probability
        function calculateBlackSwanProbability() {
            const indicators = currentData.blackswan?.indicators || {};
            const customIndicators = currentData.customIndicators || [];
            
            let riskScore = 0;
            let totalWeight = 0;
            
            // Default indicators
            const defaultWeights = {
                'VIXCLS': { weight: 8, threshold: 30 },
                'TEDRATE': { weight: 7, threshold: 0.5 },
                'T10Y2Y': { weight: 6, threshold: -0.5 },
                'BAMLH0A0HYM2': { weight: 7, threshold: 8 }
            };
            
            // Calculate risk from default indicators
            for (const [key, config] of Object.entries(defaultWeights)) {
                if (indicators[key]) {
                    const value = indicators[key].value;
                    const contribution = (value / config.threshold) * config.weight;
                    riskScore += contribution;
                    totalWeight += config.weight;
                }
            }
            
            // Add custom indicators
            for (const custom of customIndicators) {
                if (indicators[custom.symbol]) {
                    const value = indicators[custom.symbol].value;
                    const contribution = (value / custom.threshold) * custom.weight;
                    riskScore += contribution;
                    totalWeight += custom.weight;
                }
            }
            
            // Calculate probability (0-100%)
            const probability = Math.min(100, Math.max(0, (riskScore / totalWeight) * 10));
            
            updateBlackSwanProbability(probability);
            return probability;
        }
        
        // Update Black Swan Probability Display
        function updateBlackSwanProbability(probability) {
            const probElement = document.getElementById('blackSwanProbability');
            const fillElement = document.getElementById('blackSwanFill');
            const headerProb = document.getElementById('blackSwanProb');
            
            if (probElement) probElement.textContent = `${probability.toFixed(1)}%`;
            if (headerProb) headerProb.textContent = `${probability.toFixed(1)}%`;
            
            if (fillElement) {
                fillElement.style.width = `${probability}%`;
                
                // Color based on risk level
                if (probability < 10) {
                    fillElement.style.background = '#00ff88';
                } else if (probability < 30) {
                    fillElement.style.background = 'linear-gradient(90deg, #00ff88, #ffaa00)';
                } else if (probability < 60) {
                    fillElement.style.background = '#ffaa00';
                } else {
                    fillElement.style.background = 'linear-gradient(90deg, #ffaa00, #ff4444)';
                }
            }
        }
        
        // Add Custom Indicator
        function addCustomIndicator() {
            const name = document.getElementById('customIndicatorName').value;
            const symbol = document.getElementById('customFredSymbol').value;
            const weight = parseInt(document.getElementById('customWeight').value);
            const threshold = parseFloat(document.getElementById('customThreshold').value);
            
            if (name && symbol && weight && threshold) {
                const indicator = { name, symbol, weight, threshold };
                currentData.customIndicators.push(indicator);
                
                // Save to localStorage
                localStorage.setItem('customIndicators', JSON.stringify(currentData.customIndicators));
                
                // Recalculate probability
                calculateBlackSwanProbability();
                
                // Clear form
                document.getElementById('customIndicatorName').value = '';
                document.getElementById('customFredSymbol').value = '';
                document.getElementById('customWeight').value = '5';
                document.getElementById('customThreshold').value = '';
                
                // Reload black swan data
                loadBlackSwanData();
            }
        }
        
        // Load Custom Metrics
        function loadCustomMetrics() {
            const savedNames = localStorage.getItem('customMetricNames');
            const savedIndicators = localStorage.getItem('customIndicators');
            
            if (savedNames) {
                currentData.customNames = JSON.parse(savedNames);
            }
            
            if (savedIndicators) {
                currentData.customIndicators = JSON.parse(savedIndicators);
            }
        }
        
        // Format Value
        function formatValue(key, value) {
            if (key === 'WALCL') {
                return `$${(value / 1000000).toFixed(2)}T`;
            }
            if (key === 'DGS10' || key === 'TEDRATE') {
                return `${value}%`;
            }
            return value.toFixed(2);
        }
        
        // Close Modal
        function closeModal() {
            document.getElementById('historicalModal').style.display = 'none';
        }
        
        // Show Add Metric Form
        function showAddMetricForm() {
            // Navigate to Black Swan tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-tab="blackswan"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('blackswan').classList.add('active');
        }
        
        // Start Spike Monitoring
        function startSpikeMonitoring() {
            setInterval(() => {
                // Check all metrics for spikes
                const metrics = document.querySelectorAll('.metric-card');
                metrics.forEach(metric => {
                    // Spike detection logic here
                });
            }, 5000); // Check every 5 seconds
        }
        
        // Setup Enhanced Event Listeners
        function setupEnhancedEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = e.target.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Chart controls
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const group = e.target.parentElement;
                    group.querySelectorAll('.control-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Handle different control types
                    if (e.target.dataset.range) {
                        updateChartRange(e.target.dataset.range);
                    } else if (e.target.dataset.change) {
                        updateChartChangeView(e.target.dataset.change);
                    } else if (e.target.dataset.indicator) {
                        toggleIndicator(e.target.dataset.indicator);
                    }
                });
            });
            
            // Close modal on outside click
            window.onclick = (event) => {
                const modal = document.getElementById('historicalModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
        }
        
        // Update Chart Range
        function updateChartRange(range) {
            // Implementation for chart range update
            console.log('Updating chart range to:', range);
        }
        
        // Update Chart Change View
        function updateChartChangeView(changeType) {
            // Implementation for change view update
            console.log('Updating change view to:', changeType);
        }
        
        // Toggle Indicator
        function toggleIndicator(indicator) {
            // Implementation for indicator toggle
            console.log('Toggling indicator:', indicator);
        }
        
        // Load Overview Data (Enhanced)
        async function loadOverviewData() {
            try {
                const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.overview);
                const data = await response.json();
                
                currentData.overview = data;
                
                // Update key metrics with enhanced features
                const metricsGrid = document.getElementById('keyMetrics');
                metricsGrid.innerHTML = '';
                
                const priorityMetrics = ['VIXCLS', 'SP500', 'DTWEXBGS', 'DGS10', 'WALCL', 'TEDRATE'];
                
                for (const key of priorityMetrics) {
                    if (data.indicators && data.indicators[key]) {
                        const card = createEnhancedMetricCard(key, data.indicators[key]);
                        metricsGrid.appendChild(card);
                    }
                }
                
                // Calculate market phase
                calculateMarketPhase();
                
                // Update main chart
                updateMainChart(data.indicators || {});
                
            } catch (error) {
                console.error('Error loading overview:', error);
            }
        }
        
        // Load Black Swan Data (Enhanced)
        async function loadBlackSwanData() {
            try {
                const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.blackswan);
                const data = await response.json();
                
                currentData.blackswan = data;
                
                // Calculate probability with custom indicators
                calculateBlackSwanProbability();
                
                // Display data
                const grid = document.getElementById('blackSwanGrid');
                if (grid) {
                    grid.innerHTML = '';
                    
                    // Add default indicators
                    if (data.indicators) {
                        for (const [key, value] of Object.entries(data.indicators)) {
                            const card = createEnhancedMetricCard(key, value);
                            grid.appendChild(card);
                        }
                    }
                    
                    // Add custom indicators
                    for (const custom of currentData.customIndicators) {
                        // Fetch and display custom indicator data
                        // This would be implemented with actual FRED API calls
                    }
                }
                
            } catch (error) {
                console.error('Error loading Black Swan data:', error);
            }
        }
        
        // Initialize Enhanced Charts
        async function initializeEnhancedCharts() {
            const chartConfig = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    rangeslider: { visible: true }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false
            };
            
            // Initialize main chart with full history capability
            Plotly.newPlot('mainChart', [], chartConfig, config);
        }
        
        // Update Main Chart
        function updateMainChart(indicators) {
            // Implementation with full historical data
            console.log('Updating main chart with indicators:', indicators);
        }
        
        // Start Auto Refresh
        function startAutoRefresh() {
            setInterval(async () => {
                console.log('🔄 Auto-refreshing data...');
                await loadOverviewData();
                await loadBlackSwanData();
            }, 30000); // 30 seconds
        }
        
        // Test API Connections
        async function testAPIConnections() {
            const mainStatus = document.getElementById('mainApiStatus');
            const mlStatus = document.getElementById('mlStatus');
            
            try {
                const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.health);
                if (response.ok) {
                    mainStatus.className = 'status-dot connected';
                    mlStatus.className = 'status-dot connected';
                } else {
                    mainStatus.className = 'status-dot error';
                    mlStatus.className = 'status-dot error';
                }
            } catch (error) {
                console.error('API connection error:', error);
                mainStatus.className = 'status-dot error';
               mlStatus.className = 'status-dot error';
           }
       }
       
       // Load All Data
       async function loadAllData() {
           await loadOverviewData();
           await loadBlackSwanData();
           await loadFedData();
           await loadLiquidityData();
           await loadCurrenciesData();
           await loadCreditData();
           await loadCrisisData();
           await loadPredictions();
           await loadTradingSignals();
       }
       
       // Load Federal Reserve Data (Enhanced)
       async function loadFedData() {
           try {
               const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.fed);
               const data = await response.json();
               
               currentData.fed = data;
               
               const grid = document.getElementById('fedGrid');
               if (grid) {
                   grid.innerHTML = '';
                   
                   if (data.indicators) {
                       for (const [key, value] of Object.entries(data.indicators)) {
                           const card = createEnhancedMetricCard(key, value);
                           grid.appendChild(card);
                       }
                   }
               }
               
               // Update Fed chart with enhanced features
               updateFedChart(data);
               
           } catch (error) {
               console.error('Error loading Fed data:', error);
           }
       }
       
       // Load Liquidity Data (Enhanced)
       async function loadLiquidityData() {
           try {
               const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.liquidity);
               const data = await response.json();
               
               currentData.liquidity = data;
               
               const grid = document.getElementById('liquidityGrid');
               if (grid) {
                   grid.innerHTML = '';
                   
                   if (data.indicators) {
                       for (const [key, value] of Object.entries(data.indicators)) {
                           const card = createEnhancedMetricCard(key, value);
                           grid.appendChild(card);
                       }
                   }
               }
               
               // Check liquidity conditions
               checkLiquidityConditions(data);
               
               // Update Liquidity chart
               updateLiquidityChart(data);
               
           } catch (error) {
               console.error('Error loading Liquidity data:', error);
           }
       }
       
       // Check Liquidity Conditions
       function checkLiquidityConditions(data) {
           const indicators = data.indicators || {};
           
           // Key liquidity metrics
           const rrp = indicators.RRPONTTLD?.value || 0;
           const reserves = indicators.TOTRESNS?.value || 0;
           const m2 = indicators.M2SL?.value || 0;
           
           let liquidityScore = 0;
           
           // Calculate liquidity score
           if (rrp < 1000000) liquidityScore += 2; // Low RRP is bullish
           if (reserves > 3000000) liquidityScore += 2; // High reserves is bullish
           if (m2 > 0) liquidityScore += 1; // M2 growth is bullish
           
           // Update liquidity status based on score
           let status = 'STABLE';
           if (liquidityScore >= 4) {
               status = 'PUMPING';
               if (currentData.liquidityStatus !== 'PUMPING') {
                   showSpikeAlert('Liquidity', 'Injection Detected', 'spike-good');
               }
           } else if (liquidityScore <= 1) {
               status = 'CONTRACTING';
               if (currentData.liquidityStatus !== 'CONTRACTING') {
                   showSpikeAlert('Liquidity', 'Contraction Warning', 'spike-bad');
               }
           }
           
           updateMarketPhase(currentData.marketPhase, status);
       }
       
       // Load Currencies Data (Enhanced)
       async function loadCurrenciesData() {
           try {
               const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.dxy);
               const data = await response.json();
               
               currentData.currencies = data;
               
               const grid = document.getElementById('currenciesGrid');
               if (grid) {
                   grid.innerHTML = '';
                   
                   if (data.indicators) {
                       for (const [key, value] of Object.entries(data.indicators)) {
                           const card = createEnhancedMetricCard(key, value);
                           grid.appendChild(card);
                       }
                   }
               }
               
           } catch (error) {
               console.error('Error loading Currencies data:', error);
           }
       }
       
       // Load Credit Markets Data (Enhanced)
       async function loadCreditData() {
           try {
               const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.ice_bofa);
               const data = await response.json();
               
               currentData.credit = data;
               
               const grid = document.getElementById('creditGrid');
               if (grid) {
                   grid.innerHTML = '';
                   
                   if (data.indicators) {
                       for (const [key, value] of Object.entries(data.indicators)) {
                           const card = createEnhancedMetricCard(key, value);
                           
                           // Special interpretation for credit spreads
                           const spread = value.value;
                           if (spread > 8) {
                               showSpikeAlert(`${key} Spread`, `${spread}% - Distress Level`, 'spike-bad');
                           }
                           
                           grid.appendChild(card);
                       }
                   }
               }
               
           } catch (error) {
               console.error('Error loading Credit data:', error);
           }
       }
       
       // Load Crisis Indicators (Enhanced)
       async function loadCrisisData() {
           try {
               const response = await fetch(OPENBB_CONFIG.MAIN_API.baseUrl + OPENBB_CONFIG.MAIN_API.endpoints.crisis);
               const data = await response.json();
               
               currentData.crisis = data;
               
               const grid = document.getElementById('crisisGrid');
               if (grid) {
                   grid.innerHTML = '';
                   
                   // Check for crisis conditions
                   let crisisScore = 0;
                   
                   if (data.indicators) {
                       for (const [key, value] of Object.entries(data.indicators)) {
                           const card = createEnhancedMetricCard(key, value);
                           grid.appendChild(card);
                           
                           // Crisis detection
                           if (key.includes('STRESS') && value.value > 1) crisisScore++;
                           if (key.includes('SPREAD') && value.value > 2) crisisScore++;
                       }
                   }
                   
                   // Alert if crisis indicators are elevated
                   if (crisisScore >= 3) {
                       showSpikeAlert('Crisis Alert', 'Multiple indicators elevated', 'spike-bad');
                       updateRiskLevel('HIGH');
                   }
               }
               
           } catch (error) {
               console.error('Error loading Crisis data:', error);
           }
       }
       
       // Load ML Predictions (Enhanced)
       async function loadPredictions() {
           // Enhanced ML predictions with confidence intervals
           const predictions = {
               VIX: {
                   current: 16.57,
                   predicted_1d: 16.80,
                   predicted_5d: 17.60,
                   predicted_30d: 18.90,
                   confidence: 0.75,
                   confidence_interval: [15.50, 18.10],
                   trend: 'STABLE',
                   momentum: 'NEUTRAL'
               },
               SP500: {
                   current: 6389.45,
                   predicted_1d: 6396.67,
                   predicted_5d: 6427.33,
                   predicted_30d: 6512.80,
                   confidence: 0.68,
                   confidence_interval: [6350, 6450],
                   trend: 'BULLISH',
                   momentum: 'POSITIVE'
               },
               DXY: {
                   current: 121.61,
                   predicted_1d: 121.45,
                   predicted_5d: 121.20,
                   predicted_30d: 120.80,
                   confidence: 0.72,
                   confidence_interval: [120.5, 122.5],
                   trend: 'WEAKENING',
                   momentum: 'NEGATIVE'
               },
               RISK_LEVEL: {
                   current: 'LOW',
                   predicted_1d: 'LOW',
                   predicted_5d: 'MEDIUM',
                   predicted_30d: 'MEDIUM',
                   confidence: 0.82,
                   factors: ['Fed Policy', 'Geopolitical', 'Credit Spreads']
               }
           };
           
           currentData.predictions = predictions;
           updatePredictionsDisplay(predictions);
       }
       
       // Update Predictions Display (Enhanced)
       function updatePredictionsDisplay(predictions) {
           const container = document.getElementById('mlPredictions');
           if (container) {
               container.innerHTML = '';
               
               for (const [key, pred] of Object.entries(predictions)) {
                   if (key === 'RISK_LEVEL') continue;
                   
                   const predCard = document.createElement('div');
                   predCard.className = 'prediction-item';
                   predCard.innerHTML = `
                       <div class="prediction-label">${key} (30 Day)</div>
                       <div class="prediction-value">${pred.predicted_30d.toFixed(2)}</div>
                       <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                           CI: [${pred.confidence_interval[0]}, ${pred.confidence_interval[1]}]
                       </div>
                       <div style="font-size: 0.75rem; color: ${pred.momentum === 'POSITIVE' ? '#00ff88' : '#ff4444'}; margin-top: 0.25rem;">
                           Momentum: ${pred.momentum}
                       </div>
                       <div class="confidence-bar">
                           <div class="confidence-fill" style="width: ${pred.confidence * 100}%"></div>
                       </div>
                   `;
                   container.appendChild(predCard);
               }
           }
           
           // Update predictions table
           const table = document.getElementById('predictionsTable');
           if (table) {
               table.innerHTML = '';
               
               for (const [key, pred] of Object.entries(predictions)) {
                   if (key === 'RISK_LEVEL') continue;
                   
                   const row = document.createElement('tr');
                   row.innerHTML = `
                       <td>${key}</td>
                       <td>${pred.current.toFixed(2)}</td>
                       <td>${pred.predicted_1d.toFixed(2)}</td>
                       <td>${pred.predicted_5d.toFixed(2)}</td>
                       <td>${pred.predicted_30d.toFixed(2)}</td>
                       <td>${(pred.confidence * 100).toFixed(0)}%</td>
                       <td class="${pred.trend === 'BULLISH' ? 'positive' : pred.trend === 'BEARISH' ? 'negative' : 'neutral'}">
                           ${pred.trend}
                       </td>
                   `;
                   table.appendChild(row);
               }
           }
       }
       
       // Load Trading Signals (Enhanced)
       async function loadTradingSignals() {
           // Generate signals based on multiple indicators
           const signals = generateTradingSignals();
           
           currentData.signals = signals;
           updateSignalsDisplay(signals);
       }
       
       // Generate Trading Signals
       function generateTradingSignals() {
           const signals = [];
           const indicators = currentData.overview?.indicators || {};
           
           // VIX-based signals
           const vix = indicators.VIXCLS?.value || 20;
           if (vix < 15) {
               signals.push({
                   asset: 'SPY',
                   signal: 'BUY',
                   reason: 'VIX < 15 - Low volatility, complacency',
                   strength: 'STRONG',
                   confidence: 85,
                   timestamp: new Date().toISOString()
               });
           } else if (vix > 30) {
               signals.push({
                   asset: 'SPY',
                   signal: 'BUY',
                   reason: 'VIX > 30 - Extreme fear, contrarian buy',
                   strength: 'MEDIUM',
                   confidence: 70,
                   timestamp: new Date().toISOString()
               });
           }
           
           // Fed Balance Sheet signals
           const fedBalance = indicators.WALCL?.change || 0;
           if (fedBalance > 0) {
               signals.push({
                   asset: 'TLT',
                   signal: 'SELL',
                   reason: 'Fed expanding balance sheet - Inflation risk',
                   strength: 'MEDIUM',
                   confidence: 65,
                   timestamp: new Date().toISOString()
               });
           }
           
           // TED Spread signals
           const tedSpread = indicators.TEDRATE?.value || 0.2;
           if (tedSpread > 0.5) {
               signals.push({
                   asset: 'XLF',
                   signal: 'SELL',
                   reason: 'TED Spread elevated - Banking stress',
                   strength: 'STRONG',
                   confidence: 80,
                   timestamp: new Date().toISOString()
               });
           }
           
           // Market phase signals
           if (currentData.marketPhase === 'BULL START') {
               signals.push({
                   asset: 'QQQ',
                   signal: 'BUY',
                   reason: 'Bull market starting - Risk-on mode',
                   strength: 'STRONG',
                   confidence: 90,
                   timestamp: new Date().toISOString()
               });
           } else if (currentData.marketPhase === 'TOP') {
               signals.push({
                   asset: 'CASH',
                   signal: 'HOLD',
                   reason: 'Market top detected - Reduce exposure',
                   strength: 'STRONG',
                   confidence: 85,
                   timestamp: new Date().toISOString()
               });
           }
           
           // Liquidity signals
           if (currentData.liquidityStatus === 'PUMPING') {
               signals.push({
                   asset: 'IWM',
                   signal: 'BUY',
                   reason: 'Liquidity pumping - Small caps benefit',
                   strength: 'MEDIUM',
                   confidence: 75,
                   timestamp: new Date().toISOString()
               });
           } else if (currentData.liquidityStatus === 'CONTRACTING') {
               signals.push({
                   asset: 'GLD',
                   signal: 'BUY',
                   reason: 'Liquidity contracting - Safe haven',
                   strength: 'MEDIUM',
                   confidence: 70,
                   timestamp: new Date().toISOString()
               });
           }
           
           return signals;
       }
       
       // Update Signals Display (Enhanced)
       function updateSignalsDisplay(signals) {
           const signalsContainer = document.getElementById('tradingSignals');
           if (signalsContainer) {
               signalsContainer.innerHTML = '';
               
               signals.forEach(signal => {
                   const signalDiv = document.createElement('div');
                   signalDiv.className = 'signal-item';
                   
                   // Flash alert for high confidence signals
                   if (signal.confidence > 80) {
                       signalDiv.style.animation = 'pulse 2s infinite';
                   }
                   
                   signalDiv.innerHTML = `
                       <div>
                           <strong>${signal.asset}</strong>
                           <div style="font-size: 0.875rem; color: #888;">${signal.reason}</div>
                           <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                               Confidence: ${signal.confidence}% | Strength: ${signal.strength}
                           </div>
                       </div>
                       <span class="signal-badge signal-${signal.signal.toLowerCase()}">${signal.signal}</span>
                   `;
                   signalsContainer.appendChild(signalDiv);
               });
           }
           
           // Update signals table
           const table = document.getElementById('signalsTable');
           if (table) {
               table.innerHTML = '';
               
               signals.forEach(signal => {
                   const row = document.createElement('tr');
                   row.innerHTML = `
                       <td>${signal.asset}</td>
                       <td><span class="signal-badge signal-${signal.signal.toLowerCase()}">${signal.signal}</span></td>
                       <td>${signal.reason}</td>
                       <td>${signal.strength}</td>
                       <td>${signal.confidence}%</td>
                       <td>${new Date(signal.timestamp).toLocaleString()}</td>
                   `;
                   table.appendChild(row);
               });
           }
       }
       
       // Update Fed Chart (Enhanced)
       function updateFedChart(data) {
           const container = document.querySelector('#fed .chart-container');
           if (!container) return;
           
           let chartDiv = document.getElementById('fedChart');
           if (!chartDiv) {
               chartDiv = document.createElement('div');
               chartDiv.id = 'fedChart';
               chartDiv.style.height = '500px';
               container.appendChild(chartDiv);
           }
           
           const balance = data.analysis?.balance_sheet_size || 6640843;
           
           // Create multiple traces for comprehensive view
           const traces = [
               {
                   x: generateDateRange(365 * 5), // 5 years of data
                   y: generateRandomWalk(balance/1000000, 0.01, 365 * 5),
                   type: 'scatter',
                   mode: 'lines',
                   name: 'Fed Balance Sheet ($T)',
                   line: { color: '#00ccff', width: 2 }
               },
               {
                   x: generateDateRange(365 * 5),
                   y: generateRandomWalk(0.05, 0.001, 365 * 5),
                   type: 'scatter',
                   mode: 'lines',
                   name: 'Fed Funds Rate (%)',
                   yaxis: 'y2',
                   line: { color: '#ffaa00', width: 2 }
               }
           ];
           
           const layout = {
               title: 'Federal Reserve Operations - 5 Year View',
               paper_bgcolor: 'rgba(0, 0, 0, 0)',
               plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
               font: { color: '#fff' },
               xaxis: {
                   gridcolor: 'rgba(255, 255, 255, 0.1)',
                   tickfont: { color: '#888' },
                   rangeslider: { visible: true }
               },
               yaxis: {
                   title: 'Balance Sheet ($T)',
                   gridcolor: 'rgba(255, 255, 255, 0.1)',
                   tickfont: { color: '#888' }
               },
               yaxis2: {
                   title: 'Fed Funds Rate (%)',
                   overlaying: 'y',
                   side: 'right',
                   gridcolor: 'rgba(255, 255, 255, 0.05)',
                   tickfont: { color: '#888' }
               }
           };
           
           Plotly.newPlot('fedChart', traces, layout, { responsive: true });
       }
       
       // Update Risk Level
       function updateRiskLevel(level) {
           const riskPercentage = document.getElementById('riskPercentage');
           const riskFill = document.getElementById('riskFill');
           
           let percentage = 15.7;
           if (level === 'HIGH') percentage = 75;
           else if (level === 'MEDIUM') percentage = 45;
           else if (level === 'LOW') percentage = 15;
           
           if (riskPercentage) riskPercentage.textContent = `${percentage}%`;
           if (riskFill) {
               riskFill.style.width = `${percentage}%`;
               
               if (percentage > 60) {
                   riskFill.style.background = 'linear-gradient(90deg, #ffaa00, #ff4444)';
               } else if (percentage > 30) {
                   riskFill.style.background = 'linear-gradient(90deg, #00ff88, #ffaa00)';
               } else {
                   riskFill.style.background = '#00ff88';
               }
           }
       }
       
       // Utility: Generate Date Range
       function generateDateRange(days) {
           const dates = [];
           const today = new Date();
           
           for (let i = days - 1; i >= 0; i--) {
               const date = new Date(today);
               date.setDate(date.getDate() - i);
               dates.push(date.toISOString().split('T')[0]);
           }
           
           return dates;
       }
       
       // Utility: Generate Random Walk
       function generateRandomWalk(startValue, volatility, days) {
           const values = [startValue];
           
           for (let i = 1; i < days; i++) {
               const change = (Math.random() - 0.5) * volatility * 2;
               const newValue = values[i - 1] * (1 + change / 100);
               values.push(parseFloat(newValue.toFixed(2)));
           }
           
           return values;
       }
       
       // Initialize on page load
       document.addEventListener('DOMContentLoaded', initializePlatform);
   </script>
</body>
</html>
