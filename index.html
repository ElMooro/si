<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRED Data Explorer - Advanced Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 350px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            border-radius: 12px;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .header p {
            font-size: 1em;
            color: #b3c5ff;
        }

        .search-container {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3949ab;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .autocomplete-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            font-size: 0.9em;
        }

        .autocomplete-item:hover {
            background: #333;
        }

        .autocomplete-item-title {
            color: #4a9eff;
            font-weight: 500;
        }

        .autocomplete-item-symbol {
            color: #888;
            font-size: 0.85em;
        }

        .category-browser {
            margin-top: 20px;
        }

        .category-item {
            margin-bottom: 10px;
        }

        .category-header {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .category-header:hover {
            background: #333;
        }

        .category-count {
            font-size: 0.85em;
            color: #888;
            background: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .series-list {
            margin-left: 20px;
            margin-top: 10px;
            display: none;
        }

        .series-list.show {
            display: block;
        }

        .series-item {
            padding: 10px;
            background: #222;
            margin-bottom: 5px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .series-item:hover {
            background: #333;
            transform: translateX(5px);
        }

        .series-info {
            flex: 1;
        }

        .series-name {
            color: #4a9eff;
            font-weight: 500;
            font-size: 0.9em;
        }

        .series-symbol {
            color: #888;
            font-size: 0.8em;
            font-family: monospace;
        }

        .add-btn {
            padding: 4px 12px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.85em;
            cursor: pointer;
        }

        .add-btn:hover {
            background: #5cbf60;
        }

        .selected-series {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .selected-series h3 {
            color: #4a9eff;
            margin-bottom: 10px;
        }

        .series-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .series-chip {
            background: #3949ab;
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .series-chip button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            line-height: 1;
            padding: 0;
        }

        .chart-section {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .chart-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select, button {
            padding: 8px 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        select:hover, button:hover {
            background: #333;
            border-color: #555;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: #222;
            border-radius: 8px;
            padding: 15px;
            position: relative;
        }

        .chart-title {
            font-size: 1.1em;
            color: #4a9eff;
            margin-bottom: 10px;
            text-align: center;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .changes-table {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
        }

        .changes-table h3 {
            color: #4a9eff;
            margin-bottom: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        th {
            background: #222;
            color: #4a9eff;
            font-weight: 600;
        }

        tr:hover {
            background: #222;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #ff5252;
        }

        .neutral {
            color: #888;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">FRED Data Explorer</h2>
            
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Search series (e.g., GDP, unemployment, inflation)..."
                    oninput="handleSearchInput()"
                >
                <span class="search-icon">üîç</span>
                <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
            </div>

            <div class="category-browser">
                <h3 style="color: #999; font-size: 0.9em; margin-bottom: 15px;">BROWSE BY CATEGORY</h3>
                <div id="categoryList"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>FRED Economic Data Dashboard</h1>
                <p>Select series from the sidebar to analyze with multiple time-based transformations</p>
            </div>

            <div id="selectedSeriesContainer" class="selected-series" style="display: none;">
                <h3>Selected Series</h3>
                <div id="seriesChips" class="series-chips"></div>
            </div>

            <div id="emptyState" class="empty-state">
                <h3>No Series Selected</h3>
                <p>Browse categories or search for series to begin your analysis</p>
            </div>

            <div id="chartSection" class="chart-section" style="display: none;">
                <div class="chart-controls">
                    <div class="control-group">
                        <label>Chart Type:</label>
                        <select id="chartType" onchange="updateAllCharts()">
                            <option value="line">Line</option>
                            <option value="bar">Bar</option>
                            <option value="area">Area</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Date Range:</label>
                        <select id="dateRange" onchange="updateAllCharts()">
                            <option value="1M">1 Month</option>
                            <option value="3M">3 Months</option>
                            <option value="6M">6 Months</option>
                            <option value="1Y" selected>1 Year</option>
                            <option value="2Y">2 Years</option>
                            <option value="5Y">5 Years</option>
                            <option value="ALL">All Data</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button onclick="downloadAllData()">üì• Download Data</button>
                        <button onclick="resetDashboard()">üîÑ Reset</button>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h4 class="chart-title">Original Values</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartOriginal"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Daily Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartDailyChange"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Daily Percent Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartDailyPercent"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Weekly Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartWeeklyChange"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Weekly Percent Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartWeeklyPercent"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Monthly Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartMonthlyChange"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Monthly Percent Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartMonthlyPercent"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Quarterly Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartQuarterlyChange"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <h4 class="chart-title">Quarterly Percent Change</h4>
                        <div class="chart-wrapper">
                            <canvas id="chartQuarterlyPercent"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="changesTable" class="changes-table" style="display: none;">
                <h3>Latest Changes Summary</h3>
                <table id="summaryTable">
                    <thead>
                        <tr>
                            <th>Series</th>
                            <th>Current Value</th>
                            <th>Daily Change</th>
                            <th>Daily %</th>
                            <th>Weekly Change</th>
                            <th>Weekly %</th>
                            <th>Monthly Change</th>
                            <th>Monthly %</th>
                            <th>Quarterly Change</th>
                            <th>Quarterly %</th>
                        </tr>
                    </thead>
                    <tbody id="summaryTableBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://ped8gafyuz.us-east-1.awsapprunner.com';
        
        // Comprehensive FRED series database
        const fredSeries = [
            // Interest Rates
            { symbol: 'DFF', name: 'Federal Funds Rate', category: 'Interest Rates' },
            { symbol: 'DGS10', name: '10-Year Treasury Rate', category: 'Interest Rates' },
            { symbol: 'DGS2', name: '2-Year Treasury Rate', category: 'Interest Rates' },
            { symbol: 'DGS5', name: '5-Year Treasury Rate', category: 'Interest Rates' },
            { symbol: 'DGS30', name: '30-Year Treasury Rate', category: 'Interest Rates' },
            { symbol: 'TB3MS', name: '3-Month Treasury Bill', category: 'Interest Rates' },
            { symbol: 'TB6MS', name: '6-Month Treasury Bill', category: 'Interest Rates' },
            { symbol: 'DFEDTARU', name: 'Fed Funds Target Range - Upper', category: 'Interest Rates' },
            { symbol: 'SOFR', name: 'Secured Overnight Financing Rate', category: 'Interest Rates' },
            { symbol: 'EFFR', name: 'Effective Federal Funds Rate', category: 'Interest Rates' },
            
            // Exchange Rates
            { symbol: 'DEXUSEU', name: 'USD/EUR Exchange Rate', category: 'Exchange Rates' },
            { symbol: 'DEXCHUS', name: 'CNY/USD Exchange Rate', category: 'Exchange Rates' },
            { symbol: 'DEXJPUS', name: 'JPY/USD Exchange Rate', category: 'Exchange Rates' },
            { symbol: 'DEXUSUK', name: 'USD/GBP Exchange Rate', category: 'Exchange Rates' },
            { symbol: 'DEXCAUS', name: 'CAD/USD Exchange Rate', category: 'Exchange Rates' },
            { symbol: 'DTWEXBGS', name: 'Trade Weighted Dollar Index', category: 'Exchange Rates' },
            
            // Monetary Data
            { symbol: 'M1SL', name: 'M1 Money Supply', category: 'Monetary Data' },
            { symbol: 'M2SL', name: 'M2 Money Supply', category: 'Monetary Data' },
            { symbol: 'M1V', name: 'M1 Money Velocity', category: 'Monetary Data' },
            { symbol: 'M2V', name: 'M2 Money Velocity', category: 'Monetary Data' },
            { symbol: 'BOGMBASE', name: 'Monetary Base', category: 'Monetary Data' },
            { symbol: 'TOTRESNS', name: 'Total Reserves', category: 'Monetary Data' },
            { symbol: 'WRESBAL', name: 'Reserve Balances', category: 'Monetary Data' },
            { symbol: 'CURRSL', name: 'Currency in Circulation', category: 'Monetary Data' },
            
            // Financial Indicators
            { symbol: 'VIXCLS', name: 'VIX Volatility Index', category: 'Financial Indicators' },
            { symbol: 'TEDRATE', name: 'TED Spread', category: 'Financial Indicators' },
            { symbol: 'T10Y2Y', name: '10Y-2Y Treasury Spread', category: 'Financial Indicators' },
            { symbol: 'T10Y3M', name: '10Y-3M Treasury Spread', category: 'Financial Indicators' },
            { symbol: 'BAMLH0A0HYM2', name: 'High Yield Spread', category: 'Financial Indicators' },
            
            // Employment
            { symbol: 'UNRATE', name: 'Unemployment Rate', category: 'Employment' },
            { symbol: 'PAYEMS', name: 'Nonfarm Payrolls', category: 'Employment' },
            { symbol: 'CIVPART', name: 'Labor Force Participation Rate', category: 'Employment' },
            { symbol: 'EMRATIO', name: 'Employment-Population Ratio', category: 'Employment' },
            { symbol: 'UNEMPLOY', name: 'Unemployed Persons', category: 'Employment' },
            { symbol: 'ICSA', name: 'Initial Jobless Claims', category: 'Employment' },
            
            // GDP & Production
            { symbol: 'GDP', name: 'Gross Domestic Product', category: 'GDP & Production' },
            { symbol: 'GDPC1', name: 'Real GDP', category: 'GDP & Production' },
            { symbol: 'GDPPOT', name: 'Real Potential GDP', category: 'GDP & Production' },
            { symbol: 'INDPRO', name: 'Industrial Production Index', category: 'GDP & Production' },
            
            // Prices & Inflation
            { symbol: 'CPIAUCSL', name: 'Consumer Price Index', category: 'Prices' },
            { symbol: 'CPILFESL', name: 'Core CPI', category: 'Prices' },
            { symbol: 'PPIACO', name: 'Producer Price Index', category: 'Prices' },
            { symbol: 'DFEDTARU', name: 'Fed Funds Target Rate', category: 'Prices' },
            
            // Housing
            { symbol: 'HOUST', name: 'Housing Starts', category: 'Housing' },
            { symbol: 'PERMIT', name: 'Building Permits', category: 'Housing' },
            { symbol: 'CSUSHPISA', name: 'Case-Shiller Home Price Index', category: 'Housing' },
            { symbol: 'MORTGAGE30US', name: '30-Year Mortgage Rate', category: 'Housing' },
            
            // Add more series as needed...
        ];

        const categoryGroups = {
            'Money, Banking, & Finance': ['Interest Rates', 'Exchange Rates', 'Monetary Data', 'Financial Indicators'],
            'Population, Employment, & Labor Markets': ['Employment'],
            'National Accounts': ['GDP & Production'],
            'Production & Business Activity': ['GDP & Production', 'Housing'],
            'Prices': ['Prices']
        };

        let selectedSeries = [];
        let seriesData = {};
        let chartInstances = {};

        function initializeCategories() {
            const categoryList = document.getElementById('categoryList');
            
            Object.entries(categoryGroups).forEach(([mainCategory, subcategories]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-item';
                
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                categoryHeader.innerHTML = `
                    <span>${mainCategory}</span>
                    <span class="category-count">${getSeriesCount(subcategories)}+</span>
                `;
                categoryHeader.onclick = () => toggleCategory(mainCategory);
                
                const seriesList = document.createElement('div');
                seriesList.className = 'series-list';
                seriesList.id = `category-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                // Group series by subcategory
                subcategories.forEach(subcat => {
                    const subcatSeries = fredSeries.filter(s => s.category === subcat);
                    if (subcatSeries.length > 0) {
                        const subcatHeader = document.createElement('div');
                        subcatHeader.style.cssText = 'color: #888; font-size: 0.9em; margin: 10px 0 5px 0;';
                        subcatHeader.textContent = subcat;
                        seriesList.appendChild(subcatHeader);
                        
                        subcatSeries.forEach(series => {
                            const seriesItem = createSeriesItem(series);
                            seriesList.appendChild(seriesItem);
                        });
                    }
                });
                
                categoryDiv.appendChild(categoryHeader);
                categoryDiv.appendChild(seriesList);
                categoryList.appendChild(categoryDiv);
            });
        }

        function getSeriesCount(subcategories) {
            return fredSeries.filter(s => subcategories.includes(s.category)).length;
        }

        function createSeriesItem(series) {
            const item = document.createElement('div');
            item.className = 'series-item';
            item.innerHTML = `
                <div class="series-info">
                    <div class="series-name">${series.name}</div>
                    <div class="series-symbol">${series.symbol}</div>
                </div>
                <button class="add-btn" onclick="addSeries('${series.symbol}')">Add</button>
            `;
            return item;
        }

        function toggleCategory(category) {
            const id = `category-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const seriesList = document.getElementById(id);
            
            // Close all other categories
            document.querySelectorAll('.series-list').forEach(list => {
                if (list.id !== id) {
                    list.classList.remove('show');
                }
            });
            
            seriesList.classList.toggle('show');
        }

        function handleSearchInput() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const dropdown = document.getElementById('autocompleteDropdown');
            
            if (query.length < 1) {
                dropdown.style.display = 'none';
                return;
            }
            
            const matches = fredSeries.filter(series => 
                series.name.toLowerCase().includes(query) || 
                series.symbol.toLowerCase().includes(query)
            );
            
            if (matches.length > 0) {
                dropdown.innerHTML = matches.slice(0, 10).map(series => `
                    <div class="autocomplete-item" onclick="selectAutocomplete('${series.symbol}')">
                        <div class="autocomplete-item-title">${series.name}</div>
                        <div class="autocomplete-item-symbol">${series.symbol} - ${series.category}</div>
                    </div>
                `).join('');
                dropdown.style.display = 'block';
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectAutocomplete(symbol) {
            document.getElementById('searchInput').value = '';
            document.getElementById('autocompleteDropdown').style.display = 'none';
            addSeries(symbol);
        }

        async function addSeries(symbol) {
            if (selectedSeries.includes(symbol)) {
                alert('Series already added');
                return;
            }
            
            const series = fredSeries.find(s => s.symbol === symbol);
            if (!series) return;
            
            // Show loading state
            const addBtn = event.target;
            if (addBtn) {
                addBtn.textContent = 'Loading...';
                addBtn.disabled = true;
            }
            
            try {
                const data = await fetchSeriesData(symbol);
                if (data) {
                    seriesData[symbol] = data;
                    selectedSeries.push(symbol);
                    updateUI();
                }
            } catch (error) {
                console.error('Error loading series:', error);
                alert('Error loading series data');
            } finally {
                if (addBtn) {
                    addBtn.textContent = 'Add';
                    addBtn.disabled = false;
                }
            }
        }

        async function fetchSeriesData(symbol) {
            try {
                const url = `${API_BASE}/api/v1/universal/data?symbol=${symbol}&provider=fred`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                
                let results = [];
                if (data && data.data) results = data.data;
                else if (data && data.results) results = data.results;
                else if (Array.isArray(data)) results = data;
                
                if (results.length === 0) throw new Error('No data available');
                
                const processedData = results.map(item => ({
                    date: new Date(item.date || item.Date),
                    value: parseFloat(item[symbol] || item.value || item.Value || 0)
                })).filter(item => !isNaN(item.value))
                  .sort((a, b) => a.date - b.date);
                
                return processedData;
                
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                return null;
            }
        }

        function removeSeries(symbol) {
            selectedSeries = selectedSeries.filter(s => s !== symbol);
            delete seriesData[symbol];
            updateUI();
        }

        function updateUI() {
            // Update selected series chips
            const chipsContainer = document.getElementById('seriesChips');
            chipsContainer.innerHTML = selectedSeries.map(symbol => {
                const series = fredSeries.find(s => s.symbol === symbol);
                return `
                    <div class="series-chip">
                        ${series ? series.name : symbol}
                        <button onclick="removeSeries('${symbol}')">√ó</button>
                    </div>
                `;
            }).join('');
            
            // Show/hide sections
            const hasData = selectedSeries.length > 0;
            document.getElementById('selectedSeriesContainer').style.display = hasData ? 'block' : 'none';
            document.getElementById('emptyState').style.display = hasData ? 'none' : 'block';
            document.getElementById('chartSection').style.display = hasData ? 'block' : 'none';
            document.getElementById('changesTable').style.display = hasData ? 'block' : 'none';
            
            if (hasData) {
                updateAllCharts();
                updateSummaryTable();
            }
        }

        function calculateChange(data, days) {
            if (data.length < 2) return [];
            
            const changes = [];
            for (let i = 0; i < data.length; i++) {
                const targetDate = new Date(data[i].date);
                targetDate.setDate(targetDate.getDate() - days);
                
                let previousPoint = null;
                for (let j = i - 1; j >= 0; j--) {
                    const daysDiff = (data[i].date - data[j].date) / (1000 * 60 * 60 * 24);
                    if (daysDiff >= days - 1 && daysDiff <= days + 1) {
                        previousPoint = data[j];
                        break;
                    }
                }
                
                if (previousPoint) {
                    changes.push({
                        date: data[i].date,
                        value: data[i].value - previousPoint.value
                    });
                }
            }
            return changes;
        }

        function calculatePercentChange(data, days) {
            const changes = calculateChange(data, days);
            return changes.map(c => {
                const original = data.find(d => d.date.getTime() === c.date.getTime());
                const prevValue = original.value - c.value;
                return {
                    date: c.date,
                    value: prevValue !== 0 ? (c.value / prevValue) * 100 : 0
                };
            });
        }

        function updateAllCharts() {
            const chartType = document.getElementById('chartType').value;
            const dateRange = document.getElementById('dateRange').value;
            
            // Define chart configurations
            const charts = [
                { id: 'chartOriginal', transform: 'original' },
                { id: 'chartDailyChange', transform: 'dailyChange' },
                { id: 'chartDailyPercent', transform: 'dailyPercent' },
                { id: 'chartWeeklyChange', transform: 'weeklyChange' },
                { id: 'chartWeeklyPercent', transform: 'weeklyPercent' },
                { id: 'chartMonthlyChange', transform: 'monthlyChange' },
                { id: 'chartMonthlyPercent', transform: 'monthlyPercent' },
                { id: 'chartQuarterlyChange', transform: 'quarterlyChange' },
                { id: 'chartQuarterlyPercent', transform: 'quarterlyPercent' }
            ];
            
            charts.forEach(chart => {
                updateChart(chart.id, chart.transform, chartType, dateRange);
            });
        }

        function getFilteredData(data, dateRange) {
            if (dateRange === 'ALL') return data;
            
            const now = new Date();
            const ranges = {
                '1M': 30,
                '3M': 90,
                '6M': 180,
                '1Y': 365,
                '2Y': 730,
                '5Y': 1825
            };
            
            const days = ranges[dateRange] || 365;
            const startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
            
            return data.filter(d => d.date >= startDate);
        }

        function updateChart(canvasId, transform, chartType, dateRange) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart
            if (chartInstances[canvasId]) {
                chartInstances[canvasId].destroy();
            }
            
            const datasets = selectedSeries.map((symbol, index) => {
                let data = seriesData[symbol];
                if (!data) return null;
                
                // Apply date range filter
                data = getFilteredData(data, dateRange);
                
                // Apply transformation
                let transformedData;
                switch (transform) {
                    case 'original':
                        transformedData = data;
                        break;
                    case 'dailyChange':
                        transformedData = calculateChange(data, 1);
                        break;
                    case 'dailyPercent':
                        transformedData = calculatePercentChange(data, 1);
                        break;
                    case 'weeklyChange':
                        transformedData = calculateChange(data, 7);
                        break;
                    case 'weeklyPercent':
                        transformedData = calculatePercentChange(data, 7);
                        break;
                    case 'monthlyChange':
                        transformedData = calculateChange(data, 30);
                        break;
                    case 'monthlyPercent':
                        transformedData = calculatePercentChange(data, 30);
                        break;
                    case 'quarterlyChange':
                        transformedData = calculateChange(data, 90);
                        break;
                    case 'quarterlyPercent':
                        transformedData = calculatePercentChange(data, 90);
                        break;
                    default:
                        transformedData = data;
                }
                
                const series = fredSeries.find(s => s.symbol === symbol);
                
                return {
                    label: series ? series.name : symbol,
                    data: transformedData.map(d => ({ x: d.date, y: d.value })),
                    borderColor: `hsl(${index * 360 / selectedSeries.length}, 70%, 50%)`,
                    backgroundColor: `hsla(${index * 360 / selectedSeries.length}, 70%, 50%, 0.1)`,
                    borderWidth: 2,
                    fill: chartType === 'area',
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                };
            }).filter(d => d !== null);
            
            const isPercent = transform.includes('Percent');
            const yAxisFormat = isPercent ? (v) => v.toFixed(2) + '%' : (v) => v.toFixed(2);
            
            chartInstances[canvasId] = new Chart(ctx, {
                type: chartType === 'area' ? 'line' : chartType,
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + yAxisFormat(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            ticks: { 
                                color: '#888',
                                maxTicksLimit: 6
                            },
                            grid: { 
                                color: '#333',
                                display: false
                            }
                        },
                        y: {
                            ticks: { 
                                color: '#888',
                                callback: yAxisFormat
                            },
                            grid: { 
                                color: '#333'
                            }
                        }
                    }
                }
            });
        }

        function updateSummaryTable() {
            const tbody = document.getElementById('summaryTableBody');
            
            tbody.innerHTML = selectedSeries.map(symbol => {
                const data = seriesData[symbol];
                if (!data || data.length === 0) return '';
                
                const series = fredSeries.find(s => s.symbol === symbol);
                const latest = data[data.length - 1];
                
                // Calculate all changes
                const dailyChange = calculateChange(data, 1);
                const dailyPercent = calculatePercentChange(data, 1);
                const weeklyChange = calculateChange(data, 7);
                const weeklyPercent = calculatePercentChange(data, 7);
                const monthlyChange = calculateChange(data, 30);
                const monthlyPercent = calculatePercentChange(data, 30);
                const quarterlyChange = calculateChange(data, 90);
                const quarterlyPercent = calculatePercentChange(data, 90);
                
                const getLatest = (arr) => arr.length > 0 ? arr[arr.length - 1].value : null;
                
                return `
                    <tr>
                        <td>${series ? series.name : symbol}</td>
                        <td>${latest.value.toFixed(2)}</td>
                        <td class="${getChangeClass(getLatest(dailyChange))}">${formatChange(getLatest(dailyChange))}</td>
                        <td class="${getChangeClass(getLatest(dailyPercent))}">${formatPercent(getLatest(dailyPercent))}</td>
                        <td class="${getChangeClass(getLatest(weeklyChange))}">${formatChange(getLatest(weeklyChange))}</td>
                        <td class="${getChangeClass(getLatest(weeklyPercent))}">${formatPercent(getLatest(weeklyPercent))}</td>
                        <td class="${getChangeClass(getLatest(monthlyChange))}">${formatChange(getLatest(monthlyChange))}</td>
                        <td class="${getChangeClass(getLatest(monthlyPercent))}">${formatPercent(getLatest(monthlyPercent))}</td>
                        <td class="${getChangeClass(getLatest(quarterlyChange))}">${formatChange(getLatest(quarterlyChange))}</td>
                        <td class="${getChangeClass(getLatest(quarterlyPercent))}">${formatPercent(getLatest(quarterlyPercent))}</td>
                    </tr>
                `;
            }).join('');
        }

        function getChangeClass(value) {
            if (value === null) return 'neutral';
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }

        function formatChange(value) {
            if (value === null) return '-';
            return value.toFixed(2);
        }

        function formatPercent(value) {
            if (value === null) return '-';
            return value.toFixed(2) + '%';
        }

        function downloadAllData() {
            if (selectedSeries.length === 0) {
                alert('No data to download');
                return;
            }
            
            let csv = 'Date,' + selectedSeries.map(s => {
                const series = fredSeries.find(ser => ser.symbol === s);
                return series ? series.name : s;
            }).join(',') + '\n';
            
            // Get all unique dates
            const allDates = new Set();
            selectedSeries.forEach(symbol => {
                const data = seriesData[symbol] || [];
                data.forEach(d => allDates.add(d.date.toISOString().split('T')[0]));
            });
            
            const sortedDates = Array.from(allDates).sort();
            
            sortedDates.forEach(date => {
                csv += date;
                selectedSeries.forEach(symbol => {
                    const data = seriesData[symbol] || [];
                    const point = data.find(d => d.date.toISOString().split('T')[0] === date);
                    csv += ',' + (point ? point.value : '');
                });
                csv += '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fred_data_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function resetDashboard() {
            selectedSeries = [];
            seriesData = {};
            updateUI();
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initializeCategories();
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.search-container')) {
                    document.getElementById('autocompleteDropdown').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>