<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Monetary Policy Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .header p {
            font-size: 1.1em;
            color: #b3c5ff;
        }

        .real-time-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3949ab;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-result-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #333;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            color: #4a9eff;
            font-weight: 500;
            font-size: 0.9em;
        }

        .search-result-symbol {
            color: #888;
            font-size: 0.8em;
        }

        .category-browser {
            margin-top: 20px;
        }

        .category-browser h3 {
            color: #4a9eff;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .main-category {
            margin-bottom: 15px;
        }

        .main-category-header {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .main-category-header:hover {
            background: #333;
        }

        .main-category-header.active {
            background: #3949ab;
        }

        .category-count {
            font-size: 0.85em;
            color: #888;
            background: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .subcategories {
            margin-left: 20px;
            margin-top: 10px;
            display: none;
        }

        .subcategories.show {
            display: block;
        }

        .subcategory {
            margin-bottom: 10px;
        }

        .subcategory-header {
            padding: 10px;
            background: #222;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .subcategory-header:hover {
            background: #333;
            transform: translateX(5px);
        }

        .series-list {
            margin-left: 20px;
            margin-top: 8px;
            display: none;
        }

        .series-list.show {
            display: block;
        }

        .series-item {
            padding: 8px 10px;
            background: #1a1a1a;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .series-item:hover {
            background: #2a2a2a;
            transform: translateX(3px);
        }

        .series-name {
            color: #4a9eff;
            flex: 1;
            margin-right: 10px;
        }

        .series-symbol {
            color: #666;
            font-family: monospace;
            font-size: 0.8em;
        }

        .add-btn {
            padding: 4px 12px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: #5cbf60;
        }

        .add-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        /* Tabs for different views */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #e0e0e0;
        }

        .tab.active {
            color: #4a9eff;
            border-bottom-color: #4a9eff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Heatmap styles */
        .heatmap-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .heatmap-title {
            font-size: 1.4em;
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 120px repeat(7, 1fr);
            gap: 2px;
            margin-top: 10px;
        }

        .heatmap-cell {
            padding: 10px;
            text-align: center;
            font-size: 0.85em;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .heatmap-header {
            background: #222;
            color: #888;
            font-weight: 600;
        }

        .heatmap-label {
            background: #222;
            color: #4a9eff;
            font-weight: 500;
            text-align: left;
            padding-left: 15px;
        }

        /* Advanced visualizations */
        .visualization-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .viz-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
        }

        .viz-title {
            font-size: 1.2em;
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Watchlist improvements */
        .watchlist-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-size: 1.8em;
            color: #4a9eff;
        }

        .watchlist-controls {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .watchlist-btn:hover {
            background: #333;
            border-color: #555;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .watchlist-table th {
            background: #222;
            color: #4a9eff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .watchlist-table tr:hover {
            background: #222;
        }

        .series-name-cell {
            color: #4a9eff;
            font-weight: 500;
        }

        .series-symbol-cell {
            color: #666;
            font-size: 0.85em;
        }

        .value-cell {
            text-align: right;
            font-family: monospace;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #ff5252;
        }

        .neutral {
            color: #888;
        }

        .mini-chart {
            width: 100px;
            height: 30px;
            display: inline-block;
        }

        .remove-btn {
            padding: 4px 8px;
            background: #d32f2f;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
        }

        .remove-btn:hover {
            background: #f44336;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .stats-bar {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        /* Alert system */
        .alerts-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            z-index: 1000;
        }

        .alert {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
        }

        .alert.warning {
            border-color: #ff9800;
        }

        .alert.error {
            border-color: #f44336;
        }

        .alert.success {
            border-color: #4caf50;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .alert-message {
            font-size: 0.9em;
            color: #ccc;
        }

        /* Analytics panel */
        .analytics-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .analytics-title {
            font-size: 1.4em;
            color: #4a9eff;
            margin-bottom: 15px;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .analytics-card {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .analytics-value {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .analytics-label {
            font-size: 0.9em;
            color: #888;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
            
            .visualization-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">Global Economic Data Explorer</h2>
            
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Search economic series..."
                    autocomplete="off"
                >
                <span class="search-icon">üîç</span>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="category-browser">
                <h3>Browse by Source</h3>
                <div id="categoryList"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Advanced Monetary Policy Dashboard</h1>
                <p>Real-time tracking with advanced analytics and visualizations</p>
                <div class="real-time-indicator">
                    <div class="pulse-dot"></div>
                    <span style="font-size: 0.9em; color: #ccc;">Live Updates</span>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showTab('watchlist')">Watchlist</button>
                <button class="tab" onclick="showTab('heatmap')">Heatmap</button>
                <button class="tab" onclick="showTab('analytics')">Analytics</button>
                <button class="tab" onclick="showTab('visualizations')">Visualizations</button>
            </div>

            <!-- Alerts container -->
            <div id="alertsContainer" class="alerts-container"></div>

            <!-- Watchlist Tab -->
            <div id="watchlistTab" class="tab-content active">
                <div id="statsBar" class="stats-bar" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="totalSeries">0</div>
                        <div class="stat-label">Series Tracked</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value positive" id="gainers">0</div>
                        <div class="stat-label">Gainers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value negative" id="losers">0</div>
                        <div class="stat-label">Losers</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avgChange">0%</div>
                        <div class="stat-label">Avg Daily Change</div>
                    </div>
                </div>

                <div class="watchlist-container">
                    <div class="watchlist-header">
                        <h2 class="watchlist-title">My Watchlist</h2>
                        <div class="watchlist-controls">
                            <button class="watchlist-btn" onclick="refreshAllData()">üîÑ Refresh All</button>
                            <button class="watchlist-btn" onclick="downloadWatchlist()">üì• Download CSV</button>
                            <button class="watchlist-btn" onclick="clearWatchlist()">üóëÔ∏è Clear All</button>
                        </div>
                    </div>

                    <div id="watchlistContent">
                        <div class="empty-state">
                            <h3>Your watchlist is empty</h3>
                            <p>Search or browse categories to add series to your watchlist</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Heatmap Tab -->
            <div id="heatmapTab" class="tab-content">
                <div class="heatmap-container">
                    <h3 class="heatmap-title">Global Economic Indicators Heatmap</h3>
                    <div id="heatmapContent">
                        <p style="text-align: center; color: #666; padding: 40px;">
                            Add series to your watchlist to see the heatmap visualization
                        </p>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <div class="analytics-panel">
                    <h3 class="analytics-title">Advanced Analytics</h3>
                    <div id="analyticsContent" class="analytics-grid">
                        <p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">
                            Add series to your watchlist to see analytics
                        </p>
                    </div>
                </div>

                <div class="analytics-panel">
                    <h3 class="analytics-title">Calculated Indicators</h3>
                    <div id="calculatedIndicators" class="analytics-grid">
                        <!-- Calculated indicators will appear here -->
                    </div>
                </div>
            </div>

            <!-- Visualizations Tab -->
            <div id="visualizationsTab" class="tab-content">
                <div class="visualization-grid">
                    <div class="viz-card">
                        <h3 class="viz-title">Yield Curve</h3>
                        <div class="chart-container">
                            <canvas id="yieldCurveChart"></canvas>
                        </div>
                    </div>
                    <div class="viz-card">
                        <h3 class="viz-title">Correlation Matrix</h3>
                        <div class="chart-container">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                    <div class="viz-card">
                        <h3 class="viz-title">Momentum Indicators</h3>
                        <div class="chart-container">
                            <canvas id="momentumChart"></canvas>
                        </div>
                    </div>
                    <div class="viz-card">
                        <h3 class="viz-title">Volatility Analysis</h3>
                        <div class="chart-container">
                            <canvas id="volatilityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://ped8gafyuz.us-east-1.awsapprunner.com';
        
        // Comprehensive economic data series with complete FRED categories
        const economicData = {
            'FRED > Money, Banking, & Finance': {
                'Interest Rates (440+ series)': [
                    // Federal Funds and Policy Rates
                    { symbol: 'DFF', name: 'Federal Funds Rate (Daily)' },
                    { symbol: 'EFFR', name: 'Effective Federal Funds Rate' },
                    { symbol: 'OBFR', name: 'Overnight Bank Funding Rate' },
                    { symbol: 'SOFR', name: 'Secured Overnight Financing Rate' },
                    { symbol: 'DFEDTARU', name: 'Fed Funds Target Range - Upper' },
                    { symbol: 'DFEDTARL', name: 'Fed Funds Target Range - Lower' },
                    { symbol: 'DFEDTAR', name: 'Fed Funds Target Rate' },
                    { symbol: 'FEDFUNDS', name: 'Federal Funds Rate (Monthly)' },
                    
                    // Treasury Rates - Bills
                    { symbol: 'DTB4WK', name: '4-Week Treasury Bill' },
                    { symbol: 'DTB3', name: '3-Month Treasury Bill' },
                    { symbol: 'DTB6', name: '6-Month Treasury Bill' },
                    { symbol: 'TB3MS', name: '3-Month Treasury Bill (Monthly)' },
                    { symbol: 'TB6MS', name: '6-Month Treasury Bill (Monthly)' },
                    
                    // Treasury Rates - Notes and Bonds
                    { symbol: 'DGS1', name: '1-Year Treasury Rate' },
                    { symbol: 'DGS2', name: '2-Year Treasury Rate' },
                    { symbol: 'DGS3', name: '3-Year Treasury Rate' },
                    { symbol: 'DGS5', name: '5-Year Treasury Rate' },
                    { symbol: 'DGS7', name: '7-Year Treasury Rate' },
                    { symbol: 'DGS10', name: '10-Year Treasury Rate' },
                    { symbol: 'DGS20', name: '20-Year Treasury Rate' },
                    { symbol: 'DGS30', name: '30-Year Treasury Rate' },
                    
                    // TIPS and Real Rates
                    { symbol: 'DFII5', name: '5-Year TIPS' },
                    { symbol: 'DFII10', name: '10-Year TIPS' },
                    { symbol: 'DFII20', name: '20-Year TIPS' },
                    { symbol: 'DFII30', name: '30-Year TIPS' },
                    { symbol: 'T5YIE', name: '5-Year Breakeven Inflation Rate' },
                    { symbol: 'T10YIE', name: '10-Year Breakeven Inflation Rate' },
                    { symbol: 'T5YIFR', name: '5-Year Forward Inflation Expectation' },
                    
                    // Corporate and Credit Rates
                    { symbol: 'AAA', name: 'Moody\'s AAA Corporate Bond Yield' },
                    { symbol: 'BAA', name: 'Moody\'s BAA Corporate Bond Yield' },
                    { symbol: 'BAMLH0A0HYM2', name: 'High Yield Index OAS' },
                    { symbol: 'BAMLC0A0CM', name: 'Investment Grade Index OAS' },
                    
                    // Mortgage Rates
                    { symbol: 'MORTGAGE30US', name: '30-Year Fixed Mortgage Rate' },
                    { symbol: 'MORTGAGE15US', name: '15-Year Fixed Mortgage Rate' },
                    { symbol: 'MORTGAGE5US', name: '5/1 ARM Mortgage Rate' },
                    
                    // Bank and Consumer Rates
                    { symbol: 'PRIME', name: 'Bank Prime Loan Rate' },
                    { symbol: 'MPRIME', name: 'Bank Prime Rate (Monthly)' },
                    { symbol: 'DPRIME', name: 'Prime Rate Charged by Banks' },
                    { symbol: 'TERMCBPER24NS', name: '24-Month Personal Loan Rate' },
                    { symbol: 'TERMCBCCALLNS', name: 'Credit Card Interest Rate' },
                    
                    // International Rates
                    { symbol: 'INTDSREUM193N', name: 'Euro Area Interest Rate' },
                    { symbol: 'INTDSRGBM193N', name: 'UK Interest Rate' },
                    { symbol: 'INTDSRJPM193N', name: 'Japan Interest Rate' },
                    { symbol: 'INTDSRCNM193N', name: 'China Interest Rate' },
                    
                    // Spreads
                    { symbol: 'T10Y2Y', name: '10-Year Treasury Minus 2-Year' },
                    { symbol: 'T10Y3M', name: '10-Year Treasury Minus 3-Month' },
                    { symbol: 'TEDRATE', name: 'TED Spread' },
                    { symbol: 'BAAFFM', name: 'BAA-FF Spread' }
                ],
                'Exchange Rates (9+ series)': [
                    { symbol: 'DEXUSEU', name: 'US Dollar to Euro' },
                    { symbol: 'DEXUSUK', name: 'US Dollar to British Pound' },
                    { symbol: 'DEXJPUS', name: 'Japanese Yen to US Dollar' },
                    { symbol: 'DEXCHUS', name: 'Chinese Yuan to US Dollar' },
                    { symbol: 'DEXCAUS', name: 'Canadian Dollar to US Dollar' },
                    { symbol: 'DEXMXUS', name: 'Mexican Peso to US Dollar' },
                    { symbol: 'DEXKOUS', name: 'Korean Won to US Dollar' },
                    { symbol: 'DEXINUS', name: 'Indian Rupee to US Dollar' },
                    { symbol: 'DEXBZUS', name: 'Brazilian Real to US Dollar' },
                    { symbol: 'DEXSFUS', name: 'South African Rand to US Dollar' },
                    { symbol: 'DEXAUUS', name: 'Australian Dollar to US Dollar' },
                    { symbol: 'DTWEXBGS', name: 'Trade Weighted Dollar Index - Broad' },
                    { symbol: 'DTWEXAFEGS', name: 'Trade Weighted Dollar - Advanced Foreign Economies' },
                    { symbol: 'DTWEXEMEGS', name: 'Trade Weighted Dollar - Emerging Markets' }
                ],
                'Monetary Data (1,100+ series)': [
                    // Money Supply
                    { symbol: 'M1SL', name: 'M1 Money Supply' },
                    { symbol: 'M2SL', name: 'M2 Money Supply' },
                    { symbol: 'M1V', name: 'M1 Money Velocity' },
                    { symbol: 'M2V', name: 'M2 Money Velocity' },
                    { symbol: 'WM1NS', name: 'M1 Money Stock (Weekly)' },
                    { symbol: 'WM2NS', name: 'M2 Money Stock (Weekly)' },
                    { symbol: 'MZMSL', name: 'MZM Money Stock (Discontinued)' },
                    { symbol: 'MZMV', name: 'MZM Velocity' },
                    
                    // Monetary Base and Reserves
                    { symbol: 'BOGMBASE', name: 'Monetary Base' },
                    { symbol: 'AMBSL', name: 'Adjusted Monetary Base' },
                    { symbol: 'TOTRESNS', name: 'Total Reserves' },
                    { symbol: 'REQRESNS', name: 'Required Reserves' },
                    { symbol: 'EXCSRESNS', name: 'Excess Reserves' },
                    { symbol: 'WRESBAL', name: 'Reserve Balances with Fed Banks' },
                    { symbol: 'RESBALNS', name: 'Reserve Balances (Not Seasonally Adjusted)' },
                    
                    // Fed Balance Sheet Items
                    { symbol: 'WALCL', name: 'Fed Total Assets' },
                    { symbol: 'RESPPNTEPNWW', name: 'Eligible Collateral' },
                    { symbol: 'RESPPALGUONNWW', name: 'Treasury Securities Held' },
                    { symbol: 'WSHOMCB', name: 'Mortgage-Backed Securities Held' },
                    { symbol: 'SWPT', name: 'Central Bank Liquidity Swaps' },
                    { symbol: 'SWP1690', name: 'Swaps Maturing 16-90 Days' },
                    { symbol: 'OTHL1690', name: 'Loans Maturing 16-90 Days' },
                    
                    // Currency
                    { symbol: 'CURRSL', name: 'Currency in Circulation' },
                    { symbol: 'WCURRNS', name: 'Currency in Circulation (Weekly)' },
                    { symbol: 'CURRCIR', name: 'Currency Component of M1' }
                ],
                'Financial Indicators (2,200+ series)': [
                    // Volatility and Risk
                    { symbol: 'VIXCLS', name: 'VIX - CBOE Volatility Index' },
                    { symbol: 'VXOCLS', name: 'VXO - Old VIX' },
                    { symbol: 'EVZCLS', name: 'Euro Currency Volatility Index' },
                    { symbol: 'GVZCLS', name: 'Gold Volatility Index' },
                    { symbol: 'OVXCLS', name: 'Oil Volatility Index' },
                    
                    // Financial Stress Indices
                    { symbol: 'STLFSI4', name: 'St. Louis Fed Financial Stress Index' },
                    { symbol: 'NFCI', name: 'Chicago Fed National Financial Conditions Index' },
                    { symbol: 'ANFCI', name: 'Adjusted NFCI' },
                    { symbol: 'KCFSI', name: 'Kansas City Financial Stress Index' },
                    { symbol: 'CFSI', name: 'Cleveland Financial Stress Index' },
                    
                    // Credit Spreads
                    { symbol: 'BAMLH0A0HYM2', name: 'High Yield Spread' },
                    { symbol: 'BAMLC0A0CM', name: 'Investment Grade Spread' },
                    { symbol: 'BAMLH0A1HYBB', name: 'BB-Rated Spread' },
                    { symbol: 'BAMLH0A2HYB', name: 'B-Rated Spread' },
                    { symbol: 'BAMLH0A3HYC', name: 'CCC-Rated Spread' }
                ],
                'Banking (5,100+ series)': [
                    // Bank Assets and Liabilities
                    { symbol: 'DPSACBW027SBOG', name: 'Deposits, All Commercial Banks' },
                    { symbol: 'TOTBKCR', name: 'Bank Credit, All Banks' },
                    { symbol: 'USGSEC', name: 'Treasury & Agency Securities Held' },
                    { symbol: 'OTHSEC', name: 'Other Securities Held by Banks' },
                    { symbol: 'TOTLL', name: 'Total Loans and Leases' },
                    
                    // Loan Categories
                    { symbol: 'BUSLOANS', name: 'Commercial and Industrial Loans' },
                    { symbol: 'REALLN', name: 'Real Estate Loans' },
                    { symbol: 'CONSUMER', name: 'Consumer Loans' },
                    { symbol: 'REVOLSL', name: 'Revolving Consumer Credit' },
                    { symbol: 'NONREVSL', name: 'Non-Revolving Consumer Credit' },
                    
                    // Bank Performance
                    { symbol: 'USROE', name: 'Return on Equity for US Banks' },
                    { symbol: 'USROA', name: 'Return on Assets for US Banks' },
                    { symbol: 'USNIM', name: 'Net Interest Margin for US Banks' },
                    { symbol: 'NDFACBW027SBOG', name: 'Delinquency Rate on All Loans' }
                ],
                'Business Lending (2,200+ series)': [
                    { symbol: 'BCLOANSNSA', name: 'Commercial & Industrial Loans (NSA)' },
                    { symbol: 'BUSLOANS', name: 'Business Loans, All Banks' },
                    { symbol: 'CILOANSNSA', name: 'C&I Loans (Not Seasonally Adjusted)' },
                    { symbol: 'TOTCI', name: 'Total C&I Loans Outstanding' },
                    { symbol: 'ECOMPCTNSA', name: 'Commercial Paper Outstanding' },
                    { symbol: 'COMPOUT', name: 'Commercial Paper Outstanding (Total)' },
                    { symbol: 'DTCTHFNM', name: 'Total Consumer Credit Outstanding' },
                    { symbol: 'TOTALSL', name: 'Total Consumer Credit' }
                ]
            },
            'FRED > Population, Employment, & Labor Markets': {
                'Current Population Survey (6,800+ series)': [
                    { symbol: 'UNRATE', name: 'Unemployment Rate' },
                    { symbol: 'CIVPART', name: 'Labor Force Participation Rate' },
                    { symbol: 'EMRATIO', name: 'Employment-Population Ratio' },
                    { symbol: 'UNEMPLOY', name: 'Unemployed Persons (Thousands)' },
                    { symbol: 'CLF16OV', name: 'Civilian Labor Force' },
                    { symbol: 'CE16OV', name: 'Civilian Employment' },
                    { symbol: 'UEMPLT5', name: 'Unemployed Less Than 5 Weeks' },
                    { symbol: 'UEMP5TO14', name: 'Unemployed 5-14 Weeks' },
                    { symbol: 'UEMP15T26', name: 'Unemployed 15-26 Weeks' },
                    { symbol: 'UEMP27OV', name: 'Unemployed 27+ Weeks' },
                    { symbol: 'U6RATE', name: 'U-6 Unemployment Rate' },
                    { symbol: 'NROU', name: 'Natural Rate of Unemployment' }
                ],
                'Current Employment Statistics (390+ series)': [
                    { symbol: 'PAYEMS', name: 'All Employees: Total Nonfarm' },
                    { symbol: 'USCONS', name: 'Construction Employment' },
                    { symbol: 'MANEMP', name: 'Manufacturing Employment' },
                    { symbol: 'USTRADE', name: 'Retail Trade Employment' },
                    { symbol: 'USFIRE', name: 'Financial Activities Employment' },
                    { symbol: 'USPBS', name: 'Professional & Business Services' },
                    { symbol: 'USEHS', name: 'Education & Health Services' },
                    { symbol: 'USLAH', name: 'Leisure & Hospitality' },
                    { symbol: 'USGOVT', name: 'Government Employment' },
                    { symbol: 'CES0500000003', name: 'Average Hourly Earnings' },
                    { symbol: 'AWHAETP', name: 'Average Weekly Hours' },
                    { symbol: 'AWHNONAG', name: 'Average Weekly Hours - Private' }
                ],
                'Weekly Initial Claims (9+ series)': [
                    { symbol: 'ICSA', name: 'Initial Claims' },
                    { symbol: 'IC4WSA', name: '4-Week Moving Average' },
                    { symbol: 'CCSA', name: 'Continued Claims' },
                    { symbol: 'ICNSA', name: 'Initial Claims (NSA)' },
                    { symbol: 'CCNSA', name: 'Continued Claims (NSA)' }
                ],
                'Income Distribution (220+ series)': [
                    { symbol: 'MEHOINUSA672N', name: 'Real Median Household Income' },
                    { symbol: 'DSPIC96', name: 'Real Disposable Personal Income' },
                    { symbol: 'A229RC0', name: 'Personal Income' },
                    { symbol: 'GINIALLRH', name: 'Gini Index of Income Inequality' },
                    { symbol: 'WFRBST01134', name: 'Share of Total Net Worth: Top 1%' },
                    { symbol: 'WFRBSB50215', name: 'Share of Total Net Worth: Bottom 50%' }
                ]
            },
            'FRED > National Accounts': {
                'National Income & Product Accounts (13,000+ series)': [
                    { symbol: 'GDP', name: 'Gross Domestic Product' },
                    { symbol: 'GDPC1', name: 'Real GDP' },
                    { symbol: 'GDPPOT', name: 'Real Potential GDP' },
                    { symbol: 'GDPDEF', name: 'GDP Deflator' },
                    { symbol: 'NYGDPMKTPCDWLD', name: 'World GDP Per Capita' },
                    { symbol: 'PCECC96', name: 'Real Personal Consumption' },
                    { symbol: 'GPDIC1', name: 'Real Gross Private Investment' },
                    { symbol: 'GCEC1', name: 'Real Government Consumption' },
                    { symbol: 'NETEXC', name: 'Real Net Exports' },
                    { symbol: 'A191RL1Q225SBEA', name: 'Real GDP Growth Rate' }
                ],
                'Federal Government Debt': [
                    { symbol: 'GFDEBTN', name: 'Federal Debt: Total Public Debt' },
                    { symbol: 'GFDEGDQ188S', name: 'Federal Debt to GDP Ratio' },
                    { symbol: 'FYGFD', name: 'Gross Federal Debt' },
                    { symbol: 'FYGFDPUB', name: 'Federal Debt Held by Public' },
                    { symbol: 'FDHBFRBN', name: 'Debt Held by Federal Reserve' },
                    { symbol: 'FDHBFIN', name: 'Debt Held by Foreign & International' },
                    { symbol: 'FYONET', name: 'Federal Net Outlays' },
                    { symbol: 'FYFR', name: 'Federal Receipts' },
                    { symbol: 'FYFSD', name: 'Federal Surplus or Deficit' }
                ],
                'U.S. Trade & International Transactions (360+ series)': [
                    { symbol: 'BOPGSTB', name: 'Trade Balance: Goods and Services' },
                    { symbol: 'NETEXP', name: 'Net Exports of Goods and Services' },
                    { symbol: 'IMPGS', name: 'Imports of Goods and Services' },
                    { symbol: 'EXPGS', name: 'Exports of Goods and Services' },
                    { symbol: 'BOPGTB', name: 'Trade Balance: Goods' },
                    { symbol: 'IEAXGS', name: 'Exports: Goods' },
                    { symbol: 'IEAMGS', name: 'Imports: Goods' }
                ]
            },
            'FRED > Prices': {
                'Consumer Price Indexes (8,000+ series)': [
                    { symbol: 'CPIAUCSL', name: 'CPI: All Items' },
                    { symbol: 'CPILFESL', name: 'CPI: All Items Less Food & Energy' },
                    { symbol: 'CPIMEDSL', name: 'CPI: Medical Care' },
                    { symbol: 'CPIUFDSL', name: 'CPI: Food' },
                    { symbol: 'CPITRNSL', name: 'CPI: Transportation' },
                    { symbol: 'CUSR0000SAH1', name: 'CPI: Shelter' },
                    { symbol: 'CPIENGSL', name: 'CPI: Energy' },
                    { symbol: 'CPIAPPSL', name: 'CPI: Apparel' },
                    { symbol: 'CPIEDUSL', name: 'CPI: Education' },
                    { symbol: 'CPIAUCNS', name: 'CPI: All Items (NSA)' }
                ],
                'Producer Price Indexes (32,000+ series)': [
                    { symbol: 'PPIACO', name: 'PPI: All Commodities' },
                    { symbol: 'PPIFGS', name: 'PPI: Finished Goods' },
                    { symbol: 'PPIFCG', name: 'PPI: Finished Consumer Goods' },
                    { symbol: 'PPICRM', name: 'PPI: Crude Materials' },
                    { symbol: 'PPIIDC', name: 'PPI: Industrial Commodities' },
                    { symbol: 'PPIENG', name: 'PPI: Energy' },
                    { symbol: 'PPIFGS', name: 'PPI: Finished Goods' }
                ],
                'Commodities (3,000+ series)': [
                    { symbol: 'DCOILWTICO', name: 'WTI Crude Oil Price' },
                    { symbol: 'DCOILBRENTEU', name: 'Brent Crude Oil Price' },
                    { symbol: 'GOLDAMGBD228NLBM', name: 'Gold Price: London Fixing' },
                    { symbol: 'DHHNGSP', name: 'Natural Gas Price: Henry Hub' },
                    { symbol: 'PALLFNFINDEXM', name: 'Global Price Index of All Commodities' },
                    { symbol: 'DPROPANEMBTX', name: 'Propane Prices' },
                    { symbol: 'GASREGW', name: 'Regular Gasoline Price' }
                ]
            },
            'FRED > Production & Business Activity': {
                'Industrial Production & Capacity Utilization (10,000+ series)': [
                    { symbol: 'INDPRO', name: 'Industrial Production Index' },
                    { symbol: 'TCU', name: 'Total Capacity Utilization' },
                    { symbol: 'CAPUTLB50001SQ', name: 'Manufacturing Capacity Utilization' },
                    { symbol: 'IPG2211A2N', name: 'Electric Power Generation' },
                    { symbol: 'IPB50001N', name: 'Industrial Production: Manufacturing' },
                    { symbol: 'IPMANSICS', name: 'Manufacturing: ISM Report' }
                ],
                'Housing (15,000+ series)': [
                    { symbol: 'HOUST', name: 'Housing Starts: Total' },
                    { symbol: 'PERMIT', name: 'Building Permits' },
                    { symbol: 'COMPUTSA', name: 'Housing Completions' },
                    { symbol: 'CSUSHPISA', name: 'Case-Shiller National Home Price Index' },
                    { symbol: 'MSPUS', name: 'Median Sales Price of Houses Sold' },
                    { symbol: 'MORTGAGE30US', name: '30-Year Fixed Mortgage Rate' },
                    { symbol: 'MORTGAGE15US', name: '15-Year Fixed Mortgage Rate' },
                    { symbol: 'RHORUSQ156N', name: 'Homeownership Rate' },
                    { symbol: 'EXHOSLUSM495S', name: 'Existing Home Sales' },
                    { symbol: 'HSN1F', name: 'New One Family Houses Sold' }
                ],
                'Manufacturing (6,000+ series)': [
                    { symbol: 'DGORDER', name: 'Durable Goods Orders' },
                    { symbol: 'NEWORDER', name: 'Manufacturers\' New Orders' },
                    { symbol: 'AMTMNO', name: 'Manufacturers\' New Orders: Total' },
                    { symbol: 'BUSINV', name: 'Total Business Inventories' },
                    { symbol: 'ISRATIO', name: 'Total Business: Inventory to Sales Ratio' },
                    { symbol: 'MNFCTRSMSA', name: 'Manufacturers\' Shipments' }
                ],
                'Retail Trade (4,000+ series)': [
                    { symbol: 'RSXFS', name: 'Retail Sales Ex Food Services' },
                    { symbol: 'RETAILIMSA', name: 'Retail Sales: Total' },
                    { symbol: 'RSAFS', name: 'Retail & Food Services Sales' },
                    { symbol: 'MRTSSM44X72USS', name: 'Retail Trade Sales' },
                    { symbol: 'RSGASSN', name: 'Retail Sales: Gasoline Stations' }
                ],
                'Business Surveys': [
                    { symbol: 'UMCSENT', name: 'University of Michigan Consumer Sentiment' },
                    { symbol: 'MICH', name: 'Michigan Consumer Sentiment Index' },
                    { symbol: 'GACDISA066MSFRBNY', name: 'Empire State Manufacturing Index' },
                    { symbol: 'DPROSMFRBPHIL', name: 'Philadelphia Fed Business Outlook' },
                    { symbol: 'BSCICP02USM460S', name: 'Business Confidence' },
                    { symbol: 'NMFCI', name: 'Chicago Fed National Activity Index' }
                ]
            },
            'European Central Bank (ECB)': {
                'ECB Policy Rates': [
                    { symbol: 'ECBDFR', name: 'ECB Deposit Facility Rate' },
                    { symbol: 'ECBMPRFR', name: 'ECB Main Refinancing Operations Rate' },
                    { symbol: 'ECBMLFR', name: 'ECB Marginal Lending Facility Rate' },
                    { symbol: 'EUINTERESTRATE', name: 'Euro Area Interest Rate' }
                ],
                'Euro Area Indicators': [
                    { symbol: 'CLVMEURSCAB1GQEA19', name: 'Euro Area Real GDP' },
                    { symbol: 'EA19MABMM301GYSAM', name: 'Euro Area M3' },
                    { symbol: 'LRHUTTTTEZM156S', name: 'Euro Area Unemployment Rate' },
                    { symbol: 'FPCPITOTLZGEUR', name: 'Euro Area Inflation Rate' }
                ]
            },
            'New York Fed': {
                'NY Fed Operations': [
                    { symbol: 'RPONTSYD', name: 'Overnight Repo Rate' },
                    { symbol: 'RPONTTLD', name: 'Term Repo Rate' },
                    { symbol: 'TGCR', name: 'Tri-Party General Collateral Rate' },
                    { symbol: 'BGCR', name: 'Broad General Collateral Rate' },
                    { symbol: 'SOFR', name: 'SOFR (Secured Overnight Financing Rate)' }
                ],
                'Primary Dealer Positions': [
                    { symbol: 'PDPOSGS', name: 'Primary Dealer Positions: US Treasuries' },
                    { symbol: 'PDPOSMBS', name: 'Primary Dealer Positions: MBS' },
                    { symbol: 'PDPOSCORP', name: 'Primary Dealer Positions: Corporate Securities' }
                ]
            },
            'Office of Financial Research (OFR)': {
                'Financial Stress Indicators': [
                    { symbol: 'STLFSI4', name: 'St. Louis Fed Financial Stress Index (v4)' },
                    { symbol: 'STLFSI3', name: 'St. Louis Fed Financial Stress Index (v3)' },
                    { symbol: 'STLFSI2', name: 'St. Louis Fed Financial Stress Index (v2)' },
                    { symbol: 'STLFSI', name: 'St. Louis Fed Financial Stress Index (v1)' }
                ]
            }
        };

        let watchlist = [];
        let seriesData = {};
        let searchTimeout;
        let miniCharts = {};
        let updateInterval;
        let alertQueue = [];

        function initializeCategories() {
            const categoryList = document.getElementById('categoryList');
            
            Object.entries(economicData).forEach(([mainCategory, subcategories]) => {
                const mainDiv = document.createElement('div');
                mainDiv.className = 'main-category';
                
                const totalSeries = Object.values(subcategories).reduce((acc, arr) => acc + arr.length, 0);
                
                const mainHeader = document.createElement('div');
                mainHeader.className = 'main-category-header';
                mainHeader.innerHTML = `
                    <span>${mainCategory}</span>
                    <span class="category-count">${totalSeries}</span>
                `;
                mainHeader.onclick = () => toggleMainCategory(mainCategory);
                
                const subcatContainer = document.createElement('div');
                subcatContainer.className = 'subcategories';
                subcatContainer.id = `main-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                Object.entries(subcategories).forEach(([subcat, series]) => {
                    const subcatDiv = document.createElement('div');
                    subcatDiv.className = 'subcategory';
                    
                    const subcatHeader = document.createElement('div');
                    subcatHeader.className = 'subcategory-header';
                    subcatHeader.innerHTML = `
                        <span>${subcat}</span>
                        <span class="category-count">${series.length}</span>
                    `;
                    subcatHeader.onclick = () => toggleSubcategory(mainCategory, subcat);
                    
                    const seriesList = document.createElement('div');
                    seriesList.className = 'series-list';
                    seriesList.id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subcat.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    
                    series.forEach(item => {
                        const seriesItem = document.createElement('div');
                        seriesItem.className = 'series-item';
                        seriesItem.innerHTML = `
                            <span class="series-name">${item.name}</span>
                            <span class="series-symbol">${item.symbol}</span>
                            <button class="add-btn" id="btn-${item.symbol}" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                        `;
                        seriesList.appendChild(seriesItem);
                    });
                    
                    subcatDiv.appendChild(subcatHeader);
                    subcatDiv.appendChild(seriesList);
                    subcatContainer.appendChild(subcatDiv);
                });
                
                mainDiv.appendChild(mainHeader);
                mainDiv.appendChild(subcatContainer);
                categoryList.appendChild(mainDiv);
            });
        }

        function toggleMainCategory(category) {
            const id = `main-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            const header = element.previousElementSibling;
            
            document.querySelectorAll('.subcategories').forEach(sub => {
                if (sub.id !== id) {
                    sub.classList.remove('show');
                    sub.previousElementSibling.classList.remove('active');
                }
            });
            
            element.classList.toggle('show');
            header.classList.toggle('active');
        }

        function toggleSubcategory(mainCategory, subCategory) {
            const id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            
            const parent = element.closest('.subcategories');
            parent.querySelectorAll('.series-list').forEach(list => {
                if (list.id !== id) {
                    list.classList.remove('show');
                }
            });
            
            element.classList.toggle('show');
        }

        // Tab functionality
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update visualizations when switching tabs
            if (tabName === 'heatmap') {
                updateHeatmap();
            } else if (tabName === 'analytics') {
                updateAnalytics();
            } else if (tabName === 'visualizations') {
                updateVisualizations();
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(query), 300);
        });

        function performSearch(query) {
            const results = [];
            
            Object.entries(economicData).forEach(([mainCat, subcats]) => {
                Object.entries(subcats).forEach(([subcat, series]) => {
                    series.forEach(item => {
                        if (item.name.toLowerCase().includes(query) || 
                            item.symbol.toLowerCase().includes(query)) {
                            results.push({
                                ...item,
                                category: `${mainCat} > ${subcat}`
                            });
                        }
                    });
                });
            });
            
            displaySearchResults(results.slice(0, 20));
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No results found</div>';
            } else {
                container.innerHTML = results.map(item => `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-title">${item.name}</div>
                            <div class="search-result-symbol">${item.symbol} - ${item.category}</div>
                        </div>
                        <button class="add-btn" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                    </div>
                `).join('');
            }
            
            container.style.display = 'block';
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        async function addToWatchlist(symbol, name) {
            if (watchlist.find(item => item.symbol === symbol)) {
                showAlert('warning', 'Duplicate Series', 'This series is already in your watchlist');
                return;
            }
            
            const btn = document.getElementById(`btn-${symbol}`) || event.target;
            btn.textContent = 'Loading...';
            btn.disabled = true;
            
            try {
                const data = await fetchSeriesData(symbol);
                if (data && data.length > 0) {
                    seriesData[symbol] = data;
                    watchlist.push({ symbol, name });
                    updateWatchlistDisplay();
                    updateStats();
                    checkForAlerts(symbol, data);
                    
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('searchInput').value = '';
                    
                    showAlert('success', 'Series Added', `${name} added to watchlist`);
                }
            } catch (error) {
                console.error('Error loading series:', error);
                showAlert('error', 'Load Failed', `Unable to load data for ${symbol}`);
            } finally {
                btn.textContent = 'Add';
                btn.disabled = false;
            }
        }

        async function fetchSeriesData(symbol) {
            try {
                const url = `${API_BASE}/api/v1/universal/data?symbol=${symbol}&provider=fred`;
                console.log(`Fetching: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`Response for ${symbol}:`, data);
                
                let results = [];
                if (data && data.data && Array.isArray(data.data)) {
                    results = data.data;
                } else if (data && data.results && Array.isArray(data.results)) {
                    results = data.results;
                } else if (Array.isArray(data)) {
                    results = data;
                }
                
                if (results.length === 0) {
                    throw new Error('No data available');
                }
                
                const processedData = results.map(item => {
                    const date = item.date || item.Date || item.DATE;
                    const value = parseFloat(
                        item[symbol] || 
                        item.value || 
                        item.Value || 
                        item.VALUE ||
                        item.close ||
                        item.Close ||
                        item.price ||
                        item.Price ||
                        0
                    );
                    
                    return { date: new Date(date), value };
                }).filter(item => item.date && !isNaN(item.value))
                  .sort((a, b) => a.date - b.date);
                
                if (processedData.length === 0) {
                    throw new Error('No valid data points');
                }
                
                console.log(`Successfully fetched ${processedData.length} data points for ${symbol}`);
                return processedData;
                
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                throw error;
            }
        }

        function calculateChange(data, days) {
            if (!data || data.length < 2) return null;
            
            const latest = data[data.length - 1];
            const targetDate = new Date(latest.date);
            targetDate.setDate(targetDate.getDate() - days);
            
            let closest = null;
            let minDiff = Infinity;
            
            for (let i = data.length - 2; i >= 0; i--) {
                const diff = Math.abs(data[i].date - targetDate);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = data[i];
                }
                if (data[i].date < targetDate && minDiff < 7 * 24 * 60 * 60 * 1000) break;
            }
            
            if (!closest) return null;
            
            const change = latest.value - closest.value;
            const percentChange = closest.value !== 0 ? (change / closest.value) * 100 : 0;
            
            return { change, percentChange };
        }

        function calculateYTDChange(data) {
            if (!data || data.length < 2) return null;
            
            const latest = data[data.length - 1];
            const currentYear = latest.date.getFullYear();
            const startOfYear = new Date(currentYear, 0, 1);
            
            let yearStart = null;
            for (let i = 0; i < data.length; i++) {
                if (data[i].date >= startOfYear) {
                    yearStart = i > 0 ? data[i - 1] : data[i];
                    break;
                }
            }
            
            if (!yearStart) {
                yearStart = data[0];
            }
            
            const change = latest.value - yearStart.value;
            const percentChange = yearStart.value !== 0 ? (change / yearStart.value) * 100 : 0;
            
            return { change, percentChange };
        }

        function updateWatchlistDisplay() {
            const container = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Your watchlist is empty</h3>
                        <p>Search or browse categories to add series to your watchlist</p>
                    </div>
                `;
                document.getElementById('statsBar').style.display = 'none';
                return;
            }
            
            document.getElementById('statsBar').style.display = 'flex';
            
            let tableHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Series</th>
                            <th>Current Value</th>
                            <th>Trend</th>
                            <th>Daily %</th>
                            <th>Weekly %</th>
                            <th>Monthly %</th>
                            <th>Quarterly %</th>
                            <th>YTD %</th>
                            <th>1 Year %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                const ytd = calculateYTDChange(data);
                const yearly = calculateChange(data, 365);
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="series-name-cell">${item.name}</div>
                            <div class="series-symbol-cell">${item.symbol}</div>
                        </td>
                        <td class="value-cell">${formatValue(latest.value)}</td>
                        <td><canvas id="mini-${item.symbol}" class="mini-chart"></canvas></td>
                        <td class="value-cell ${getChangeClass(daily?.percentChange)}">${formatPercent(daily?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(weekly?.percentChange)}">${formatPercent(weekly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(monthly?.percentChange)}">${formatPercent(monthly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(quarterly?.percentChange)}">${formatPercent(quarterly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(ytd?.percentChange)}">${formatPercent(ytd?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(yearly?.percentChange)}">${formatPercent(yearly?.percentChange)}</td>
                        <td><button class="remove-btn" onclick="removeFromWatchlist('${item.symbol}')">Remove</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
            
            // Create mini charts
            setTimeout(() => {
                watchlist.forEach(item => {
                    createMiniChart(item.symbol);
                });
            }, 100);
        }

        function createMiniChart(symbol) {
            const canvas = document.getElementById(`mini-${symbol}`);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const data = seriesData[symbol];
            if (!data || data.length < 2) return;
            
            // Get last 30 days of data
            const days = 30;
            const endDate = new Date(data[data.length - 1].date);
            const startDate = new Date(endDate);
            startDate.setDate(startDate.getDate() - days);
            
            const recentData = data.filter(d => d.date >= startDate);
            
            if (miniCharts[symbol]) {
                miniCharts[symbol].destroy();
            }
            
            miniCharts[symbol] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: recentData.map(d => d.date),
                    datasets: [{
                        data: recentData.map(d => d.value),
                        borderColor: getSparklineColor(recentData),
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        function getSparklineColor(data) {
            if (data.length < 2) return '#888';
            const change = data[data.length - 1].value - data[0].value;
            return change >= 0 ? '#4caf50' : '#ff5252';
        }

        function updateStats() {
            let gainers = 0;
            let losers = 0;
            let totalDataPoints = 0;
            let totalDailyChange = 0;
            let validChanges = 0;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                totalDataPoints += data.length;
                const daily = calculateChange(data, 1);
                if (daily) {
                    if (daily.percentChange > 0) gainers++;
                    else if (daily.percentChange < 0) losers++;
                    totalDailyChange += daily.percentChange;
                    validChanges++;
                }
            });
            
            document.getElementById('totalSeries').textContent = watchlist.length;
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
            
            const avgChange = validChanges > 0 ? (totalDailyChange / validChanges).toFixed(2) + '%' : '0%';
            document.getElementById('avgChange').textContent = avgChange;
            document.getElementById('avgChange').className = getChangeClass(totalDailyChange / validChanges) + ' stat-value';
        }

        function updateHeatmap() {
            const container = document.getElementById('heatmapContent');
            
            if (watchlist.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Add series to your watchlist to see the heatmap visualization</p>';
                return;
            }
            
            const periods = ['Daily', 'Weekly', 'Monthly', 'Quarterly', 'YTD', '1 Year'];
            const gridHTML = ['<div class="heatmap-grid">'];
            
            // Header row
            gridHTML.push('<div class="heatmap-cell heatmap-header"></div>');
            periods.forEach(period => {
                gridHTML.push(`<div class="heatmap-cell heatmap-header">${period}</div>`);
            });
            
            // Data rows
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                gridHTML.push(`<div class="heatmap-cell heatmap-label" title="${item.name}">${item.symbol}</div>`);
                
                const changes = [
                    calculateChange(data, 1)?.percentChange,
                    calculateChange(data, 7)?.percentChange,
                    calculateChange(data, 30)?.percentChange,
                    calculateChange(data, 90)?.percentChange,
                    calculateYTDChange(data)?.percentChange,
                    calculateChange(data, 365)?.percentChange
                ];
                
                changes.forEach(change => {
                    const color = getHeatmapColor(change);
                    const value = change !== null && change !== undefined ? change.toFixed(2) + '%' : 'N/A';
                    gridHTML.push(`
                        <div class="heatmap-cell" style="background: ${color}; color: ${Math.abs(change) > 5 ? '#fff' : '#ccc'};">
                            ${value}
                        </div>
                    `);
                });
            });
            
            gridHTML.push('</div>');
            container.innerHTML = gridHTML.join('');
        }

        function getHeatmapColor(value) {
            if (value === null || value === undefined) return '#333';
            
            const max = 10; // Max percentage for color scale
            const normalized = Math.max(-1, Math.min(1, value / max));
            
            if (normalized > 0) {
                const intensity = normalized;
                return `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`;
            } else {
                const intensity = Math.abs(normalized);
                return `rgba(255, 82, 82, ${0.2 + intensity * 0.8})`;
            }
        }

        function updateAnalytics() {
            const container = document.getElementById('analyticsContent');
            const indicatorsContainer = document.getElementById('calculatedIndicators');
            
            if (watchlist.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px; grid-column: 1/-1;">Add series to your watchlist to see analytics</p>';
                return;
            }
            
            // Calculate various analytics
            const analytics = calculateAdvancedAnalytics();
            
            container.innerHTML = `
                <div class="analytics-card">
                    <div class="analytics-value ${getChangeClass(analytics.momentum)}">${analytics.momentum.toFixed(2)}%</div>
                    <div class="analytics-label">Market Momentum</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value">${analytics.volatility.toFixed(2)}%</div>
                    <div class="analytics-label">Average Volatility</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value">${analytics.correlation.toFixed(2)}</div>
                    <div class="analytics-label">Avg Correlation</div>
                </div>
                <div class="analytics-card">
                    <div class="analytics-value ${analytics.trendStrength > 0 ? 'positive' : 'negative'}">${Math.abs(analytics.trendStrength).toFixed(1)}%</div>
                    <div class="analytics-label">Trend Strength</div>
                </div>
            `;
            
            // Calculate special indicators if we have the right data
            const indicators = calculateSpecialIndicators();
            if (Object.keys(indicators).length > 0) {
                indicatorsContainer.innerHTML = Object.entries(indicators).map(([name, value]) => `
                    <div class="analytics-card">
                        <div class="analytics-value ${value.class || ''}">${value.display}</div>
                        <div class="analytics-label">${name}</div>
                    </div>
                `).join('');
            }
        }

        function calculateAdvancedAnalytics() {
            let totalMomentum = 0;
            let totalVolatility = 0;
            let validSeries = 0;
            let trendStrength = 0;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length < 30) return;
                
                // Calculate momentum (30-day rate of change)
                const momentum = calculateChange(data, 30);
                if (momentum) {
                    totalMomentum += momentum.percentChange;
                    validSeries++;
                }
                
                // Calculate volatility (standard deviation of daily returns)
                const returns = [];
                for (let i = 1; i < Math.min(30, data.length); i++) {
                    const dailyReturn = ((data[i].value - data[i-1].value) / data[i-1].value) * 100;
                    returns.push(dailyReturn);
                }
                
                if (returns.length > 0) {
                    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                    const stdDev = Math.sqrt(variance);
                    totalVolatility += stdDev;
                }
                
                // Calculate trend strength
                const weeklyChange = calculateChange(data, 7);
                const monthlyChange = calculateChange(data, 30);
                if (weeklyChange && monthlyChange) {
                    if (Math.sign(weeklyChange.percentChange) === Math.sign(monthlyChange.percentChange)) {
                        trendStrength += monthlyChange.percentChange;
                    }
                }
            });
            
            return {
                momentum: validSeries > 0 ? totalMomentum / validSeries : 0,
                volatility: validSeries > 0 ? totalVolatility / validSeries : 0,
                correlation: calculateAverageCorrelation(),
                trendStrength: validSeries > 0 ? trendStrength / validSeries : 0
            };
        }

        function calculateAverageCorrelation() {
            // Simplified correlation calculation
            const series = watchlist.filter(item => seriesData[item.symbol] && seriesData[item.symbol].length > 30);
            if (series.length < 2) return 0;
            
            let totalCorrelation = 0;
            let pairs = 0;
            
            for (let i = 0; i < series.length - 1; i++) {
                for (let j = i + 1; j < series.length; j++) {
                    const corr = calculateCorrelation(
                        seriesData[series[i].symbol],
                        seriesData[series[j].symbol]
                    );
                    if (corr !== null) {
                        totalCorrelation += Math.abs(corr);
                        pairs++;
                    }
                }
            }
            
            return pairs > 0 ? totalCorrelation / pairs : 0;
        }

        function calculateCorrelation(data1, data2) {
            // Simple correlation calculation for recent 30 days
            const days = 30;
            const recent1 = data1.slice(-days);
            const recent2 = data2.slice(-days);
            
            if (recent1.length < days || recent2.length < days) return null;
            
            const returns1 = [];
            const returns2 = [];
            
            for (let i = 1; i < days; i++) {
                returns1.push((recent1[i].value - recent1[i-1].value) / recent1[i-1].value);
                returns2.push((recent2[i].value - recent2[i-1].value) / recent2[i-1].value);
            }
            
            const mean1 = returns1.reduce((a, b) => a + b) / returns1.length;
            const mean2 = returns2.reduce((a, b) => a + b) / returns2.length;
            
            let numerator = 0;
            let sum1 = 0;
            let sum2 = 0;
            
            for (let i = 0; i < returns1.length; i++) {
                numerator += (returns1[i] - mean1) * (returns2[i] - mean2);
                sum1 += Math.pow(returns1[i] - mean1, 2);
                sum2 += Math.pow(returns2[i] - mean2, 2);
            }
            
            return numerator / Math.sqrt(sum1 * sum2);
        }

        function calculateSpecialIndicators() {
            const indicators = {};
            
            // Taylor Rule if we have Fed Funds and CPI
            const dff = seriesData['DFF'];
            const cpi = seriesData['CPIAUCSL'];
            if (dff && cpi && dff.length > 0 && cpi.length > 12) {
                const currentRate = dff[dff.length - 1].value;
                const cpiChange = calculateChange(cpi, 365);
                if (cpiChange) {
                    const inflation = cpiChange.percentChange;
                    const taylorRate = 2 + inflation + 0.5 * (inflation - 2) + 0.5 * 0; // Assuming 0 output gap
                    indicators['Taylor Rule Rate'] = {
                        display: taylorRate.toFixed(2) + '%',
                        class: currentRate < taylorRate ? 'positive' : 'negative'
                    };
                }
            }
            
            // Real Interest Rate
            const treasury10 = seriesData['DGS10'];
            if (treasury10 && cpi && treasury10.length > 0 && cpi.length > 12) {
                const nominalRate = treasury10[treasury10.length - 1].value;
                const inflationExp = calculateChange(cpi, 365);
                if (inflationExp) {
                    const realRate = nominalRate - inflationExp.percentChange;
                    indicators['Real 10Y Rate'] = {
                        display: realRate.toFixed(2) + '%',
                        class: getChangeClass(realRate)
                    };
                }
            }
            
            // Money Multiplier
            const m2 = seriesData['M2SL'];
            const base = seriesData['BOGMBASE'];
            if (m2 && base && m2.length > 0 && base.length > 0) {
                const multiplier = m2[m2.length - 1].value / base[base.length - 1].value;
                indicators['Money Multiplier'] = {
                    display: multiplier.toFixed(2) + 'x',
                    class: ''
                };
            }
            
            return indicators;
        }

        function updateVisualizations() {
            // Update yield curve if we have treasury data
            updateYieldCurve();
            
            // Update other visualizations
            updateCorrelationMatrix();
            updateMomentumChart();
            updateVolatilityChart();
        }

        function updateYieldCurve() {
            const canvas = document.getElementById('yieldCurveChart');
            const ctx = canvas.getContext('2d');
            
            const treasurySymbols = ['TB3MS', 'DGS1', 'DGS2', 'DGS5', 'DGS10', 'DGS30'];
            const maturities = [0.25, 1, 2, 5, 10, 30];
            const currentData = [];
            const historicalData = [];
            
            treasurySymbols.forEach((symbol, index) => {
                const data = seriesData[symbol];
                if (data && data.length > 0) {
                    currentData.push({
                        x: maturities[index],
                        y: data[data.length - 1].value
                    });
                    
                    // Get data from 1 year ago
                    const yearAgo = calculateChange(data, 365);
                    if (yearAgo) {
                        historicalData.push({
                            x: maturities[index],
                            y: data[data.length - 1].value - yearAgo.change
                        });
                    }
                }
            });
            
            if (currentData.length < 2) {
                ctx.fillStyle = '#666';
                ctx.fillText('Add treasury rates to see yield curve', canvas.width/2 - 100, canvas.height/2);
                return;
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: 'Current',
                            data: currentData,
                            borderColor: '#4a9eff',
                            backgroundColor: 'rgba(74, 158, 255, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: '1 Year Ago',
                            data: historicalData,
                            borderColor: '#888',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Maturity (Years)',
                                color: '#888'
                            },
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Yield (%)',
                                color: '#888'
                            },
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }

        function updateCorrelationMatrix() {
            const canvas = document.getElementById('correlationChart');
            const ctx = canvas.getContext('2d');
            
            // Implementation for correlation matrix visualization
            ctx.fillStyle = '#666';
            ctx.fillText('Correlation matrix coming soon', canvas.width/2 - 80, canvas.height/2);
        }

        function updateMomentumChart() {
            const canvas = document.getElementById('momentumChart');
            const ctx = canvas.getContext('2d');
            
            const momentumData = [];
            const labels = [];
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length < 30) return;
                
                const momentum = calculateChange(data, 30);
                if (momentum) {
                    labels.push(item.symbol);
                    momentumData.push(momentum.percentChange);
                }
            });
            
            if (momentumData.length === 0) {
                ctx.fillStyle = '#666';
                ctx.fillText('Add series to see momentum analysis', canvas.width/2 - 100, canvas.height/2);
                return;
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '30-Day Momentum (%)',
                        data: momentumData,
                        backgroundColor: momentumData.map(v => v >= 0 ? 'rgba(76, 175, 80, 0.6)' : 'rgba(255, 82, 82, 0.6)'),
                        borderColor: momentumData.map(v => v >= 0 ? '#4caf50' : '#ff5252'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Momentum (%)',
                                color: '#888'
                            },
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        x: {
                            ticks: { 
                                color: '#888',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateVolatilityChart() {
            const canvas = document.getElementById('volatilityChart');
            const ctx = canvas.getContext('2d');
            
            const volatilityData = [];
            const returnData = [];
            const labels = [];
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length < 30) return;
                
                // Calculate 30-day rolling volatility
                const returns = [];
                for (let i = data.length - 30; i < data.length; i++) {
                    if (i > 0) {
                        const dailyReturn = ((data[i].value - data[i-1].value) / data[i-1].value) * 100;
                        returns.push(dailyReturn);
                    }
                }
                
                if (returns.length > 0) {
                    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                    const stdDev = Math.sqrt(variance);
                    
                    labels.push(item.symbol);
                    volatilityData.push(stdDev);
                    returnData.push(mean * 252); // Annualized return
                }
            });
            
            if (volatilityData.length === 0) {
                ctx.fillStyle = '#666';
                ctx.fillText('Add series to see volatility analysis', canvas.width/2 - 100, canvas.height/2);
                return;
            }
            
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Risk-Return Profile',
                        data: volatilityData.map((v, i) => ({
                            x: v,
                            y: returnData[i],
                            label: labels[i]
                        })),
                        backgroundColor: 'rgba(74, 158, 255, 0.6)',
                        borderColor: '#4a9eff',
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw.label}: Vol ${context.raw.x.toFixed(2)}%, Return ${context.raw.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Volatility (Daily Std Dev %)',
                                color: '#888'
                            },
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Annualized Return (%)',
                                color: '#888'
                            },
                            ticks: { color: '#888' },
                            grid: { color: '#333' }
                        }
                    }
                }
            });
        }

        // Alert system
        function showAlert(type, title, message) {
            const alertsContainer = document.getElementById('alertsContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHTML = `
                <div id="${alertId}" class="alert ${type}">
                    <div class="alert-title">${title}</div>
                    <div class="alert-message">${message}</div>
                </div>
            `;
            
            alertsContainer.insertAdjacentHTML('beforeend', alertHTML);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => alert.remove(), 300);
                }
            }, 5000);
        }

        function checkForAlerts(symbol, data) {
            if (!data || data.length < 2) return;
            
            const daily = calculateChange(data, 1);
            const weekly = calculateChange(data, 7);
            
            // Check for significant moves
            if (daily && Math.abs(daily.percentChange) > 5) {
                showAlert(
                    daily.percentChange > 0 ? 'success' : 'warning',
                    `${symbol} Alert`,
                    `Significant daily move: ${daily.percentChange.toFixed(2)}%`
                );
            }
            
            // Check for trend changes
            if (daily && weekly && Math.sign(daily.percentChange) !== Math.sign(weekly.percentChange)) {
                showAlert(
                    'warning',
                    `${symbol} Trend Change`,
                    'Daily and weekly trends are diverging'
                );
            }
            
            // Special alerts for specific indicators
            if (symbol === 'T10Y2Y') {
                const latest = data[data.length - 1].value;
                if (latest < 0) {
                    showAlert(
                        'error',
                        'Yield Curve Inversion',
                        '10Y-2Y spread is negative - potential recession signal'
                    );
                }
            }
            
            if (symbol === 'VIXCLS') {
                const latest = data[data.length - 1].value;
                if (latest > 30) {
                    showAlert(
                        'warning',
                        'High Volatility',
                        `VIX at ${latest.toFixed(2)} - elevated market fear`
                    );
                }
            }
        }

        // Real-time updates
        function startRealTimeUpdates() {
            // Update every 5 minutes
            updateInterval = setInterval(() => {
                refreshAllData(true); // Silent refresh
            }, 5 * 60 * 1000);
        }

        function stopRealTimeUpdates() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
        }

        // Utility functions
        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (Math.abs(value) >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (Math.abs(value) >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (Math.abs(value) >= 1e3) return (value / 1e3).toFixed(2) + 'K';
            if (Math.abs(value) < 1) return value.toFixed(4);
            return value.toFixed(2);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function getChangeClass(value) {
            if (value === null || value === undefined) return 'neutral';
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(item => item.symbol !== symbol);
            delete seriesData[symbol];
            
            // Destroy mini chart
            if (miniCharts[symbol]) {
                miniCharts[symbol].destroy();
                delete miniCharts[symbol];
            }
            
            updateWatchlistDisplay();
            updateStats();
            
            // Update other tabs if visible
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.textContent.toLowerCase();
                if (tabName.includes('heatmap')) updateHeatmap();
                else if (tabName.includes('analytics')) updateAnalytics();
                else if (tabName.includes('visualizations')) updateVisualizations();
            }
        }

        async function refreshAllData(silent = false) {
            const btn = document.querySelector('.watchlist-btn');
            if (!silent && btn) {
                btn.textContent = '‚è≥ Refreshing...';
                btn.disabled = true;
            }
            
            try {
                const promises = watchlist.map(item => 
                    fetchSeriesData(item.symbol).catch(() => null)
                );
                const results = await Promise.all(promises);
                
                let updatedCount = 0;
                results.forEach((data, index) => {
                    if (data && data.length > 0) {
                        const oldData = seriesData[watchlist[index].symbol];
                        seriesData[watchlist[index].symbol] = data;
                        
                        // Check for alerts on updated data
                        if (oldData && oldData.length > 0) {
                            const oldLatest = oldData[oldData.length - 1].value;
                            const newLatest = data[data.length - 1].value;
                            if (oldLatest !== newLatest) {
                                updatedCount++;
                                checkForAlerts(watchlist[index].symbol, data);
                            }
                        }
                    }
                });
                
                updateWatchlistDisplay();
                updateStats();
                
                if (!silent && updatedCount > 0) {
                    showAlert('success', 'Data Refreshed', `Updated ${updatedCount} series`);
                }
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                if (!silent) {
                    showAlert('error', 'Refresh Failed', 'Some data could not be updated');
                }
            } finally {
                if (!silent && btn) {
                    btn.textContent = 'üîÑ Refresh All';
                    btn.disabled = false;
                }
            }
        }

        function downloadWatchlist() {
            if (watchlist.length === 0) {
                showAlert('warning', 'Empty Watchlist', 'Add series before downloading');
                return;
            }
            
            let csv = 'Series,Symbol,Current Value,Daily %,Weekly %,Monthly %,Quarterly %,YTD %,1 Year %,30-Day Volatility\n';
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                const ytd = calculateYTDChange(data);
                const yearly = calculateChange(data, 365);
                
                // Calculate volatility
                const returns = [];
                for (let i = Math.max(1, data.length - 30); i < data.length; i++) {
                    const dailyReturn = ((data[i].value - data[i-1].value) / data[i-1].value) * 100;
                    returns.push(dailyReturn);
                }
                const volatility = returns.length > 0 ? 
                    Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - returns.reduce((x, y) => x + y) / returns.length, 2), 0) / returns.length) : 0;
                
                csv += `"${item.name}",${item.symbol},${latest.value},`;
                csv += `${daily?.percentChange || ''},`;
                csv += `${weekly?.percentChange || ''},`;
                csv += `${monthly?.percentChange || ''},`;
                csv += `${quarterly?.percentChange || ''},`;
                csv += `${ytd?.percentChange || ''},`;
                csv += `${yearly?.percentChange || ''},`;
                csv += `${volatility.toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `monetary_policy_dashboard_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showAlert('success', 'Download Complete', 'Watchlist exported to CSV');
        }

        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your entire watchlist?')) {
                // Destroy all mini charts
                Object.values(miniCharts).forEach(chart => chart.destroy());
                miniCharts = {};
                
                watchlist = [];
                seriesData = {};
                updateWatchlistDisplay();
                updateStats();
                
                // Clear visualizations
                updateHeatmap();
                updateAnalytics();
                updateVisualizations();
                
                showAlert('success', 'Watchlist Cleared', 'All series have been removed');
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initializeCategories();
            startRealTimeUpdates();
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            stopRealTimeUpdates();
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshAllData();
                        break;
                    case 's':
                        e.preventDefault();
                        downloadWatchlist();
                        break;
                    case 'k':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                }
            }
        });