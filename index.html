<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Economic Data Watchlist</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .header p {
            font-size: 1.1em;
            color: #b3c5ff;
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3949ab;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-result-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #333;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            color: #4a9eff;
            font-weight: 500;
            font-size: 0.9em;
        }

        .search-result-symbol {
            color: #888;
            font-size: 0.8em;
        }

        .category-browser {
            margin-top: 20px;
        }

        .category-browser h3 {
            color: #4a9eff;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .main-category {
            margin-bottom: 15px;
        }

        .main-category-header {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .main-category-header:hover {
            background: #333;
        }

        .main-category-header.active {
            background: #3949ab;
        }

        .category-count {
            font-size: 0.85em;
            color: #888;
            background: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .subcategories {
            margin-left: 20px;
            margin-top: 10px;
            display: none;
        }

        .subcategories.show {
            display: block;
        }

        .subcategory {
            margin-bottom: 10px;
        }

        .subcategory-header {
            padding: 10px;
            background: #222;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .subcategory-header:hover {
            background: #333;
            transform: translateX(5px);
        }

        .series-list {
            margin-left: 20px;
            margin-top: 8px;
            display: none;
        }

        .series-list.show {
            display: block;
        }

        .series-item {
            padding: 8px 10px;
            background: #1a1a1a;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .series-item:hover {
            background: #2a2a2a;
            transform: translateX(3px);
        }

        .series-name {
            color: #4a9eff;
            flex: 1;
            margin-right: 10px;
        }

        .series-symbol {
            color: #666;
            font-family: monospace;
            font-size: 0.8em;
        }

        .add-btn {
            padding: 4px 12px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: #5cbf60;
        }

        .add-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .watchlist-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-size: 1.8em;
            color: #4a9eff;
        }

        .watchlist-controls {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .watchlist-btn:hover {
            background: #333;
            border-color: #555;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .watchlist-table th {
            background: #222;
            color: #4a9eff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .watchlist-table tr:hover {
            background: #222;
        }

        .series-name-cell {
            color: #4a9eff;
            font-weight: 500;
        }

        .series-symbol-cell {
            color: #666;
            font-size: 0.85em;
        }

        .value-cell {
            text-align: right;
            font-family: monospace;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #ff5252;
        }

        .neutral {
            color: #888;
        }

        .remove-btn {
            padding: 4px 8px;
            background: #d32f2f;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
        }

        .remove-btn:hover {
            background: #f44336;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .stats-bar {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .error-note {
            background: #ff9800;
            color: #000;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">Global Economic Data Explorer</h2>
            
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Search economic series..."
                    autocomplete="off"
                >
                <span class="search-icon">üîç</span>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="category-browser">
                <h3>Browse by Source</h3>
                <div id="categoryList"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Global Economic Data Watchlist</h1>
                <p>Track economic indicators from FRED, ECB, NY Fed, and OFR</p>
            </div>

            <div id="errorNote" class="error-note" style="display: none;">
                Note: Some series may not be available through the API. FRED series typically have the best coverage.
            </div>

            <div id="statsBar" class="stats-bar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="totalSeries">0</div>
                    <div class="stat-label">Series Tracked</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value positive" id="gainers">0</div>
                    <div class="stat-label">Gainers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value negative" id="losers">0</div>
                    <div class="stat-label">Losers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataPoints">0</div>
                    <div class="stat-label">Data Points</div>
                </div>
            </div>

            <div class="watchlist-container">
                <div class="watchlist-header">
                    <h2 class="watchlist-title">My Watchlist</h2>
                    <div class="watchlist-controls">
                        <button class="watchlist-btn" onclick="refreshAllData()">üîÑ Refresh All</button>
                        <button class="watchlist-btn" onclick="downloadWatchlist()">üì• Download CSV</button>
                        <button class="watchlist-btn" onclick="clearWatchlist()">üóëÔ∏è Clear All</button>
                    </div>
                </div>

                <div id="watchlistContent">
                    <div class="empty-state">
                        <h3>Your watchlist is empty</h3>
                        <p>Search or browse categories to add series to your watchlist</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://ped8gafyuz.us-east-1.awsapprunner.com';
        
        // Comprehensive economic data series
        const economicData = {
            'Federal Reserve (FRED) - Core Series': {
                'Interest Rates': [
                    { symbol: 'DFF', name: 'Federal Funds Rate' },
                    { symbol: 'EFFR', name: 'Effective Federal Funds Rate' },
                    { symbol: 'SOFR', name: 'Secured Overnight Financing Rate' },
                    { symbol: 'DGS1', name: '1-Year Treasury Rate' },
                    { symbol: 'DGS2', name: '2-Year Treasury Rate' },
                    { symbol: 'DGS5', name: '5-Year Treasury Rate' },
                    { symbol: 'DGS10', name: '10-Year Treasury Rate' },
                    { symbol: 'DGS30', name: '30-Year Treasury Rate' },
                    { symbol: 'TB3MS', name: '3-Month Treasury Bill' },
                    { symbol: 'MORTGAGE30US', name: '30-Year Mortgage Rate' },
                    { symbol: 'PRIME', name: 'Prime Rate' }
                ],
                'Monetary Aggregates': [
                    { symbol: 'M1SL', name: 'M1 Money Supply' },
                    { symbol: 'M2SL', name: 'M2 Money Supply' },
                    { symbol: 'BOGMBASE', name: 'Monetary Base' },
                    { symbol: 'TOTRESNS', name: 'Total Reserves' },
                    { symbol: 'WRESBAL', name: 'Reserve Balances with Fed Banks' },
                    { symbol: 'RESPPNTEPNWW', name: 'Eligible Collateral' },
                    { symbol: 'RESPPALGUONNWW', name: 'Treasury Securities Held' },
                    { symbol: 'SWP1690', name: 'Central Bank Liquidity Swaps' },
                    { symbol: 'OTHL1690', name: 'Loans: Credit Facilities' }
                ],
                'Economic Indicators': [
                    { symbol: 'GDP', name: 'Gross Domestic Product' },
                    { symbol: 'GDPC1', name: 'Real GDP' },
                    { symbol: 'UNRATE', name: 'Unemployment Rate' },
                    { symbol: 'PAYEMS', name: 'Nonfarm Payrolls' },
                    { symbol: 'CPIAUCSL', name: 'Consumer Price Index' },
                    { symbol: 'CPILFESL', name: 'Core CPI' },
                    { symbol: 'PPIACO', name: 'Producer Price Index' },
                    { symbol: 'INDPRO', name: 'Industrial Production Index' },
                    { symbol: 'HOUST', name: 'Housing Starts' },
                    { symbol: 'PERMIT', name: 'Building Permits' }
                ],
                'Financial Markets': [
                    { symbol: 'VIXCLS', name: 'VIX Volatility Index' },
                    { symbol: 'TEDRATE', name: 'TED Spread' },
                    { symbol: 'T10Y2Y', name: '10Y-2Y Treasury Spread' },
                    { symbol: 'T10Y3M', name: '10Y-3M Treasury Spread' },
                    { symbol: 'BAMLH0A0HYM2', name: 'High Yield Spread' },
                    { symbol: 'DEXUSEU', name: 'USD/EUR Exchange Rate' },
                    { symbol: 'DEXCHUS', name: 'CNY/USD Exchange Rate' },
                    { symbol: 'DEXJPUS', name: 'JPY/USD Exchange Rate' },
                    { symbol: 'DTWEXBGS', name: 'Trade Weighted Dollar Index' }
                ]
            },
            'European Central Bank (ECB) - Attempt': {
                'ECB Policy Rates': [
                    { symbol: 'ECBDFR', name: 'ECB Deposit Facility Rate' },
                    { symbol: 'ECBMPRFR', name: 'ECB Main Refinancing Rate' },
                    { symbol: 'ECBMLFR', name: 'ECB Marginal Lending Rate' },
                    { symbol: 'EUINTERESTRATE', name: 'Euro Area Interest Rate' }
                ],
                'Euro Area Indicators': [
                    { symbol: 'EURM1', name: 'Euro Area M1' },
                    { symbol: 'EURM2', name: 'Euro Area M2' },
                    { symbol: 'EURM3', name: 'Euro Area M3' },
                    { symbol: 'EURCPI', name: 'Euro Area CPI' },
                    { symbol: 'EURGDP', name: 'Euro Area GDP' },
                    { symbol: 'EURUNRATE', name: 'Euro Area Unemployment' }
                ]
            },
            'New York Fed - Core Series': {
                'NY Fed Markets': [
                    { symbol: 'RPONTSYD', name: 'Overnight Repo Rate' },
                    { symbol: 'SOFR', name: 'SOFR (also in FRED)' },
                    { symbol: 'OBFR', name: 'Overnight Bank Funding Rate' },
                    { symbol: 'TGCR', name: 'Tri-Party General Collateral Rate' },
                    { symbol: 'BGCR', name: 'Broad General Collateral Rate' }
                ],
                'Primary Dealer Statistics': [
                    { symbol: 'PDPOSGS', name: 'Primary Dealer Positions - Treasuries' },
                    { symbol: 'PDPOSMBS', name: 'Primary Dealer Positions - MBS' },
                    { symbol: 'PDPOSCORP', name: 'Primary Dealer Positions - Corporate' },
                    { symbol: 'PDDURAS', name: 'Primary Dealer Duration Risk' }
                ],
                'Inflation Expectations': [
                    { symbol: 'T5YIE', name: '5-Year Breakeven Inflation Rate' },
                    { symbol: 'T10YIE', name: '10-Year Breakeven Inflation Rate' },
                    { symbol: 'T5YIFR', name: '5-Year Forward Inflation Expectation' },
                    { symbol: 'DFEDTARU', name: 'Fed Funds Target Upper Bound' }
                ]
            },
            'Office of Financial Research (OFR)': {
                'Financial Stress': [
                    { symbol: 'STLFSI4', name: 'St. Louis Fed Financial Stress Index' },
                    { symbol: 'NFCI', name: 'Chicago Fed Financial Conditions' },
                    { symbol: 'ANFCI', name: 'Adjusted Financial Conditions' },
                    { symbol: 'KCFSI', name: 'Kansas City Financial Stress' }
                ],
                'Systemic Risk Indicators': [
                    { symbol: 'SRISK', name: 'Systemic Risk Measure' },
                    { symbol: 'LEVERAGE', name: 'Financial Sector Leverage' },
                    { symbol: 'MKTCAP', name: 'Market Capitalization Ratio' }
                ]
            },
            'Additional FRED Series': {
                'Employment Details': [
                    { symbol: 'CIVPART', name: 'Labor Force Participation Rate' },
                    { symbol: 'EMRATIO', name: 'Employment-Population Ratio' },
                    { symbol: 'UNEMPLOY', name: 'Unemployed Persons' },
                    { symbol: 'ICSA', name: 'Initial Jobless Claims' },
                    { symbol: 'CCSA', name: 'Continued Claims' },
                    { symbol: 'U6RATE', name: 'U-6 Unemployment Rate' },
                    { symbol: 'MEHOINUSA672N', name: 'Median Household Income' }
                ],
                'Housing Market': [
                    { symbol: 'CSUSHPISA', name: 'Case-Shiller Home Price Index' },
                    { symbol: 'MSPUS', name: 'Median Sales Price of Houses' },
                    { symbol: 'EXHOSLUSM495S', name: 'Existing Home Sales' },
                    { symbol: 'HSN1F', name: 'New Home Sales' },
                    { symbol: 'MSACSR', name: 'Monthly Supply of Houses' }
                ],
                'Manufacturing': [
                    { symbol: 'DGORDER', name: 'Durable Goods Orders' },
                    { symbol: 'NEWORDER', name: 'Manufacturers New Orders' },
                    { symbol: 'UMCSENT', name: 'Consumer Sentiment' },
                    { symbol: 'GACDISA066MSFRBNY', name: 'Empire State Index' },
                    { symbol: 'MANEMP', name: 'Manufacturing Employment' }
                ],
                'Credit & Banking': [
                    { symbol: 'TOTBKCR', name: 'Bank Credit, All Banks' },
                    { symbol: 'BUSLOANS', name: 'Business Loans' },
                    { symbol: 'REALLN', name: 'Real Estate Loans' },
                    { symbol: 'CONSUMER', name: 'Consumer Loans' },
                    { symbol: 'DPSACBW027SBOG', name: 'Deposits, All Banks' },
                    { symbol: 'H8B1001NCBCMG', name: 'Commercial Paper Outstanding' }
                ],
                'Commodities': [
                    { symbol: 'DCOILWTICO', name: 'WTI Crude Oil Price' },
                    { symbol: 'GOLDAMGBD228NLBM', name: 'Gold Price London Fix' },
                    { symbol: 'DHHNGSP', name: 'Natural Gas Price' },
                    { symbol: 'DCOILBRENTEU', name: 'Brent Crude Oil Price' },
                    { symbol: 'PALLFNFINDEXM', name: 'Global Commodity Index' }
                ],
                'Government Finance': [
                    { symbol: 'GFDEBTN', name: 'Federal Debt Total' },
                    { symbol: 'GFDEGDQ188S', name: 'Federal Debt to GDP Ratio' },
                    { symbol: 'FYFSD', name: 'Federal Surplus or Deficit' },
                    { symbol: 'FYFR', name: 'Federal Receipts' },
                    { symbol: 'FYONET', name: 'Federal Net Outlays' }
                ]
            }
        };

        let watchlist = [];
        let seriesData = {};
        let searchTimeout;
        let failedSeries = new Set();

        function initializeCategories() {
            const categoryList = document.getElementById('categoryList');
            
            Object.entries(economicData).forEach(([mainCategory, subcategories]) => {
                const mainDiv = document.createElement('div');
                mainDiv.className = 'main-category';
                
                const totalSeries = Object.values(subcategories).reduce((acc, arr) => acc + arr.length, 0);
                
                const mainHeader = document.createElement('div');
                mainHeader.className = 'main-category-header';
                mainHeader.innerHTML = `
                    <span>${mainCategory}</span>
                    <span class="category-count">${totalSeries}</span>
                `;
                mainHeader.onclick = () => toggleMainCategory(mainCategory);
                
                const subcatContainer = document.createElement('div');
                subcatContainer.className = 'subcategories';
                subcatContainer.id = `main-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                Object.entries(subcategories).forEach(([subcat, series]) => {
                    const subcatDiv = document.createElement('div');
                    subcatDiv.className = 'subcategory';
                    
                    const subcatHeader = document.createElement('div');
                    subcatHeader.className = 'subcategory-header';
                    subcatHeader.innerHTML = `
                        <span>${subcat}</span>
                        <span class="category-count">${series.length}</span>
                    `;
                    subcatHeader.onclick = () => toggleSubcategory(mainCategory, subcat);
                    
                    const seriesList = document.createElement('div');
                    seriesList.className = 'series-list';
                    seriesList.id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subcat.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    
                    series.forEach(item => {
                        const seriesItem = document.createElement('div');
                        seriesItem.className = 'series-item';
                        seriesItem.innerHTML = `
                            <span class="series-name">${item.name}</span>
                            <span class="series-symbol">${item.symbol}</span>
                            <button class="add-btn" id="btn-${item.symbol}" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                        `;
                        seriesList.appendChild(seriesItem);
                    });
                    
                    subcatDiv.appendChild(subcatHeader);
                    subcatDiv.appendChild(seriesList);
                    subcatContainer.appendChild(subcatDiv);
                });
                
                mainDiv.appendChild(mainHeader);
                mainDiv.appendChild(subcatContainer);
                categoryList.appendChild(mainDiv);
            });
        }

        function toggleMainCategory(category) {
            const id = `main-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            const header = element.previousElementSibling;
            
            document.querySelectorAll('.subcategories').forEach(sub => {
                if (sub.id !== id) {
                    sub.classList.remove('show');
                    sub.previousElementSibling.classList.remove('active');
                }
            });
            
            element.classList.toggle('show');
            header.classList.toggle('active');
        }

        function toggleSubcategory(mainCategory, subCategory) {
            const id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            
            const parent = element.closest('.subcategories');
            parent.querySelectorAll('.series-list').forEach(list => {
                if (list.id !== id) {
                    list.classList.remove('show');
                }
            });
            
            element.classList.toggle('show');
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(query), 300);
        });

        function performSearch(query) {
            const results = [];
            
            Object.entries(economicData).forEach(([mainCat, subcats]) => {
                Object.entries(subcats).forEach(([subcat, series]) => {
                    series.forEach(item => {
                        if (item.name.toLowerCase().includes(query) || 
                            item.symbol.toLowerCase().includes(query)) {
                            results.push({
                                ...item,
                                category: `${mainCat} > ${subcat}`
                            });
                        }
                    });
                });
            });
            
            displaySearchResults(results.slice(0, 20));
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No results found</div>';
            } else {
                container.innerHTML = results.map(item => `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-title">${item.name}</div>
                            <div class="search-result-symbol">${item.symbol} - ${item.category}</div>
                        </div>
                        <button class="add-btn" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                    </div>
                `).join('');
            }
            
            container.style.display = 'block';
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        async function addToWatchlist(symbol, name) {
            if (watchlist.find(item => item.symbol === symbol)) {
                alert('This series is already in your watchlist');
                return;
            }
            
            const btn = document.getElementById(`btn-${symbol}`) || event.target;
            btn.textContent = 'Loading...';
            btn.disabled = true;
            
            try {
                const data = await fetchSeriesData(symbol);
                if (data && data.length > 0) {
                    seriesData[symbol] = data;
                    watchlist.push({ symbol, name });
                    updateWatchlistDisplay();
                    updateStats();
                    
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('searchInput').value = '';
                    
                    if (failedSeries.size > 0) {
                        document.getElementById('errorNote').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading series:', error);
                failedSeries.add(symbol);
                alert(`Unable to load data for ${symbol}. This series may not be available through the API.`);
            } finally {
                btn.textContent = 'Add';
                btn.disabled = false;
            }
        }

        async function fetchSeriesData(symbol) {
            try {
                // Try the standard FRED endpoint first
                const url = `${API_BASE}/api/v1/universal/data?symbol=${symbol}&provider=fred`;
                console.log(`Fetching: ${url}`);
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`Response for ${symbol}:`, data);
                
                let results = [];
                if (data && data.data && Array.isArray(data.data)) {
                    results = data.data;
                } else if (data && data.results && Array.isArray(data.results)) {
                    results = data.results;
                } else if (Array.isArray(data)) {
                    results = data;
                }
                
                if (results.length === 0) {
                    throw new Error('No data available');
                }
                
                const processedData = results.map(item => {
                    // Try different possible field names
                    const date = item.date || item.Date || item.DATE;
                    const value = parseFloat(
                        item[symbol] || 
                        item.value || 
                        item.Value || 
                        item.VALUE ||
                        item.close ||
                        item.Close ||
                        item.price ||
                        item.Price ||
                        0
                    );
                    
                    return { date: new Date(date), value };
                }).filter(item => item.date && !isNaN(item.value))
                  .sort((a, b) => a.date - b.date);
                
                if (processedData.length === 0) {
                    throw new Error('No valid data points');
                }
                
                console.log(`Successfully fetched ${processedData.length} data points for ${symbol}`);
                return processedData;
                
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                throw error;
            }
        }

        function calculateChange(data, days) {
            if (!data || data.length < 2) return null;
            
            const latest = data[data.length - 1];
            const targetDate = new Date(latest.date);
            targetDate.setDate(targetDate.getDate() - days);
            
            let closest = null;
            let minDiff = Infinity;
            
            for (let i = data.length - 2; i >= 0; i--) {
                const diff = Math.abs(data[i].date - targetDate);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = data[i];
                }
                if (data[i].date < targetDate && minDiff < 7 * 24 * 60 * 60 * 1000) break;
            }
            
            if (!closest) return null;
            
            const change = latest.value - closest.value;
            const percentChange = closest.value !== 0 ? (change / closest.value) * 100 : 0;
            
            return { change, percentChange };
        }

        function calculateYTDChange(data) {
            if (!data || data.length < 2) return null;
            
            const latest = data[data.length - 1];
            const currentYear = latest.date.getFullYear();
            const startOfYear = new Date(currentYear, 0, 1);
            
            let yearStart = null;
            for (let i = 0; i < data.length; i++) {
                if (data[i].date >= startOfYear) {
                    yearStart = i > 0 ? data[i - 1] : data[i];
                    break;
                }
            }
            
            if (!yearStart) {
                yearStart = data[0];
            }
            
            const change = latest.value - yearStart.value;
            const percentChange = yearStart.value !== 0 ? (change / yearStart.value) * 100 : 0;
            
            return { change, percentChange };
        }

        function updateWatchlistDisplay() {
            const container = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Your watchlist is empty</h3>
                        <p>Search or browse categories to add series to your watchlist</p>
                    </div>
                `;
                document.getElementById('statsBar').style.display = 'none';
                return;
            }
            
            document.getElementById('statsBar').style.display = 'flex';
            
            let tableHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Series</th>
                            <th>Current Value</th>
                            <th>Daily %</th>
                            <th>Weekly %</th>
                            <th>Monthly %</th>
                            <th>Quarterly %</th>
                            <th>YTD %</th>
                            <th>1 Year %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                const ytd = calculateYTDChange(data);
                const yearly = calculateChange(data, 365);
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="series-name-cell">${item.name}</div>
                            <div class="series-symbol-cell">${item.symbol}</div>
                        </td>
                        <td class="value-cell">${formatValue(latest.value)}</td>
                        <td class="value-cell ${getChangeClass(daily?.percentChange)}">${formatPercent(daily?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(weekly?.percentChange)}">${formatPercent(weekly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(monthly?.percentChange)}">${formatPercent(monthly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(quarterly?.percentChange)}">${formatPercent(quarterly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(ytd?.percentChange)}">${formatPercent(ytd?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(yearly?.percentChange)}">${formatPercent(yearly?.percentChange)}</td>
                        <td><button class="remove-btn" onclick="removeFromWatchlist('${item.symbol}')">Remove</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function updateStats() {
            let gainers = 0;
            let losers = 0;
            let totalDataPoints = 0;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                totalDataPoints += data.length;
                const daily = calculateChange(data, 1);
                if (daily) {
                    if (daily.percentChange > 0) gainers++;
                    else if (daily.percentChange < 0) losers++;
                }
            });
            
            document.getElementById('totalSeries').textContent = watchlist.length;
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
            document.getElementById('dataPoints').textContent = formatNumber(totalDataPoints);
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (Math.abs(value) >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (Math.abs(value) >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (Math.abs(value) >= 1e3) return (value / 1e3).toFixed(2) + 'K';
            if (Math.abs(value) < 1) return value.toFixed(4);
            return value.toFixed(2);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function getChangeClass(value) {
            if (value === null || value === undefined) return 'neutral';
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(item => item.symbol !== symbol);
            delete seriesData[symbol];
            updateWatchlistDisplay();
            updateStats();
        }

        async function refreshAllData() {
            const btn = event.target;
            btn.textContent = '‚è≥ Refreshing...';
            btn.disabled = true;
            
            try {
                const promises = watchlist.map(item => 
                    fetchSeriesData(item.symbol).catch(() => null)
                );
                const results = await Promise.all(promises);
                
                results.forEach((data, index) => {
                    if (data && data.length > 0) {
                        seriesData[watchlist[index].symbol] = data;
                    }
                });
                
                updateWatchlistDisplay();
                updateStats();
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error refreshing some data. Please try again.');
            } finally {
                btn.textContent = 'üîÑ Refresh All';
                btn.disabled = false;
            }
        }

        function downloadWatchlist() {
            if (watchlist.length === 0) {
                alert('Your watchlist is empty');
                return;
            }
            
            let csv = 'Series,Symbol,Current Value,Daily %,Weekly %,Monthly %,Quarterly %,YTD %,1 Year %\n';
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                const ytd = calculateYTDChange(data);
                const yearly = calculateChange(data, 365);
                
                csv += `"${item.name}",${item.symbol},${latest.value},`;
                csv += `${daily?.percentChange || ''},`;
                csv += `${weekly?.percentChange || ''},`;
                csv += `${monthly?.percentChange || ''},`;
                csv += `${quarterly?.percentChange || ''},`;
                csv += `${ytd?.percentChange || ''},`;
                csv += `${yearly?.percentChange || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `watchlist_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your entire watchlist?')) {
                watchlist = [];
                seriesData = {};
                updateWatchlistDisplay();
                updateStats();
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initializeCategories();
        });
    </script>
</body>
</html>