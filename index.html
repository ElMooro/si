<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenBB Economic Intelligence Platform</title>
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>
  <input type="text" id="searchInput" placeholder="Search FRED or ECB indicator..." onkeyup="debounceSearch(this.value)" />
  <div id="searchResults"></div>
  <div id="chartContainer"></div>

  <script>
    const API_BASE_URL = 'https://ped8gafyuz.us-east-1.awsapprunner.com/api/v1';
    const charts = {};
    let chartCounter = 0;
    let searchTimeout;

    const sampleIndicators = [
      // FRED
      { symbol: 'DGS10', name: '10-Year Treasury', provider: 'fred' },
      { symbol: 'GDP', name: 'Gross Domestic Product', provider: 'fred' },
      // ECB
      { symbol: 'ICP.MU.A.C000000.4.ANR', name: 'HICP All-items Euro Area', provider: 'ecb' },
      { symbol: 'MNA.M.U2.S1.W0.S1.S1.B.B1GQ.Y.Z', name: 'Euro Area Nominal GDP', provider: 'ecb' },
    ];

    function debounceSearch(query) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => performSearch(query), 300);
    }

    function performSearch(query) {
      const results = sampleIndicators.filter(i =>
        i.symbol.toLowerCase().includes(query.toLowerCase()) ||
        i.name.toLowerCase().includes(query.toLowerCase())
      );

      const resultContainer = document.getElementById('searchResults');
      resultContainer.innerHTML = results
        .map(
          r => `<div onclick="loadChart('${r.symbol}', '${r.provider}')">${r.symbol} - ${r.name} (${r.provider.toUpperCase()})</div>`
        )
        .join('');
    }

    async function loadChart(symbol, provider) {
      const chartId = `chart_${chartCounter++}`;
      const container = document.getElementById('chartContainer');
      const div = document.createElement('div');
      div.id = chartId;
      container.appendChild(div);

      const endpoint = `${API_BASE_URL}/economy/${provider}_series?symbol=${symbol}&provider=${provider}`;
      try {
        const response = await fetch(endpoint);
        if (!response.ok) throw new Error(`API Error: ${response.status}`);
        const data = await response.json();

        const points = (data.results || [])
          .filter(p => p.value && !isNaN(parseFloat(p.value)))
          .map(p => ({ x: p.date, y: parseFloat(p.value) }));

        Plotly.newPlot(chartId, [
          {
            x: points.map(p => p.x),
            y: points.map(p => p.y),
            mode: 'lines',
            name: symbol,
          },
        ], {
          title: `${symbol} - ${provider.toUpperCase()}`,
          xaxis: { title: 'Date' },
          yaxis: { title: 'Value' },
        });
      } catch (err) {
        document.getElementById(chartId).innerHTML = `<p style='color:red'>${err.message}</p>`;
      }
    }
  </script>
</body>
</html>
