<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRED Data Watchlist Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            line-height: 1.6;
        }

        .container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 400px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            overflow-y: auto;
            padding: 20px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #1a237e 0%, #3949ab 100%);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .header p {
            font-size: 1.1em;
            color: #b3c5ff;
        }

        .search-container {
            position: relative;
            margin-bottom: 25px;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3949ab;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 0 0 8px 8px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .search-result-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: #333;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-title {
            color: #4a9eff;
            font-weight: 500;
            font-size: 0.9em;
        }

        .search-result-symbol {
            color: #888;
            font-size: 0.8em;
        }

        .category-browser {
            margin-top: 20px;
        }

        .category-browser h3 {
            color: #4a9eff;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .main-category {
            margin-bottom: 15px;
        }

        .main-category-header {
            padding: 12px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .main-category-header:hover {
            background: #333;
        }

        .main-category-header.active {
            background: #3949ab;
        }

        .category-count {
            font-size: 0.85em;
            color: #888;
            background: #1a1a1a;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .subcategories {
            margin-left: 20px;
            margin-top: 10px;
            display: none;
        }

        .subcategories.show {
            display: block;
        }

        .subcategory {
            margin-bottom: 10px;
        }

        .subcategory-header {
            padding: 10px;
            background: #222;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            transition: all 0.2s ease;
        }

        .subcategory-header:hover {
            background: #333;
            transform: translateX(5px);
        }

        .series-list {
            margin-left: 20px;
            margin-top: 8px;
            display: none;
        }

        .series-list.show {
            display: block;
        }

        .series-item {
            padding: 8px 10px;
            background: #1a1a1a;
            margin-bottom: 4px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .series-item:hover {
            background: #2a2a2a;
            transform: translateX(3px);
        }

        .series-name {
            color: #4a9eff;
            flex: 1;
            margin-right: 10px;
        }

        .series-symbol {
            color: #666;
            font-family: monospace;
            font-size: 0.8em;
        }

        .add-btn {
            padding: 4px 12px;
            background: #4caf50;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
            white-space: nowrap;
        }

        .add-btn:hover {
            background: #5cbf60;
        }

        .add-btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .watchlist-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .watchlist-title {
            font-size: 1.8em;
            color: #4a9eff;
        }

        .watchlist-controls {
            display: flex;
            gap: 10px;
        }

        .watchlist-btn {
            padding: 8px 16px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #e0e0e0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .watchlist-btn:hover {
            background: #333;
            border-color: #555;
        }

        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95em;
        }

        .watchlist-table th,
        .watchlist-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .watchlist-table th {
            background: #222;
            color: #4a9eff;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .watchlist-table tr:hover {
            background: #222;
        }

        .series-name-cell {
            color: #4a9eff;
            font-weight: 500;
        }

        .series-symbol-cell {
            color: #666;
            font-size: 0.85em;
        }

        .value-cell {
            text-align: right;
            font-family: monospace;
        }

        .positive {
            color: #4caf50;
        }

        .negative {
            color: #ff5252;
        }

        .neutral {
            color: #888;
        }

        .remove-btn {
            padding: 4px 8px;
            background: #d32f2f;
            border: none;
            border-radius: 4px;
            color: white;
            font-size: 0.8em;
            cursor: pointer;
        }

        .remove-btn:hover {
            background: #f44336;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
        }

        .stats-bar {
            background: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            flex: 1;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4a9eff;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        @media (max-width: 1024px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
                border-right: none;
                border-bottom: 1px solid #333;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <h2 style="color: #4a9eff; margin-bottom: 20px;">FRED Data Explorer</h2>
            
            <div class="search-container">
                <input 
                    type="text" 
                    id="searchInput" 
                    class="search-input" 
                    placeholder="Search FRED series..."
                    autocomplete="off"
                >
                <span class="search-icon">🔍</span>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="category-browser">
                <h3>Browse by Category</h3>
                <div id="categoryList"></div>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>FRED Economic Data Watchlist</h1>
                <p>Build your custom watchlist with real-time economic indicators</p>
            </div>

            <div id="statsBar" class="stats-bar" style="display: none;">
                <div class="stat-item">
                    <div class="stat-value" id="totalSeries">0</div>
                    <div class="stat-label">Series Tracked</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value positive" id="gainers">0</div>
                    <div class="stat-label">Gainers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value negative" id="losers">0</div>
                    <div class="stat-label">Losers</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="dataPoints">0</div>
                    <div class="stat-label">Data Points</div>
                </div>
            </div>

            <div class="watchlist-container">
                <div class="watchlist-header">
                    <h2 class="watchlist-title">My Watchlist</h2>
                    <div class="watchlist-controls">
                        <button class="watchlist-btn" onclick="refreshAllData()">🔄 Refresh All</button>
                        <button class="watchlist-btn" onclick="downloadWatchlist()">📥 Download CSV</button>
                        <button class="watchlist-btn" onclick="clearWatchlist()">🗑️ Clear All</button>
                    </div>
                </div>

                <div id="watchlistContent">
                    <div class="empty-state">
                        <h3>Your watchlist is empty</h3>
                        <p>Search or browse categories to add series to your watchlist</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const API_BASE = 'https://ped8gafyuz.us-east-1.awsapprunner.com';
        
        // Comprehensive FRED categories and series
        const fredData = {
            'Money, Banking, & Finance': {
                'Interest Rates': [
                    { symbol: 'DFF', name: 'Federal Funds Rate' },
                    { symbol: 'DGS10', name: '10-Year Treasury Rate' },
                    { symbol: 'DGS2', name: '2-Year Treasury Rate' },
                    { symbol: 'DGS5', name: '5-Year Treasury Rate' },
                    { symbol: 'DGS30', name: '30-Year Treasury Rate' },
                    { symbol: 'TB3MS', name: '3-Month Treasury Bill' },
                    { symbol: 'TB6MS', name: '6-Month Treasury Bill' },
                    { symbol: 'DFEDTARU', name: 'Fed Funds Target Range - Upper' },
                    { symbol: 'DFEDTARL', name: 'Fed Funds Target Range - Lower' },
                    { symbol: 'SOFR', name: 'Secured Overnight Financing Rate' },
                    { symbol: 'EFFR', name: 'Effective Federal Funds Rate' },
                    { symbol: 'OBFR', name: 'Overnight Bank Funding Rate' },
                    { symbol: 'AMERIBOR', name: 'American Interbank Offered Rate' },
                    { symbol: 'PRIME', name: 'Prime Rate' }
                ],
                'Exchange Rates': [
                    { symbol: 'DEXUSEU', name: 'USD/EUR Exchange Rate' },
                    { symbol: 'DEXCHUS', name: 'CNY/USD Exchange Rate' },
                    { symbol: 'DEXJPUS', name: 'JPY/USD Exchange Rate' },
                    { symbol: 'DEXUSUK', name: 'USD/GBP Exchange Rate' },
                    { symbol: 'DEXCAUS', name: 'CAD/USD Exchange Rate' },
                    { symbol: 'DEXMXUS', name: 'MXN/USD Exchange Rate' },
                    { symbol: 'DEXKOUS', name: 'KRW/USD Exchange Rate' },
                    { symbol: 'DEXINUS', name: 'INR/USD Exchange Rate' },
                    { symbol: 'DTWEXBGS', name: 'Trade Weighted Dollar Index' }
                ],
                'Monetary Data': [
                    { symbol: 'M1SL', name: 'M1 Money Supply' },
                    { symbol: 'M2SL', name: 'M2 Money Supply' },
                    { symbol: 'M1V', name: 'M1 Money Velocity' },
                    { symbol: 'M2V', name: 'M2 Money Velocity' },
                    { symbol: 'BOGMBASE', name: 'Monetary Base' },
                    { symbol: 'TOTRESNS', name: 'Total Reserves' },
                    { symbol: 'REQRESNS', name: 'Required Reserves' },
                    { symbol: 'EXCSRESNS', name: 'Excess Reserves' },
                    { symbol: 'WRESBAL', name: 'Reserve Balances' },
                    { symbol: 'CURRSL', name: 'Currency in Circulation' },
                    { symbol: 'RESPPNTEPNWW', name: 'Eligible Collateral' },
                    { symbol: 'RESPPALGUONNWW', name: 'Treasury Securities' },
                    { symbol: 'SWP1690', name: 'Liquidity Swaps' },
                    { symbol: 'OTHL1690', name: 'Credit Facilities' }
                ],
                'Financial Indicators': [
                    { symbol: 'VIXCLS', name: 'VIX Volatility Index' },
                    { symbol: 'TEDRATE', name: 'TED Spread' },
                    { symbol: 'T10Y2Y', name: '10Y-2Y Treasury Spread' },
                    { symbol: 'T10Y3M', name: '10Y-3M Treasury Spread' },
                    { symbol: 'BAMLH0A0HYM2', name: 'High Yield Spread' },
                    { symbol: 'BAMLC0A0CM', name: 'Investment Grade Spread' },
                    { symbol: 'DCOILWTICO', name: 'WTI Crude Oil Price' },
                    { symbol: 'GOLDAMGBD228NLBM', name: 'Gold Price' },
                    { symbol: 'STLFSI4', name: 'Financial Stress Index' }
                ],
                'Banking': [
                    { symbol: 'DPSACBW027SBOG', name: 'Deposits at Commercial Banks' },
                    { symbol: 'TOTBKCR', name: 'Bank Credit' },
                    { symbol: 'BUSLOANS', name: 'Business Loans' },
                    { symbol: 'REALLN', name: 'Real Estate Loans' },
                    { symbol: 'CONSUMER', name: 'Consumer Loans' },
                    { symbol: 'REVOLSL', name: 'Revolving Consumer Credit' },
                    { symbol: 'USGSEC', name: 'Treasury & Agency Securities' }
                ],
                'Business Lending': [
                    { symbol: 'BCLOANSNSA', name: 'Commercial & Industrial Loans' },
                    { symbol: 'TOTCI', name: 'Total C&I Loans' },
                    { symbol: 'ECOMPCTNSA', name: 'Commercial Paper Outstanding' },
                    { symbol: 'NCBCELQ027S', name: 'Corporate Equities' }
                ],
                'Foreign Exchange Intervention': [
                    { symbol: 'BOGZ1FL313011303Q', name: 'Foreign Exchange Reserves' }
                ]
            },
            'Population, Employment, & Labor Markets': {
                'Current Population Survey': [
                    { symbol: 'UNRATE', name: 'Unemployment Rate' },
                    { symbol: 'CIVPART', name: 'Labor Force Participation Rate' },
                    { symbol: 'EMRATIO', name: 'Employment-Population Ratio' },
                    { symbol: 'UNEMPLOY', name: 'Unemployed Persons' },
                    { symbol: 'CLF16OV', name: 'Civilian Labor Force' },
                    { symbol: 'CE16OV', name: 'Civilian Employment' },
                    { symbol: 'UEMPLT5', name: 'Unemployed Less Than 5 Weeks' },
                    { symbol: 'UEMP5TO14', name: 'Unemployed 5-14 Weeks' },
                    { symbol: 'UEMP15T26', name: 'Unemployed 15-26 Weeks' },
                    { symbol: 'UEMP27OV', name: 'Unemployed 27+ Weeks' }
                ],
                'Current Employment Statistics': [
                    { symbol: 'PAYEMS', name: 'Nonfarm Payrolls' },
                    { symbol: 'USCONS', name: 'Construction Employment' },
                    { symbol: 'MANEMP', name: 'Manufacturing Employment' },
                    { symbol: 'USTRADE', name: 'Retail Trade Employment' },
                    { symbol: 'USFIRE', name: 'Financial Activities Employment' },
                    { symbol: 'USPBS', name: 'Professional & Business Services' },
                    { symbol: 'USEHS', name: 'Education & Health Services' },
                    { symbol: 'USLAH', name: 'Leisure & Hospitality' },
                    { symbol: 'USGOVT', name: 'Government Employment' },
                    { symbol: 'CES0500000003', name: 'Average Hourly Earnings' },
                    { symbol: 'AWHAETP', name: 'Average Weekly Hours' }
                ],
                'ADP Employment': [
                    { symbol: 'ADPWNUSNERSA', name: 'ADP National Employment' },
                    { symbol: 'ADPEMNUSNERNSA', name: 'ADP Total Nonfarm Private' }
                ],
                'Education': [
                    { symbol: 'LREM25TTUSM156S', name: 'Employment Rate: Bachelor\'s Degree' },
                    { symbol: 'LREM25FEUSM156S', name: 'Female Employment Rate: Bachelor\'s' }
                ],
                'Income Distribution': [
                    { symbol: 'MEHOINUSA672N', name: 'Median Household Income' },
                    { symbol: 'DSPIC96', name: 'Disposable Personal Income' },
                    { symbol: 'A229RC0', name: 'Personal Income' },
                    { symbol: 'GINIALLRH', name: 'Gini Index' },
                    { symbol: 'WFRBST01134', name: 'Share of Total Net Worth: Top 1%' }
                ],
                'Job Openings and Labor Turnover': [
                    { symbol: 'JTSJOL', name: 'Job Openings' },
                    { symbol: 'JTSQUR', name: 'Quits Rate' },
                    { symbol: 'JTSHIR', name: 'Hires Rate' },
                    { symbol: 'JTSSEP', name: 'Separations Rate' },
                    { symbol: 'JTSLDR', name: 'Layoffs & Discharges Rate' }
                ],
                'Labor Market Conditions': [
                    { symbol: 'NFCIINDEXM', name: 'Labor Market Conditions Index' },
                    { symbol: 'UMCSENT', name: 'Consumer Sentiment' }
                ],
                'Population': [
                    { symbol: 'POPTHM', name: 'Population' },
                    { symbol: 'POP', name: 'Total Population' },
                    { symbol: 'LFWA64TTUSM647S', name: 'Working Age Population' }
                ],
                'Productivity & Costs': [
                    { symbol: 'OPHNFB', name: 'Nonfarm Business Output Per Hour' },
                    { symbol: 'ULCNFB', name: 'Unit Labor Costs' },
                    { symbol: 'COMPRNFB', name: 'Real Compensation Per Hour' }
                ],
                'Weekly Initial Claims': [
                    { symbol: 'ICSA', name: 'Initial Claims' },
                    { symbol: 'IC4WSA', name: '4-Week Moving Average' },
                    { symbol: 'CCSA', name: 'Continued Claims' }
                ]
            },
            'National Accounts': {
                'National Income & Product Accounts': [
                    { symbol: 'GDP', name: 'Gross Domestic Product' },
                    { symbol: 'GDPC1', name: 'Real GDP' },
                    { symbol: 'GDPPOT', name: 'Real Potential GDP' },
                    { symbol: 'NYGDPMKTPCDWLD', name: 'World GDP Per Capita' },
                    { symbol: 'GDPDEF', name: 'GDP Deflator' },
                    { symbol: 'PCECC96', name: 'Real Personal Consumption' },
                    { symbol: 'GPDIC1', name: 'Real Gross Private Investment' },
                    { symbol: 'GCEC1', name: 'Real Government Consumption' },
                    { symbol: 'NETEXC', name: 'Real Net Exports' }
                ],
                'Federal Government Debt': [
                    { symbol: 'GFDEBTN', name: 'Federal Debt: Total Public Debt' },
                    { symbol: 'GFDEGDQ188S', name: 'Federal Debt to GDP Ratio' },
                    { symbol: 'FYGFD', name: 'Gross Federal Debt' },
                    { symbol: 'FYGFDPUB', name: 'Federal Debt Held by Public' },
                    { symbol: 'FDHBFRBN', name: 'Debt Held by Federal Reserve' }
                ],
                'Flow of Funds': [
                    { symbol: 'BOGZ1FL893064105Q', name: 'Corporate Debt Securities' },
                    { symbol: 'HHMSDODNS', name: 'Household Debt Service Ratio' },
                    { symbol: 'TDSP', name: 'Household Debt Service Payments' }
                ],
                'U.S. Trade & International Transactions': [
                    { symbol: 'BOPGSTB', name: 'Trade Balance' },
                    { symbol: 'NETEXP', name: 'Net Exports' },
                    { symbol: 'IMPGS', name: 'Imports' },
                    { symbol: 'EXPGS', name: 'Exports' },
                    { symbol: 'BOPGTB', name: 'Trade Balance: Goods' }
                ]
            },
            'Production & Business Activity': {
                'Business Cycle Expansions & Contractions': [
                    { symbol: 'USREC', name: 'Recession Indicator' },
                    { symbol: 'USRECM', name: 'Monthly Recession Indicator' }
                ],
                'Business Surveys': [
                    { symbol: 'UMCSENT', name: 'Consumer Sentiment' },
                    { symbol: 'MICH', name: 'Michigan Consumer Sentiment' },
                    { symbol: 'GACDISA066MSFRBNY', name: 'Empire State Index' },
                    { symbol: 'DPROSMFRBPHIL', name: 'Philly Fed Index' },
                    { symbol: 'BSCICP02USM460S', name: 'Business Confidence' }
                ],
                'Construction': [
                    { symbol: 'HOUST', name: 'Housing Starts' },
                    { symbol: 'PERMIT', name: 'Building Permits' },
                    { symbol: 'COMPUTSA', name: 'Housing Completions' },
                    { symbol: 'TTLCONS', name: 'Total Construction Spending' },
                    { symbol: 'PRRESCONS', name: 'Private Residential Construction' }
                ],
                'Housing': [
                    { symbol: 'CSUSHPISA', name: 'Case-Shiller Home Price Index' },
                    { symbol: 'MSPUS', name: 'Median Sales Price of Houses' },
                    { symbol: 'MORTGAGE30US', name: '30-Year Mortgage Rate' },
                    { symbol: 'MORTGAGE15US', name: '15-Year Mortgage Rate' },
                    { symbol: 'RHORUSQ156N', name: 'Homeownership Rate' },
                    { symbol: 'HSNGPERMITNS', name: 'New Housing Permits' },
                    { symbol: 'EXHOSLUSM495S', name: 'Existing Home Sales' },
                    { symbol: 'HSN1F', name: 'New Home Sales' }
                ],
                'Industrial Production & Capacity Utilization': [
                    { symbol: 'INDPRO', name: 'Industrial Production Index' },
                    { symbol: 'TCU', name: 'Capacity Utilization' },
                    { symbol: 'CAPUTLB50001SQ', name: 'Manufacturing Capacity Utilization' },
                    { symbol: 'IPG2211A2N', name: 'Electric Power Generation' }
                ],
                'Manufacturing': [
                    { symbol: 'DGORDER', name: 'Durable Goods Orders' },
                    { symbol: 'NEWORDER', name: 'Manufacturers\' New Orders' },
                    { symbol: 'AMTMNO', name: 'Value of Manufacturers\' Orders' },
                    { symbol: 'BUSINV', name: 'Business Inventories' },
                    { symbol: 'ISRATIO', name: 'Inventory to Sales Ratio' }
                ],
                'Retail Trade': [
                    { symbol: 'RSXFS', name: 'Retail Sales Ex Food Services' },
                    { symbol: 'RETAILIMSA', name: 'Retail Sales' },
                    { symbol: 'RSAFS', name: 'Retail & Food Services Sales' },
                    { symbol: 'MRTSSM44X72USS', name: 'Retail Trade Sales' }
                ],
                'Transportation': [
                    { symbol: 'RAILFRTINTERMODAL', name: 'Rail Freight Intermodal' },
                    { symbol: 'HTRUCKSSAAR', name: 'Heavy Truck Sales' },
                    { symbol: 'TOTALSA', name: 'Vehicle Sales' },
                    { symbol: 'ALTSALES', name: 'Light Vehicle Sales' }
                ],
                'Wholesale Trade': [
                    { symbol: 'WHLSLRIMSA', name: 'Wholesale Trade: Sales' },
                    { symbol: 'WHLSLRIRSA', name: 'Wholesale Trade: Inventories' }
                ]
            },
            'Prices': {
                'Consumer Price Indexes': [
                    { symbol: 'CPIAUCSL', name: 'Consumer Price Index' },
                    { symbol: 'CPILFESL', name: 'Core CPI' },
                    { symbol: 'CPIMEDSL', name: 'Medical Care CPI' },
                    { symbol: 'CPIUFDSL', name: 'Food CPI' },
                    { symbol: 'CPITRNSL', name: 'Transportation CPI' },
                    { symbol: 'CUSR0000SAH1', name: 'Shelter CPI' },
                    { symbol: 'CPIENGSL', name: 'Energy CPI' },
                    { symbol: 'CPIAPPSL', name: 'Apparel CPI' },
                    { symbol: 'CPIEDUSL', name: 'Education CPI' }
                ],
                'Producer Price Indexes': [
                    { symbol: 'PPIACO', name: 'Producer Price Index' },
                    { symbol: 'PPIFGS', name: 'PPI: Finished Goods' },
                    { symbol: 'PPIFCG', name: 'PPI: Finished Consumer Goods' },
                    { symbol: 'PPICRM', name: 'PPI: Crude Materials' },
                    { symbol: 'PPIIDC', name: 'PPI: Industrial Commodities' }
                ],
                'House Price Indexes': [
                    { symbol: 'CSUSHPINSA', name: 'Case-Shiller National Index' },
                    { symbol: 'USSTHPI', name: 'All-Transactions House Price Index' },
                    { symbol: 'SPCS20RSA', name: 'S&P/CS 20-City Index' },
                    { symbol: 'ASPNHSUS', name: 'Average Sales Price' }
                ],
                'Commodities': [
                    { symbol: 'DCOILWTICO', name: 'WTI Crude Oil' },
                    { symbol: 'GOLDAMGBD228NLBM', name: 'Gold Price' },
                    { symbol: 'DHHNGSP', name: 'Natural Gas Price' },
                    { symbol: 'DCOILBRENTEU', name: 'Brent Crude Oil' },
                    { symbol: 'PALLFNFINDEXM', name: 'Global Commodity Index' }
                ],
                'Import/Export Price Indexes': [
                    { symbol: 'IR', name: 'Import Price Index' },
                    { symbol: 'IQ', name: 'Export Price Index' }
                ],
                'Employment Cost Index': [
                    { symbol: 'ECIALLCIV', name: 'Employment Cost Index' },
                    { symbol: 'ECIWAG', name: 'ECI: Wages & Salaries' },
                    { symbol: 'ECIBNF', name: 'ECI: Benefits' }
                ]
            }
        };

        let watchlist = [];
        let seriesData = {};
        let searchTimeout;

        function initializeCategories() {
            const categoryList = document.getElementById('categoryList');
            
            Object.entries(fredData).forEach(([mainCategory, subcategories]) => {
                const mainDiv = document.createElement('div');
                mainDiv.className = 'main-category';
                
                const totalSeries = Object.values(subcategories).reduce((acc, arr) => acc + arr.length, 0);
                
                const mainHeader = document.createElement('div');
                mainHeader.className = 'main-category-header';
                mainHeader.innerHTML = `
                    <span>${mainCategory}</span>
                    <span class="category-count">${totalSeries}</span>
                `;
                mainHeader.onclick = () => toggleMainCategory(mainCategory);
                
                const subcatContainer = document.createElement('div');
                subcatContainer.className = 'subcategories';
                subcatContainer.id = `main-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
                
                Object.entries(subcategories).forEach(([subcat, series]) => {
                    const subcatDiv = document.createElement('div');
                    subcatDiv.className = 'subcategory';
                    
                    const subcatHeader = document.createElement('div');
                    subcatHeader.className = 'subcategory-header';
                    subcatHeader.innerHTML = `
                        <span>${subcat}</span>
                        <span class="category-count">${series.length}</span>
                    `;
                    subcatHeader.onclick = () => toggleSubcategory(mainCategory, subcat);
                    
                    const seriesList = document.createElement('div');
                    seriesList.className = 'series-list';
                    seriesList.id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subcat.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    
                    series.forEach(item => {
                        const seriesItem = document.createElement('div');
                        seriesItem.className = 'series-item';
                        seriesItem.innerHTML = `
                            <span class="series-name">${item.name}</span>
                            <span class="series-symbol">${item.symbol}</span>
                            <button class="add-btn" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                        `;
                        seriesList.appendChild(seriesItem);
                    });
                    
                    subcatDiv.appendChild(subcatHeader);
                    subcatDiv.appendChild(seriesList);
                    subcatContainer.appendChild(subcatDiv);
                });
                
                mainDiv.appendChild(mainHeader);
                mainDiv.appendChild(subcatContainer);
                categoryList.appendChild(mainDiv);
            });
        }

        function toggleMainCategory(category) {
            const id = `main-${category.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            const header = element.previousElementSibling;
            
            // Close all other main categories
            document.querySelectorAll('.subcategories').forEach(sub => {
                if (sub.id !== id) {
                    sub.classList.remove('show');
                    sub.previousElementSibling.classList.remove('active');
                }
            });
            
            element.classList.toggle('show');
            header.classList.toggle('active');
        }

        function toggleSubcategory(mainCategory, subCategory) {
            const id = `series-${mainCategory.replace(/[^a-zA-Z0-9]/g, '-')}-${subCategory.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const element = document.getElementById(id);
            
            // Close all other series lists in this category
            const parent = element.closest('.subcategories');
            parent.querySelectorAll('.series-list').forEach(list => {
                if (list.id !== id) {
                    list.classList.remove('show');
                }
            });
            
            element.classList.toggle('show');
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => performSearch(query), 300);
        });

        function performSearch(query) {
            const results = [];
            
            Object.entries(fredData).forEach(([mainCat, subcats]) => {
                Object.entries(subcats).forEach(([subcat, series]) => {
                    series.forEach(item => {
                        if (item.name.toLowerCase().includes(query) || 
                            item.symbol.toLowerCase().includes(query)) {
                            results.push({
                                ...item,
                                category: `${mainCat} > ${subcat}`
                            });
                        }
                    });
                });
            });
            
            displaySearchResults(results.slice(0, 20)); // Limit to 20 results
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No results found</div>';
            } else {
                container.innerHTML = results.map(item => `
                    <div class="search-result-item">
                        <div class="search-result-info">
                            <div class="search-result-title">${item.name}</div>
                            <div class="search-result-symbol">${item.symbol} - ${item.category}</div>
                        </div>
                        <button class="add-btn" onclick="addToWatchlist('${item.symbol}', '${item.name.replace(/'/g, "\\'")}')">Add</button>
                    </div>
                `).join('');
            }
            
            container.style.display = 'block';
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                document.getElementById('searchResults').style.display = 'none';
            }
        });

        async function addToWatchlist(symbol, name) {
            if (watchlist.find(item => item.symbol === symbol)) {
                alert('This series is already in your watchlist');
                return;
            }
            
            // Show loading state
            const btn = event.target;
            btn.textContent = 'Loading...';
            btn.disabled = true;
            
            try {
                const data = await fetchSeriesData(symbol);
                if (data && data.length > 0) {
                    seriesData[symbol] = data;
                    watchlist.push({ symbol, name });
                    updateWatchlistDisplay();
                    updateStats();
                    
                    // Hide search results if adding from search
                    document.getElementById('searchResults').style.display = 'none';
                    document.getElementById('searchInput').value = '';
                }
            } catch (error) {
                console.error('Error loading series:', error);
                alert('Error loading series data. Please try again.');
            } finally {
                btn.textContent = 'Add';
                btn.disabled = false;
            }
        }

        async function fetchSeriesData(symbol) {
            try {
                const url = `${API_BASE}/api/v1/universal/data?symbol=${symbol}&provider=fred`;
                const response = await fetch(url);
                
                if (!response.ok) throw new Error('Failed to fetch data');
                
                const data = await response.json();
                
                let results = [];
                if (data && data.data) results = data.data;
                else if (data && data.results) results = data.results;
                else if (Array.isArray(data)) results = data;
                
                if (results.length === 0) throw new Error('No data available');
                
                const processedData = results.map(item => ({
                    date: new Date(item.date || item.Date),
                    value: parseFloat(item[symbol] || item.value || item.Value || 0)
                })).filter(item => !isNaN(item.value))
                  .sort((a, b) => a.date - b.date);
                
                return processedData;
                
            } catch (error) {
                console.error(`Error fetching ${symbol}:`, error);
                throw error;
            }
        }

        function calculateChange(data, days) {
            if (!data || data.length < 2) return null;
            
            const latest = data[data.length - 1];
            const targetDate = new Date(latest.date);
            targetDate.setDate(targetDate.getDate() - days);
            
            // Find the closest data point to target date
            let closest = null;
            let minDiff = Infinity;
            
            for (let i = data.length - 2; i >= 0; i--) {
                const diff = Math.abs(data[i].date - targetDate);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = data[i];
                }
                // Stop if we've gone too far back
                if (data[i].date < targetDate && minDiff < 7 * 24 * 60 * 60 * 1000) break;
            }
            
            if (!closest) return null;
            
            const change = latest.value - closest.value;
            const percentChange = closest.value !== 0 ? (change / closest.value) * 100 : 0;
            
            return { change, percentChange };
        }

        function updateWatchlistDisplay() {
            const container = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Your watchlist is empty</h3>
                        <p>Search or browse categories to add series to your watchlist</p>
                    </div>
                `;
                document.getElementById('statsBar').style.display = 'none';
                return;
            }
            
            document.getElementById('statsBar').style.display = 'flex';
            
            let tableHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Series</th>
                            <th>Current Value</th>
                            <th>Daily Change</th>
                            <th>Daily %</th>
                            <th>Weekly Change</th>
                            <th>Weekly %</th>
                            <th>Monthly Change</th>
                            <th>Monthly %</th>
                            <th>Quarterly Change</th>
                            <th>Quarterly %</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                
                tableHTML += `
                    <tr>
                        <td>
                            <div class="series-name-cell">${item.name}</div>
                            <div class="series-symbol-cell">${item.symbol}</div>
                        </td>
                        <td class="value-cell">${formatValue(latest.value)}</td>
                        <td class="value-cell ${getChangeClass(daily?.change)}">${formatChange(daily?.change)}</td>
                        <td class="value-cell ${getChangeClass(daily?.percentChange)}">${formatPercent(daily?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(weekly?.change)}">${formatChange(weekly?.change)}</td>
                        <td class="value-cell ${getChangeClass(weekly?.percentChange)}">${formatPercent(weekly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(monthly?.change)}">${formatChange(monthly?.change)}</td>
                        <td class="value-cell ${getChangeClass(monthly?.percentChange)}">${formatPercent(monthly?.percentChange)}</td>
                        <td class="value-cell ${getChangeClass(quarterly?.change)}">${formatChange(quarterly?.change)}</td>
                        <td class="value-cell ${getChangeClass(quarterly?.percentChange)}">${formatPercent(quarterly?.percentChange)}</td>
                        <td><button class="remove-btn" onclick="removeFromWatchlist('${item.symbol}')">Remove</button></td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        }

        function updateStats() {
            let gainers = 0;
            let losers = 0;
            let totalDataPoints = 0;
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                totalDataPoints += data.length;
                const daily = calculateChange(data, 1);
                if (daily) {
                    if (daily.change > 0) gainers++;
                    else if (daily.change < 0) losers++;
                }
            });
            
            document.getElementById('totalSeries').textContent = watchlist.length;
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
            document.getElementById('dataPoints').textContent = formatNumber(totalDataPoints);
        }

        function formatValue(value) {
            if (value === null || value === undefined) return '-';
            if (Math.abs(value) >= 1000000) return (value / 1000000).toFixed(2) + 'M';
            if (Math.abs(value) >= 1000) return (value / 1000).toFixed(2) + 'K';
            return value.toFixed(2);
        }

        function formatChange(value) {
            if (value === null || value === undefined) return '-';
            const sign = value > 0 ? '+' : '';
            return sign + formatValue(value);
        }

        function formatPercent(value) {
            if (value === null || value === undefined) return '-';
            const sign = value > 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function getChangeClass(value) {
            if (value === null || value === undefined) return 'neutral';
            return value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(item => item.symbol !== symbol);
            delete seriesData[symbol];
            updateWatchlistDisplay();
            updateStats();
        }

        async function refreshAllData() {
            const btn = event.target;
            btn.textContent = '⏳ Refreshing...';
            btn.disabled = true;
            
            try {
                const promises = watchlist.map(item => fetchSeriesData(item.symbol));
                const results = await Promise.all(promises);
                
                results.forEach((data, index) => {
                    if (data && data.length > 0) {
                        seriesData[watchlist[index].symbol] = data;
                    }
                });
                
                updateWatchlistDisplay();
                updateStats();
            } catch (error) {
                console.error('Error refreshing data:', error);
                alert('Error refreshing some data. Please try again.');
            } finally {
                btn.textContent = '🔄 Refresh All';
                btn.disabled = false;
            }
        }

        function downloadWatchlist() {
            if (watchlist.length === 0) {
                alert('Your watchlist is empty');
                return;
            }
            
            let csv = 'Series,Symbol,Current Value,Daily Change,Daily %,Weekly Change,Weekly %,Monthly Change,Monthly %,Quarterly Change,Quarterly %\n';
            
            watchlist.forEach(item => {
                const data = seriesData[item.symbol];
                if (!data || data.length === 0) return;
                
                const latest = data[data.length - 1];
                const daily = calculateChange(data, 1);
                const weekly = calculateChange(data, 7);
                const monthly = calculateChange(data, 30);
                const quarterly = calculateChange(data, 90);
                
                csv += `"${item.name}",${item.symbol},${latest.value},`;
                csv += `${daily?.change || ''},${daily?.percentChange || ''},`;
                csv += `${weekly?.change || ''},${weekly?.percentChange || ''},`;
                csv += `${monthly?.change || ''},${monthly?.percentChange || ''},`;
                csv += `${quarterly?.change || ''},${quarterly?.percentChange || ''}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `fred_watchlist_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your entire watchlist?')) {
                watchlist = [];
                seriesData = {};
                updateWatchlistDisplay();
                updateStats();
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            initializeCategories();
        });
    </script>
</body>
</html>