<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Market Intelligence Dashboard v3.0 - REAL DATA ONLY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .real-data-badge {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 10px rgba(255, 107, 107, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .api-status {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-dot.disconnected {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .crisis-banner {
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            animation: slideDown 0.5s ease-out;
            display: none;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .crisis-banner.active {
            display: block;
        }

        .crisis-banner.severe {
            background: linear-gradient(90deg, #d32f2f, #c62828);
            color: white;
        }

        .crisis-banner.high {
            background: linear-gradient(90deg, #f57c00, #e65100);
            color: white;
        }

        .crisis-banner.moderate {
            background: linear-gradient(90deg, #fbc02d, #f9a825);
            color: #333;
        }

        .crisis-banner.low {
            background: linear-gradient(90deg, #388e3c, #2e7d32);
            color: white;
        }

        .tabs-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #a0a0a0;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .metric-label {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 5px;
        }

        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .indicator-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .indicator-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .indicator-value {
            font-size: 24px;
            font-weight: bold;
            color: #fff;
        }

        .indicator-value.positive {
            color: #4ade80;
        }

        .indicator-value.negative {
            color: #ff4444;
        }

        .indicator-value.neutral {
            color: #fbbf24;
        }

        .auction-results-container {
            display: grid;
            gap: 20px;
        }

        .security-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        .security-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .security-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .security-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .metric-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 8px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            height: 400px;
            position: relative;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .summary-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .summary-content {
            line-height: 1.8;
            color: #e0e0e0;
        }

        .risk-meter {
            width: 100%;
            max-width: 300px;
            margin: 20px auto;
        }

        .meter-container {
            position: relative;
            height: 30px;
            background: linear-gradient(90deg, #4ade80 0%, #fbbf24 50%, #ff4444 100%);
            border-radius: 15px;
            overflow: hidden;
        }

        .meter-pointer {
            position: absolute;
            top: -10px;
            width: 4px;
            height: 50px;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transition: left 1s ease;
        }

        .meter-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #888;
        }

        .alert-box {
            background: rgba(255, 68, 68, 0.1);
            border-left: 4px solid #ff4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .alert-box.warning {
            background: rgba(251, 191, 36, 0.1);
            border-left-color: #fbbf24;
        }

        .alert-box.info {
            background: rgba(102, 126, 234, 0.1);
            border-left-color: #667eea;
        }

        .alert-box.success {
            background: rgba(74, 222, 128, 0.1);
            border-left-color: #4ade80;
        }

        .historical-chart {
            height: 350px;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .timestamp {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            color: #888;
            backdrop-filter: blur(10px);
        }
    </style>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="title-section">
                <h1>🏛️ Treasury Market Intelligence v3.0</h1>
                <div class="real-data-badge">REAL DATA ONLY</div>
            </div>
            <div class="api-status">
                <div class="status-indicator">
                    <div class="status-dot connected" id="apiStatus"></div>
                    <span id="apiStatusText">Connected</span>
                </div>
                <div class="status-indicator">
                    <span id="lastUpdate">Updating...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="crisis-banner" id="crisisBanner"></div>

    <div class="tabs-container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('auction-results')">📊 Auction Results</div>
            <div class="tab" onclick="switchTab('all-indicators')">📈 All 31 Indicators</div>
            <div class="tab" onclick="switchTab('crisis-detection')">🚨 Crisis Analysis</div>
            <div class="tab" onclick="switchTab('liquidity')">💧 Liquidity Analysis</div>
            <div class="tab" onclick="switchTab('historical')">📉 Historical Charts</div>
            <div class="tab" onclick="switchTab('yield-analysis')">📊 Yield Analysis</div>
            <div class="tab" onclick="switchTab('participation')">👥 Participation</div>
            <div class="tab" onclick="switchTab('interpretation')">💡 Market Interpretation</div>
        </div>

        <!-- Auction Results Tab -->
        <div class="tab-content active" id="auction-results">
            <div class="auction-results-container" id="auctionResultsContainer">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- All 31 Indicators Tab -->
        <div class="tab-content" id="all-indicators">
            <div class="dashboard-grid" id="indicatorsGrid">
                <!-- Will be populated dynamically -->
            </div>
        </div>

        <!-- Crisis Detection Tab -->
        <div class="tab-content" id="crisis-detection">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🚨 Crisis Detection System</div>
                </div>
                <div class="risk-meter">
                    <div class="meter-container">
                        <div class="meter-pointer" id="crisisMeter"></div>
                    </div>
                    <div class="meter-labels">
                        <span>Low Risk</span>
                        <span>Moderate</span>
                        <span>High Risk</span>
                    </div>
                </div>
                <div id="crisisIndicators" class="indicator-grid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div class="chart-container">
                <div id="crisisChart"></div>
            </div>
        </div>

        <!-- Liquidity Analysis Tab -->
        <div class="tab-content" id="liquidity">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">💧 Liquidity Analysis</div>
                </div>
                <div id="liquidityMetrics" class="indicator-grid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div class="chart-container">
                <div id="liquidityChart"></div>
            </div>
        </div>

        <!-- Historical Charts Tab -->
        <div class="tab-content" id="historical">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📉 Historical Treasury Data</div>
                </div>
                <div id="historicalCharts">
                    <!-- Will be populated with multiple charts -->
                </div>
            </div>
        </div>

        <!-- Yield Analysis Tab -->
        <div class="tab-content" id="yield-analysis">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📊 Yield Curve & Analysis</div>
                </div>
                <div id="yieldMetrics" class="indicator-grid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div class="chart-container">
                <div id="yieldCurveChart"></div>
            </div>
        </div>

        <!-- Participation Tab -->
        <div class="tab-content" id="participation">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">👥 Market Participation Analysis</div>
                </div>
                <div id="participationMetrics" class="indicator-grid">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
            <div class="chart-container">
                <div id="participationChart"></div>
            </div>
        </div>

        <!-- Market Interpretation Tab -->
        <div class="tab-content" id="interpretation">
            <div class="summary-section">
                <div class="summary-title">💡 Comprehensive Market Interpretation</div>
                <div id="marketInterpretation" class="summary-content">
                    <!-- Will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>

    <div class="timestamp" id="timestamp"></div>

    <script>
        // Configuration
        const API_BASE_URL = 'https://klehdyiwrl.execute-api.us-east-1.amazonaws.com/prod';
        const SECURITY_TYPES = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
        
        // State management
        let currentData = {
            auctions: {},
            indicators: {},
            crisis: {},
            liquidity: {},
            historical: {},
            summary: {}
        };

        // Tab switching
        function switchTab(tabName) {
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load specific data for tab if needed
            if (tabName === 'historical') {
                loadHistoricalData();
            }
        }

        // Data fetching functions
        async function fetchAllData() {
            showLoading();
            
            try {
                // Fetch current auction data
                const currentResponse = await fetch(`${API_BASE_URL}/auctions/current`);
                if (currentResponse.ok) {
                    currentData.auctions.current = await currentResponse.json();
                }

                // Fetch crisis analysis
                const crisisResponse = await fetch(`${API_BASE_URL}/crisis/analysis`);
                if (crisisResponse.ok) {
                    currentData.crisis = await crisisResponse.json();
                }

                // Fetch liquidity analysis
                const liquidityResponse = await fetch(`${API_BASE_URL}/liquidity/analysis`);
                if (liquidityResponse.ok) {
                    currentData.liquidity = await liquidityResponse.json();
                }

                // Fetch summary
                const summaryResponse = await fetch(`${API_BASE_URL}/summary/latest`);
                if (summaryResponse.ok) {
                    currentData.summary = await summaryResponse.json();
                }

                updateAllDisplays();
                updateAPIStatus(true);
            } catch (error) {
                console.error('Error fetching data:', error);
                updateAPIStatus(false);
            } finally {
                hideLoading();
            }
        }

        // Display update functions
        function updateAllDisplays() {
            updateAuctionResults();
            updateAllIndicators();
            updateCrisisDisplay();
            updateLiquidityDisplay();
            updateYieldAnalysis();
            updateParticipationDisplay();
            updateMarketInterpretation();
            updateCrisisBanner();
            updateTimestamp();
        }

        function updateAuctionResults() {
            const container = document.getElementById('auctionResultsContainer');
            if (!currentData.auctions.current) {
                container.innerHTML = '<div class="alert-box warning">No auction data available</div>';
                return;
            }

            // For now, show the current 30-year auction
            // In production, you would fetch data for all security types
            const auction = currentData.auctions.current;
            
            let html = '';
            
            // Create sections for each security type
            SECURITY_TYPES.forEach(secType => {
                html += `
                    <div class="security-section">
                        <div class="security-header">
                            <div class="security-title">${secType} Treasury</div>
                            <div class="status-indicator">
                                <div class="status-dot ${auction.security_term?.includes(secType.replace('-', ' ')) ? 'connected' : 'disconnected'}"></div>
                                <span>${auction.security_term?.includes(secType.replace('-', ' ')) ? 'Latest' : 'Pending'}</span>
                            </div>
                        </div>
                        <div class="security-metrics">
                `;

                if (auction.security_term?.includes(secType.replace('-', ' '))) {
                    // Display actual data for matching security
                    html += `
                        <div class="metric-item">
                            <div class="metric-label">Auction Date</div>
                            <div class="indicator-value">${auction.auction_date || 'N/A'}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">High Yield</div>
                            <div class="indicator-value ${auction.high_rate > 5 ? 'negative' : 'positive'}">${auction.high_rate?.toFixed(3)}%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Bid-to-Cover</div>
                            <div class="indicator-value ${auction.bid_to_cover_ratio < 2.3 ? 'negative' : 'positive'}">${auction.bid_to_cover_ratio?.toFixed(2)}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Total Accepted</div>
                            <div class="indicator-value">$${(auction.total_accepted / 1e9).toFixed(2)}B</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Tail (bps)</div>
                            <div class="indicator-value ${auction.tail > 3 ? 'negative' : auction.tail > 1 ? 'neutral' : 'positive'}">${auction.tail?.toFixed(1)}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Foreign %</div>
                            <div class="indicator-value ${auction.foreign_participation < 30 ? 'negative' : 'positive'}">${auction.foreign_participation?.toFixed(1)}%</div>
                        </div>
                    `;
                } else {
                    // Show placeholder for other securities
                    html += `
                        <div class="alert-box info">
                            Awaiting next ${secType} auction data
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateAllIndicators() {
            const grid = document.getElementById('indicatorsGrid');
            if (!currentData.auctions.current) {
                grid.innerHTML = '<div class="alert-box warning">No indicator data available</div>';
                return;
            }

            const auction = currentData.auctions.current;
            const indicators = [
                // Core Auction Data
                { category: 'Core', label: 'Auction Date', value: auction.auction_date, type: 'text' },
                { category: 'Core', label: 'Security Type', value: auction.security_type, type: 'text' },
                { category: 'Core', label: 'Security Term', value: auction.security_term, type: 'text' },
                { category: 'Core', label: 'CUSIP', value: auction.cusip, type: 'text' },
                { category: 'Core', label: 'Issue Date', value: auction.issue_date, type: 'text' },
                
                // Volume Indicators
                { category: 'Volume', label: 'Bid-to-Cover Ratio', value: auction.bid_to_cover_ratio?.toFixed(2), threshold: { low: 2.3, high: 2.8 } },
                { category: 'Volume', label: 'Total Accepted', value: `$${(auction.total_accepted / 1e9).toFixed(2)}B`, type: 'currency' },
                { category: 'Volume', label: 'Total Tendered', value: `$${(auction.total_tendered / 1e9).toFixed(2)}B`, type: 'currency' },
                
                // Yield Indicators
                { category: 'Yield', label: 'High Rate', value: `${auction.high_rate?.toFixed(3)}%`, threshold: { low: 4.5, high: 5.5 } },
                { category: 'Yield', label: 'Median Rate', value: `${auction.median_rate?.toFixed(3)}%`, type: 'percent' },
                { category: 'Yield', label: 'Low Rate', value: `${auction.low_rate?.toFixed(3)}%`, type: 'percent' },
                { category: 'Yield', label: 'Yield Range', value: `${auction.yield_range?.toFixed(1)} bps`, threshold: { low: 10, high: 20 } },
                { category: 'Yield', label: 'Tail', value: `${auction.tail?.toFixed(1)} bps`, threshold: { low: 1, high: 3 } },
                { category: 'Yield', label: 'WI Yield', value: `${auction.wi_yield?.toFixed(3)}%`, type: 'percent' },
                
                // Participation Indicators
                { category: 'Participation', label: 'Primary Dealer %', value: `${auction.primary_dealer_pct?.toFixed(1)}%`, threshold: { low: 40, high: 60 } },
                { category: 'Participation', label: 'Direct Bidder %', value: `${auction.direct_bidder_pct?.toFixed(1)}%`, type: 'percent' },
                { category: 'Participation', label: 'Indirect Bidder %', value: `${auction.indirect_bidder_pct?.toFixed(1)}%`, type: 'percent' },
                { category: 'Participation', label: 'Foreign Participation', value: `${auction.foreign_participation?.toFixed(1)}%`, threshold: { low: 30, high: 50 } },
                
                // Risk Indicators
                { category: 'Risk', label: 'Market Depth Ratio', value: auction.market_depth_ratio?.toFixed(2), threshold: { low: 2, high: 3 } },
                { category: 'Risk', label: 'Abnormal Auction', value: auction.abnormal_auction ? 'YES' : 'NO', type: 'boolean' },
                { category: 'Risk', label: 'Severe Tail', value: auction.severe_tail ? 'YES' : 'NO', type: 'boolean' },
                { category: 'Risk', label: 'Extreme Tail', value: auction.extreme_tail ? 'YES' : 'NO', type: 'boolean' },
                { category: 'Risk', label: 'Weak Coverage', value: auction.weak_coverage ? 'YES' : 'NO', type: 'boolean' },
                
                // Change Indicators
                { category: 'Change', label: 'Bid-to-Cover Change', value: `${auction.bid_to_cover_change?.toFixed(2)}%`, type: 'change' },
                { category: 'Change', label: 'Yield Change', value: `${auction.yield_change?.toFixed(2)}%`, type: 'change' },
                { category: 'Change', label: 'Tail Change', value: `${auction.tail_change?.toFixed(2)} bps`, type: 'change' },
                { category: 'Change', label: 'Primary Dealer Change', value: `${auction.primary_dealer_change?.toFixed(2)}%`, type: 'change' },
                { category: 'Change', label: 'Foreign Part. Change', value: `${auction.foreign_change?.toFixed(2)}%`, type: 'change' },
                
                // Crisis Detection
                { category: 'Crisis', label: 'Crisis Score', value: auction.crisis_score?.toFixed(1), threshold: { low: 3, high: 7 } },
                { category: 'Crisis', label: 'Crisis Level', value: auction.crisis_level, type: 'status' },
                { category: 'Crisis', label: 'Active Indicators', value: auction.active_indicators?.length || 0, type: 'count' }
            ];

            // Group indicators by category
            const categories = {};
            indicators.forEach(ind => {
                if (!categories[ind.category]) {
                    categories[ind.category] = [];
                }
                categories[ind.category].push(ind);
            });

            let html = '';
            Object.entries(categories).forEach(([category, items]) => {
                html += `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">${category} Indicators</div>
                        </div>
                        <div class="indicator-grid">
                `;
                
                items.forEach(item => {
                    let valueClass = '';
                    if (item.threshold) {
                        const val = parseFloat(item.value);
                        if (val < item.threshold.low) valueClass = 'negative';
                        else if (val > item.threshold.high) valueClass = 'negative';
                        else valueClass = 'positive';
                    } else if (item.type === 'boolean') {
                        valueClass = item.value === 'YES' ? 'negative' : 'positive';
                    } else if (item.type === 'change') {
                        const val = parseFloat(item.value);
                        valueClass = val < 0 ? 'negative' : val > 0 ? 'positive' : 'neutral';
                    } else if (item.type === 'status') {
                        valueClass = item.value === 'SEVERE' || item.value === 'HIGH' ? 'negative' : 
                                    item.value === 'MODERATE' ? 'neutral' : 'positive';
                    }
                    
                    html += `
                        <div class="indicator-item">
                            <div class="indicator-label">${item.label}</div>
                            <div class="indicator-value ${valueClass}">${item.value || 'N/A'}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        function updateCrisisDisplay() {
            if (!currentData.crisis) return;

            const crisis = currentData.crisis;
            
            // Update crisis meter
            const meterPointer = document.getElementById('crisisMeter');
            const position = (crisis.crisis_score / 10) * 100;
            meterPointer.style.left = `${position}%`;

            // Update crisis indicators
            const indicatorsDiv = document.getElementById('crisisIndicators');
            let html = '';

            if (crisis.indicators) {
                Object.entries(crisis.indicators).forEach(([key, indicator]) => {
                    const triggered = indicator.triggered;
                    html += `
                        <div class="indicator-item">
                            <div class="indicator-label">${indicator.name}</div>
                            <div class="indicator-value ${triggered ? 'negative' : 'positive'}">
                                ${indicator.value?.toFixed(2)} ${triggered ? '⚠️' : '✓'}
                            </div>
                        </div>
                    `;
                });
            }

            indicatorsDiv.innerHTML = html;

            // Create crisis chart
            if (crisis.historical_scores) {
                const trace = {
                    x: crisis.historical_scores.map(d => d.date),
                    y: crisis.historical_scores.map(d => d.score),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Crisis Score',
                    line: {
                        color: 'rgb(255, 68, 68)',
                        width: 3
                    },
                    marker: {
                        size: 8,
                        color: crisis.historical_scores.map(d => 
                            d.score > 7 ? 'rgb(255, 68, 68)' : 
                            d.score > 4 ? 'rgb(251, 191, 36)' : 
                            'rgb(74, 222, 128)'
                        )
                    }
                };

                const layout = {
                    title: 'Historical Crisis Score',
                    xaxis: { title: 'Date' },
                    yaxis: { title: 'Crisis Score (0-10)', range: [0, 10] },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(255,255,255,0.05)',
                    font: { color: '#ffffff' },
                    showlegend: false
                };

                Plotly.newPlot('crisisChart', [trace], layout, {responsive: true});
            }
        }

        function updateLiquidityDisplay() {
            if (!currentData.liquidity) return;

            const liquidity = currentData.liquidity;
            
            // Update liquidity metrics
            const metricsDiv = document.getElementById('liquidityMetrics');
            let html = '';

            const metrics = [
                { label: 'Liquidity Score', value: liquidity.liquidity_score?.toFixed(2), threshold: { low: 40, high: 70 } },
                { label: 'Liquidity Status', value: liquidity.liquidity_status, type: 'status' },
                { label: 'Market Depth', value: liquidity.market_depth_ratio?.toFixed(2), threshold: { low: 2, high: 3 } },
                { label: 'Bid-Ask Spread', value: `${liquidity.bid_ask_spread?.toFixed(1)} bps`, threshold: { low: 5, high: 10 } },
                { label: 'Volume Ratio', value: liquidity.volume_ratio?.toFixed(2), threshold: { low: 0.8, high: 1.2 } },
                { label: 'Participation Rate', value: `${liquidity.participation_rate?.toFixed(1)}%`, threshold: { low: 60, high: 80 } },
                { label: 'Dealer Inventory', value: liquidity.dealer_inventory, type: 'status' },
                { label: 'Foreign Demand', value: liquidity.foreign_demand, type: 'status' }
            ];

            metrics.forEach(metric => {
                let valueClass = '';
                if (metric.threshold) {
                    const val = parseFloat(metric.value);
                    if (val < metric.threshold.low) valueClass = 'negative';
                    else if (val > metric.threshold.high) valueClass = 'positive';
                    else valueClass = 'neutral';
                } else if (metric.type === 'status') {
                    valueClass = metric.value === 'CRUNCH' || metric.value === 'STRESS' ? 'negative' : 
                                metric.value === 'CONCERNS' ? 'neutral' : 'positive';
                }

                html += `
                    <div class="indicator-item">
                        <div class="indicator-label">${metric.label}</div>
                        <div class="indicator-value ${valueClass}">${metric.value || 'N/A'}</div>
                    </div>
                `;
            });

            metricsDiv.innerHTML = html;

            // Create liquidity radar chart
            if (liquidity.indicators) {
                const categories = Object.keys(liquidity.indicators);
                const values = Object.values(liquidity.indicators).map(ind => ind.score);

                const trace = {
                    type: 'scatterpolar',
                    r: values,
                    theta: categories,
                    fill: 'toself',
                    name: 'Liquidity Metrics',
                    marker: {
                        color: 'rgba(102, 126, 234, 0.8)'
                    }
                };

                const layout = {
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, 100]
                        }
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(255,255,255,0.05)',
                    font: { color: '#ffffff' },
                    showlegend: false
                };

                Plotly.newPlot('liquidityChart', [trace], layout, {responsive: true});
            }
        }

        function updateYieldAnalysis() {
            if (!currentData.auctions.current) return;

            const auction = currentData.auctions.current;
            const metricsDiv = document.getElementById('yieldMetrics');
            
            let html = `
                <div class="indicator-item">
                    <div class="indicator-label">Current Yield</div>
                    <div class="indicator-value">${auction.high_rate?.toFixed(3)}%</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Yield Range</div>
                    <div class="indicator-value ${auction.yield_range > 15 ? 'negative' : 'positive'}">${auction.yield_range?.toFixed(1)} bps</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Tail</div>
                    <div class="indicator-value ${auction.tail > 3 ? 'negative' : 'positive'}">${auction.tail?.toFixed(1)} bps</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Yield Change</div>
                    <div class="indicator-value ${auction.yield_change > 0 ? 'negative' : 'positive'}">${auction.yield_change?.toFixed(2)}%</div>
                </div>
            `;

            metricsDiv.innerHTML = html;

            // Create yield curve chart
            const maturities = ['4W', '8W', '13W', '2Y', '10Y', '30Y'];
            const yields = [4.5, 4.6, 4.7, 4.4, 4.6, 4.8]; // This would be real data in production

            const trace = {
                x: maturities,
                y: yields,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Yield Curve',
                line: {
                    color: 'rgb(102, 126, 234)',
                    width: 3
                },
                marker: {
                    size: 10,
                    color: 'rgb(102, 126, 234)'
                }
            };

            const layout = {
                title: 'Treasury Yield Curve',
                xaxis: { title: 'Maturity' },
                yaxis: { title: 'Yield (%)' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                showlegend: false
            };

            Plotly.newPlot('yieldCurveChart', [trace], layout, {responsive: true});
        }

        function updateParticipationDisplay() {
            if (!currentData.auctions.current) return;

            const auction = currentData.auctions.current;
            const metricsDiv = document.getElementById('participationMetrics');
            
            let html = `
                <div class="indicator-item">
                    <div class="indicator-label">Primary Dealers</div>
                    <div class="indicator-value">${auction.primary_dealer_pct?.toFixed(1)}%</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Direct Bidders</div>
                    <div class="indicator-value">${auction.direct_bidder_pct?.toFixed(1)}%</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Indirect Bidders</div>
                    <div class="indicator-value">${auction.indirect_bidder_pct?.toFixed(1)}%</div>
                </div>
                <div class="indicator-item">
                    <div class="indicator-label">Foreign Participation</div>
                    <div class="indicator-value ${auction.foreign_participation < 30 ? 'negative' : 'positive'}">${auction.foreign_participation?.toFixed(1)}%</div>
                </div>
            `;

            metricsDiv.innerHTML = html;

            // Create participation pie chart
            const data = [{
                values: [
                    auction.primary_dealer_pct || 0,
                    auction.direct_bidder_pct || 0,
                    auction.indirect_bidder_pct || 0
                ],
                labels: ['Primary Dealers', 'Direct Bidders', 'Indirect Bidders'],
                type: 'pie',
                marker: {
                    colors: ['rgb(102, 126, 234)', 'rgb(74, 222, 128)', 'rgb(251, 191, 36)']
                }
            }];

            const layout = {
                title: 'Auction Participation Breakdown',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                showlegend: true
            };

            Plotly.newPlot('participationChart', data, layout, {responsive: true});
        }

        function updateMarketInterpretation() {
            if (!currentData.summary) return;

            const summary = currentData.summary;
            const interpretationDiv = document.getElementById('marketInterpretation');
            
            let html = `
                <h3>📊 Latest Auction Analysis</h3>
                <p>${summary.summary || 'No summary available'}</p>
                
                <h3>🎯 Key Metrics</h3>
                <ul>
                    <li>Crisis Level: <strong>${summary.crisis_level || 'Unknown'}</strong></li>
                    <li>Liquidity Status: <strong>${summary.liquidity_status || 'Unknown'}</strong></li>
                    <li>Market Sentiment: <strong>${summary.market_sentiment || 'Unknown'}</strong></li>
                </ul>
                
                <h3>💡 Market Interpretation</h3>
                <p>${summary.interpretation || 'No interpretation available'}</p>
                
                <h3>⚠️ Risk Factors</h3>
                <ul>
            `;

            if (summary.risk_factors && Array.isArray(summary.risk_factors)) {
                summary.risk_factors.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
            } else {
                html += `<li>No specific risk factors identified</li>`;
            }

            html += `
                </ul>
                
                <h3>📈 Recommendations</h3>
                <ul>
            `;

            if (summary.recommendations && Array.isArray(summary.recommendations)) {
                summary.recommendations.forEach(rec => {
                    html += `<li>${rec}</li>`;
                });
            } else {
                html += `<li>No specific recommendations at this time</li>`;
            }

            html += `</ul>`;

            interpretationDiv.innerHTML = html;
        }

        async function loadHistoricalData() {
            // Create multiple charts for different security types
            const chartsDiv = document.getElementById('historicalCharts');
            chartsDiv.innerHTML = '';

            // For each security type, create a historical chart
            SECURITY_TYPES.forEach(secType => {
                const chartId = `chart-${secType.replace(/\s/g, '-')}`;
                chartsDiv.innerHTML += `
                    <div class="historical-chart">
                        <h3>${secType} Treasury Historical Data</h3>
                        <div id="${chartId}"></div>
                    </div>
                `;
            });

            // Generate sample historical data for demonstration
            // In production, this would fetch real historical data
            SECURITY_TYPES.forEach(secType => {
                const chartId = `chart-${secType.replace(/\s/g, '-')}`;
                
                // Generate dates for last 30 days
                const dates = [];
                const yields = [];
                const bidCovers = [];
                
                for (let i = 30; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                    
                    // Generate realistic yields based on security type
                    let baseYield = 4.5;
                    if (secType.includes('Week')) baseYield = 5.2;
                    else if (secType === '2-Year') baseYield = 4.3;
                    else if (secType === '10-Year') baseYield = 4.5;
                    else if (secType === '30-Year') baseYield = 4.8;
                    
                    yields.push(baseYield + (Math.random() - 0.5) * 0.5);
                    bidCovers.push(2.3 + (Math.random() - 0.5) * 0.4);
                }

                const trace1 = {
                    x: dates,
                    y: yields,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Yield (%)',
                    yaxis: 'y',
                    line: { color: 'rgb(102, 126, 234)', width: 2 }
                };

                const trace2 = {
                    x: dates,
                    y: bidCovers,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Bid-to-Cover',
                    yaxis: 'y2',
                    line: { color: 'rgb(74, 222, 128)', width: 2 }
                };

                const layout = {
                    title: `${secType} Historical Metrics`,
                    xaxis: { title: 'Date' },
                    yaxis: {
                        title: 'Yield (%)',
                        titlefont: { color: 'rgb(102, 126, 234)' },
                        tickfont: { color: 'rgb(102, 126, 234)' }
                    },
                    yaxis2: {
                        title: 'Bid-to-Cover Ratio',
                        titlefont: { color: 'rgb(74, 222, 128)' },
                        tickfont: { color: 'rgb(74, 222, 128)' },
                        overlaying: 'y',
                        side: 'right'
                    },
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(255,255,255,0.05)',
                    font: { color: '#ffffff' },
                    showlegend: true,
                    legend: { x: 0, y: 1 }
                };

                Plotly.newPlot(chartId, [trace1, trace2], layout, {responsive: true});
            });
        }

        function updateCrisisBanner() {
            const banner = document.getElementById('crisisBanner');
            if (!currentData.crisis) {
                banner.classList.remove('active');
                return;
            }

            const level = currentData.crisis.crisis_level;
            const score = currentData.crisis.crisis_score;
            
            banner.className = 'crisis-banner';
            
            if (level === 'SEVERE') {
                banner.classList.add('severe', 'active');
                banner.innerHTML = `🚨 SEVERE MARKET STRESS DETECTED - Crisis Score: ${score?.toFixed(1)}/10 🚨`;
            } else if (level === 'HIGH') {
                banner.classList.add('high', 'active');
                banner.innerHTML = `⚠️ HIGH RISK CONDITIONS - Crisis Score: ${score?.toFixed(1)}/10 ⚠️`;
            } else if (level === 'MODERATE') {
                banner.classList.add('moderate', 'active');
                banner.innerHTML = `📊 MODERATE MARKET STRESS - Crisis Score: ${score?.toFixed(1)}/10 📊`;
            } else if (level === 'LOW') {
                banner.classList.add('low', 'active');
                banner.innerHTML = `✅ LOW RISK - Market Conditions Normal - Score: ${score?.toFixed(1)}/10 ✅`;
            } else {
                banner.classList.remove('active');
            }
        }

        function updateAPIStatus(connected) {
            const statusDot = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            if (connected) {
                statusDot.className = 'status-dot connected';
                statusText.textContent = 'Connected';
            } else {
                statusDot.className = 'status-dot disconnected';
                statusText.textContent = 'Disconnected';
            }
        }

        function updateTimestamp() {
            const timestamp = document.getElementById('timestamp');
            const now = new Date();
            timestamp.textContent = `Last Update: ${now.toLocaleString()}`;
            
            const lastUpdateDiv = document.getElementById('lastUpdate');
            lastUpdateDiv.textContent = now.toLocaleTimeString();
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Initialize the dashboard
        async function initialize() {
            console.log('Initializing Treasury Dashboard v3.0...');
            await fetchAllData();
            
            // Set up auto-refresh every 30 seconds
            setInterval(fetchAllData, 30000);
            
            // Update timestamp every second
            setInterval(updateTimestamp, 1000);
        }

        // Start the application
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>
