<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Crisis Detection System - Complete v11.0</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        /* Core Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        /* Risk Level Indicator */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .risk-level {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .risk-none {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .risk-low {
            background: rgba(0, 204, 255, 0.2);
            color: #00ccff;
        }
        
        .risk-moderate {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .risk-high {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .risk-severe {
            background: rgba(255, 0, 0, 0.4);
            color: #ff0000;
            animation: severePulse 1s infinite;
        }
        
        @keyframes severePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.05); }
        }
        
        /* API Status Indicators */
        .api-status {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Market Phase Banner */
        .market-phase-banner {
            background: linear-gradient(90deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            animation: phaseGlow 2s ease-in-out infinite;
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        @keyframes phaseGlow {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .market-phase-banner.normal {
            background: linear-gradient(90deg, #00ff44, #00ff88);
        }
        
        .market-phase-banner.elevated {
            background: linear-gradient(90deg, #ffaa00, #ff8800);
        }
        
        .market-phase-banner.crisis {
            background: linear-gradient(90deg, #ff0000, #ff4444);
            animation: crisisPulse 0.8s ease-in-out infinite;
        }
        
        @keyframes crisisPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        /* Crisis Detection Dashboard */
        .crisis-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .crisis-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .crisis-panel.critical {
            border: 2px solid #ff4444;
            background: rgba(255, 68, 68, 0.05);
            animation: criticalPulse 2s infinite;
        }
        
        @keyframes criticalPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 68, 68, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
        }
        
        .crisis-score-meter {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        
        .crisis-score-value {
            font-size: 5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff4444, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .crisis-probability {
            font-size: 1.5rem;
            margin-top: 0.5rem;
            color: #ffaa00;
        }
        
        /* Pattern Detection Grid */
        .pattern-grid {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .pattern-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            border-left: 4px solid;
        }
        
        .pattern-card.high-severity {
            border-left-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }
        
        .pattern-card.moderate-severity {
            border-left-color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
        }
        
        .pattern-card.low-severity {
            border-left-color: #00ccff;
            background: rgba(0, 204, 255, 0.1);
        }
        
        .pattern-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .pattern-value {
            font-size: 1.5rem;
            color: #00ff88;
            margin: 0.5rem 0;
        }
        
        .pattern-description {
            font-size: 0.875rem;
            color: #aaa;
            margin-top: 0.5rem;
        }
        
        .pattern-context {
            font-size: 0.75rem;
            color: #888;
            font-style: italic;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Alert System */
        .alert-container {
            margin-bottom: 2rem;
        }
        
        .alert-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 4px solid;
            transition: all 0.3s;
        }
        
        .alert-item:hover {
            transform: translateX(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .alert-item.critical {
            border-left-color: #ff0000;
            background: rgba(255, 0, 0, 0.1);
        }
        
        .alert-item.warning {
            border-left-color: #ffaa00;
            background: rgba(255, 170, 0, 0.05);
        }
        
        .alert-item.info {
            border-left-color: #00ccff;
            background: rgba(0, 204, 255, 0.05);
        }
        
        .alert-icon {
            font-size: 1.5rem;
            min-width: 30px;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-id {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .alert-message {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .alert-action {
            color: #00ff88;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }
        
        .alert-timestamp {
            font-size: 0.75rem;
            color: #666;
        }
        
        .alert-ttl {
            font-size: 0.75rem;
            color: #888;
            margin-left: 1rem;
        }
        
        /* Crisis Thresholds Grid */
        .thresholds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .threshold-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .threshold-card.triggered {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            animation: thresholdFlash 1s infinite;
        }
        
        @keyframes thresholdFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .threshold-name {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .threshold-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .threshold-limit {
            font-size: 0.875rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .threshold-score {
            font-size: 0.75rem;
            color: #ffaa00;
            margin-top: 0.5rem;
        }
        
        /* Recommendations Panel */
        .recommendations-panel {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 204, 255, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .recommendations-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .recommendation-list {
            display: grid;
            gap: 0.75rem;
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            transition: all 0.3s;
        }
        
        .recommendation-item:hover {
            background: rgba(0, 255, 136, 0.1);
            transform: translateX(5px);
        }
        
        .recommendation-icon {
            color: #00ff88;
            min-width: 20px;
        }
        
        .recommendation-text {
            flex: 1;
            font-size: 0.95rem;
        }
        
        /* Market Conditions Grid */
        .conditions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .condition-card {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .condition-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .condition-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .condition-value.elevated { color: #ffaa00; }
        .condition-value.adequate { color: #00ff88; }
        .condition-value.strained { color: #ff4444; }
        .condition-value.increasing { color: #ffaa00; }
        
        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .metric-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .metric-interpretation {
            font-size: 0.75rem;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-style: italic;
            opacity: 0.9;
        }
        
        /* Data Table */
        .data-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: rgba(0, 255, 136, 0.1);
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            color: #00ff88;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .data-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        #mainChart, #crisisChart, #liquidityChart, #tailChart, #patternChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Historical Comparison */
        .historical-comparison {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .similarity-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .similarity-item {
            text-align: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .similarity-year {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .similarity-percent {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .similarity-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        /* Next Auction Panel */
        .next-auction-panel {
            background: linear-gradient(135deg, rgba(255, 170, 0, 0.1), rgba(255, 68, 68, 0.1));
            border: 1px solid rgba(255, 170, 0, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .next-auction-header {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        .next-auction-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .auction-detail {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
        }
        
        .auction-detail-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.5rem;
        }
        
        .auction-detail-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .risk-factors-list {
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(255, 68, 68, 0.3);
        }
        
        .risk-factor-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            color: #ffaa00;
        }
        
        /* Integration APIs Panel */
        .integration-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .api-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .api-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .api-card:hover {
            border-color: #00ff88;
            transform: translateY(-2px);
        }
        
        .api-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .api-url {
            font-size: 0.75rem;
            color: #00ccff;
            word-break: break-all;
        }
        
        /* Utility Classes */
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .metrics-grid,
            .thresholds-grid,
            .crisis-dashboard {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Market Phase Banner -->
    <div class="market-phase-banner" id="marketPhaseBanner">
        🏛️ TREASURY CRISIS DETECTION: INITIALIZING...
    </div>
    
    <header class="header">
        <div class="logo">
            🏛️ Treasury Crisis Detection System
            <span style="font-size: 0.875rem; color: #888;">v11.0 Complete</span>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="riskScore">0</div>
                <div class="stat-label">Risk Score</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="crisisProbability">0%</div>
                <div class="stat-label">Crisis Prob</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="activeAlerts">0</div>
                <div class="stat-label">Active Alerts</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--:--</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>
        
        <div class="risk-indicator">
            <span>Crisis Level:</span>
            <span class="risk-level risk-none" id="riskLevel">NONE</span>
        </div>
        
        <div class="api-status">
            <div class="api-indicator">
                <div class="status-dot loading" id="treasuryApiStatus"></div>
                <span>Treasury</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="crisisApiStatus"></div>
                <span>Crisis</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="alertsApiStatus"></div>
                <span>Alerts</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="analysisApiStatus"></div>
                <span>Analysis</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="crisis">🚨 Crisis Detection</button>
            <button class="tab-btn" data-tab="patterns">🔍 Pattern Recognition</button>
            <button class="tab-btn" data-tab="alerts">⚠️ Active Alerts</button>
            <button class="tab-btn" data-tab="thresholds">📊 Thresholds</button>
            <button class="tab-btn" data-tab="auctions">🏛️ Auctions</button>
            <button class="tab-btn" data-tab="liquidity">💧 Liquidity</button>
            <button class="tab-btn" data-tab="analysis">📈 Analysis</button>
            <button class="tab-btn" data-tab="recommendations">💡 Actions</button>
            <button class="tab-btn" data-tab="historical">📜 Historical</button>
        </div>
        
        <!-- Crisis Detection Tab -->
        <div class="tab-content active" id="crisis">
            <div class="crisis-dashboard">
                <!-- Crisis Score Panel -->
                <div class="crisis-panel" id="crisisScorePanel">
                    <div class="crisis-score-meter">
                        <div class="crisis-score-value" id="crisisScoreValue">0</div>
                        <div style="font-size: 1rem; color: #888;">Crisis Score (0-10)</div>
                        <div class="crisis-probability" id="crisisProbabilityDisplay">0-20%</div>
                        <div style="font-size: 0.875rem; color: #666;">Crisis Probability</div>
                    </div>
                    
                    <div class="conditions-grid">
                        <div class="condition-card">
                            <div class="condition-label">Stress Level</div>
                            <div class="condition-value" id="stressLevel">NORMAL</div>
                        </div>
                        <div class="condition-card">
                            <div class="condition-label">Liquidity</div>
                            <div class="condition-value" id="liquidityStatus">ADEQUATE</div>
                        </div>
                        <div class="condition-card">
                            <div class="condition-label">Volatility</div>
                            <div class="condition-value" id="volatilityStatus">STABLE</div>
                        </div>
                        <div class="condition-card">
                            <div class="condition-label">Dealer Capacity</div>
                            <div class="condition-value" id="dealerCapacity">NORMAL</div>
                        </div>
                    </div>
                </div>
                
                <!-- Current Metrics Panel -->
                <div class="crisis-panel">
                    <h3 style="margin-bottom: 1rem;">Current Metrics</h3>
                    <div class="metrics-grid" style="grid-template-columns: 1fr;">
                        <div style="display: grid; gap: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Bid-to-Cover</span>
                                <span id="currentBTC" style="font-weight: bold;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Tail (bp)</span>
                                <span id="currentTail" style="font-weight: bold;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Foreign %</span>
                                <span id="currentForeign" style="font-weight: bold;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Dealer %</span>
                                <span id="currentDealer" style="font-weight: bold;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Market Depth</span>
                                <span id="currentDepth" style="font-weight: bold;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: rgba(0,0,0,0.3); border-radius: 6px;">
                                <span>Allotted High %</span>
                                <span id="currentAllotted" style="font-weight: bold;">--</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Historical Comparison -->
                <div class="crisis-panel">
                    <h3 style="margin-bottom: 1rem;">Historical Crisis Similarity</h3>
                    <div class="similarity-grid">
                        <div class="similarity-item">
                            <div class="similarity-year">2008</div>
                            <div class="similarity-percent" id="similarity2008">0%</div>
                            <div class="similarity-label">Lehman Crisis</div>
                        </div>
                        <div class="similarity-item">
                            <div class="similarity-year">2011</div>
                            <div class="similarity-percent" id="similarity2011">0%</div>
                            <div class="similarity-label">Euro Crisis</div>
                        </div>
                        <div class="similarity-item">
                            <div class="similarity-year">2020</div>
                            <div class="similarity-percent" id="similarity2020">0%</div>
                            <div class="similarity-label">COVID Crisis</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Crisis Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Crisis Score Timeline</h2>
                </div>
                <div id="crisisChart"></div>
            </div>
        </div>
        
        <!-- Pattern Recognition Tab -->
        <div class="tab-content" id="patterns">
            <div class="pattern-grid" id="patternsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Pattern Detection Analysis</h2>
                </div>
                <div id="patternChart"></div>
            </div>
        </div>
        
        <!-- Active Alerts Tab -->
        <div class="tab-content" id="alerts">
            <div class="alert-container" id="alertsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <!-- Next Auction Panel -->
            <div class="next-auction-panel" id="nextAuctionPanel">
                <div class="next-auction-header">📅 Next Auction</div>
                <div class="next-auction-details">
                    <div class="auction-detail">
                        <div class="auction-detail-label">Date</div>
                        <div class="auction-detail-value" id="nextAuctionDate">--</div>
                    </div>
                    <div class="auction-detail">
                        <div class="auction-detail-label">Type</div>
                        <div class="auction-detail-value" id="nextAuctionType">--</div>
                    </div>
                    <div class="auction-detail">
                        <div class="auction-detail-label">Size</div>
                        <div class="auction-detail-value" id="nextAuctionSize">--</div>
                    </div>
                </div>
                <div class="risk-factors-list" id="nextAuctionRisks">
                    <div style="font-weight: bold; margin-bottom: 0.5rem;">Risk Factors:</div>
                </div>
            </div>
        </div>
        
        <!-- Thresholds Tab -->
        <div class="tab-content" id="thresholds">
            <div class="thresholds-grid" id="thresholdsGrid">
                <!-- Thresholds will be populated dynamically -->
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Tail Analysis</h2>
                </div>
                <div id="tailChart"></div>
            </div>
        </div>
        
        <!-- Auctions Tab -->
        <div class="tab-content" id="auctions">
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Security</th>
                            <th>BTC</th>
                            <th>Tail (bp)</th>
                            <th>Foreign %</th>
                            <th>Dealer %</th>
                            <th>Direct %</th>
                            <th>Crisis Score</th>
                            <th>Crisis Level</th>
                            <th>Indicators</th>
                        </tr>
                    </thead>
                    <tbody id="auctionsTable">
                        <tr>
                            <td colspan="10" style="text-align: center;">Loading auction data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Liquidity Tab -->
        <div class="tab-content" id="liquidity">
            <div class="metrics-grid" id="liquidityMetrics">
                <!-- Liquidity metrics will be populated -->
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Market Liquidity Analysis</h2>
                </div>
                <div id="liquidityChart"></div>
            </div>
        </div>
        
        <!-- Analysis Tab -->
        <div class="tab-content" id="analysis">
            <div class="crisis-dashboard">
                <div class="crisis-panel">
                    <h3>Market Analysis Summary</h3>
                    <div id="analysisSummary" style="margin-top: 1rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                
                <div class="crisis-panel">
                    <h3>24-Hour Outlook</h3>
                    <div id="outlookPanel" style="margin-top: 1rem;">
                        <div class="loading">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Comprehensive Market Analysis</h2>
                </div>
                <div id="mainChart"></div>
            </div>
        </div>
        
        <!-- Recommendations Tab -->
        <div class="tab-content" id="recommendations">
            <div class="recommendations-panel">
                <div class="recommendations-header">
                    <span>💡</span>
                    <span>Immediate Actions Required</span>
                </div>
                <div class="recommendation-list" id="recommendationsList">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Integration APIs -->
            <div class="integration-panel">
                <h3>Integrated Data Sources</h3>
                <div class="api-grid" id="apiGrid">
                    <!-- API connections will be displayed here -->
                </div>
            </div>
        </div>
        
        <!-- Historical Tab -->
        <div class="tab-content" id="historical">
            <div class="metrics-grid" id="historicalMetrics">
                <!-- Historical metrics will be populated -->
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Total Auctions</th>
                            <th>Avg BTC</th>
                            <th>Abnormal</th>
                            <th>Severe</th>
                            <th>Extreme</th>
                            <th>Crisis Periods</th>
                        </tr>
                    </thead>
                    <tbody id="historicalTable">
                        <tr>
                            <td colspan="7" style="text-align: center;">Loading historical data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Treasury Crisis Detection System Configuration
        const TREASURY_API = {
            baseUrl: 'https://i1hgpjotq7.execute-api.us-east-1.amazonaws.com/prod',
            backupUrl: 'https://klehdyiwrl.execute-api.us-east-1.amazonaws.com/prod',
            endpoints: {
                current: '/rates/current',
                indicators: '/indicators/all',
                liquidity: '/liquidity/metrics',
                historical: '/historical',
                crisis: '/treasury/crisis',
                alerts: '/treasury/alerts',
                analysis: '/treasury/analysis'
            }
        };
        
        // Crisis Thresholds Configuration
        const CRISIS_THRESHOLDS = {
            BID_TO_COVER: {
                critical: 2.0,
                weak: 2.5,
                normal: 2.8,
                strong: 3.5,
                scores: { critical: 2, weak: 1 }
            },
            DEALER_CONCENTRATION: {
                critical: 50,
                high: 40,
                elevated: 30,
                normal: 25,
                scores: { critical: 2, high: 1 }
            },
            FOREIGN_PARTICIPATION: {
                critical: 30,
                weak: 40,
                normal: 50,
                healthy: 60,
                scores: { critical: 2, weak: 1 }
            },
            TAIL: {
                extreme: 5,
                high: 3,
                elevated: 1,
                normal: 0.5,
                scores: { extreme: 3, high: 2, elevated: 1 }
            },
            MARKET_DEPTH: {
                poor: 2.0,
                weak: 2.5,
                normal: 2.8,
                healthy: 3.5,
                scores: { poor: 2, weak: 1 }
            },
            ALLOTMENT_HIGH: {
                critical: 50,
                elevated: 35,
                normal: 25,
                scores: { critical: 2, elevated: 1 }
            },
            YIELD: {
                flightToSafety: 1.0,
                scores: { flightToSafety: 1 }
            }
        };
        
        // Historical Crisis Patterns
        const CRISIS_PATTERNS = {
            '2008_STYLE': {
                name: '2008-style dealer concentration',
                conditions: {
                    dealer_change: 10,
                    dealer_threshold: 40
                },
                description: 'Primary dealers concentration increasing rapidly',
                context: 'Similar to Q3 2008 before Lehman collapse'
            },
            '2000_STYLE': {
                name: '2000-style BTC collapse',
                conditions: {
                    btc_threshold: 2.0,
                    btc_change: -5
                },
                description: 'Bid-to-cover ratio collapsing',
                context: 'Matches dot-com bubble auction stress'
            },
            '2020_STYLE': {
                name: '2020-style foreign retreat',
                conditions: {
                    foreign_change: -5,
                    foreign_threshold: 40
                },
                description: 'Foreign buyers retreating from market',
                context: 'Similar to COVID flight-to-quality pattern'
            }
        };
        
        // Global state
        let currentData = {
            auctions: [],
            indicators: {},
            liquidity: {},
            crisis: {},
            alerts: [],
            analysis: {},
            historical: {},
            patterns: []
        };
        
        let charts = {
            crisis: null,
            pattern: null,
            liquidity: null,
            tail: null,
            main: null
        };
        
        let autoRefreshInterval = null;
        let activeTab = 'crisis';
        
        // Initialize the platform
        async function initializePlatform() {
            console.log('🚀 Initializing Treasury Crisis Detection System v11.0...');
            
            // Test API connections
            await testAPIConnections();
            
            // Load all data
            await loadAllData();
            
            // Initialize charts
            initializeCharts();
            
            // Setup event listeners
            setupEventListeners();
            
            // Start auto-refresh (30 seconds)
            startAutoRefresh();
            
            console.log('✅ System initialized successfully');
        }
        
        // Test API connections
        async function testAPIConnections() {
            const apis = [
                { id: 'treasuryApiStatus', endpoint: '/rates/current' },
                { id: 'crisisApiStatus', endpoint: '/treasury/crisis' },
                { id: 'alertsApiStatus', endpoint: '/treasury/alerts' },
                { id: 'analysisApiStatus', endpoint: '/treasury/analysis' }
            ];
            
            for (const api of apis) {
                try {
                    const response = await fetch(TREASURY_API.baseUrl + api.endpoint);
                    const statusElement = document.getElementById(api.id);
                    
                    if (response.ok) {
                        statusElement.className = 'status-dot connected';
                    } else {
                        // Try backup URL
                        const backupResponse = await fetch(TREASURY_API.backupUrl + api.endpoint);
                        statusElement.className = backupResponse.ok ? 'status-dot connected' : 'status-dot error';
                    }
                } catch (error) {
                    console.error(`API connection error for ${api.endpoint}:`, error);
                    document.getElementById(api.id).className = 'status-dot error';
                }
            }
        }
        
        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadCurrentRates(),
                loadIndicators(),
                loadLiquidityMetrics(),
                loadCrisisDetection(),
                loadAlerts(),
                loadAnalysis(),
                loadHistoricalData()
            ]);
            
            updateDashboard();
        }
        
        // Load current rates
        async function loadCurrentRates() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.current);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentData.auctions = data.data || [];
                    updateAuctionsTable();
                    updateCurrentMetrics();
                }
            } catch (error) {
                console.error('Error loading rates:', error);
            }
        }
        
        // Load indicators
        async function loadIndicators() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.indicators);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentData.indicators = data.indicators || {};
                    updateIndicatorsDisplay();
                }
            } catch (error) {
                console.error('Error loading indicators:', error);
            }
        }
        
        // Load liquidity metrics
        async function loadLiquidityMetrics() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.liquidity);
                const data = await response.json();
                
                if (data.status === 'success') {
                    currentData.liquidity = data.metrics || {};
                    updateLiquidityDisplay();
                }
            } catch (error) {
                console.error('Error loading liquidity:', error);
            }
        }
        
        // Load crisis detection
        async function loadCrisisDetection() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.crisis);
                const data = await response.json();
                
                currentData.crisis = data;
                updateCrisisDisplay();
                updatePatternDisplay();
            } catch (error) {
                console.error('Error loading crisis detection:', error);
            }
        }
        
        // Load alerts
        async function loadAlerts() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.alerts);
                const data = await response.json();
                
                currentData.alerts = data.alerts || [];
                updateAlertsDisplay();
                updateNextAuction(data.next_auction);
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        }
        
        // Load analysis
        async function loadAnalysis() {
            try {
                const response = await fetch(TREASURY_API.baseUrl + TREASURY_API.endpoints.analysis);
                const data = await response.json();
                
                currentData.analysis = data;
                updateAnalysisDisplay();
                updateRecommendations();
                updateIntegrationAPIs();
            } catch (error) {
                console.error('Error loading analysis:', error);
            }
        }
        
        // Load historical data
        async function loadHistoricalData() {
            try {
                const years = [2020, 2021, 2022, 2023, 2024, 2025];
                const historicalData = [];
                
                for (const year of years) {
                    try {
                        const response = await fetch(`${TREASURY_API.baseUrl}${TREASURY_API.endpoints.historical}?year=${year}`);
                        const data = await response.json();
                        
                        if (data.status === 'success') {
                            historicalData.push({
                                year,
                                ...data.historical_analysis
                            });
                        }
                    } catch (e) {
                        console.error(`Error loading ${year} data:`, e);
                    }
                }
                
                currentData.historical = historicalData;
                updateHistoricalDisplay();
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }
        
        // Update dashboard
        function updateDashboard() {
            // Update header stats
            document.getElementById('riskScore').textContent = currentData.crisis.risk_score || 0;
            document.getElementById('crisisProbability').textContent = currentData.crisis.crisis_probability || '0%';
            document.getElementById('activeAlerts').textContent = currentData.alerts.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Update risk level
            const crisisLevel = currentData.indicators?.current_auction?.crisis_level || 'NONE';
            const riskElement = document.getElementById('riskLevel');
            riskElement.textContent = crisisLevel;
            riskElement.className = `risk-level risk-${crisisLevel.toLowerCase()}`;
            
            // Update market phase banner
            updateMarketPhase();
        }
        
        // Update market phase banner
        function updateMarketPhase() {
            const banner = document.getElementById('marketPhaseBanner');
            const riskScore = currentData.crisis.risk_score || 0;
            const alerts = currentData.alerts || [];
            
            let phase = '';
            let bannerClass = 'normal';
            
            if (riskScore >= 70) {
                phase = '🚨 CRISIS DETECTED - IMMEDIATE ACTION REQUIRED';
                bannerClass = 'crisis';
            } else if (riskScore >= 40) {
                phase = '⚠️ ELEVATED RISK - CRISIS PATTERNS EMERGING';
                bannerClass = 'elevated';
            } else if (alerts.some(a => a.level === 'CRITICAL')) {
                phase = '⚠️ CRITICAL ALERTS ACTIVE - MONITOR CLOSELY';
                bannerClass = 'elevated';
            } else {
                phase = '✅ TREASURY MARKET: NORMAL CONDITIONS';
                bannerClass = 'normal';
            }
            
            banner.textContent = phase;
            banner.className = `market-phase-banner ${bannerClass}`;
        }
        
        // Update crisis display
        function updateCrisisDisplay() {
            const crisis = currentData.crisis;
            
            // Update crisis score
            document.getElementById('crisisScoreValue').textContent = crisis.risk_score || 0;
            document.getElementById('crisisProbabilityDisplay').textContent = crisis.crisis_probability || '0-20%';
            
            // Update panel styling based on risk
            const panel = document.getElementById('crisisScorePanel');
            if (crisis.risk_score >= 70) {
                panel.classList.add('critical');
            } else {
                panel.classList.remove('critical');
            }
            
            // Update market conditions
            const conditions = crisis.market_conditions || {};
            document.getElementById('stressLevel').textContent = conditions.stress_level || 'NORMAL';
            document.getElementById('stressLevel').className = `condition-value ${(conditions.stress_level || '').toLowerCase()}`;
            
            document.getElementById('liquidityStatus').textContent = conditions.liquidity || 'ADEQUATE';
            document.getElementById('liquidityStatus').className = `condition-value ${(conditions.liquidity || '').toLowerCase()}`;
            
            document.getElementById('volatilityStatus').textContent = conditions.volatility || 'STABLE';
            document.getElementById('volatilityStatus').className = `condition-value ${(conditions.volatility || '').toLowerCase()}`;
            
            document.getElementById('dealerCapacity').textContent = conditions.dealer_capacity || 'NORMAL';
            document.getElementById('dealerCapacity').className = `condition-value ${(conditions.dealer_capacity || '').toLowerCase()}`;
            
            // Update historical similarity
            const analysis = currentData.analysis;
            if (analysis.historical_comparison) {
                document.getElementById('similarity2008').textContent = 
                    `${analysis.historical_comparison['2008_similarity'] || 0}%`;
                document.getElementById('similarity2011').textContent = 
                    `${analysis.historical_comparison['2011_similarity'] || 0}%`;
                document.getElementById('similarity2020').textContent = 
                    `${analysis.historical_comparison['2020_similarity'] || 0}%`;
            }
            
            // Update crisis chart
            updateCrisisChart();
        }
        
        // Update current metrics
        function updateCurrentMetrics() {
            const latest = currentData.auctions[0] || {};
            const analysis = currentData.analysis?.current_metrics || {};
            
            document.getElementById('currentBTC').textContent = 
                latest.bid_to_cover_ratio?.toFixed(2) || analysis.btc?.toFixed(2) || '--';
            document.getElementById('currentTail').textContent = 
                latest.tail?.toFixed(1) || analysis.tail_bps?.toFixed(1) || '--';
            document.getElementById('currentForeign').textContent = 
                `${latest.indirect_bidder_pct?.toFixed(1) || analysis.indirect_pct?.toFixed(1) || '--'}%`;
            document.getElementById('currentDealer').textContent = 
                `${latest.primary_dealer_pct?.toFixed(1) || analysis.dealer_pct?.toFixed(1) || '--'}%`;
            document.getElementById('currentDepth').textContent = 
                latest.market_depth_ratio?.toFixed(2) || '--';
            document.getElementById('currentAllotted').textContent = 
                `${analysis.allotted_at_high?.toFixed(1) || '--'}%`;
            
            // Update thresholds display
            updateThresholdsDisplay();
        }
        
        // Update pattern display
        function updatePatternDisplay() {
            const patterns = currentData.crisis.patterns_detected || [];
            const grid = document.getElementById('patternsGrid');
            
            grid.innerHTML = '';
            
            if (patterns.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #888;">No crisis patterns detected</div>';
                return;
            }
            
            patterns.forEach(pattern => {
                const card = document.createElement('div');
                card.className = `pattern-card ${pattern.severity.toLowerCase()}-severity`;
                
                card.innerHTML = `
                    <div class="pattern-name">${pattern.pattern}</div>
                    <div class="pattern-value">${pattern.value}</div>
                    <div class="pattern-description">${pattern.description}</div>
                    <div class="pattern-context">${pattern.historical_context}</div>
                `;
                
                grid.appendChild(card);
            });
            
            // Update pattern chart
            updatePatternChart();
        }
        
        // Update alerts display
        function updateAlertsDisplay() {
            const container = document.getElementById('alertsContainer');
            const alerts = currentData.alerts;
            
            container.innerHTML = '';
            
            if (alerts.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #888;">No active alerts</div>';
                return;
            }
            
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert-item ${alert.level.toLowerCase()}`;
                
                const icon = alert.level === 'CRITICAL' ? '🔴' : 
                            alert.level === 'WARNING' ? '🟠' : 'ℹ️';
                
                alertDiv.innerHTML = `
                    <div class="alert-icon">${icon}</div>
                    <div class="alert-content">
                        <div class="alert-id">${alert.id}</div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-action">Action: ${alert.action}</div>
                        <div>
                            <span class="alert-timestamp">${new Date(alert.timestamp).toLocaleString()}</span>
                            <span class="alert-ttl">Expires in ${alert.ttl_hours}h</span>
                        </div>
                    </div>
                `;
                
                container.appendChild(alertDiv);
            });
        }
        
        // Update next auction
        function updateNextAuction(nextAuction) {
            if (!nextAuction) return;
            
            document.getElementById('nextAuctionDate').textContent = nextAuction.date || '--';
            document.getElementById('nextAuctionType').textContent = nextAuction.type || '--';
            document.getElementById('nextAuctionSize').textContent = nextAuction.size || '--';
            
            const risksContainer = document.getElementById('nextAuctionRisks');
            risksContainer.innerHTML = '<div style="font-weight: bold; margin-bottom: 0.5rem;">Risk Factors:</div>';
            
            (nextAuction.risk_factors || []).forEach(risk => {
                const riskDiv = document.createElement('div');
                riskDiv.className = 'risk-factor-item';
                riskDiv.innerHTML = `<span>⚠️</span> ${risk}`;
                risksContainer.appendChild(riskDiv);
            });
        }
        
        // Update thresholds display
        function updateThresholdsDisplay() {
            const grid = document.getElementById('thresholdsGrid');
            const latest = currentData.auctions[0] || {};
            
            grid.innerHTML = '';
            
            // Define all thresholds to monitor
            const thresholds = [
                {
                    name: 'LOW_BID_TO_COVER',
                    value: latest.bid_to_cover_ratio,
                    threshold: CRISIS_THRESHOLDS.BID_TO_COVER.critical,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.BID_TO_COVER.scores.critical,
                    display: 'BTC < 2.0'
                },
                {
                    name: 'WEAK_BID_TO_COVER',
                    value: latest.bid_to_cover_ratio,
                    threshold: CRISIS_THRESHOLDS.BID_TO_COVER.weak,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.BID_TO_COVER.scores.weak,
                    display: 'BTC < 2.5'
                },
                {
                    name: 'EXTREME_TAIL',
                    value: latest.tail,
                    threshold: CRISIS_THRESHOLDS.TAIL.extreme,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.TAIL.scores.extreme,
                    display: 'Tail > 5bp'
                },
                {
                    name: 'HIGH_TAIL',
                    value: latest.tail,
                    threshold: CRISIS_THRESHOLDS.TAIL.high,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.TAIL.scores.high,
                    display: 'Tail > 3bp'
                },
                {
                    name: 'ELEVATED_TAIL',
                    value: latest.tail,
                    threshold: CRISIS_THRESHOLDS.TAIL.elevated,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.TAIL.scores.elevated,
                    display: 'Tail > 1bp'
                },
                {
                    name: 'DEALER_CONCENTRATION',
                    value: latest.primary_dealer_pct,
                    threshold: CRISIS_THRESHOLDS.DEALER_CONCENTRATION.critical,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.DEALER_CONCENTRATION.scores.critical,
                    display: 'Dealers > 50%'
                },
                {
                    name: 'HIGH_DEALER_RELIANCE',
                    value: latest.primary_dealer_pct,
                    threshold: CRISIS_THRESHOLDS.DEALER_CONCENTRATION.high,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.DEALER_CONCENTRATION.scores.high,
                    display: 'Dealers > 40%'
                },
                {
                    name: 'LOW_FOREIGN_PARTICIPATION',
                    value: latest.indirect_bidder_pct,
                    threshold: CRISIS_THRESHOLDS.FOREIGN_PARTICIPATION.critical,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.FOREIGN_PARTICIPATION.scores.critical,
                    display: 'Foreign < 30%'
                },
                {
                    name: 'WEAK_FOREIGN_DEMAND',
                    value: latest.indirect_bidder_pct,
                    threshold: CRISIS_THRESHOLDS.FOREIGN_PARTICIPATION.weak,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.FOREIGN_PARTICIPATION.scores.weak,
                    display: 'Foreign < 40%'
                },
                {
                    name: 'POOR_MARKET_DEPTH',
                    value: latest.market_depth_ratio,
                    threshold: CRISIS_THRESHOLDS.MARKET_DEPTH.poor,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.MARKET_DEPTH.scores.poor,
                    display: 'Depth < 2.0'
                },
                {
                    name: 'WEAK_MARKET_DEPTH',
                    value: latest.market_depth_ratio,
                    threshold: CRISIS_THRESHOLDS.MARKET_DEPTH.weak,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.MARKET_DEPTH.scores.weak,
                    display: 'Depth < 2.5'
                },
                {
                    name: 'HIGH_ALLOTMENT_PCT',
                    value: currentData.analysis?.current_metrics?.allotted_at_high,
                    threshold: CRISIS_THRESHOLDS.ALLOTMENT_HIGH.critical,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.ALLOTMENT_HIGH.scores.critical,
                    display: 'Allotted > 50%'
                },
                {
                    name: 'ELEVATED_ALLOTMENT',
                    value: currentData.analysis?.current_metrics?.allotted_at_high,
                    threshold: CRISIS_THRESHOLDS.ALLOTMENT_HIGH.elevated,
                    operator: '>',
                    score: CRISIS_THRESHOLDS.ALLOTMENT_HIGH.scores.elevated,
                    display: 'Allotted > 35%'
                },
                {
                    name: 'FLIGHT_TO_SAFETY',
                    value: latest.high_investment_rate,
                    threshold: CRISIS_THRESHOLDS.YIELD.flightToSafety,
                    operator: '<',
                    score: CRISIS_THRESHOLDS.YIELD.scores.flightToSafety,
                    display: 'Yield < 1.0%'
                }
            ];
            
            thresholds.forEach(threshold => {
                const isTriggered = checkThreshold(threshold.value, threshold.threshold, threshold.operator);
                
                const card = document.createElement('div');
                card.className = `threshold-card ${isTriggered ? 'triggered' : ''}`;
                
                card.innerHTML = `
                    <div class="threshold-name">${threshold.name.replace(/_/g, ' ')}</div>
                    <div class="threshold-value ${isTriggered ? 'negative' : 'positive'}">
                        ${threshold.value?.toFixed(2) || '--'}
                    </div>
                    <div class="threshold-limit">Threshold: ${threshold.display}</div>
                    <div class="threshold-score">Score Impact: +${threshold.score}</div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Check threshold
        function checkThreshold(value, threshold, operator) {
            if (value === null || value === undefined || threshold === null || threshold === undefined) {
                return false;
            }
            
            if (operator === '<') {
                return value < threshold;
            } else if (operator === '>') {
                return value > threshold;
            }
            return false;
        }
        
        // Update indicators display
        function updateIndicatorsDisplay() {
            const indicators = currentData.indicators;
            
            // Update percentage changes
            const changes = indicators.percentage_changes || {};
            
            // These will be used in various displays
        }
        
        // Update liquidity display
        function updateLiquidityDisplay() {
            const metrics = currentData.liquidity;
            const grid = document.getElementById('liquidityMetrics');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const cards = [
                {
                    title: 'Primary Dealers',
                    current: metrics.primary_dealer?.current,
                    average: metrics.primary_dealer?.average,
                    min: metrics.primary_dealer?.min,
                    max: metrics.primary_dealer?.max,
                    trend: metrics.primary_dealer?.trend,
                    warning: metrics.primary_dealer?.concentration_warning
                },
                {
                    title: 'Foreign/Indirect',
                    current: metrics.indirect_bidder?.current,
                    average: metrics.indirect_bidder?.average,
                    min: metrics.indirect_bidder?.min,
                    max: metrics.indirect_bidder?.max,
                    trend: metrics.indirect_bidder?.trend
                },
                {
                    title: 'Direct Bidders',
                    current: metrics.direct_bidder?.current,
                    average: metrics.direct_bidder?.average,
                    trend: metrics.direct_bidder?.trend
                },
                {
                    title: 'Market Depth',
                    current: metrics.market_depth?.current,
                    average: metrics.market_depth?.average,
                    min: metrics.market_depth?.min,
                    max: metrics.market_depth?.max,
                    warning: metrics.market_depth?.depth_warning
                }
            ];
            
            cards.forEach(card => {
                const div = document.createElement('div');
                div.className = 'metric-card';
                
                if (card.warning) {
                    div.classList.add('spike-alert-bad');
                }
                
                div.innerHTML = `
                    <div class="metric-title">${card.title}</div>
                    <div class="metric-value ${card.trend === 'decreasing' ? 'negative' : card.trend === 'increasing' ? 'positive' : 'neutral'}">
                        ${card.current?.toFixed(2) || '--'}${card.title.includes('Depth') ? '' : '%'}
                    </div>
                    <div class="metric-change neutral">
                        Avg: ${card.average?.toFixed(2) || '--'} | Range: ${card.min?.toFixed(1) || '--'}-${card.max?.toFixed(1) || '--'}
                    </div>
                    <div class="metric-interpretation">
                        Trend: ${card.trend || 'stable'} ${card.warning ? '⚠️ Warning' : ''}
                    </div>
                `;
                
                grid.appendChild(div);
            });
            
            // Update liquidity chart
            updateLiquidityChart();
        }
        
        // Update analysis display
        function updateAnalysisDisplay() {
            const analysis = currentData.analysis;
            
            // Update summary
            const summaryDiv = document.getElementById('analysisSummary');
            if (summaryDiv && analysis.summary) {
                summaryDiv.innerHTML = `
                    <div style="margin-bottom: 1rem; color: #ff4444; font-weight: bold;">
                        ${analysis.summary.status}
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        Risk Score: <span style="color: #ffaa00; font-weight: bold;">${analysis.summary.risk_score}/100</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        Probability: <span style="color: #ffaa00; font-weight: bold;">${analysis.summary.crisis_probability}</span>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        Market Phase: <span style="color: #00ccff;">${analysis.summary.market_phase}</span>
                    </div>
                    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                        Patterns: ${(analysis.summary.patterns_detected || []).join(', ')}
                    </div>
                `;
            }
            
            // Update 24h outlook
            const outlookDiv = document.getElementById('outlookPanel');
            if (outlookDiv && analysis.next_24h_outlook) {
                const outlook = analysis.next_24h_outlook;
                outlookDiv.innerHTML = `
                    <div style="margin-bottom: 1rem;">
                        Volatility: <span class="${outlook.expected_volatility === 'HIGH' ? 'negative' : 'positive'}" style="font-weight: bold;">
                            ${outlook.expected_volatility}
                        </span>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Key Events:</strong>
                        <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                            ${(outlook.key_events || []).map(e => `<li>${e}</li>`).join('')}
                        </ul>
                    </div>
                    <div>
                        <strong>Watch Levels:</strong>
                        <div style="margin-top: 0.5rem;">
                            10Y Yield: Support ${outlook.watch_levels?.['10Y_yield']?.support || '--'} | 
                            Resistance ${outlook.watch_levels?.['10Y_yield']?.resistance || '--'}
                        </div>
                        <div>
                            DXY: Support ${outlook.watch_levels?.DXY?.support || '--'} | 
                            Resistance ${outlook.watch_levels?.DXY?.resistance || '--'}
                        </div>
                    </div>
                `;
            }
        }
        
        // Update recommendations
        function updateRecommendations() {
            const recommendations = currentData.crisis.immediate_actions || 
                                   currentData.analysis.recommendations || [];
            const list = document.getElementById('recommendationsList');
            
            if (!list) return;
            
            list.innerHTML = '';
            
            if (recommendations.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #888;">No specific recommendations at this time</div>';
                return;
            }
            
            recommendations.forEach(rec => {
                const item = document.createElement('div');
                item.className = 'recommendation-item';
                item.innerHTML = `
                    <div class="recommendation-icon">→</div>
                    <div class="recommendation-text">${rec}</div>
                `;
                list.appendChild(item);
            });
        }
        
        // Update integration APIs
        function updateIntegrationAPIs() {
            const apis = currentData.crisis.integration_apis || 
                        currentData.analysis.integration || {};
            const grid = document.getElementById('apiGrid');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            const apiList = [
                { name: 'Treasury API', url: apis.treasury || TREASURY_API.baseUrl },
                { name: 'ECB API', url: apis.ecb },
                { name: 'FRED API', url: apis.fred || apis.fred_api },
                { name: 'OFR API', url: apis.ofr || apis.ofr_api }
            ];
            
            apiList.forEach(api => {
                if (!api.url) return;
                
                const card = document.createElement('div');
                card.className = 'api-card';
                card.innerHTML = `
                    <div class="api-name">${api.name}</div>
                    <div class="api-url">${api.url}</div>
                `;
                grid.appendChild(card);
            });
        }
        
        // Update auctions table
        function updateAuctionsTable() {
            const table = document.getElementById('auctionsTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            currentData.auctions.forEach(auction => {
                const row = document.createElement('tr');
                
                const crisisClass = getCrisisClass(auction.crisis_level);
                
                row.innerHTML = `
                    <td>${auction.auction_date}</td>
                    <td>${auction.security_type} ${auction.security_term}</td>
                    <td class="${auction.bid_to_cover_ratio < 2.5 ? 'negative' : 'positive'}">
                        ${auction.bid_to_cover_ratio?.toFixed(2) || '--'}
                    </td>
                    <td class="${auction.tail > 1 ? 'negative' : 'positive'}">
                        ${auction.tail?.toFixed(1) || '0.0'}
                    </td>
                    <td class="${auction.indirect_bidder_pct < 40 ? 'negative' : 'positive'}">
                        ${auction.indirect_bidder_pct?.toFixed(1) || '--'}%
                    </td>
                    <td class="${auction.primary_dealer_pct > 40 ? 'negative' : 'positive'}">
                        ${auction.primary_dealer_pct?.toFixed(1) || '--'}%
                    </td>
                    <td>${auction.direct_bidder_pct?.toFixed(1) || '--'}%</td>
                    <td class="${auction.crisis_score >= 5 ? 'negative' : auction.crisis_score >= 3 ? 'neutral' : 'positive'}">
                        ${auction.crisis_score || 0}
                    </td>
                    <td><span class="risk-level ${crisisClass}">${auction.crisis_level}</span></td>
                    <td style="font-size: 0.75rem;">
                        ${(auction.crisis_indicators || []).slice(0, 2).join(', ')}
                        ${auction.crisis_indicators?.length > 2 ? '...' : ''}
                    </td>
                `;
                
                table.appendChild(row);
            });
        }
        
        // Get crisis class
        function getCrisisClass(level) {
            if (!level) return 'risk-none';
            switch (level.toUpperCase()) {
                case 'NONE': return 'risk-none';
                case 'LOW': return 'risk-low';
                case 'MODERATE': return 'risk-moderate';
                case 'HIGH': return 'risk-high';
                case 'SEVERE': return 'risk-severe';
                default: return 'risk-none';
            }
        }
        
        // Update historical display
        function updateHistoricalDisplay() {
            const table = document.getElementById('historicalTable');
            if (!table) return;
            
            table.innerHTML = '';
            
            currentData.historical.forEach(yearData => {
                const row = document.createElement('tr');
                
                const crisisDistribution = yearData.crisis_distribution || {};
                const crisisPeriods = yearData.crisis_periods || [];
                
                row.innerHTML = `
                    <td>${yearData.year}</td>
                    <td>${yearData.total_auctions || '--'}</td>
                    <td>${yearData.bid_to_cover?.average?.toFixed(2) || '--'}</td>
                    <td>${yearData.tail_statistics?.abnormal_count || 0}</td>
                    <td>${yearData.tail_statistics?.severe_count || 0}</td>
                    <td>${yearData.tail_statistics?.extreme_count || 0}</td>
                    <td>${crisisPeriods.length > 0 ? crisisPeriods.map(p => `${p.level}: ${p.trigger}`).join(', ') : 'None'}</td>
                `;
                
                table.appendChild(row);
            });
            
            // Update historical metrics
            const metricsGrid = document.getElementById('historicalMetrics');
            if (metricsGrid) {
                metricsGrid.innerHTML = '';
                
                // Calculate aggregates
                let totalAuctions = 0;
                let totalAbnormal = 0;
                let totalSevere = 0;
                let totalExtreme = 0;
                
                currentData.historical.forEach(yearData => {
                    totalAuctions += yearData.total_auctions || 0;
                    totalAbnormal += yearData.tail_statistics?.abnormal_count || 0;
                    totalSevere += yearData.tail_statistics?.severe_count || 0;
                    totalExtreme += yearData.tail_statistics?.extreme_count || 0;
                });
                
                const metrics = [
                    { title: 'Total Auctions', value: totalAuctions, subtitle: 'All years' },
                    { title: 'Abnormal Auctions', value: totalAbnormal, subtitle: `${((totalAbnormal/totalAuctions)*100).toFixed(1)}% of total` },
                    { title: 'Severe Events', value: totalSevere, subtitle: 'Tail > 3bp' },
                    { title: 'Extreme Events', value: totalExtreme, subtitle: 'Tail > 5bp' }
                ];
                
                metrics.forEach(metric => {
                    const card = document.createElement('div');
                    card.className = 'metric-card';
                    card.innerHTML = `
                        <div class="metric-title">${metric.title}</div>
                        <div class="metric-value">${metric.value}</div>
                        <div style="font-size: 0.875rem; color: #888;">${metric.subtitle}</div>
                    `;
                    metricsGrid.appendChild(card);
                });
            }
        }
        
        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: false
            };
            
            // Initialize empty charts
            if (document.getElementById('crisisChart')) {
                Plotly.newPlot('crisisChart', [], chartConfig, config);
            }
            if (document.getElementById('patternChart')) {
                Plotly.newPlot('patternChart', [], chartConfig, config);
            }
            if (document.getElementById('liquidityChart')) {
                Plotly.newPlot('liquidityChart', [], chartConfig, config);
            }
            if (document.getElementById('tailChart')) {
                Plotly.newPlot('tailChart', [], chartConfig, config);
            }
            if (document.getElementById('mainChart')) {
                Plotly.newPlot('mainChart', [], chartConfig, config);
            }
        }
        
        // Update crisis chart
        function updateCrisisChart() {
            if (!document.getElementById('crisisChart')) return;
            
            const dates = currentData.auctions.map(a => a.auction_date).reverse();
            const crisisScores = currentData.auctions.map(a => a.crisis_score).reverse();
            const bidCovers = currentData.auctions.map(a => a.bid_to_cover_ratio).reverse();
            const tails = currentData.auctions.map(a => a.tail).reverse();
            
            const traces = [
                {
                    x: dates,
                    y: crisisScores,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Crisis Score',
                    line: { 
                        color: '#ff4444', 
                        width: 3,
                        shape: 'spline'
                    },
                    marker: {
                        size: 8,
                        color: crisisScores.map(s => s >= 7 ? '#ff0000' : s >= 5 ? '#ff4444' : s >= 3 ? '#ffaa00' : '#00ff88')
                    },
                    yaxis: 'y'
                },
                {
                    x: dates,
                    y: bidCovers,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Bid-to-Cover',
                    line: { color: '#00ff88', width: 2 },
                    yaxis: 'y2'
                },
                {
                    x: dates,
                    y: tails,
                    type: 'bar',
                    name: 'Tail (bp)',
                    marker: {
                        color: tails.map(t => t > 3 ? '#ff4444' : t > 1 ? '#ffaa00' : '#00ff88'),
                        opacity: 0.6
                    },
                    yaxis: 'y3'
                }
            ];
            
            const layout = {
                title: 'Crisis Indicators Timeline',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Crisis Score',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    range: [0, 10],
                    side: 'left'
                },
                yaxis2: {
                    title: 'Bid-to-Cover',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    overlaying: 'y',
                    side: 'right'
                },
                yaxis3: {
                    title: 'Tail (bp)',
                    overlaying: 'y',
                    side: 'left',
                    position: 0.05,
                    showgrid: false
                },
                shapes: [
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 5,
                        y1: 5,
                        line: {
                            color: '#ff4444',
                            width: 2,
                            dash: 'dash'
                        }
                    },
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 7,
                        y1: 7,
                        line: {
                            color: '#ff0000',
                            width: 2,
                            dash: 'dash'
                        }
                    }
                ],
                annotations: [
                    {
                        x: dates[Math.floor(dates.length / 2)],
                        y: 5,
                        text: 'HIGH Risk',
                        showarrow: false,
                        yshift: 10,
                        font: { color: '#ff4444', size: 10 }
                    },
                    {
                        x: dates[Math.floor(dates.length / 2)],
                        y: 7,
                        text: 'SEVERE',
                        showarrow: false,
                        yshift: 10,
                        font: { color: '#ff0000', size: 10 }
                    }
                ]
            };
            
            Plotly.newPlot('crisisChart', traces, layout, {responsive: true});
        }
        
        // Update pattern chart
        function updatePatternChart() {
            if (!document.getElementById('patternChart')) return;
            
            const patterns = currentData.crisis.patterns_detected || [];
            
            if (patterns.length === 0) {
                Plotly.newPlot('patternChart', [], {
                    title: 'No Patterns Detected',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                    font: { color: '#fff' }
                }, {responsive: true});
                return;
            }
            
            const trace = {
                x: patterns.map(p => p.pattern),
                y: patterns.map(p => {
                    if (p.severity === 'HIGH') return 3;
                    if (p.severity === 'MODERATE') return 2;
                    return 1;
                }),
                type: 'bar',
                marker: {
                    color: patterns.map(p => {
                        if (p.severity === 'HIGH') return '#ff4444';
                        if (p.severity === 'MODERATE') return '#ffaa00';
                        return '#00ccff';
                    })
                },
                text: patterns.map(p => p.value),
                textposition: 'outside'
            };
            
            const layout = {
                title: 'Crisis Pattern Detection',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888', size: 10 },
                    tickangle: -45
                },
                yaxis: {
                    title: 'Severity Level',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    tickmode: 'array',
                    tickvals: [1, 2, 3],
                    ticktext: ['LOW', 'MODERATE', 'HIGH']
                }
            };
            
            Plotly.newPlot('patternChart', [trace], layout, {responsive: true});
        }
        
        // Update liquidity chart
        function updateLiquidityChart() {
            if (!document.getElementById('liquidityChart')) return;
            
            const dates = currentData.auctions.map(a => a.auction_date).reverse();
            const primaryDealer = currentData.auctions.map(a => a.primary_dealer_pct).reverse();
            const indirect = currentData.auctions.map(a => a.indirect_bidder_pct).reverse();
            const direct = currentData.auctions.map(a => a.direct_bidder_pct).reverse();
            
            const traces = [
                {
                    x: dates,
                    y: primaryDealer,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Primary Dealers',
                    stackgroup: 'one',
                    fillcolor: 'rgba(255, 68, 68, 0.5)',
                    line: { color: '#ff4444' }
                },
                {
                    x: dates,
                    y: indirect,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Foreign/Indirect',
                    stackgroup: 'one',
                    fillcolor: 'rgba(0, 255, 136, 0.5)',
                    line: { color: '#00ff88' }
                },
                {
                    x: dates,
                    y: direct,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Direct Bidders',
                    stackgroup: 'one',
                    fillcolor: 'rgba(0, 204, 255, 0.5)',
                    line: { color: '#00ccff' }
                }
            ];
            
            const layout = {
                title: 'Market Participation Breakdown',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Participation %',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    range: [0, 100]
                },
                showlegend: true
            };
            
            Plotly.newPlot('liquidityChart', traces, layout, {responsive: true});
        }
        
        // Update tail chart
        function updateTailChart() {
            if (!document.getElementById('tailChart')) return;
            
            const dates = currentData.auctions.map(a => a.auction_date).reverse();
            const tails = currentData.auctions.map(a => a.tail).reverse();
            
            const trace = {
                x: dates,
                y: tails,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Tail (basis points)',
                line: { 
                    color: '#ffaa00', 
                    width: 2,
                    shape: 'spline'
                },
                marker: {
                    size: 8,
                    color: tails.map(t => t > 5 ? '#ff0000' : t > 3 ? '#ff4444' : t > 1 ? '#ffaa00' : '#00ff88')
                }
            };
            
            const layout = {
                title: 'Auction Tail Analysis',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Tail (basis points)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                shapes: [
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 1,
                        y1: 1,
                        line: { color: '#ffaa00', width: 1, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 3,
                        y1: 3,
                        line: { color: '#ff4444', width: 1, dash: 'dash' }
                    },
                    {
                        type: 'line',
                        x0: dates[0],
                        x1: dates[dates.length - 1],
                        y0: 5,
                        y1: 5,
                        line: { color: '#ff0000', width: 1, dash: 'dash' }
                    }
                ],
                annotations: [
                    {
                        x: dates[dates.length - 1],
                        y: 1,
                        text: 'Elevated',
                        showarrow: false,
                        xshift: 40,
                        font: { color: '#ffaa00', size: 10 }
                    },
                    {
                        x: dates[dates.length - 1],
                        y: 3,
                        text: 'High',
                        showarrow: false,
                        xshift: 40,
                        font: { color: '#ff4444', size: 10 }
                    },
                    {
                        x: dates[dates.length - 1],
                        y: 5,
                        text: 'Extreme',
                        showarrow: false,
                        xshift: 40,
                        font: { color: '#ff0000', size: 10 }
                    }
                ]
            };
            
            Plotly.newPlot('tailChart', [trace], layout, {responsive: true});
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = e.target.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    
                    activeTab = tabId;
                    
                    // Update specific tab charts
                    if (tabId === 'thresholds') updateTailChart();
                    if (tabId === 'analysis') updateMainChart();
                });
            });
        }
        
        // Update main chart
        function updateMainChart() {
            if (!document.getElementById('mainChart')) return;
            
            const dates = currentData.auctions.map(a => a.auction_date).reverse();
            const bidCovers = currentData.auctions.map(a => a.bid_to_cover_ratio).reverse();
            const foreignPct = currentData.auctions.map(a => a.indirect_bidder_pct).reverse();
            const dealerPct = currentData.auctions.map(a => a.primary_dealer_pct).reverse();
            const crisisScores = currentData.auctions.map(a => a.crisis_score).reverse();
            
            const traces = [
                {
                    x: dates,
                    y: bidCovers,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Bid-to-Cover',
                    line: { color: '#00ff88', width: 2 },
                    yaxis: 'y'
                },
                {
                    x: dates,
                    y: foreignPct,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Foreign %',
                    line: { color: '#00ccff', width: 2 },
                    yaxis: 'y2'
                },
                {
                    x: dates,
                    y: dealerPct,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Dealer %',
                    line: { color: '#ffaa00', width: 2 },
                    yaxis: 'y2'
                },
                {
                    x: dates,
                    y: crisisScores,
                    type: 'bar',
                    name: 'Crisis Score',
                    marker: {
                        color: crisisScores.map(s => s >= 5 ? '#ff4444' : s >= 3 ? '#ffaa00' : '#00ff88'),
                        opacity: 0.4
                    },
                    yaxis: 'y3'
                }
            ];
            
            const layout = {
                title: 'Comprehensive Market Analysis',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Bid-to-Cover',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    side: 'left'
                },
                yaxis2: {
                    title: 'Participation %',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    overlaying: 'y',
                    side: 'right'
                },
                yaxis3: {
                    title: 'Crisis Score',
                    overlaying: 'y',
                    side: 'left',
                    position: 0.05,
                    showgrid: false,
                    range: [0, 10]
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            Plotly.newPlot('mainChart', traces, layout, {responsive: true});
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            // Refresh every 30 seconds
            autoRefreshInterval = setInterval(() => {
                console.log('🔄 Auto-refreshing data...');
                loadAllData();
            }, 30000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePlatform);
    </script>
</body>
</html>
