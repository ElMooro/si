<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polygon Advanced Trading Dashboard</title>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #151932;
            --bg-card: #1a1f3a;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --accent-green: #00d4aa;
            --accent-red: #ff3b69;
            --accent-blue: #5865f2;
            --accent-yellow: #ffb800;
            --accent-purple: #9945ff;
            --border: #2a3050;
            --hover: #262b47;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--accent-blue);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1rem;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-blue);
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Watchlist Grid */
        .watchlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .watchlist-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .watchlist-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-blue);
        }

        .watchlist-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .watchlist-symbol {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .watchlist-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .badge-stock {
            background: var(--accent-blue);
            color: white;
        }

        .badge-crypto {
            background: var(--accent-purple);
            color: white;
        }

        .badge-forex {
            background: var(--accent-yellow);
            color: black;
        }

        .watchlist-price {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .watchlist-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .watchlist-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .metric-item {
            font-size: 0.8rem;
        }

        .metric-label {
            color: var(--text-secondary);
        }

        .metric-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Action Buttons */
        .card-actions {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .action-btn {
            width: 30px;
            height: 30px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--accent-blue);
            color: white;
        }

        .action-btn.favorited {
            color: var(--accent-yellow);
        }

        /* Add Asset Section */
        .add-asset-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .add-asset-form {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .input-field {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .select-field {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: var(--accent-red);
            color: white;
        }

        /* Chart Modal */
        .chart-container {
            width: 100%;
            height: 500px;
            position: relative;
            margin-bottom: 2rem;
        }

        .chart-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .info-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }

        /* Notes Section */
        .notes-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .notes-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .notes-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
            resize: vertical;
        }

        .notes-list {
            margin-top: 1rem;
        }

        .note-item {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }

        .note-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .note-text {
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        /* Utilities */
        .positive {
            color: var(--accent-green);
        }

        .negative {
            color: var(--accent-red);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .watchlist-grid {
                grid-template-columns: 1fr;
            }

            .add-asset-form {
                flex-direction: column;
            }

            .input-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üìä Polygon Trading Dashboard</div>
            <div class="header-controls">
                <button class="btn" onclick="refreshAll()">üîÑ Refresh All</button>
                <span id="last-update" style="color: var(--text-secondary); font-size: 0.9rem;">Last update: Never</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('watchlist')">üìã Watchlist</button>
            <button class="tab-btn" onclick="switchTab('favorites')">‚≠ê Favorites</button>
            <button class="tab-btn" onclick="switchTab('high-volume')">üìä High Volume</button>
            <button class="tab-btn" onclick="switchTab('high-beta')">‚ö° High Beta</button>
            <button class="tab-btn" onclick="switchTab('indices')">üìà Indices</button>
            <button class="tab-btn" onclick="switchTab('crypto')">‚Çø Crypto</button>
            <button class="tab-btn" onclick="switchTab('forex')">üí± Forex</button>
        </div>

        <!-- Add Asset Section -->
        <div class="add-asset-section">
            <div class="add-asset-form">
                <div class="input-group">
                    <label class="input-label">Symbol</label>
                    <input type="text" class="input-field" id="add-symbol" placeholder="e.g., AAPL, BTC, EUR/USD">
                </div>
                <div class="input-group">
                    <label class="input-label">Type</label>
                    <select class="select-field" id="add-type">
                        <option value="stock">Stock</option>
                        <option value="crypto">Crypto</option>
                        <option value="forex">Forex</option>
                        <option value="index">Index</option>
                    </select>
                </div>
                <div class="input-group" style="align-self: flex-end;">
                    <button class="btn" onclick="addAsset()">+ Add to Watchlist</button>
                </div>
            </div>
        </div>

        <!-- Tab Contents -->
        <!-- Watchlist Tab -->
        <div id="watchlist-tab" class="tab-content active">
            <h2 style="margin-bottom: 1rem;">All Assets</h2>
            <div class="watchlist-grid" id="watchlist-grid">
                <!-- Watchlist items will be populated here -->
            </div>
        </div>

        <!-- Favorites Tab -->
        <div id="favorites-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Favorite Assets</h2>
            <div class="watchlist-grid" id="favorites-grid">
                <!-- Favorite items will be populated here -->
            </div>
        </div>

        <!-- High Volume Tab -->
        <div id="high-volume-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Highest Volume Stocks</h2>
            <div class="stats-grid" id="volume-stats">
                <!-- Volume stats will be populated here -->
            </div>
            <div class="watchlist-grid" id="high-volume-grid">
                <!-- High volume stocks will be populated here -->
            </div>
        </div>

        <!-- High Beta Tab -->
        <div id="high-beta-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">High Beta Stocks</h2>
            <div class="stats-grid" id="beta-stats">
                <!-- Beta stats will be populated here -->
            </div>
            <div class="watchlist-grid" id="high-beta-grid">
                <!-- High beta stocks will be populated here -->
            </div>
        </div>

        <!-- Indices Tab -->
        <div id="indices-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Market Indices</h2>
            <div class="watchlist-grid" id="indices-grid">
                <!-- Indices will be populated here -->
            </div>
        </div>

        <!-- Crypto Tab -->
        <div id="crypto-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Cryptocurrencies</h2>
            <div class="watchlist-grid" id="crypto-grid">
                <!-- Crypto assets will be populated here -->
            </div>
        </div>

        <!-- Forex Tab -->
        <div id="forex-tab" class="tab-content">
            <h2 style="margin-bottom: 1rem;">Forex Pairs</h2>
            <div class="watchlist-grid" id="forex-grid">
                <!-- Forex pairs will be populated here -->
            </div>
        </div>
    </div>

    <!-- Chart Modal -->
    <div class="modal" id="chart-modal">
        <div class="modal-content" style="width: 90%; max-width: 1200px;">
            <div class="modal-header">
                <h2 class="modal-title" id="modal-title">Asset Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="chart-info" id="chart-info">
                <!-- Asset info will be populated here -->
            </div>
            
            <div class="chart-container">
                <canvas id="full-chart"></canvas>
            </div>
            
            <div class="notes-section">
                <div class="notes-header">
                    <h3 class="notes-title">Notes</h3>
                    <button class="btn" onclick="saveNote()">Save Note</button>
                </div>
                <textarea class="notes-textarea" id="note-input" placeholder="Add your notes here..."></textarea>
                <div class="notes-list" id="notes-list">
                    <!-- Notes will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'https://fjf6t3ne4h.execute-api.us-east-1.amazonaws.com/prod';
        let chartInstance = null;
        let modalChartInstance = null;
        let currentAsset = null;
        
        // Data storage
        let watchlist = [];
        let favorites = [];
        let assetData = {};
        let assetNotes = {};
        let priceHistory = {};
        
        // Default assets
        const defaultAssets = [
            { symbol: 'SPY', type: 'index', name: 'S&P 500' },
            { symbol: 'QQQ', type: 'index', name: 'NASDAQ 100' },
            { symbol: 'IWM', type: 'index', name: 'Russell 2000' },
            { symbol: 'GRNY', type: 'stock', name: 'GraniteShares 2x Long NVDA' },
            { symbol: 'X:BTCUSD', type: 'crypto', name: 'Bitcoin' },
            { symbol: 'X:ETHUSD', type: 'crypto', name: 'Ethereum' },
            { symbol: 'X:MATICUSD', type: 'crypto', name: 'Polygon' },
            { symbol: 'X:PEPEUSD', type: 'crypto', name: 'Pepe' },
            { symbol: 'DXY', type: 'forex', name: 'US Dollar Index' },
            { symbol: 'C:EURUSD', type: 'forex', name: 'EUR/USD' },
            { symbol: 'C:USDJPY', type: 'forex', name: 'USD/JPY' }
        ];
        
        // High volume and high beta stocks
        const highVolumeStocks = ['AAPL', 'NVDA', 'TSLA', 'MSFT', 'AMD', 'AMZN', 'META', 'SPY', 'QQQ', 'PLTR'];
        const highBetaStocks = ['TSLA', 'NVDA', 'AMD', 'PLTR', 'GME', 'AMC', 'COIN', 'RIOT', 'MARA', 'GRNY'];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            loadFromStorage();
            initializeWatchlist();
            loadAllData();
        });

        // Load from localStorage
        function loadFromStorage() {
            const savedWatchlist = localStorage.getItem('polygon_watchlist');
            const savedFavorites = localStorage.getItem('polygon_favorites');
            const savedNotes = localStorage.getItem('polygon_notes');
            
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
            } else {
                watchlist = [...defaultAssets];
            }
            
            if (savedFavorites) {
                favorites = JSON.parse(savedFavorites);
            }
            
            if (savedNotes) {
                assetNotes = JSON.parse(savedNotes);
            }
        }

        // Save to localStorage
        function saveToStorage() {
            localStorage.setItem('polygon_watchlist', JSON.stringify(watchlist));
            localStorage.setItem('polygon_favorites', JSON.stringify(favorites));
            localStorage.setItem('polygon_notes', JSON.stringify(assetNotes));
        }

        // Initialize watchlist
        function initializeWatchlist() {
            if (watchlist.length === 0) {
                watchlist = [...defaultAssets];
                saveToStorage();
            }
        }

        // Switch tabs
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Load specific tab data
            if (tabName === 'high-volume') {
                loadHighVolumeStocks();
            } else if (tabName === 'high-beta') {
                loadHighBetaStocks();
            }
        }

        // Add asset to watchlist
        function addAsset() {
            const symbolInput = document.getElementById('add-symbol');
            const typeSelect = document.getElementById('add-type');
            
            let symbol = symbolInput.value.trim().toUpperCase();
            const type = typeSelect.value;
            
            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            
            // Format symbol based on type
            if (type === 'crypto' && !symbol.includes(':')) {
                symbol = 'X:' + symbol + 'USD';
            } else if (type === 'forex' && !symbol.includes(':')) {
                symbol = 'C:' + symbol.replace('/', '');
            }
            
            // Check if already in watchlist
            if (watchlist.find(a => a.symbol === symbol)) {
                alert('Asset already in watchlist');
                return;
            }
            
            // Add to watchlist
            const asset = {
                symbol: symbol,
                type: type,
                name: symbol
            };
            
            watchlist.push(asset);
            saveToStorage();
            
            // Clear inputs
            symbolInput.value = '';
            
            // Reload data
            loadAssetData(asset);
            renderWatchlist();
        }

        // Toggle favorite
        function toggleFavorite(symbol) {
            const index = favorites.indexOf(symbol);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(symbol);
            }
            saveToStorage();
            renderAllGrids();
        }

        // Remove from watchlist
        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(a => a.symbol !== symbol);
            favorites = favorites.filter(s => s !== symbol);
            saveToStorage();
            renderAllGrids();
        }

        // Open chart modal
        function openChartModal(symbol) {
            currentAsset = symbol;
            const modal = document.getElementById('chart-modal');
            modal.classList.add('active');
            
            // Update modal title
            document.getElementById('modal-title').textContent = symbol + ' - Full Analysis';
            
            // Load full chart data
            loadFullChart(symbol);
            
            // Load notes
            loadNotes(symbol);
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('chart-modal');
            modal.classList.remove('active');
            if (modalChartInstance) {
                modalChartInstance.destroy();
                modalChartInstance = null;
            }
        }

        // Load full chart
        async function loadFullChart(symbol) {
            const data = assetData[symbol];
            if (!data) return;
            
            // Display asset info
            const infoHtml = `
                <div class="info-card">
                    <div class="metric-label">Open</div>
                    <div class="metric-value">${formatCurrency(data.open)}</div>
                </div>
                <div class="info-card">
                    <div class="metric-label">High</div>
                    <div class="metric-value">${formatCurrency(data.high)}</div>
                </div>
                <div class="info-card">
                    <div class="metric-label">Low</div>
                    <div class="metric-value">${formatCurrency(data.low)}</div>
                </div>
                <div class="info-card">
                    <div class="metric-label">Close</div>
                    <div class="metric-value">${formatCurrency(data.close)}</div>
                </div>
                <div class="info-card">
                    <div class="metric-label">Volume</div>
                    <div class="metric-value">${formatNumber(data.volume)}</div>
                </div>
                <div class="info-card">
                    <div class="metric-label">Change</div>
                    <div class="metric-value ${data.close >= data.open ? 'positive' : 'negative'}">
                        ${((data.close - data.open) / data.open * 100).toFixed(2)}%
                    </div>
                </div>
            `;
            document.getElementById('chart-info').innerHTML = infoHtml;
            
            // Create full chart
            const ctx = document.getElementById('full-chart').getContext('2d');
            
            if (modalChartInstance) {
                modalChartInstance.destroy();
            }
            
            // Generate more historical data points for demonstration
            const history = generateHistoricalData(symbol, 100);
            
            modalChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => h.date),
                    datasets: [{
                        label: 'Price',
                        data: history.map(h => h.price),
                        borderColor: '#5865f2',
                        backgroundColor: 'rgba(88, 101, 242, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: '#2a3050'
                            },
                            ticks: {
                                color: '#8892b0',
                                maxTicksLimit: 10
                            }
                        },
                        y: {
                            position: 'right',
                            grid: {
                                color: '#2a3050'
                            },
                            ticks: {
                                color: '#8892b0',
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate historical data
        function generateHistoricalData(symbol, days) {
            const data = assetData[symbol];
            if (!data) return [];
            
            const history = [];
            let basePrice = data.close;
            
            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // Simulate price movement
                const change = (Math.random() - 0.5) * basePrice * 0.02;
                basePrice = Math.max(basePrice * 0.5, basePrice + change);
                
                history.push({
                    date: date.toLocaleDateString(),
                    price: basePrice
                });
            }
            
            // Add current price
            history[history.length - 1].price = data.close;
            
            return history;
        }

        // Save note
        function saveNote() {
            if (!currentAsset) return;
            
            const noteInput = document.getElementById('note-input');
            const note = noteInput.value.trim();
            
            if (!note) return;
            
            if (!assetNotes[currentAsset]) {
                assetNotes[currentAsset] = [];
            }
            
            assetNotes[currentAsset].push({
                text: note,
                date: new Date().toISOString()
            });
            
            saveToStorage();
            noteInput.value = '';
            loadNotes(currentAsset);
        }

        // Load notes
        function loadNotes(symbol) {
            const notes = assetNotes[symbol] || [];
            const notesList = document.getElementById('notes-list');
            
            if (notes.length === 0) {
                notesList.innerHTML = '<p style="color: var(--text-secondary);">No notes yet</p>';
                return;
            }
            
            let html = '';
            notes.forEach(note => {
                const date = new Date(note.date);
                html += `
                    <div class="note-item">
                        <div class="note-date">${date.toLocaleDateString()} ${date.toLocaleTimeString()}</div>
                        <div class="note-text">${note.text}</div>
                    </div>
                `;
            });
            
            notesList.innerHTML = html;
        }

        // Load all data
        async function loadAllData() {
            // Load data for all watchlist items
            for (const asset of watchlist) {
                await loadAssetData(asset);
            }
            
            renderAllGrids();
            updateLastUpdate();
        }

        // Load asset data
        async function loadAssetData(asset) {
            try {
                const endpoint = asset.type === 'index' ? '/indices' : '/stock/' + asset.symbol;
                const response = await fetch(API_BASE + endpoint);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (asset.type === 'index' && data[asset.symbol]) {
                        assetData[asset.symbol] = data[asset.symbol];
                    } else if (!data.error) {
                        assetData[asset.symbol] = data;
                    }
                }
            } catch (error) {
                console.error('Error loading ' + asset.symbol + ':', error);
            }
        }

        // Load high volume stocks
        async function loadHighVolumeStocks() {
            const grid = document.getElementById('high-volume-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const stocks = [];
            for (const symbol of highVolumeStocks) {
                const data = assetData[symbol];
                if (!data) {
                    await loadAssetData({ symbol: symbol, type: 'stock' });
                }
                if (assetData[symbol]) {
                    stocks.push({ symbol: symbol, data: assetData[symbol] });
                }
            }
            
            // Sort by volume
            stocks.sort((a, b) => (b.data.volume || 0) - (a.data.volume || 0));
            
            // Display stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Average Volume</div>
                    <div class="stat-value">${formatNumber(stocks.reduce((sum, s) => sum + (s.data.volume || 0), 0) / stocks.length)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Highest Volume</div>
                    <div class="stat-value">${stocks[0] ? stocks[0].symbol : '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Stocks</div>
                    <div class="stat-value">${stocks.length}</div>
                </div>
            `;
            document.getElementById('volume-stats').innerHTML = statsHtml;
            
            // Display stocks
            let html = '';
            stocks.forEach(stock => {
                html += createWatchlistCard(stock.symbol, stock.data, 'stock');
            });
            grid.innerHTML = html;
        }

        // Load high beta stocks
        async function loadHighBetaStocks() {
            const grid = document.getElementById('high-beta-grid');
            grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            
            const stocks = [];
            for (const symbol of highBetaStocks) {
                const data = assetData[symbol];
                if (!data) {
                    await loadAssetData({ symbol: symbol, type: 'stock' });
                }
                if (assetData[symbol]) {
                    stocks.push({ symbol: symbol, data: assetData[symbol] });
                }
            }
            
            // Calculate volatility (simplified)
            stocks.forEach(stock => {
                const change = Math.abs((stock.data.high - stock.data.low) / stock.data.open * 100);
                stock.volatility = change;
            });
            
            // Sort by volatility
            stocks.sort((a, b) => b.volatility - a.volatility);
            
            // Display stats
            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-label">Average Volatility</div>
                    <div class="stat-value">${(stocks.reduce((sum, s) => sum + s.volatility, 0) / stocks.length).toFixed(2)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Most Volatile</div>
                    <div class="stat-value">${stocks[0] ? stocks[0].symbol : '-'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Stocks</div>
                    <div class="stat-value">${stocks.length}</div>
                </div>
            `;
            document.getElementById('beta-stats').innerHTML = statsHtml;
            
            // Display stocks
            let html = '';
            stocks.forEach(stock => {
                html += createWatchlistCard(stock.symbol, stock.data, 'stock');
            });
            grid.innerHTML = html;
        }

        // Render all grids
        function renderAllGrids() {
            renderWatchlist();
            renderFavorites();
            renderByType();
        }

        // Render watchlist
        function renderWatchlist() {
            const grid = document.getElementById('watchlist-grid');
            let html = '';
            
            watchlist.forEach(asset => {
                const data = assetData[asset.symbol];
                if (data) {
                    html += createWatchlistCard(asset.symbol, data, asset.type);
                }
            });
            
            grid.innerHTML = html || '<div class="loading">Loading watchlist...</div>';
        }

        // Render favorites
        function renderFavorites() {
            const grid = document.getElementById('favorites-grid');
            let html = '';
            
            favorites.forEach(symbol => {
                const asset = watchlist.find(a => a.symbol === symbol);
                if (asset) {
                    const data = assetData[symbol];
                    if (data) {
                        html += createWatchlistCard(symbol, data, asset.type);
                    }
                }
            });
            
            grid.innerHTML = html || '<p style="color: var(--text-secondary);">No favorites yet. Click the star icon on any asset to add it to favorites.</p>';
        }

        // Render by type
        function renderByType() {
            // Indices
            const indicesGrid = document.getElementById('indices-grid');
            let indicesHtml = '';
            watchlist.filter(a => a.type === 'index').forEach(asset => {
                const data = assetData[asset.symbol];
                if (data) {
                    indicesHtml += createWatchlistCard(asset.symbol, data, 'index');
                }
            });
            indicesGrid.innerHTML = indicesHtml || '<p style="color: var(--text-secondary);">No indices in watchlist</p>';
            
            // Crypto
            const cryptoGrid = document.getElementById('crypto-grid');
            let cryptoHtml = '';
            watchlist.filter(a => a.type === 'crypto').forEach(asset => {
                const data = assetData[asset.symbol];
                if (data) {
                    cryptoHtml += createWatchlistCard(asset.symbol, data, 'crypto');
                }
            });
            cryptoGrid.innerHTML = cryptoHtml || '<p style="color: var(--text-secondary);">No cryptocurrencies in watchlist</p>';
            
            // Forex
            const forexGrid = document.getElementById('forex-grid');
            let forexHtml = '';
            watchlist.filter(a => a.type === 'forex').forEach(asset => {
                const data = assetData[asset.symbol];
                if (data) {
                    forexHtml += createWatchlistCard(asset.symbol, data, 'forex');
                }
            });
            forexGrid.innerHTML = forexHtml || '<p style="color: var(--text-secondary);">No forex pairs in watchlist</p>';
        }

        // Create watchlist card
        function createWatchlistCard(symbol, data, type) {
            const displaySymbol = symbol.replace('X:', '').replace('C:', '');
            const change = calculateChange(data.open, data.close);
            const isPositive = change.value >= 0;
            const isFavorite = favorites.includes(symbol);
            
            let badge = '';
            if (type === 'stock') badge = '<span class="watchlist-badge badge-stock">STOCK</span>';
            else if (type === 'crypto') badge = '<span class="watchlist-badge badge-crypto">CRYPTO</span>';
            else if (type === 'forex') badge = '<span class="watchlist-badge badge-forex">FOREX</span>';
            else if (type === 'index') badge = '<span class="watchlist-badge badge-stock">INDEX</span>';
            
            return `
                <div class="watchlist-card" onclick="openChartModal('${symbol}')">
                    <div class="card-actions" onclick="event.stopPropagation()">
                        <button class="action-btn ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite('${symbol}')" title="Favorite">
                            ‚≠ê
                        </button>
                        <button class="action-btn" onclick="removeFromWatchlist('${symbol}')" title="Remove">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="watchlist-card-header">
                        <div class="watchlist-symbol">${displaySymbol}</div>
                        ${badge}
                    </div>
                    <div class="watchlist-price">${formatCurrency(data.close, type === 'crypto' ? 4 : 2)}</div>
                    <div class="watchlist-change ${isPositive ? 'positive' : 'negative'}">
                        <span>${isPositive ? '‚ñ≤' : '‚ñº'}</span>
                        <span>${formatCurrency(Math.abs(change.value), type === 'crypto' ? 4 : 2)}</span>
                        <span>(${Math.abs(change.percent).toFixed(2)}%)</span>
                    </div>
                    <div class="watchlist-metrics">
                        <div class="metric-item">
                            <span class="metric-label">Volume:</span>
                            <span class="metric-value">${formatNumber(data.volume)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">High:</span>
                            <span class="metric-value">${formatCurrency(data.high, type === 'crypto' ? 4 : 2)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Low:</span>
                            <span class="metric-value">${formatCurrency(data.low, type === 'crypto' ? 4 : 2)}</span>
                        </div>
                        <div class="metric-item">
                            <span class="metric-label">Open:</span>
                            <span class="metric-value">${formatCurrency(data.open, type === 'crypto' ? 4 : 2)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Calculate change
        function calculateChange(open, close) {
            if (!open || !close) return { value: 0, percent: 0 };
            const change = close - open;
            const percent = (change / open) * 100;
            return { value: change, percent: percent };
        }

        // Format currency
        function formatCurrency(value, decimals = 2) {
            if (value == null) return '-';
            return '$' + parseFloat(value).toFixed(decimals);
        }

        // Format number
        function formatNumber(value) {
            if (value == null) return '-';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            if (value >= 1e3) return (value / 1e3).toFixed(2) + 'K';
            return parseFloat(value).toFixed(2);
        }

        // Refresh all data
        async function refreshAll() {
            console.log('Refreshing all data...');
            assetData = {}; // Clear cache
            await loadAllData();
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('last-update').textContent = 'Last update: ' + now.toLocaleTimeString();
        }

        // Auto-refresh every 5 minutes
        setInterval(refreshAll, 300000);
    </script>
</body>
</html>
