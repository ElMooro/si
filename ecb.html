<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECB Systemic Risk Monitor - Professional Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.0/dist/simple-statistics.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-bottom: 2px solid #3b82f6;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .status-item {
            background: rgba(30, 41, 59, 0.8);
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-value {
            font-weight: 600;
            color: #60a5fa;
        }
        
        .controls {
            background: rgba(30, 41, 59, 0.5);
            padding: 20px;
            border-bottom: 1px solid #334155;
        }
        
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #334155;
            border-radius: 8px;
            color: #e2e8f0;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .filters {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .filter-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .indicators-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            border: 1px solid #334155;
            overflow: hidden;
            max-height: calc(100vh - 250px);
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            padding: 15px 20px;
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid #334155;
            font-weight: 600;
            color: #60a5fa;
        }
        
        .indicators-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .indicator-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .indicator-card:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        .indicator-card.selected {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        .indicator-name {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .editable-name {
            background: transparent;
            border: 1px solid transparent;
            color: inherit;
            padding: 2px 4px;
            border-radius: 4px;
            flex: 1;
        }
        
        .editable-name:hover {
            background: rgba(51, 65, 85, 0.3);
            border-color: #475569;
        }
        
        .editable-name:focus {
            outline: none;
            background: rgba(15, 23, 42, 0.8);
            border-color: #3b82f6;
        }
        
        .indicator-value {
            font-size: 20px;
            font-weight: 700;
            color: #60a5fa;
            margin: 8px 0;
        }
        
        .indicator-change {
            display: flex;
            gap: 10px;
            font-size: 13px;
        }
        
        .change-item {
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(51, 65, 85, 0.3);
        }
        
        .change-positive {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        
        .change-negative {
            color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .interpretation {
            margin-top: 8px;
            padding: 8px;
            background: rgba(51, 65, 85, 0.2);
            border-radius: 6px;
            font-size: 13px;
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .interpretation-icon {
            font-size: 16px;
        }
        
        .chart-panel {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            border: 1px solid #334155;
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 20px;
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
        }
        
        .chart-btn {
            padding: 6px 12px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }
        
        .chart-btn.active {
            background: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
            color: #60a5fa;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .analysis-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
        }
        
        .analysis-label {
            color: #94a3b8;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .analysis-value {
            font-size: 24px;
            font-weight: 700;
            color: #e2e8f0;
        }
        
        .analysis-description {
            font-size: 13px;
            color: #64748b;
            margin-top: 5px;
        }
        
        .risk-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-critical {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .risk-high {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
        }
        
        .risk-medium {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .risk-low {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #64748b;
        }
        
        .spinner {
            border: 3px solid #334155;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .trend-signal {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .trend-reversal {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .indicators-panel {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üè¶ ECB Systemic Risk Monitor</h1>
        <div class="status-bar">
            <div class="status-item">
                <span>Total Indicators:</span>
                <span class="status-value" id="total-indicators">0</span>
            </div>
            <div class="status-item">
                <span>System Risk:</span>
                <span class="status-value" id="system-risk">Loading...</span>
            </div>
            <div class="status-item">
                <span>Average Stress:</span>
                <span class="status-value" id="avg-stress">0.0000</span>
            </div>
            <div class="status-item">
                <span>Last Update:</span>
                <span class="status-value" id="last-update">--</span>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="search-container">
            <input type="text" class="search-input" id="search-input" 
                   placeholder="Search indicators... (e.g., Germany, CISS, unemployment, Italy)">
            <button class="btn" onclick="searchIndicators()">Search</button>
            <button class="btn" onclick="loadAllIndicators()">Show All</button>
        </div>
        
        <div class="filters">
            <button class="filter-btn active" onclick="filterByDataset('all', this)">All</button>
            <button class="filter-btn" onclick="filterByDataset('CISS', this)">CISS Stress</button>
            <button class="filter-btn" onclick="filterByDataset('BSI', this)">Balance Sheet</button>
            <button class="filter-btn" onclick="filterByDataset('MIR', this)">Interest Rates</button>
            <button class="filter-btn" onclick="filterByDataset('UNEMPLOYMENT', this)">Unemployment</button>
            <button class="filter-btn" onclick="filterByDataset('ILM', this)">Liquidity</button>
            <button class="filter-btn" onclick="filterHighRisk(this)">‚ö†Ô∏è High Risk Only</button>
        </div>
    </div>
    
    <div class="main-content">
        <div class="indicators-panel">
            <div class="panel-header">
                ECB Indicators (<span id="filtered-count">0</span>)
            </div>
            <div class="indicators-list" id="indicators-list">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading ECB data...
                </div>
            </div>
        </div>
        
        <div class="chart-panel">
            <div class="chart-header">
                <div class="chart-title" id="chart-title">Select an indicator to view analysis</div>
                <div class="chart-controls">
                    <button class="chart-btn active" onclick="setChartPeriod('all', this)">All</button>
                    <button class="chart-btn" onclick="setChartPeriod('5y', this)">5Y</button>
                    <button class="chart-btn" onclick="setChartPeriod('1y', this)">1Y</button>
                    <button class="chart-btn" onclick="setChartPeriod('6m', this)">6M</button>
                    <button class="chart-btn" onclick="setChartPeriod('3m', this)">3M</button>
                    <button class="chart-btn" onclick="detectTrendReversal()">üîç Detect Reversal</button>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="main-chart"></canvas>
            </div>
            
            <div class="analysis-grid" id="analysis-grid">
                <!-- Analysis cards will be populated here -->
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_BASE = 'https://dv7wxb807j.execute-api.us-east-1.amazonaws.com/prod';
        
        // Global variables
        let allIndicators = [];
        let filteredIndicators = [];
        let selectedIndicator = null;
        let chart = null;
        let currentPeriod = 'all';
        let customNames = {};
        
        // Interpretation rules
        const interpretations = {
            'CISS': (value, change) => {
                if (value > 0.4) return { text: 'üö® FINANCIAL CRISIS - Systemic stress critical', icon: 'üö®' };
                if (value > 0.3) return { text: '‚ö†Ô∏è BLACK SWAN RISK - High systemic stress', icon: '‚ö†Ô∏è' };
                if (value > 0.2) return { text: 'üü° STRESS BUILDING - Monitor closely', icon: 'üü°' };
                if (value > 0.1) return { text: 'üìä ELEVATED STRESS - Early warning', icon: 'üìä' };
                if (change > 10) return { text: 'üìà RAPID DETERIORATION - Stress accelerating', icon: 'üìà' };
                if (change < -10) return { text: 'üìâ STRESS EASING - Conditions improving', icon: 'üìâ' };
                return { text: '‚úÖ NORMAL CONDITIONS - Low stress', icon: '‚úÖ' };
            },
            'MIR': (value, change) => {
                if (value > 8) return { text: 'üí∏ TIGHT CREDIT - High borrowing costs', icon: 'üí∏' };
                if (value > 6) return { text: 'üìä RISING RATES - Credit tightening', icon: 'üìä' };
                if (value < 2) return { text: 'üí∞ EASY MONEY - Ultra-low rates', icon: 'üí∞' };
                if (change > 20) return { text: 'üöÄ RATE SHOCK - Rapid tightening', icon: 'üöÄ' };
                return { text: 'üí± NORMAL RATES - Standard conditions', icon: 'üí±' };
            },
            'BSI': (value, change) => {
                if (change < -10) return { text: 'üíß LIQUIDITY CONTRACTING - Bank deleveraging', icon: 'üíß' };
                if (change < -5) return { text: 'üìâ BALANCE SHEET SHRINKING - Credit contraction', icon: 'üìâ' };
                if (change > 10) return { text: 'üí∞ CREDIT EXPANSION - Balance sheet growth', icon: 'üí∞' };
                return { text: 'üè¶ STABLE BANKING - Normal operations', icon: 'üè¶' };
            },
            'UNEMPLOYMENT': (value, change) => {
                if (value > 15) return { text: 'üî¥ CRISIS UNEMPLOYMENT - Severe joblessness', icon: 'üî¥' };
                if (value > 10) return { text: '‚ö†Ô∏è HIGH UNEMPLOYMENT - Economic stress', icon: '‚ö†Ô∏è' };
                if (value > 7) return { text: 'üü° ELEVATED JOBLESSNESS - Weakening labor market', icon: 'üü°' };
                if (value < 4) return { text: 'üí™ FULL EMPLOYMENT - Strong labor market', icon: 'üí™' };
                return { text: 'üë• NORMAL EMPLOYMENT - Stable conditions', icon: 'üë•' };
            },
            'ILM': (value, change) => {
                if (change < -10) return { text: 'üè¶ DOLLAR SHORTAGE - Funding stress', icon: 'üè¶' };
                if (change < -5) return { text: 'üíµ LIQUIDITY TIGHTENING - Funding pressure', icon: 'üíµ' };
                if (change > 10) return { text: 'üíß LIQUIDITY FLOODING - Excess reserves', icon: 'üíß' };
                return { text: 'üí± NORMAL LIQUIDITY - Balanced conditions', icon: 'üí±' };
            }
        };
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadAllIndicators();
            loadCustomNames();
            setInterval(updateTime, 1000);
        });
        
        // Load all indicators
        async function loadAllIndicators() {
            try {
                const response = await fetch(`${API_BASE}/list?limit=200`);
                const data = await response.json();
                
                allIndicators = data.indicators || [];
                filteredIndicators = allIndicators;
                
                // Update status
                document.getElementById('total-indicators').textContent = allIndicators.length;
                
                // Calculate risk assessment
                await updateRiskAssessment();
                
                // Display indicators
                displayIndicators(filteredIndicators);
                
                // Auto-select first indicator
                if (filteredIndicators.length > 0) {
                    selectIndicator(filteredIndicators[0]);
                }
                
            } catch (error) {
                console.error('Error loading indicators:', error);
                document.getElementById('indicators-list').innerHTML = 
                    '<div class="loading">Error loading data. Please refresh.</div>';
            }
        }
        
        // Update risk assessment
        async function updateRiskAssessment() {
            try {
                const response = await fetch(`${API_BASE}/risk-assessment`);
                const data = await response.json();
                
                const riskLevel = data.systemic_risk || 'UNKNOWN';
                const avgStress = data.average_stress || 0;
                
                const riskElement = document.getElementById('system-risk');
                riskElement.textContent = riskLevel;
                riskElement.className = 'status-value risk-' + riskLevel.toLowerCase();
                
                document.getElementById('avg-stress').textContent = avgStress.toFixed(4);
                
            } catch (error) {
                console.error('Error updating risk assessment:', error);
            }
        }
        
        // Display indicators in the list
        function displayIndicators(indicators) {
            const listElement = document.getElementById('indicators-list');
            document.getElementById('filtered-count').textContent = indicators.length;
            
            if (indicators.length === 0) {
                listElement.innerHTML = '<div class="loading">No indicators found</div>';
                return;
            }
            
            listElement.innerHTML = indicators.map(indicator => {
                const customName = customNames[indicator.symbol] || indicator.name;
                const interpretation = getInterpretation(indicator);
                const changeValue = getChangeValue(indicator);
                
                return `
                    <div class="indicator-card ${selectedIndicator?.symbol === indicator.symbol ? 'selected' : ''}" 
                         onclick="selectIndicator(${JSON.stringify(indicator).replace(/"/g, '&quot;')})">
                        <div class="indicator-name">
                            <input type="text" class="editable-name" 
                                   value="${customName}"
                                   onclick="event.stopPropagation()"
                                   onchange="updateCustomName('${indicator.symbol}', this.value)"
                                   title="Click to edit name">
                            <span class="risk-indicator risk-${getRiskLevel(indicator.value, indicator.dataset)}">${indicator.country || 'EU'}</span>
                        </div>
                        <div class="indicator-value">${formatValue(indicator.value, indicator.dataset)}</div>
                        <div class="indicator-change">
                            ${changeValue ? `
                                <span class="change-item ${changeValue.percent > 0 ? 'change-positive' : 'change-negative'}">
                                    ${changeValue.label}: ${changeValue.percent > 0 ? '+' : ''}${changeValue.percent.toFixed(2)}%
                                </span>
                            ` : ''}
                            <span class="change-item">${indicator.observations || 0} obs</span>
                        </div>
                        ${interpretation ? `
                            <div class="interpretation">
                                <span class="interpretation-icon">${interpretation.icon}</span>
                                <span>${interpretation.text}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Select an indicator and load its data
        async function selectIndicator(indicator) {
            selectedIndicator = indicator;
            
            // Update selected state in UI
            document.querySelectorAll('.indicator-card').forEach(card => {
                card.classList.remove('selected');
            });
            event?.currentTarget?.classList.add('selected');
            
            // Load historical data
            try {
                const response = await fetch(`${API_BASE}/historical/${indicator.symbol}`);
                const data = await response.json();
                
                // Update chart
                updateChart(data);
                
                // Update analysis
                updateAnalysis(data);
                
            } catch (error) {
                console.error('Error loading historical data:', error);
            }
        }
        
        // Update the main chart
        function updateChart(data) {
            const ctx = document.getElementById('main-chart').getContext('2d');
            const customName = customNames[data.symbol] || data.name;
            
            document.getElementById('chart-title').textContent = customName || data.symbol;
            
            // Prepare data
            let chartData = data.historical_data || [];
            
            // Apply period filter
            if (currentPeriod !== 'all' && chartData.length > 0) {
                const periods = {
                    '5y': 60,
                    '1y': 12,
                    '6m': 6,
                    '3m': 3
                };
                const months = periods[currentPeriod];
                chartData = chartData.slice(-months);
            }
            
            // Calculate moving averages
            const ma7 = calculateMovingAverage(chartData.map(d => d.value), 7);
            const ma30 = calculateMovingAverage(chartData.map(d => d.value), 30);
            
            // Destroy existing chart
            if (chart) {
                chart.destroy();
            }
            
            // Create new chart
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.map(d => d.date),
                    datasets: [
                        {
                            label: 'Value',
                            data: chartData.map(d => d.value),
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 0,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'MA7',
                            data: ma7,
                            borderColor: '#10b981',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'MA30',
                            data: ma30,
                            borderColor: '#f59e0b',
                            borderWidth: 1,
                            borderDash: [10, 5],
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e2e8f0'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#60a5fa',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += formatValue(context.parsed.y, selectedIndicator.dataset);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#94a3b8',
                                maxTicksLimit: 10
                            },
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#94a3b8',
                                callback: function(value) {
                                    return formatValue(value, selectedIndicator.dataset);
                                }
                            },
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)'
                            }
                        }
                    }
                }
            });
        }
        
        // Update analysis panel
        function updateAnalysis(data) {
            const changes = data.changes || {};
            const historical = data.historical_data || [];
            
            // Calculate additional metrics
            const values = historical.map(d => d.value);
            const yoyChange = calculateYoYChange(historical);
            const volatility = calculateVolatility(values);
            const trend = detectTrend(values);
            const rsi = calculateRSI(values);
            
            const analysisHTML = `
                <div class="analysis-card">
                    <div class="analysis-label">Current Value</div>
                    <div class="analysis-value">${formatValue(changes.current || 0, selectedIndicator.dataset)}</div>
                    <div class="analysis-description">Latest observation</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Week Change</div>
                    <div class="analysis-value ${changes.wow_percent > 0 ? 'change-positive' : 'change-negative'}">
                        ${changes.wow_percent > 0 ? '+' : ''}${changes.wow_percent?.toFixed(2) || 0}%
                    </div>
                    <div class="analysis-description">7-day change</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Month Change</div>
                    <div class="analysis-value ${changes.mom_percent > 0 ? 'change-positive' : 'change-negative'}">
                        ${changes.mom_percent > 0 ? '+' : ''}${changes.mom_percent?.toFixed(2) || 0}%
                    </div>
                    <div class="analysis-description">30-day change</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Quarter Change</div>
                    <div class="analysis-value ${changes.qoq_percent > 0 ? 'change-positive' : 'change-negative'}">
                        ${changes.qoq_percent > 0 ? '+' : ''}${changes.qoq_percent?.toFixed(2) || 0}%
                    </div>
                    <div class="analysis-description">90-day change</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Year-over-Year</div>
                    <div class="analysis-value ${yoyChange > 0 ? 'change-positive' : 'change-negative'}">
                        ${yoyChange > 0 ? '+' : ''}${yoyChange.toFixed(2)}%
                    </div>
                    <div class="analysis-description">Annual change</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Volatility</div>
                    <div class="analysis-value">${volatility.toFixed(4)}</div>
                    <div class="analysis-description">Standard deviation</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">RSI (14)</div>
                    <div class="analysis-value" style="color: ${rsi > 70 ? '#ef4444' : rsi < 30 ? '#10b981' : '#60a5fa'}">
                        ${rsi.toFixed(2)}
                    </div>
                    <div class="analysis-description">${rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral'}</div>
                </div>
                
                <div class="analysis-card">
                    <div class="analysis-label">Trend</div>
                    <div class="analysis-value">
                        ${trend.direction === 'up' ? 'üìà' : trend.direction === 'down' ? 'üìâ' : '‚û°Ô∏è'} 
                        ${trend.direction.toUpperCase()}
                    </div>
                    <div class="analysis-description">
                        ${trend.reversal ? '<span class="trend-signal trend-reversal">‚ö†Ô∏è REVERSAL DETECTED</span>' : `Strength: ${trend.strength.toFixed(2)}`}
                    </div>
                </div>
            `;
            
            document.getElementById('analysis-grid').innerHTML = analysisHTML;
        }
        
        // Search indicators
        function searchIndicators() {
            const query = document.getElementById('search-input').value.toLowerCase();
            
            if (!query) {
                filteredIndicators = allIndicators;
            } else {
                filteredIndicators = allIndicators.filter(ind => {
                    const customName = customNames[ind.symbol] || ind.name;
                    return ind.symbol.toLowerCase().includes(query) ||
                           customName.toLowerCase().includes(query) ||
                           (ind.country && ind.country.toLowerCase().includes(query)) ||
                           (ind.dataset && ind.dataset.toLowerCase().includes(query));
                });
            }
            
            displayIndicators(filteredIndicators);
        }
        
        // Filter by dataset
        function filterByDataset(dataset, button) {
            // Update button states
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            if (dataset === 'all') {
                filteredIndicators = allIndicators;
            } else {
                filteredIndicators = allIndicators.filter(ind => ind.dataset === dataset);
            }
            
            displayIndicators(filteredIndicators);
        }
        
        // Filter high risk indicators
        function filterHighRisk(button) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            filteredIndicators = allIndicators.filter(ind => {
                const risk = getRiskLevel(ind.value, ind.dataset);
                return risk === 'high' || risk === 'critical';
            });
            
            displayIndicators(filteredIndicators);
        }
        
        // Set chart period
        function setChartPeriod(period, button) {
            currentPeriod = period;
            
            // Update button states
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            button?.classList.add('active');
            
            // Reload chart if indicator selected
            if (selectedIndicator) {
                selectIndicator(selectedIndicator);
            }
        }
        
        // Detect trend reversal
        async function detectTrendReversal() {
            if (!selectedIndicator) {
                alert('Please select an indicator first');
                return;
            }
            
            const response = await fetch(`${API_BASE}/historical/${selectedIndicator.symbol}`);
            const data = await response.json();
            const values = (data.historical_data || []).map(d => d.value);
            
            const trend = detectTrend(values);
            
            if (trend.reversal) {
                alert(`‚ö†Ô∏è TREND REVERSAL DETECTED!\n\nThe ${selectedIndicator.name} shows a ${trend.direction} reversal with strength ${trend.strength.toFixed(2)}.\n\nThis could indicate a significant market shift.`);
            } else {
                alert(`No reversal detected. Current trend: ${trend.direction} with strength ${trend.strength.toFixed(2)}`);
            }
        }
        
        // Update custom name
        function updateCustomName(symbol, name) {
            customNames[symbol] = name;
            localStorage.setItem('ecb_custom_names', JSON.stringify(customNames));
        }
        
        // Load custom names from localStorage
        function loadCustomNames() {
            const saved = localStorage.getItem('ecb_custom_names');
            if (saved) {
                customNames = JSON.parse(saved);
            }
        }
        
        // Helper Functions
        
        function formatValue(value, dataset) {
            if (value === null || value === undefined) return 'N/A';
            
            if (dataset === 'MIR' || dataset === 'UNEMPLOYMENT') {
                return value.toFixed(2) + '%';
            } else if (dataset === 'BSI' || dataset === 'ILM') {
                return value.toLocaleString();
            } else {
                return value.toFixed(4);
            }
        }
        
        function getRiskLevel(value, dataset) {
            if (dataset === 'CISS') {
                if (value > 0.3) return 'critical';
                if (value > 0.2) return 'high';
                if (value > 0.1) return 'medium';
                return 'low';
            } else if (dataset === 'UNEMPLOYMENT') {
                if (value > 15) return 'critical';
                if (value > 10) return 'high';
                if (value > 7) return 'medium';
                return 'low';
            }
            return 'low';
        }
        
        function getInterpretation(indicator) {
            const interpreter = interpretations[indicator.dataset];
            if (!interpreter) return null;
            
            const change = getChangeValue(indicator);
            return interpreter(indicator.value, change?.percent || 0);
        }
        
        function getChangeValue(indicator) {
            // This would need historical data, for now return mock
            return {
                label: 'MoM',
                percent: Math.random() * 20 - 10
            };
        }
        
        function calculateMovingAverage(values, period) {
            const ma = [];
            for (let i = 0; i < values.length; i++) {
                if (i < period - 1) {
                    ma.push(null);
                } else {
                    const sum = values.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                    ma.push(sum / period);
                }
            }
            return ma;
        }
        
        function calculateYoYChange(historical) {
            if (historical.length < 12) return 0;
            const current = historical[historical.length - 1].value;
            const yearAgo = historical[historical.length - 12].value;
            return ((current - yearAgo) / yearAgo) * 100;
        }
        
        function calculateVolatility(values) {
            if (values.length < 2) return 0;
            const mean = values.reduce((a, b) => a + b, 0) / values.length;
            const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
            return Math.sqrt(variance);
        }
        
        function calculateRSI(values, period = 14) {
            if (values.length < period + 1) return 50;
            
            let gains = 0;
            let losses = 0;
            
            for (let i = values.length - period; i < values.length; i++) {
                const change = values[i] - values[i - 1];
                if (change > 0) {
                    gains += change;
                } else {
                    losses -= change;
                }
            }
            
            const avgGain = gains / period;
            const avgLoss = losses / period;
            
            if (avgLoss === 0) return 100;
            
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }
        
        function detectTrend(values) {
            if (values.length < 10) return { direction: 'neutral', strength: 0, reversal: false };
            
            // Calculate recent trend
            const recent = values.slice(-10);
            const older = values.slice(-20, -10);
            
            const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
            const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
            
            const change = ((recentAvg - olderAvg) / olderAvg) * 100;
            
            // Check for reversal
            const ma7 = calculateMovingAverage(values, 7);
            const ma30 = calculateMovingAverage(values, 30);
            
            const recentMA7 = ma7.slice(-5).filter(v => v !== null);
            const recentMA30 = ma30.slice(-5).filter(v => v !== null);
            
            let reversal = false;
            if (recentMA7.length >= 2 && recentMA30.length >= 2) {
                const ma7Trend = recentMA7[recentMA7.length - 1] > recentMA7[0];
                const ma30Trend = recentMA30[recentMA30.length - 1] > recentMA30[0];
                
                // Check for MA crossover
                if (ma7Trend !== ma30Trend && Math.abs(change) > 5) {
                    reversal = true;
                }
            }
            
            return {
                direction: change > 2 ? 'up' : change < -2 ? 'down' : 'neutral',
                strength: Math.abs(change),
                reversal: reversal
            };
        }
        
        function updateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === '/' && e.ctrlKey) {
                e.preventDefault();
                document.getElementById('search-input').focus();
            }
        });
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadAllIndicators();
        }, 300000);
    </script>
</body>
</html>