<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECB Systemic Risk Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e27;
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        .header {
            background: rgba(20, 24, 44, 0.95);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .api-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ffaa00;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .risk-summary {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .risk-level {
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        
        .risk-level.low { color: #00ff88; }
        .risk-level.medium { color: #ffaa00; }
        .risk-level.high { color: #ff4444; }
        
        .country-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .country-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .country-card:hover {
            background: rgba(0, 255, 136, 0.1);
            transform: translateY(-2px);
        }
        
        .country-flag {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .country-name {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .country-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid #ff4444;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }
        
        #mainChart {
            height: 400px;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo">üè¶ ECB Systemic Risk Monitor</div>
        <div class="api-status">
            <span>API Status:</span>
            <div id="apiStatus" class="status-dot"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </header>

    <div class="container">
        <div class="risk-summary">
            <h2>Eurozone Systemic Risk Assessment</h2>
            <div id="riskLevel" class="risk-level">Loading...</div>
            <p id="riskDescription">Fetching latest ECB data...</p>
            <p style="margin-top: 1rem; opacity: 0.7;">Data cached weekly ‚Ä¢ 159 indicators ‚Ä¢ 296 observations</p>
        </div>

        <h3 style="margin-bottom: 1rem;">Country Risk Indicators (CISS)</h3>
        <div id="countryGrid" class="country-grid">
            <div class="loading">Loading country data...</div>
        </div>

        <div class="chart-container">
            <h3>Systemic Stress Levels by Country</h3>
            <div id="mainChart"></div>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://dv7wxb807j.execute-api.us-east-1.amazonaws.com/prod';
        
        const COUNTRY_MAP = {
            'DE': { name: 'Germany', flag: 'üá©üá™' },
            'IT': { name: 'Italy', flag: 'üáÆüáπ' },
            'ES': { name: 'Spain', flag: 'üá™üá∏' },
            'FR': { name: 'France', flag: 'üá´üá∑' },
            'GR': { name: 'Greece', flag: 'üá¨üá∑' },
            'PT': { name: 'Portugal', flag: 'üáµüáπ' },
            'IE': { name: 'Ireland', flag: 'üáÆüá™' },
            'NL': { name: 'Netherlands', flag: 'üá≥üá±' },
            'BE': { name: 'Belgium', flag: 'üáßüá™' },
            'AT': { name: 'Austria', flag: 'üá¶üáπ' },
            'FI': { name: 'Finland', flag: 'üá´üáÆ' },
            'LU': { name: 'Luxembourg', flag: 'üá±üá∫' }
        };
        
        // Initialize dashboard
        async function init() {
            console.log('Initializing ECB Dashboard...');
            
            // Test API connection
            const connected = await testConnection();
            if (!connected) {
                showError('Failed to connect to ECB API');
                return;
            }
            
            // Load risk assessment
            await loadRiskAssessment();
            
            // Load country data
            await loadCountryData();
        }
        
        // Test API connection
        async function testConnection() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                if (data.status === 'OK') {
                    document.getElementById('apiStatus').className = 'status-dot connected';
                    document.getElementById('statusText').textContent = `Connected (${data.indicators} indicators)`;
                    return true;
                }
            } catch (error) {
                console.error('Connection error:', error);
                document.getElementById('apiStatus').className = 'status-dot error';
                document.getElementById('statusText').textContent = 'Connection failed';
            }
            return false;
        }
        
        // Load risk assessment
        async function loadRiskAssessment() {
            try {
                const response = await fetch(`${API_URL}/risk-assessment`);
                const data = await response.json();
                
                // Update risk level display
                const riskElement = document.getElementById('riskLevel');
                riskElement.textContent = data.systemic_risk || 'UNKNOWN';
                riskElement.className = `risk-level ${data.systemic_risk.toLowerCase()}`;
                
                // Update description
                const avgStress = (data.average_stress * 100).toFixed(2);
                document.getElementById('riskDescription').textContent = 
                    `Average stress level: ${avgStress}% across Eurozone countries`;
                
                // Store country risks for display
                if (data.country_risks) {
                    displayCountryRisks(data.country_risks);
                    createChart(data.country_risks);
                }
                
            } catch (error) {
                console.error('Error loading risk assessment:', error);
            }
        }
        
        // Load country-specific data
        async function loadCountryData() {
            const symbols = [
                'ECB.CISS.M.DE.Z0Z.4F.EC.SOV_CI.IDX',
                'ECB.CISS.M.IT.Z0Z.4F.EC.SOV_CI.IDX',
                'ECB.CISS.M.ES.Z0Z.4F.EC.SOV_CI.IDX',
                'ECB.CISS.M.FR.Z0Z.4F.EC.SOV_CI.IDX'
            ];
            
            for (const symbol of symbols) {
                try {
                    const response = await fetch(`${API_URL}/data/${symbol}`);
                    const data = await response.json();
                    console.log(`${symbol}:`, data.value);
                } catch (error) {
                    console.error(`Error loading ${symbol}:`, error);
                }
            }
        }
        
        // Display country risk cards
        function displayCountryRisks(countryRisks) {
            const grid = document.getElementById('countryGrid');
            grid.innerHTML = '';
            
            countryRisks.forEach(risk => {
                const country = COUNTRY_MAP[risk.country] || { name: risk.country, flag: 'üè≥Ô∏è' };
                const card = document.createElement('div');
                card.className = 'country-card';
                
                const valuePercent = (risk.value * 100).toFixed(2);
                const colorClass = risk.value > 0.15 ? 'style="color: #ff4444"' : 
                                  risk.value > 0.10 ? 'style="color: #ffaa00"' : 
                                  'style="color: #00ff88"';
                
                card.innerHTML = `
                    <div class="country-flag">${country.flag}</div>
                    <div class="country-name">${country.name}</div>
                    <div class="country-value" ${colorClass}>${valuePercent}%</div>
                    <div style="font-size: 0.875rem; opacity: 0.7;">${risk.risk}</div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Create Plotly chart
        function createChart(countryRisks) {
            const countries = countryRisks.map(r => 
                COUNTRY_MAP[r.country]?.name || r.country
            );
            const values = countryRisks.map(r => r.value * 100);
            const colors = values.map(v => 
                v > 15 ? '#ff4444' : v > 10 ? '#ffaa00' : '#00ff88'
            );
            
            const trace = {
                x: countries,
                y: values,
                type: 'bar',
                marker: { color: colors }
            };
            
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0)',
                font: { color: '#fff' },
                xaxis: {
                    title: 'Country',
                    gridcolor: 'rgba(255, 255, 255, 0.1)'
                },
                yaxis: {
                    title: 'Stress Level (%)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)'
                },
                margin: { t: 20 }
            };
            
            Plotly.newPlot('mainChart', [trace], layout, {responsive: true});
        }
        
        // Show error message
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = `Error: ${message}`;
            container.insertBefore(errorDiv, container.firstChild);
        }
        
        // Start the dashboard
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>