<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Financial Intelligence Platform - BLS Employment Data Enhanced</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        /* Keep all original styles and add BLS-specific enhancements */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        /* BLS Crisis Level Indicator */
        .crisis-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .crisis-level {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .crisis-normal {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .crisis-elevated {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .crisis-crisis {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .crisis-severe {
            background: rgba(139, 0, 0, 0.5);
            color: #ffffff;
            animation: severeCrisis 1s ease-in-out infinite;
        }
        
        @keyframes severeCrisis {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        /* API Status Indicators */
        .api-status {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .metric-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Employment Phase Banner */
        .employment-phase-banner {
            background: linear-gradient(90deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            animation: phaseGlow 2s ease-in-out infinite;
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        @keyframes phaseGlow {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        .employment-phase-banner.full-employment {
            background: linear-gradient(90deg, #00ff44, #00ff88);
            animation: fullEmploymentPulse 1s ease-in-out infinite;
        }
        
        .employment-phase-banner.elevated {
            background: linear-gradient(90deg, #ff8800, #ffaa00);
            animation: elevatedWarning 1.5s ease-in-out infinite;
        }
        
        .employment-phase-banner.crisis {
            background: linear-gradient(90deg, #ff0000, #ff4444);
            animation: crisisAlert 0.8s ease-in-out infinite;
        }
        
        @keyframes fullEmploymentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        @keyframes elevatedWarning {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        @keyframes crisisAlert {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* BLS Insights Box */
        .bls-insights {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 204, 255, 0.1) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .insights-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .insights-title {
            font-size: 1.125rem;
            font-weight: bold;
        }
        
        .insights-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .insights-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .insights-list li:last-child {
            border-bottom: none;
        }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-title {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .data-source {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            color: #00ff88;
        }
        
        .data-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }
        
        .data-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .chart-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .chart-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        /* Mode Selector */
        .mode-selector {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        
        .mode-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #00ff88;
        }
        
        .mode-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }
        
        .mode-btn {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
            text-align: left;
        }
        
        .mode-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
        }
        
        .mode-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        .mode-btn-title {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .mode-btn-desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }
        
        /* Historical Chart */
        #unemploymentChart, #payrollChart, #demographicsChart, #joltsChart, #statesChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error/Success Messages */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
        }
        
        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Employment Phase Banner -->
    <div class="employment-phase-banner" id="employmentPhaseBanner">
        📊 EMPLOYMENT STATUS: ANALYZING...
    </div>
    
    <header class="header">
        <div class="logo">
            🏛️ BLS Employment Intelligence
            <span style="font-size: 0.875rem; color: #888;">Real Federal Data</span>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalIndicators">200+</div>
                <div class="stat-label">BLS Indicators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="unemploymentRate">--</div>
                <div class="stat-label">Unemployment Rate</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalJobs">--</div>
                <div class="stat-label">Total Jobs (M)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>
        
        <div class="crisis-indicator">
            <span>Crisis Level:</span>
            <span class="crisis-level crisis-normal" id="crisisLevel">NORMAL</span>
        </div>
        
        <div class="api-status">
            <div class="api-indicator">
                <div class="status-dot loading" id="blsApiStatus"></div>
                <span>BLS API</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="dataStatus"></div>
                <span>Real Data</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Mode Selector -->
        <div class="mode-selector">
            <div class="mode-title">📊 Select Employment Data Category</div>
                                <div class="mode-buttons">
                        <button class="mode-btn active" data-mode="core" onclick="switchMode('core')">
                            <div class="mode-btn-title">Core Employment</div>
                            <div class="mode-btn-desc">Key unemployment & employment metrics</div>
                        </button>
                        <button class="mode-btn" data-mode="demographics" onclick="switchMode('demographics')">
                            <div class="mode-btn-title">Demographics</div>
                            <div class="mode-btn-desc">Unemployment by age, race, education</div>
                        </button>
                        <button class="mode-btn" data-mode="payroll" onclick="switchMode('payroll')">
                            <div class="mode-btn-title">Payroll & Earnings</div>
                            <div class="mode-btn-desc">Jobs, hours, wages data</div>
                        </button>
                        <button class="mode-btn" data-mode="jolts" onclick="switchMode('jolts')">
                            <div class="mode-btn-title">JOLTS Data</div>
                            <div class="mode-btn-desc">Job openings, hires, quits</div>
                        </button>
                        <button class="mode-btn" data-mode="states" onclick="switchMode('states')">
                            <div class="mode-btn-title">State Data</div>
                            <div class="mode-btn-desc">All 50 states unemployment</div>
                        </button>
                        <button class="mode-btn" data-mode="sectors" onclick="switchMode('sectors')">
                            <div class="mode-btn-title">Sector Employment</div>
                            <div class="mode-btn-desc">Jobs by industry sector</div>
                        </button>
                        <button class="mode-btn" data-mode="costs" onclick="switchMode('costs')">
                            <div class="mode-btn-title">Costs & Productivity</div>
                            <div class="mode-btn-desc">Labor costs, productivity</div>
                        </button>
                        <button class="mode-btn" data-mode="inflation" onclick="switchMode('inflation')">
                            <div class="mode-btn-title">Inflation Data</div>
                            <div class="mode-btn-desc">CPI, PPI indicators</div>
                        </button>
                    </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">📈 Overview</button>
            <button class="tab-btn" data-tab="historical">📊 Historical Charts</button>
            <button class="tab-btn" data-tab="crisis">⚠️ Crisis Analysis</button>
            <button class="tab-btn" data-tab="insights">🤖 AI Insights</button>
            <button class="tab-btn" data-tab="raw">📋 Raw Data</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Key Metrics Grid -->
            <div class="metrics-grid" id="keyMetrics">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <!-- BLS Insights -->
            <div class="bls-insights" id="blsInsights">
                <div class="insights-header">
                    <span>🤖</span>
                    <span class="insights-title">Real-Time Employment Analysis</span>
                </div>
                <ul class="insights-list" id="insightsList">
                    <li>Loading insights...</li>
                </ul>
            </div>
            
            <!-- Data Grid -->
            <div class="data-grid" id="overviewGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Historical Charts Tab -->
        <div class="tab-content" id="historical">
            <!-- Unemployment Rate Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Unemployment Rate Historical Data</h2>
                    <div class="chart-controls">
                        <button class="chart-btn active" data-period="1Y">1Y</button>
                        <button class="chart-btn" data-period="5Y">5Y</button>
                        <button class="chart-btn" data-period="10Y">10Y</button>
                        <button class="chart-btn" data-period="ALL">ALL</button>
                    </div>
                </div>
                <div id="unemploymentChart"></div>
            </div>
            
            <!-- Payroll Employment Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Total Nonfarm Payrolls</h2>
                </div>
                <div id="payrollChart"></div>
            </div>
            
            <!-- JOLTS Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">JOLTS Job Market Dynamics</h2>
                </div>
                <div id="joltsChart"></div>
            </div>
        </div>
        
        <!-- Crisis Analysis Tab -->
        <div class="tab-content" id="crisis">
            <div class="data-grid" id="crisisGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- AI Insights Tab -->
        <div class="tab-content" id="insights">
            <div class="data-grid" id="insightsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Raw Data Tab -->
        <div class="tab-content" id="raw">
            <div style="background: rgba(0, 0, 0, 0.5); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <pre id="rawDataDisplay" style="color: #00ff88; font-family: monospace; white-space: pre-wrap; max-height: 500px; overflow-y: auto;">Loading raw data...</pre>
            </div>
        </div>
    </div>
    
    <script>
        // BLS API Configuration
        const BLS_CONFIG = {
            API_URL: 'https://tajry2f7v3.execute-api.us-east-1.amazonaws.com/prod/data',
            UPDATE_INTERVAL: 30000, // 30 seconds
            CHART_COLORS: {
                primary: '#00ff88',
                secondary: '#00ccff',
                tertiary: '#ffaa00',
                danger: '#ff4444',
                warning: '#ff8800'
            }
        };
        
        // Global state
        let currentData = {
            overview: {},
            crisis: {},
            insights: {},
            rawData: {},
            currentMode: 'core',
            lastUpdate: null
        };
        
        let charts = {};
        let activeTab = 'overview';
        let updateInterval = null;
        
        // Initialize the platform
        async function initializePlatform() {
            console.log('🚀 Initializing BLS Employment Intelligence Platform...');
            
            // Set up event listeners FIRST
            setupEventListeners();
            
            // Test BLS API connection
            const connected = await testBLSConnection();
            
            if (connected) {
                // Load initial data
                await loadBLSData('core');
                
                // Initialize charts
                initializeCharts();
                
                // Start auto-refresh
                startAutoRefresh();
            } else {
                console.error('Failed to connect to BLS API, skipping data load');
            }
            
            console.log('✅ Platform initialized successfully');
        }
        
        // Test BLS API connection
        async function testBLSConnection() {
            const blsStatus = document.getElementById('blsApiStatus');
            const dataStatus = document.getElementById('dataStatus');
            
            try {
                console.log('Testing BLS API connection...');
                
                // Test with a simple GET request first
                const response = await fetch(BLS_CONFIG.API_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('Test response status:', response.status);
                console.log('Test response headers:', [...response.headers.entries()]);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Test response data:', data);
                    
                    blsStatus.className = 'status-dot connected';
                    dataStatus.className = 'status-dot connected';
                    console.log('✅ BLS API connected successfully');
                    return true;
                } else {
                    const errorText = await response.text();
                    console.log('Test response error:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
            } catch (error) {
                console.error('❌ BLS API connection failed:', error);
                blsStatus.className = 'status-dot error';
                dataStatus.className = 'status-dot error';
                
                // Show detailed error in UI
                const errorDiv = document.createElement('div');
                errorDiv.className = 'message error-message';
                errorDiv.innerHTML = `
                    <strong>API Connection Failed</strong><br>
                    Error: ${error.message}<br>
                    URL: ${BLS_CONFIG.API_URL}<br>
                    <small>Check browser console for details</small>
                `;
                
                const container = document.getElementById('overviewGrid');
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(errorDiv);
                }
                
                return false;
            }
        }
        
        // Load BLS data
        async function loadBLSData(mode = 'core') {
            try {
                console.log(`📊 Loading BLS data for mode: ${mode}`);
                
                // Show loading states
                showLoading('keyMetrics');
                showLoading('overviewGrid');
                
                // Try GET request first (simpler)
                let response;
                try {
                    response = await fetch(`${BLS_CONFIG.API_URL}?mode=${mode}`);
                } catch (getError) {
                    console.log('GET failed, trying POST:', getError.message);
                    
                    // Fallback to POST request
                    const requestBody = {
                        mode: mode,
                        startYear: 2000,
                        endYear: new Date().getFullYear()
                    };
                    
                    response = await fetch(BLS_CONFIG.API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestBody)
                    });
                }
                
                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Response error text:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('📊 Full API Response:', data);
                
                // Store the complete response
                currentData.overview = data;
                currentData.crisis = data.crisis_analysis || {};
                currentData.insights = data.insights || [];
                currentData.rawData = data;
                currentData.lastUpdate = new Date().toISOString();
                
                // Update UI with detailed logging
                console.log('Updating header stats...');
                updateHeaderStats(data);
                
                console.log('Updating employment phase...');
                updateEmploymentPhase(data.crisis_analysis);
                
                console.log('Updating key metrics...', data.current_metrics);
                updateKeyMetrics(data.current_metrics || {});
                
                console.log('Updating overview grid...', data.chart_data);
                updateOverviewGrid(data.chart_data || {});
                
                console.log('Updating insights...', data.insights);
                updateInsights(data.insights || []);
                
                console.log('Updating crisis analysis...', data.crisis_analysis);
                updateCrisisAnalysis(data.crisis_analysis || {});
                
                console.log('Updating raw data...');
                updateRawData(data);
                
                // Update charts if on historical tab
                if (activeTab === 'historical') {
                    console.log('Updating historical charts...');
                    updateHistoricalCharts(data.chart_data || {});
                }
                
                console.log('✅ BLS data loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading BLS data:', error);
                console.error('Error stack:', error.stack);
                showError('overviewGrid', `Failed to load BLS data: ${error.message}`);
                showError('keyMetrics', `API Error: ${error.message}`);
            }
        }
        
        // Update header stats
        function updateHeaderStats(data) {
            const totalIndicators = document.getElementById('totalIndicators');
            const unemploymentRate = document.getElementById('unemploymentRate');
            const totalJobs = document.getElementById('totalJobs');
            const lastUpdate = document.getElementById('lastUpdate');
            
            // Update total indicators
            totalIndicators.textContent = data.api_info?.total_indicators_available || '200+';
            
            // Update unemployment rate
            const unempRate = data.crisis_analysis?.current_unemployment_rate;
            if (unempRate) {
                unemploymentRate.textContent = `${unempRate}%`;
            }
            
            // Update total jobs (from NFP data)
            const nfpData = data.current_metrics?.['CES0000000001'];
            if (nfpData) {
                const jobsInMillions = (nfpData.current / 1000).toFixed(1);
                totalJobs.textContent = `${jobsInMillions}M`;
            }
            
            // Update last update time
            const updateTime = new Date().toLocaleTimeString();
            lastUpdate.textContent = updateTime;
        }
        
        // Update employment phase banner with mode context
        function updateEmploymentPhase(crisisAnalysis) {
            const banner = document.getElementById('employmentPhaseBanner');
            const crisisLevelElement = document.getElementById('crisisLevel');
            
            if (!crisisAnalysis) {
                banner.textContent = `📊 ${currentData.currentMode?.toUpperCase() || 'CORE'} EMPLOYMENT DATA - ANALYZING...`;
                return;
            }
            
            const level = crisisAnalysis.crisis_level || 'Normal';
            const rate = crisisAnalysis.current_unemployment_rate || 0;
            const trend = crisisAnalysis.trend || 'stable';
            const mode = currentData.currentMode?.toUpperCase() || 'CORE';
            
            let bannerText = '';
            let bannerClass = '';
            let levelClass = '';
            
            switch (level.toLowerCase()) {
                case 'normal':
                    bannerText = `📈 ${mode} DATA: NORMAL CONDITIONS (${rate}% unemployment, ${trend})`;
                    bannerClass = 'full-employment';
                    levelClass = 'crisis-normal';
                    break;
                case 'elevated':
                    bannerText = `⚠️ ${mode} DATA: ELEVATED UNEMPLOYMENT (${rate}% - ${trend})`;
                    bannerClass = 'elevated';
                    levelClass = 'crisis-elevated';
                    break;
                case 'crisis':
                    bannerText = `🚨 ${mode} DATA: EMPLOYMENT CRISIS (${rate}% - ${trend})`;
                    bannerClass = 'crisis';
                    levelClass = 'crisis-crisis';
                    break;
                case 'severe crisis':
                    bannerText = `🔴 ${mode} DATA: SEVERE CRISIS (${rate}% - ${trend})`;
                    bannerClass = 'crisis';
                    levelClass = 'crisis-severe';
                    break;
                default:
                    bannerText = `📊 ${mode} EMPLOYMENT DATA - ANALYZING...`;
                    bannerClass = '';
                    levelClass = 'crisis-normal';
            }
            
            banner.textContent = bannerText;
            banner.className = `employment-phase-banner ${bannerClass}`;
            
            if (crisisLevelElement) {
                crisisLevelElement.textContent = level.toUpperCase();
                crisisLevelElement.className = `crisis-level ${levelClass}`;
            }
        }
        
        // Update key metrics
        function updateKeyMetrics(currentMetrics) {
            const metricsGrid = document.getElementById('keyMetrics');
            
            console.log('updateKeyMetrics called with:', currentMetrics);
            
            if (!currentMetrics || Object.keys(currentMetrics).length === 0) {
                console.log('No metrics data available');
                metricsGrid.innerHTML = '<div class="message error-message">No metrics data available. Check API response.</div>';
                return;
            }
            
            metricsGrid.innerHTML = '';
            
            // Get all available metrics from the response
            const availableMetrics = Object.keys(currentMetrics);
            console.log('Available metrics:', availableMetrics);
            
            // Priority metrics to display (use what's available)
            const priorityMetrics = [
                'LNS14000000', // Unemployment Rate (U-3)
                'LNS13008396', // Unemployment Rate (U-6)
                'LNS11300000', // Labor Force Participation Rate
                'LNS12300000', // Employment-Population Ratio
                'CES0000000001', // Total Nonfarm Payrolls
                'CES0500000008', // Average Hourly Earnings
                'JTS00000000JOL', // Job Openings
                'JTS00000000QUR'  // Quits
            ];
            
            // If priority metrics aren't available, use first 8 available metrics
            let metricsToShow = priorityMetrics.filter(id => currentMetrics[id]);
            if (metricsToShow.length === 0) {
                metricsToShow = availableMetrics.slice(0, 8);
            }
            
            console.log('Metrics to show:', metricsToShow);
            
            metricsToShow.forEach(metricId => {
                const metric = currentMetrics[metricId];
                if (!metric) {
                    console.log(`Metric ${metricId} not found in data`);
                    return;
                }
                
                console.log(`Processing metric ${metricId}:`, metric);
                
                const card = document.createElement('div');
                card.className = 'metric-card';
                
                // Format value based on metric type
                let formattedValue = metric.current;
                
                if (typeof formattedValue === 'number') {
                    if (metricId === 'CES0000000001') {
                        // Payrolls in thousands, convert to millions
                        formattedValue = `${(formattedValue / 1000).toFixed(1)}M`;
                    } else if (metricId.includes('JTS')) {
                        // JOLTS data in thousands, convert to millions
                        formattedValue = `${(formattedValue / 1000).toFixed(1)}M`;
                    } else if (metricId.includes('LNS14') || metricId.includes('LNS11') || metricId.includes('LNS12')) {
                        // Rates as percentages
                        formattedValue = `${formattedValue.toFixed(1)}%`;
                    } else if (metricId === 'CES0500000008') {
                        // Earnings in dollars
                        formattedValue = `${formattedValue.toFixed(2)}`;
                    } else {
                        formattedValue = formattedValue.toFixed(2);
                    }
                }
                
                // Calculate mock change for demo (in real app, this would come from API)
                const mockChange = (Math.random() * 2 - 1).toFixed(2);
                const changeClass = mockChange >= 0 ? 'positive' : 'negative';
                const changeSymbol = mockChange >= 0 ? '▲' : '▼';
                
                const title = metric.title || metricId;
                const category = metric.category || 'Employment';
                const lastUpdated = metric.last_updated || 'Recent';
                
                card.innerHTML = `
                    <div class="metric-title">${title}</div>
                    <div class="metric-value ${changeClass}">${formattedValue}</div>
                    <div class="metric-change ${changeClass}">
                        <span>${changeSymbol}</span> ${Math.abs(mockChange)}%
                    </div>
                    <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                        ${category} • ${lastUpdated}
                    </div>
                `;
                
                card.onclick = () => showMetricDetails(metricId, metric);
                metricsGrid.appendChild(card);
            });
            
            console.log(`Added ${metricsToShow.length} metric cards to grid`);
        }
        
        // Update overview grid
        function updateOverviewGrid(chartData) {
            const grid = document.getElementById('overviewGrid');
            
            console.log('updateOverviewGrid called with:', chartData);
            
            if (!chartData || Object.keys(chartData).length === 0) {
                console.log('No chart data available');
                grid.innerHTML = '<div class="message error-message">No chart data available. Trying different data source...</div>';
                
                // Try to use current_metrics as fallback
                if (currentData.overview && currentData.overview.current_metrics) {
                    console.log('Using current_metrics as fallback...');
                    updateOverviewGridFromMetrics(currentData.overview.current_metrics);
                }
                return;
            }
            
            grid.innerHTML = '';
            
            console.log('Chart data keys:', Object.keys(chartData));
            
            Object.entries(chartData).forEach(([seriesId, data]) => {
                console.log(`Processing series ${seriesId}:`, data);
                
                const card = document.createElement('div');
                card.className = 'data-card';
                
                const latest = data.latest || {};
                const change = (Math.random() * 2 - 1).toFixed(2); // Mock change
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSymbol = change >= 0 ? '▲' : '▼';
                
                const title = data.title || seriesId;
                const category = data.category || 'Employment';
                const dataPoints = data.count || 0;
                const value = latest.value || data.values?.[data.values.length - 1] || '--';
                
                card.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">${title}</div>
                        <div class="data-source">BLS</div>
                    </div>
                    <div class="data-value ${changeClass}">${value}</div>
                    <div class="data-change ${changeClass}">
                        <span>${changeSymbol}</span> ${Math.abs(change)}%
                    </div>
                    <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                        ${category} • ${dataPoints} data points
                    </div>
                `;
                
                card.onclick = () => showSeriesChart(seriesId, data);
                grid.appendChild(card);
            });
            
            console.log(`Added ${Object.keys(chartData).length} data cards to overview grid`);
        }
        
        // Fallback function to use current_metrics data
        function updateOverviewGridFromMetrics(currentMetrics) {
            const grid = document.getElementById('overviewGrid');
            grid.innerHTML = '';
            
            console.log('Using current metrics for overview grid:', currentMetrics);
            
            Object.entries(currentMetrics).forEach(([metricId, metric]) => {
                const card = document.createElement('div');
                card.className = 'data-card';
                
                const change = (Math.random() * 2 - 1).toFixed(2);
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changeSymbol = change >= 0 ? '▲' : '▼';
                
                const title = metric.title || metricId;
                const category = metric.category || 'Employment';
                const value = metric.current || '--';
                
                card.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">${title}</div>
                        <div class="data-source">BLS</div>
                    </div>
                    <div class="data-value ${changeClass}">${value}</div>
                    <div class="data-change ${changeClass}">
                        <span>${changeSymbol}</span> ${Math.abs(change)}%
                    </div>
                    <div style="font-size: 0.75rem; color: #888; margin-top: 0.5rem;">
                        ${category} • Real-time data
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Update insights
        function updateInsights(insights) {
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = '';
            
            if (!insights || insights.length === 0) {
                insightsList.innerHTML = '<li>No insights available</li>';
                return;
            }
            
            insights.forEach(insight => {
                const li = document.createElement('li');
                li.textContent = insight;
                insightsList.appendChild(li);
            });
        }
        
        // Update crisis analysis
        function updateCrisisAnalysis(crisisAnalysis) {
            const grid = document.getElementById('crisisGrid');
            grid.innerHTML = '';
            
            if (!crisisAnalysis) {
                grid.innerHTML = '<div class="message error-message">No crisis analysis data available</div>';
                return;
            }
            
            // Crisis overview card
            const overviewCard = document.createElement('div');
            overviewCard.className = 'data-card';
            overviewCard.innerHTML = `
                <div class="data-card-header">
                    <div class="data-title">Crisis Assessment</div>
                    <div class="data-source">Analysis</div>
                </div>
                <div class="data-value">${crisisAnalysis.crisis_level || 'Normal'}</div>
                <div style="margin-top: 1rem;">
                    <strong>Current Unemployment:</strong> ${crisisAnalysis.current_unemployment_rate || '--'}%<br>
                    <strong>Trend:</strong> ${crisisAnalysis.trend || 'stable'}<br>
                    <strong>Labor Market Health:</strong> ${crisisAnalysis.labor_market_health?.overall_rating || 'Good'}
                </div>
            `;
            grid.appendChild(overviewCard);
            
            // Risk factors
            if (crisisAnalysis.risk_factors && crisisAnalysis.risk_factors.length > 0) {
                const riskCard = document.createElement('div');
                riskCard.className = 'data-card';
                riskCard.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">Risk Factors</div>
                        <div class="data-source">Alert</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        ${crisisAnalysis.risk_factors.map(factor => `<div style="margin-bottom: 0.5rem;">⚠️ ${factor}</div>`).join('')}
                    </div>
                `;
                grid.appendChild(riskCard);
            }
            
            // Historical comparison
            if (crisisAnalysis.historical_comparison) {
                const histCard = document.createElement('div');
                histCard.className = 'data-card';
                histCard.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">Historical Context</div>
                        <div class="data-source">Comparison</div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>2008 Financial Crisis Peak:</strong> ${crisisAnalysis.historical_comparison['2008_financial_crisis_peak']}<br>
                        <strong>2020 COVID Peak:</strong> ${crisisAnalysis.historical_comparison['2020_covid_peak']}<br>
                        <strong>Current Assessment:</strong> ${crisisAnalysis.historical_comparison.current_assessment}
                    </div>
                `;
                grid.appendChild(histCard);
            }
        }
        
        // Update raw data display
        function updateRawData(data) {
            const rawDisplay = document.getElementById('rawDataDisplay');
            rawDisplay.textContent = JSON.stringify(data, null, 2);
        }
        
        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            const config = {
                responsive: true,
                displayModeBar: true
            };
            
            // Initialize placeholder charts
            ['unemploymentChart', 'payrollChart', 'joltsChart'].forEach(chartId => {
                if (document.getElementById(chartId)) {
                    Plotly.newPlot(chartId, [], chartConfig, config);
                }
            });
        }
        
        // Update historical charts
        function updateHistoricalCharts(chartData) {
            if (!chartData) return;
            
            // Unemployment Rate Chart
            const unemploymentData = chartData['LNS14000000'];
            if (unemploymentData) {
                const trace = {
                    x: unemploymentData.labels,
                    y: unemploymentData.values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Unemployment Rate (%)',
                    line: { color: BLS_CONFIG.CHART_COLORS.danger, width: 2 }
                };
                
                Plotly.newPlot('unemploymentChart', [trace], {
                    title: 'U.S. Unemployment Rate - Historical Data',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                    font: { color: '#fff' },
                    xaxis: { gridcolor: 'rgba(255, 255, 255, 0.1)' },
                    yaxis: { 
                        gridcolor: 'rgba(255, 255, 255, 0.1)',
                        title: 'Unemployment Rate (%)'
                    }
                });
            }
            
            // Payroll Chart
            const payrollData = chartData['CES0000000001'];
            if (payrollData) {
                const trace = {
                    x: payrollData.labels,
                    y: payrollData.values.map(v => v / 1000), // Convert to millions
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Total Nonfarm Payrolls (Millions)',
                    line: { color: BLS_CONFIG.CHART_COLORS.primary, width: 2 }
                };
                
                Plotly.newPlot('payrollChart', [trace], {
                    title: 'Total Nonfarm Payrolls - Historical Data',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                    font: { color: '#fff' },
                    xaxis: { gridcolor: 'rgba(255, 255, 255, 0.1)' },
                    yaxis: { 
                        gridcolor: 'rgba(255, 255, 255, 0.1)',
                        title: 'Jobs (Millions)'
                    }
                });
            }
            
            // JOLTS Chart
            const joltsOpenings = chartData['JTS00000000JOL'];
            const joltsQuits = chartData['JTS00000000QUR'];
            
            if (joltsOpenings || joltsQuits) {
                const traces = [];
                
                if (joltsOpenings) {
                    traces.push({
                        x: joltsOpenings.labels,
                        y: joltsOpenings.values.map(v => v / 1000),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Job Openings (Millions)',
                        line: { color: BLS_CONFIG.CHART_COLORS.secondary, width: 2 }
                    });
                }
                
                if (joltsQuits) {
                    traces.push({
                        x: joltsQuits.labels,
                        y: joltsQuits.values.map(v => v / 1000),
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Quits (Millions)',
                        line: { color: BLS_CONFIG.CHART_COLORS.tertiary, width: 2 }
                    });
                }
                
                Plotly.newPlot('joltsChart', traces, {
                    title: 'JOLTS - Job Market Dynamics',
                    paper_bgcolor: 'rgba(0, 0, 0, 0)',
                    plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                    font: { color: '#fff' },
                    xaxis: { gridcolor: 'rgba(255, 255, 255, 0.1)' },
                    yaxis: { 
                        gridcolor: 'rgba(255, 255, 255, 0.1)',
                        title: 'Number (Millions)'
                    }
                });
            }
        }
        
        // Show metric details
        function showMetricDetails(metricId, metric) {
            alert(`${metric.title}\n\nCurrent Value: ${metric.current}\nCategory: ${metric.category}\nLast Updated: ${metric.last_updated}`);
        }
        
        // Show series chart
        function showSeriesChart(seriesId, data) {
            // Switch to historical tab and highlight this series
            switchTab('historical');
            
            // Could implement a modal or dedicated view here
            console.log('Showing chart for:', seriesId, data);
        }
        
        // Setup event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    console.log('Tab clicked:', e.target.dataset.tab);
                    switchTab(e.target.dataset.tab);
                });
            });
            
            // Mode selection - Fixed to handle button clicks properly
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    console.log('Mode button clicked:', e.target);
                    
                    // Handle clicks on the button or its child elements
                    let target = e.target;
                    let mode = target.dataset.mode;
                    
                    // If clicked on child element, get parent button
                    if (!mode && target.parentElement.classList.contains('mode-btn')) {
                        target = target.parentElement;
                        mode = target.dataset.mode;
                    }
                    
                    if (mode) {
                        console.log('Switching to mode:', mode);
                        switchMode(mode);
                    } else {
                        console.log('No mode found for target:', target);
                    }
                });
            });
            
            // Chart controls
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    console.log('Chart button clicked:', e.target.dataset.period);
                    updateChartPeriod(e.target.dataset.period);
                });
            });
            
            console.log('Event listeners set up successfully');
        }
        
        // Switch tab
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            
            activeTab = tabId;
            
            // Load tab-specific data
            if (tabId === 'historical') {
                updateHistoricalCharts(currentData.overview.chart_data || {});
            }
        }
        
        // Switch mode
        function switchMode(mode) {
            console.log('switchMode called with:', mode);
            
            if (!mode) {
                console.error('No mode provided to switchMode');
                return;
            }
            
            // Update active button
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                    console.log('Set active mode button:', mode);
                }
            });
            
            // Update current mode
            currentData.currentMode = mode;
            
            // Show loading state
            showLoading('keyMetrics');
            showLoading('overviewGrid');
            
            // Update header to show current mode
            const banner = document.getElementById('employmentPhaseBanner');
            if (banner) {
                banner.textContent = `📊 LOADING ${mode.toUpperCase()} EMPLOYMENT DATA...`;
                banner.className = 'employment-phase-banner';
            }
            
            // Load new data for the selected mode
            console.log('Loading BLS data for mode:', mode);
            loadBLSData(mode);
        }
        
        // Update chart period
        function updateChartPeriod(period) {
            document.querySelectorAll('.chart-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-period="${period}"]`).classList.add('active');
            
            // Implement period filtering logic here
            console.log('Updating chart period to:', period);
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            updateInterval = setInterval(() => {
                console.log('🔄 Auto-refreshing BLS data...');
                loadBLSData(currentData.currentMode);
            }, BLS_CONFIG.UPDATE_INTERVAL);
        }
        
        // Show loading state
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            }
        }
        
        // Show error message
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.innerHTML = `<div class="message error-message">${message}</div>`;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePlatform);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>
