<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLS Employment Crisis Detection Platform - Real Federal Data</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        /* Crisis Level Indicator */
        .crisis-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .crisis-level {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .crisis-normal {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .crisis-elevated {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .crisis-warning {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .crisis-severe {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            animation: criticalPulse 1s ease-in-out infinite;
        }
        
        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* API Status Indicators */
        .api-status {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .metric-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Crisis Phase Banner */
        .crisis-phase-banner {
            background: linear-gradient(90deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            animation: phaseGlow 2s ease-in-out infinite;
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        @keyframes phaseGlow {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-title {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .data-source {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            color: #00ff88;
        }
        
        .data-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }
        
        .data-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }
        
        .chart-control-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .chart-control-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .chart-control-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        #mainChart, #historicalChart, .category-chart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Messages */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
        }
        
        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }

        /* Crisis Alert Styles */
        .crisis-alert {
            background: rgba(255, 0, 0, 0.15);
            border: 2px solid #ff0000;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            animation: criticalPulse 1s ease-in-out infinite;
        }
        
        /* State Grid */
        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .state-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            transition: all 0.3s;
        }
        
        .state-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.1);
        }
        
        .state-name {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        
        .state-value {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                overflow-x: auto;
            }
            
            .state-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <!-- Crisis Phase Banner -->
    <div class="crisis-phase-banner" id="crisisPhaseBanner">
        📊 BLS EMPLOYMENT STATUS: ANALYZING FEDERAL DATA...
    </div>
    
    <header class="header">
        <div class="logo">
            🏛️ BLS Employment Platform
            <span style="font-size: 0.875rem; color: #888;">Real Federal Data</span>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="unemploymentRate">--</div>
                <div class="stat-label">Unemployment</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalIndicators">200+</div>
                <div class="stat-label">Indicators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="dataPoints">--</div>
                <div class="stat-label">Data Points</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>
        
        <div class="crisis-indicator">
            <span>Crisis Level:</span>
            <span class="crisis-level crisis-normal" id="crisisLevel">LOADING...</span>
        </div>
        
        <div class="api-status">
            <div class="api-indicator">
                <div class="status-dot loading" id="blsApiStatus"></div>
                <span>BLS API</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="lambdaStatus"></div>
                <span>Lambda</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="autoUpdate"></div>
                <span>Auto-Update</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">📊 Overview</button>
            <button class="tab-btn" data-tab="core">💼 Core Employment</button>
            <button class="tab-btn" data-tab="demographics">👥 Demographics</button>
            <button class="tab-btn" data-tab="states">🗺️ State Data</button>
            <button class="tab-btn" data-tab="jolts">📈 JOLTS</button>
            <button class="tab-btn" data-tab="payroll">💰 Payroll</button>
            <button class="tab-btn" data-tab="sectors">🏭 Sectors</button>
            <button class="tab-btn" data-tab="costs">💵 Costs</button>
            <button class="tab-btn" data-tab="alternative">📉 Alternative</button>
            <button class="tab-btn" data-tab="inflation">📈 Inflation</button>
            <button class="tab-btn" data-tab="crisis">🚨 Crisis Analysis</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Key Metrics -->
            <div class="metrics-grid" id="keyMetrics">
                <!-- Will be populated with real BLS data -->
            </div>
            
            <!-- Main Historical Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Historical Employment Trends (Auto-Updates)</h2>
                    <div class="chart-controls">
                        <button class="chart-control-btn active" onclick="updateChartPeriod('1y')">1Y</button>
                        <button class="chart-control-btn" onclick="updateChartPeriod('5y')">5Y</button>
                        <button class="chart-control-btn" onclick="updateChartPeriod('10y')">10Y</button>
                        <button class="chart-control-btn" onclick="updateChartPeriod('all')">All</button>
                    </div>
                </div>
                <div id="mainChart"></div>
            </div>
            
            <!-- Crisis Analysis Summary -->
            <div class="crisis-alert" id="crisisAlertSummary" style="display: none;">
                <h3 style="color: #ff0000; margin-bottom: 1rem;">🚨 EMPLOYMENT CRISIS DETECTED</h3>
                <div id="crisisMessage"></div>
            </div>
            
            <!-- All Core Indicators -->
            <h3 style="margin: 2rem 0 1rem 0; color: #00ff88;">Core Employment Indicators</h3>
            <div class="data-grid" id="overviewGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Core Employment Tab -->
        <div class="tab-content" id="core">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Core Employment Historical Data</h2>
                </div>
                <div id="coreChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="coreGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Demographics Tab -->
        <div class="tab-content" id="demographics">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Demographic Unemployment Breakdown</h2>
                </div>
                <div id="demographicsChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="demographicsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- States Tab -->
        <div class="tab-content" id="states">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">State Unemployment Map</h2>
                </div>
                <div id="statesChart" class="category-chart"></div>
            </div>
            <h3 style="margin: 2rem 0 1rem 0; color: #00ff88;">All 50 States + DC</h3>
            <div class="state-grid" id="statesGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- JOLTS Tab -->
        <div class="tab-content" id="jolts">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">JOLTS - Job Openings and Labor Turnover</h2>
                </div>
                <div id="joltsChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="joltsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Payroll Tab -->
        <div class="tab-content" id="payroll">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Payroll Employment & Earnings</h2>
                </div>
                <div id="payrollChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="payrollGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Sectors Tab -->
        <div class="tab-content" id="sectors">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Employment by Major Sectors</h2>
                </div>
                <div id="sectorsChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="sectorsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Costs Tab -->
        <div class="tab-content" id="costs">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Employment Costs & Productivity</h2>
                </div>
                <div id="costsChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="costsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Alternative Tab -->
        <div class="tab-content" id="alternative">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Alternative Employment Measures</h2>
                </div>
                <div id="alternativeChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="alternativeGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Inflation Tab -->
        <div class="tab-content" id="inflation">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Inflation & Price Indicators</h2>
                </div>
                <div id="inflationChart" class="category-chart"></div>
            </div>
            <div class="data-grid" id="inflationGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Crisis Analysis Tab -->
        <div class="tab-content" id="crisis">
            <div class="crisis-alert" id="crisisDetailAlert" style="display: none;">
                <h3 style="color: #ff0000; margin-bottom: 1rem;">🚨 DETAILED CRISIS ANALYSIS</h3>
                <div id="crisisDetailMessage"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Crisis Detection Dashboard</h2>
                </div>
                <div id="crisisChart" class="category-chart"></div>
            </div>
            
            <h3 style="margin: 2rem 0 1rem 0; color: #00ff88;">Crisis Indicators & Thresholds</h3>
            <div class="data-grid" id="crisisGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // BLS API Configuration
        const BLS_CONFIG = {
            API_URL: 'https://tajry2f7v3.execute-api.us-east-1.amazonaws.com/prod/data',
            UPDATE_INTERVAL: 30000, // 30 seconds for auto-refresh
            CHART_UPDATE_INTERVAL: 60000 // 60 seconds for chart updates
        };
        
        // Global state for BLS data
        let blsData = {
            current: {},
            historical: {},
            crisis: {},
            stats: {},
            lastUpdate: null,
            chartPeriod: '1y'
        };
        
        let autoUpdateInterval = null;
        let chartUpdateInterval = null;
        
        // Initialize the BLS platform
        async function initializePlatform() {
            console.log('🚀 Initializing BLS Employment Platform...');
            
            // Test BLS API connection
            await testBLSConnection();
            
            // Load all BLS data
            await loadBLSData('core'); // Start with core data
            
            // Setup event listeners
            setupEventListeners();
            
            // Start auto-update
            startAutoUpdate();
            
            // Setup additional features
            setupKeyboardShortcuts();
            addExportButton();
            monitorAPIHealth();
            
            console.log('✅ BLS Platform initialized with real federal data');
        }
        
        // Start auto-update
        function startAutoUpdate() {
            console.log('🔄 Starting auto-update (every 30 seconds)...');
            
            // Initial update
            updateLastUpdateTime();
            
            // Auto-refresh data
            autoUpdateInterval = setInterval(() => {
                console.log('🔄 Auto-updating BLS data...');
                
                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                const mode = getModeFromTab(activeTab);
                
                // Silently update in background
                loadBLSData(mode).then(() => {
                    console.log('✅ Auto-update complete');
                    updateLastUpdateTime();
                });
                
            }, BLS_CONFIG.UPDATE_INTERVAL);
            
            // Auto-refresh charts
            chartUpdateInterval = setInterval(() => {
                console.log('📊 Refreshing charts...');
                
                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                const mode = getModeFromTab(activeTab);
                updateCharts(mode);
                
            }, BLS_CONFIG.CHART_UPDATE_INTERVAL);
        }
        
        // Update last update time
        function updateLastUpdateTime() {
            const lastUpdateEl = document.getElementById('lastUpdate');
            if (!lastUpdateEl) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                second: '2-digit'
            });
            
            lastUpdateEl.textContent = timeStr;
        }
        
        // Format value based on units
        function formatValue(value, units) {
            if (typeof value !== 'number') return 'N/A';
            
            if (units === 'Thousands' || value >= 10000) {
                return (value / 1000).toFixed(1) + 'K';
            } else if (units === 'Millions' || value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (units === 'Percent' || units === '%') {
                return value.toFixed(2) + '%';
            } else if (units === 'Dollars') {
                return '$' + value.toFixed(2);
            } else if (units === 'Hours') {
                return value.toFixed(1) + ' hrs';
            } else if (units === 'Index') {
                return value.toFixed(1);
            } else {
                return value.toFixed(2);
            }
        }
        
        // Test BLS API connection
        async function testBLSConnection() {
            const blsStatus = document.getElementById('blsApiStatus');
            const lambdaStatus = document.getElementById('lambdaStatus');
            const autoUpdateStatus = document.getElementById('autoUpdate');
            
            try {
                console.log('Testing BLS API connection...');
                const response = await axios.get(BLS_CONFIG.API_URL);
                
                if (response.data && response.data.success) {
                    blsStatus.className = 'status-dot connected';
                    lambdaStatus.className = 'status-dot connected';
                    autoUpdateStatus.className = 'status-dot connected';
                    
                    console.log('✅ BLS API connected successfully');
                    console.log(`📊 ${response.data.results?.series_fetched || 0} indicators available`);
                    
                    // Update header with real data
                    if (response.data.crisis_analysis) {
                        const unemployment = response.data.crisis_analysis.current_unemployment_rate;
                        if (unemployment !== null) {
                            document.getElementById('unemploymentRate').textContent = `${unemployment}%`;
                        }
                    }
                    
                    if (response.data.results) {
                        document.getElementById('dataPoints').textContent = 
                            response.data.results.total_data_points || '--';
                    }
                    
                    // Update last update time
                    updateLastUpdateTime();
                    
                } else {
                    throw new Error('Invalid response from BLS API');
                }
            } catch (error) {
                console.error('BLS API connection error:', error);
                blsStatus.className = 'status-dot error';
                lambdaStatus.className = 'status-dot error';
                autoUpdateStatus.className = 'status-dot error';
            }
        }
        
        // Load BLS data for specific mode
        async function loadBLSData(mode = 'core', startYear = 2000) {
            try {
                console.log(`📊 Loading BLS ${mode} data...`);
                
                const response = await axios.post(BLS_CONFIG.API_URL, {
                    mode: mode,
                    startYear: startYear,
                    endYear: new Date().getFullYear()
                });
                
                if (response.data && response.data.success) {
                    const data = response.data;
                    
                    // Store data
                    blsData.current[mode] = data.current_metrics || {};
                    blsData.historical[mode] = data.chart_data || {};
                    blsData.crisis = data.crisis_analysis || {};
                    blsData.stats = data.results || {};
                    blsData.lastUpdate = new Date();
                    
                    console.log(`✅ Loaded ${Object.keys(blsData.current[mode]).length} ${mode} indicators`);
                    
                    // Update displays based on active tab
                    updateDisplays(mode);
                    updateCharts(mode);
                    updateCrisisAnalysis();
                    updateCrisisBanner();
                    
                    return data;
                }
            } catch (error) {
                console.error(`Error loading BLS ${mode} data:`, error);
                showError(`Failed to load ${mode} data. Retrying...`);
                
                // Retry after 5 seconds
                setTimeout(() => loadBLSData(mode, startYear), 5000);
            }
        }
        
        // Update all displays with real BLS data
        function updateDisplays(mode) {
            // Update key metrics
            updateKeyMetrics(mode);
            
            // Update grids based on mode
            switch(mode) {
                case 'core':
                    updateGrid('overviewGrid', blsData.current[mode]);
                    updateGrid('coreGrid', blsData.current[mode]);
                    break;
                case 'demographics':
                    updateGrid('demographicsGrid', blsData.current[mode]);
                    break;
                case 'states':
                    updateStatesGrid(blsData.current[mode]);
                    break;
                case 'jolts':
                    updateGrid('joltsGrid', blsData.current[mode]);
                    break;
                case 'payroll':
                    updateGrid('payrollGrid', blsData.current[mode]);
                    break;
                case 'sectors':
                    updateGrid('sectorsGrid', blsData.current[mode]);
                    break;
                case 'costs':
                    updateGrid('costsGrid', blsData.current[mode]);
                    break;
                case 'alternative':
                    updateGrid('alternativeGrid', blsData.current[mode]);
                    break;
                case 'inflation':
                    updateGrid('inflationGrid', blsData.current[mode]);
                    break;
                case 'all':
                    updateGrid('overviewGrid', blsData.current[mode]);
                    break;
            }
        }
        
        // Update key metrics cards
        function updateKeyMetrics(mode) {
            const metricsGrid = document.getElementById('keyMetrics');
            if (!metricsGrid) return;
            
            metricsGrid.innerHTML = '';
            
            // Select key indicators to display
            const keyIndicators = [
                'LNS14000000', // Unemployment Rate
                'CES0000000001', // Total Nonfarm Payrolls
                'LNS11300000', // Labor Force Participation
                'JTS00000000JOL', // Job Openings
                'CES0500000008', // Average Hourly Earnings
                'CUUR0000SA0' // CPI
            ];
            
            const currentData = blsData.current[mode] || {};
            
            keyIndicators.forEach(seriesId => {
                if (currentData[seriesId]) {
                    const metric = currentData[seriesId];
                    const card = createMetricCard(seriesId, metric);
                    metricsGrid.appendChild(card);
                }
            });
        }
        
        // Create metric card with real data
        function createMetricCard(seriesId, metric) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            
            const value = metric.current || 0;
            const changeClass = value > 5 ? 'negative' : value < 3 ? 'positive' : 'neutral';
            
            card.innerHTML = `
                <div class="metric-title">${metric.title || seriesId}</div>
                <div class="metric-value ${changeClass}">${formatValue(value, metric.units)}</div>
                <div class="metric-change">
                    <span>Last: ${metric.last_updated || 'N/A'}</span>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">
                    ${metric.category || 'Employment Indicator'}
                </div>
            `;
            
            return card;
        }
        
        // Update data grid with real BLS data
        function updateGrid(gridId, data) {
            const grid = document.getElementById(gridId);
            if (!grid || !data) return;
            
            grid.innerHTML = '';
            
            Object.entries(data).forEach(([seriesId, indicator]) => {
                const card = document.createElement('div');
                card.className = 'data-card';
                
                const value = indicator.current || 0;
                const units = indicator.units || '';
                const changeClass = value > 5 ? 'negative' : value < 3 ? 'positive' : 'neutral';
                
                card.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">${indicator.title || seriesId}</div>
                        <div class="data-source">${indicator.category || 'BLS'}</div>
                    </div>
                    <div class="data-value ${changeClass}">
                        ${formatValue(value, units)}
                    </div>
                    <div class="data-change">
                        <span>Updated: ${indicator.last_updated || 'N/A'}</span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            if (Object.keys(data).length === 0) {
                grid.innerHTML = '<div class="message">Loading real BLS data...</div>';
            }
        }
        
        // Update states grid with special formatting
        function updateStatesGrid(data) {
            const grid = document.getElementById('statesGrid');
            if (!grid || !data) return;
            
            grid.innerHTML = '';
            grid.className = 'state-grid';
            
            // State names mapping
            const stateNames = {
                'LASST010000000000003': 'Alabama',
                'LASST020000000000003': 'Alaska',
                'LASST040000000000003': 'Arizona',
                'LASST050000000000003': 'Arkansas',
                'LASST060000000000003': 'California',
                'LASST080000000000003': 'Colorado',
                'LASST090000000000003': 'Connecticut',
                'LASST100000000000003': 'Delaware',
                'LASST110000000000003': 'DC',
                'LASST120000000000003': 'Florida',
                'LASST130000000000003': 'Georgia',
                'LASST150000000000003': 'Hawaii',
                'LASST160000000000003': 'Idaho',
                'LASST170000000000003': 'Illinois',
                'LASST180000000000003': 'Indiana',
                'LASST190000000000003': 'Iowa',
                'LASST200000000000003': 'Kansas',
                'LASST210000000000003': 'Kentucky',
                'LASST220000000000003': 'Louisiana',
                'LASST230000000000003': 'Maine',
                'LASST240000000000003': 'Maryland',
                'LASST250000000000003': 'Massachusetts',
                'LASST260000000000003': 'Michigan',
                'LASST270000000000003': 'Minnesota',
                'LASST280000000000003': 'Mississippi',
                'LASST290000000000003': 'Missouri',
                'LASST300000000000003': 'Montana',
                'LASST310000000000003': 'Nebraska',
                'LASST320000000000003': 'Nevada',
                'LASST330000000000003': 'New Hampshire',
                'LASST340000000000003': 'New Jersey',
                'LASST350000000000003': 'New Mexico',
                'LASST360000000000003': 'New York',
                'LASST370000000000003': 'North Carolina',
                'LASST380000000000003': 'North Dakota',
                'LASST390000000000003': 'Ohio',
                'LASST400000000000003': 'Oklahoma',
                'LASST410000000000003': 'Oregon',
                'LASST420000000000003': 'Pennsylvania',
                'LASST440000000000003': 'Rhode Island',
                'LASST450000000000003': 'South Carolina',
                'LASST460000000000003': 'South Dakota',
                'LASST470000000000003': 'Tennessee',
                'LASST480000000000003': 'Texas',
                'LASST490000000000003': 'Utah',
                'LASST500000000000003': 'Vermont',
                'LASST510000000000003': 'Virginia',
                'LASST530000000000003': 'Washington',
                'LASST540000000000003': 'West Virginia',
                'LASST550000000000003': 'Wisconsin',
                'LASST560000000000003': 'Wyoming'
            };
            
            Object.entries(data).forEach(([seriesId, indicator]) => {
                const card = document.createElement('div');
                card.className = 'state-card';
                
                const value = indicator.current || 0;
                const stateName = stateNames[seriesId] || indicator.title || seriesId;
                const colorClass = value > 5 ? 'negative' : value < 3 ? 'positive' : 'neutral';
                
                card.innerHTML = `
                    <div class="state-name">${stateName}</div>
                    <div class="state-value ${colorClass}">${value.toFixed(1)}%</div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Update charts with real historical data
        function updateCharts(mode) {
            const historicalData = blsData.historical[mode] || {};
            
            // Update main chart
            updateMainHistoricalChart(historicalData);
            
            // Update category-specific charts
            switch(mode) {
                case 'core':
                    updateCategoryChart('coreChart', historicalData, 'Core Employment');
                    break;
                case 'demographics':
                    updateCategoryChart('demographicsChart', historicalData, 'Demographics');
                    break;
                case 'states':
                    updateStatesMapChart(historicalData);
                    break;
                case 'jolts':
                    updateCategoryChart('joltsChart', historicalData, 'JOLTS');
                    break;
                case 'payroll':
                    updateCategoryChart('payrollChart', historicalData, 'Payroll');
                    break;
                case 'sectors':
                    updateSectorsChart(historicalData);
                    break;
                case 'costs':
                    updateCategoryChart('costsChart', historicalData, 'Costs');
                    break;
                case 'alternative':
                    updateCategoryChart('alternativeChart', historicalData, 'Alternative');
                    break;
                case 'inflation':
                    updateCategoryChart('inflationChart', historicalData, 'Inflation');
                    break;
            }
            
            // Always update crisis chart
            updateCrisisChart();
        }
        
        // Update main historical chart with real data
        function updateMainHistoricalChart(data) {
            const chartDiv = document.getElementById('mainChart');
            if (!chartDiv) return;
            
            const traces = [];
            
            // Add unemployment rate as primary trace
            if (data['LNS14000000']) {
                const unemploymentData = data['LNS14000000'];
                traces.push({
                    x: unemploymentData.labels || [],
                    y: unemploymentData.values || [],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Unemployment Rate (U-3)',
                    line: { color: '#ff4444', width: 3 },
                    yaxis: 'y'
                });
            }
            
            // Add nonfarm payrolls as secondary trace
            if (data['CES0000000001']) {
                const payrollData = data['CES0000000001'];
                traces.push({
                    x: payrollData.labels || [],
                    y: payrollData.values ? payrollData.values.map(v => v/1000) : [],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Nonfarm Payrolls (Millions)',
                    line: { color: '#00ff88', width: 2 },
                    yaxis: 'y2'
                });
            }
            
            // Add labor force participation
            if (data['LNS11300000']) {
                const participationData = data['LNS11300000'];
                traces.push({
                    x: participationData.labels || [],
                    y: participationData.values || [],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Labor Force Participation Rate',
                    line: { color: '#00ccff', width: 2, dash: 'dot' },
                    yaxis: 'y'
                });
            }
            
            const layout = {
                title: 'U.S. Employment Indicators - Historical Trends (Real BLS Data)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    title: 'Date',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Percentage (%)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    side: 'left'
                },
                yaxis2: {
                    title: 'Payrolls (Millions)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: 'rgba(255, 255, 255, 0.05)',
                    tickfont: { color: '#00ff88' }
                },
                legend: {
                    font: { color: '#fff' },
                    bgcolor: 'rgba(0, 0, 0, 0.5)',
                    bordercolor: 'rgba(255, 255, 255, 0.2)',
                    borderwidth: 1
                },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('mainChart', traces, layout, {responsive: true});
        }
        
        // Update category chart
        function updateCategoryChart(chartId, data, category) {
            const chartDiv = document.getElementById(chartId);
            if (!chartDiv) return;
            
            const traces = [];
            let count = 0;
            const maxSeries = 5; // Limit to 5 series for readability
            
            Object.entries(data).forEach(([seriesId, seriesData]) => {
                if (count < maxSeries && seriesData.labels && seriesData.values) {
                    traces.push({
                        x: seriesData.labels,
                        y: seriesData.values,
                        type: 'scatter',
                        mode: 'lines',
                        name: seriesData.title || seriesId,
                        line: { width: 2 }
                    });
                    count++;
                }
            });
            
            const layout = {
                title: `${category} - Historical Data (Real BLS)`,
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                legend: { font: { color: '#fff' } },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot(chartId, traces, layout, {responsive: true});
        }
        
        // Update sectors chart with bar chart
        function updateSectorsChart(data) {
            const chartDiv = document.getElementById('sectorsChart');
            if (!chartDiv) return;
            
            const sectorNames = [];
            const currentValues = [];
            
            Object.entries(data).forEach(([seriesId, seriesData]) => {
                if (seriesData.latest) {
                    sectorNames.push(seriesData.title || seriesId);
                    currentValues.push(seriesData.latest.value / 1000); // Convert to thousands
                }
            });
            
            const trace = {
                x: sectorNames,
                y: currentValues,
                type: 'bar',
                marker: {
                    color: currentValues.map((v, i) => {
                        const colors = ['#00ff88', '#00ccff', '#ffaa00', '#ff4444', '#ff00ff'];
                        return colors[i % colors.length];
                    })
                },
                text: currentValues.map(v => `${v.toFixed(1)}K`),
                textposition: 'outside'
            };
            
            const layout = {
                title: 'Employment by Sector (Thousands)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888', size: 10 },
                    tickangle: -45
                },
                yaxis: {
                    title: 'Employment (Thousands)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: false
            };
            
            Plotly.newPlot('sectorsChart', [trace], layout, {responsive: true});
        }
        
        // Update states map chart
        function updateStatesMapChart(data) {
            const chartDiv = document.getElementById('statesChart');
            if (!chartDiv) return;
            
            // For now, show top/bottom states as bar chart
            const stateData = [];
            Object.entries(data).forEach(([seriesId, seriesData]) => {
                if (seriesData.latest) {
                    stateData.push({
                        name: seriesData.title || seriesId,
                        value: seriesData.latest.value
                    });
                }
            });
            
            // Sort and get top 10 and bottom 10
            stateData.sort((a, b) => a.value - b.value);
            const displayData = [...stateData.slice(0, 10), ...stateData.slice(-10)];
            
            const trace = {
                x: displayData.map(d => d.name),
                y: displayData.map(d => d.value),
                type: 'bar',
                marker: {
                    color: displayData.map(d => d.value > 5 ? '#ff4444' : d.value > 3 ? '#ffaa00' : '#00ff88')
                }
            };
            
            const layout = {
                title: 'State Unemployment Rates - Top & Bottom 10',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888', size: 9 },
                    tickangle: -45
                },
                yaxis: {
                    title: 'Unemployment Rate (%)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                }
            };
            
            Plotly.newPlot('statesChart', [trace], layout, {responsive: true});
        }
        
        // Update crisis chart
        function updateCrisisChart() {
            const chartDiv = document.getElementById('crisisChart');
            if (!chartDiv || !blsData.crisis) return;
            
            // Create crisis indicator visualization
            const crisisData = blsData.crisis;
            const currentRate = crisisData.current_unemployment_rate || 0;
            
            // Historical comparison data
            const trace = {
                x: ['Current', '2008 Crisis', '2020 COVID', 'Normal'],
                y: [currentRate, 10.0, 14.7, 4.0],
                type: 'bar',
                marker: {
                    color: [
                        currentRate >= 7 ? '#ff0000' : currentRate >= 5 ? '#ffaa00' : '#00ff88',
                        '#ff0000',
                        '#ff0000',
                        '#00ff88'
                    ]
                },
                text: [
                    `${currentRate}%`,
                    '10.0%',
                    '14.7%',
                    '4.0%'
                ],
                textposition: 'outside'
            };
            
            const layout = {
                title: 'Crisis Level Comparison',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Unemployment Rate (%)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    range: [0, 16]
                },
                showlegend: false
            };
            
            Plotly.newPlot('crisisChart', [trace], layout, {responsive: true});
        }
        
        // Update crisis analysis
        function updateCrisisAnalysis() {
            const crisis = blsData.crisis;
            if (!crisis) return;
            
            // Update crisis level indicator
            const crisisLevel = document.getElementById('crisisLevel');
            const level = crisis.crisis_level || 'UNKNOWN';
            
            crisisLevel.textContent = level.toUpperCase();
            crisisLevel.className = `crisis-level ${
                level === 'Severe Crisis' ? 'crisis-severe' :
                level === 'Crisis' ? 'crisis-warning' :
                level === 'Elevated' ? 'crisis-elevated' :
                'crisis-normal'
            }`;
            
            // Update crisis alerts
            const alertSummary = document.getElementById('crisisAlertSummary');
            const alertDetail = document.getElementById('crisisDetailAlert');
            
            if (crisis.current_unemployment_rate >= 7) {
                if (alertSummary) {
                    alertSummary.style.display = 'block';
                    document.getElementById('crisisMessage').innerHTML = `
                        <p>Unemployment Rate: ${crisis.current_unemployment_rate}%</p>
                        <p>Crisis Level: ${crisis.crisis_level}</p>
                        <p>Trend: ${crisis.trend || 'Unknown'}</p>
                        ${crisis.risk_factors ? `<p>Risk Factors: ${crisis.risk_factors.join(', ')}</p>` : ''}
                    `;
                }
                
                if (alertDetail) {
                    alertDetail.style.display = 'block';
                    document.getElementById('crisisDetailMessage').innerHTML = `
                        <p><strong>Current Rate:</strong> ${crisis.current_unemployment_rate}%</p>
                        <p><strong>Crisis Thresholds:</strong></p>
                        <ul>
                            <li>Normal: < 5%</li>
                            <li>Elevated: 5-7%</li>
                            <li>Crisis: 7-10%</li>
                            <li>Severe: ≥ 10%</li>
                        </ul>
                        <p><strong>Historical Context:</strong></p>
                        <ul>
                            <li>2008 Financial Crisis Peak: 10.0%</li>
                            <li>2020 COVID Peak: 14.7%</li>
                        </ul>
                    `;
                }
            } else {
                if (alertSummary) alertSummary.style.display = 'none';
                if (alertDetail) alertDetail.style.display = 'none';
            }
            
            // Update crisis grid
            updateCrisisGrid();
        }
        
        // Update crisis indicators grid
        function updateCrisisGrid() {
            const grid = document.getElementById('crisisGrid');
            if (!grid || !blsData.crisis) return;
            
            grid.innerHTML = '';
            
            const crisis = blsData.crisis;
            const indicators = [
                {
                    name: 'Current Unemployment',
                    value: crisis.current_unemployment_rate,
                    threshold: 5,
                    units: '%'
                },
                {
                    name: 'Crisis Level',
                    value: crisis.crisis_level,
                    threshold: 'Normal',
                    units: ''
                },
                {
                    name: 'Trend Direction',
                    value: crisis.trend,
                    threshold: 'stable',
                    units: ''
                },
                {
                    name: 'Labor Market Health',
                    value: crisis.labor_market_health?.overall_rating,
                    threshold: 'Good',
                    units: ''
                }
            ];
            
            indicators.forEach(indicator => {
                const card = document.createElement('div');
                card.className = 'data-card';
                
                const isAlert = (typeof indicator.value === 'number' && indicator.value > indicator.threshold) ||
                               (indicator.value === 'increasing' || indicator.value === 'Poor');
                
                card.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">${indicator.name}</div>
                        <div class="data-source">${isAlert ? '⚠️ ALERT' : '✅ OK'}</div>
                    </div>
                    <div class="data-value ${isAlert ? 'negative' : 'positive'}">
                        ${indicator.value}${indicator.units}
                    </div>
                    <div class="data-change">
                        <span>Threshold: ${indicator.threshold}${indicator.units}</span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Update crisis banner
        function updateCrisisBanner() {
            const banner = document.getElementById('crisisPhaseBanner');
            if (!banner || !blsData.crisis) return;
            
            const rate = blsData.crisis.current_unemployment_rate || 0;
            let message = '';
            
            if (rate >= 10) {
                message = '🚨 SEVERE CRISIS: UNEMPLOYMENT CRITICAL';
            } else if (rate >= 7) {
                message = '🔴 CRISIS MODE: ELEVATED UNEMPLOYMENT';
            } else if (rate >= 5) {
                message = '🟡 WARNING: UNEMPLOYMENT RISING';
            } else if (rate >= 0) {
                message = `🟢 NORMAL: UNEMPLOYMENT AT ${rate.toFixed(1)}%`;
            } else {
                message = '📊 BLS EMPLOYMENT STATUS: LOADING...';
            }
            
            banner.textContent = message;
        }
        
        // Update chart period
        window.updateChartPeriod = function(period) {
            blsData.chartPeriod = period;
            
            // Update button states
            document.querySelectorAll('.chart-control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Determine start year based on period
            let startYear = new Date().getFullYear();
            switch(period) {
                case '1y':
                    startYear = new Date().getFullYear() - 1;
                    break;
                case '5y':
                    startYear = new Date().getFullYear() - 5;
                    break;
                case '10y':
                    startYear = new Date().getFullYear() - 10;
                    break;
                case 'all':
                    startYear = 2000;
                    break;
            }
            
            // Reload data with new period
            const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
            const mode = getModeFromTab(activeTab);
            loadBLSData(mode, startYear);
        };
        
        // Get mode from tab
        function getModeFromTab(tabId) {
            const modeMap = {
                'overview': 'core',
                'core': 'core',
                'demographics': 'demographics',
                'states': 'states',
                'jolts': 'jolts',
                'payroll': 'payroll',
                'sectors': 'sectors',
                'costs': 'costs',
                'alternative': 'alternative',
                'inflation': 'inflation',
                'crisis': 'core' // Use core data for crisis analysis
            };
            
            return modeMap[tabId] || 'core';
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Update active tab
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    // Show corresponding content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = e.target.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    
                    // Load data for this tab
                    const mode = getModeFromTab(tabId);
                    loadBLSData(mode);
                });
            });
            
            // Add refresh button
            const refreshBtn = document.createElement('button');
            refreshBtn.textContent = '🔄 Refresh Data';
            refreshBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #00ff88; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 1000;';
            refreshBtn.onclick = () => {
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'Updating...';
                
                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                const mode = getModeFromTab(activeTab);
                
                loadBLSData(mode).then(() => {
                    refreshBtn.textContent = '✅ Updated!';
                    setTimeout(() => {
                        refreshBtn.textContent = '🔄 Refresh Data';
                        refreshBtn.disabled = false;
                    }, 2000);
                }).catch(() => {
                    refreshBtn.textContent = '❌ Error';
                    setTimeout(() => {
                        refreshBtn.textContent = '🔄 Refresh Data';
                        refreshBtn.disabled = false;
                    }, 2000);
                });
            };
            document.body.appendChild(refreshBtn);
        }
        
        // Show error message
        function showError(message) {
            console.error('❌ Error:', message);
            
            // Create error notification
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.style.cssText = 'position: fixed; top: 100px; right: 20px; z-index: 9999; max-width: 300px;';
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // Handle data loading states
        function setLoadingState(gridId, loading = true) {
            const grid = document.getElementById(gridId);
            if (!grid) return;
            
            if (loading) {
                grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            }
        }
        
        // Fetch all available modes on startup
        async function fetchAllModes() {
            console.log('📊 Fetching all BLS data modes...');
            
            const modes = ['core', 'demographics', 'states', 'jolts', 'payroll', 'sectors', 'costs', 'alternative', 'inflation'];
            
            for (const mode of modes) {
                try {
                    console.log(`Loading ${mode} data...`);
                    await loadBLSData(mode);
                    
                    // Small delay between requests to avoid overwhelming the API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`Failed to load ${mode} data:`, error);
                }
            }
            
            console.log('✅ All BLS data modes loaded');
        }
        
        // Enhanced error handling and retry logic
        async function fetchWithRetry(url, options = {}, maxRetries = 3) {
            let lastError;
            
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await axios.request({
                        url,
                        ...options,
                        timeout: 30000 // 30 second timeout
                    });
                    
                    return response;
                } catch (error) {
                    lastError = error;
                    console.warn(`Retry ${i + 1}/${maxRetries} for ${url}`);
                    
                    // Wait before retrying (exponential backoff)
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            
            throw lastError;
        }
        
        // Monitor API health
        async function monitorAPIHealth() {
            setInterval(async () => {
                try {
                    const response = await axios.get(BLS_CONFIG.API_URL, { timeout: 5000 });
                    
                    if (response.data && response.data.success) {
                        document.getElementById('blsApiStatus').className = 'status-dot connected';
                    } else {
                        document.getElementById('blsApiStatus').className = 'status-dot error';
                    }
                } catch (error) {
                    document.getElementById('blsApiStatus').className = 'status-dot error';
                }
            }, 30000); // Check every 30 seconds
        }
        
        // Add keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + R to refresh
                if ((e.ctrlKey || e.metaKey) && e.key === 'r') {
                    e.preventDefault();
                    const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                    const mode = getModeFromTab(activeTab);
                    loadBLSData(mode);
                }
                
                // Number keys 1-9 to switch tabs
                if (e.key >= '1' && e.key <= '9' && !e.ctrlKey && !e.metaKey && !e.altKey && !e.shiftKey) {
                    const tabIndex = parseInt(e.key) - 1;
                    const tabs = document.querySelectorAll('.tab-btn');
                    if (tabs[tabIndex]) {
                        tabs[tabIndex].click();
                    }
                }
                
                // Arrow keys to navigate tabs
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    const tabs = Array.from(document.querySelectorAll('.tab-btn'));
                    const currentIndex = tabs.findIndex(tab => tab.classList.contains('active'));
                    let newIndex;
                    
                    if (e.key === 'ArrowLeft') {
                        newIndex = currentIndex > 0 ? currentIndex - 1 : tabs.length - 1;
                    } else {
                        newIndex = currentIndex < tabs.length - 1 ? currentIndex + 1 : 0;
                    }
                    
                    if (tabs[newIndex]) {
                        tabs[newIndex].click();
                    }
                }
            });
        }
        
        // Export data functionality
        function exportData() {
            const dataToExport = {
                timestamp: new Date().toISOString(),
                crisis_analysis: blsData.crisis,
                current_metrics: blsData.current,
                statistics: blsData.stats,
                source: 'U.S. Bureau of Labor Statistics',
                api_endpoint: BLS_CONFIG.API_URL,
                export_info: {
                    format: 'JSON',
                    version: '2.0',
                    includes: ['current_values', 'historical_data', 'crisis_analysis']
                }
            };
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bls-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.style.cssText = 'position: fixed; bottom: 70px; left: 20px; z-index: 9999;';
            successDiv.textContent = '✅ Data exported successfully!';
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
        
        // Add export button
        function addExportButton() {
            const exportBtn = document.createElement('button');
            exportBtn.textContent = '📥 Export Data';
            exportBtn.style.cssText = 'position: fixed; bottom: 20px; left: 20px; padding: 10px 20px; background: #00ccff; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 1000;';
            exportBtn.onclick = exportData;
            document.body.appendChild(exportBtn);
        }
        
        // Add fullscreen button
        function addFullscreenButton() {
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.textContent = '⛶ Fullscreen';
            fullscreenBtn.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 10px 20px; background: rgba(255, 255, 255, 0.1); color: #fff; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; cursor: pointer; font-weight: bold; z-index: 1000;';
            
            fullscreenBtn.onclick = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    fullscreenBtn.textContent = '✕ Exit Fullscreen';
                } else {
                    document.exitFullscreen();
                    fullscreenBtn.textContent = '⛶ Fullscreen';
                }
            };
            
            document.body.appendChild(fullscreenBtn);
        }
        
        // Create demo mode for testing
        function createDemoData() {
            // Generate demo data if API is unavailable
            const demoData = {
                current: {
                    core: {
                        'LNS14000000': {
                            title: 'Unemployment Rate (U-3)',
                            current: 4.2,
                            units: 'Percent',
                            category: 'Core Employment',
                            last_updated: '2025-08-01'
                        },
                        'CES0000000001': {
                            title: 'Total Nonfarm Payrolls',
                            current: 159000,
                            units: 'Thousands',
                            category: 'Employment',
                            last_updated: '2025-08-01'
                        },
                        'LNS11300000': {
                            title: 'Labor Force Participation Rate',
                            current: 63.5,
                            units: 'Percent',
                            category: 'Core Employment',
                            last_updated: '2025-08-01'
                        }
                    }
                },
                historical: {
                    core: {
                        'LNS14000000': {
                            labels: ['2024-01', '2024-02', '2024-03', '2024-04', '2024-05', '2024-06'],
                            values: [3.9, 3.8, 3.9, 4.0, 4.1, 4.2],
                            title: 'Unemployment Rate (U-3)'
                        }
                    }
                },
                crisis: {
                    current_unemployment_rate: 4.2,
                    crisis_level: 'Normal',
                    trend: 'stable',
                    risk_factors: [],
                    labor_market_health: {
                        overall_rating: 'Good',
                        trend: 'stable'
                    }
                },
                stats: {
                    series_fetched: 11,
                    total_data_points: 614,
                    success_rate: '100%'
                }
            };
            
            return demoData;
        }
        
        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 BLS Employment Crisis Detection Platform Starting...');
            console.log('📡 API Endpoint:', BLS_CONFIG.API_URL);
            console.log('⏱️ Auto-Update Interval:', BLS_CONFIG.UPDATE_INTERVAL / 1000, 'seconds');
            console.log('📊 Chart Update Interval:', BLS_CONFIG.CHART_UPDATE_INTERVAL / 1000, 'seconds');
            
            try {
                // Initialize platform
                await initializePlatform();
                
                console.log('✅ BLS Platform fully initialized and displaying real federal data');
                console.log('📊 Data Source: U.S. Bureau of Labor Statistics (BLS)');
                console.log('🔄 Auto-updates enabled - Data refreshes every 30 seconds');
                
                // Show welcome message
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'success-message';
                welcomeDiv.style.cssText = 'position: fixed; top: 100px; left: 50%; transform: translateX(-50%); z-index: 9999; padding: 20px; font-size: 1.1rem;';
                welcomeDiv.textContent = '✅ Connected to BLS API - Real Federal Data Loading...';
                document.body.appendChild(welcomeDiv);
                
                setTimeout(() => {
                    welcomeDiv.remove();
                }, 3000);
                
            } catch (error) {
                console.error('❌ Failed to initialize platform:', error);
                
                // Load demo data as fallback
                console.log('📊 Loading demo data as fallback...');
                blsData = createDemoData();
                updateDisplays('core');
                updateCharts('core');
                updateCrisisAnalysis();
                updateCrisisBanner();
                
                showError('Unable to connect to BLS API. Showing demo data.');
            }
            
            // Add fullscreen button
            addFullscreenButton();
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
                console.log('🛑 Auto-update stopped');
            }
            if (chartUpdateInterval) {
                clearInterval(chartUpdateInterval);
                console.log('🛑 Chart update stopped');
            }
        });
        
        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause updates when tab is not visible
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                    autoUpdateInterval = null;
                }
                if (chartUpdateInterval) {
                    clearInterval(chartUpdateInterval);
                    chartUpdateInterval = null;
                }
                console.log('⏸️ Updates paused (tab hidden)');
            } else {
                // Resume updates when tab becomes visible
                if (!autoUpdateInterval && !chartUpdateInterval) {
                    startAutoUpdate();
                    console.log('▶️ Updates resumed (tab visible)');
                }
            }
        });
        
        // Log platform info
        console.log('=====================================');
        console.log('BLS Employment Crisis Detection v2.0');
        console.log('Real-time Federal Employment Data');
        console.log('200+ Economic Indicators');
        console.log('Crisis Detection System Active');
        console.log('=====================================');
    </script>
</body>
</html>
