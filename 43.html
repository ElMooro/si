<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fed Liquidity Dashboard - Complete 62 Indicators</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .title {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .stats-bar {
            display: flex;
            gap: 2rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .controls {
            background: rgba(20, 24, 44, 0.95);
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .category-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.875rem;
        }
        
        .tab-btn:hover {
            background: rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        .tab-btn.favorites {
            background: linear-gradient(135deg, #ff6b6b, #ff9f43);
        }
        
        .tab-btn.favorites.active {
            background: linear-gradient(135deg, #ff6b6b, #ff9f43);
            color: #fff;
        }
        
        .search-bar {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
        }
        
        .refresh-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #00ff88, #00ccff);
            border: none;
            border-radius: 8px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }
        
        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .indicator-card {
            background: rgba(20, 24, 44, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .indicator-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }
        
        .indicator-title-wrapper {
            flex: 1;
            margin-right: 1rem;
        }
        
        .indicator-title {
            font-size: 0.875rem;
            color: #00ff88;
            font-weight: bold;
            word-break: break-word;
            cursor: text;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .indicator-title:hover {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 0 1px rgba(0, 255, 136, 0.3);
        }
        
        .indicator-title.editing {
            background: rgba(0, 255, 136, 0.2);
            box-shadow: 0 0 0 2px #00ff88;
        }
        
        .edit-btn {
            position: absolute;
            top: 10px;
            right: 45px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 4px;
            padding: 6px 10px;
            color: #888;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .edit-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .favorite-btn:hover {
            transform: scale(1.2);
        }
        
        .favorite-btn.favorited {
            color: #ff6b6b;
        }
        
        .favorite-btn:not(.favorited) {
            color: #666;
        }
        
        .indicator-symbol {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            color: #00ff88;
            white-space: nowrap;
            margin-top: 0.5rem;
        }
        
        .indicator-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #fff;
        }
        
        .indicator-date {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 1rem;
        }
        
        .changes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
        
        .change-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            padding: 0.5rem;
            text-align: center;
        }
        
        .change-period {
            font-size: 0.625rem;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 0.25rem;
        }
        
        .change-value {
            font-size: 1.125rem;
            font-weight: bold;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .last-update {
            text-align: center;
            font-size: 0.875rem;
            color: #666;
            margin-top: 2rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 8px;
        }
        
        .category-header {
            grid-column: 1 / -1;
            background: linear-gradient(90deg, rgba(0, 255, 136, 0.1), transparent);
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 1.125rem;
            font-weight: bold;
            color: #00ff88;
            border-left: 4px solid #00ff88;
        }
        
        .empty-favorites {
            grid-column: 1 / -1;
            text-align: center;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.2);
        }
        
        .empty-favorites h3 {
            margin-bottom: 1rem;
            color: #888;
        }
        
        .empty-favorites p {
            color: #666;
        }
        
        @media (max-width: 768px) {
            .indicators-grid {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .changes-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 class="title">Fed Liquidity Dashboard</h1>
            <div class="api-status">
                <div class="status-dot loading" id="apiStatus"></div>
                <span id="statusText">Connecting...</span>
            </div>
        </div>
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-value" id="totalIndicators">0</div>
                <div class="stat-label">Total Indicators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="fedBalance">-</div>
                <div class="stat-label">Fed Balance Sheet</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="reserveBalances">-</div>
                <div class="stat-label">Reserve Balances</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="overnightRRP">-</div>
                <div class="stat-label">Overnight RRP</div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <div class="category-tabs">
            <button class="tab-btn favorites" data-category="favorites">‚≠ê Favorites</button>
            <button class="tab-btn active" data-category="all">All Indicators</button>
            <button class="tab-btn" data-category="reserves">Reserves</button>
            <button class="tab-btn" data-category="currency">Currency</button>
            <button class="tab-btn" data-category="treasury_account">Treasury</button>
            <button class="tab-btn" data-category="repo_operations">Repo Ops</button>
            <button class="tab-btn" data-category="securities">Securities</button>
            <button class="tab-btn" data-category="lending_facilities">Lending</button>
            <button class="tab-btn" data-category="balance_sheet">Balance Sheet</button>
            <button class="tab-btn" data-category="other_assets">Other</button>
        </div>
        <div class="search-bar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search indicators (e.g., WALCL, Reserve, Balance)">
            <button class="refresh-btn" id="refreshBtn" onclick="loadAllData()">Refresh Data</button>
        </div>
    </div>
    
    <div class="indicators-grid" id="indicatorsGrid">
        <div style="grid-column: 1 / -1; text-align: center; padding: 3rem;">
            <div class="loading-spinner"></div>
            <p style="margin-top: 1rem;">Loading Fed liquidity data...</p>
        </div>
    </div>
    
    <div class="last-update" id="lastUpdate">
        Last Updated: Never
    </div>
    
    <script>
        // Fed Liquidity API Configuration
        const FED_API_URL = 'https://nmkverrwjnxsmgnogzckkoyuce0bqxyk.lambda-url.us-east-1.on.aws';
        
        // Categories from the API documentation
        const FED_LIQUIDITY_CATEGORIES = {
            "reserves": ["WRBWFRBL", "RESBALNS", "RESBALNSW", "REQRESNS", "EXCSRESNS", "TOTRESNS"],
            "currency": ["WCURCIR", "CURRCIR", "BOGMBBM"],
            "treasury_account": ["WTREGEN", "TREASURY"],
            "repo_operations": ["WREPODEL", "WREPOFOR", "RRPONTSYD", "RPONTSYD", "H41RESPPREPO", "H41RESPPFIMA"],
            "securities": ["WSHOTSL", "WSHOSHO", "WSHOTS", "WSHOMCB", "WSHOFDEB", "TREAST", "TREASLT5", "TREASG5T10", "TREASG10", "TIPS", "FPCPN", "MBST", "CMBS"],
            "lending_facilities": ["WLCFLL", "WPCREDIT", "DISCBORR", "WSCREDIT", "PDCB", "TAF", "H41RESPPBTFP"],
            "emergency_programs": ["RESPPALLEX", "PPPLF", "MSLP", "MLF", "CPFF", "PMCCF", "SMCCF", "TALF", "MMLF"],
            "balance_sheet": ["WALCL", "RESPPANWW", "BOGMBASE", "WOTHLL"],
            "other_assets": ["WFCDA", "WUPSHO", "WUDSON", "SWPT", "CLBSWP", "WORAL", "WGCAL", "WSDRAL", "COINAL", "WDTGAL", "TERMAUC"]
        };
        
        // Global state
        let allIndicatorData = {};
        let currentCategory = 'all';
        let searchTerm = '';
        let autoRefreshInterval = null;
        let customNames = {};
        let favorites = [];
        
        // Load saved data from localStorage
        function loadSavedData() {
            const savedNames = localStorage.getItem('fedLiquidityCustomNames');
            if (savedNames) {
                customNames = JSON.parse(savedNames);
            }
            
            const savedFavorites = localStorage.getItem('fedLiquidityFavorites');
            if (savedFavorites) {
                favorites = JSON.parse(savedFavorites);
            }
        }
        
        // Save custom names
        function saveCustomNames() {
            localStorage.setItem('fedLiquidityCustomNames', JSON.stringify(customNames));
        }
        
        // Save favorites
        function saveFavorites() {
            localStorage.setItem('fedLiquidityFavorites', JSON.stringify(favorites));
        }
        
        // Toggle favorite status
        function toggleFavorite(series) {
            const index = favorites.indexOf(series);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(series);
            }
            saveFavorites();
            filterAndDisplayIndicators();
        }
        
        // Edit indicator name
        function editIndicatorName(series, currentName) {
            const newName = prompt('Enter new name for this indicator:', currentName);
            if (newName && newName !== currentName) {
                customNames[series] = newName;
                saveCustomNames();
                filterAndDisplayIndicators();
            }
        }
        
        // Initialize the dashboard
        async function initDashboard() {
            console.log('Initializing Fed Liquidity Dashboard...');
            
            // Load saved data
            loadSavedData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Load initial data
            await loadAllData();
            
            // Set up auto-refresh (twice weekly: Wednesday and Saturday at 9 AM)
            setupAutoRefresh();
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Category tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = e.target.dataset.category;
                    filterAndDisplayIndicators();
                });
            });
            
            // Search input
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                filterAndDisplayIndicators();
            });
        }
        
        // Load all data from the Fed API
        async function loadAllData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Loading...';
            
            updateStatus('loading', 'Loading data...');
            
            try {
                // Simple fetch like the working OpenBB code
                const summaryResponse = await fetch(`${FED_API_URL}/?series=summary`);
                const summaryData = await summaryResponse.json();
                
                // Process summary data
                if (summaryData.metrics) {
                    summaryData.metrics.forEach(metric => {
                        allIndicatorData[metric.series] = {
                            name: metric.name,
                            value: metric.latest_value,
                            date: metric.latest_date,
                            week_change: metric.week_change || 0,
                            cached: metric.cached
                        };
                    });
                }
                
                // Load percentage changes for all indicators
                await loadPercentageChanges();
                
                // Update header stats
                updateHeaderStats();
                
                // Display all indicators
                filterAndDisplayIndicators();
                
                // Update status
                updateStatus('connected', 'Connected');
                
                // Update last update time
                document.getElementById('lastUpdate').textContent = 
                    `Last Updated: ${new Date().toLocaleString()} | Auto-refresh: Wed & Sat 9 AM ET`;
                
                // Update total indicators count
                document.getElementById('totalIndicators').textContent = 
                    Object.keys(allIndicatorData).length;
                
            } catch (error) {
                console.error('Error loading data:', error);
                updateStatus('error', 'Connection error');
                
                // Show error in grid
                const grid = document.getElementById('indicatorsGrid');
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1;">
                        <div class="error-message">
                            <h3>Connection Error</h3>
                            <p>Unable to connect to Fed Liquidity API</p>
                            <p style="margin-top: 1rem;">Error: ${error.message}</p>
                        </div>
                    </div>
                `;
                
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Data';
            }
        }
        
        // Load percentage changes for all key indicators
        async function loadPercentageChanges() {
            // Get percentage changes for key series
            const keySeriesList = [
                'WRBWFRBL', 'WALCL', 'WCURCIR', 'WTREGEN', 'RRPONTSYD',
                'TOTRESNS', 'WSHOTSL', 'WLCFLL', 'BOGMBASE', 'RESPPANWW'
            ];
            
            for (const series of keySeriesList) {
                try {
                    // Simple fetch like the working OpenBB code
                    const changesResponse = await fetch(
                        `${FED_API_URL}/?action=changes&series=${series}&period=all`
                    );
                    const changesData = await changesResponse.json();
                    
                    if (!changesData.error) {
                        // Merge changes data with existing indicator data
                        if (!allIndicatorData[series]) {
                            allIndicatorData[series] = {};
                        }
                        
                        allIndicatorData[series] = {
                            ...allIndicatorData[series],
                            name: changesData.name || allIndicatorData[series]?.name || series,
                            value: changesData.latest_value,
                            date: changesData.latest_date,
                            week_change: changesData.week_change?.percentage || 0,
                            month_change: changesData.month_change?.percentage || 0,
                            quarter_change: changesData.quarter_change?.percentage || 0,
                            year_change: changesData.year_change?.percentage || 0
                        };
                    }
                } catch (error) {
                    console.error(`Error loading changes for ${series}:`, error);
                }
            }
            
            // Load individual series data for remaining indicators
            const allSeries = Object.keys(FED_LIQUIDITY_CATEGORIES).flatMap(
                cat => FED_LIQUIDITY_CATEGORIES[cat]
            );
            
            // Batch load remaining series (limit concurrent requests)
            const batchSize = 5;
            for (let i = 0; i < allSeries.length; i += batchSize) {
                const batch = allSeries.slice(i, i + batchSize);
                const promises = batch.map(series => loadSeriesData(series));
                await Promise.allSettled(promises);
            }
        }
        
        // Load data for a single series
        async function loadSeriesData(series) {
            if (allIndicatorData[series]?.week_change !== undefined) {
                return; // Already loaded with changes
            }
            
            try {
                const response = await fetch(`${FED_API_URL}/?series=${series}`);
                const data = await response.json();
                
                if (!data.error && data.latest) {
                    // Calculate simple percentage changes from observations if available
                    let weekChange = 0, monthChange = 0, quarterChange = 0, yearChange = 0;
                    
                    if (data.observations && data.observations.length > 1) {
                        const latest = data.observations[0].value;
                        
                        // Find historical values for comparison
                        data.observations.forEach((obs, index) => {
                            const daysAgo = Math.floor(
                                (new Date() - new Date(obs.date)) / (1000 * 60 * 60 * 24)
                            );
                            
                            if (daysAgo >= 7 && daysAgo <= 10 && weekChange === 0) {
                                weekChange = ((latest - obs.value) / obs.value * 100);
                            }
                            if (daysAgo >= 28 && daysAgo <= 35 && monthChange === 0) {
                                monthChange = ((latest - obs.value) / obs.value * 100);
                            }
                            if (daysAgo >= 85 && daysAgo <= 95 && quarterChange === 0) {
                                quarterChange = ((latest - obs.value) / obs.value * 100);
                            }
                            if (daysAgo >= 360 && daysAgo <= 370 && yearChange === 0) {
                                yearChange = ((latest - obs.value) / obs.value * 100);
                            }
                        });
                    }
                    
                    allIndicatorData[series] = {
                        name: data.name || series,
                        value: data.latest.value,
                        date: data.latest.date,
                        week_change: weekChange,
                        month_change: monthChange,
                        quarter_change: quarterChange,
                        year_change: yearChange,
                        cached: data.cached || false
                    };
                }
            } catch (error) {
                console.error(`Error loading ${series}:`, error);
            }
        }
        
        // Update header statistics
        function updateHeaderStats() {
            // Fed Balance Sheet (WALCL)
            if (allIndicatorData.WALCL) {
                const value = allIndicatorData.WALCL.value;
                const formatted = value ? `$${(value / 1000000).toFixed(2)}T` : '-';
                document.getElementById('fedBalance').textContent = formatted;
            }
            
            // Reserve Balances (WRBWFRBL)
            if (allIndicatorData.WRBWFRBL) {
                const value = allIndicatorData.WRBWFRBL.value;
                const formatted = value ? `$${(value / 1000000).toFixed(2)}T` : '-';
                document.getElementById('reserveBalances').textContent = formatted;
            }
            
            // Overnight RRP (RRPONTSYD)
            if (allIndicatorData.RRPONTSYD) {
                const value = allIndicatorData.RRPONTSYD.value;
                const formatted = value ? `$${value.toFixed(0)}B` : '-';
                document.getElementById('overnightRRP').textContent = formatted;
            }
        }
        
        // Filter and display indicators based on category and search
        function filterAndDisplayIndicators() {
            const grid = document.getElementById('indicatorsGrid');
            grid.innerHTML = '';
            
            if (currentCategory === 'favorites') {
                // Show favorites
                if (favorites.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-favorites">
                            <h3>No Favorites Yet</h3>
                            <p>Click the star icon on any indicator to add it to your favorites</p>
                        </div>
                    `;
                } else {
                    favorites.forEach(series => {
                        if (shouldShowIndicator(series)) {
                            const card = createIndicatorCard(series);
                            if (card) grid.appendChild(card);
                        }
                    });
                }
            } else if (currentCategory === 'all') {
                // Show all indicators grouped by category
                Object.keys(FED_LIQUIDITY_CATEGORIES).forEach(category => {
                    const categoryIndicators = FED_LIQUIDITY_CATEGORIES[category];
                    
                    // Add category header
                    const header = document.createElement('div');
                    header.className = 'category-header';
                    header.textContent = getCategoryDisplayName(category);
                    grid.appendChild(header);
                    
                    // Add indicators for this category
                    categoryIndicators.forEach(series => {
                        if (shouldShowIndicator(series)) {
                            const card = createIndicatorCard(series);
                            if (card) grid.appendChild(card);
                        }
                    });
                });
            } else {
                // Show specific category
                const categoryIndicators = FED_LIQUIDITY_CATEGORIES[currentCategory] || [];
                categoryIndicators.forEach(series => {
                    if (shouldShowIndicator(series)) {
                        const card = createIndicatorCard(series);
                        if (card) grid.appendChild(card);
                    }
                });
            }
            
            if (grid.children.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">No indicators found matching your criteria.</div>';
            }
        }
        
        // Check if indicator should be shown based on search
        function shouldShowIndicator(series) {
            if (!searchTerm) return true;
            
            const data = allIndicatorData[series];
            if (!data) return false;
            
            const displayName = customNames[series] || data.name;
            
            return series.toLowerCase().includes(searchTerm) ||
                   displayName.toLowerCase().includes(searchTerm);
        }
        
        // Create indicator card element
        function createIndicatorCard(series) {
            const data = allIndicatorData[series];
            if (!data) return null;
            
            const card = document.createElement('div');
            card.className = 'indicator-card';
            
            // Get custom name or use default
            const displayName = customNames[series] || data.name || series;
            const isFavorited = favorites.includes(series);
            
            // Format value
            let formattedValue = '-';
            if (data.value !== null && data.value !== undefined) {
                if (series.includes('WALCL') || series.includes('BALANCE') || 
                    series.includes('WRBWFRBL') || series.includes('TOTRESNS')) {
                    // Large values in trillions
                    formattedValue = `$${(data.value / 1000000).toFixed(3)}T`;
                } else if (series.includes('RATE') || series.includes('DGS')) {
                    // Rates as percentages
                    formattedValue = `${data.value.toFixed(3)}%`;
                } else if (data.value > 1000000) {
                    // Large values in trillions
                    formattedValue = `$${(data.value / 1000000).toFixed(3)}T`;
                } else if (data.value > 1000) {
                    // Values in billions
                    formattedValue = `$${(data.value / 1000).toFixed(1)}B`;
                } else {
                    formattedValue = data.value.toFixed(2);
                }
            }
            
            card.innerHTML = `
                <button class="edit-btn" onclick="editIndicatorName('${series}', '${displayName.replace(/'/g, "\\'")}')">‚úèÔ∏è</button>
                <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${series}')">
                    ${isFavorited ? '‚≠ê' : '‚òÜ'}
                </button>
                <div class="indicator-header">
                    <div class="indicator-title-wrapper">
                        <div class="indicator-title" ondblclick="editIndicatorName('${series}', '${displayName.replace(/'/g, "\\'")}')">${displayName}</div>
                        <div class="indicator-symbol">${series}</div>
                    </div>
                </div>
                <div class="indicator-value">${formattedValue}</div>
                <div class="indicator-date">Latest: ${data.date || 'N/A'}</div>
                <div class="changes-grid">
                    <div class="change-item">
                        <div class="change-period">Week</div>
                        <div class="change-value ${getChangeClass(data.week_change)}">
                            ${formatChange(data.week_change)}
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-period">Month</div>
                        <div class="change-value ${getChangeClass(data.month_change)}">
                            ${formatChange(data.month_change)}
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-period">Quarter</div>
                        <div class="change-value ${getChangeClass(data.quarter_change)}">
                            ${formatChange(data.quarter_change)}
                        </div>
                    </div>
                    <div class="change-item">
                        <div class="change-period">Year</div>
                        <div class="change-value ${getChangeClass(data.year_change)}">
                            ${formatChange(data.year_change)}
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Get category display name
        function getCategoryDisplayName(category) {
            const names = {
                'reserves': 'üè¶ RESERVES',
                'currency': 'üíµ CURRENCY',
                'treasury_account': 'üèõÔ∏è TREASURY ACCOUNT',
                'repo_operations': 'üîÑ REPO OPERATIONS',
                'securities': 'üìä SECURITIES',
                'lending_facilities': 'üí∞ LENDING FACILITIES',
                'emergency_programs': 'üö® EMERGENCY PROGRAMS',
                'balance_sheet': 'üìà BALANCE SHEET',
                'other_assets': 'üì¶ OTHER ASSETS'
            };
            return names[category] || category.toUpperCase();
        }
        
        // Format percentage change
        function formatChange(change) {
            if (change === null || change === undefined || change === 0) {
                return '0.00%';
            }
            const sign = change > 0 ? '+' : '';
            return `${sign}${change.toFixed(2)}%`;
        }
        
        // Get CSS class for change value
        function getChangeClass(change) {
            if (change === null || change === undefined) return 'neutral';
            if (change > 0) return 'positive';
            if (change < 0) return 'negative';
            return 'neutral';
        }
        
        // Update status indicator
        function updateStatus(status, text) {
            const statusDot = document.getElementById('apiStatus');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }
        
        // Setup auto-refresh (twice weekly)
        function setupAutoRefresh() {
            // Clear existing interval if any
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Check every hour if it's time to refresh
            autoRefreshInterval = setInterval(() => {
                const now = new Date();
                const day = now.getDay();
                const hour = now.getHours();
                
                // Refresh on Wednesday (3) and Saturday (6) at 9 AM
                if ((day === 3 || day === 6) && hour === 9) {
                    console.log('Auto-refreshing data...');
                    loadAllData();
                }
            }, 3600000); // Check every hour
        }
        
        // Initialize dashboard on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
