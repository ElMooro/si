<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Market Intelligence - Complete Multi-Security Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .real-data-badge {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .api-status {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: blink 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 15px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #a0a0a0;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .security-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .security-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .security-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .metric {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .metric-value.positive { color: #4ade80; }
        .metric-value.negative { color: #ff4444; }
        .metric-value.neutral { color: #fbbf24; }

        .indicator-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .indicator-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #ffffff;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .indicators-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .indicator-item {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .indicator-name {
            font-size: 12px;
            color: #aaa;
        }

        .indicator-value {
            font-size: 16px;
            font-weight: bold;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 450px;
        }

        .summary-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .crisis-meter {
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            text-align: center;
        }

        .meter-container {
            position: relative;
            height: 40px;
            background: linear-gradient(90deg, #4ade80 0%, #fbbf24 50%, #ff4444 100%);
            border-radius: 20px;
            margin: 20px 0;
        }

        .meter-pointer {
            position: absolute;
            top: -5px;
            width: 6px;
            height: 50px;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transition: left 1s ease;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.03);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>
                üèõÔ∏è Treasury Market Intelligence
                <span class="real-data-badge">REAL DATA ONLY</span>
            </h1>
            <div class="api-status">
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>API Connected</span>
                </div>
                <div class="status-indicator">
                    <span id="lastUpdate">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('auction-results')">üìä Auction Results</div>
            <div class="tab" onclick="switchTab('all-indicators')">üìà All 31 Indicators</div>
            <div class="tab" onclick="switchTab('crisis-analysis')">üö® Crisis Analysis</div>
            <div class="tab" onclick="switchTab('liquidity-analysis')">üíß Liquidity Analysis</div>
            <div class="tab" onclick="switchTab('summary')">üìã Comprehensive Summary</div>
            <div class="tab" onclick="switchTab('yield-analysis')">üìâ Yield Analysis</div>
            <div class="tab" onclick="switchTab('participation')">üë• Participation</div>
            <div class="tab" onclick="switchTab('interpretation')">üí° Market Interpretation</div>
            <div class="tab" onclick="switchTab('historical')">üìú Historical Charts</div>
        </div>

        <!-- Auction Results Tab -->
        <div class="tab-content active" id="auction-results">
            <h2 style="margin-bottom: 20px; color: #fff;">Latest Auction Results - All Securities</h2>
            <div class="security-grid" id="auctionResultsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading auction data for all securities...</p>
                </div>
            </div>
        </div>

        <!-- All 31 Indicators Tab -->
        <div class="tab-content" id="all-indicators">
            <h2 style="margin-bottom: 20px; color: #fff;">All 31 Treasury Indicators - All Securities</h2>
            <div id="indicatorsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading all indicators...</p>
                </div>
            </div>
        </div>

        <!-- Crisis Analysis Tab -->
        <div class="tab-content" id="crisis-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Crisis Detection Analysis - All Securities</h2>
            <div class="crisis-meter">
                <h3>Aggregate Crisis Score</h3>
                <div class="meter-container">
                    <div class="meter-pointer" id="crisisMeter" style="left: 10%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888;">
                    <span>Low Risk (0)</span>
                    <span>Moderate (5)</span>
                    <span>High Risk (10)</span>
                </div>
            </div>
            <div id="crisisIndicators">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing crisis indicators...</p>
                </div>
            </div>
            <div class="chart-container">
                <div id="crisisChart"></div>
            </div>
        </div>

        <!-- Liquidity Analysis Tab -->
        <div class="tab-content" id="liquidity-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Liquidity Analysis - All Securities</h2>
            <div id="liquidityMetrics">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing liquidity metrics...</p>
                </div>
            </div>
            <div class="chart-container">
                <div id="liquidityChart"></div>
            </div>
        </div>

        <!-- Comprehensive Summary Tab -->
        <div class="tab-content" id="summary">
            <h2 style="margin-bottom: 20px; color: #fff;">Comprehensive Market Summary</h2>
            <div class="summary-section" id="summaryContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating comprehensive summary...</p>
                </div>
            </div>
        </div>

        <!-- Yield Analysis Tab -->
        <div class="tab-content" id="yield-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Yield Analysis - All Securities</h2>
            <div class="chart-container">
                <div id="yieldCurveChart"></div>
            </div>
            <div id="yieldMetrics">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing yields...</p>
                </div>
            </div>
        </div>

        <!-- Participation Tab -->
        <div class="tab-content" id="participation">
            <h2 style="margin-bottom: 20px; color: #fff;">Market Participation - All Securities</h2>
            <div id="participationMetrics">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing participation...</p>
                </div>
            </div>
            <div class="chart-container">
                <div id="participationChart"></div>
            </div>
        </div>

        <!-- Market Interpretation Tab -->
        <div class="tab-content" id="interpretation">
            <h2 style="margin-bottom: 20px; color: #fff;">Market Interpretation</h2>
            <div class="summary-section" id="interpretationContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating market interpretation...</p>
                </div>
            </div>
        </div>

        <!-- Historical Charts Tab -->
        <div class="tab-content" id="historical">
            <h2 style="margin-bottom: 20px; color: #fff;">Historical Data - All Securities</h2>
            <div id="historicalChartsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading historical data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'https://api.fiscaldata.treasury.gov/services/api/fiscal_service';
        const SECURITIES = [
            { name: '4-Week', term: '4-Week', type: 'Bill' },
            { name: '8-Week', term: '8-Week', type: 'Bill' },
            { name: '13-Week', term: '13-Week', type: 'Bill' },
            { name: '26-Week', term: '26-Week', type: 'Bill' },
            { name: '52-Week', term: '52-Week', type: 'Bill' },
            { name: '2-Year', term: '2-Year', type: 'Note' },
            { name: '3-Year', term: '3-Year', type: 'Note' },
            { name: '5-Year', term: '5-Year', type: 'Note' },
            { name: '7-Year', term: '7-Year', type: 'Note' },
            { name: '10-Year', term: '10-Year', type: 'Note' },
            { name: '30-Year', term: '30-Year', type: 'Bond' }
        ];

        // All 31 indicators
        const INDICATORS = {
            core: ['auction_date', 'security_type', 'security_term', 'cusip', 'issue_date'],
            volume: ['bid_to_cover_ratio', 'total_accepted', 'total_tendered'],
            yield: ['high_rate', 'median_rate', 'low_rate', 'yield_range', 'tail', 'wi_yield'],
            participation: ['primary_dealer_pct', 'direct_bidder_pct', 'indirect_bidder_pct', 'foreign_participation'],
            risk: ['market_depth_ratio', 'abnormal_auction', 'severe_tail', 'extreme_tail', 'weak_coverage'],
            change: ['bid_to_cover_change', 'yield_change', 'tail_change', 'primary_dealer_change', 'foreign_change'],
            crisis: ['crisis_score', 'crisis_level', 'active_indicators']
        };

        let currentData = {
            auctions: {},
            indicators: {},
            crisis: {},
            liquidity: {},
            historical: {}
        };

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
        }

        // Fetch auction data for all securities
        async function fetchAllAuctionData() {
            const results = {};
            
            for (const security of SECURITIES) {
                try {
                    // Fetch from Treasury Direct API
                    const response = await fetch(
                        `${API_BASE}/v1/accounting/od/auction_results?filter=security_term:eq:${security.term}&sort=-auction_date&page[size]=1`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && data.data.length > 0) {
                            results[security.name] = processAuctionData(data.data[0]);
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching ${security.name} data:`, error);
                }
            }
            
            currentData.auctions = results;
            return results;
        }

        // Process auction data to calculate all 31 indicators
        function processAuctionData(auction) {
            const processed = {
                // Core Data (5)
                auction_date: auction.auction_date,
                security_type: auction.security_type,
                security_term: auction.security_term,
                cusip: auction.cusip,
                issue_date: auction.issue_date,
                
                // Volume Indicators (3)
                bid_to_cover_ratio: parseFloat(auction.bid_to_cover_ratio) || 0,
                total_accepted: parseFloat(auction.total_accepted) || 0,
                total_tendered: parseFloat(auction.total_tendered) || 0,
                
                // Yield Indicators (6)
                high_rate: parseFloat(auction.high_investment_rate) || 0,
                median_rate: parseFloat(auction.median_investment_rate) || 0,
                low_rate: parseFloat(auction.low_investment_rate) || 0,
                yield_range: 0,
                tail: 0,
                wi_yield: parseFloat(auction.high_investment_rate) || 0, // Approximation
                
                // Participation Indicators (4)
                primary_dealer_pct: parseFloat(auction.primary_dealer_accepted_pct) || 0,
                direct_bidder_pct: parseFloat(auction.direct_bidder_accepted_pct) || 0,
                indirect_bidder_pct: parseFloat(auction.indirect_bidder_accepted_pct) || 0,
                foreign_participation: parseFloat(auction.indirect_bidder_accepted_pct) || 0,
                
                // Risk Indicators (5)
                market_depth_ratio: 0,
                abnormal_auction: false,
                severe_tail: false,
                extreme_tail: false,
                weak_coverage: false,
                
                // Change Indicators (5)
                bid_to_cover_change: 0,
                yield_change: 0,
                tail_change: 0,
                primary_dealer_change: 0,
                foreign_change: 0,
                
                // Crisis Detection (3)
                crisis_score: 0,
                crisis_level: 'NONE',
                active_indicators: []
            };
            
            // Calculate derived indicators
            processed.yield_range = (processed.high_rate - processed.low_rate) * 100; // in basis points
            processed.tail = (processed.high_rate - processed.median_rate) * 100; // in basis points
            processed.market_depth_ratio = processed.total_tendered / processed.total_accepted;
            
            // Risk assessments
            processed.abnormal_auction = processed.bid_to_cover_ratio < 2.3;
            processed.severe_tail = processed.tail > 3;
            processed.extreme_tail = processed.tail > 5;
            processed.weak_coverage = processed.bid_to_cover_ratio < 2.0;
            
            // Calculate crisis score
            let score = 0;
            const indicators = [];
            
            if (processed.weak_coverage) {
                score += 2;
                indicators.push('WEAK_COVERAGE');
            }
            if (processed.extreme_tail) {
                score += 3;
                indicators.push('EXTREME_TAIL');
            } else if (processed.severe_tail) {
                score += 2;
                indicators.push('SEVERE_TAIL');
            }
            if (processed.primary_dealer_pct > 50) {
                score += 2;
                indicators.push('HIGH_DEALER_CONCENTRATION');
            }
            if (processed.foreign_participation < 30) {
                score += 2;
                indicators.push('LOW_FOREIGN_PARTICIPATION');
            }
            
            processed.crisis_score = Math.min(score, 10);
            processed.active_indicators = indicators;
            
            // Determine crisis level
            if (score >= 7) processed.crisis_level = 'SEVERE';
            else if (score >= 5) processed.crisis_level = 'HIGH';
            else if (score >= 3) processed.crisis_level = 'MODERATE';
            else if (score >= 1) processed.crisis_level = 'LOW';
            else processed.crisis_level = 'NONE';
            
            return processed;
        }

        // Display auction results
        function displayAuctionResults() {
            const grid = document.getElementById('auctionResultsGrid');
            grid.innerHTML = '';
            
            const prioritySecurities = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            
            prioritySecurities.forEach(secName => {
                const auction = currentData.auctions[secName];
                if (!auction) return;
                
                const card = document.createElement('div');
                card.className = 'security-card';
                
                card.innerHTML = `
                    <div class="security-header">
                        <div class="security-title">${secName} Treasury</div>
                        <div style="color: ${getCrisisColor(auction.crisis_level)}">
                            ${auction.crisis_level}
                        </div>
                    </div>
                    <div class="metrics-grid">
                        <div class="metric">
                            <div class="metric-label">Auction Date</div>
                            <div class="metric-value">${auction.auction_date || 'N/A'}</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">High Yield</div>
                            <div class="metric-value ${auction.high_rate > 5 ? 'negative' : 'positive'}">
                                ${auction.high_rate.toFixed(3)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Bid-to-Cover</div>
                            <div class="metric-value ${auction.bid_to_cover_ratio < 2.3 ? 'negative' : 'positive'}">
                                ${auction.bid_to_cover_ratio.toFixed(2)}
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Tail (bps)</div>
                            <div class="metric-value ${auction.tail > 3 ? 'negative' : auction.tail > 1 ? 'neutral' : 'positive'}">
                                ${auction.tail.toFixed(1)}
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Foreign %</div>
                            <div class="metric-value ${auction.foreign_participation < 30 ? 'negative' : 'positive'}">
                                ${auction.foreign_participation.toFixed(1)}%
                            </div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">Crisis Score</div>
                            <div class="metric-value ${auction.crisis_score > 5 ? 'negative' : auction.crisis_score > 3 ? 'neutral' : 'positive'}">
                                ${auction.crisis_score}/10
                            </div>
                        </div>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        // Display all 31 indicators
        function displayAllIndicators() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = '';
            
            // Create sections for each security
            const prioritySecurities = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            
            prioritySecurities.forEach(secName => {
                const auction = currentData.auctions[secName];
                if (!auction) return;
                
                const section = document.createElement('div');
                section.className = 'indicator-section';
                
                let html = `<h3 style="color: #fff; margin-bottom: 20px;">${secName} Treasury - All 31 Indicators</h3>`;
                
                Object.entries(INDICATORS).forEach(([category, indicators]) => {
                    html += `
                        <div class="indicator-category">
                            <div class="category-title">${category.charAt(0).toUpperCase() + category.slice(1)} Indicators</div>
                            <div class="indicators-list">
                    `;
                    
                    indicators.forEach(indicator => {
                        const value = auction[indicator];
                        let displayValue = value;
                        let valueClass = '';
                        
                        if (typeof value === 'boolean') {
                            displayValue = value ? 'YES' : 'NO';
                            valueClass = value ? 'negative' : 'positive';
                        } else if (typeof value === 'number') {
                            displayValue = value.toFixed(2);
                            if (indicator.includes('change')) {
                                valueClass = value > 0 ? 'negative' : 'positive';
                            }
                        } else if (Array.isArray(value)) {
                            displayValue = value.length > 0 ? value.join(', ') : 'None';
                        }
                        
                        html += `
                            <div class="indicator-item">
                                <span class="indicator-name">${indicator.replace(/_/g, ' ')}</span>
                                <span class="indicator-value ${valueClass}">${displayValue || 'N/A'}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                section.innerHTML = html;
                container.appendChild(section);
            });
        }

        // Display crisis analysis
        function displayCrisisAnalysis() {
            const container = document.getElementById('crisisIndicators');
            container.innerHTML = '';
            
            // Calculate aggregate crisis score
            let totalScore = 0;
            let count = 0;
            const allIndicators = new Set();
            
            Object.values(currentData.auctions).forEach(auction => {
                totalScore += auction.crisis_score || 0;
                count++;
                auction.active_indicators?.forEach(ind => allIndicators.add(ind));
            });
            
            const avgScore = count > 0 ? totalScore / count : 0;
            
            // Update meter
            const meter = document.getElementById('crisisMeter');
            meter.style.left = `${(avgScore / 10) * 100}%`;
            
            // Display crisis indicators by security
            const html = `
                <h3 style="margin: 20px 0;">Aggregate Crisis Score: ${avgScore.toFixed(1)}/10</h3>
                <h4 style="margin: 15px 0;">Active Crisis Indicators:</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                    ${Array.from(allIndicators).map(ind => `
                        <div style="background: rgba(255, 68, 68, 0.1); padding: 10px; border-radius: 8px; border-left: 4px solid #ff4444;">
                            ${ind.replace(/_/g, ' ')}
                        </div>
                    `).join('')}
                </div>
            `;
            
            container.innerHTML = html;
            
            // Create crisis chart
            createCrisisChart();
        }

        // Display liquidity analysis
        function displayLiquidityAnalysis() {
            const container = document.getElementById('liquidityMetrics');
            container.innerHTML = '';
            
            // Calculate aggregate liquidity metrics
            let totalDepth = 0;
            let totalForeign = 0;
            let totalDealer = 0;
            let count = 0;
            
            Object.values(currentData.auctions).forEach(auction => {
                totalDepth += auction.market_depth_ratio || 0;
                totalForeign += auction.foreign_participation || 0;
                totalDealer += auction.primary_dealer_pct || 0;
                count++;
            });
            
            const avgDepth = count > 0 ? totalDepth / count : 0;
            const avgForeign = count > 0 ? totalForeign / count : 0;
            const avgDealer = count > 0 ? totalDealer / count : 0;
            
            const html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div class="security-card">
                        <h3>Market Depth</h3>
                        <div class="metric-value ${avgDepth < 2 ? 'negative' : 'positive'}" style="font-size: 36px;">
                            ${avgDepth.toFixed(2)}
                        </div>
                        <p style="color: #888;">Average across all securities</p>
                    </div>
                    <div class="security-card">
                        <h3>Foreign Participation</h3>
                        <div class="metric-value ${avgForeign < 30 ? 'negative' : 'positive'}" style="font-size: 36px;">
                            ${avgForeign.toFixed(1)}%
                        </div>
                        <p style="color: #888;">Average indirect bidder %</p>
                    </div>
                    <div class="security-card">
                        <h3>Dealer Concentration</h3>
                        <div class="metric-value ${avgDealer > 50 ? 'negative' : 'positive'}" style="font-size: 36px;">
                            ${avgDealer.toFixed(1)}%
                        </div>
                        <p style="color: #888;">Average primary dealer %</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Create liquidity chart
            createLiquidityChart();
        }

        // Display comprehensive summary
        function displaySummary() {
            const container = document.getElementById('summaryContent');
            
            // Generate summary based on all securities
            const securities = Object.keys(currentData.auctions);
            const crisisSecurities = securities.filter(s => 
                currentData.auctions[s].crisis_level === 'HIGH' || 
                currentData.auctions[s].crisis_level === 'SEVERE'
            );
            
            const html = `
                <h3>Market Overview</h3>
                <p style="margin: 15px 0;">
                    Analysis of ${securities.length} Treasury securities shows 
                    ${crisisSecurities.length > 0 ? `elevated stress in ${crisisSecurities.join(', ')}` : 'normal market conditions'}.
                </p>
                
                <h3 style="margin-top: 20px;">Key Findings</h3>
                <ul style="margin: 15px 0; padding-left: 20px;">
                    ${securities.map(s => {
                        const a = currentData.auctions[s];
                        return `<li>${s}: BTC ${a.bid_to_cover_ratio.toFixed(2)}, Tail ${a.tail.toFixed(1)}bp, ${a.crisis_level}</li>`;
                    }).join('')}
                </ul>
                
                <h3 style="margin-top: 20px;">Risk Assessment</h3>
                <p style="margin: 15px 0;">
                    ${crisisSecurities.length > 0 ? 
                        `‚ö†Ô∏è WARNING: ${crisisSecurities.length} securities showing elevated risk indicators` : 
                        '‚úÖ All securities within normal parameters'}
                </p>
            `;
            
            container.innerHTML = html;
        }

        // Create yield curve chart
        function createYieldCurveChart() {
            const securities = ['4-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            const maturities = [0.077, 0.25, 2, 10, 30]; // Years
            const yields = securities.map(s => currentData.auctions[s]?.high_rate || 0);
            
            const trace = {
                x: maturities,
                y: yields,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Yield Curve',
                line: { color: '#667eea', width: 3 },
                marker: { size: 10, color: '#667eea' }
            };
            
            const layout = {
                title: 'Treasury Yield Curve',
                xaxis: { 
                    title: 'Maturity (Years)', 
                    type: 'log',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: { 
                    title: 'Yield (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('yieldCurveChart', [trace], layout, {responsive: true});
        }

        // Create participation chart
        function createParticipationChart() {
            const securities = Object.keys(currentData.auctions);
            
            const traces = [
                {
                    x: securities,
                    y: securities.map(s => currentData.auctions[s].primary_dealer_pct),
                    name: 'Primary Dealers',
                    type: 'bar',
                    marker: { color: '#ff4444' }
                },
                {
                    x: securities,
                    y: securities.map(s => currentData.auctions[s].direct_bidder_pct),
                    name: 'Direct Bidders',
                    type: 'bar',
                    marker: { color: '#667eea' }
                },
                {
                    x: securities,
                    y: securities.map(s => currentData.auctions[s].indirect_bidder_pct),
                    name: 'Indirect Bidders',
                    type: 'bar',
                    marker: { color: '#4ade80' }
                }
            ];
            
            const layout = {
                title: 'Market Participation by Security',
                barmode: 'stack',
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Participation %',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('participationChart', traces, layout, {responsive: true});
        }

        // Create crisis chart
        function createCrisisChart() {
            const securities = Object.keys(currentData.auctions);
            const scores = securities.map(s => currentData.auctions[s].crisis_score);
            
            const trace = {
                x: securities,
                y: scores,
                type: 'bar',
                marker: {
                    color: scores.map(s => 
                        s >= 7 ? '#ff0000' : 
                        s >= 5 ? '#ff4444' : 
                        s >= 3 ? '#fbbf24' : 
                        '#4ade80'
                    )
                }
            };
            
            const layout = {
                title: 'Crisis Scores by Security',
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Crisis Score (0-10)',
                    range: [0, 10],
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('crisisChart', [trace], layout, {responsive: true});
        }

        // Create liquidity chart
        function createLiquidityChart() {
            const securities = Object.keys(currentData.auctions);
            
            const trace1 = {
                x: securities,
                y: securities.map(s => currentData.auctions[s].market_depth_ratio),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Market Depth Ratio',
                yaxis: 'y',
                line: { color: '#667eea', width: 2 }
            };
            
            const trace2 = {
                x: securities,
                y: securities.map(s => currentData.auctions[s].bid_to_cover_ratio),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Bid-to-Cover',
                yaxis: 'y2',
                line: { color: '#4ade80', width: 2 }
            };
            
            const layout = {
                title: 'Liquidity Metrics Across Securities',
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Market Depth',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Bid-to-Cover',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('liquidityChart', [trace1, trace2], layout, {responsive: true});
        }

        // Create historical charts
        async function createHistoricalCharts() {
            const container = document.getElementById('historicalChartsContainer');
            container.innerHTML = '';
            
            const prioritySecurities = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            
            for (const security of prioritySecurities) {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `<div id="historical-${security}" style="height: 400px;"></div>`;
                container.appendChild(chartDiv);
                
                // Fetch historical data
                try {
                    const response = await fetch(
                        `${API_BASE}/v1/accounting/od/auction_results?filter=security_term:eq:${security}&sort=-auction_date&page[size]=30`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && data.data.length > 0) {
                            createHistoricalChart(security, data.data);
                        }
                    }
                } catch (error) {
                    console.error(`Error fetching historical data for ${security}:`, error);
                }
            }
        }

        // Create individual historical chart
        function createHistoricalChart(security, data) {
            const dates = data.map(d => d.auction_date).reverse();
            const btc = data.map(d => parseFloat(d.bid_to_cover_ratio) || 0).reverse();
            const yields = data.map(d => parseFloat(d.high_investment_rate) || 0).reverse();
            
            const trace1 = {
                x: dates,
                y: btc,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Bid-to-Cover',
                yaxis: 'y',
                line: { color: '#4ade80' }
            };
            
            const trace2 = {
                x: dates,
                y: yields,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Yield (%)',
                yaxis: 'y2',
                line: { color: '#667eea' }
            };
            
            const layout = {
                title: `${security} Treasury - Historical Data`,
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Bid-to-Cover',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Yield (%)',
                    overlaying: 'y',
                    side: 'right'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                showlegend: true
            };
            
            Plotly.newPlot(`historical-${security}`, [trace1, trace2], layout, {responsive: true});
        }

        // Get crisis color
        function getCrisisColor(level) {
            switch(level) {
                case 'SEVERE': return '#ff0000';
                case 'HIGH': return '#ff4444';
                case 'MODERATE': return '#fbbf24';
                case 'LOW': return '#4ade80';
                default: return '#888888';
            }
        }

        // Initialize dashboard
        async function initializeDashboard() {
            document.getElementById('lastUpdate').textContent = 'Loading...';
            
            // Fetch all auction data
            await fetchAllAuctionData();
            
            // Display all sections
            displayAuctionResults();
            displayAllIndicators();
            displayCrisisAnalysis();
            displayLiquidityAnalysis();
            displaySummary();
            
            // Create charts
            createYieldCurveChart();
            createParticipationChart();
            createHistoricalCharts();
            
            // Update timestamp
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            
            // Refresh every 60 seconds
            setInterval(initializeDashboard, 60000);
        }

        // Start the dashboard
        window.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
