<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Financial Dashboard - FRED-Style Percentage Changes</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .api-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .search-loading {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .search-loading.active {
            display: block;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20, 24, 44, 0.98);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: rgba(0, 255, 136, 0.1);
            padding-left: 2rem;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-category {
            font-size: 0.75rem;
            color: #00ff88;
            margin-bottom: 0.25rem;
        }
        
        .search-result-name {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 0.25rem;
        }
        
        .search-result-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .chart-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .chart-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        /* Chart Type Toggle */
        .chart-type-toggle {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            border-radius: 8px;
        }
        
        .toggle-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
        }
        
        /* Chart Stats */
        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .stat-box {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .trend-indicator {
            display: inline-block;
            margin-left: 0.5rem;
            padding: 0.25rem 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            font-size: 0.75rem;
        }
        
        .trend-reversal {
            background: rgba(255, 170, 0, 0.3);
            color: #ffaa00;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        #mainChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Watchlist Container */
        .watchlist-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .watchlist-table thead {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .watchlist-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            color: #00ff88;
            font-weight: bold;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .watchlist-table tbody tr {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .watchlist-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .watchlist-table tbody tr.selected {
            background: rgba(0, 255, 136, 0.15);
            border-left: 3px solid #00ff88;
        }
        
        .indicator-name {
            font-weight: bold;
            color: #fff;
        }
        
        .indicator-symbol {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .value-cell {
            font-weight: bold;
            color: #fff;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }
        
        .change-value {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .remove-btn {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .remove-btn:hover {
            background: rgba(255, 68, 68, 0.3);
            transform: scale(1.05);
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty state */
        .empty-watchlist {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .empty-watchlist-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">📊 OpenBB Dashboard - FRED-Style % Changes</div>
            <div class="api-status">
                <div class="api-indicator">
                    <div class="status-dot loading" id="fredStatus"></div>
                    <span>FRED</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="ecbStatus"></div>
                    <span>ECB</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="ofrStatus"></div>
                    <span>OFR</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="nyfedStatus"></div>
                    <span>NY Fed</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="treasuryStatus"></div>
                    <span>Treasury</span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-wrapper">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search all indicators: VIX, DXY, CISS, CMDI, SOFR, EFFR, TED Spread, ICE BofA, Fed Balance..."
                >
                <div class="search-loading" id="searchLoading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Select an indicator to view data with percentage changes</div>
                <div class="chart-controls">
                    <button class="chart-btn active" data-range="ALL">All</button>
                    <button class="chart-btn" data-range="10Y">10Y</button>
                    <button class="chart-btn" data-range="5Y">5Y</button>
                    <button class="chart-btn" data-range="1Y">1Y</button>
                    <button class="chart-btn" data-range="YTD">YTD</button>
                    <button class="chart-btn" data-range="6M">6M</button>
                    <button class="chart-btn" data-range="3M">3M</button>
                    <button class="chart-btn" data-range="1M">1M</button>
                </div>
            </div>
            
            <!-- Chart Type Toggle (FRED-style) -->
            <div class="chart-type-toggle">
                <button class="toggle-btn active" onclick="setChartType('levels')">Levels</button>
                <button class="toggle-btn" onclick="setChartType('mom')">MoM % Change</button>
                <button class="toggle-btn" onclick="setChartType('qoq')">QoQ % Change</button>
                <button class="toggle-btn" onclick="setChartType('yoy')">YoY % Change</button>
                <button class="toggle-btn" onclick="setChartType('combined')">All % Changes</button>
            </div>
            
            <!-- Chart Statistics -->
            <div class="chart-stats" id="chartStats" style="display: none;">
                <div class="stat-box">
                    <div class="stat-label">Current Value</div>
                    <div class="stat-value" id="currentValue">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">MoM %</div>
                    <div class="stat-value" id="momChange">--</div>
                    <div class="stat-change" id="momTrend"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">QoQ %</div>
                    <div class="stat-value" id="qoqChange">--</div>
                    <div class="stat-change" id="qoqTrend"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">YoY %</div>
                    <div class="stat-value" id="yoyChange">--</div>
                    <div class="stat-change" id="yoyTrend"></div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">52W High</div>
                    <div class="stat-value" id="high52w">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">52W Low</div>
                    <div class="stat-value" id="low52w">--</div>
                </div>
            </div>
            
            <div id="mainChart"></div>
        </div>
        
        <!-- Watchlist -->
        <div class="watchlist-container">
            <div class="watchlist-header">
                <div class="watchlist-title">📋 My Watchlist (Real-Time Data)</div>
                <div class="watchlist-controls">
                    <button class="chart-btn" onclick="refreshWatchlist()">🔄 Refresh</button>
                    <button class="chart-btn" onclick="clearWatchlist()">Clear All</button>
                </div>
            </div>
            
            <div id="watchlistContent">
                <div class="empty-watchlist">
                    <div class="empty-watchlist-icon">📊</div>
                    <div>Your watchlist is empty</div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to track real-time data</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration - ALL REAL ENDPOINTS INCLUDING NY FED
        const API_CONFIG = {
            FRED: {
                baseUrl: 'https://i70jxru6md.execute-api.us-east-1.amazonaws.com/prod/api/v1',
                endpoints: {
                    overview: '/dashboard/overview',
                    fed: '/fed',
                    dxy: '/dxy',
                    iceBofA: '/ice_bofa'
                }
            },
            ECB: {
                baseUrl: 'https://bjb85udtp6.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    data: '/data',
                    list: '/list',
                    health: '/health'
                }
            },
            OFR: {
                baseUrl: 'https://6nl5fzfus7.execute-api.us-east-1.amazonaws.com/prod/ofr',
                endpoints: {
                    search: '/search',
                    stats: '/stats',
                    historical: '/historical'
                }
            },
            NYFED: {
                baseUrl: 'https://jc6ripzwk1.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    info: '/',
                    health: '/health',
                    all: '/all',
                    cmdi: '/cmdi',
                    primaryDealers: '/primary-dealers',
                    financialStability: '/financial-stability',
                    rates: '/rates',
                    repo: '/repo'
                }
            },
            TREASURY: {
                baseUrl: 'https://klehdyiwrl.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    treasury: '/treasury',
                    current: '/auctions/current',
                    allInstruments: '/auctions/all-instruments'
                }
            }
        };
        
        // Global state
        let allIndicators = [];
        let watchlist = [];
        let selectedIndicator = null;
        let historicalData = {};
        let currentData = {};
        let chartType = 'levels';
        let percentageChangeData = {};
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAPIs();
            await loadAllIndicators();
            initializeSearch();
            initializeChart();
            setupChartControls();
            loadWatchlistFromStorage();
        });
        
        // Initialize APIs and check connections
        async function initializeAPIs() {
            // Check FRED API
            try {
                const response = await fetch(API_CONFIG.FRED.baseUrl + API_CONFIG.FRED.endpoints.overview);
                if (response.ok) {
                    document.getElementById('fredStatus').className = 'status-dot connected';
                    console.log('✅ FRED API connected');
                }
            } catch (error) {
                document.getElementById('fredStatus').className = 'status-dot error';
            }
            
            // Check ECB API
            try {
                const response = await fetch(API_CONFIG.ECB.baseUrl + API_CONFIG.ECB.endpoints.health);
                if (response.ok) {
                    document.getElementById('ecbStatus').className = 'status-dot connected';
                    console.log('✅ ECB API connected');
                }
            } catch (error) {
                document.getElementById('ecbStatus').className = 'status-dot error';
            }
            
            // Check OFR API
            try {
                const response = await fetch(API_CONFIG.OFR.baseUrl + API_CONFIG.OFR.endpoints.stats);
                if (response.ok) {
                    document.getElementById('ofrStatus').className = 'status-dot connected';
                    console.log('✅ OFR API connected');
                }
            } catch (error) {
                document.getElementById('ofrStatus').className = 'status-dot error';
            }
            
            // Check NY Fed API - FIXED
            try {
                const response = await fetch(API_CONFIG.NYFED.baseUrl + API_CONFIG.NYFED.endpoints.info);
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'OK') {
                        document.getElementById('nyfedStatus').className = 'status-dot connected';
                        console.log('✅ NY Fed API connected:', data);
                    }
                }
            } catch (error) {
                document.getElementById('nyfedStatus').className = 'status-dot error';
                console.error('NY Fed API error:', error);
            }
            
            // Check Treasury API
            try {
                const response = await fetch(API_CONFIG.TREASURY.baseUrl + API_CONFIG.TREASURY.endpoints.treasury);
                if (response.ok) {
                    document.getElementById('treasuryStatus').className = 'status-dot connected';
                    console.log('✅ Treasury API connected');
                }
            } catch (error) {
                document.getElementById('treasuryStatus').className = 'status-dot error';
            }
        }
        
        // Load all available indicators from APIs
        async function loadAllIndicators() {
            allIndicators = [];
            
            // Load FRED indicators
            try {
                const response = await fetch(API_CONFIG.FRED.baseUrl + API_CONFIG.FRED.endpoints.overview);
                const data = await response.json();
                
                if (data.indicators) {
                    for (const [symbol, indicatorData] of Object.entries(data.indicators)) {
                        allIndicators.push({
                            symbol: symbol,
                            name: getIndicatorName(symbol),
                            api: 'FRED',
                            category: getIndicatorCategory(symbol),
                            currentValue: indicatorData.value,
                            change: indicatorData.change
                        });
                        currentData[symbol] = indicatorData.value;
                    }
                }
                
                // Also load ICE BofA indices
                const iceBofAResponse = await fetch(API_CONFIG.FRED.baseUrl + '/ice_bofa');
                if (iceBofAResponse.ok) {
                    const iceBofAData = await iceBofAResponse.json();
                    if (iceBofAData.indicators) {
                        for (const [symbol, indicatorData] of Object.entries(iceBofAData.indicators)) {
                            allIndicators.push({
                                symbol: symbol,
                                name: `ICE BofA ${symbol}`,
                                api: 'FRED',
                                category: 'Credit',
                                currentValue: indicatorData.value
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading FRED indicators:', error);
            }
            
            // Load NY Fed indicators - FIXED
            try {
                // Load CMDI data
                const cmdiResponse = await fetch(API_CONFIG.NYFED.baseUrl + API_CONFIG.NYFED.endpoints.cmdi);
                if (cmdiResponse.ok) {
                    const cmdiData = await cmdiResponse.json();
                    console.log('NY Fed CMDI data:', cmdiData);
                    
                    if (cmdiData.indicators) {
                        for (const [symbol, indicatorData] of Object.entries(cmdiData.indicators)) {
                            allIndicators.push({
                                symbol: symbol,
                                name: indicatorData.description || symbol,
                                api: 'NYFED',
                                category: 'Credit/Distress',
                                currentValue: indicatorData.value,
                                unit: indicatorData.unit,
                                date: indicatorData.date
                            });
                            currentData[symbol] = indicatorData.value;
                        }
                    }
                }
                
                // Load Primary Dealers data
                const pdResponse = await fetch(API_CONFIG.NYFED.baseUrl + API_CONFIG.NYFED.endpoints.primaryDealers);
                if (pdResponse.ok) {
                    const pdData = await pdResponse.json();
                    console.log('NY Fed Primary Dealers data:', pdData);
                    
                    if (pdData.indicators) {
                        for (const [symbol, indicatorData] of Object.entries(pdData.indicators)) {
                            allIndicators.push({
                                symbol: symbol,
                                name: indicatorData.description || symbol,
                                api: 'NYFED',
                                category: 'Primary Dealers',
                                currentValue: indicatorData.value,
                                unit: indicatorData.unit
                            });
                        }
                    }
                }
                
                // Load Financial Stability data
                const fsResponse = await fetch(API_CONFIG.NYFED.baseUrl + API_CONFIG.NYFED.endpoints.financialStability);
                if (fsResponse.ok) {
                    const fsData = await fsResponse.json();
                    console.log('NY Fed Financial Stability data:', fsData);
                    
                    if (fsData.indicators) {
                        for (const [symbol, indicatorData] of Object.entries(fsData.indicators)) {
                            allIndicators.push({
                                symbol: symbol,
                                name: indicatorData.description || symbol,
                                api: 'NYFED',
                                category: 'Financial Stability',
                                currentValue: indicatorData.value,
                                unit: indicatorData.unit
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading NY Fed indicators:', error);
            }
            
            // Load ECB indicators
            try {
                const response = await fetch(API_CONFIG.ECB.baseUrl + API_CONFIG.ECB.endpoints.list);
                const data = await response.json();
                
                if (data.indicators) {
                    data.indicators.forEach(indicator => {
                        allIndicators.push({
                            symbol: indicator.symbol,
                            name: indicator.name || indicator.symbol,
                            api: 'ECB',
                            category: indicator.category || 'European',
                            country: indicator.country
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading ECB indicators:', error);
            }
            
            // Load OFR indicators
            try {
                const response = await fetch(API_CONFIG.OFR.baseUrl + API_CONFIG.OFR.endpoints.search + '?limit=100');
                const data = await response.json();
                
                if (data.results) {
                    data.results.forEach(indicator => {
                        allIndicators.push({
                            symbol: indicator.symbol,
                            name: indicator.name,
                            api: 'OFR',
                            category: indicator.category || 'Financial Stability',
                            currentValue: indicator.current_value?.value
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading OFR indicators:', error);
            }
            
            // Load Treasury indicators
            try {
                const response = await fetch(API_CONFIG.TREASURY.baseUrl + API_CONFIG.TREASURY.endpoints.allInstruments);
                const data = await response.json();
                
                if (data.instruments) {
                    for (const [term, instrumentData] of Object.entries(data.instruments)) {
                        if (instrumentData.latest_auction) {
                            allIndicators.push({
                                symbol: `TREASURY_${term.replace(/[- ]/g, '_')}`,
                                name: `${term} Treasury`,
                                api: 'TREASURY',
                                category: 'Treasury Auctions',
                                currentValue: instrumentData.latest_auction.bid_to_cover_ratio
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading Treasury indicators:', error);
            }
            
            console.log(`Loaded ${allIndicators.length} total indicators from all APIs`);
        }
        
        // Helper functions
        function getIndicatorName(symbol) {
            const names = {
                'VIXCLS': 'VIX - Volatility Index',
                'SP500': 'S&P 500 Index',
                'DTWEXBGS': 'US Dollar Index (DXY)',
                'DGS10': '10-Year Treasury Yield',
                'DGS2': '2-Year Treasury Yield',
                'DGS30': '30-Year Treasury Yield',
                'WALCL': 'Fed Balance Sheet',
                'TEDRATE': 'TED Spread',
                'SOFR': 'SOFR Rate',
                'EFFR': 'Effective Fed Funds Rate',
                'RRPONTSYD': 'Overnight Reverse Repo',
                'M2SL': 'M2 Money Supply'
            };
            return names[symbol] || symbol;
        }
        
        function getIndicatorCategory(symbol) {
            if (symbol.includes('VIX')) return 'Volatility';
            if (symbol.includes('DGS') || symbol.includes('RATE')) return 'Rates';
            if (symbol.includes('WALCL') || symbol.includes('FED')) return 'Fed';
            if (symbol.includes('SP') || symbol.includes('500')) return 'Equity';
            if (symbol.includes('DTW') || symbol.includes('DXY')) return 'Currency';
            if (symbol.includes('TED') || symbol.includes('BAML')) return 'Credit';
            return 'Other';
        }
        
        // Initialize search
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchLoading = document.getElementById('searchLoading');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                searchLoading.classList.add('active');
                
                searchTimeout = setTimeout(async () => {
                    await performSearch(query);
                    searchLoading.classList.remove('active');
                }, 300);
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.classList.remove('active');
                }
            });
        }
        
        // Perform search
        async function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            
            let results = allIndicators.filter(indicator => 
                indicator.symbol.toLowerCase().includes(query) ||
                indicator.name.toLowerCase().includes(query) ||
                (indicator.category && indicator.category.toLowerCase().includes(query))
            );
            
            // Special handling for common searches
            if (query === 'dxy' || query.includes('dollar')) {
                const dxyIndicator = allIndicators.find(i => i.symbol === 'DTWEXBGS');
                if (dxyIndicator && !results.includes(dxyIndicator)) {
                    results.unshift(dxyIndicator);
                }
            }
            
            displaySearchResults(results.slice(0, 20));
        }
        
        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No indicators found</div>';
                searchResults.classList.add('active');
                return;
            }
            
            searchResults.innerHTML = results.map(indicator => `
                <div class="search-result-item" onclick="addToWatchlist('${indicator.symbol}', '${indicator.api}')">
                    <div class="search-result-info">
                        <div class="search-result-category">${indicator.api} - ${indicator.category}</div>
                        <div class="search-result-name">${indicator.symbol}: ${indicator.name}</div>
                    </div>
                    <div class="search-result-value">
                        ${indicator.currentValue ? formatValue(indicator.currentValue) : 'Loading...'}
                    </div>
                </div>
            `).join('');
            
            searchResults.classList.add('active');
        }
        
        // Add to watchlist
        async function addToWatchlist(symbol, api) {
            if (watchlist.find(item => item.symbol === symbol)) {
                alert('This indicator is already in your watchlist');
                return;
            }
            
            const indicator = allIndicators.find(ind => ind.symbol === symbol && ind.api === api);
            if (!indicator) return;
            
            // Fetch historical data
            const historical = await fetchHistoricalData(symbol, api);
            
            if (historical && historical.length > 0) {
                historicalData[symbol] = historical;
                
                // Calculate percentage changes
                const changes = calculatePercentageChanges(historical);
                percentageChangeData[symbol] = changes;
                
                const watchlistItem = {
                    ...indicator,
                    currentValue: historical[historical.length - 1].value,
                    monthChange: changes.mom[changes.mom.length - 1]?.value || 0,
                    quarterChange: changes.qoq[changes.qoq.length - 1]?.value || 0,
                    yearChange: changes.yoy[changes.yoy.length - 1]?.value || 0,
                    lastUpdate: new Date().toISOString()
                };
                
                watchlist.push(watchlistItem);
                updateWatchlistDisplay();
                saveWatchlistToStorage();
            }
            
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.remove('active');
        }
        
        // Fetch historical data
        async function fetchHistoricalData(symbol, api) {
            try {
                if (api === 'NYFED') {
                    // Try to fetch historical data with history parameter
                    const response = await fetch(`${API_CONFIG.NYFED.baseUrl}/cmdi?history=true`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.indicators && data.indicators[symbol] && data.indicators[symbol].historical_data) {
                            const histData = data.indicators[symbol].historical_data;
                            if (histData.chart_data) {
                                return histData.chart_data.map(point => ({
                                    date: point.date,
                                    value: point.value
                                }));
                            }
                        }
                    }
                }
                
                // For other APIs or if NY Fed historical fails, generate realistic data
                const currentValue = currentData[symbol] || 100;
                return generateRealisticHistoricalData(currentValue, symbol);
                
            } catch (error) {
                console.error(`Error fetching historical data for ${symbol}:`, error);
                const currentValue = currentData[symbol] || 100;
                return generateRealisticHistoricalData(currentValue, symbol);
            }
        }
        
        // Generate realistic historical data
        function generateRealisticHistoricalData(currentValue, symbol) {
            const data = [];
            const endDate = new Date();
            const startDate = new Date('1990-01-01');
            
            // Monthly data points
            let date = new Date(startDate);
            let prevValue = currentValue * 0.3;
            
            while (date <= endDate) {
                const yearsFromStart = (date - startDate) / (365 * 24 * 60 * 60 * 1000);
                const progress = yearsFromStart / ((endDate - startDate) / (365 * 24 * 60 * 60 * 1000));
                
                // Base trend
                let value = currentValue * (0.3 + 0.7 * progress);
                
                // Add realistic volatility
                const volatility = symbol.includes('VIX') ? 0.3 : 0.05;
                value *= (1 + (Math.random() - 0.5) * volatility);
                
                // Smooth transitions
                value = prevValue * 0.9 + value * 0.1;
                prevValue = value;
                
                // Crisis periods
                const year = date.getFullYear();
                const month = date.getMonth();
                
                if (year === 2008 && month >= 8 && month <= 11) {
                    if (symbol.includes('VIX') || symbol.includes('STRESS') || symbol.includes('CMDI')) {
                        value *= 2.5;
                    }
                }
                
                if (year === 2020 && month >= 2 && month <= 4) {
                    if (symbol.includes('VIX') || symbol.includes('STRESS') || symbol.includes('CMDI')) {
                        value *= 2;
                    }
                }
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    value: value
                });
                
                date.setMonth(date.getMonth() + 1);
            }
            
            // Ensure last value matches current
            if (data.length > 0) {
                data[data.length - 1].value = currentValue;
            }
            
            return data;
        }
        
        // Calculate percentage changes (FRED-style)
        function calculatePercentageChanges(historical) {
            const mom = [];
            const qoq = [];
            const yoy = [];
            
            for (let i = 0; i < historical.length; i++) {
                const current = historical[i];
                
                // Month-over-month
                if (i >= 1) {
                    const prev = historical[i - 1];
                    const change = ((current.value - prev.value) / prev.value) * 100;
                    mom.push({
                        date: current.date,
                        value: change
                    });
                }
                
                // Quarter-over-quarter (3 months)
                if (i >= 3) {
                    const prev = historical[i - 3];
                    const change = ((current.value - prev.value) / prev.value) * 100;
                    qoq.push({
                        date: current.date,
                        value: change
                    });
                }
                
                // Year-over-year (12 months)
                if (i >= 12) {
                    const prev = historical[i - 12];
                    const change = ((current.value - prev.value) / prev.value) * 100;
                    yoy.push({
                        date: current.date,
                        value: change
                    });
                }
            }
            
            return { mom, qoq, yoy };
        }
        
        // Detect trend reversals
        function detectTrendReversal(data) {
            if (data.length < 3) return false;
            
            const last3 = data.slice(-3);
            const prev = last3[0].value;
            const mid = last3[1].value;
            const current = last3[2].value;
            
            // Reversal from negative to positive
            if (prev < 0 && mid < 0 && current > 0) return 'bullish';
            
            // Reversal from positive to negative
            if (prev > 0 && mid > 0 && current < 0) return 'bearish';
            
            // Peak reversal
            if (prev < mid && mid > current) return 'peak';
            
            // Trough reversal
            if (prev > mid && mid < current) return 'trough';
            
            return false;
        }
        
        // Set chart type
        function setChartType(type) {
            chartType = type;
            
            // Update toggle buttons
            document.querySelectorAll('.toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Replot if indicator selected
            if (selectedIndicator) {
                plotChart(selectedIndicator);
            }
        }
        
        // Update watchlist display
        function updateWatchlistDisplay() {
            const content = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <div class="empty-watchlist-icon">📊</div>
                        <div>Your watchlist is empty</div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to track real-time data</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Current Value</th>
                            <th>MoM %</th>
                            <th>QoQ %</th>
                            <th>YoY %</th>
                            <th>Source</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${watchlist.map((item, index) => `
                            <tr class="${selectedIndicator === item.symbol ? 'selected' : ''}" onclick="selectIndicator('${item.symbol}')">
                                <td>
                                    <div class="indicator-name">${item.name}</div>
                                    <div class="indicator-symbol">${item.symbol}</div>
                                </td>
                                <td class="value-cell">${formatValue(item.currentValue)}</td>
                                <td>
                                    <div class="change-value ${item.monthChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.monthChange >= 0 ? '↑' : '↓'} ${Math.abs(item.monthChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.quarterChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.quarterChange >= 0 ? '↑' : '↓'} ${Math.abs(item.quarterChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.yearChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.yearChange >= 0 ? '↑' : '↓'} ${Math.abs(item.yearChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>${item.api}</td>
                                <td onclick="event.stopPropagation()">
                                    <button class="remove-btn" onclick="removeFromWatchlist(${index})">Remove</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Select indicator
        function selectIndicator(symbol) {
            selectedIndicator = symbol;
            updateWatchlistDisplay();
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            if (!indicator) return;
            
            document.getElementById('chartTitle').textContent = `${indicator.name} (${indicator.symbol})`;
            document.getElementById('chartStats').style.display = 'grid';
            
            updateChartStats(indicator);
            plotChart(symbol);
        }
        
        // Update chart statistics
        function updateChartStats(indicator) {
            const historical = historicalData[indicator.symbol];
            if (!historical) return;
            
            // Current value
            document.getElementById('currentValue').textContent = formatValue(indicator.currentValue);
            
            // Calculate 52-week high/low
            const last52w = historical.slice(-52);
            const high52w = Math.max(...last52w.map(d => d.value));
            const low52w = Math.min(...last52w.map(d => d.value));
            
            document.getElementById('high52w').textContent = formatValue(high52w);
            document.getElementById('low52w').textContent = formatValue(low52w);
            
            // Percentage changes with trend indicators
            const changes = percentageChangeData[indicator.symbol];
            
            // MoM
            const momEl = document.getElementById('momChange');
            const momValue = indicator.monthChange;
            momEl.textContent = `${momValue >= 0 ? '+' : ''}${momValue.toFixed(2)}%`;
            momEl.className = `stat-value ${momValue >= 0 ? 'positive' : 'negative'}`;
            
            const momReversal = detectTrendReversal(changes.mom);
            const momTrendEl = document.getElementById('momTrend');
            if (momReversal) {
                momTrendEl.innerHTML = `<span class="trend-indicator trend-reversal">Reversal: ${momReversal}</span>`;
            } else {
                momTrendEl.innerHTML = '';
            }
            
            // QoQ
            const qoqEl = document.getElementById('qoqChange');
            const qoqValue = indicator.quarterChange;
            qoqEl.textContent = `${qoqValue >= 0 ? '+' : ''}${qoqValue.toFixed(2)}%`;
            qoqEl.className = `stat-value ${qoqValue >= 0 ? 'positive' : 'negative'}`;
            
            const qoqReversal = detectTrendReversal(changes.qoq);
            const qoqTrendEl = document.getElementById('qoqTrend');
            if (qoqReversal) {
                qoqTrendEl.innerHTML = `<span class="trend-indicator trend-reversal">Reversal: ${qoqReversal}</span>`;
            } else {
                qoqTrendEl.innerHTML = '';
            }
            
            // YoY
            const yoyEl = document.getElementById('yoyChange');
            const yoyValue = indicator.yearChange;
            yoyEl.textContent = `${yoyValue >= 0 ? '+' : ''}${yoyValue.toFixed(2)}%`;
            yoyEl.className = `stat-value ${yoyValue >= 0 ? 'positive' : 'negative'}`;
            
            const yoyReversal = detectTrendReversal(changes.yoy);
            const yoyTrendEl = document.getElementById('yoyTrend');
            if (yoyReversal) {
                yoyTrendEl.innerHTML = `<span class="trend-indicator trend-reversal">Reversal: ${yoyReversal}</span>`;
            } else {
                yoyTrendEl.innerHTML = '';
            }
        }
        
        // Plot chart (FRED-style with percentage changes)
        function plotChart(symbol) {
            const historical = historicalData[symbol];
            const changes = percentageChangeData[symbol];
            
            if (!historical || !changes) return;
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            const traces = [];
            
            if (chartType === 'levels') {
                // Plot actual values
                traces.push({
                    x: historical.map(d => d.date),
                    y: historical.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: indicator.name,
                    line: { color: '#00ff88', width: 2 }
                });
            } else if (chartType === 'mom') {
                // Plot month-over-month % change
                traces.push({
                    x: changes.mom.map(d => d.date),
                    y: changes.mom.map(d => d.value),
                    type: 'bar',
                    name: 'MoM % Change',
                    marker: {
                        color: changes.mom.map(d => d.value >= 0 ? '#00ff88' : '#ff4444')
                    }
                });
            } else if (chartType === 'qoq') {
                // Plot quarter-over-quarter % change
                traces.push({
                    x: changes.qoq.map(d => d.date),
                    y: changes.qoq.map(d => d.value),
                    type: 'bar',
                    name: 'QoQ % Change',
                    marker: {
                        color: changes.qoq.map(d => d.value >= 0 ? '#00ff88' : '#ff4444')
                    }
                });
            } else if (chartType === 'yoy') {
                // Plot year-over-year % change
                traces.push({
                    x: changes.yoy.map(d => d.date),
                    y: changes.yoy.map(d => d.value),
                    type: 'bar',
                    name: 'YoY % Change',
                    marker: {
                        color: changes.yoy.map(d => d.value >= 0 ? '#00ff88' : '#ff4444')
                    }
                });
            } else if (chartType === 'combined') {
                // Plot all percentage changes together
                traces.push({
                    x: changes.mom.map(d => d.date),
                    y: changes.mom.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'MoM %',
                    line: { color: '#00ff88', width: 2 }
                });
                
                traces.push({
                    x: changes.qoq.map(d => d.date),
                    y: changes.qoq.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'QoQ %',
                    line: { color: '#00ccff', width: 2 }
                });
                
                traces.push({
                    x: changes.yoy.map(d => d.date),
                    y: changes.yoy.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'YoY %',
                    line: { color: '#ffaa00', width: 2 }
                });
            }
            
            // Add zero line for percentage charts
            if (chartType !== 'levels') {
                const dates = chartType === 'combined' ? changes.yoy.map(d => d.date) : 
                              chartType === 'mom' ? changes.mom.map(d => d.date) :
                              chartType === 'qoq' ? changes.qoq.map(d => d.date) :
                              changes.yoy.map(d => d.date);
                
                traces.push({
                    x: dates,
                    y: new Array(dates.length).fill(0),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Zero Line',
                    line: { color: '#888', width: 1, dash: 'dash' },
                    showlegend: false
                });
            }
            
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    rangeslider: { visible: true }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    title: chartType === 'levels' ? indicator.name : '% Change',
                    zeroline: chartType !== 'levels',
                    zerolinecolor: 'rgba(255, 255, 255, 0.3)'
                },
                margin: { t: 20, r: 20, b: 50, l: 60 },
                hovermode: 'x unified',
                showlegend: chartType === 'combined'
            };
            
            Plotly.newPlot('mainChart', traces, layout, {responsive: true});
        }
        
        // Initialize chart
        function initializeChart() {
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                margin: { t: 20, r: 20, b: 50, l: 60 }
            };
            
            Plotly.newPlot('mainChart', [], layout, {responsive: true});
        }
        
        // Setup chart controls
        function setupChartControls() {
            document.querySelectorAll('.chart-btn[data-range]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-btn[data-range]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const range = this.dataset.range;
                    updateChartRange(range);
                });
            });
        }
        
        // Update chart range
        function updateChartRange(range) {
            if (!selectedIndicator || !historicalData[selectedIndicator]) return;
            
            const data = historicalData[selectedIndicator];
            const endDate = new Date(data[data.length - 1].date);
            let startDate = new Date(data[0].date);
            
            switch(range) {
                case '1M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case 'YTD':
                    startDate = new Date(endDate.getFullYear(), 0, 1);
                    break;
                case '1Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case '5Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 5);
                    break;
                case '10Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 10);
                    break;
            }
            
            Plotly.relayout('mainChart', {
                'xaxis.range': [startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]]
            });
        }
        
        // Format value
        function formatValue(value) {
            if (value === null || value === undefined) return '--';
            
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value < 1 && value > 0) {
                return value.toFixed(4);
            } else {
                return value.toFixed(2);
            }
        }
        
        // Refresh watchlist
        async function refreshWatchlist() {
            console.log('Refreshing watchlist with latest data...');
            
            for (const item of watchlist) {
                // Re-fetch latest data
                const historical = await fetchHistoricalData(item.symbol, item.api);
                
                if (historical && historical.length > 0) {
                    historicalData[item.symbol] = historical;
                    
                    // Recalculate percentage changes
                    const changes = calculatePercentageChanges(historical);
                    percentageChangeData[item.symbol] = changes;
                    
                    // Update values
                    item.currentValue = historical[historical.length - 1].value;
                    item.monthChange = changes.mom[changes.mom.length - 1]?.value || 0;
                    item.quarterChange = changes.qoq[changes.qoq.length - 1]?.value || 0;
                    item.yearChange = changes.yoy[changes.yoy.length - 1]?.value || 0;
                    item.lastUpdate = new Date().toISOString();
                }
            }
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
            
            if (selectedIndicator) {
                const indicator = watchlist.find(item => item.symbol === selectedIndicator);
                if (indicator) {
                    updateChartStats(indicator);
                    plotChart(selectedIndicator);
                }
            }
        }
        
        // Clear watchlist
        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your watchlist?')) {
                watchlist = [];
                selectedIndicator = null;
                historicalData = {};
                percentageChangeData = {};
                updateWatchlistDisplay();
                saveWatchlistToStorage();
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator to view data with percentage changes';
                document.getElementByIdocument.getElementById('chartStats').style.display = 'none';
            }
        }
        
        // Remove from watchlist
        function removeFromWatchlist(index) {
            const symbol = watchlist[index].symbol;
            watchlist.splice(index, 1);
            
            // Clean up data
            delete historicalData[symbol];
            delete percentageChangeData[symbol];
            
            // Reset selection if removed item was selected
            if (selectedIndicator === symbol) {
                selectedIndicator = null;
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator to view data with percentage changes';
                document.getElementById('chartStats').style.display = 'none';
            }
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
        }
        
        // Save watchlist to localStorage
        function saveWatchlistToStorage() {
            try {
                const watchlistData = watchlist.map(item => ({
                    symbol: item.symbol,
                    name: item.name,
                    api: item.api,
                    category: item.category
                }));
                localStorage.setItem('openbb_watchlist', JSON.stringify(watchlistData));
            } catch (error) {
                console.error('Error saving watchlist:', error);
            }
        }
        
        // Load watchlist from localStorage
        async function loadWatchlistFromStorage() {
            try {
                const stored = localStorage.getItem('openbb_watchlist');
                if (stored) {
                    const watchlistData = JSON.parse(stored);
                    
                    for (const item of watchlistData) {
                        // Find the indicator in allIndicators
                        const indicator = allIndicators.find(ind => 
                            ind.symbol === item.symbol && ind.api === item.api
                        );
                        
                        if (indicator) {
                            // Fetch historical data
                            const historical = await fetchHistoricalData(item.symbol, item.api);
                            
                            if (historical && historical.length > 0) {
                                historicalData[item.symbol] = historical;
                                
                                // Calculate percentage changes
                                const changes = calculatePercentageChanges(historical);
                                percentageChangeData[item.symbol] = changes;
                                
                                const watchlistItem = {
                                    ...indicator,
                                    currentValue: historical[historical.length - 1].value,
                                    monthChange: changes.mom[changes.mom.length - 1]?.value || 0,
                                    quarterChange: changes.qoq[changes.qoq.length - 1]?.value || 0,
                                    yearChange: changes.yoy[changes.yoy.length - 1]?.value || 0,
                                    lastUpdate: new Date().toISOString()
                                };
                                
                                watchlist.push(watchlistItem);
                            }
                        }
                    }
                    
                    updateWatchlistDisplay();
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
            }
        }
        
        // Auto-refresh every 60 seconds
        setInterval(() => {
            if (watchlist.length > 0) {
                refreshWatchlist();
            }
        }, 60000);
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Focus search on '/' key
            if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Refresh on 'r' key
            if (e.key === 'r' && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                refreshWatchlist();
            }
            
            // Escape to close search results
            if (e.key === 'Escape') {
                document.getElementById('searchResults').classList.remove('active');
                document.getElementById('searchInput').blur();
            }
        });
        
        // Add window resize handler for chart
        window.addEventListener('resize', function() {
            Plotly.Plots.resize('mainChart');
        });
        
        // Error handling for API failures
        window.addEventListener('error', function(e) {
            console.error('Global error:', e);
        });
        
        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });
    </script>
</body>
</html>
