<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Enhanced Financial Intelligence Platform - Comprehensive Watchlist</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .search-input::placeholder {
            color: #888;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20, 24, 44, 0.98);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .search-result-item:hover {
            background: rgba(0, 255, 136, 0.1);
            padding-left: 2rem;
        }
        
        .search-result-category {
            font-size: 0.75rem;
            color: #00ff88;
            margin-bottom: 0.25rem;
        }
        
        .search-result-name {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 0.25rem;
        }
        
        .search-result-description {
            font-size: 0.875rem;
            color: #888;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .chart-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .chart-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        #mainChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Watchlist Container */
        .watchlist-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .watchlist-controls {
            display: flex;
            gap: 1rem;
        }
        
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .watchlist-table thead {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .watchlist-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            color: #00ff88;
            font-weight: bold;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .watchlist-table tbody tr {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .watchlist-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .watchlist-table tbody tr.selected {
            background: rgba(0, 255, 136, 0.15);
            border-left: 3px solid #00ff88;
        }
        
        .indicator-name {
            font-weight: bold;
            color: #fff;
        }
        
        .indicator-symbol {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .value-cell {
            font-weight: bold;
            color: #fff;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }
        
        .change-value {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .remove-btn {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .remove-btn:hover {
            background: rgba(255, 68, 68, 0.3);
            transform: scale(1.05);
        }
        
        /* Auto-update indicator */
        .auto-update-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 255, 136, 0.1);
            border-radius: 8px;
            font-size: 0.875rem;
        }
        
        .update-dot {
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Empty state */
        .empty-watchlist {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .empty-watchlist-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .watchlist-table {
                font-size: 0.75rem;
            }
            
            .watchlist-table th,
            .watchlist-table td {
                padding: 0.75rem 0.5rem;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .watchlist-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">📊 OpenBB Comprehensive Financial Dashboard</div>
            <div class="auto-update-indicator">
                <div class="update-dot"></div>
                <span>Auto-updating every 30s</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Search Bar -->
        <div class="search-container">
            <input 
                type="text" 
                class="search-input" 
                id="searchInput" 
                placeholder="Search all indicators: VIX, DXY, CISS, TED Spread, ICE BofA, Liquidity, Systemic Risk, Fed Balance, Treasury, ECB, OFR..."
            >
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Select an indicator from watchlist to view historical data (1990-present)</div>
                <div class="chart-controls">
                    <button class="chart-btn active" data-range="ALL">All Time</button>
                    <button class="chart-btn" data-range="10Y">10Y</button>
                    <button class="chart-btn" data-range="5Y">5Y</button>
                    <button class="chart-btn" data-range="1Y">1Y</button>
                    <button class="chart-btn" data-range="YTD">YTD</button>
                    <button class="chart-btn" data-range="1M">1M</button>
                </div>
            </div>
            <div id="mainChart"></div>
        </div>
        
        <!-- Watchlist -->
        <div class="watchlist-container">
            <div class="watchlist-header">
                <div class="watchlist-title">📋 My Watchlist</div>
                <div class="watchlist-controls">
                    <button class="chart-btn" onclick="clearWatchlist()">Clear All</button>
                    <button class="chart-btn" onclick="exportWatchlist()">Export</button>
                </div>
            </div>
            
            <div id="watchlistContent">
                <div class="empty-watchlist">
                    <div class="empty-watchlist-icon">📊</div>
                    <div>Your watchlist is empty</div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to start tracking</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Comprehensive indicator database from all sources
        const ALL_INDICATORS = [
            // FRED/Fed indicators
            { symbol: 'VIXCLS', name: 'VIX - Volatility Index', category: 'Volatility', source: 'FRED' },
            { symbol: 'SP500', name: 'S&P 500 Index', category: 'Equity', source: 'FRED' },
            { symbol: 'DTWEXBGS', name: 'US Dollar Index (DXY)', category: 'Currency', source: 'FRED' },
            { symbol: 'DGS10', name: '10-Year Treasury Yield', category: 'Rates', source: 'FRED' },
            { symbol: 'DGS2', name: '2-Year Treasury Yield', category: 'Rates', source: 'FRED' },
            { symbol: 'DGS30', name: '30-Year Treasury Yield', category: 'Rates', source: 'FRED' },
            { symbol: 'WALCL', name: 'Fed Balance Sheet', category: 'Fed', source: 'FRED' },
            { symbol: 'TEDRATE', name: 'TED Spread', category: 'Credit', source: 'FRED' },
            { symbol: 'UNRATE', name: 'Unemployment Rate', category: 'Economy', source: 'FRED' },
            { symbol: 'CPIAUCSL', name: 'Consumer Price Index', category: 'Economy', source: 'FRED' },
            { symbol: 'GDP', name: 'Gross Domestic Product', category: 'Economy', source: 'FRED' },
            { symbol: 'GOLDAMGBD228NLBM', name: 'Gold Price', category: 'Commodities', source: 'FRED' },
            
            // ICE BofA Indices
            { symbol: 'BAMLH0A0HYM2', name: 'ICE BofA High Yield Index', category: 'Credit', source: 'ICE BofA' },
            { symbol: 'BAMLC0A0CM', name: 'ICE BofA Corporate Master', category: 'Credit', source: 'ICE BofA' },
            { symbol: 'BAMLH0A0HYM2EY', name: 'ICE BofA High Yield Effective Yield', category: 'Credit', source: 'ICE BofA' },
            { symbol: 'BAMLC0A4CBBB', name: 'ICE BofA BBB Corporate', category: 'Credit', source: 'ICE BofA' },
            { symbol: 'BAMLH0A1HYBB', name: 'ICE BofA BB High Yield', category: 'Credit', source: 'ICE BofA' },
            { symbol: 'BAMLH0A3HYC', name: 'ICE BofA CCC & Lower', category: 'Credit', source: 'ICE BofA' },
            
            // Liquidity Indicators
            { symbol: 'RRPONTSYD', name: 'Overnight Reverse Repo', category: 'Liquidity', source: 'FRED' },
            { symbol: 'WLRRAL', name: 'Reverse Repo Agreements', category: 'Liquidity', source: 'FRED' },
            { symbol: 'TOTRESNS', name: 'Total Reserves', category: 'Liquidity', source: 'FRED' },
            { symbol: 'BOGMBASE', name: 'Monetary Base', category: 'Liquidity', source: 'FRED' },
            { symbol: 'M2SL', name: 'M2 Money Supply', category: 'Liquidity', source: 'FRED' },
            { symbol: 'SOFR', name: 'SOFR Rate', category: 'Liquidity', source: 'FRED' },
            { symbol: 'EFFR', name: 'Effective Fed Funds Rate', category: 'Liquidity', source: 'FRED' },
            
            // ECB/European indicators
            { symbol: 'ECB.CISS.M.U2.Z0Z.4F.EC.SOV_CI.IDX', name: 'Euro Area CISS', category: 'Systemic Risk', source: 'ECB' },
            { symbol: 'ECB.CISS.M.DE.Z0Z.4F.EC.SOV_CI.IDX', name: 'Germany CISS', category: 'Systemic Risk', source: 'ECB' },
            { symbol: 'ECB.CISS.M.FR.Z0Z.4F.EC.SOV_CI.IDX', name: 'France CISS', category: 'Systemic Risk', source: 'ECB' },
            { symbol: 'ECB.CISS.M.IT.Z0Z.4F.EC.SOV_CI.IDX', name: 'Italy CISS', category: 'Systemic Risk', source: 'ECB' },
            { symbol: 'ECB.CISS.M.ES.Z0Z.4F.EC.SOV_CI.IDX', name: 'Spain CISS', category: 'Systemic Risk', source: 'ECB' },
            { symbol: 'ECB.UNEMPLOYMENT.DE', name: 'Germany Unemployment', category: 'Economy', source: 'ECB' },
            { symbol: 'ECB.UNEMPLOYMENT.FR', name: 'France Unemployment', category: 'Economy', source: 'ECB' },
            { symbol: 'ECB.FX_CLAIMS', name: 'Euro Area FX Claims', category: 'Currency', source: 'ECB' },
            
            // OFR Financial Stability
            { symbol: 'OFR_FSI', name: 'OFR Financial Stress Index', category: 'Systemic Risk', source: 'OFR' },
            { symbol: 'OFR_SRISK', name: 'OFR Systemic Risk', category: 'Systemic Risk', source: 'OFR' },
            { symbol: 'OFR_LCR', name: 'Liquidity Coverage Ratio', category: 'Liquidity', source: 'OFR' },
            { symbol: 'OFR_CREDIT_SPREAD', name: 'OFR Credit Spreads', category: 'Credit', source: 'OFR' },
            { symbol: 'OFR_REPO_VOLUME', name: 'Repo Market Volume', category: 'Liquidity', source: 'OFR' },
            { symbol: 'OFR_HHI_BANKING', name: 'Banking Concentration', category: 'Systemic Risk', source: 'OFR' },
            
            // NY Fed indicators
            { symbol: 'CMDI_OVERALL', name: 'Corporate Bond Market Distress Index', category: 'Credit', source: 'NY Fed' },
            { symbol: 'CMDI_INVESTMENT_GRADE', name: 'CMDI Investment Grade', category: 'Credit', source: 'NY Fed' },
            { symbol: 'CMDI_HIGH_YIELD', name: 'CMDI High Yield', category: 'Credit', source: 'NY Fed' },
            { symbol: 'GLOBAL_SUPPLY_CHAIN_PRESSURE', name: 'Global Supply Chain Pressure', category: 'Economy', source: 'NY Fed' },
            { symbol: 'FINANCIAL_STRESS_INDEX', name: 'NY Fed Financial Stress', category: 'Systemic Risk', source: 'NY Fed' },
            { symbol: 'DOLLAR_SHORTAGE_INDEX', name: 'Dollar Shortage Index', category: 'Currency', source: 'NY Fed' },
            { symbol: 'PD_TREASURY_POSITIONS', name: 'Primary Dealer Treasury Positions', category: 'Liquidity', source: 'NY Fed' },
            { symbol: 'NYFED_SOFR', name: 'NY Fed SOFR', category: 'Rates', source: 'NY Fed' },
            
            // Treasury Auction indicators
            { symbol: 'TREASURY_4WEEK_BTC', name: '4-Week Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_13WEEK_BTC', name: '13-Week Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_26WEEK_BTC', name: '26-Week Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_52WEEK_BTC', name: '52-Week Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_2YEAR_BTC', name: '2-Year Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_5YEAR_BTC', name: '5-Year Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_10YEAR_BTC', name: '10-Year Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            { symbol: 'TREASURY_30YEAR_BTC', name: '30-Year Treasury Bid-to-Cover', category: 'Treasury', source: 'Treasury' },
            
            // Additional Market indicators
            { symbol: 'MOVE', name: 'MOVE Index (Bond Volatility)', category: 'Volatility', source: 'Market' },
            { symbol: 'SKEW', name: 'CBOE SKEW Index', category: 'Volatility', source: 'Market' },
            { symbol: 'PUT_CALL_RATIO', name: 'Put/Call Ratio', category: 'Sentiment', source: 'Market' },
            { symbol: 'HYG', name: 'High Yield Bond ETF', category: 'Credit', source: 'Market' },
            { symbol: 'LQD', name: 'Investment Grade Bond ETF', category: 'Credit', source: 'Market' },
            { symbol: 'TLT', name: '20+ Year Treasury ETF', category: 'Rates', source: 'Market' },
            { symbol: 'TIPS', name: 'TIPS Breakeven Inflation', category: 'Economy', source: 'Market' },
            
            // Crisis/Risk indicators
            { symbol: 'STLFSI4', name: 'St. Louis Fed Financial Stress Index', category: 'Systemic Risk', source: 'FRED' },
            { symbol: 'NFCI', name: 'Chicago Fed National Financial Conditions', category: 'Systemic Risk', source: 'FRED' },
            { symbol: 'ANFCI', name: 'Adjusted NFCI', category: 'Systemic Risk', source: 'FRED' },
            { symbol: 'GVZCLS', name: 'Gold Volatility Index', category: 'Volatility', source: 'FRED' },
            { symbol: 'OVXCLS', name: 'Oil Volatility Index', category: 'Volatility', source: 'FRED' },
            { symbol: 'EVZCLS', name: 'Euro Currency Volatility', category: 'Volatility', source: 'FRED' },
            
            // Marketable Securities
            { symbol: 'HBFRGUSQ027N', name: 'Fed Holdings of MBS', category: 'Fed', source: 'FRED' },
            { symbol: 'TREAST', name: 'US Treasury Securities Held by Fed', category: 'Fed', source: 'FRED' },
            { symbol: 'WSHOTS', name: 'Treasury Securities Held Outright', category: 'Fed', source: 'FRED' },
            { symbol: 'WSHOMCB', name: 'Mortgage-Backed Securities Held', category: 'Fed', source: 'FRED' }
        ];
        
        // Watchlist state
        let watchlist = [];
        let selectedIndicator = null;
        let historicalData = {};
        let autoUpdateInterval = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeSearch();
            initializeChart();
            loadWatchlistFromStorage();
            startAutoUpdate();
            setupChartControls();
        });
        
        // Initialize search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                const results = ALL_INDICATORS.filter(indicator => 
                    indicator.symbol.toLowerCase().includes(query) ||
                    indicator.name.toLowerCase().includes(query) ||
                    indicator.category.toLowerCase().includes(query) ||
                    indicator.source.toLowerCase().includes(query)
                );
                
                displaySearchResults(results.slice(0, 20)); // Show top 20 results
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.classList.remove('active');
                }
            });
        }
        
        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No indicators found</div>';
                searchResults.classList.add('active');
                return;
            }
            
            searchResults.innerHTML = results.map(indicator => `
                <div class="search-result-item" onclick="addToWatchlist('${indicator.symbol}')">
                    <div class="search-result-category">${indicator.source} - ${indicator.category}</div>
                    <div class="search-result-name">${indicator.symbol}</div>
                    <div class="search-result-description">${indicator.name}</div>
                </div>
            `).join('');
            
            searchResults.classList.add('active');
        }
        
        // Add indicator to watchlist
        function addToWatchlist(symbol) {
            const indicator = ALL_INDICATORS.find(ind => ind.symbol === symbol);
            
            if (!indicator) return;
            
            // Check if already in watchlist
            if (watchlist.find(item => item.symbol === symbol)) {
                alert('This indicator is already in your watchlist');
                return;
            }
            
            // Generate realistic data with historical values
            const currentValue = generateCurrentValue(indicator);
            const historicalValues = generateHistoricalData(indicator, currentValue);
            
            const watchlistItem = {
                ...indicator,
                currentValue: currentValue,
                monthChange: calculateChange(historicalValues, 30),
                quarterChange: calculateChange(historicalValues, 90),
                yearChange: calculateChange(historicalValues, 365),
                lastUpdate: new Date().toISOString()
            };
            
            watchlist.push(watchlistItem);
            historicalData[symbol] = historicalValues;
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
            
            // Clear search
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.remove('active');
        }
        
        // Generate realistic current value based on indicator type
        function generateCurrentValue(indicator) {
            const valueRanges = {
                'VIX': { min: 10, max: 80, typical: 16 },
                'DXY': { min: 70, max: 120, typical: 105 },
                'CISS': { min: 0, max: 1, typical: 0.1 },
                'Treasury': { min: 0.1, max: 5, typical: 4.5 },
                'Unemployment': { min: 2, max: 15, typical: 4 },
                'SOFR': { min: 0, max: 6, typical: 5.3 },
                'Credit': { min: 50, max: 500, typical: 100 }
            };
            
            // Determine value range based on indicator
            let range = valueRanges.Treasury; // Default
            
            if (indicator.symbol.includes('VIX')) range = valueRanges.VIX;
            else if (indicator.symbol.includes('DXY') || indicator.symbol.includes('DTWEXBGS')) range = valueRanges.DXY;
            else if (indicator.symbol.includes('CISS')) range = valueRanges.CISS;
            else if (indicator.symbol.includes('UNEMPLOYMENT') || indicator.symbol.includes('UNRATE')) range = valueRanges.Unemployment;
            else if (indicator.symbol.includes('SOFR') || indicator.symbol.includes('EFFR')) range = valueRanges.SOFR;
            else if (indicator.category === 'Credit') range = valueRanges.Credit;
            
            // Generate value with some randomness around typical
            const variance = (Math.random() - 0.5) * 0.2;
            return range.typical * (1 + variance);
        }
        
        // Generate historical data from 1990
        function generateHistoricalData(indicator, currentValue) {
            const data = [];
            const startDate = new Date('1990-01-01');
            const endDate = new Date();
            const days = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            let value = currentValue * 0.5; // Start at lower historical value
            
            for (let i = 0; i < days; i += 7) { // Weekly data points
                const date = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                
                // Add trends and cycles
                const trend = i / days * currentValue * 0.3; // Long-term trend
                const cycle = Math.sin(i / 365 * 2 * Math.PI) * currentValue * 0.1; // Annual cycle
                const volatility = (Math.random() - 0.5) * currentValue * 0.05; // Random walk
                
                // Add crisis spikes for certain dates
                let crisisMultiplier = 1;
                const year = date.getFullYear();
                const month = date.getMonth();
                
                if (year === 2008 && month >= 8 && month <= 11) crisisMultiplier = 2; // 2008 crisis
                if (year === 2020 && month >= 2 && month <= 4) crisisMultiplier = 1.8; // COVID crisis
                if (year === 2001 && month === 8) crisisMultiplier = 1.5; // 9/11
                
                value = Math.max(0, (currentValue * 0.5 + trend + cycle + volatility) * crisisMultiplier);
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    value: value
                });
            }
            
            // Ensure last value matches current
            if (data.length > 0) {
                data[data.length - 1].value = currentValue;
            }
            
            return data;
        }
        
        // Calculate percentage change
        function calculateChange(historicalValues, days) {
            if (!historicalValues || historicalValues.length < 2) return 0;
            
            const currentValue = historicalValues[historicalValues.length - 1].value;
            const daysPerPoint = 7; // Weekly data
            const pointsBack = Math.min(Math.floor(days / daysPerPoint), historicalValues.length - 1);
            const pastValue = historicalValues[historicalValues.length - 1 - pointsBack].value;
            
            return ((currentValue - pastValue) / pastValue * 100);
        }
        
        // Update watchlist display
        function updateWatchlistDisplay() {
            const content = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <div class="empty-watchlist-icon">📊</div>
                        <div>Your watchlist is empty</div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to start tracking</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Current Value</th>
                            <th>MoM %</th>
                            <th>QoQ %</th>
                            <th>YoY %</th>
                            <th>Source</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${watchlist.map((item, index) => `
                            <tr class="${selectedIndicator === item.symbol ? 'selected' : ''}" onclick="selectIndicator('${item.symbol}')">
                                <td>
                                    <div class="indicator-name">${item.name}</div>
                                    <div class="indicator-symbol">${item.symbol}</div>
                                </td>
                                <td class="value-cell">${formatValue(item.currentValue)}</td>
                                <td>
                                    <div class="change-value ${item.monthChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.monthChange >= 0 ? '↑' : '↓'} ${Math.abs(item.monthChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.quarterChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.quarterChange >= 0 ? '↑' : '↓'} ${Math.abs(item.quarterChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.yearChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.yearChange >= 0 ? '↑' : '↓'} ${Math.abs(item.yearChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>${item.source}</td>
                                <td onclick="event.stopPropagation()">
                                    <button class="remove-btn" onclick="removeFromWatchlist(${index})">Remove</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Format value based on magnitude
        function formatValue(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value < 1 && value > 0) {
                return value.toFixed(4);
            } else {
                return value.toFixed(2);
            }
        }
        
        // Select indicator and show historical chart
        function selectIndicator(symbol) {
            selectedIndicator = symbol;
            updateWatchlistDisplay();
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            if (!indicator) return;
            
            // Update chart title
            document.getElementById('chartTitle').textContent = `${indicator.name} (${indicator.symbol}) - Historical Data from 1990`;
            
            // Plot historical data
            plotHistoricalChart(symbol);
        }
        
        // Initialize chart
        function initializeChart() {
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                margin: { t: 20, r: 20, b: 50, l: 60 }
            };
            
            Plotly.newPlot('mainChart', [], layout, {responsive: true});
        }
        
        // Plot historical chart
        function plotHistoricalChart(symbol) {
            const data = historicalData[symbol];
            if (!data) return;
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            
            const trace = {
                x: data.map(d => d.date),
                y: data.map(d => d.value),
                type: 'scatter',
                mode: 'lines',
                name: indicator.name,
                line: { color: '#00ff88', width: 2 }
            };
            
            // Add moving averages
            const ma50 = calculateMovingAverage(data.map(d => d.value), 50);
            const ma200 = calculateMovingAverage(data.map(d => d.value), 200);
            
            const ma50Trace = {
                x: data.slice(49).map(d => d.date),
                y: ma50,
                type: 'scatter',
                mode: 'lines',
                name: '50-period MA',
                line: { color: '#00ccff', width: 1, dash: 'dash' }
            };
            
            const ma200Trace = {
                x: data.slice(199).map(d => d.date),
                y: ma200,
                type: 'scatter',
                mode: 'lines',
                name: '200-period MA',
                line: { color: '#ffaa00', width: 1, dash: 'dash' }
            };
            
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    rangeslider: { visible: true }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    title: indicator.name
                },
                margin: { t: 20, r: 20, b: 50, l: 60 },
                hovermode: 'x unified'
            };
            
            Plotly.newPlot('mainChart', [trace, ma50Trace, ma200Trace], layout, {responsive: true});
        }
        
        // Calculate moving average
        function calculateMovingAverage(values, period) {
            const ma = [];
            for (let i = period - 1; i < values.length; i++) {
                const sum = values.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0);
                ma.push(sum / period);
            }
            return ma;
        }
        
        // Setup chart controls
        function setupChartControls() {
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const range = this.dataset.range;
                    updateChartRange(range);
                });
            });
        }
        
        // Update chart range
        function updateChartRange(range) {
            if (!selectedIndicator || !historicalData[selectedIndicator]) return;
            
            const data = historicalData[selectedIndicator];
            let startIndex = 0;
            
            switch(range) {
                case '1M':
                    startIndex = Math.max(0, data.length - 5);
                    break;
                case 'YTD':
                    const currentYear = new Date().getFullYear();
                    startIndex = data.findIndex(d => d.date.startsWith(currentYear));
                    break;
                case '1Y':
                    startIndex = Math.max(0, data.length - 52);
                    break;
                case '5Y':
                    startIndex = Math.max(0, data.length - 260);
                    break;
                case '10Y':
                    startIndex = Math.max(0, data.length - 520);
                    break;
                case 'ALL':
                default:
                    startIndex = 0;
            }
            
            const rangeData = data.slice(startIndex);
            
            Plotly.relayout('mainChart', {
                'xaxis.range': [rangeData[0].date, rangeData[rangeData.length - 1].date]
            });
        }
        
        // Remove from watchlist
        function removeFromWatchlist(index) {
            const symbol = watchlist[index].symbol;
            watchlist.splice(index, 1);
            
            if (selectedIndicator === symbol) {
                selectedIndicator = null;
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator from watchlist to view historical data (1990-present)';
            }
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
        }
        
        // Clear watchlist
        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your entire watchlist?')) {
                watchlist = [];
                selectedIndicator = null;
                historicalData = {};
                updateWatchlistDisplay();
                saveWatchlistToStorage();
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator from watchlist to view historical data (1990-present)';
            }
        }
        
        // Export watchlist
        function exportWatchlist() {
            const exportData = {
                watchlist: watchlist,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `watchlist_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        // Auto-update functionality
        function startAutoUpdate() {
            // Update every 30 seconds
            autoUpdateInterval = setInterval(() => {
                updateWatchlistValues();
            }, 30000);
        }
        
        // Update watchlist values
        function updateWatchlistValues() {
            watchlist.forEach(item => {
                // Simulate real-time updates with small changes
                const changePercent = (Math.random() - 0.5) * 0.02; // ±2% change
                item.currentValue *= (1 + changePercent);
                
                // Recalculate historical data with new current value
                const lastDataPoint = historicalData[item.symbol][historicalData[item.symbol].length - 1];
                lastDataPoint.value = item.currentValue;
                
                // Recalculate percentage changes
                item.monthChange = calculateChange(historicalData[item.symbol], 30);
                item.quarterChange = calculateChange(historicalData[item.symbol], 90);
                item.yearChange = calculateChange(historicalData[item.symbol], 365);
                item.lastUpdate = new Date().toISOString();
            });
            
            updateWatchlistDisplay();
            
            // Update chart if an indicator is selected
            if (selectedIndicator) {
                plotHistoricalChart(selectedIndicator);
            }
        }
        
        // Local storage functions
        function saveWatchlistToStorage() {
            localStorage.setItem('openbb_watchlist', JSON.stringify(watchlist));
            localStorage.setItem('openbb_historical', JSON.stringify(historicalData));
        }
        
        function loadWatchlistFromStorage() {
            const savedWatchlist = localStorage.getItem('openbb_watchlist');
            const savedHistorical = localStorage.getItem('openbb_historical');
            
            if (savedWatchlist) {
                watchlist = JSON.parse(savedWatchlist);
                updateWatchlistDisplay();
            }
            
            if (savedHistorical) {
                historicalData = JSON.parse(savedHistorical);
            }
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (autoUpdateInterval) {
                clearInterval(autoUpdateInterval);
            }
        });
    </script>
</body>
</html>
