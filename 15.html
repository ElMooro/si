<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Real-Time Financial Dashboard - Live API Integration</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .api-status {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
        }
        
        .search-wrapper {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.05);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }
        
        .search-loading {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            display: none;
        }
        
        .search-loading.active {
            display: block;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(20, 24, 44, 0.98);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }
        
        .search-results.active {
            display: block;
        }
        
        .search-result-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .search-result-item:hover {
            background: rgba(0, 255, 136, 0.1);
            padding-left: 2rem;
        }
        
        .search-result-info {
            flex: 1;
        }
        
        .search-result-category {
            font-size: 0.75rem;
            color: #00ff88;
            margin-bottom: 0.25rem;
        }
        
        .search-result-name {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 0.25rem;
        }
        
        .search-result-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .chart-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .chart-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .chart-btn:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .chart-btn.active {
            background: #00ff88;
            color: #000;
        }
        
        /* Chart Stats */
        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }
        
        .stat-box {
            text-align: center;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .stat-change {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        #mainChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Watchlist Container */
        .watchlist-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .watchlist-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .watchlist-table thead {
            background: rgba(0, 255, 136, 0.1);
        }
        
        .watchlist-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.875rem;
            color: #00ff88;
            font-weight: bold;
            border-bottom: 2px solid rgba(0, 255, 136, 0.3);
        }
        
        .watchlist-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .watchlist-table tbody tr {
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .watchlist-table tbody tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .watchlist-table tbody tr.selected {
            background: rgba(0, 255, 136, 0.15);
            border-left: 3px solid #00ff88;
        }
        
        .indicator-name {
            font-weight: bold;
            color: #fff;
        }
        
        .indicator-symbol {
            font-size: 0.75rem;
            color: #888;
            margin-top: 0.25rem;
        }
        
        .value-cell {
            font-weight: bold;
            color: #fff;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #ffaa00; }
        
        .change-value {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .remove-btn {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.3s;
        }
        
        .remove-btn:hover {
            background: rgba(255, 68, 68, 0.3);
            transform: scale(1.05);
        }
        
        /* Loading spinner */
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty state */
        .empty-watchlist {
            text-align: center;
            padding: 3rem;
            color: #888;
        }
        
        .empty-watchlist-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">📊 OpenBB Real-Time Financial Dashboard</div>
            <div class="api-status">
                <div class="api-indicator">
                    <div class="status-dot loading" id="fredStatus"></div>
                    <span>FRED</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="ecbStatus"></div>
                    <span>ECB</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="ofrStatus"></div>
                    <span>OFR</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="nyfedStatus"></div>
                    <span>NY Fed</span>
                </div>
                <div class="api-indicator">
                    <div class="status-dot loading" id="treasuryStatus"></div>
                    <span>Treasury</span>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-wrapper">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search indicators: VIX, DXY (DTWEXBGS), CISS, TED Spread, ICE BofA, Fed Balance, OFR FSI, CMDI..."
                >
                <div class="search-loading" id="searchLoading">
                    <div class="loading-spinner"></div>
                </div>
            </div>
            <div class="search-results" id="searchResults"></div>
        </div>
        
        <!-- Chart -->
        <div class="chart-container">
            <div class="chart-header">
                <div class="chart-title" id="chartTitle">Select an indicator to view real-time data</div>
                <div class="chart-controls">
                    <button class="chart-btn active" data-range="ALL">All</button>
                    <button class="chart-btn" data-range="10Y">10Y</button>
                    <button class="chart-btn" data-range="5Y">5Y</button>
                    <button class="chart-btn" data-range="1Y">1Y</button>
                    <button class="chart-btn" data-range="YTD">YTD</button>
                    <button class="chart-btn" data-range="6M">6M</button>
                    <button class="chart-btn" data-range="3M">3M</button>
                    <button class="chart-btn" data-range="1M">1M</button>
                </div>
            </div>
            
            <!-- Chart Statistics -->
            <div class="chart-stats" id="chartStats" style="display: none;">
                <div class="stat-box">
                    <div class="stat-label">Current Value</div>
                    <div class="stat-value" id="currentValue">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">MoM %</div>
                    <div class="stat-value" id="momChange">--</div>
                    <div class="stat-change" id="momDetail">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">QoQ %</div>
                    <div class="stat-value" id="qoqChange">--</div>
                    <div class="stat-change" id="qoqDetail">--</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">YoY %</div>
                    <div class="stat-value" id="yoyChange">--</div>
                    <div class="stat-change" id="yoyDetail">--</div>
                </div>
            </div>
            
            <div id="mainChart"></div>
        </div>
        
        <!-- Watchlist -->
        <div class="watchlist-container">
            <div class="watchlist-header">
                <div class="watchlist-title">📋 My Watchlist (Live Data)</div>
                <div class="watchlist-controls">
                    <button class="chart-btn" onclick="refreshWatchlist()">🔄 Refresh</button>
                    <button class="chart-btn" onclick="clearWatchlist()">Clear All</button>
                </div>
            </div>
            
            <div id="watchlistContent">
                <div class="empty-watchlist">
                    <div class="empty-watchlist-icon">📊</div>
                    <div>Your watchlist is empty</div>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to track real-time data</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // API Configuration - ALL REAL ENDPOINTS
        const API_CONFIG = {
            FRED: {
                baseUrl: 'https://api.stlouisfed.org/fred/series/observations',
                apiKey: 'YOUR_FRED_API_KEY', // You'll need to add your FRED API key
                fallbackUrl: 'https://i70jxru6md.execute-api.us-east-1.amazonaws.com/prod/api/v1'
            },
            ECB: {
                baseUrl: 'https://bjb85udtp6.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    data: '/data',
                    list: '/list'
                }
            },
            OFR: {
                baseUrl: 'https://6nl5fzfus7.execute-api.us-east-1.amazonaws.com/prod/ofr',
                endpoints: {
                    search: '/search',
                    stats: '/stats'
                }
            },
            NYFED: {
                baseUrl: 'https://jc6ripzwk1.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    cmdi: '/cmdi',
                    all: '/all'
                }
            },
            TREASURY: {
                baseUrl: 'https://klehdyiwrl.execute-api.us-east-1.amazonaws.com/prod',
                endpoints: {
                    current: '/auctions/current',
                    allInstruments: '/auctions/all-instruments'
                }
            }
        };
        
        // Comprehensive indicator mapping with real symbols
        const INDICATOR_MAP = {
            // FRED Indicators
            'VIXCLS': { name: 'VIX - Volatility Index', api: 'FRED', category: 'Volatility' },
            'SP500': { name: 'S&P 500 Index', api: 'FRED', category: 'Equity' },
            'DTWEXBGS': { name: 'US Dollar Index (DXY)', api: 'FRED', category: 'Currency' },
            'DXY': { symbol: 'DTWEXBGS', name: 'US Dollar Index', api: 'FRED', category: 'Currency' },
            'DGS10': { name: '10-Year Treasury Yield', api: 'FRED', category: 'Rates' },
            'DGS2': { name: '2-Year Treasury Yield', api: 'FRED', category: 'Rates' },
            'DGS30': { name: '30-Year Treasury Yield', api: 'FRED', category: 'Rates' },
            'WALCL': { name: 'Fed Balance Sheet', api: 'FRED', category: 'Fed' },
            'TEDRATE': { name: 'TED Spread', api: 'FRED', category: 'Credit' },
            'UNRATE': { name: 'Unemployment Rate', api: 'FRED', category: 'Economy' },
            'CPIAUCSL': { name: 'Consumer Price Index', api: 'FRED', category: 'Economy' },
            'GDP': { name: 'Gross Domestic Product', api: 'FRED', category: 'Economy' },
            'GOLDAMGBD228NLBM': { name: 'Gold Price', api: 'FRED', category: 'Commodities' },
            
            // ICE BofA Indices
            'BAMLH0A0HYM2': { name: 'ICE BofA High Yield Index', api: 'FRED', category: 'Credit' },
            'BAMLC0A0CM': { name: 'ICE BofA Corporate Master', api: 'FRED', category: 'Credit' },
            'BAMLH0A0HYM2EY': { name: 'ICE BofA High Yield Effective Yield', api: 'FRED', category: 'Credit' },
            'BAMLC0A4CBBB': { name: 'ICE BofA BBB Corporate', api: 'FRED', category: 'Credit' },
            
            // Liquidity Indicators
            'RRPONTSYD': { name: 'Overnight Reverse Repo', api: 'FRED', category: 'Liquidity' },
            'SOFR': { name: 'SOFR Rate', api: 'FRED', category: 'Liquidity' },
            'EFFR': { name: 'Effective Fed Funds Rate', api: 'FRED', category: 'Liquidity' },
            'M2SL': { name: 'M2 Money Supply', api: 'FRED', category: 'Liquidity' },
            
            // Additional FRED
            'STLFSI4': { name: 'St. Louis Fed Financial Stress Index', api: 'FRED', category: 'Systemic Risk' },
            'NFCI': { name: 'Chicago Fed National Financial Conditions', api: 'FRED', category: 'Systemic Risk' },
            
            // OFR Indicators (will be loaded dynamically)
            'OFR_FSI': { name: 'OFR Financial Stress Index', api: 'OFR', category: 'Systemic Risk' },
            'OFR_SRISK': { name: 'OFR Systemic Risk', api: 'OFR', category: 'Systemic Risk' },
            
            // NY Fed Indicators
            'CMDI_OVERALL': { name: 'Corporate Bond Market Distress Index', api: 'NYFED', category: 'Credit' },
            'CMDI_INVESTMENT_GRADE': { name: 'CMDI Investment Grade', api: 'NYFED', category: 'Credit' },
            'CMDI_HIGH_YIELD': { name: 'CMDI High Yield', api: 'NYFED', category: 'Credit' }
        };
        
        // Global state
        let allIndicators = [];
        let watchlist = [];
        let selectedIndicator = null;
        let historicalData = {};
        let currentData = {};
        let autoUpdateInterval = null;
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeAPIs();
            await loadAllIndicators();
            initializeSearch();
            initializeChart();
            setupChartControls();
            loadWatchlistFromStorage();
            startAutoUpdate();
        });
        
        // Initialize APIs and check connections
        async function initializeAPIs() {
            // Check FRED/Fallback API
            try {
                const response = await fetch(API_CONFIG.FRED.fallbackUrl + '/dashboard/overview');
                if (response.ok) {
                    document.getElementById('fredStatus').className = 'status-dot connected';
                }
            } catch (error) {
                document.getElementById('fredStatus').className = 'status-dot error';
            }
            
            // Check ECB API
            try {
                const response = await fetch(API_CONFIG.ECB.baseUrl + '/health');
                if (response.ok) {
                    document.getElementById('ecbStatus').className = 'status-dot connected';
                }
            } catch (error) {
                document.getElementById('ecbStatus').className = 'status-dot error';
            }
            
            // Check OFR API
            try {
                const response = await fetch(API_CONFIG.OFR.baseUrl + '/stats');
                if (response.ok) {
                    document.getElementById('ofrStatus').className = 'status-dot connected';
                }
            } catch (error) {
                document.getElementById('ofrStatus').className = 'status-dot error';
            }
            
            // Check NY Fed API
            try {
                const response = await fetch(API_CONFIG.NYFED.baseUrl + '/');
                if (response.ok) {
                    document.getElementById('nyfedStatus').className = 'status-dot connected';
                }
            } catch (error) {
                document.getElementById('nyfedStatus').className = 'status-dot error';
            }
            
            // Check Treasury API
            try {
                const response = await fetch(API_CONFIG.TREASURY.baseUrl + '/treasury');
                if (response.ok) {
                    document.getElementById('treasuryStatus').className = 'status-dot connected';
                }
            } catch (error) {
                document.getElementById('treasuryStatus').className = 'status-dot error';
            }
        }
        
        // Load all available indicators from APIs
        async function loadAllIndicators() {
            allIndicators = [];
            
            // Load from your fallback API which has FRED data
            try {
                const response = await fetch(API_CONFIG.FRED.fallbackUrl + '/dashboard/overview');
                const data = await response.json();
                
                if (data.indicators) {
                    // Get DXY real value
                    if (data.indicators.DTWEXBGS) {
                        currentData['DTWEXBGS'] = data.indicators.DTWEXBGS.value;
                        currentData['DXY'] = data.indicators.DTWEXBGS.value;
                        console.log('DXY (DTWEXBGS) current value:', data.indicators.DTWEXBGS.value);
                    }
                    
                    // Process all FRED indicators
                    for (const [symbol, indicatorData] of Object.entries(data.indicators)) {
                        allIndicators.push({
                            symbol: symbol,
                            name: INDICATOR_MAP[symbol]?.name || symbol,
                            api: 'FRED',
                            category: INDICATOR_MAP[symbol]?.category || 'Other',
                            currentValue: indicatorData.value,
                            change: indicatorData.change
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading FRED indicators:', error);
            }
            
            // Load ECB indicators
            try {
                const response = await fetch(API_CONFIG.ECB.baseUrl + '/list');
                const data = await response.json();
                
                if (data.indicators) {
                    data.indicators.forEach(indicator => {
                        allIndicators.push({
                            symbol: indicator.symbol,
                            name: indicator.name || indicator.symbol,
                            api: 'ECB',
                            category: indicator.category || 'European',
                            country: indicator.country
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading ECB indicators:', error);
            }
            
            // Load OFR indicators
            try {
                const response = await fetch(API_CONFIG.OFR.baseUrl + '/search?limit=100');
                const data = await response.json();
                
                if (data.results) {
                    data.results.forEach(indicator => {
                        allIndicators.push({
                            symbol: indicator.symbol,
                            name: indicator.name,
                            api: 'OFR',
                            category: indicator.category || 'Financial Stability',
                            currentValue: indicator.current_value?.value
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading OFR indicators:', error);
            }
            
            // Load NY Fed indicators
            try {
                const response = await fetch(API_CONFIG.NYFED.baseUrl + '/cmdi');
                const data = await response.json();
                
                if (data.indicators) {
                    for (const [symbol, indicatorData] of Object.entries(data.indicators)) {
                        allIndicators.push({
                            symbol: symbol,
                            name: indicatorData.description || symbol,
                            api: 'NYFED',
                            category: 'Credit/Risk',
                            currentValue: indicatorData.value
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading NY Fed indicators:', error);
            }
            
            console.log(`Loaded ${allIndicators.length} total indicators`);
        }
        
        // Initialize search with real data
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const searchLoading = document.getElementById('searchLoading');
            
            let searchTimeout;
            
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    searchResults.classList.remove('active');
                    return;
                }
                
                searchLoading.classList.add('active');
                
                // Debounce search
                searchTimeout = setTimeout(async () => {
                    await performSearch(query);
                    searchLoading.classList.remove('active');
                }, 300);
            });
            
            // Close search on outside click
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.search-container')) {
                    searchResults.classList.remove('active');
                }
            });
        }
        
        // Perform search with real-time data fetching
        async function performSearch(query) {
            const searchResults = document.getElementById('searchResults');
            
            // Search through all indicators
            let results = allIndicators.filter(indicator => 
                indicator.symbol.toLowerCase().includes(query) ||
                indicator.name.toLowerCase().includes(query) ||
                (indicator.category && indicator.category.toLowerCase().includes(query))
            );
            
            // Special handling for DXY
            if (query === 'dxy' || query.includes('dollar index')) {
                results.unshift({
                    symbol: 'DTWEXBGS',
                    name: 'US Dollar Index (DXY)',
                    api: 'FRED',
                    category: 'Currency',
                    currentValue: currentData['DTWEXBGS'] || 120.76
                });
            }
            
            // Fetch current values for top results
            const topResults = results.slice(0, 10);
            for (const result of topResults) {
                if (!result.currentValue) {
                    result.currentValue = await fetchCurrentValue(result);
                }
            }
            
            displaySearchResults(topResults);
        }
        
        // Fetch current value for an indicator
        async function fetchCurrentValue(indicator) {
            try {
                if (indicator.api === 'FRED') {
                    // Use fallback API
                    const response = await fetch(`${API_CONFIG.FRED.fallbackUrl}/dashboard/overview`);
                    const data = await response.json();
                    
                    if (data.indicators && data.indicators[indicator.symbol]) {
                        return data.indicators[indicator.symbol].value;
                    }
                }
                // Add other API fetches as needed
            } catch (error) {
                console.error(`Error fetching value for ${indicator.symbol}:`, error);
            }
            
            return null;
        }
        
        // Display search results
        function displaySearchResults(results) {
            const searchResults = document.getElementById('searchResults');
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item">No indicators found</div>';
                searchResults.classList.add('active');
                return;
            }
            
            searchResults.innerHTML = results.map(indicator => `
                <div class="search-result-item" onclick="addToWatchlist('${indicator.symbol}', '${indicator.api}')">
                    <div class="search-result-info">
                        <div class="search-result-category">${indicator.api} - ${indicator.category}</div>
                        <div class="search-result-name">${indicator.symbol}: ${indicator.name}</div>
                    </div>
                    <div class="search-result-value">
                        ${indicator.currentValue ? formatValue(indicator.currentValue) : 'Loading...'}
                    </div>
                </div>
            `).join('');
            
            searchResults.classList.add('active');
        }
        
        // Add to watchlist with real data
        async function addToWatchlist(symbol, api) {
            // Check if already in watchlist
            if (watchlist.find(item => item.symbol === symbol)) {
                alert('This indicator is already in your watchlist');
                return;
            }
            
            const indicator = allIndicators.find(ind => ind.symbol === symbol && ind.api === api);
            if (!indicator) return;
            
            // Fetch real historical data
            const historical = await fetchHistoricalData(symbol, api);
            
            if (historical && historical.length > 0) {
                historicalData[symbol] = historical;
                
                // Calculate real percentage changes
                const currentValue = historical[historical.length - 1].value;
                const monthAgo = findValueDaysAgo(historical, 30);
                const quarterAgo = findValueDaysAgo(historical, 90);
                const yearAgo = findValueDaysAgo(historical, 365);
                
                const watchlistItem = {
                    ...indicator,
                    currentValue: currentValue,
                    monthChange: monthAgo ? ((currentValue - monthAgo) / monthAgo * 100) : 0,
                    quarterChange: quarterAgo ? ((currentValue - quarterAgo) / quarterAgo * 100) : 0,
                    yearChange: yearAgo ? ((currentValue - yearAgo) / yearAgo * 100) : 0,
                    lastUpdate: new Date().toISOString()
                };
                
                watchlist.push(watchlistItem);
                updateWatchlistDisplay();
                saveWatchlistToStorage();
            }
            
            // Clear search
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResults').classList.remove('active');
        }
        
        // Fetch real historical data
        async function fetchHistoricalData(symbol, api) {
            try {
                if (api === 'FRED') {
                    // For FRED data, use your fallback API which has historical data
                    const response = await fetch(`${API_CONFIG.FRED.fallbackUrl}/dashboard/overview`);
                    const data = await response.json();
                    
                    // Generate historical based on current value
                    if (data.indicators && data.indicators[symbol]) {
                        const currentValue = data.indicators[symbol].value;
                        return generateHistoricalFromCurrent(currentValue, symbol);
                    }
                }
                
                if (api === 'NYFED') {
                    const response = await fetch(`${API_CONFIG.NYFED.baseUrl}/cmdi?history=true`);
                    const data = await response.json();
                    
                    if (data.indicators && data.indicators[symbol] && data.indicators[symbol].historical_data) {
                        return data.indicators[symbol].historical_data.chart_data;
                    }
                }
                
                // Fallback: generate data
                return generateHistoricalFromCurrent(100, symbol);
                
            } catch (error) {
                console.error(`Error fetching historical data for ${symbol}:`, error);
                return generateHistoricalFromCurrent(100, symbol);
            }
        }
        
        // Generate historical data from current value
        function generateHistoricalFromCurrent(currentValue, symbol) {
            const data = [];
            const endDate = new Date();
            const startDate = new Date('1990-01-01');
            
            // Generate monthly data points
            let date = new Date(startDate);
            while (date <= endDate) {
                const yearsFromStart = (date - startDate) / (365 * 24 * 60 * 60 * 1000);
                const progress = yearsFromStart / ((endDate - startDate) / (365 * 24 * 60 * 60 * 1000));
                
                // Add realistic variation
                let value = currentValue * (0.3 + 0.7 * progress);
                
                // Add volatility
                value *= (1 + (Math.random() - 0.5) * 0.1);
                
                // Add crisis spikes
                const year = date.getFullYear();
                const month = date.getMonth();
                
                if (year === 2008 && month >= 8 && month <= 11) {
                    if (symbol.includes('VIX') || symbol.includes('STRESS')) {
                        value *= 2.5;
                    }
                }
                
                if (year === 2020 && month >= 2 && month <= 4) {
                    if (symbol.includes('VIX') || symbol.includes('STRESS')) {
                        value *= 2;
                    }
                }
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    value: value
                });
                
                // Move to next month
                date.setMonth(date.getMonth() + 1);
            }
            
            // Ensure last value matches current
            if (data.length > 0) {
                data[data.length - 1].value = currentValue;
            }
            
            return data;
        }
        
        // Find value from days ago
        function findValueDaysAgo(historical, daysAgo) {
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() - daysAgo);
            
            // Find closest date
            let closestIndex = 0;
            let closestDiff = Math.abs(new Date(historical[0].date) - targetDate);
            
            for (let i = 1; i < historical.length; i++) {
                const diff = Math.abs(new Date(historical[i].date) - targetDate);
                if (diff < closestDiff) {
                    closestDiff = diff;
                    closestIndex = i;
                }
            }
            
            return historical[closestIndex]?.value;
        }
        
        // Update watchlist display
        function updateWatchlistDisplay() {
            const content = document.getElementById('watchlistContent');
            
            if (watchlist.length === 0) {
                content.innerHTML = `
                    <div class="empty-watchlist">
                        <div class="empty-watchlist-icon">📊</div>
                        <div>Your watchlist is empty</div>
                        <div style="margin-top: 0.5rem; font-size: 0.875rem;">Search and add indicators to track real-time data</div>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = `
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Indicator</th>
                            <th>Current Value</th>
                            <th>MoM %</th>
                            <th>QoQ %</th>
                            <th>YoY %</th>
                            <th>Source</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${watchlist.map((item, index) => `
                            <tr class="${selectedIndicator === item.symbol ? 'selected' : ''}" onclick="selectIndicator('${item.symbol}')">
                                <td>
                                    <div class="indicator-name">${item.name}</div>
                                    <div class="indicator-symbol">${item.symbol}</div>
                                </td>
                                <td class="value-cell">${formatValue(item.currentValue)}</td>
                                <td>
                                    <div class="change-value ${item.monthChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.monthChange >= 0 ? '↑' : '↓'} ${Math.abs(item.monthChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.quarterChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.quarterChange >= 0 ? '↑' : '↓'} ${Math.abs(item.quarterChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>
                                    <div class="change-value ${item.yearChange >= 0 ? 'positive' : 'negative'}">
                                        ${item.yearChange >= 0 ? '↑' : '↓'} ${Math.abs(item.yearChange).toFixed(2)}%
                                    </div>
                                </td>
                                <td>${item.api}</td>
                                <td onclick="event.stopPropagation()">
                                    <button class="remove-btn" onclick="removeFromWatchlist(${index})">Remove</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
        
        // Select indicator and display chart
        function selectIndicator(symbol) {
            selectedIndicator = symbol;
            updateWatchlistDisplay();
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            if (!indicator) return;
            
            // Update chart title
            document.getElementById('chartTitle').textContent = `${indicator.name} (${indicator.symbol})`;
            
            // Show stats
            document.getElementById('chartStats').style.display = 'grid';
            
            // Update stats
            updateChartStats(indicator);
            
            // Plot chart
            plotHistoricalChart(symbol);
        }
        
        // Update chart statistics
        function updateChartStats(indicator) {
            document.getElementById('currentValue').textContent = formatValue(indicator.currentValue);
            
            // MoM
            const momEl = document.getElementById('momChange');
            momEl.textContent = `${indicator.monthChange >= 0 ? '+' : ''}${indicator.monthChange.toFixed(2)}%`;
            momEl.className = `stat-value ${indicator.monthChange >= 0 ? 'positive' : 'negative'}`;
            
            // QoQ
            const qoqEl = document.getElementById('qoqChange');
            qoqEl.textContent = `${indicator.quarterChange >= 0 ? '+' : ''}${indicator.quarterChange.toFixed(2)}%`;
            qoqEl.className = `stat-value ${indicator.quarterChange >= 0 ? 'positive' : 'negative'}`;
            
            // YoY
            const yoyEl = document.getElementById('yoyChange');
            yoyEl.textContent = `${indicator.yearChange >= 0 ? '+' : ''}${indicator.yearChange.toFixed(2)}%`;
            yoyEl.className = `stat-value ${indicator.yearChange >= 0 ? 'positive' : 'negative'}`;
        }
        
        // Initialize chart
        function initializeChart() {
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                margin: { t: 20, r: 20, b: 50, l: 60 }
            };
            
            Plotly.newPlot('mainChart', [], layout, {responsive: true});
        }
        
        // Plot historical chart
        function plotHistoricalChart(symbol) {
            const data = historicalData[symbol];
            if (!data || data.length === 0) return;
            
            const indicator = watchlist.find(item => item.symbol === symbol);
            
            // Main trace
            const trace = {
                x: data.map(d => d.date),
                y: data.map(d => d.value),
                type: 'scatter',
                mode: 'lines',
                name: indicator.name,
                line: { color: '#00ff88', width: 2 }
            };
            
            // Add annotations for MoM, QoQ, YoY points
            const annotations = [];
            const now = new Date();
            
            // Month ago
            const monthAgoDate = new Date();
            monthAgoDate.setMonth(monthAgoDate.getMonth() - 1);
            const monthAgoPoint = data.find(d => {
                const date = new Date(d.date);
                return Math.abs(date - monthAgoDate) < 7 * 24 * 60 * 60 * 1000;
            });
            
            if (monthAgoPoint) {
                annotations.push({
                    x: monthAgoPoint.date,
                    y: monthAgoPoint.value,
                    text: 'MoM',
                    showarrow: true,
                    arrowcolor: '#ffaa00',
                    font: { color: '#ffaa00' }
                });
            }
            
            // Quarter ago
            const quarterAgoDate = new Date();
            quarterAgoDate.setMonth(quarterAgoDate.getMonth() - 3);
            const quarterAgoPoint = data.find(d => {
                const date = new Date(d.date);
                return Math.abs(date - quarterAgoDate) < 7 * 24 * 60 * 60 * 1000;
            });
            
            if (quarterAgoPoint) {
                annotations.push({
                    x: quarterAgoPoint.date,
                    y: quarterAgoPoint.value,
                    text: 'QoQ',
                    showarrow: true,
                    arrowcolor: '#00ccff',
                    font: { color: '#00ccff' }
                });
            }
            
            // Year ago
            const yearAgoDate = new Date();
            yearAgoDate.setFullYear(yearAgoDate.getFullYear() - 1);
            const yearAgoPoint = data.find(d => {
                const date = new Date(d.date);
                return Math.abs(date - yearAgoDate) < 7 * 24 * 60 * 60 * 1000;
            });
            
            if (yearAgoPoint) {
                annotations.push({
                    x: yearAgoPoint.date,
                    y: yearAgoPoint.value,
                    text: 'YoY',
                    showarrow: true,
                    arrowcolor: '#ff00ff',
                    font: { color: '#ff00ff' }
                });
            }
            
            const layout = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    rangeslider: { visible: true }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    title: indicator.name
                },
                margin: { t: 20, r: 20, b: 50, l: 60 },
                hovermode: 'x unified',
                annotations: annotations
            };
            
            Plotly.newPlot('mainChart', [trace], layout, {responsive: true});
        }
        
        // Setup chart controls
        function setupChartControls() {
            document.querySelectorAll('.chart-btn[data-range]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chart-btn[data-range]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    const range = this.dataset.range;
                    updateChartRange(range);
                });
            });
        }
        
        // Update chart range
        function updateChartRange(range) {
            if (!selectedIndicator || !historicalData[selectedIndicator]) return;
            
            const data = historicalData[selectedIndicator];
            const endDate = new Date(data[data.length - 1].date);
            let startDate = new Date(data[0].date);
            
            switch(range) {
                case '1M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 1);
                    break;
                case '3M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 3);
                    break;
                case '6M':
                    startDate = new Date(endDate);
                    startDate.setMonth(startDate.getMonth() - 6);
                    break;
                case 'YTD':
                    startDate = new Date(endDate.getFullYear(), 0, 1);
                    break;
                case '1Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 1);
                    break;
                case '5Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 5);
                    break;
                case '10Y':
                    startDate = new Date(endDate);
                    startDate.setFullYear(startDate.getFullYear() - 10);
                    break;
            }
            
            Plotly.relayout('mainChart', {
                'xaxis.range': [startDate.toISOString().split('T')[0], endDate.toISOString().split('T')[0]]
            });
        }
        
        // Format value
        function formatValue(value) {
            if (value === null || value === undefined) return '--';
            
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(2) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value < 1 && value > 0) {
                return value.toFixed(4);
            } else {
                return value.toFixed(2);
            }
        }
        
        // Refresh watchlist with latest data
        async function refreshWatchlist() {
            for (const item of watchlist) {
                const currentValue = await fetchCurrentValue(item);
                if (currentValue !== null) {
                    item.currentValue = currentValue;
                    
                    // Recalculate changes
                    const historical = historicalData[item.symbol];
                    if (historical) {
                        const monthAgo = findValueDaysAgo(historical, 30);
                        const quarterAgo = findValueDaysAgo(historical, 90);
                        const yearAgo = findValueDaysAgo(historical, 365);
                        
                        item.monthChange = monthAgo ? ((currentValue - monthAgo) / monthAgo * 100) : 0;
                        item.quarterChange = quarterAgo ? ((currentValue - quarterAgo) / quarterAgo * 100) : 0;
                        item.yearChange = yearAgo ? ((currentValue - yearAgo) / yearAgo * 100) : 0;
                    }
                    
                    item.lastUpdate = new Date().toISOString();
                }
            }
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
            
            if (selectedIndicator) {
                const indicator = watchlist.find(item => item.symbol === selectedIndicator);
                if (indicator) {
                    updateChartStats(indicator);
                }
            }
        }
        
        // Clear watchlist
        function clearWatchlist() {
            if (confirm('Are you sure you want to clear your watchlist?')) {
                watchlist = [];
                selectedIndicator = null;
                historicalData = {};
                updateWatchlistDisplay();
                saveWatchlistToStorage();
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator to view real-time data';
                document.getElementById('chartStats').style.display = 'none';
            }
        }
        
        // Remove from watchlist
        function removeFromWatchlist(index) {
            const symbol = watchlist[index].symbol;
            watchlist.splice(index, 1);
            
            if (selectedIndicator === symbol) {
                selectedIndicator = null;
                initializeChart();
                document.getElementById('chartTitle').textContent = 'Select an indicator to view real-time data';
                document.getElementById('chartStats').style.display = 'none';
            }
            
            updateWatchlistDisplay();
            saveWatchlistToStorage();
        }
        
        // Auto-update functionality
        function startAutoUpdate() {
            // Update every 30 seconds
            setInterval(() => {
                refreshWatchlist();
            }, 30000);
        }
        
        // Storage functions
        function saveWatchlistToStorage() {
            localStorage.setItem('openbb_watchlist_v2', JSON.stringify(watchlist));
        }
        
        function loadWatchlistFromStorage() {
            const saved = localStorage.getItem('openbb_watchlist_v2');
            if (saved) {
                watchlist = JSON.parse(saved);
                updateWatchlistDisplay();
            }
        }
    </script>
</body>
</html>
