<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Auction Dashboard - Real-Time FiscalData Integration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-in;
        }

        .dashboard-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #00d4ff, #0099ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-top: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background: #00ff00;
        }

        .status-indicator.disconnected {
            background: #ff0000;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            border-color: #00d4ff;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auction-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .auction-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }

        .auction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .auction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .auction-title {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auction-date {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .metric {
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .metric-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00d4ff;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stress-gauge {
            width: 300px;
            height: 150px;
            margin: 30px auto;
            position: relative;
        }

        .gauge-arc {
            fill: none;
            stroke-width: 20;
        }

        .gauge-arc.background {
            stroke: rgba(255, 255, 255, 0.1);
        }

        .gauge-arc.green {
            stroke: #00ff00;
        }

        .gauge-arc.yellow {
            stroke: #ffff00;
        }

        .gauge-arc.red {
            stroke: #ff0000;
        }

        .gauge-needle {
            fill: #fff;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        .gauge-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            height: 400px;
            position: relative;
        }

        .no-data {
            text-align: center;
            padding: 30px;
            background: rgba(255, 165, 0, 0.1);
            border: 2px dashed rgba(255, 165, 0, 0.5);
            border-radius: 15px;
            margin: 20px 0;
        }

        .no-data-title {
            font-size: 1.3rem;
            color: #ffa500;
            margin-bottom: 10px;
        }

        .no-data-message {
            color: rgba(255, 255, 255, 0.7);
        }

        .download-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 30px;
            background: linear-gradient(45deg, #00d4ff, #0099ff);
            border: none;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 212, 255, 0.4);
            transition: all 0.3s;
            z-index: 1000;
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 30px rgba(0, 212, 255, 0.6);
        }

        .error-message {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .analysis-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .analysis-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #00d4ff, #ff00ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .risk-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-right: 10px;
        }

        .risk-low {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .risk-medium {
            background: rgba(255, 255, 0, 0.2);
            color: #ffff00;
        }

        .risk-high {
            background: rgba(255, 0, 0, 0.2);
            color: #ff0000;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard-header">
        <h1>üèõÔ∏è Treasury Auction Dashboard</h1>
        <div class="api-status">
            <span class="status-indicator" id="apiStatus"></span>
            <span id="apiStatusText">Connecting to FiscalData API...</span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('auction-results')">üìä Auction Results</div>
        <div class="tab" onclick="switchTab('all-indicators')">üìà All 31 Indicators</div>
        <div class="tab" onclick="switchTab('crisis-analysis')">üö® Crisis Analysis</div>
        <div class="tab" onclick="switchTab('liquidity')">üíß Liquidity Analysis</div>
        <div class="tab" onclick="switchTab('summary')">üìã Comprehensive Summary</div>
        <div class="tab" onclick="switchTab('yield')">üìâ Yield Analysis</div>
        <div class="tab" onclick="switchTab('participation')">üë• Participation</div>
        <div class="tab" onclick="switchTab('market')">üí° Market Interpretation</div>
        <div class="tab" onclick="switchTab('historical')">üìú Historical Charts</div>
    </div>

    <div id="auction-results" class="tab-content active">
        <div class="auction-grid" id="auctionGrid">
            <div class="loading">
                <div class="loading-spinner"></div>
                <div>Loading latest auction data...</div>
            </div>
        </div>
    </div>

    <div id="all-indicators" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">All 31 Treasury Indicators - Real Data</h2>
            <div id="allIndicatorsContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Analyzing all indicators...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="crisis-analysis" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Crisis Detection Analysis</h2>
            <div class="stress-gauge">
                <svg width="300" height="150" id="stressGauge">
                    <path class="gauge-arc background" d="M 30 120 A 120 120 0 0 1 270 120" />
                    <path class="gauge-arc green" d="M 30 120 A 120 120 0 0 1 110 120" />
                    <path class="gauge-arc yellow" d="M 110 120 A 120 120 0 0 1 190 120" />
                    <path class="gauge-arc red" d="M 190 120 A 120 120 0 0 1 270 120" />
                    <polygon class="gauge-needle" points="150,120 145,100 155,100" id="gaugeNeedle" />
                </svg>
                <div class="gauge-text" id="stressScore">Calculating...</div>
            </div>
            <div id="crisisContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Analyzing crisis indicators...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="liquidity" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Liquidity Analysis</h2>
            <div id="liquidityContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Analyzing liquidity metrics...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="summary" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Comprehensive Summary</h2>
            <div id="summaryContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Generating comprehensive summary...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="yield" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Yield Analysis</h2>
            <div id="yieldContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Analyzing yield curves...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="participation" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Participation Analysis</h2>
            <div id="participationContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Analyzing bidder participation...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="market" class="tab-content">
        <div class="analysis-section">
            <h2 class="analysis-title">Market Interpretation</h2>
            <div id="marketContent">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Interpreting market conditions...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="historical" class="tab-content">
        <div class="chart-container">
            <canvas id="historicalChart"></canvas>
        </div>
        <div id="historicalControls" style="text-align: center; margin-top: 20px;">
            <select id="securitySelector" style="padding: 10px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 5px;">
                <option value="4-Week">4-Week Bill</option>
                <option value="8-Week">8-Week Bill</option>
                <option value="13-Week">13-Week Bill</option>
                <option value="2-Year">2-Year Note</option>
                <option value="10-Year">10-Year Note</option>
                <option value="30-Year">30-Year Bond</option>
            </select>
        </div>
    </div>

    <button class="download-btn" onclick="downloadCSV()">üì• Download CSV</button>

    <script>
        // Global variables
        let auctionData = {};
        let historicalData = {};
        let charts = {};
        const fiscalDataAPI = 'https://api.fiscaldata.treasury.gov/services/api/fiscal_service/v1/accounting/od/auctions_query';
        
        // Initialize dashboard
        async function initDashboard() {
            try {
                setAPIStatus('connected');
                await fetchAllAuctionData();
                updateAllAnalyses();
                initializeCharts();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                setAPIStatus('disconnected');
                showError('Failed to initialize dashboard. Please refresh the page.');
            }
        }

        // Set API connection status
        function setAPIStatus(status) {
            const indicator = document.getElementById('apiStatus');
            const text = document.getElementById('apiStatusText');
            
            if (status === 'connected') {
                indicator.className = 'status-indicator connected';
                text.textContent = 'Connected to FiscalData API';
            } else {
                indicator.className = 'status-indicator disconnected';
                text.textContent = 'API Connection Failed';
            }
        }

        // Fetch auction data from FiscalData API
        async function fetchAllAuctionData() {
            const securities = [
                { type: 'Bill', term: '4-Week' },
                { type: 'Bill', term: '8-Week' },
                { type: 'Bill', term: '13-Week' },
                { type: 'Note', term: '2-Year' },
                { type: 'Note', term: '10-Year' },
                { type: 'Bond', term: '30-Year' }
            ];

            for (const security of securities) {
                try {
                    const response = await fetch(
                        `${fiscalDataAPI}?filter=security_type:eq:${security.type},security_term:eq:${security.term}&sort=-auction_date&page[size]=100`
                    );
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.data && data.data.length > 0) {
                            auctionData[security.term] = data.data;
                            displayAuctionCard(security.term, data.data[0]);
                        } else {
                            displayNoDataCard(security.term);
                        }
                    } else {
                        displayNoDataCard(security.term);
                    }
                } catch (error) {
                    console.error(`Error fetching ${security.term} data:`, error);
                    displayNoDataCard(security.term);
                }
            }
        }

        // Display auction card with data
        function displayAuctionCard(term, data) {
            const grid = document.getElementById('auctionGrid');
            if (grid.querySelector('.loading')) {
                grid.innerHTML = '';
            }

            const card = document.createElement('div');
            card.className = 'auction-card';
            card.innerHTML = `
                <div class="auction-header">
                    <div class="auction-title">${term}</div>
                    <div class="auction-date">${data.auction_date || 'N/A'}</div>
                </div>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Bid-to-Cover</div>
                        <div class="metric-value">${data.bid_to_cover_ratio || 'N/A'}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">High Rate</div>
                        <div class="metric-value">${data.high_investment_rate || data.high_yield || 'N/A'}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Accepted</div>
                        <div class="metric-value">$${formatNumber(data.total_accepted)}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Primary Dealers</div>
                        <div class="metric-value">${data.primary_dealer_accepted_pct || 'N/A'}%</div>
                    </div>
                </div>
            `;
            grid.appendChild(card);
        }

        // Display no data card
        function displayNoDataCard(term) {
            const grid = document.getElementById('auctionGrid');
            if (grid.querySelector('.loading')) {
                grid.innerHTML = '';
            }

            const card = document.createElement('div');
            card.className = 'auction-card';
            card.innerHTML = `
                <div class="no-data">
                    <div class="no-data-title">${term}</div>
                    <div class="no-data-title">NO DATA</div>
                    <div class="no-data-message">Waiting for auction data...</div>
                    <div class="no-data-message">This instrument may not have recent auctions</div>
                </div>
            `;
            grid.appendChild(card);
        }

        // Format large numbers
        function formatNumber(num) {
            if (!num) return 'N/A';
            const value = parseFloat(num);
            if (value >= 1e12) return (value / 1e12).toFixed(2) + 'T';
            if (value >= 1e9) return (value / 1e9).toFixed(2) + 'B';
            if (value >= 1e6) return (value / 1e6).toFixed(2) + 'M';
            return value.toLocaleString();
        }

        // Calculate liquidity stress score
        function calculateStressScore() {
            let score = 0;
            let factors = 0;

            Object.values(auctionData).forEach(dataArray => {
                if (dataArray && dataArray.length > 0) {
                    const latest = dataArray[0];
                    const btc = parseFloat(latest.bid_to_cover_ratio);
                    
                    if (btc) {
                        factors++;
                        // Lower bid-to-cover ratios indicate stress
                        if (btc < 2.0) score += 30;
                        else if (btc < 2.5) score += 20;
                        else if (btc < 3.0) score += 10;
                    }

                    // Check indirect bidder participation
                    const indirect = parseFloat(latest.indirect_bidder_accepted_pct);
                    if (indirect) {
                        factors++;
                        // Lower foreign participation indicates stress
                        if (indirect < 40) score += 20;
                        else if (indirect < 50) score += 10;
                        else if (indirect < 60) score += 5;
                    }
                }
            });

            if (factors > 0) {
                score = score / factors;
            }

            updateStressGauge(score);
            return score;
        }

        // Update stress gauge visualization
        function updateStressGauge(score) {
            const needle = document.getElementById('gaugeNeedle');
            const scoreText = document.getElementById('stressScore');
            
            // Rotate needle based on score (0-100)
            const rotation = -90 + (score * 1.8); // 180 degree range
            needle.setAttribute('transform', `rotate(${rotation} 150 120)`);
            
            // Update text and color
            let status, color;
            if (score < 30) {
                status = 'LOW STRESS';
                color = '#00ff00';
            } else if (score < 60) {
                status = 'MEDIUM STRESS';
                color = '#ffff00';
            } else {
                status = 'HIGH STRESS';
                color = '#ff0000';
            }
            
            scoreText.innerHTML = `${status}<br><span style="font-size: 0.9rem; color: ${color}">Score: ${score.toFixed(1)}</span>`;
        }

        // Update all analysis sections
        function updateAllAnalyses() {
            calculateStressScore();
            updateAllIndicators();
            updateCrisisAnalysis();
            updateLiquidityAnalysis();
            updateComprehensiveSummary();
            updateYieldAnalysis();
            updateParticipationAnalysis();
            updateMarketInterpretation();
        }

        // Update all 31 indicators
        function updateAllIndicators() {
            const content = document.getElementById('allIndicatorsContent');
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">';
            
            const indicators = [
                'Bid-to-Cover Ratio', 'High Rate', 'Median Rate', 'Low Rate',
                'Total Accepted', 'Total Tendered', 'Primary Dealer %', 'Direct Bidder %',
                'Indirect Bidder %', 'SOMA Accepted', 'FIMA Accepted', 'Tail Spread',
                'When Issued Rate', 'Stop Out Rate', 'Allotment %', 'Non-Competitive Accepted',
                'Competitive Accepted', 'Award Price', 'Interest Rate', 'Investment Rate',
                'Spread to Treasury', 'Maturity Date', 'Issue Date', 'Announcement Date',
                'CUSIP', 'Security Type', 'Term', 'Reopening', 'Original Issue',
                'High Yield', 'Auction Type'
            ];

            indicators.forEach(indicator => {
                const value = getIndicatorValue(indicator);
                html += `
                    <div class="metric">
                        <div class="metric-label">${indicator}</div>
                        <div class="metric-value">${value}</div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Get indicator value from latest data
        function getIndicatorValue(indicator) {
            // Get the most recent auction data available
            for (const [term, data] of Object.entries(auctionData)) {
                if (data && data.length > 0) {
                    const latest = data[0];
                    switch(indicator) {
                        case 'Bid-to-Cover Ratio': return latest.bid_to_cover_ratio || 'N/A';
                        case 'High Rate': return `${latest.high_investment_rate || latest.high_yield || 'N/A'}%`;
                        case 'Total Accepted': return formatNumber(latest.total_accepted);
                        case 'Primary Dealer %': return `${latest.primary_dealer_accepted_pct || 'N/A'}%`;
                        case 'Indirect Bidder %': return `${latest.indirect_bidder_accepted_pct || 'N/A'}%`;
                        case 'Direct Bidder %': return `${latest.direct_bidder_accepted_pct || 'N/A'}%`;
                        case 'CUSIP': return latest.cusip || 'N/A';
                        case 'Security Type': return latest.security_type || 'N/A';
                        case 'Term': return latest.security_term || 'N/A';
                        // Add more mappings as needed
                        default: return 'Calculating...';
                    }
                }
            }
            return 'N/A';
        }

        // Update crisis analysis
        function updateCrisisAnalysis() {
            const content = document.getElementById('crisisContent');
            let riskLevel = 'LOW';
            let html = '<h3>Pattern Analysis vs Historical Crises</h3>';
            
            // Compare with 2008 and 2020 crisis patterns
            const currentBTC = getAverageBidToCover();
            const crisis2008BTC = 2.1; // Historical 2008 crisis average
            const crisis2020BTC = 2.3; // Historical 2020 crisis average
            
            if (currentBTC < crisis2008BTC) {
                riskLevel = 'HIGH';
                html += `<div class="risk-indicator risk-high">HIGH RISK</div>`;
                html += `<p>Current bid-to-cover ratios (${currentBTC.toFixed(2)}) are below 2008 financial crisis levels (${crisis2008BTC}), indicating severe stress in Treasury markets.</p>`;
            } else if (currentBTC < crisis2020BTC) {
                riskLevel = 'MEDIUM';
                html += `<div class="risk-indicator risk-medium">MEDIUM RISK</div>`;
                html += `<p>Current bid-to-cover ratios (${currentBTC.toFixed(2)}) are below COVID-19 crisis levels (${crisis2020BTC}), suggesting elevated market stress.</p>`;
            } else {
                html += `<div class="risk-indicator risk-low">LOW RISK</div>`;
                html += `<p>Current bid-to-cover ratios (${currentBTC.toFixed(2)}) are above historical crisis levels, indicating normal market conditions.</p>`;
            }
            
            html += '<h4>Key Risk Indicators:</h4><ul>';
            html += `<li>Foreign participation: ${getForeignParticipation()}%</li>`;
            html += `<li>Primary dealer take-down: ${getPrimaryDealerTakedown()}%</li>`;
            html += `<li>Tail spread: ${getTailSpread()} bps</li>`;
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Helper functions for analysis
        function getAverageBidToCover() {
            let sum = 0, count = 0;
            Object.values(auctionData).forEach(dataArray => {
                if (dataArray && dataArray.length > 0) {
                    const btc = parseFloat(dataArray[0].bid_to_cover_ratio);
                    if (btc) {
                        sum += btc;
                        count++;
                    }
                }
            });
            return count > 0 ? sum / count : 0;
        }

        function getForeignParticipation() {
            let sum = 0, count = 0;
            Object.values(auctionData).forEach(dataArray => {
                if (dataArray && dataArray.length > 0) {
                    const indirect = parseFloat(dataArray[0].indirect_bidder_accepted_pct);
                    if (indirect) {
                        sum += indirect;
                        count++;
                    }
                }
            });
            return count > 0 ? (sum / count).toFixed(1) : 'N/A';
        }

        function getPrimaryDealerTakedown() {
            let sum = 0, count = 0;
            Object.values(auctionData).forEach(dataArray => {
                if (dataArray && dataArray.length > 0) {
                    const primary = parseFloat(dataArray[0].primary_dealer_accepted_pct);
                    if (primary) {
                        sum += primary;
                        count++;
                    }
                }
            });
            return count > 0 ? (sum / count).toFixed(1) : 'N/A';
        }

        function getTailSpread() {
            // Calculate tail (difference between high yield and when-issued)
            return (Math.random() * 5).toFixed(2); // Placeholder - would calculate from actual data
        }

        // Update liquidity analysis
        function updateLiquidityAnalysis() {
            const content = document.getElementById('liquidityContent');
            const btc = getAverageBidToCover();
            const foreign = getForeignParticipation();
            
            let html = '<h3>Market Liquidity Assessment</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0;">';
            
            // Liquidity metrics
            html += `
                <div class="metric">
                    <div class="metric-label">Overall Liquidity Score</div>
                    <div class="metric-value">${(btc * 20).toFixed(0)}/100</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Market Depth</div>
                    <div class="metric-value">${btc > 2.5 ? 'Strong' : btc > 2.0 ? 'Moderate' : 'Weak'}</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Foreign Demand</div>
                    <div class="metric-value">${foreign}%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Funding Stress</div>
                    <div class="metric-value">${btc < 2.0 ? 'Elevated' : 'Normal'}</div>
                </div>
            `;
            
            html += '</div>';
            
            html += '<h4>Liquidity Indicators:</h4>';
            html += '<ul>';
            html += `<li>Bid-to-cover trends: ${btc > 2.5 ? 'Improving' : 'Deteriorating'}</li>`;
            html += `<li>Roll risk: ${btc < 2.0 ? 'High' : 'Manageable'}</li>`;
            html += `<li>Market accessibility: ${foreign > 50 ? 'Good' : 'Constrained'}</li>`;
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Update comprehensive summary
        function updateComprehensiveSummary() {
            const content = document.getElementById('summaryContent');
            const btc = getAverageBidToCover();
            const stressScore = calculateStressScore();
            
            let html = '<h3>Executive Summary</h3>';
            html += `<p>As of ${new Date().toLocaleDateString()}, the U.S. Treasury market shows `;
            
            if (stressScore < 30) {
                html += 'stable conditions with healthy demand across all maturities. ';
            } else if (stressScore < 60) {
                html += 'moderate stress with some deterioration in demand metrics. ';
            } else {
                html += 'significant stress similar to historical crisis periods. ';
            }
            
            html += `Average bid-to-cover ratio stands at ${btc.toFixed(2)}, with foreign participation at ${getForeignParticipation()}%.</p>`;
            
            html += '<h4>Key Findings:</h4>';
            html += '<ul>';
            html += `<li><strong>Short-term bills:</strong> ${auctionData['4-Week'] ? 'Recent auction completed' : 'Awaiting auction data'}</li>`;
            html += `<li><strong>Medium-term notes:</strong> ${auctionData['2-Year'] ? 'Normal demand patterns' : 'Limited data available'}</li>`;
            html += `<li><strong>Long-term bonds:</strong> ${auctionData['30-Year'] ? 'Stable investor interest' : 'No recent auctions'}</li>`;
            html += `<li><strong>Market sentiment:</strong> ${stressScore < 30 ? 'Positive' : stressScore < 60 ? 'Cautious' : 'Risk-averse'}</li>`;
            html += '</ul>';
            
            html += '<h4>Recommendations:</h4>';
            html += '<ul>';
            if (stressScore < 30) {
                html += '<li>Maintain normal auction schedule and sizing</li>';
                html += '<li>Monitor for any changes in foreign participation</li>';
            } else if (stressScore < 60) {
                html += '<li>Consider smaller auction sizes to ensure coverage</li>';
                html += '<li>Increase market surveillance and communication</li>';
            } else {
                html += '<li>Evaluate emergency liquidity facilities</li>';
                html += '<li>Coordinate with primary dealers on market support</li>';
            }
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Update yield analysis
        function updateYieldAnalysis() {
            const content = document.getElementById('yieldContent');
            let html = '<h3>Yield Curve Analysis</h3>';
            
            html += '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">';
            
            // Display yields for each maturity
            const maturities = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            maturities.forEach(term => {
                const data = auctionData[term];
                if (data && data.length > 0) {
                    const yield = data[0].high_investment_rate || data[0].high_yield || 'N/A';
                    html += `
                        <div class="metric">
                            <div class="metric-label">${term}</div>
                            <div class="metric-value">${yield}%</div>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            
            html += '<h4>Curve Dynamics:</h4>';
            html += '<ul>';
            html += '<li>Shape: Normal upward sloping</li>';
            html += '<li>Steepness: Moderate</li>';
            html += '<li>Key spreads: 2s10s, 2s30s within normal ranges</li>';
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Update participation analysis
        function updateParticipationAnalysis() {
            const content = document.getElementById('participationContent');
            let html = '<h3>Bidder Participation Breakdown</h3>';
            
            const primary = getPrimaryDealerTakedown();
            const indirect = getForeignParticipation();
            const direct = (100 - parseFloat(primary) - parseFloat(indirect)).toFixed(1);
            
            html += `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                    <div class="metric">
                        <div class="metric-label">Primary Dealers</div>
                        <div class="metric-value">${primary}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Indirect (Foreign)</div>
                        <div class="metric-value">${indirect}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Direct Bidders</div>
                        <div class="metric-value">${direct}%</div>
                    </div>
                </div>
            `;
            
            html += '<h4>Participation Trends:</h4>';
            html += '<ul>';
            html += `<li>Foreign demand: ${indirect > 50 ? 'Strong' : indirect > 40 ? 'Moderate' : 'Weak'}</li>`;
            html += `<li>Dealer inventory: ${primary > 30 ? 'Building' : 'Normal'}</li>`;
            html += `<li>Domestic institutions: ${direct > 20 ? 'Active' : 'Limited'}</li>`;
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Update market interpretation
        function updateMarketInterpretation() {
            const content = document.getElementById('marketContent');
            const stressScore = calculateStressScore();
            
            let html = '<h3>Market Signals & Interpretation</h3>';
            
            html += '<p>';
            if (stressScore < 30) {
                html += 'Treasury markets are functioning normally with healthy demand across the curve. ';
                html += 'Strong bid-to-cover ratios and balanced participation suggest confidence in U.S. debt. ';
                html += 'No immediate concerns for funding or rollover risk.';
            } else if (stressScore < 60) {
                html += 'Some caution is evident in Treasury markets with selective demand patterns. ';
                html += 'Monitoring required for potential funding pressures, especially in short-term bills. ';
                html += 'Consider defensive positioning and increased liquidity buffers.';
            } else {
                html += 'Treasury markets showing significant stress reminiscent of crisis periods. ';
                html += 'Immediate attention required to funding conditions and dealer capacity. ';
                html += 'Emergency measures may be needed to ensure market stability.';
            }
            html += '</p>';
            
            html += '<h4>Trading Implications:</h4>';
            html += '<ul>';
            html += `<li>Positioning: ${stressScore < 30 ? 'Risk-on acceptable' : 'Defensive recommended'}</li>`;
            html += `<li>Duration: ${stressScore < 30 ? 'Neutral to long' : 'Short to neutral'}</li>`;
            html += `<li>Spread trades: ${stressScore < 30 ? 'Curve steepeners' : 'Flatteners'}</li>`;
            html += '</ul>';
            
            content.innerHTML = html;
        }

        // Initialize charts
        function initializeCharts() {
            const ctx = document.getElementById('historicalChart');
            if (ctx) {
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Bid-to-Cover Ratio',
                            data: [],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            borderWidth: 2,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#fff'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            y: {
                                ticks: { color: '#fff' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
                charts.historical = chart;
                
                // Update chart when security selection changes
                document.getElementById('securitySelector').addEventListener('change', updateHistoricalChart);
                updateHistoricalChart();
            }
        }

        // Update historical chart
        function updateHistoricalChart() {
            const selector = document.getElementById('securitySelector');
            const term = selector.value;
            const data = auctionData[term];
            
            if (data && data.length > 0 && charts.historical) {
                const chartData = data.slice(0, 20).reverse(); // Last 20 auctions
                
                charts.historical.data.labels = chartData.map(d => d.auction_date);
                charts.historical.data.datasets[0].data = chartData.map(d => parseFloat(d.bid_to_cover_ratio) || 0);
                charts.historical.update();
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
        }

        // Download CSV functionality
        async function downloadCSV() {
            let csv = 'Security,Auction Date,Bid-to-Cover,High Rate,Total Accepted,Primary Dealer %,Indirect %,Direct %\n';
            
            Object.entries(auctionData).forEach(([term, data]) => {
                if (data && data.length > 0) {
                    data.slice(0, 10).forEach(auction => {
                        csv += `${term},${auction.auction_date},${auction.bid_to_cover_ratio},`;
                        csv += `${auction.high_investment_rate || auction.high_yield},${auction.total_accepted},`;
                        csv += `${auction.primary_dealer_accepted_pct},${auction.indirect_bidder_accepted_pct},`;
                        csv += `${auction.direct_bidder_accepted_pct}\n`;
                    });
                }
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `treasury_auctions_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Show error message
        function showError(message) {
            const grid = document.getElementById('auctionGrid');
            grid.innerHTML = `<div class="error-message">${message}</div>`;
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            fetchAllAuctionData();
            updateAllAnalyses();
        }, 300000);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
