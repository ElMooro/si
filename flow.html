<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Options Flow & Sentiment | JustHodl.AI</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0a0e17;--card:#111827;--card2:#1a2332;--border:#1e2d3d;--text:#e2e8f0;--dim:#64748b;--green:#22c55e;--red:#ef4444;--yellow:#f59e0b;--blue:#3b82f6;--purple:#a855f7;--cyan:#06b6d4;--orange:#f97316;--accent:#3b82f6}
body{font-family:'Inter',-apple-system,system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
a{color:var(--cyan);text-decoration:none}
.topbar{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100}
.topbar h1{font-size:18px;font-weight:700;background:linear-gradient(135deg,#60a5fa,#a78bfa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.topbar .meta{font-size:11px;color:var(--dim)}
.topbar .live{display:inline-block;width:8px;height:8px;background:#22c55e;border-radius:50%;margin-right:6px;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.back-link{font-size:13px;color:var(--cyan);padding:4px 12px;border:1px solid rgba(6,182,212,.3);border-radius:6px}
.back-link:hover{background:rgba(6,182,212,.1)}
.tabs{display:flex;gap:2px;padding:8px 24px;background:#0d1117;border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap}
.tab{padding:8px 16px;font-size:12px;font-weight:500;color:var(--dim);cursor:pointer;border-radius:6px;white-space:nowrap;transition:.2s}
.tab:hover{color:var(--text);background:rgba(255,255,255,.05)}
.tab.active{color:#60a5fa;background:rgba(59,130,246,.15);border:1px solid rgba(59,130,246,.3)}
.content{padding:20px 24px;max-width:1600px;margin:0 auto}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
.grid4{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;position:relative;overflow:hidden}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--accent),transparent)}
.card h3{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--dim);margin-bottom:10px}
.stat{font-size:28px;font-weight:700;line-height:1.2}
.sublabel{font-size:11px;color:var(--dim);margin-top:2px}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:600;letter-spacing:.5px}
.badge.green{background:rgba(34,197,94,.15);color:#22c55e}
.badge.red{background:rgba(239,68,68,.15);color:#ef4444}
.badge.yellow{background:rgba(245,158,11,.15);color:#f59e0b}
.badge.blue{background:rgba(59,130,246,.15);color:#3b82f6}
.badge.purple{background:rgba(168,85,247,.15);color:#a78bfa}
.badge.cyan{background:rgba(6,182,212,.15);color:#06b6d4}
.badge.orange{background:rgba(249,115,22,.15);color:#f97316}
table{width:100%;border-collapse:collapse;font-size:12px}
th{text-align:left;padding:8px 10px;font-size:10px;text-transform:uppercase;letter-spacing:.8px;color:var(--dim);border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--card)}
td{padding:7px 10px;border-bottom:1px solid rgba(30,45,61,.5)}
tr:hover{background:rgba(255,255,255,.02)}
.pct-bar{height:6px;border-radius:3px;background:#1e293b;overflow:hidden;min-width:60px}
.pct-fill{height:100%;border-radius:3px;transition:width .5s}
.gauge-wrap{position:relative;width:200px;height:110px;margin:0 auto}
.section-title{font-size:14px;font-weight:600;margin:24px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px}
.section-title .icon{font-size:16px}
.sparkline{display:flex;align-items:end;gap:1px;height:32px}
.sparkline .bar{width:3px;border-radius:1px;transition:height .3s}
.flow-bar{display:flex;align-items:center;gap:6px}
.flow-bar .bar-container{flex:1;height:14px;border-radius:3px;background:#1e293b;position:relative;overflow:hidden}
.flow-bar .fill{height:100%;border-radius:3px;position:absolute;top:0}
.signal-card{background:var(--card2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;border-left:3px solid}
.signal-card.buy{border-left-color:#22c55e}
.signal-card.sell{border-left-color:#ef4444}
.signal-card.warn{border-left-color:#f59e0b}
.signal-card .sig-type{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.signal-card .sig-msg{font-size:12px;color:var(--dim);margin-top:4px}
.signal-card .sig-conf{font-size:10px;color:var(--dim);margin-top:4px}
.hidden{display:none!important}
.loading{text-align:center;padding:60px;color:var(--dim)}
.loading .spin{display:inline-block;width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.pos{color:#22c55e}.neg{color:#ef4444}.neu{color:#f59e0b}
.heatmap-cell{padding:8px;border-radius:6px;text-align:center;font-size:11px;font-weight:600}
@media(max-width:1024px){.grid2,.grid3{grid-template-columns:1fr}.grid4{grid-template-columns:1fr 1fr}}
@media(max-width:640px){.content{padding:12px}.tabs{padding:6px 12px}}
</style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
<div class="topbar">
<div style="display:flex;align-items:center;gap:16px">
<a href="index.html" class="back-link">‚Üê Dashboard</a>
<h1>Options Flow & Sentiment Intelligence</h1>
</div>
<div class="meta"><span class="live"></span>Live | <span id="lastUpdate">Loading...</span></div>
</div>
<div class="tabs" id="tabBar">
<div class="tab active" data-tab="overview">Overview</div>
<div class="tab" data-tab="vix">VIX Complex</div>
<div class="tab" data-tab="options">Options Flow</div>
<div class="tab" data-tab="gamma">Gamma Exposure</div>
<div class="tab" data-tab="flows">Fund Flows</div>
<div class="tab" data-tab="sentiment">Sentiment</div>
<div class="tab" data-tab="unusual">Unusual Activity</div>
<div class="tab" data-tab="signals">Trading Signals</div>
<div class="tab" data-tab="news">News Sentiment</div>
<div class="tab" data-tab="internals">Market Internals</div>
</div>
<div class="content" id="mainContent">
<div class="loading"><div class="spin"></div><p style="margin-top:12px">Loading institutional data...</p></div>
</div>
<script>
const LAMBDA='https://g65enkjk3uu4woaoy764ow3q340sppvg.lambda-url.us-east-1.on.aws/';
const S3='https://justhodl-dashboard-live.s3.amazonaws.com/flow-data.json';
let DATA=null,activeTab='overview';
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const fmt=(n,d=1)=>n!=null?Number(n).toFixed(d):'‚Äî';
const fmtM=n=>{if(!n&&n!==0)return'‚Äî';let a=Math.abs(n);return(n<0?'-':'+')+' $'+(a>=1e9?(a/1e9).toFixed(1)+'B':a>=1e6?(a/1e6).toFixed(1)+'M':a>=1e3?(a/1e3).toFixed(0)+'K':'$'+a.toFixed(0))};
const fmtN=n=>{if(!n&&n!==0)return'‚Äî';return n>=1e9?(n/1e9).toFixed(2)+'B':n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?Math.round(n/1e3)+'K':n.toFixed(0)};
const cc=v=>v>0?'pos':v<0?'neg':'neu';
const bc=l=>{const m={'BULLISH':'green','BEARISH':'red','NEUTRAL':'yellow','INFLOW':'green','OUTFLOW':'red','FLAT':'yellow','RISK_ON':'green','RISK_OFF':'red'};return m[l]||'blue'};
const sparkline=(vals,h=32)=>{if(!vals||!vals.length)return'';const mx=Math.max(...vals),mn=Math.min(...vals),r=mx-mn||1;return`<div class="sparkline">${vals.map(v=>{const ht=Math.max(2,((v-mn)/r)*h);const c=v>=vals[0]?'#22c55e':'#ef4444';return`<div class="bar" style="height:${ht}px;background:${c}"></div>`}).join('')}</div>`};

function renderOverview(d){
const v=d.vix_complex?.vix||{},pc=d.put_call||{},s=d.sentiment?.composite||{},gex=d.gamma_exposure||{},ff=d.fund_flows||{},ra=ff.risk_appetite||{},sr=ff.sector_rotation?.rotation_signal||{},sigs=d.trading_signals||[];
const mf=ff.market_flow||{};
return`
<div class="grid4">
<div class="card" style="--accent:${v.regime_color||'#3b82f6'}"><h3>VIX</h3><div class="stat">${fmt(v.current,2)}</div><div class="sublabel"><span class="${cc(v.change)}">${v.change>0?'+':''}${fmt(v.change,2)} (${v.change>0?'+':''}${fmt(v.change_pct,1)}%)</span></div><span class="badge ${v.current>25?'red':v.current>20?'yellow':'green'}">${v.regime||'‚Äî'}</span></div>
<div class="card" style="--accent:${s.color||'#f59e0b'}"><h3>Sentiment</h3><div class="stat">${fmt(s.score,0)}<span style="font-size:14px;color:var(--dim)">/100</span></div><span class="badge ${s.score<30?'red':s.score>70?'green':'yellow'}">${s.label||'‚Äî'}</span></div>
<div class="card" style="--accent:${pc.pc_color||'#3b82f6'}"><h3>Put/Call Ratio</h3><div class="stat">${fmt(pc.total_put_call_ratio,3)}</div><div class="sublabel">Calls: ${fmtN(pc.total_call_volume)} | Puts: ${fmtN(pc.total_put_volume)}</div><span class="badge ${pc.total_put_call_ratio>1?'red':pc.total_put_call_ratio<0.6?'green':'yellow'}">${pc.pc_signal||'‚Äî'}</span></div>
<div class="card" style="--accent:${gex.color||'#22c55e'}"><h3>Gamma Exposure</h3><div class="stat">${fmtN(gex.total_gex)}</div><div class="sublabel">Max Strike: $${gex.max_gamma_strike||'‚Äî'}</div><span class="badge ${gex.regime==='POSITIVE_GAMMA'?'green':'red'}">${gex.regime||'‚Äî'}</span></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="card" style="--accent:#06b6d4"><h3>üí∞ Net Options Premium</h3>
<div style="display:flex;justify-content:space-between;align-items:center">
<div><div class="stat pos">${fmtM(pc.net_premium)}</div><div class="sublabel">Call Premium: ${fmtM(pc.total_call_premium)} | Put Premium: ${fmtM(pc.total_put_premium)}</div></div>
<div style="text-align:right"><div style="font-size:20px;font-weight:700" class="${cc(mf.net_5d)}">${fmtM(mf.net_5d)}</div><div class="sublabel">5-Day Net ETF Flow</div></div>
</div></div>
<div class="card" style="--accent:${ra.regime==='RISK_ON'?'#22c55e':'#ef4444'}"><h3>üéØ Risk Appetite</h3>
<div style="display:flex;justify-content:space-between;align-items:center">
<div><span class="badge ${ra.regime==='RISK_ON'?'green':'red'}" style="font-size:14px;padding:4px 12px">${ra.regime||'‚Äî'}</span></div>
<div style="text-align:right"><div class="sublabel">Risk-On: <span class="${cc(ra.risk_on_flow)}">${fmtM(ra.risk_on_flow)}</span></div><div class="sublabel">Risk-Off: <span class="${cc(ra.risk_off_flow)}">${fmtM(ra.risk_off_flow)}</span></div></div>
</div>
<div class="sublabel" style="margin-top:8px">Cycle: <span class="badge purple">${sr.phase||'‚Äî'}</span></div>
</div></div>
<div class="section-title"><span class="icon">‚ö°</span>Active Trading Signals (${sigs.length})</div>
<div class="grid2">
${sigs.slice(0,6).map(s=>`<div class="signal-card ${s.type.includes('BUY')?'buy':s.type.includes('SELL')||s.type.includes('WARNING')?'sell':'warn'}">
<div class="sig-type" style="color:${s.type.includes('BUY')?'#22c55e':s.type.includes('SELL')?'#ef4444':'#f59e0b'}">${s.type} ‚Äî ${s.source}</div>
<div class="sig-msg">${s.message}</div>
<div class="sig-conf">Confidence: ${s.confidence}% | Strength: ${s.strength}</div>
</div>`).join('')}
</div>
<div class="section-title"><span class="icon">üìä</span>Top ETF Fund Flows (Real Data ‚Äî ETF Global)</div>
<div class="card"><table><thead><tr><th>ETF</th><th>Name</th><th>Price</th><th>1D Change</th><th>1D Flow</th><th>5D Flow</th><th>20D Flow</th><th>Direction</th></tr></thead><tbody>
${(ff.etf_flows||[]).slice(0,12).map(e=>`<tr><td style="font-weight:600">${e.ticker}</td><td style="color:var(--dim)">${e.name}</td><td>$${fmt(e.price,2)}</td><td class="${cc(e.change_1d)}">${e.change_1d>0?'+':''}${fmt(e.change_1d,2)}%</td>
<td class="${cc(e.flow_1d)}">${fmtM(e.flow_1d)}</td><td class="${cc(e.flow_5d)}" style="font-weight:600">${fmtM(e.flow_5d)}</td><td class="${cc(e.flow_20d)}">${fmtM(e.flow_20d)}</td>
<td><span class="badge ${bc(e.flow_direction)}">${e.flow_direction}</span></td></tr>`).join('')}
</tbody></table></div>`;
}

function renderVix(d){
const v=d.vix_complex?.vix||{},v3m=d.vix_complex?.vix3m||{},ts=d.vix_complex?.term_structure||{},sk=d.skew||{};
const hist=v.history_30d||[];const vals=hist.map(h=>h.value).reverse();
return`
<div class="grid3">
<div class="card" style="--accent:${v.regime_color||'#3b82f6'}"><h3>VIX Index</h3><div class="stat">${fmt(v.current,2)}</div>
<div class="sublabel"><span class="${cc(v.change)}">${v.change>0?'+':''}${fmt(v.change,2)} (${v.change>0?'+':''}${fmt(v.change_pct,1)}%)</span></div>
<span class="badge ${v.current>25?'red':v.current>20?'yellow':'green'}" style="margin-top:6px;display:inline-block">${v.regime||'‚Äî'}</span>
${sparkline(vals)}</div>
<div class="card" style="--accent:#a855f7"><h3>VIX3M</h3><div class="stat">${fmt(v3m.current,2)}</div><div class="sublabel">3-Month Volatility Expectation</div></div>
<div class="card" style="--accent:${ts.signal==='BULLISH'?'#22c55e':'#ef4444'}"><h3>Term Structure</h3><div class="stat">${fmt(ts.vix_vix3m_ratio,4)}</div><span class="badge ${ts.state==='CONTANGO'?'green':'red'}">${ts.state||'‚Äî'}</span>
<div class="sublabel" style="margin-top:4px">${ts.description||''}</div></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="card"><h3>VIX Statistics</h3><table>
<tr><td>SMA(10)</td><td style="font-weight:600">${fmt(v.sma_10,2)}</td></tr>
<tr><td>SMA(20)</td><td style="font-weight:600">${fmt(v.sma_20,2)}</td></tr>
<tr><td>SMA(50)</td><td style="font-weight:600">${fmt(v.sma_50,2)}</td></tr>
<tr><td>1Y Percentile</td><td style="font-weight:600">${fmt(v.percentile_1y,1)}%</td></tr>
<tr><td>Z-Score</td><td style="font-weight:600">${fmt(v.zscore,2)}</td></tr>
<tr><td>52W Range</td><td style="font-weight:600">${fmt(v.low_52w,1)} ‚Äî ${fmt(v.high_52w,1)}</td></tr>
</table></div>
<div class="card" style="--accent:#f97316"><h3>CBOE SKEW Index</h3>
${sk.current?`<div class="stat">${fmt(sk.current,1)}</div><span class="badge ${sk.signal==='EXTREME_TAIL_RISK'?'red':sk.signal==='ELEVATED_TAIL_RISK'?'orange':'blue'}">${sk.signal||'‚Äî'}</span>
<div class="sublabel" style="margin-top:6px">${sk.description||''}</div>
<table style="margin-top:10px"><tr><td>SMA(20)</td><td>${fmt(sk.sma_20,1)}</td></tr><tr><td>Percentile</td><td>${fmt(sk.percentile_1y,1)}%</td></tr><tr><td>52W Range</td><td>${fmt(sk.low_52w,0)}‚Äî${fmt(sk.high_52w,0)}</td></tr></table>`
:'<div class="sublabel">SKEW data unavailable</div>'}
</div></div>`;
}

function renderOptions(d){
const pc=d.put_call||{},flows=pc.options_flow||[];
return`
<div class="grid4">
<div class="card" style="--accent:${pc.pc_color||'#3b82f6'}"><h3>Total P/C Ratio</h3><div class="stat">${fmt(pc.total_put_call_ratio,3)}</div><span class="badge ${bc(pc.pc_signal==='COMPLACENCY'?'BULLISH':'NEUTRAL')}">${pc.pc_signal||'‚Äî'}</span></div>
<div class="card" style="--accent:#22c55e"><h3>Total Call Volume</h3><div class="stat pos">${fmtN(pc.total_call_volume)}</div><div class="sublabel">Premium: ${fmtM(pc.total_call_premium)}</div></div>
<div class="card" style="--accent:#ef4444"><h3>Total Put Volume</h3><div class="stat neg">${fmtN(pc.total_put_volume)}</div><div class="sublabel">Premium: ${fmtM(pc.total_put_premium)}</div></div>
<div class="card" style="--accent:#06b6d4"><h3>Net Premium</h3><div class="stat ${cc(pc.net_premium)}">${fmtM(pc.net_premium)}</div><div class="sublabel">${pc.net_premium>0?'Call':'Put'}-Dominant Market</div></div>
</div>
<div class="section-title"><span class="icon">üìã</span>Options Flow by Ticker (Real Contract Data)</div>
<div class="card"><table><thead><tr><th>Ticker</th><th>Price</th><th>Call Vol</th><th>Put Vol</th><th>P/C Ratio</th><th>Call Premium</th><th>Put Premium</th><th>Net Premium</th><th>Contracts</th><th>Sentiment</th></tr></thead><tbody>
${flows.map(f=>`<tr><td style="font-weight:700">${f.ticker}</td><td>$${fmt(f.stock_price,2)}</td>
<td class="pos">${fmtN(f.call_volume)}</td><td class="neg">${fmtN(f.put_volume)}</td>
<td style="font-weight:600">${fmt(f.pc_ratio,3)}</td>
<td class="pos">${fmtM(f.call_premium)}</td><td class="neg">${fmtM(f.put_premium)}</td>
<td class="${cc(f.net_premium)}" style="font-weight:600">${fmtM(f.net_premium)}</td>
<td>${f.contracts_analyzed}</td>
<td><span class="badge ${bc(f.sentiment)}">${f.sentiment}</span></td></tr>`).join('')}
</tbody></table></div>
<div class="sublabel" style="margin-top:8px;padding:8px">üìù ${pc.pc_description||''}</div>`;
}

function renderGamma(d){
const g=d.gamma_exposure||{},levels=g.strike_levels||[];
return`
<div class="grid3">
<div class="card" style="--accent:${g.color||'#22c55e'}"><h3>Net GEX</h3><div class="stat">${fmtN(g.total_gex)}</div><span class="badge ${g.regime==='POSITIVE_GAMMA'?'green':'red'}">${g.regime||'‚Äî'}</span></div>
<div class="card" style="--accent:#22c55e"><h3>Call Gamma</h3><div class="stat pos">${fmtN(g.call_gex)}</div></div>
<div class="card" style="--accent:#ef4444"><h3>Put Gamma</h3><div class="stat neg">${fmtN(g.put_gex)}</div></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="card"><h3>SPY Gamma by Strike (SPY @ $${fmt(g.spy_price,2)})</h3>
<div style="max-height:400px;overflow-y:auto"><table><thead><tr><th>Strike</th><th>GEX</th><th>Profile</th></tr></thead><tbody>
${levels.slice(0,20).map(l=>{const maxG=Math.max(...levels.map(x=>Math.abs(x.gex)));const w=Math.abs(l.gex)/maxG*100;
return`<tr style="${l.strike===g.max_gamma_strike?'background:rgba(59,130,246,.1)':''}"><td style="font-weight:600">$${l.strike}</td><td class="${cc(l.gex)}">${fmtN(l.gex)}</td>
<td><div class="pct-bar"><div class="pct-fill" style="width:${w}%;background:${l.gex>=0?'#22c55e':'#ef4444'}"></div></div></td></tr>`}).join('')}
</tbody></table></div></div>
<div class="card"><h3>Gamma Regime Analysis</h3>
<div style="padding:16px;background:var(--card2);border-radius:8px;margin-bottom:12px">
<div style="font-size:20px;font-weight:700;color:${g.color||'#fff'}">${g.regime||'‚Äî'}</div>
<div class="sublabel" style="margin-top:4px">${g.description||''}</div>
</div>
<table>
<tr><td>Max Gamma Strike</td><td style="font-weight:700">$${g.max_gamma_strike||'‚Äî'}</td></tr>
<tr><td>SPY Price</td><td>$${fmt(g.spy_price,2)}</td></tr>
<tr><td>Call GEX</td><td class="pos">${fmtN(g.call_gex)}</td></tr>
<tr><td>Put GEX</td><td class="neg">${fmtN(g.put_gex)}</td></tr>
</table>
<div class="sublabel" style="margin-top:12px">‚ÑπÔ∏è Positive gamma = dealers suppress vol (mean reversion). Negative gamma = dealers amplify moves (trend following).</div>
</div></div>`;
}

function renderFlows(d){
const ff=d.fund_flows||{},etfs=ff.etf_flows||[],ra=ff.risk_appetite||{},sr=ff.sector_rotation||{},rs=sr.rotation_signal||{},mf=ff.market_flow||{};
const cats=['US Large Cap','US Tech','US Small Cap','US Blue Chip','Sector','Fixed Income','Commodities','International','Volatility'];
return`
<div class="grid4">
<div class="card" style="--accent:#22c55e"><h3>5D Total Inflows</h3><div class="stat pos">${fmtM(mf.total_inflow_5d)}</div></div>
<div class="card" style="--accent:#ef4444"><h3>5D Total Outflows</h3><div class="stat neg">${fmtM(mf.total_outflow_5d)}</div></div>
<div class="card" style="--accent:#3b82f6"><h3>5D Net Flow</h3><div class="stat ${cc(mf.net_5d)}">${fmtM(mf.net_5d)}</div></div>
<div class="card" style="--accent:${ra.regime==='RISK_ON'?'#22c55e':'#ef4444'}"><h3>Risk Regime</h3><div class="stat">${ra.regime||'‚Äî'}</div></div>
</div>
<div class="grid2" style="margin-top:16px">
<div class="card" style="--accent:#a855f7"><h3>Sector Rotation</h3>
<div style="margin-bottom:12px"><span class="badge purple" style="font-size:14px;padding:6px 14px">${rs.phase||'‚Äî'}</span></div>
<div class="sublabel">${rs.description||''}</div>
${rs.scores?`<table style="margin-top:10px">${Object.entries(rs.scores).map(([k,v])=>`<tr><td>${k.replace(/_/g,' ')}</td><td class="${cc(v)}" style="font-weight:600">${v>0?'+':''}${v}M</td></tr>`).join('')}</table>`:''}
${sr.top_inflow?`<div style="margin-top:10px;padding:8px;background:rgba(34,197,94,.1);border-radius:6px"><span class="pos" style="font-weight:600">‚Üë ${sr.top_inflow} (${sr.top_inflow_name})</span>: ${fmtM(sr.top_inflow_flow)}</div>`:''}
${sr.top_outflow?`<div style="margin-top:4px;padding:8px;background:rgba(239,68,68,.1);border-radius:6px"><span class="neg" style="font-weight:600">‚Üì ${sr.top_outflow} (${sr.top_outflow_name})</span>: ${fmtM(sr.top_outflow_flow)}</div>`:''}
</div>
<div class="card" style="--accent:#06b6d4"><h3>Risk Appetite Flows (5-Day)</h3>
<table><tr><td>Risk-On Assets</td><td class="${cc(ra.risk_on_flow)}" style="font-weight:600">${fmtM(ra.risk_on_flow)}</td></tr>
<tr><td>Risk-Off Assets</td><td class="${cc(ra.risk_off_flow)}" style="font-weight:600">${fmtM(ra.risk_off_flow)}</td></tr>
<tr><td>Net Direction</td><td class="${cc(ra.net_flow)}" style="font-weight:700;font-size:16px">${fmtM(ra.net_flow)}</td></tr></table>
<div class="sublabel" style="margin-top:8px">Risk-On: SPY, QQQ, IWM, XLK, XLF, EEM<br>Risk-Off: TLT, GLD, XLP, XLU, VXX</div>
</div></div>
<div class="section-title"><span class="icon">üí∞</span>Complete ETF Fund Flows (Real Data ‚Äî Polygon ETF Global)</div>
${cats.map(cat=>{const items=etfs.filter(e=>e.category===cat);if(!items.length)return'';
return`<div class="card" style="margin-bottom:12px;--accent:#3b82f6"><h3>${cat}</h3><table><thead><tr><th>ETF</th><th>Name</th><th>Price</th><th>1D Chg</th><th>5D Chg</th><th>1D Flow</th><th>5D Flow</th><th>20D Flow</th><th>Rel Vol</th><th>Direction</th></tr></thead><tbody>
${items.map(e=>`<tr><td style="font-weight:700">${e.ticker}</td><td style="color:var(--dim);font-size:11px">${e.name}</td><td>$${fmt(e.price,2)}</td>
<td class="${cc(e.change_1d)}">${e.change_1d>0?'+':''}${fmt(e.change_1d,2)}%</td>
<td class="${cc(e.change_5d)}">${e.change_5d>0?'+':''}${fmt(e.change_5d,2)}%</td>
<td class="${cc(e.flow_1d)}">${fmtM(e.flow_1d)}</td>
<td class="${cc(e.flow_5d)}" style="font-weight:600">${fmtM(e.flow_5d)}</td>
<td class="${cc(e.flow_20d)}">${fmtM(e.flow_20d)}</td>
<td>${fmt(e.relative_volume,1)}x</td>
<td><span class="badge ${bc(e.flow_direction)}">${e.flow_direction}</span></td></tr>`).join('')}
</tbody></table></div>`}).join('')}`;
}

function renderSentiment(d){
const s=d.sentiment||{},comp=s.composite||{};
const components=[
{key:'vix_sentiment',name:'VIX Fear/Greed',icon:'üò∞'},
{key:'credit_sentiment',name:'Credit Conditions',icon:'üè¶'},
{key:'curve_sentiment',name:'Yield Curve',icon:'üìà'},
{key:'hy_sentiment',name:'High Yield',icon:'üíé'},
{key:'breadth_sentiment',name:'Market Breadth',icon:'üìä'},
{key:'momentum_sentiment',name:'Momentum (RSI)',icon:'üîÑ'},
{key:'news_sentiment',name:'News Sentiment',icon:'üì∞'}
];
return`
<div class="card" style="text-align:center;padding:24px;margin-bottom:16px;--accent:${comp.color||'#f59e0b'}">
<h3 style="margin-bottom:16px">JustHodl Sentiment Composite</h3>
<div class="stat" style="font-size:48px;color:${comp.color||'#fff'}">${fmt(comp.score,0)}</div>
<span class="badge ${comp.score<30?'red':comp.score>70?'green':'yellow'}" style="font-size:16px;padding:6px 20px;margin-top:8px;display:inline-block">${comp.label||'‚Äî'}</span>
<div class="sublabel" style="margin-top:8px">${comp.components||0} components weighted</div>
</div>
<div class="grid2">
${components.map(c=>{const data=s[c.key];if(!data)return'';
return`<div class="card" style="--accent:${data.score>65?'#22c55e':data.score<35?'#ef4444':'#f59e0b'}">
<h3>${c.icon} ${c.name}</h3>
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="stat" style="font-size:24px;color:${data.score>65?'#22c55e':data.score<35?'#ef4444':'#f59e0b'}">${fmt(data.score,0)}</div>
<span class="badge ${data.score>65?'green':data.score<35?'red':'yellow'}">${data.label||'‚Äî'}</span>
</div>
<div class="pct-bar" style="margin-top:8px;height:8px"><div class="pct-fill" style="width:${data.score}%;background:${data.score>65?'#22c55e':data.score<35?'#ef4444':'#f59e0b'}"></div></div>
${data.vix?`<div class="sublabel" style="margin-top:4px">VIX: ${data.vix}</div>`:''}
${data.ted_spread?`<div class="sublabel" style="margin-top:4px">TED: ${data.ted_spread}%</div>`:''}
${data.spread!=null?`<div class="sublabel" style="margin-top:4px">Spread: ${data.spread}${data.spread<1?'%':''}</div>`:''}
${data.rsi?`<div class="sublabel" style="margin-top:4px">RSI(14): ${fmt(data.rsi,1)}</div>`:''}
</div>`}).join('')}
</div>`;
}

function renderUnusual(d){
const u=d.unusual_activity||[];
return`<div class="section-title"><span class="icon">üîç</span>Unusual Volume Activity (>1.5x avg)</div>
${u.length?`<div class="card"><table><thead><tr><th>Ticker</th><th>Price</th><th>Change</th><th>Volume</th><th>Avg Volume</th><th>Relative Vol</th><th>Signal</th></tr></thead><tbody>
${u.map(a=>`<tr><td style="font-weight:700">${a.ticker}</td><td>$${fmt(a.price,2)}</td>
<td class="${cc(a.change_pct)}">${a.change_pct>0?'+':''}${fmt(a.change_pct,2)}%</td>
<td style="font-weight:600">${fmtN(a.volume)}</td><td>${fmtN(a.avg_volume)}</td>
<td style="font-weight:700;color:${a.relative_volume>2?'#ef4444':'#f59e0b'}">${fmt(a.relative_volume,1)}x</td>
<td><span class="badge ${a.signal.includes('BULLISH')?'green':a.signal.includes('BEARISH')?'red':'yellow'}">${a.signal}</span></td></tr>`).join('')}
</tbody></table></div>`:'<div class="card"><div class="sublabel" style="padding:20px;text-align:center">No unusual volume detected today (all stocks within 1.5x average)</div></div>'}`;
}

function renderSignals(d){
const sigs=d.trading_signals||[];
return`<div class="section-title"><span class="icon">‚ö°</span>AI Trading Signals (${sigs.length} active)</div>
${sigs.length?sigs.map(s=>`<div class="signal-card ${s.type.includes('BUY')?'buy':s.type.includes('SELL')||s.type.includes('WARNING')?'sell':'warn'}">
<div style="display:flex;justify-content:space-between;align-items:center">
<div class="sig-type" style="color:${s.type.includes('BUY')?'#22c55e':s.type.includes('SELL')?'#ef4444':'#f59e0b'}">${s.type}</div>
<span class="badge ${s.strength==='STRONG'?'red':'yellow'}">${s.strength}</span>
</div>
<div style="font-size:12px;font-weight:600;margin-top:6px;color:var(--cyan)">${s.source}</div>
<div class="sig-msg">${s.message}</div>
<div style="margin-top:6px"><div class="pct-bar" style="height:6px"><div class="pct-fill" style="width:${s.confidence}%;background:${s.confidence>70?'#22c55e':s.confidence>50?'#f59e0b':'#64748b'}"></div></div>
<div class="sublabel">Confidence: ${s.confidence}%</div></div>
</div>`).join(''):'<div class="card"><div class="sublabel" style="padding:20px;text-align:center">No active signals</div></div>'}`;
}

function renderNews(d){
const n=d.sentiment?.news_sentiment||{};const articles=n.top_articles||[];
return`
<div class="grid3">
<div class="card" style="--accent:${n.score>65?'#22c55e':n.score<35?'#ef4444':'#f59e0b'}"><h3>News Sentiment</h3><div class="stat" style="color:${n.score>65?'#22c55e':n.score<35?'#ef4444':'#f59e0b'}">${fmt(n.score,0)}</div><span class="badge ${n.score>65?'green':n.score<35?'red':'yellow'}">${n.label||'‚Äî'}</span></div>
<div class="card" style="--accent:#22c55e"><h3>Bullish Articles</h3><div class="stat pos">${n.bullish_count||0}</div><div class="sublabel">of ${n.article_count||0} analyzed</div></div>
<div class="card" style="--accent:#ef4444"><h3>Bearish Articles</h3><div class="stat neg">${n.bearish_count||0}</div><div class="sublabel">Neutral: ${n.neutral_count||0}</div></div>
</div>
<div class="section-title"><span class="icon">üì∞</span>Latest Market News</div>
<div class="card"><table><thead><tr><th>Source</th><th>Title</th><th>Sentiment</th><th>Score</th></tr></thead><tbody>
${articles.map(a=>{const sc=a.sentiment_score;return`<tr><td style="font-size:11px;color:var(--dim);white-space:nowrap">${a.source}</td>
<td><a href="${a.url}" target="_blank" style="font-size:12px">${a.title?.substring(0,80)||'‚Äî'}</a></td>
<td><span class="badge ${sc>0.1?'green':sc<-0.1?'red':'yellow'}">${a.sentiment_label||'‚Äî'}</span></td>
<td style="font-weight:600" class="${cc(sc)}">${fmt(sc,3)}</td></tr>`}).join('')}
</tbody></table></div>`;
}

function renderInternals(d){
const m=d.market_internals||{};
const rows=[
['Fed Funds Rate','fed_funds_rate','%'],['10Y Treasury','treasury_10y','%'],['2Y Treasury','treasury_2y','%'],
['TED Spread','ted_spread','%'],['HY Spread','hy_spread','%'],['IG Spread','ig_spread','%'],
['10Y-2Y Curve','yield_curve_10y2y','%'],['10Y-3M Curve','yield_curve_10y3m','%'],
['5Y Breakeven','breakeven_5y','%'],['10Y Breakeven','breakeven_10y','%']
];
return`<div class="section-title"><span class="icon">üèõÔ∏è</span>Market Internals (FRED Real-Time)</div>
<div class="card"><table><thead><tr><th>Metric</th><th>Value</th><th>Date</th></tr></thead><tbody>
${rows.map(([name,key,unit])=>{const v=m[key];if(!v)return'';
return`<tr><td style="font-weight:500">${name}</td><td style="font-weight:700">${fmt(v.value,3)}${unit}</td><td style="color:var(--dim)">${v.date}</td></tr>`}).join('')}
</tbody></table></div>`;
}

const renderers={overview:renderOverview,vix:renderVix,options:renderOptions,gamma:renderGamma,flows:renderFlows,sentiment:renderSentiment,unusual:renderUnusual,signals:renderSignals,news:renderNews,internals:renderInternals};

function render(){if(!DATA)return;const d=DATA.data||{};const fn=renderers[activeTab];if(fn)$('#mainContent').innerHTML=fn(d)}

document.querySelectorAll('.tab').forEach(t=>{t.addEventListener('click',()=>{$$('.tab').forEach(x=>x.classList.remove('active'));t.classList.add('active');activeTab=t.dataset.tab;render()})});

async function loadData(){
try{const r=await fetch(LAMBDA,{signal:AbortSignal.timeout(300000)});DATA=await r.json();
$('#lastUpdate').textContent=new Date().toLocaleTimeString()+' (Live)';render()}
catch(e){try{const r=await fetch(S3);DATA=await r.json();$('#lastUpdate').textContent='Cached (S3)';render()}
catch(e2){$('#mainContent').innerHTML='<div class="loading" style="color:#ef4444">Failed to load data</div>'}}}

loadData();
const now=new Date();const h=now.getUTCHours(),day=now.getUTCDay();
if(day>0&&day<6&&h>=13&&h<=21){setInterval(loadData,300000)}else{setInterval(loadData,900000)}
</script>
</body>
</html>
