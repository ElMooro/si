<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Financial Intelligence Platform - 72,846+ Indicators</title>
    
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow-x: hidden;
        }
        
        /* Navigation Bar */
        nav {
            background: #121212;
            border-bottom: 1px solid #282828;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-links {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .nav-links a {
            color: #ccc;
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
            position: relative;
        }

        .nav-links a:hover {
            color: #00ff88;
        }

        .nav-links a.active {
            color: #00ff88;
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            right: 0;
            height: 2px;
            background: #00ff88;
        }

        /* Header */
        .header {
            background: #1a1a1a;
            padding: 15px 20px;
            border-bottom: 1px solid #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 999;
        }
        .logo {
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* Main Container */
        .main-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px);
        }
        
        /* Search Section */
        .search-section {
            background: #121212;
            padding: 20px;
            border-bottom: 1px solid #282828;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 15px;
        }
        .search-container {
            position: relative;
            width: 100%;
            max-width: 800px;
        }
        .search-box {
            width: 100%;
            padding: 15px 50px 15px 20px;
            background: #222;
            border: 2px solid #333;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .search-box:focus {
            outline: none;
            border-color: #00ff88;
        }
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            font-size: 18px;
        }
        
        /* Search Status Indicator */
        .search-status {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 5px;
        }
        .search-status.active {
            color: #00ff88;
        }
        
        /* Data Source Filter */
        .data-source-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .source-toggle {
            background: #252525;
            border: 1px solid #383838;
            color: #ccc;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .source-toggle:hover {
            background: #333;
            border-color: #555;
        }
        .source-toggle.active {
            background: #00dd77;
            color: #000;
            border-color: #00dd77;
        }
        .source-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }
        .source-indicator.connected {
            background: #00dd77;
        }
        
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            margin-top: 5px;
            max-height: 500px;
            overflow-y: auto;
            background: #181818;
            border: 1px solid #333;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .search-loading {
            padding: 20px;
            text-align: center;
            color: #00ff88;
        }
        .search-item {
            padding: 15px 20px;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .search-item:last-child { border-bottom: none; }
        .search-item:hover { background: #252525; }
        .search-item-left {
            flex: 1;
        }
        .search-item-symbol {
            font-weight: bold;
            color: #00dd77;
            font-size: 16px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
        }
        .search-item-name {
            font-size: 14px;
            color: #ddd;
            margin-bottom: 4px;
        }
        .search-item-description {
            font-size: 12px;
            color: #aaa;
            line-height: 1.3;
        }
        .search-item-source {
            font-size: 11px;
            color: #888;
            background: #2a2a2a;
            padding: 4px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }
        
        /* Charts and Watchlist Container */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Charts Area */
        .charts-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #0f0f0f;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
        }
        .chart-window {
            background: #131313;
            border: 1px solid #282828;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: border-color 0.3s;
            min-height: 500px;
        }
        .chart-window.active-chart {
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.3);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .chart-title-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }
        .chart-title {
            font-size: 18px;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chart-symbols {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .chart-symbol-tag {
            background: #252525;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid #333;
        }
        .symbol-color-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .remove-symbol {
            cursor: pointer;
            color: #ff5555;
            font-weight: bold;
            margin-left: 5px;
            opacity: 0.7;
            font-size: 14px;
        }
        .remove-symbol:hover { opacity: 1; }

        .chart-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .timeframe-buttons {
            display: flex;
            gap: 2px;
            background: #080808;
            padding: 3px;
            border-radius: 6px;
            border: 1px solid #252525;
        }
        .timeframe-btn {
            background: transparent;
            border: none;
            color: #888;
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
            border-radius: 4px;
        }
        .timeframe-btn:hover {
            background: #2e2e2e;
            color: #fff;
        }
        .timeframe-btn.active {
            background: #00dd77;
            color: #000;
            font-weight: bold;
        }
        
        .chart-canvas {
            background: #0a0a0a;
            border-radius: 6px;
            height: 500px;
            flex-grow: 1;
            min-height: 450px;
        }
        .chart-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #555;
            font-size: 16px;
            text-align: center;
            padding: 20px;
        }
        
        .control-btn {
            background: #252525;
            border: 1px solid #383838;
            color: #ccc;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 12px;
            transition: all 0.2s;
        }
        .control-btn:hover {
            background: #333;
            border-color: #555;
            color: #fff;
        }
        .close-btn {
            background: #dd4444;
            border-color: #dd4444;
            color: #fff;
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }
        .close-btn:hover { background: #ff5555; }
        
        /* Watchlist Section */
        .watchlist-section {
            background: #121212;
            border-top: 1px solid #282828;
            height: 300px;
            overflow-y: auto;
        }
        
        .watchlist-header {
            background: #1a1a1a;
            padding: 15px 20px;
            border-bottom: 1px solid #282828;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .watchlist-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .watchlist-selector {
            background: #252525;
            color: #fff;
            border: 1px solid #333;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .watchlist-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .sort-button {
            background: #252525;
            color: #fff;
            border: 1px solid #333;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .sort-button:hover {
            background: #333;
            border-color: #555;
        }
        
        .sort-button.active {
            background: #00dd77;
            color: #000;
            border-color: #00dd77;
        }
        
        .add-watchlist {
            background: #00dd77;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .add-watchlist:hover { background: #00ff88; }
        
        /* Table Styles */
        .watchlist-table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
        }
        
        .watchlist-table th {
            background: #f5f5f5;
            color: #333;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            padding: 12px 15px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            position: sticky;
            top: 57px;
            z-index: 5;
        }
        
        .watchlist-table tbody tr {
            transition: background-color 0.2s;
            cursor: pointer;
            background: #fff;
            color: #333;
        }
        
        .watchlist-table tbody tr:hover {
            background: #f8f8f8;
        }
        
        .watchlist-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
            color: #333;
        }
        
        .symbol-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .symbol-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 10px;
        }
        
        .symbol-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .symbol-name {
            font-weight: bold;
            color: #000;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .symbol-fullname {
            color: #666;
            font-size: 11px;
        }
        
        .price-cell {
            font-weight: bold;
            color: #000;
            text-align: right;
        }
        
        .change-cell {
            text-align: right;
            font-weight: bold;
        }
        
        .positive { color: #00dd77; }
        .negative { color: #ff4444; }
        .neutral { color: #666; }
        
        /* Loading */
        .loading-pulse { animation: pulse 1.5s infinite ease-in-out; }
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f0f0f; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        /* Message Popup */
        .message-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #222;
            border: 1px solid #333;
            padding: 15px 20px;
            border-radius: 6px;
            z-index: 2000;
            animation: slideInAndOut 3s ease-in-out forwards;
        }
        .message-popup.info { border-color: #00dd77; }
        .message-popup.error { border-color: #ff4444; color: #ff6666; }
        
        @keyframes slideInAndOut {
            0% { transform: translateX(120%); opacity: 0; }
            15%, 85% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(120%); opacity: 0; }
        }
        
        .api-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ff4444;
        }
        
        .status-dot.connected {
            background: #00dd77;
        }
        
        /* Info Panel */
        .info-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #333;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #00ff88;
            max-width: 400px;
            font-size: 13px;
            z-index: 9999;
        }
        
        .info-panel h3 {
            margin-bottom: 10px;
            color: #00ff88;
        }
        
        .info-panel button {
            background: #00ff88;
            color: #000;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .info-panel button:hover {
            background: #00dd77;
        }
    </style>
</head>
<body>
    <nav>
        <div class="nav-logo">📊 OPENBB</div>
        <div class="nav-links">
            <a href="#" class="active">Platform</a>
            <a href="#" onclick="showAPIInfo()">Lambda Search (6,204)</a>
            <a href="#" onclick="showEnhancedInfo()">Enhanced API (60,000+)</a>
            <a href="#" onclick="showDocumentation()">Documentation</a>
        </div>
    </nav>

    <div class="header">
        <div class="logo">📊 OPENBB FINANCIAL INTELLIGENCE - 72,846+ INDICATORS</div>
        <div class="header-controls">
            <div class="api-status">
                <div class="status-dot" id="apiStatus"></div>
                <span id="apiStatusText">Checking connections...</span>
            </div>
            <button class="control-btn" onclick="addNewChart()">+ New Chart</button>
            <span id="clock" style="color: #888; font-size: 14px;"></span>
        </div>
    </div>

    <div class="main-container">
        <div class="search-section">
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox"
                       placeholder="Search 72,846+ financial instruments (Try: Treasury, GDP, AAPL, SOFR, ECB Stress, University Michigan)..."
                       onkeyup="performSearch(this.value)"
                       autocomplete="off">
                <span class="search-icon">🔍</span>
                <div class="search-results" id="searchResults" style="display: none;"></div>
            </div>
            <div class="search-status" id="searchStatus">Lambda Search: Ready | Enhanced API: Ready</div>
            
            <div class="data-source-filter">
                <button class="source-toggle active" data-source="lambda" onclick="toggleDataSource('lambda')">
                    <span class="source-indicator" id="lambda-indicator"></span>
                    Lambda Platform (6,204)
                </button>
                <button class="source-toggle active" data-source="enhanced" onclick="toggleDataSource('enhanced')">
                    <span class="source-indicator" id="enhanced-indicator"></span>
                    Enhanced API (60,000+)
                </button>
            </div>
        </div>

        <div class="content">
            <div class="charts-area" style="display: none;" id="chartsArea">
                <div class="chart-grid" id="chartGrid"></div>
            </div>
            
            <div class="watchlist-section" style="flex: 1;">
                <div class="watchlist-header">
                    <div class="watchlist-title">
                        <select class="watchlist-selector" id="watchlistSelector" onchange="switchWatchlist(this.value)">
                            <option value="MAIN">MAIN</option>
                            <option value="STOCKS">STOCKS</option>
                            <option value="ECONOMIC">ECONOMIC INDICATORS</option>
                        </select>
                    </div>
                    <div class="watchlist-controls">
                        <button class="sort-button active" id="sortDefault" onclick="changeSortOrder('default')">Default</button>
                        <button class="sort-button" id="sortIncrease" onclick="changeSortOrder('increase')">↑ Increase</button>
                        <button class="sort-button" id="sortDecrease" onclick="changeSortOrder('decrease')">↓ Decrease</button>
                        <button class="control-btn" onclick="showChartView()" id="chartViewBtn" style="display: none;">📊 Chart View</button>
                        <button class="add-watchlist" onclick="document.getElementById('searchBox').focus()">+ Add Symbol</button>
                    </div>
                </div>
                <table class="watchlist-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th class="text-right">Price / Value</th>
                            <th class="text-right">Daily Change</th>
                            <th class="text-right">1D %</th>
                            <th class="text-right">1W %</th>
                            <th class="text-right">1M %</th>
                            <th class="text-right">1Y %</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="watchlistBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const LAMBDA_API = 'https://i3y8tfdp1k.execute-api.us-east-1.amazonaws.com/prod';
        const ENHANCED_API_IP = '52.72.62.43';
        const ENHANCED_API = `http://${ENHANCED_API_IP}:8000/api/v1`;
        
        // Global state
        let lambdaWorking = false;
        let enhancedWorking = false;
        let activeSources = ['lambda', 'enhanced'];
        let searchTimeout = null;
        
        // Charts
        const charts = {};
        let chartIdCounter = 0;
        let activeChartId = null;
        
        // Watchlists
        const watchlists = {
            'MAIN': {
                symbols: [
                    { symbol: 'AAPL', provider: 'enhanced' },
                    { symbol: 'SPY', provider: 'enhanced' },
                    { symbol: 'DGS10', provider: 'enhanced' },
                    { symbol: 'SOFR', provider: 'enhanced' }
                ]
            },
            'STOCKS': {
                symbols: [
                    { symbol: 'AAPL', provider: 'enhanced' },
                    { symbol: 'MSFT', provider: 'enhanced' },
                    { symbol: 'GOOGL', provider: 'enhanced' },
                    { symbol: 'AMZN', provider: 'enhanced' }
                ]
            },
            'ECONOMIC': {
                symbols: [
                    { symbol: 'GDP', provider: 'enhanced' },
                    { symbol: 'UNRATE', provider: 'enhanced' },
                    { symbol: 'CPIAUCSL', provider: 'enhanced' },
                    { symbol: 'DGS10', provider: 'enhanced' }
                ]
            }
        };
        
        let currentWatchlist = 'MAIN';
        let watchlistSymbols = [];
        let watchlistData = {};
        let sortOrder = 'default';
        
        // Initialize
        async function init() {
            updateClock();
            setInterval(updateClock, 1000);
            
            loadWatchlists();
            await checkAPIConnections();
            showInfoPanel();
            loadWatchlistData();
            
            // Refresh data every 60 seconds
            setInterval(loadWatchlistData, 60000);
        }
        
        // Show info panel
        function showInfoPanel() {
            const infoPanel = document.createElement('div');
            infoPanel.className = 'info-panel';
            infoPanel.innerHTML = `
                <h3>🚀 OpenBB Financial Platform Ready!</h3>
                <p><strong>✅ 72,846+ indicators available</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li id="lambda-status">⏳ Lambda Platform: Checking...</li>
                    <li id="enhanced-status">⏳ Enhanced API: Checking...</li>
                </ul>
                <button onclick="this.parentElement.remove()">Got it!</button>
            `;
            document.body.appendChild(infoPanel);
        }

        // Check API connections
        async function checkAPIConnections() {
            // Test Lambda Platform
            try {
                const response = await fetch(`${LAMBDA_API}/api/search/stats`);
                if (response.ok) {
                    const data = await response.json();
                    lambdaWorking = true;
                    document.getElementById('lambda-indicator').classList.add('connected');
                    const status = document.getElementById('lambda-status');
                    if (status) status.innerHTML = `✅ Lambda Platform: ${data.document_count} indicators`;
                }
            } catch (error) {
                console.error('Lambda check failed:', error);
            }
            
            // Test Enhanced API
            try {
                const response = await fetch(`${ENHANCED_API}/economy/survey/university_of_michigan?provider=fred`);
                if (response.ok) {
                    enhancedWorking = true;
                    document.getElementById('enhanced-indicator').classList.add('connected');
                    const status = document.getElementById('enhanced-status');
                    if (status) status.innerHTML = `✅ Enhanced API: 60,000+ indicators`;
                }
            } catch (error) {
                console.error('Enhanced API check failed:', error);
            }
            
            // Update status
            document.getElementById('apiStatus').classList.add('connected');
            document.getElementById('apiStatusText').textContent = `Connected: ${(lambdaWorking ? 1 : 0) + (enhancedWorking ? 1 : 0)} APIs`;
            updateSearchStatus();
        }
        
        // Update search status
        function updateSearchStatus() {
            const statusEl = document.getElementById('searchStatus');
            statusEl.textContent = `Lambda: ${lambdaWorking ? 'Ready' : 'Offline'} | Enhanced: ${enhancedWorking ? 'Ready' : 'Offline'}`;
            statusEl.className = (lambdaWorking || enhancedWorking) ? 'search-status active' : 'search-status';
        }
        
        // Search functionality
        async function performSearch(query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query || query.trim().length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                resultsDiv.innerHTML = '<div class="search-loading">Searching...</div>';
                resultsDiv.style.display = 'block';
                
                const results = [];
                
                // Search Lambda
                if (lambdaWorking && activeSources.includes('lambda')) {
                    try {
                        const response = await fetch(`${LAMBDA_API}/api/search?query=${encodeURIComponent(query)}&limit=20`);
                        if (response.ok) {
                            const data = await response.json();
                            if (data.results) {
                                data.results.forEach(r => {
                                    const source = r._source || r;
                                    results.push({
                                        symbol: source.symbol || source.series_id,
                                        name: source.name || source.title || source.symbol,
                                        provider: 'lambda',
                                        source: 'lambda'
                                    });
                                });
                            }
                        }
                    } catch (error) {
                        console.error('Lambda search error:', error);
                    }
                }
                
                // Add Enhanced API special endpoints
                if (enhancedWorking && activeSources.includes('enhanced')) {
                    const specialEndpoints = [
                        { symbol: 'UofM', name: 'University of Michigan Survey' },
                        { symbol: 'GDP_NOMINAL', name: 'US GDP Nominal' }
                    ];
                    
                    specialEndpoints.forEach(endpoint => {
                        if (endpoint.name.toLowerCase().includes(query.toLowerCase())) {
                            results.push({
                                symbol: endpoint.symbol,
                                name: endpoint.name,
                                provider: 'enhanced',
                                source: 'enhanced'
                            });
                        }
                    });
                }
                
                displaySearchResults(results, query);
            }, 300);
        }
        
        // Display search results
        function displaySearchResults(results, query) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!results || results.length === 0) {
                resultsDiv.innerHTML = '<div class="search-item" style="text-align:center; color:#888;">No results found</div>';
                return;
            }
            
            let html = '';
            results.forEach(result => {
                html += `
                    <div class="search-item" onclick="addToWatchlist('${result.symbol}', '${result.provider}', '${result.name}')">
                        <div class="search-item-left">
                            <div class="search-item-symbol">${result.symbol}</div>
                            <div class="search-item-name">${result.name}</div>
                        </div>
                        <div class="search-item-source">${result.source}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Add to watchlist
        function addToWatchlist(symbol, provider, name) {
            const currentSymbols = watchlists[currentWatchlist].symbols;
            
            if (!currentSymbols.find(s => s.symbol === symbol)) {
                currentSymbols.push({ symbol, provider });
                watchlistSymbols = [...currentSymbols];
                saveWatchlists();
                loadSingleWatchlistItem(symbol, provider);
                showMessage(`Added ${symbol} to ${currentWatchlist}`, 'info');
            }
            
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('searchBox').value = '';
        }
        
        // Load watchlist data
        async function loadWatchlistData() {
            watchlistSymbols = [...watchlists[currentWatchlist].symbols];
            
            for (const item of watchlistSymbols) {
                await loadSingleWatchlistItem(item.symbol, item.provider);
            }
            
            renderWatchlist();
        }
        
        // Load single item
        async function loadSingleWatchlistItem(symbol, provider) {
            try {
                let url;
                
                if (provider === 'enhanced' && enhancedWorking) {
                    if (symbol === 'UofM') {
                        url = `${ENHANCED_API}/economy/survey/university_of_michigan?provider=fred`;
                    } else if (['AAPL', 'MSFT', 'GOOGL', 'AMZN'].includes(symbol)) {
                        url = `${ENHANCED_API}/equity/quote?symbol=${symbol}&provider=yfinance`;
                    } else {
                        url = `${ENHANCED_API}/economy/fred/series?symbol=${symbol}&provider=fred&limit=100`;
                    }
                } else if (provider === 'lambda' && lambdaWorking) {
                    url = `${LAMBDA_API}/api/search?query=${symbol}&limit=1`;
                }
                
                if (!url) return;
                
                const response = await fetch(url);
                if (!response.ok) return;
                
                const data = await response.json();
                processDataResponse(symbol, data, provider);
                
            } catch (error) {
                console.error(`Error loading ${symbol}:`, error);
                // Use demo data
                watchlistData[symbol] = generateDemoData(symbol);
            }
        }
        
        // Process data response
        function processDataResponse(symbol, data, provider) {
            if (provider === 'enhanced') {
                if (data.results && Array.isArray(data.results)) {
                    const latest = data.results[data.results.length - 1];
                    watchlistData[symbol] = {
                        name: symbol,
                        provider: provider,
                        price: latest.value || latest.inflation_expectation || 0,
                        changes: calculateChanges(data.results),
                        hasData: true
                    };
                } else if (data.price !== undefined) {
                    watchlistData[symbol] = {
                        name: data.name || symbol,
                        provider: provider,
                        price: data.price,
                        changes: { '1d': 0, '1w': 0, '1m': 0, '1y': 0 },
                        hasData: true
                    };
                }
            } else if (provider === 'lambda' && data.results && data.results.length > 0) {
                const source = data.results[0]._source || data.results[0];
                watchlistData[symbol] = {
                    name: source.name || source.title || symbol,
                    provider: provider,
                    price: source.value || source.latest_value || 0,
                    changes: { '1d': 0, '1w': 0, '1m': 0, '1y': 0 },
                    hasData: true
                };
            }
            
            renderWatchlist();
        }
        
        // Calculate changes
        function calculateChanges(data) {
            if (!data || data.length < 2) {
                return { '1d': 0, '1w': 0, '1m': 0, '1y': 0 };
            }
            
            const latest = data[data.length - 1];
            const latestValue = latest.value || latest.inflation_expectation || 0;
            
            // Simple calculation - would need proper date filtering in production
            const changes = { '1d': 0, '1w': 0, '1m': 0, '1y': 0 };
            
            if (data.length > 1) {
                const previous = data[data.length - 2];
                const previousValue = previous.value || previous.inflation_expectation || 0;
                if (previousValue !== 0) {
                    changes['1d'] = ((latestValue - previousValue) / previousValue) * 100;
                }
            }
            
            return changes;
        }
        
        // Generate demo data
        function generateDemoData(symbol) {
            const baseData = {
                'AAPL': { name: 'Apple Inc.', price: 195.89 },
                'SPY': { name: 'SPDR S&P 500', price: 452.16 },
                'DGS10': { name: '10-Year Treasury', price: 4.426 },
                'SOFR': { name: 'SOFR Rate', price: 5.31 }
            };
            
            const data = baseData[symbol] || { name: symbol, price: 100 };
            
            return {
                ...data,
                provider: 'demo',
                changes: {
                    '1d': (Math.random() - 0.5) * 5,
                    '1w': (Math.random() - 0.5) * 10,
                    '1m': (Math.random() - 0.5) * 15,
                    '1y': (Math.random() - 0.5) * 30
                },
                hasData: true
            };
        }
        
        // Render watchlist
        function renderWatchlist() {
            const tbody = document.getElementById('watchlistBody');
            
            let symbolsToRender = watchlistSymbols.map(item => {
                const data = watchlistData[item.symbol];
                if (!data) return null;
                
                return {
                    symbol: item.symbol,
                    data: data,
                    maxChange: Math.max(...Object.values(data.changes).map(Math.abs))
                };
            }).filter(item => item !== null);
            
            // Sort
            if (sortOrder === 'increase') {
                symbolsToRender.sort((a, b) => b.data.changes['1d'] - a.data.changes['1d']);
            } else if (sortOrder === 'decrease') {
                symbolsToRender.sort((a, b) => a.data.changes['1d'] - b.data.changes['1d']);
            }
            
            const formatPrice = (price) => {
                if (price >= 1000) return price.toFixed(0);
                if (price >= 1) return price.toFixed(2);
                return price.toFixed(4);
            };
            
            const formatChange = (change) => {
                const val = parseFloat(change);
                return (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
            };
            
            const getChangeClass = (change) => {
                return parseFloat(change) >= 0 ? 'positive' : 'negative';
            };
            
            const html = symbolsToRender.map(({ symbol, data }) => `
                <tr ondblclick="openChartForSymbol('${symbol}', '${data.provider}')">
                    <td>
                        <div class="symbol-cell">
                            <div class="symbol-icon">${symbol.charAt(0)}</div>
                            <div class="symbol-info">
                                <div class="symbol-name">${symbol}</div>
                                <div class="symbol-fullname">${data.name}</div>
                            </div>
                        </div>
                    </td>
                    <td class="price-cell">${formatPrice(data.price)}</td>
                    <td class="change-cell ${getChangeClass(data.changes['1d'])}">${formatChange(data.changes['1d'])}</td>
                    <td class="change-cell ${getChangeClass(data.changes['1d'])}">${formatChange(data.changes['1d'])}</td>
                    <td class="change-cell ${getChangeClass(data.changes['1w'])}">${formatChange(data.changes['1w'])}</td>
                    <td class="change-cell ${getChangeClass(data.changes['1m'])}">${formatChange(data.changes['1m'])}</td>
                    <td class="change-cell ${getChangeClass(data.changes['1y'])}">${formatChange(data.changes['1y'])}</td>
                    <td>
                        <button class="control-btn" style="padding: 4px 8px; font-size: 11px;"
                                onclick="removeFromWatchlist(event, '${symbol}')">×</button>
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 20px;">No data</td></tr>';
        }
        
        // Chart functions
        function addNewChart() {
            const chartId = `chart_${chartIdCounter++}`;
            
            const chartHtml = `
                <div class="chart-window" id="${chartId}">
                    <div class="chart-header">
                        <div class="chart-title-section">
                            <div class="chart-title">Chart ${chartIdCounter}</div>
                            <div class="chart-symbols" id="${chartId}_symbols"></div>
                        </div>
                        <div class="chart-controls">
                            <button class="close-btn" onclick="removeChart('${chartId}')">×</button>
                        </div>
                    </div>
                    <div class="chart-canvas" id="${chartId}_canvas">
                        <div class="chart-message">Add symbols to chart</div>
                    </div>
                </div>`;
            
            document.getElementById('chartGrid').insertAdjacentHTML('beforeend', chartHtml);
            charts[chartId] = { symbols: [], data: {} };
            
            document.getElementById('chartsArea').style.display = 'block';
            document.getElementById('chartViewBtn').style.display = 'block';
        }
        
        function removeChart(chartId) {
            delete charts[chartId];
            document.getElementById(chartId).remove();
            
            if (Object.keys(charts).length === 0) {
                document.getElementById('chartsArea').style.display = 'none';
                document.getElementById('chartViewBtn').style.display = 'none';
            }
        }
        
        function openChartForSymbol(symbol, provider) {
            if (Object.keys(charts).length === 0) {
                addNewChart();
            }
            
            const chartId = Object.keys(charts)[0];
            const chart = charts[chartId];
            
            if (!chart.symbols.find(s => s.symbol === symbol)) {
                chart.symbols.push({ symbol, provider });
                loadChartData(chartId, symbol, provider);
            }
        }
        
        async function loadChartData(chartId, symbol, provider) {
            // Simplified chart loading - would need full implementation
            const chart = charts[chartId];
            chart.data[symbol] = [];
            
            // Update display
            const symbolsDiv = document.getElementById(`${chartId}_symbols`);
            symbolsDiv.innerHTML = chart.symbols.map(s => `
                <div class="chart-symbol-tag">${s.symbol}</div>
            `).join('');
            
            document.getElementById(`${chartId}_canvas`).innerHTML = 
                '<div class="chart-message">Chart visualization would go here</div>';
        }
        
        // Utility functions
        function switchWatchlist(name) {
            currentWatchlist = name;
            loadWatchlistData();
        }
        
        function changeSortOrder(order) {
            sortOrder = order;
            document.querySelectorAll('.sort-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`sort${order.charAt(0).toUpperCase() + order.slice(1)}`).classList.add('active');
            renderWatchlist();
        }
        
        function removeFromWatchlist(event, symbol) {
            event.stopPropagation();
            const currentSymbols = watchlists[currentWatchlist].symbols;
            const index = currentSymbols.findIndex(s => s.symbol === symbol);
            if (index > -1) {
                currentSymbols.splice(index, 1);
                delete watchlistData[symbol];
                saveWatchlists();
                renderWatchlist();
            }
        }
        
        function toggleDataSource(source) {
            const button = document.querySelector(`[data-source="${source}"]`);
            const isActive = button.classList.contains('active');
            
            if (isActive) {
                button.classList.remove('active');
                activeSources = activeSources.filter(s => s !== source);
            } else {
                button.classList.add('active');
                activeSources.push(source);
            }
        }
        
        function showChartView() {
            const chartsArea = document.getElementById('chartsArea');
            chartsArea.style.display = chartsArea.style.display === 'none' ? 'block' : 'none';
        }
        
        function saveWatchlists() {
            localStorage.setItem('openbbWatchlists', JSON.stringify(watchlists));
        }
        
        function loadWatchlists() {
            const saved = localStorage.getItem('openbbWatchlists');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.assign(watchlists, data);
                } catch (e) {
                    console.error('Error loading watchlists:', e);
                }
            }
        }
        
        function updateClock() {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString();
        }
        
        function showMessage(text, type = 'info') {
            const popup = document.createElement('div');
            popup.className = `message-popup ${type}`;
            popup.textContent = text;
            document.body.appendChild(popup);
            setTimeout(() => popup.remove(), 3000);
        }
        
        function showAPIInfo() {
            showMessage('Lambda Search API: 6,204 indicators with CORS enabled', 'info');
        }
        
        function showEnhancedInfo() {
            showMessage('Enhanced API: 60,000+ indicators with real-time updates', 'info');
        }
        
        function showDocumentation() {
            window.open('https://docs.openbb.co', '_blank');
        }
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            const searchBox = document.getElementById('searchBox');
            const searchResults = document.getElementById('searchResults');
            
            if (!searchBox.contains(event.target) && !searchResults.contains(event.target)) {
                searchResults.style.display = 'none';
            }
        });
        
        // Initialize
        window.onload = init;
    </script>
</body>
</html>