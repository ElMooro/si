<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crisis Monitoring Platform - Real-Time Financial Stress Dashboard</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 68, 68, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #ff4444, #ffaa00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* Crisis Level Banner */
        .crisis-banner {
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            position: sticky;
            top: 80px;
            z-index: 999;
            transition: all 0.3s;
        }
        
        .crisis-banner.LOW {
            background: linear-gradient(90deg, #00ff44, #00ff88);
            color: #000;
        }
        
        .crisis-banner.MODERATE {
            background: linear-gradient(90deg, #ffaa00, #ffd700);
            color: #000;
        }
        
        .crisis-banner.ELEVATED {
            background: linear-gradient(90deg, #ff8800, #ffaa00);
            color: #000;
            animation: pulseWarning 2s infinite;
        }
        
        .crisis-banner.HIGH {
            background: linear-gradient(90deg, #ff4444, #ff6666);
            color: #fff;
            animation: pulseAlert 1.5s infinite;
        }
        
        .crisis-banner.CRITICAL {
            background: linear-gradient(90deg, #ff0000, #ff4444);
            color: #fff;
            animation: criticalAlert 1s infinite;
        }
        
        @keyframes pulseWarning {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        @keyframes pulseAlert {
            0%, 100% { opacity: 0.85; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.01); }
        }
        
        @keyframes criticalAlert {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.02); }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Crisis Probability Display */
        .crisis-probability-section {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.1), rgba(255, 170, 0, 0.1));
            border: 2px solid rgba(255, 68, 68, 0.3);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }
        
        .probability-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            margin-bottom: 1.5rem;
        }
        
        .probability-circle {
            position: relative;
            width: 180px;
            height: 180px;
        }
        
        .probability-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            font-weight: bold;
        }
        
        .probability-label {
            font-size: 0.875rem;
            color: #888;
            text-transform: uppercase;
            margin-top: 0.5rem;
        }
        
        /* Stress Indicators Grid */
        .stress-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stress-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .stress-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(255, 68, 68, 0.2);
        }
        
        .stress-card.alert {
            animation: stressAlert 2s infinite;
            border-color: #ff4444;
        }
        
        @keyframes stressAlert {
            0%, 100% { 
                box-shadow: 0 0 0 rgba(255, 68, 68, 0);
            }
            50% { 
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.6);
            }
        }
        
        .stress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .stress-title {
            font-size: 0.875rem;
            color: #888;
            text-transform: uppercase;
        }
        
        .stress-score {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .score-low {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .score-medium {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .score-high {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .stress-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .stress-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Components Grid */
        .components-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        
        .component-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .component-name {
            font-size: 0.875rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        
        .component-score {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .component-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .component-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 1s ease;
        }
        
        .fill-low {
            background: linear-gradient(90deg, #00ff88, #00ccff);
        }
        
        .fill-medium {
            background: linear-gradient(90deg, #ffaa00, #ffd700);
        }
        
        .fill-high {
            background: linear-gradient(90deg, #ff4444, #ff8888);
        }
        
        /* Charts Section */
        .charts-section {
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        #crisisChart, #componentsChart {
            height: 400px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Status Indicators */
        .status-bar {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 2rem;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Refresh Timer */
        .refresh-timer {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: rgba(20, 24, 44, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.875rem;
            z-index: 100;
        }
        
        .timer-value {
            font-weight: bold;
            color: #00ff88;
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 68, 68, 0.3);
            border-top-color: #ff4444;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error Message */
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            text-align: center;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .stress-grid {
                grid-template-columns: 1fr;
            }
            
            .components-grid {
                grid-template-columns: 1fr;
            }
            
            .probability-display {
                flex-direction: column;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="logo">
            ⚠️ Crisis Monitoring Platform
            <span style="font-size: 0.875rem; color: #888;">Real-Time</span>
        </div>
        
        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="apiStatus"></div>
                <span>Crisis API</span>
            </div>
            <div class="status-item">
                <span>Last Update:</span>
                <span id="lastUpdate">--:--:--</span>
            </div>
        </div>
    </header>
    
    <!-- Crisis Level Banner -->
    <div class="crisis-banner" id="crisisBanner">
        🔄 INITIALIZING CRISIS MONITORING SYSTEM...
    </div>
    
    <div class="container">
        <!-- Crisis Probability Section -->
        <div class="crisis-probability-section">
            <div class="probability-display">
                <div class="probability-circle">
                    <svg width="180" height="180">
                        <circle cx="90" cy="90" r="80" fill="none" stroke="rgba(255, 255, 255, 0.1)" stroke-width="10"/>
                        <circle id="probabilityArc" cx="90" cy="90" r="80" fill="none" stroke="url(#gradient)" stroke-width="10" 
                                stroke-dasharray="502" stroke-dashoffset="502" transform="rotate(-90 90 90)"/>
                        <defs>
                            <linearGradient id="gradient">
                                <stop offset="0%" stop-color="#00ff88"/>
                                <stop offset="50%" stop-color="#ffaa00"/>
                                <stop offset="100%" stop-color="#ff4444"/>
                            </linearGradient>
                        </defs>
                    </svg>
                    <div class="probability-value" id="probabilityValue">--%</div>
                </div>
                <div>
                    <h2>Crisis Probability</h2>
                    <div class="probability-label" id="crisisLevel">CALCULATING...</div>
                    <div class="components-grid" id="componentsGrid">
                        <!-- Components will be added here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Treasury Stress Indicators -->
        <h2 style="margin-bottom: 1rem;">📊 Treasury Market Stress</h2>
        <div class="stress-grid" id="treasuryGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Market Stress Indicators -->
        <h2 style="margin-bottom: 1rem;">📈 Market Stress Indicators</h2>
        <div class="stress-grid" id="marketGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Liquidity Stress Indicators -->
        <h2 style="margin-bottom: 1rem;">💧 Liquidity & Funding Stress</h2>
        <div class="stress-grid" id="liquidityGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Systemic Risk Indicators -->
        <h2 style="margin-bottom: 1rem;">🏦 Systemic Risk Indicators</h2>
        <div class="stress-grid" id="systemicGrid">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
        
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Crisis Components Timeline</h2>
                </div>
                <div id="crisisChart"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">Stress Score Distribution</h2>
                </div>
                <div id="componentsChart"></div>
            </div>
        </div>
    </div>
    
    <!-- Refresh Timer -->
    <div class="refresh-timer">
        Next refresh in: <span class="timer-value" id="refreshTimer">60</span>s
    </div>
    
    <script>
        // Crisis API Configuration
        const CRISIS_API = {
            baseUrl: 'https://632cocxo10.execute-api.us-east-1.amazonaws.com/prod',
            endpoints: {
                health: '/health',
                dashboard: '/crisis/dashboard',
                probability: '/crisis/probability',
                treasury: '/crisis/treasury',
                market: '/crisis/market',
                liquidity: '/crisis/liquidity',
                systemic: '/crisis/systemic'
            }
        };
        
        // Global state
        let currentData = {
            dashboard: null,
            probability: null,
            treasury: null,
            market: null,
            liquidity: null,
            systemic: null,
            historicalData: []
        };
        
        let refreshInterval = null;
        let countdownInterval = null;
        let refreshCountdown = 60;
        
        // Initialize the platform
        async function initializePlatform() {
            console.log('🚀 Initializing Crisis Monitoring Platform...');
            
            // Test API connection
            await testAPIConnection();
            
            // Load all data
            await loadAllData();
            
            // Initialize charts
            initializeCharts();
            
            // Start auto-refresh (60 seconds)
            startAutoRefresh();
            
            console.log('✅ Platform initialized successfully');
        }
        
        // Test API connection
        async function testAPIConnection() {
            const statusDot = document.getElementById('apiStatus');
            statusDot.className = 'status-dot';
            
            try {
                const response = await fetch(CRISIS_API.baseUrl + CRISIS_API.endpoints.health);
                if (response.ok) {
                    statusDot.classList.add('connected');
                    console.log('✅ Crisis API connected');
                } else {
                    statusDot.classList.add('error');
                    console.error('❌ Crisis API error');
                }
            } catch (error) {
                statusDot.classList.add('error');
                console.error('❌ Crisis API connection failed:', error);
            }
        }
        
        // Load all data from Crisis API
        async function loadAllData() {
            try {
                // Load dashboard data (main endpoint)
                const dashboardResponse = await fetch(CRISIS_API.baseUrl + CRISIS_API.endpoints.dashboard);
                if (dashboardResponse.ok) {
                    currentData.dashboard = await dashboardResponse.json();
                    updateDashboardDisplay(currentData.dashboard);
                }
                
                // Update last update time
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                
                // Store historical data point
                if (currentData.dashboard) {
                    currentData.historicalData.push({
                        timestamp: now,
                        probability: currentData.dashboard.crisis_assessment.probability,
                        components: currentData.dashboard.crisis_assessment.components
                    });
                    
                    // Keep only last 100 data points
                    if (currentData.historicalData.length > 100) {
                        currentData.historicalData.shift();
                    }
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Failed to load crisis data. Retrying...');
            }
        }
        
        // Update dashboard display
        function updateDashboardDisplay(data) {
            if (!data) return;
            
            // Update crisis probability
            updateCrisisProbability(data.crisis_assessment);
            
            // Update treasury indicators
            updateTreasuryIndicators(data.treasury_indicators);
            
            // Update market indicators
            updateMarketIndicators(data.market_indicators);
            
            // Update liquidity indicators
            updateLiquidityIndicators(data.liquidity_indicators);
            
            // Update systemic indicators
            updateSystemicIndicators(data.systemic_indicators);
            
            // Update charts
            updateCharts(data);
        }
        
        // Update crisis probability display
        function updateCrisisProbability(assessment) {
            const probabilityValue = document.getElementById('probabilityValue');
            const crisisLevel = document.getElementById('crisisLevel');
            const crisisBanner = document.getElementById('crisisBanner');
            const probabilityArc = document.getElementById('probabilityArc');
            
            const probability = assessment.probability;
            const level = assessment.level;
            
            // Update probability value
            probabilityValue.textContent = `${probability}%`;
            probabilityValue.style.color = getColorForProbability(probability);
            
            // Update level text
            crisisLevel.textContent = `CRISIS LEVEL: ${level}`;
            
            // Update banner
            let bannerText = '';
            switch(level) {
                case 'LOW':
                    bannerText = '✅ LOW RISK - Markets Operating Normally';
                    break;
                case 'MODERATE':
                    bannerText = '⚠️ MODERATE RISK - Increased Monitoring Required';
                    break;
                case 'ELEVATED':
                    bannerText = '🔶 ELEVATED RISK - Stress Building in Markets';
                    break;
                case 'HIGH':
                    bannerText = '🔴 HIGH RISK - Significant Market Stress Detected';
                    break;
                case 'CRITICAL':
                    bannerText = '🚨 CRITICAL RISK - Crisis Conditions Present';
                    break;
            }
            crisisBanner.textContent = bannerText;
            crisisBanner.className = `crisis-banner ${level}`;
            
            // Update probability arc
            const circumference = 2 * Math.PI * 80;
            const offset = circumference - (probability / 100 * circumference);
            probabilityArc.style.strokeDashoffset = offset;
            
            // Update components
            updateComponents(assessment.components);
        }
        
        // Update components display
        function updateComponents(components) {
            const grid = document.getElementById('componentsGrid');
            grid.innerHTML = '';
            
            const componentNames = {
                treasury: 'Treasury',
                market: 'Market',
                liquidity: 'Liquidity',
                systemic: 'Systemic'
            };
            
            for (const [key, score] of Object.entries(components)) {
                const item = document.createElement('div');
                item.className = 'component-item';
                
                const fillClass = score <= 3 ? 'fill-low' : score <= 6 ? 'fill-medium' : 'fill-high';
                const scoreColor = score <= 3 ? '#00ff88' : score <= 6 ? '#ffaa00' : '#ff4444';
                
                item.innerHTML = `
                    <div class="component-name">${componentNames[key] || key}</div>
                    <div class="component-score" style="color: ${scoreColor}">${score}/10</div>
                    <div class="component-bar">
                        <div class="component-fill ${fillClass}" style="width: ${score * 10}%"></div>
                    </div>
                `;
                
                grid.appendChild(item);
            }
        }
        
        // Update treasury indicators
        function updateTreasuryIndicators(treasury) {
            const grid = document.getElementById('treasuryGrid');
            grid.innerHTML = '';
            
            const indicators = [
                {
                    title: 'Bid-to-Cover Ratio',
                    value: treasury.bid_to_cover,
                    score: treasury.stress_score,
                    interpretation: treasury.bid_to_cover < 2 ? 'Weak demand' : treasury.bid_to_cover < 2.3 ? 'Moderate demand' : 'Strong demand'
                },
                {
                    title: 'Foreign Participation',
                    value: treasury.foreign_participation,
                    score: treasury.stress_score,
                    suffix: '%',
                    interpretation: 'Foreign buyer interest'
                },
                {
                    title: 'Indirect Bidders',
                    value: treasury.indirect_bidder_pct,
                    score: treasury.stress_score,
                    suffix: '%',
                    interpretation: 'Institutional demand'
                }
            ];
            
            indicators.forEach(indicator => {
                if (indicator.value !== null && indicator.value !== undefined) {
                    grid.appendChild(createStressCard(indicator));
                }
            });
        }
        
        // Update market indicators
        function updateMarketIndicators(market) {
            const grid = document.getElementById('marketGrid');
            grid.innerHTML = '';
            
            const indicators = [
                {
                    title: 'VIX (Volatility)',
                    value: market.VIX,
                    score: market.stress_score,
                    interpretation: market.VIX < 15 ? 'Low volatility' : market.VIX < 20 ? 'Normal' : market.VIX < 30 ? 'Elevated fear' : 'High fear'
                },
                {
                    title: 'TED Spread',
                    value: market.TED_SPREAD,
                    score: market.stress_score,
                    suffix: '%',
                    interpretation: market.TED_SPREAD < 0.3 ? 'Normal' : market.TED_SPREAD < 0.5 ? 'Mild stress' : 'Credit stress'
                },
                {
                    title: '10Y-2Y Spread',
                    value: market.TERM_SPREAD_10Y2Y,
                    score: market.stress_score,
                    suffix: '%',
                    interpretation: market.TERM_SPREAD_10Y2Y < 0 ? 'Inverted (recession signal)' : 'Normal curve'
                },
                {
                    title: 'Dollar Index (DXY)',
                    value: market.DXY,
                    score: market.stress_score,
                    interpretation: market.DXY > 105 ? 'Strong dollar' : market.DXY > 100 ? 'Above average' : 'Below average'
                }
            ];
            
            indicators.forEach(indicator => {
                if (indicator.value !== null && indicator.value !== undefined) {
                    grid.appendChild(createStressCard(indicator));
                }
            });
        }
        
        // Update liquidity indicators
        function updateLiquidityIndicators(liquidity) {
            const grid = document.getElementById('liquidityGrid');
            grid.innerHTML = '';
            
            const indicators = [
                {
                    title: 'SOFR (Overnight Rate)',
                    value: liquidity.OVERNIGHT_RATE,
                    score: liquidity.stress_score,
                    suffix: '%',
                    interpretation: 'Funding cost indicator'
                },
                {
                    title: 'Bank Reserves',
                    value: liquidity.RESERVES ? (liquidity.RESERVES / 1000).toFixed(1) : null,
                    score: liquidity.stress_score,
                    suffix: 'T',
                    interpretation: 'Banking system liquidity'
                },
                {
                    title: 'Reverse Repo Usage',
                    value: liquidity.REVERSE_REPO,
                    score: liquidity.stress_score,
                    suffix: 'B',
                    interpretation: liquidity.REVERSE_REPO > 2000 ? 'High usage' : 'Normal usage'
                }
            ];
            
            indicators.forEach(indicator => {
                if (indicator.value !== null && indicator.value !== undefined) {
                    grid.appendChild(createStressCard(indicator));
                }
            });
        }
        
        // Update systemic indicators
        function updateSystemicIndicators(systemic) {
            const grid = document.getElementById('systemicGrid');
            grid.innerHTML = '';
            
            const indicators = [
                {
                    title: 'Financial Conditions',
                    value: systemic.FINANCIAL_CONDITIONS,
                    score: systemic.stress_score,
                    interpretation: systemic.FINANCIAL_CONDITIONS > 0 ? 'Tightening' : 'Loosening'
                },
                {
                    title: 'Stress Index',
                    value: systemic.STRESS_INDEX,
                    score: systemic.stress_score,
                    interpretation: systemic.STRESS_INDEX > 0 ? 'Above average stress' : 'Below average stress'
                }
            ];
            
            indicators.forEach(indicator => {
                if (indicator.value !== null && indicator.value !== undefined) {
                    grid.appendChild(createStressCard(indicator));
                }
            });
        }
        
        // Create stress card element
        function createStressCard(indicator) {
            const card = document.createElement('div');
            card.className = 'stress-card';
            
            // Add alert class if stress score is high
            if (indicator.score > 5) {
                card.classList.add('alert');
            }
            
            const scoreClass = indicator.score <= 3 ? 'score-low' : indicator.score <= 6 ? 'score-medium' : 'score-high';
            const valueColor = indicator.score <= 3 ? '#00ff88' : indicator.score <= 6 ? '#ffaa00' : '#ff4444';
            
            // Format value
            let displayValue = '';
            if (indicator.value !== null && indicator.value !== undefined) {
                if (typeof indicator.value === 'number') {
                    displayValue = indicator.value.toFixed(2) + (indicator.suffix || '');
                } else {
                    displayValue = indicator.value + (indicator.suffix || '');
                }
            } else {
                displayValue = 'N/A';
            }
            
            card.innerHTML = `
                <div class="stress-header">
                    <div class="stress-title">${indicator.title}</div>
                    <div class="stress-score ${scoreClass}">Score: ${indicator.score}/10</div>
                </div>
                <div class="stress-value" style="color: ${valueColor}">${displayValue}</div>
                <div class="stress-change neutral">
                    ${indicator.interpretation || 'Monitoring...'}
                </div>
            `;
            
            return card;
        }
        
        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                margin: { t: 30, r: 30, b: 30, l: 50 }
            };
            
            Plotly.newPlot('crisisChart', [], chartConfig, {responsive: true});
            Plotly.newPlot('componentsChart', [], chartConfig, {responsive: true});
        }
        
        // Update charts
        function updateCharts(data) {
            updateTimelineChart();
            updateComponentsChart(data.crisis_assessment.components);
        }
        
        // Update timeline chart
        function updateTimelineChart() {
            if (currentData.historicalData.length < 2) return;
            
            const timestamps = currentData.historicalData.map(d => d.timestamp);
            const probabilities = currentData.historicalData.map(d => d.probability);
            
            const trace = {
                x: timestamps,
                y: probabilities,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Crisis Probability',
                line: {
                    color: '#ff4444',
                    width: 2
                },
                marker: {
                    size: 6,
                    color: probabilities.map(p => getColorForProbability(p))
                }
            };
            
            const layout = {
                title: 'Crisis Probability Over Time',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Probability (%)',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    range: [0, 100]
                },
                margin: { t: 30, r: 30, b: 30, l: 50 }
            };
            
            Plotly.newPlot('crisisChart', [trace], layout, {responsive: true});
        }
        
        // Update components chart
        function updateComponentsChart(components) {
            const labels = Object.keys(components).map(k => k.charAt(0).toUpperCase() + k.slice(1));
            const values = Object.values(components);
            
            const trace = {
                x: labels,
                y: values,
                type: 'bar',
                marker: {
                    color: values.map(v => v <= 3 ? '#00ff88' : v <= 6 ? '#ffaa00' : '#ff4444')
                }
            };
            
            const layout = {
                title: 'Stress Score by Component',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Stress Score',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    range: [0, 10]
                },
                margin: { t: 30, r: 30, b: 30, l: 50 }
            };
            
            Plotly.newPlot('componentsChart', [trace], layout, {responsive: true});
        }
        
        // Get color for probability
        function getColorForProbability(probability) {
            if (probability < 15) return '#00ff88';
            if (probability < 30) return '#ffd700';
            if (probability < 50) return '#ffaa00';
            if (probability < 70) return '#ff6666';
            return '#ff0000';
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            // Set up countdown
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refreshTimer').textContent = refreshCountdown;
                
                if (refreshCountdown <= 0) {
                    refreshCountdown = 60;
                }
            }, 1000);
            
            // Set up data refresh
            refreshInterval = setInterval(() => {
                console.log('🔄 Refreshing crisis data...');
                loadAllData();
            }, 60000); // 60 seconds
        }
        
        // Show error message
        function showError(message) {
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePlatform);
    </script>
</body>
</html>
