<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Liquidity Live Dashboard - Real Data</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            min-height: 100vh;
        }

        .dashboard {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #1a1a1a;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(90deg, #00ff88, #00d4ff, #0099ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .status-item {
            padding: 8px 16px;
            background: #1a1a1a;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #00ff88;
            animation: pulse 2s infinite;
        }

        .status-dot.loading {
            background: #ffaa00;
        }

        .status-dot.error {
            background: #ff4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .khalid-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 20px;
            padding: 40px;
            margin: 30px 0;
            text-align: center;
            border: 1px solid #2a2a3e;
        }

        .khalid-title {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #00d4ff;
        }

        .khalid-value {
            font-size: 6em;
            font-weight: 900;
            margin: 20px 0;
            text-shadow: 0 0 30px currentColor;
        }

        .khalid-gauge {
            width: 100%;
            max-width: 600px;
            margin: 30px auto;
        }

        .gauge-background {
            height: 40px;
            background: linear-gradient(90deg, 
                #ff0000 0%, 
                #ff6600 20%, 
                #ffcc00 40%, 
                #99ff00 60%, 
                #00ff00 80%, 
                #ff0000 100%);
            border-radius: 20px;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .gauge-pointer {
            position: absolute;
            top: -10px;
            width: 4px;
            height: 60px;
            background: white;
            box-shadow: 0 0 20px white;
            transition: left 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .khalid-status {
            font-size: 1.5em;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .metric-card {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 20px;
            border: 1px solid #2a2a2a;
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            border-color: #00d4ff;
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,212,255,0.1);
        }

        .metric-label {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .metric-change {
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 5px;
            display: inline-block;
        }

        .metric-change.positive {
            background: rgba(0,255,136,0.2);
            color: #00ff88;
        }

        .metric-change.negative {
            background: rgba(255,68,68,0.2);
            color: #ff4444;
        }

        .alerts-container {
            background: rgba(255,0,0,0.05);
            border: 2px solid rgba(255,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
        }

        .alert-item {
            background: rgba(255,0,0,0.1);
            border-left: 4px solid #ff4444;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            animation: alertPulse 2s infinite;
        }

        @keyframes alertPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .predictions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .prediction-card {
            background: linear-gradient(135deg, #2a1a3e, #1a2a3e);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid #3a2a4e;
        }

        .prediction-label {
            font-size: 1.1em;
            color: #888;
            margin-bottom: 15px;
        }

        .prediction-value {
            font-size: 3em;
            font-weight: bold;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .prediction-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }

        .prediction-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            transition: width 1s ease;
        }

        .data-timestamp {
            text-align: center;
            color: #666;
            margin: 20px 0;
            font-size: 0.9em;
        }

        .refresh-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #00d4ff, #0099ff);
            border: none;
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0,212,255,0.3);
            transition: all 0.3s ease;
        }

        .refresh-button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0,212,255,0.5);
        }

        .refresh-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .countdown {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1a1a1a;
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid #2a2a2a;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #1a1a1a;
            border-top-color: #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: rgba(255,0,0,0.1);
            border: 1px solid rgba(255,0,0,0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            display: none;
        }

        .error-message.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>üåç GLOBAL LIQUIDITY COMMAND CENTER</h1>
            <p style="color: #666;">Real-Time Data from 500+ Economic Indicators</p>
        </div>

        <div class="countdown" id="countdown">
            Next Update: <span id="timer">--:--</span>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="lambdaStatus"></div>
                <span>Lambda</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="apiStatus"></div>
                <span>API</span>
            </div>
            <div class="status-item">
                <div class="status-dot" id="dataStatus"></div>
                <span>Data Feed</span>
            </div>
            <div class="status-item">
                <span id="lastUpdate">Never</span>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="khalid-container">
            <h2 class="khalid-title">üéØ KHALID INDEX</h2>
            <div class="khalid-value" id="khalidValue">--</div>
            <div class="khalid-gauge">
                <div class="gauge-background">
                    <div class="gauge-pointer" id="khalidPointer" style="left: 50%;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; color: #666;">
                    <span>0</span>
                    <span>FEAR</span>
                    <span>NEUTRAL</span>
                    <span>GREED</span>
                    <span>100</span>
                </div>
            </div>
            <div class="khalid-status" id="khalidStatus">Loading...</div>
        </div>

        <div class="alerts-container" id="alertsContainer" style="display: none;">
            <h2 style="color: #ff4444;">üö® ACTIVE ALERTS</h2>
            <div id="alertsList"></div>
        </div>

        <div class="metrics-grid" id="metricsGrid">
            <div class="metric-card">
                <div class="metric-label">üìä VIX Volatility</div>
                <div class="metric-value" id="vix">--</div>
                <div class="metric-change" id="vixChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">üìà 2s10s Spread</div>
                <div class="metric-value" id="spread2s10s">--</div>
                <div class="metric-change" id="spreadChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">üí≥ HY Credit Spread</div>
                <div class="metric-value" id="hySpread">--</div>
                <div class="metric-change" id="hyChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">üíº Unemployment</div>
                <div class="metric-value" id="unemployment">--</div>
                <div class="metric-change" id="unempChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">üè≠ ISM Manufacturing</div>
                <div class="metric-value" id="ism">--</div>
                <div class="metric-change" id="ismChange">--</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">üíµ S&P 500</div>
                <div class="metric-value" id="sp500">--</div>
                <div class="metric-change" id="spChange">--</div>
            </div>
        </div>

        <h2 style="text-align: center; margin: 40px 0;">ü§ñ ML PREDICTIONS</h2>

        <div class="predictions-grid">
            <div class="prediction-card">
                <div class="prediction-label">Recession Risk (12M)</div>
                <div class="prediction-value" id="recessionProb">--%</div>
                <div class="prediction-bar">
                    <div class="prediction-fill" id="recessionBar" style="width: 0%;"></div>
                </div>
            </div>
            <div class="prediction-card">
                <div class="prediction-label">Crash Risk (3M)</div>
                <div class="prediction-value" id="crashProb">--%</div>
                <div class="prediction-bar">
                    <div class="prediction-fill" id="crashBar" style="width: 0%;"></div>
                </div>
            </div>
            <div class="prediction-card">
                <div class="prediction-label">Fear & Greed</div>
                <div class="prediction-value" id="fearGreed">--</div>
                <div class="prediction-bar">
                    <div class="prediction-fill" id="fearGreedBar" style="width: 0%;"></div>
                </div>
            </div>
            <div class="prediction-card">
                <div class="prediction-label">Put/Call Ratio</div>
                <div class="prediction-value" id="putCall">--</div>
                <div class="prediction-bar">
                    <div class="prediction-fill" id="putCallBar" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="data-timestamp">
            Last Updated: <span id="timestamp">Never</span>
        </div>

        <button class="refresh-button" id="refreshBtn" onclick="fetchLiveData()">
            üîÑ Refresh Now
        </button>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <script>
        // ================================
        // CONFIGURATION - UPDATE THIS!
        // ================================
        
        // IMPORTANT: Replace this with your actual API Gateway URL after running setup_api.sh
        const API_URL = 'YOUR_API_GATEWAY_URL_HERE';  // Will look like: https://xxxxx.execute-api.us-east-1.amazonaws.com/prod/data
        
        // For testing without API Gateway, you can invoke Lambda directly via AWS CLI
        const USE_MOCK_DATA = API_URL === 'YOUR_API_GATEWAY_URL_HERE';
        
        // Update intervals
        const AUTO_REFRESH_INTERVAL = 15 * 60 * 1000;  // 15 minutes
        const COUNTDOWN_INTERVAL = 1000;  // 1 second

        // ================================
        // STATE MANAGEMENT
        // ================================
        
        let countdownTimer = null;
        let autoRefreshTimer = null;
        let secondsUntilRefresh = 900;  // 15 minutes
        let lastData = null;

        // ================================
        // DATA FETCHING
        // ================================
        
        async function fetchLiveData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const refreshBtn = document.getElementById('refreshBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            try {
                // Show loading state
                loadingOverlay.classList.add('active');
                refreshBtn.disabled = true;
                errorMessage.classList.remove('active');
                
                // Update status indicators
                document.getElementById('apiStatus').className = 'status-dot loading';
                document.getElementById('dataStatus').className = 'status-dot loading';
                
                let data;
                
                if (USE_MOCK_DATA) {
                    // Mock data for testing when API not set up
                    console.warn('Using mock data. Set up API Gateway and update API_URL!');
                    data = generateMockData();
                } else {
                    // Fetch real data from Lambda via API Gateway
                    const response = await fetch(API_URL, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    // Parse the body if it's stringified
                    if (typeof result.body === 'string') {
                        data = JSON.parse(result.body);
                    } else {
                        data = result;
                    }
                }
                
                // Store last data
                lastData = data;
                
                // Update display with real data
                updateDisplay(data);
                
                // Update status indicators
                document.getElementById('lambdaStatus').className = 'status-dot';
                document.getElementById('apiStatus').className = 'status-dot';
                document.getElementById('dataStatus').className = 'status-dot';
                document.getElementById('lastUpdate').textContent = 'Just now';
                
                // Reset countdown
                secondsUntilRefresh = 900;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                
                // Show error message
                errorMessage.textContent = `Error: ${error.message}. Check console for details.`;
                errorMessage.classList.add('active');
                
                // Update status indicators
                document.getElementById('apiStatus').className = 'status-dot error';
                document.getElementById('dataStatus').className = 'status-dot error';
                
                // If no API URL set, show setup instructions
                if (USE_MOCK_DATA) {
                    errorMessage.innerHTML = `
                        <strong>API Gateway not configured!</strong><br>
                        1. Run: ./setup_api.sh<br>
                        2. Copy the API URL from output<br>
                        3. Update API_URL in this HTML file<br>
                        <br>Currently showing mock data for demo purposes.
                    `;
                }
                
            } finally {
                // Hide loading state
                loadingOverlay.classList.remove('active');
                refreshBtn.disabled = false;
            }
        }

        // ================================
        // UPDATE DISPLAY
        // ================================
        
        function updateDisplay(data) {
            // Update Khalid Index
            if (data.khalid_index) {
                const khalidValue = data.khalid_index.index_value || data.khalid_index.value || data.khalid_index;
                updateKhalidIndex(khalidValue);
            }
            
            // Update metrics
            if (data.metrics || data.market_data) {
                const metrics = data.metrics || data.market_data;
                
                if (metrics.VIXCLS) {
                    document.getElementById('vix').textContent = metrics.VIXCLS.value?.toFixed(2) || metrics.VIXCLS;
                }
                
                if (metrics.DGS10 && metrics.DGS2) {
                    const spread = (metrics.DGS10.value - metrics.DGS2.value) || (metrics.DGS10 - metrics.DGS2);
                    document.getElementById('spread2s10s').textContent = `${spread.toFixed(2)}%`;
                }
                
                if (metrics.BAMLH0A0HYM2) {
                    const hyValue = metrics.BAMLH0A0HYM2.value || metrics.BAMLH0A0HYM2;
                    document.getElementById('hySpread').textContent = `${(hyValue < 10 ? hyValue * 100 : hyValue).toFixed(0)}bp`;
                }
                
                if (metrics.UNRATE) {
                    document.getElementById('unemployment').textContent = `${(metrics.UNRATE.value || metrics.UNRATE).toFixed(1)}%`;
                }
                
                if (metrics.NAPM) {
                    document.getElementById('ism').textContent = (metrics.NAPM.value || metrics.NAPM).toFixed(1);
                }
                
                if (metrics.SP500) {
                    document.getElementById('sp500').textContent = (metrics.SP500.value || metrics.SP500).toFixed(2);
                }
            }
            
            // Update predictions
            if (data.ml_predictions || data.recession_probability) {
                const predictions = data.ml_predictions || {};
                const recessionProb = predictions.recession_12m || data.recession_probability || 0;
                const crashProb = predictions.crash_3m || 0;
                
                document.getElementById('recessionProb').textContent = `${recessionProb}%`;
                document.getElementById('recessionBar').style.width = `${recessionProb}%`;
                
                document.getElementById('crashProb').textContent = `${crashProb}%`;
                document.getElementById('crashBar').style.width = `${crashProb}%`;
            }
            
            // Update sentiment
            if (data.sentiment) {
                const fearGreed = data.sentiment.fear_greed_index || data.sentiment.fear_greed || 50;
                document.getElementById('fearGreed').textContent = fearGreed;
                document.getElementById('fearGreedBar').style.width = `${fearGreed}%`;
            }
            
            // Update options flow
            if (data.options_flow) {
                const putCall = data.options_flow.put_call_ratio || 1.0;
                document.getElementById('putCall').textContent = putCall.toFixed(2);
                document.getElementById('putCallBar').style.width = `${Math.min(putCall * 50, 100)}%`;
            }
            
            // Update alerts
            if (data.alerts_triggered && data.alerts_triggered.length > 0) {
                const alertsContainer = document.getElementById('alertsContainer');
                const alertsList = document.getElementById('alertsList');
                alertsContainer.style.display = 'block';
                alertsList.innerHTML = data.alerts_triggered.map(alert => 
                    `<div class="alert-item">${alert}</div>`
                ).join('');
            } else {
                document.getElementById('alertsContainer').style.display = 'none';
            }
            
            // Update timestamp
            document.getElementById('timestamp').textContent = new Date().toLocaleString();
        }

        // ================================
        // KHALID INDEX DISPLAY
        // ================================
        
        function updateKhalidIndex(value) {
            const khalidEl = document.getElementById('khalidValue');
            const pointerEl = document.getElementById('khalidPointer');
            const statusEl = document.getElementById('khalidStatus');
            
            khalidEl.textContent = value;
            pointerEl.style.left = `${value}%`;
            
            // Update color and status based on value
            if (value < 20) {
                khalidEl.style.color = '#ff0000';
                statusEl.textContent = 'üî¥ EXTREME FEAR - Strong Buy Signal';
            } else if (value < 35) {
                khalidEl.style.color = '#ff6600';
                statusEl.textContent = 'üò® FEAR - Add to Positions';
            } else if (value < 65) {
                khalidEl.style.color = '#ffcc00';
                statusEl.textContent = 'üòê NEUTRAL - Hold Steady';
            } else if (value < 80) {
                khalidEl.style.color = '#99ff00';
                statusEl.textContent = 'üòä GREED - Consider Taking Profits';
            } else {
                khalidEl.style.color = '#00ff00';
                statusEl.textContent = 'üö® EXTREME GREED - Sell Signal';
            }
        }

        // ================================
        // MOCK DATA GENERATOR
        // ================================
        
        function generateMockData() {
            console.log('Generating mock data for testing...');
            return {
                khalid_index: {
                    index_value: Math.floor(Math.random() * 30) + 40,
                    components: {
                        volatility: Math.floor(Math.random() * 100),
                        credit: Math.floor(Math.random() * 100),
                        curve: Math.floor(Math.random() * 100),
                        options: Math.floor(Math.random() * 100)
                    }
                },
                metrics: {
                    VIXCLS: { value: Math.random() * 15 + 15 },
                    DGS10: { value: Math.random() + 3.5 },
                    DGS2: { value: Math.random() + 3 },
                    BAMLH0A0HYM2: { value: Math.random() * 2 + 4 },
                    UNRATE: { value: Math.random() * 2 + 3 },
                    NAPM: { value: Math.random() * 10 + 45 },
                    SP500: { value: Math.random() * 100 + 4500 }
                },
                ml_predictions: {
                    recession_12m: Math.floor(Math.random() * 30) + 10,
                    crash_3m: Math.floor(Math.random() * 20) + 5
                },
                sentiment: {
                    fear_greed: Math.floor(Math.random() * 40) + 30
                },
                options_flow: {
                    put_call_ratio: Math.random() * 0.5 + 0.75
                },
                alerts_triggered: Math.random() > 0.7 ? ['Test Alert: VIX Spike Detected'] : []
            };
        }

        // ================================
        // COUNTDOWN TIMER
        // ================================
        
        function updateCountdown() {
            const minutes = Math.floor(secondsUntilRefresh / 60);
            const seconds = secondsUntilRefresh % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update last update time
            if (lastData) {
                const secondsAgo = 900 - secondsUntilRefresh;
                if (secondsAgo < 60) {
                    document.getElementById('lastUpdate').textContent = 'Just now';
                } else {
                    const minutesAgo = Math.floor(secondsAgo / 60);
                    document.getElementById('lastUpdate').textContent = `${minutesAgo}m ago`;
                }
            }
            
            secondsUntilRefresh--;
            
            if (secondsUntilRefresh < 0) {
                secondsUntilRefresh = 900;
                fetchLiveData();
            }
        }

        // ================================
        // INITIALIZATION
        // ================================
        
        function initialize() {
            console.log('Initializing Global Liquidity Dashboard...');
            
            // Check if API URL is configured
            if (USE_MOCK_DATA) {
                console.warn('‚ö†Ô∏è API_URL not configured! Using mock data.');
                console.log('To use real data:');
                console.log('1. Run: ./setup_api.sh');
                console.log('2. Copy the API URL from output');
                console.log('3. Update API_URL in this HTML file');
            } else {
                console.log(`‚úÖ Configured to fetch from: ${API_URL}`);
            }
            
            // Initial data fetch
            fetchLiveData();
            
            // Start countdown timer
            countdownTimer = setInterval(updateCountdown, COUNTDOWN_INTERVAL);
            
            // Set up auto-refresh
            autoRefreshTimer = setInterval(fetchLiveData, AUTO_REFRESH_INTERVAL);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
                    e.preventDefault();
                    fetchLiveData();
                }
            });
            
            console.log('Dashboard initialized successfully!');
        }

        // Start when page loads
        window.addEventListener('load', initialize);

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (countdownTimer) clearInterval(countdownTimer);
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
        });
    </script>
</body>
</html>
