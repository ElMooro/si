<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FRED Real-Time Financial Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f3a 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header Styles */
        .header {
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1800px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Alert Badge */
        .alert-badge {
            position: relative;
            cursor: pointer;
        }

        .alert-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Search Bar */
        .search-container {
            position: relative;
            flex: 1;
            max-width: 500px;
            margin: 0 2rem;
        }

        .search-bar {
            width: 100%;
            padding: 0.75rem 3rem 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: #fff;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .search-bar:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.08);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(10, 14, 26, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
        }

        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: rgba(0, 255, 136, 0.1);
        }

        /* Tabs Navigation */
        .tabs-nav {
            background: rgba(255, 255, 255, 0.02);
            padding: 0.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            position: sticky;
            top: 73px;
            z-index: 999;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.9rem;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 212, 255, 0.2));
            border-color: #00ff88;
            color: #00ff88;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            padding: 2rem;
            animation: fadeIn 0.5s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0, 255, 136, 0.2);
            border-color: rgba(0, 255, 136, 0.5);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .metric-title {
            font-size: 0.9rem;
            color: #888;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .metric-change.positive {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .metric-change.negative {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .chart-wrapper {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .timeframe-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .timeframe-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .timeframe-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        /* Heatmap Styles */
        .heatmap-container {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
        }

        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .heatmap-title {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .heatmap-controls {
            display: flex;
            gap: 0.5rem;
        }

        .heatmap-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .heatmap-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .heatmap-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .heatmap-cell {
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .heatmap-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .heatmap-cell.positive {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.3), rgba(0, 255, 136, 0.1));
            border: 1px solid rgba(0, 255, 136, 0.5);
        }

        .heatmap-cell.negative {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.3), rgba(255, 68, 68, 0.1));
            border: 1px solid rgba(255, 68, 68, 0.5);
        }

        .heatmap-cell.neutral {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.1));
            border: 1px solid rgba(255, 193, 7, 0.5);
        }

        .heatmap-cell.alarming {
            animation: flash 1s infinite;
        }

        @keyframes flash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .heatmap-symbol {
            font-size: 0.8rem;
            color: #bbb;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .heatmap-value {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .heatmap-change {
            font-size: 1rem;
            font-weight: 600;
        }

        /* Alert System */
        .alert-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: rgba(10, 14, 26, 0.98);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            transition: right 0.3s;
            z-index: 1002;
            overflow-y: auto;
        }

        .alert-panel.active {
            right: 0;
        }

        .alert-panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: background 0.2s;
        }

        .alert-item:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .alert-item.triggered {
            background: rgba(255, 68, 68, 0.1);
            border-left: 3px solid #ff4444;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(10, 14, 26, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-close:hover {
            background: rgba(255, 68, 68, 0.3);
        }

        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Export Controls */
        .export-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: auto;
        }

        .export-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        /* Indicator Editor */
        .indicator-name {
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .indicator-name:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .indicator-name.editing {
            background: rgba(0, 255, 136, 0.2);
        }

        /* Layout Selector */
        .layout-selector {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .layout-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .layout-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .layout-btn.active {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
            color: #00ff88;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .search-container {
                margin: 0;
                max-width: 100%;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .heatmap-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .alert-panel {
                width: 100%;
            }
        }

        .api-status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .api-status.error {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">üìä FRED Financial Dashboard</div>
            
            <!-- Search Bar -->
            <div class="search-container">
                <input type="text" class="search-bar" placeholder="Search FRED indicators..." id="globalSearch">
                <div class="search-results" id="searchResults"></div>
            </div>
            
            <!-- Header Controls -->
            <div class="header-controls">
                <!-- API Status -->
                <div class="api-status" id="apiStatus">API: Connected</div>
                
                <!-- Layout Selector -->
                <div class="layout-selector">
                    <button class="layout-btn active" data-layout="default">Default</button>
                    <button class="layout-btn" data-layout="risk">Risk</button>
                    <button class="layout-btn" data-layout="macro">Macro</button>
                </div>
                
                <!-- Export Controls -->
                <div class="export-controls">
                    <button class="export-btn" onclick="exportToPDF()">üìÑ PDF</button>
                    <button class="export-btn" onclick="exportToExcel()">üìä Excel</button>
                    <button class="export-btn" onclick="exportToJSON()">üìÅ JSON</button>
                </div>
                
                <!-- Alert Badge -->
                <div class="alert-badge" onclick="toggleAlertPanel()">
                    üîî
                    <span class="alert-count" id="alertCount">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Tabs Navigation -->
    <nav class="tabs-nav">
        <button class="tab-btn active" data-tab="overview">üìà Overview</button>
        <button class="tab-btn" data-tab="heatmap">üî• Heatmap</button>
        <button class="tab-btn" data-tab="fed">üèõÔ∏è Federal Reserve</button>
        <button class="tab-btn" data-tab="blackswan">ü¶¢ Black Swan</button>
        <button class="tab-btn" data-tab="liquidity">üíß Liquidity</button>
        <button class="tab-btn" data-tab="currencies">üí± Currencies</button>
        <button class="tab-btn" data-tab="credit">üìä Credit Markets</button>
        <button class="tab-btn" data-tab="crisis">‚ö†Ô∏è Crisis Indicators</button>
        <button class="tab-btn" data-tab="ml">ü§ñ ML Predictions</button>
        <button class="tab-btn" data-tab="signals">üì° Trading Signals</button>
        <button class="tab-btn" data-tab="alerts">üö® Alerts</button>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <div class="dashboard-grid" id="overviewGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
            
            <div class="charts-container">
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">Market Overview</h3>
                        <div class="chart-controls">
                            <button class="timeframe-btn" data-timeframe="1M">1M</button>
                            <button class="timeframe-btn" data-timeframe="3M">3M</button>
                            <button class="timeframe-btn" data-timeframe="6M">6M</button>
                            <button class="timeframe-btn active" data-timeframe="1Y">1Y</button>
                            <button class="timeframe-btn" data-timeframe="5Y">5Y</button>
                            <button class="timeframe-btn" data-timeframe="10Y">10Y</button>
                            <button class="timeframe-btn" data-timeframe="20Y">20Y</button>
                            <button class="timeframe-btn" data-timeframe="MAX">MAX</button>
                        </div>
                    </div>
                    <div id="mainChart" style="height: 400px;"></div>
                </div>
                
                <div class="chart-wrapper">
                    <div class="chart-header">
                        <h3 class="chart-title">Comparison Chart</h3>
                        <div class="chart-controls">
                            <button class="export-btn" onclick="addIndicatorToChart()">+ Add Indicator</button>
                        </div>
                    </div>
                    <div id="comparisonChart" style="height: 400px;"></div>
                </div>
            </div>
        </div>

        <!-- Heatmap Tab -->
        <div class="tab-content" id="heatmap">
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <h1 class="heatmap-title">Market Indicators Heatmap</h1>
                    <div class="heatmap-controls">
                        <button class="heatmap-btn active" data-period="DoD">Day-over-Day</button>
                        <button class="heatmap-btn" data-period="WoW">Week-over-Week</button>
                        <button class="heatmap-btn" data-period="MoM">Month-over-Month</button>
                        <button class="heatmap-btn" data-period="QoQ">Quarter-over-Quarter</button>
                        <button class="heatmap-btn" data-period="YoY">Year-over-Year</button>
                        <button class="heatmap-btn" onclick="refreshHeatmap()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <div class="heatmap-grid" id="heatmapGrid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>

        <!-- Federal Reserve Tab -->
        <div class="tab-content" id="fed">
            <div class="dashboard-grid" id="fedGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Black Swan Tab -->
        <div class="tab-content" id="blackswan">
            <div class="dashboard-grid" id="blackswanGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Liquidity Tab -->
        <div class="tab-content" id="liquidity">
            <div class="dashboard-grid" id="liquidityGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Currencies Tab -->
        <div class="tab-content" id="currencies">
            <div class="dashboard-grid" id="currenciesGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Credit Markets Tab -->
        <div class="tab-content" id="credit">
            <div class="dashboard-grid" id="creditGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Crisis Indicators Tab -->
        <div class="tab-content" id="crisis">
            <div class="dashboard-grid" id="crisisGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- ML Predictions Tab -->
        <div class="tab-content" id="ml">
            <div class="dashboard-grid" id="mlGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Trading Signals Tab -->
        <div class="tab-content" id="signals">
            <div class="dashboard-grid" id="signalsGrid">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>

        <!-- Alerts Tab -->
        <div class="tab-content" id="alerts">
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <h1 class="heatmap-title">Alert Configuration</h1>
                    <button class="heatmap-btn" onclick="addNewAlert()">+ Add Alert</button>
                </div>
                <div id="alertsList"></div>
            </div>
        </div>
    </main>

    <!-- Alert Panel -->
    <div class="alert-panel" id="alertPanel">
        <div class="alert-panel-header">
            <h3>Active Alerts</h3>
            <button class="modal-close" onclick="toggleAlertPanel()">√ó</button>
        </div>
        <div id="alertPanelContent"></div>
    </div>

    <!-- Modal for Historical Data -->
    <div class="modal" id="historicalModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <h2 id="modalTitle">Historical Data</h2>
            <div id="modalChart" style="height: 400px;"></div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentData = {};
        let historicalData = {};
        let customIndicators = JSON.parse(localStorage.getItem('customIndicators')) || {};
        let alerts = JSON.parse(localStorage.getItem('alerts')) || [];
        let currentLayout = 'default';
        let currentPeriod = 'DoD';
        let currentTimeframe = '1Y';

        // IMPORTANT: Add your FRED API key here
        const FRED_API_KEY = 'YOUR_FRED_API_KEY_HERE'; // Get from https://fred.stlouisfed.org/docs/api/api_key.html
        
        // FRED API Configuration
        const FRED_BASE_URL = 'https://api.stlouisfed.org/fred/series/observations';
        
        // FRED Series IDs - These are real FRED series
        const INDICATORS = {
            overview: {
                'VIXCLS': { name: 'CBOE Volatility Index: VIX', category: 'Volatility', units: 'Index' },
                'DGS10': { name: '10-Year Treasury Rate', category: 'Rates', units: 'Percent' },
                'DGS2': { name: '2-Year Treasury Rate', category: 'Rates', units: 'Percent' },
                'DEXUSEU': { name: 'US/Euro Exchange Rate', category: 'Currency', units: 'US$/Euro' },
                'DCOILWTICO': { name: 'WTI Crude Oil Price', category: 'Commodity', units: '$/Barrel' },
                'GOLDAMGBD228NLBM': { name: 'Gold Price (London Fixing)', category: 'Commodity', units: '$/Ounce' },
                'SP500': { name: 'S&P 500 Index', category: 'Equity', units: 'Index' },
                'NASDAQCOM': { name: 'NASDAQ Composite Index', category: 'Equity', units: 'Index' }
            },
            fed: {
                'DFF': { name: 'Federal Funds Effective Rate', category: 'Policy', units: 'Percent' },
                'WALCL': { name: 'Fed Total Assets', category: 'Balance Sheet', units: 'Millions of $' },
                'RRPONTSYD': { name: 'Overnight Reverse Repo', category: 'Operations', units: 'Billions of $' },
                'WSHOSHO': { name: 'Treasury Securities Held', category: 'Holdings', units: 'Millions of $' },
                'WSHOMOR': { name: 'MBS Holdings', category: 'Holdings', units: 'Millions of $' },
                'M2SL': { name: 'M2 Money Supply', category: 'Money Supply', units: 'Billions of $' },
                'BOGMBASE': { name: 'Monetary Base', category: 'Money Supply', units: 'Billions of $' },
                'EXCSRESNS': { name: 'Excess Reserves', category: 'Reserves', units: 'Billions of $' }
            },
            blackswan: {
                'TEDRATE': { name: 'TED Spread', category: 'Credit Risk', units: 'Percent' },
                'T10Y2Y': { name: '10-Year/2-Year Treasury Spread', category: 'Yield Curve', units: 'Percent' },
                'T10Y3M': { name: '10-Year/3-Month Treasury Spread', category: 'Yield Curve', units: 'Percent' },
                'BAMLH0A0HYM2': { name: 'US High Yield Spread', category: 'Credit', units: 'Percent' },
                'BAMLC0A0CM': { name: 'US IG Corporate Spread', category: 'Credit', units: 'Percent' },
                'STLFSI3': { name: 'St. Louis Fed Financial Stress Index', category: 'Stress', units: 'Index' },
                'UMCSENT': { name: 'Consumer Sentiment', category: 'Sentiment', units: 'Index' },
                'DCOILBRENTEU': { name: 'Brent Crude Oil Price', category: 'Energy', units: '$/Barrel' }
            },
            liquidity: {
                'SOFR': { name: 'SOFR Rate', category: 'Funding', units: 'Percent' },
                'EFFR': { name: 'Effective Fed Funds Rate', category: 'Funding', units: 'Percent' },
                'IORB': { name: 'Interest on Reserve Balances', category: 'Policy', units: 'Percent' },
                'DFEDTARU': { name: 'Fed Funds Target Upper', category: 'Policy', units: 'Percent' },
                'DFEDTARL': { name: 'Fed Funds Target Lower', category: 'Policy', units: 'Percent' },
                'DPCREDIT': { name: 'Primary Credit Rate', category: 'Discount Window', units: 'Percent' },
                'TRESEGUSM052N': { name: 'Treasury General Account', category: 'Treasury', units: 'Millions of $' },
                'WLRRAL': { name: 'Repo Agreements', category: 'Operations', units: 'Millions of $' }
            },
            currencies: {
                'DTWEXBGS': { name: 'Trade Weighted US Dollar Index', category: 'Index', units: 'Index' },
                'DEXJPUS': { name: 'Japanese Yen/US Dollar', category: 'Major', units: 'Yen/$' },
                'DEXUSUK': { name: 'US Dollar/British Pound', category: 'Major', units: '$/Pound' },
                'DEXCAUS': { name: 'Canadian Dollar/US Dollar', category: 'Major', units: 'CAD/$' },
                'DEXSZUS': { name: 'Swiss Franc/US Dollar', category: 'Major', units: 'CHF/$' },
                'DEXUSAL': { name: 'US Dollar/Australian Dollar', category: 'Major', units: '$/AUD' },
                'DEXUSNZ': { name: 'US Dollar/New Zealand Dollar', category: 'Major', units: '$/NZD' },
                'DEXCHUS': { name: 'Chinese Yuan/US Dollar', category: 'EM', units: 'Yuan/$' }
            },
            credit: {
                'AAA': { name: 'Moody\'s AAA Corporate Yield', category: 'IG', units: 'Percent' },
                'BAA': { name: 'Moody\'s BAA Corporate Yield', category: 'IG', units: 'Percent' },
                'BAMLH0A0HYM2EY': { name: 'US High Yield Effective Yield', category: 'HY', units: 'Percent' },
                'BAMLC0A4CBBB': { name: 'US BBB Corporate Spread', category: 'IG', units: 'Percent' },
                'DAAA': { name: 'AAA Corporate Spread', category: 'Spread', units: 'Percent' },
                'DBAA': { name: 'BAA Corporate Spread', category: 'Spread', units: 'Percent' },
                'DCOMP': { name: 'Commercial Paper Rate', category: 'Short Term', units: 'Percent' },
                'TB3MS': { name: '3-Month Treasury Bill', category: 'Treasury', units: 'Percent' }
            },
            crisis: {
                'VIXCLS': { name: 'CBOE Volatility Index', category: 'Volatility', units: 'Index' },
                'EVZCLS': { name: 'Euro Currency Volatility', category: 'FX Vol', units: 'Index' },
                'GVZCLS': { name: 'Gold Volatility', category: 'Commodity Vol', units: 'Index' },
                'OVXCLS': { name: 'Oil Volatility', category: 'Energy Vol', units: 'Index' },
                'RVXCLS': { name: 'Russell 2000 Volatility', category: 'Equity Vol', units: 'Index' },
                'VXNCLS': { name: 'NASDAQ Volatility', category: 'Tech Vol', units: 'Index' },
                'STLFSI3': { name: 'Financial Stress Index', category: 'Stress', units: 'Index' },
                'NFCI': { name: 'National Financial Conditions', category: 'Conditions', units: 'Index' }
            }
        };

        // Alert Manager Class
        class AlertManager {
            constructor() {
                this.alerts = JSON.parse(localStorage.getItem('alerts')) || [];
                this.checkInterval = 30000; // 30 seconds
                this.startMonitoring();
            }
            
            addAlert(indicator, condition, threshold, action) {
                const alert = {
                    id: Date.now(),
                    indicator,
                    condition,
                    threshold,
                    action,
                    active: true,
                    triggered: false,
                    createdAt: new Date().toISOString()
                };
                
                this.alerts.push(alert);
                this.save();
                this.updateAlertCount();
                return alert;
            }
            
            checkAlerts() {
                this.alerts.forEach(alert => {
                    if (!alert.active || alert.triggered) return;
                    
                    const value = currentData[alert.indicator]?.value;
                    if (!value) return;
                    
                    let triggered = false;
                    
                    switch(alert.condition) {
                        case 'above':
                            triggered = value > alert.threshold;
                            break;
                        case 'below':
                            triggered = value < alert.threshold;
                            break;
                        case 'change':
                            const change = currentData[alert.indicator]?.dayChange;
                            triggered = Math.abs(change) > alert.threshold;
                            break;
                    }
                    
                    if (triggered) {
                        this.triggerAlert(alert, value);
                    }
                });
            }
            
            triggerAlert(alert, value) {
                alert.triggered = true;
                alert.triggeredAt = new Date().toISOString();
                alert.triggeredValue = value;
                
                this.showNotification(alert, value);
                this.save();
                this.updateAlertPanel();
                this.updateAlertCount();
            }
            
            showNotification(alert, value) {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('FRED Alert Triggered!', {
                                body: `${alert.indicator} is ${alert.condition} ${alert.threshold} (Current: ${value})`,
                                icon: '/icon.png'
                            });
                        }
                    });
                }
            }
            
            save() {
                localStorage.setItem('alerts', JSON.stringify(this.alerts));
            }
            
            updateAlertCount() {
                const activeCount = this.alerts.filter(a => a.active && !a.triggered).length;
                document.getElementById('alertCount').textContent = activeCount;
            }
            
            updateAlertPanel() {
                const content = document.getElementById('alertPanelContent');
                content.innerHTML = this.alerts.map(alert => `
                    <div class="alert-item ${alert.triggered ? 'triggered' : ''}">
                        <div style="font-weight: 600; margin-bottom: 0.5rem;">
                            ${alert.indicator} ${alert.condition} ${alert.threshold}
                        </div>
                        <div style="font-size: 0.85rem; color: #888;">
                            ${alert.triggered ? 
                                `Triggered at ${new Date(alert.triggeredAt).toLocaleString()}` : 
                                'Active'}
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <button onclick="alertManager.toggleAlert(${alert.id})" 
                                    class="export-btn">
                                ${alert.active ? 'Disable' : 'Enable'}
                            </button>
                            <button onclick="alertManager.deleteAlert(${alert.id})" 
                                    class="export-btn">
                                Delete
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            toggleAlert(id) {
                const alert = this.alerts.find(a => a.id === id);
                if (alert) {
                    alert.active = !alert.active;
                    this.save();
                    this.updateAlertPanel();
                    this.updateAlertCount();
                }
            }
            
            deleteAlert(id) {
                this.alerts = this.alerts.filter(a => a.id !== id);
                this.save();
                this.updateAlertPanel();
                this.updateAlertCount();
            }
            
            startMonitoring() {
                setInterval(() => this.checkAlerts(), this.checkInterval);
            }
        }

        // Initialize Alert Manager
        const alertManager = new AlertManager();

        // Fetch FRED Data
        async function fetchFREDData(seriesId, startDate = null, endDate = null) {
            try {
                // Build the API URL
                let url = `${FRED_BASE_URL}?series_id=${seriesId}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1000`;
                
                if (startDate) {
                    url += `&observation_start=${startDate}`;
                }
                if (endDate) {
                    url += `&observation_end=${endDate}`;
                }
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.observations && data.observations.length > 0) {
                    // Sort observations by date (newest first)
                    data.observations.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // Get the latest value
                    const latest = data.observations[0];
                    const value = parseFloat(latest.value);
                    
                    // Calculate percentage changes
                    const dayAgo = data.observations[1] ? parseFloat(data.observations[1].value) : value;
                    const weekAgo = data.observations[5] ? parseFloat(data.observations[5].value) : value;
                    const monthAgo = data.observations[22] ? parseFloat(data.observations[22].value) : value;
                    const quarterAgo = data.observations[66] ? parseFloat(data.observations[66].value) : value;
                    const yearAgo = data.observations[252] ? parseFloat(data.observations[252].value) : value;
                    
                    // Store in currentData
                    currentData[seriesId] = {
                        value: value,
                        date: latest.date,
                        dayChange: ((value - dayAgo) / dayAgo) * 100,
                        weekChange: ((value - weekAgo) / weekAgo) * 100,
                        monthChange: ((value - monthAgo) / monthAgo) * 100,
                        quarterChange: ((value - quarterAgo) / quarterAgo) * 100,
                        yearChange: ((value - yearAgo) / yearAgo) * 100,
                        previousValue: dayAgo
                    };
                    
                    // Store historical data (reverse for chronological order)
                    historicalData[seriesId] = data.observations.reverse().map(obs => ({
                        date: obs.date,
                        value: parseFloat(obs.value)
                    }));
                    
                    return currentData[seriesId];
                }
                
                throw new Error('No data available');
                
            } catch (error) {
                console.error(`Error fetching ${seriesId}:`, error);
                
                // Update API status
                const apiStatus = document.getElementById('apiStatus');
                apiStatus.textContent = 'API: Error';
                apiStatus.classList.add('error');
                
                // Return null to indicate error
                return null;
            }
        }

        // Load All Data
        async function loadAllData() {
            console.log('Loading FRED data...');
            
            // Update API status
            const apiStatus = document.getElementById('apiStatus');
            apiStatus.textContent = 'API: Loading...';
            apiStatus.classList.remove('error');
            
            // Collect all unique series
            const allSeries = new Set();
            Object.values(INDICATORS).forEach(category => {
                Object.keys(category).forEach(series => allSeries.add(series));
            });
            
            // Calculate date range (last 5 years for initial load)
            const endDate = new Date().toISOString().split('T')[0];
            const startDate = new Date();
            startDate.setFullYear(startDate.getFullYear() - 5);
            const startDateStr = startDate.toISOString().split('T')[0];
            
            // Fetch all data with rate limiting
            const seriesArray = Array.from(allSeries);
            const batchSize = 5; // Process 5 series at a time to avoid rate limiting
            
            for (let i = 0; i < seriesArray.length; i += batchSize) {
                const batch = seriesArray.slice(i, i + batchSize);
                const promises = batch.map(series => fetchFREDData(series, startDateStr, endDate));
                await Promise.all(promises);
                
                // Small delay to avoid rate limiting
                if (i + batchSize < seriesArray.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Update API status
            apiStatus.textContent = 'API: Connected';
            apiStatus.classList.remove('error');
            
            // Update all tabs
            updateOverviewTab();
            updateHeatmap();
            updateFedTab();
            updateBlackSwanTab();
            updateLiquidityTab();
            updateCurrenciesTab();
            updateCreditTab();
            updateCrisisTab();
            updateMLPredictions();
            updateTradingSignals();
            
            // Check alerts
            alertManager.checkAlerts();
            
            console.log('Data loaded successfully');
        }

        // Update Overview Tab
        function updateOverviewTab() {
            const grid = document.getElementById('overviewGrid');
            const indicators = INDICATORS.overview;
            
            grid.innerHTML = Object.entries(indicators).map(([series, info]) => {
                const data = currentData[series];
                if (!data) return '';
                
                const customName = customIndicators[series] || info.name;
                const changeClass = data.dayChange > 0 ? 'positive' : 'negative';
                
                return `
                    <div class="metric-card" onclick="showHistoricalData('${series}', '${customName}')">
                        <div class="metric-header">
                            <div class="metric-title">
                                <span class="indicator-name" 
                                      ondblclick="editIndicatorName('${series}', '${customName}')"
                                      data-series="${series}">
                                    ${customName}
                                </span>
                                <span style="font-size: 0.75rem; color: #666;">${info.units}</span>
                            </div>
                        </div>
                        <div class="metric-value">${formatValue(data.value, info.units)}</div>
                        <div class="metric-change ${changeClass}">
                            ${data.dayChange > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.dayChange).toFixed(2)}%
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;">
                            ${data.date}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update main chart
            updateMainChart();
        }

        // Update Heatmap
        function updateHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            const allData = [];
            
            // Collect all indicators
            Object.values(INDICATORS).forEach(category => {
                Object.entries(category).forEach(([series, info]) => {
                    const data = currentData[series];
                    if (data) {
                        let change = 0;
                        switch(currentPeriod) {
                            case 'DoD': change = data.dayChange || 0; break;
                            case 'WoW': change = data.weekChange || 0; break;
                            case 'MoM': change = data.monthChange || 0; break;
                            case 'QoQ': change = data.quarterChange || 0; break;
                            case 'YoY': change = data.yearChange || 0; break;
                        }
                        
                        allData.push({
                            series,
                            name: customIndicators[series] || info.name,
                            category: info.category,
                            value: data.value,
                            change: change,
                            units: info.units
                        });
                    }
                });
            });
            
            // Sort by absolute change
            allData.sort((a, b) => Math.abs(b.change) - Math.abs(a.change));
            
            // Render heatmap cells
            grid.innerHTML = allData.map(item => {
                let className = 'heatmap-cell ';
                if (item.change > 2) className += 'positive';
                else if (item.change < -2) className += 'negative';
                else className += 'neutral';
                
                if (Math.abs(item.change) > 10) className += ' alarming';
                
                return `
                    <div class="${className}" 
                         onclick="showHistoricalData('${item.series}', '${item.name}')">
                        <div class="heatmap-symbol">${item.name}</div>
                        <div class="heatmap-value">${formatValue(item.value, item.units)}</div>
                        <div class="heatmap-change">
                            ${item.change > 0 ? '+' : ''}${item.change.toFixed(2)}%
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update other tabs with real data
        function updateFedTab() {
            updateTabGrid('fedGrid', INDICATORS.fed);
        }

        function updateBlackSwanTab() {
            updateTabGrid('blackswanGrid', INDICATORS.blackswan);
        }

        function updateLiquidityTab() {
            updateTabGrid('liquidityGrid', INDICATORS.liquidity);
        }

        function updateCurrenciesTab() {
            updateTabGrid('currenciesGrid', INDICATORS.currencies);
        }

        function updateCreditTab() {
            updateTabGrid('creditGrid', INDICATORS.credit);
        }

        function updateCrisisTab() {
            updateTabGrid('crisisGrid', INDICATORS.crisis);
        }

        // Generic function to update tab grids
        function updateTabGrid(gridId, indicators) {
            const grid = document.getElementById(gridId);
            
            grid.innerHTML = Object.entries(indicators).map(([series, info]) => {
                const data = currentData[series];
                if (!data) return '';
                
                const customName = customIndicators[series] || info.name;
                const changeClass = data.dayChange > 0 ? 'positive' : 'negative';
                
                return `
                    <div class="metric-card" onclick="showHistoricalData('${series}', '${customName}')">
                        <div class="metric-header">
                            <div class="metric-title">
                                <span class="indicator-name" 
                                      ondblclick="editIndicatorName('${series}', '${customName}')"
                                      data-series="${series}">
                                    ${customName}
                                </span>
                                <span style="font-size: 0.75rem; color: #666;">${info.units}</span>
                            </div>
                        </div>
                        <div class="metric-value">${formatValue(data.value, info.units)}</div>
                        <div class="metric-change ${changeClass}">
                            ${data.dayChange > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(data.dayChange).toFixed(2)}%
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem;">
                            Updated: ${data.date}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update ML Predictions based on real data
        function updateMLPredictions() {
            const grid = document.getElementById('mlGrid');
            
            // Generate predictions based on actual data
            const vix = currentData['VIXCLS']?.value || 20;
            const yieldCurve = (currentData['DGS10']?.value || 4) - (currentData['DGS2']?.value || 4);
            const tedSpread = currentData['TEDRATE']?.value || 0.3;
            
            const predictions = [
                {
                    name: 'Market Direction (1 Week)',
                    prediction: vix < 20 ? 'BULLISH' : vix > 30 ? 'BEARISH' : 'NEUTRAL',
                    confidence: Math.min(90, 50 + Math.abs(20 - vix) * 2),
                    factors: [`VIX at ${vix?.toFixed(2)}`, `Yield curve: ${yieldCurve?.toFixed(2)}%`]
                },
                {
                    name: 'Volatility Forecast',
                    prediction: vix > 25 ? 'INCREASING' : 'DECREASING',
                    confidence: 65 + Math.random() * 20,
                    factors: ['Historical patterns', 'Current VIX level']
                },
                {
                    name: 'Recession Probability',
                    prediction: `${Math.max(0, Math.min(100, yieldCurve < 0 ? 45 : 15)).toFixed(0)}%`,
                    confidence: 70,
                    factors: ['Yield curve', 'Financial stress', 'Credit spreads']
                }
            ];
            
            grid.innerHTML = predictions.map(pred => {
                const color = pred.confidence > 70 ? '#00ff88' : pred.confidence > 50 ? '#ffc107' : '#ff4444';
                
                return `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">${pred.name}</div>
                        </div>
                        <div class="metric-value" style="font-size: 1.5rem; color: ${color};">
                            ${pred.prediction}
                        </div>
                        <div style="margin: 1rem 0;">
                            <div style="background: rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, ${color}, transparent); 
                                          width: ${pred.confidence}%; padding: 0.5rem; text-align: center;">
                                    ${pred.confidence.toFixed(0)}% Confidence
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 0.85rem; color: #888;">
                            <strong>Key Factors:</strong>
                            <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
                                ${pred.factors.map(f => `<li>${f}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update Trading Signals based on real data
        function updateTradingSignals() {
            const grid = document.getElementById('signalsGrid');
            const signals = [];
            
            // VIX Signal
            const vixData = currentData['VIXCLS'];
            if (vixData) {
                signals.push({
                    name: 'VIX Index',
                    currentValue: vixData.value,
                    action: vixData.value < 15 ? 'BUY PROTECTION' : vixData.value > 30 ? 'SELL' : 'HOLD',
                    signal: vixData.value < 15 ? 'Low Volatility' : vixData.value > 30 ? 'High Fear' : 'Normal',
                    target: vixData.value < 15 ? 20 : vixData.value > 30 ? 20 : vixData.value
                });
            }
            
            // Add more signals based on available data
            if (currentData['DGS10']) {
                const yieldData = currentData['DGS10'];
                signals.push({
                    name: '10-Year Treasury',
                    currentValue: yieldData.value,
                    action: yieldData.dayChange > 5 ? 'SELL BONDS' : yieldData.dayChange < -5 ? 'BUY BONDS' : 'HOLD',
                    signal: `${yieldData.dayChange > 0 ? 'Rising' : 'Falling'} Yields`,
                    target: yieldData.value
                });
            }
            
            grid.innerHTML = signals.map(signal => {
                const actionColor = signal.action.includes('BUY') ? '#00ff88' : 
                                  signal.action.includes('SELL') ? '#ff4444' : '#ffc107';
                
                return `
                    <div class="metric-card">
                        <div class="metric-header">
                            <div class="metric-title">${signal.name}</div>
                            <span style="background: ${actionColor}20; color: ${actionColor}; 
                                       padding: 0.25rem 0.75rem; border-radius: 20px; font-weight: 600;">
                                ${signal.action}
                            </span>
                        </div>
                        <div class="metric-value">${signal.currentValue.toFixed(2)}</div>
                        <div style="margin: 1rem 0; font-size: 0.9rem;">
                            <div>Signal: <strong>${signal.signal}</strong></div>
                            <div>Target: <strong>${signal.target.toFixed(2)}</strong></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update Main Chart
        function updateMainChart() {
            const traces = [];
            
            // Add VIX to chart
            if (historicalData['VIXCLS']) {
                const data = filterDataByTimeframe(historicalData['VIXCLS'], currentTimeframe);
                traces.push({
                    x: data.map(d => d.date),
                    y: data.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'VIX',
                    yaxis: 'y',
                    line: { color: '#00ff88', width: 2 }
                });
            }
            
            // Add 10Y Treasury to chart
            if (historicalData['DGS10']) {
                const data = filterDataByTimeframe(historicalData['DGS10'], currentTimeframe);
                traces.push({
                    x: data.map(d => d.date),
                    y: data.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: '10Y Treasury',
                    yaxis: 'y2',
                    line: { color: '#00d4ff', width: 2 }
                });
            }
            
            const layout = {
                title: 'Market Overview - Real FRED Data',
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'VIX Index',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    titlefont: { color: '#00ff88' }
                },
                yaxis2: {
                    title: '10Y Treasury Yield (%)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' },
                    titlefont: { color: '#00d4ff' }
                },
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    y: -0.15
                }
            };
            
            Plotly.newPlot('mainChart', traces, layout, { responsive: true });
        }

        // Filter data by timeframe
        function filterDataByTimeframe(data, timeframe) {
            if (!data || data.length === 0) return [];
            
            const now = new Date();
            const cutoffDate = new Date();
            
            switch(timeframe) {
                case '1M': cutoffDate.setMonth(now.getMonth() - 1); break;
                case '3M': cutoffDate.setMonth(now.getMonth() - 3); break;
                case '6M': cutoffDate.setMonth(now.getMonth() - 6); break;
                case '1Y': cutoffDate.setFullYear(now.getFullYear() - 1); break;
                case '5Y': cutoffDate.setFullYear(now.getFullYear() - 5); break;
                case '10Y': cutoffDate.setFullYear(now.getFullYear() - 10); break;
                case '20Y': cutoffDate.setFullYear(now.getFullYear() - 20); break;
                case 'MAX': return data;
            }
            
            return data.filter(d => new Date(d.date) >= cutoffDate);
        }

        // Show Historical Data
        function showHistoricalData(series, name) {
            const modal = document.getElementById('historicalModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalChart = document.getElementById('modalChart');
            
            modalTitle.textContent = `${name} - Historical Data (Since 1990)`;
            modal.classList.add('active');
            
            // Fetch more historical data if needed
            fetchExtendedHistory(series).then(() => {
                const data = historicalData[series];
                if (data && data.length > 0) {
                    const trace = {
                        x: data.map(d => d.date),
                        y: data.map(d => d.value),
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#00ff88', width: 2 }
                    };
                    
                    const layout = {
                        xaxis: {
                            gridcolor: 'rgba(255, 255, 255, 0.1)',
                            tickfont: { color: '#888' },
                            rangeslider: { visible: true }
                        },
                        yaxis: {
                            gridcolor: 'rgba(255, 255, 255, 0.1)',
                            tickfont: { color: '#888' },
                            title: INDICATORS[getIndicatorCategory(series)][series].units
                        },
                        paper_bgcolor: 'rgba(0, 0, 0, 0)',
                        plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                        font: { color: '#fff' }
                    };
                    
                    Plotly.newPlot(modalChart, [trace], layout, { responsive: true });
                }
            });
        }

        // Fetch extended history (from 1990)
        async function fetchExtendedHistory(series) {
            const startDate = '1990-01-01';
            const endDate = new Date().toISOString().split('T')[0];
            
            const data = await fetchFREDData(series, startDate, endDate);
            return data;
        }

        // Get indicator category
        function getIndicatorCategory(series) {
            for (const [category, indicators] of Object.entries(INDICATORS)) {
                if (indicators[series]) return category;
            }
            return 'overview';
        }

        // Close Modal
        function closeModal() {
            document.getElementById('historicalModal').classList.remove('active');
        }

        // Format Value based on units
        function formatValue(value, units) {
            if (!value && value !== 0) return 'N/A';
            
            if (units.includes('Billions')) {
                return (value / 1000).toFixed(2) + 'T';
            } else if (units.includes('Millions')) {
                return (value / 1000000).toFixed(2) + 'T';
            } else if (units.includes('Percent')) {
                return value.toFixed(3) + '%';
            } else if (units.includes('$/')) {
                return '  + value.toFixed(2);
            } else if (units.includes('Index')) {
                return value.toFixed(2);
            } else {
                return value.toFixed(2);
            }
        }

        // Edit Indicator Name
        function editIndicatorName(series, currentName) {
            const newName = prompt('Enter new name for indicator:', currentName);
            if (newName && newName !== currentName) {
                customIndicators[series] = newName;
                localStorage.setItem('customIndicators', JSON.stringify(customIndicators));
                
                // Refresh current tab
                const activeTab = document.querySelector('.tab-content.active').id;
                switch(activeTab) {
                    case 'overview': updateOverviewTab(); break;
                    case 'heatmap': updateHeatmap(); break;
                    case 'fed': updateFedTab(); break;
                    case 'blackswan': updateBlackSwanTab(); break;
                    case 'liquidity': updateLiquidityTab(); break;
                    case 'currencies': updateCurrenciesTab(); break;
                    case 'credit': updateCreditTab(); break;
                    case 'crisis': updateCrisisTab(); break;
                }
            }
        }

        // Tab Navigation
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                
                // Update active states
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(tab).classList.add('active');
            });
        });

        // Timeframe Buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeframe-btn')) {
                const timeframe = e.target.dataset.timeframe;
                currentTimeframe = timeframe;
                
                // Update active state
                e.target.parentElement.querySelectorAll('.timeframe-btn').forEach(b => 
                    b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Refresh chart
                updateMainChart();
            }
        });

        // Heatmap Period Buttons
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('heatmap-btn') && e.target.dataset.period) {
                currentPeriod = e.target.dataset.period;
                
                // Update active state
                document.querySelectorAll('.heatmap-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Refresh heatmap
                updateHeatmap();
            }
        });

        // Layout Selector
        document.querySelectorAll('.layout-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                currentLayout = btn.dataset.layout;
                
                // Update active state
                document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Apply layout
                applyLayout(currentLayout);
            });
        });

        // Apply Layout
        function applyLayout(layout) {
            const layouts = {
                default: 'overview',
                risk: 'crisis',
                macro: 'fed'
            };
            
            // Switch to appropriate tab
            const targetTab = layouts[layout] || 'overview';
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(targetTab).classList.add('active');
            
            // Update tab navigation
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-tab="${targetTab}"]`).classList.add('active');
        }

        // Global Search
        const searchBar = document.getElementById('globalSearch');
        const searchResults = document.getElementById('searchResults');
        
        searchBar.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            const results = [];
            
            // Search through all indicators
            Object.values(INDICATORS).forEach(category => {
                Object.entries(category).forEach(([series, info]) => {
                    const name = customIndicators[series] || info.name;
                    if (name.toLowerCase().includes(query) || series.toLowerCase().includes(query)) {
                        results.push({ series, name, category: info.category });
                    }
                });
            });
            
            if (results.length > 0) {
                searchResults.innerHTML = results.map(r => `
                    <div class="search-result-item" onclick="showHistoricalData('${r.series}', '${r.name}')">
                        <strong>${r.name}</strong>
                        <span style="float: right; color: #666;">${r.series}</span>
                    </div>
                `).join('');
                searchResults.style.display = 'block';
            } else {
                searchResults.style.display = 'none';
            }
        });

        // Click outside search to close
        document.addEventListener('click', (e) => {
            if (!searchBar.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Export Functions
        function exportToPDF() {
            if (typeof jspdf !== 'undefined') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('FRED Financial Data Report', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
                
                let y = 50;
                Object.entries(currentData).forEach(([series, data]) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    const info = Object.values(INDICATORS).flatMap(cat => Object.entries(cat))
                                       .find(([s]) => s === series)?.[1];
                    const name = customIndicators[series] || info?.name || series;
                    
                    doc.text(`${name}: ${formatValue(data.value, info?.units || '')} (${data.dayChange > 0 ? '+' : ''}${data.dayChange.toFixed(2)}%)`, 20, y);
                    y += 10;
                });
                
                doc.save('fred_financial_report.pdf');
            }
        }

        function exportToExcel() {
            const ws_data = [['Indicator', 'Series ID', 'Value', 'Day Change %', 'Week Change %', 'Month Change %', 'Year Change %', 'Date']];
            
            Object.entries(currentData).forEach(([series, data]) => {
                const info = Object.values(INDICATORS).flatMap(cat => Object.entries(cat))
                                   .find(([s]) => s === series)?.[1];
                const name = customIndicators[series] || info?.name || series;
                
                ws_data.push([
                    name, 
                    series,
                    data.value, 
                    data.dayChange, 
                    data.weekChange,
                    data.monthChange,
                    data.yearChange,
                    data.date
                ]);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'FRED Data');
            
            XLSX.writeFile(wb, 'fred_data.xlsx');
        }

        function exportToJSON() {
            const exportData = {
                timestamp: new Date().toISOString(),
                data: currentData,
                historical: historicalData,
                customIndicators: customIndicators
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                                 { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'fred_data.json';
            a.click();
        }

        // Alert Panel Functions
        function toggleAlertPanel() {
            const panel = document.getElementById('alertPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                alertManager.updateAlertPanel();
            }
        }

        function addNewAlert() {
            const indicator = prompt('Enter FRED series ID (e.g., VIXCLS, DGS10):');
            if (!indicator) return;
            
            const condition = prompt('Enter condition (above/below/change):');
            if (!condition) return;
            
            const threshold = parseFloat(prompt('Enter threshold value:'));
            if (isNaN(threshold)) return;
            
            const action = 'notify'; // For browser notifications
            
            alertManager.addAlert(indicator, condition, threshold, action);
            alert('Alert added successfully!');
        }

        // Refresh Functions
        function refreshHeatmap() {
            updateHeatmap();
        }

        function addIndicatorToChart() {
            const indicator = prompt('Enter FRED series ID to add (e.g., SP500, NASDAQCOM):');
            if (indicator && historicalData[indicator]) {
                const data = filterDataByTimeframe(historicalData[indicator], currentTimeframe);
                const info = Object.values(INDICATORS).flatMap(cat => Object.entries(cat))
                                   .find(([s]) => s === indicator)?.[1];
                
                const trace = {
                    x: data.map(d => d.date),
                    y: data.map(d => d.value),
                    type: 'scatter',
                    mode: 'lines',
                    name: customIndicators[indicator] || info?.name || indicator
                };
                
                Plotly.addTraces('comparisonChart', [trace]);
            } else {
                alert('Series not found. Please load it first or check the series ID.');
            }
        }

        // Initialize Comparison Chart
        function initComparisonChart() {
            const layout = {
                title: 'Indicator Comparison',
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                showlegend: true
            };
            
            Plotly.newPlot('comparisonChart', [], layout, { responsive: true });
        }

        // Auto-refresh function
        function startAutoRefresh() {
            // Refresh every 5 minutes (FRED data doesn't update that frequently)
            setInterval(() => {
                console.log('Auto-refreshing data...');
                loadAllData();
            }, 300000); // 5 minutes
        }

        // Initialize Dashboard
        async function init() {
            console.log('Initializing FRED Dashboard...');
            
            // Check if API key is set
            if (FRED_API_KEY === 'YOUR_FRED_API_KEY_HERE') {
                alert('Please add your FRED API key to the code. Get one free at: https://fred.stlouisfed.org/docs/api/api_key.html');
                
                // Update API status
                const apiStatus = document.getElementById('apiStatus');
                apiStatus.textContent = 'API: No Key';
                apiStatus.classList.add('error');
                return;
            }
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Initialize comparison chart
            initComparisonChart();
            
            // Load all data
            await loadAllData();
            
            // Start auto-refresh
            startAutoRefresh();
            
            console.log('Dashboard initialized successfully');
        }

        // Start the application
        init();
    </script>
</body>
</html>
