<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy Dashboard - 72 Indicators</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border: #dee2e6;
            --accent: #0066cc;
            --positive: #28a745;
            --negative: #dc3545;
            --neutral: #6c757d;
            --shadow: rgba(0,0,0,0.1);
            --hover: #f1f3f5;
            --edit-bg: #fff3cd;
            --drag-bg: rgba(0,102,204,0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #242424;
            --text-primary: #e4e4e4;
            --text-secondary: #a0a0a0;
            --border: #404040;
            --accent: #4a9eff;
            --positive: #52c41a;
            --negative: #ff4d4f;
            --neutral: #8c8c8c;
            --shadow: rgba(0,0,0,0.3);
            --hover: #333333;
            --edit-bg: #3a3a1a;
            --drag-bg: rgba(74,158,255,0.1);
        }

        [data-theme="ocean"] {
            --bg-primary: #0a1929;
            --bg-secondary: #001e3c;
            --bg-card: #132f4c;
            --text-primary: #b2bac2;
            --text-secondary: #5090d3;
            --border: #265d97;
            --accent: #5090d3;
            --positive: #66bb6a;
            --negative: #f44336;
            --neutral: #81c784;
            --shadow: rgba(0,0,0,0.4);
            --hover: #173a5e;
            --edit-bg: #1e4976;
            --drag-bg: rgba(80,144,211,0.2);
        }

        [data-theme="forest"] {
            --bg-primary: #1a1f16;
            --bg-secondary: #242b1f;
            --bg-card: #2d3428;
            --text-primary: #c8d5b9;
            --text-secondary: #8fa778;
            --border: #4a5842;
            --accent: #7cb342;
            --positive: #8bc34a;
            --negative: #ef5350;
            --neutral: #90a4ae;
            --shadow: rgba(0,0,0,0.4);
            --hover: #3e4637;
            --edit-bg: #4a5842;
            --drag-bg: rgba(124,179,66,0.2);
        }

        [data-theme="sunset"] {
            --bg-primary: #2d1b69;
            --bg-secondary: #3d2973;
            --bg-card: #4a337d;
            --text-primary: #f4e4c1;
            --text-secondary: #d4a574;
            --border: #6b4984;
            --accent: #ff6b6b;
            --positive: #4ecdc4;
            --negative: #ff6b6b;
            --neutral: #95a5a6;
            --shadow: rgba(0,0,0,0.4);
            --hover: #5a4187;
            --edit-bg: #6b4984;
            --drag-bg: rgba(255,107,107,0.2);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Density Modes */
        [data-density="compact"] {
            font-size: 14px;
        }

        [data-density="comfortable"] {
            font-size: 16px;
        }

        [data-density="spacious"] {
            font-size: 18px;
        }

        [data-density="compact"] .indicator-card {
            padding: 0.75rem;
        }

        [data-density="spacious"] .indicator-card {
            padding: 1.5rem;
        }

        .header {
            background: var(--bg-secondary);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn:hover {
            background: var(--hover);
            transform: translateY(-1px);
        }

        .btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .theme-selector, .density-selector {
            padding: 0.4rem 0.8rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .last-update {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--drag-bg);
        }

        .view-controls {
            display: flex;
            gap: 0.5rem;
        }

        .card-size-btn {
            padding: 0.4rem 0.6rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .card-size-btn:hover {
            background: var(--hover);
        }

        .card-size-btn.active {
            background: var(--accent);
            color: white;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .tab:hover {
            background: var(--hover);
        }

        .tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .sort-controls {
            display: flex;
            gap: 0.5rem;
        }

        .indicators-grid {
            display: grid;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .indicators-grid.small {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .indicators-grid.medium {
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
        }

        .indicators-grid.large {
            grid-template-columns: repeat(auto-fill, minmax(500px, 1fr));
        }

        .indicator-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            box-shadow: 0 1px 3px var(--shadow);
            transition: all 0.2s;
            position: relative;
            cursor: move;
        }

        .indicator-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            background: var(--drag-bg);
        }

        .indicator-card.drag-over {
            border: 2px dashed var(--accent);
            background: var(--drag-bg);
        }

        .indicator-card:hover {
            box-shadow: 0 4px 12px var(--shadow);
            transform: translateY(-2px);
        }

        .indicator-card.has-notes {
            border-left: 4px solid var(--accent);
        }

        .indicator-card.selected {
            border: 2px solid var(--accent);
            box-shadow: 0 0 0 3px var(--drag-bg);
        }

        .indicator-card.small .notes-section,
        .indicator-card.small .indicator-original-name {
            display: none;
        }

        .indicator-card.small .changes-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.25rem;
        }

        .indicator-card.small .indicator-value {
            font-size: 1.5rem;
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .indicator-title {
            flex: 1;
            margin-right: 0.5rem;
        }

        .indicator-code {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--accent);
            margin-bottom: 0.25rem;
        }

        .indicator-name-input {
            width: 100%;
            font-size: 0.875rem;
            color: var(--text-primary);
            background: transparent;
            border: 1px solid transparent;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s;
            font-weight: 500;
        }

        .indicator-name-input:hover {
            background: var(--hover);
            border-color: var(--border);
        }

        .indicator-name-input:focus {
            outline: none;
            background: var(--edit-bg);
            border-color: var(--accent);
        }

        .indicator-actions {
            display: flex;
            gap: 0.25rem;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            color: var(--text-secondary);
            padding: 0.25rem;
        }

        .action-btn:hover {
            transform: scale(1.2);
        }

        .action-btn.active {
            color: var(--accent);
        }

        .favorite-btn.active {
            color: #ffc107;
        }

        .indicator-value {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .changes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .change-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.375rem 0.5rem;
            background: var(--bg-secondary);
            border-radius: 0.25rem;
        }

        .change-value.positive {
            color: var(--positive);
        }

        .change-value.negative {
            color: var(--negative);
        }

        .notes-section {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border);
        }

        .notes-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.5rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 0.25rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            font-family: inherit;
        }

        /* Full Screen Mode */
        .fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 1000;
            padding: 2rem;
            overflow-y: auto;
        }

        .fullscreen-modal.active {
            display: block;
        }

        .fullscreen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .fullscreen-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .fullscreen-indicator {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .fullscreen-chart {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }

        /* Split Screen Comparison */
        .split-screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 999;
        }

        .split-screen.active {
            display: flex;
            flex-direction: column;
        }

        .split-header {
            background: var(--bg-secondary);
            padding: 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .split-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .split-pane {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            border-right: 1px solid var(--border);
        }

        .split-pane:last-child {
            border-right: none;
        }

        .comparison-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        /* Keyboard Shortcuts Modal */
        .shortcuts-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 10px 40px var(--shadow);
            z-index: 1001;
            max-width: 500px;
            width: 90%;
        }

        .shortcuts-modal.active {
            display: block;
        }

        .shortcuts-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-key {
            background: var(--bg-secondary);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            color: var(--accent);
        }

        /* Loading and Status */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .save-indicator {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--positive);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
            pointer-events: none;
            z-index: 1000;
        }

        .save-indicator.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Navigation Helper */
        .nav-helper {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            z-index: 100;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .nav-helper.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .indicators-grid {
                grid-template-columns: 1fr !important;
            }

            .header-content {
                flex-direction: column;
            }

            .split-content {
                flex-direction: column;
            }

            .split-pane {
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
        }
    </style>
</head>
<body data-density="comfortable">
    <div class="header">
        <div class="header-content">
            <div>
                <h1>Economy Dashboard</h1>
                <div class="last-update" id="lastUpdate">Loading...</div>
            </div>
            <div class="header-controls">
                <button class="btn" onclick="toggleSplitScreen()">
                    ‚ö° Compare
                </button>
                <button class="btn" onclick="showShortcuts()">
                    ‚å®Ô∏è Shortcuts
                </button>
                <select class="theme-selector" id="themeSelector" onchange="changeTheme(this.value)">
                    <option value="light">‚òÄÔ∏è Light</option>
                    <option value="dark">üåô Dark</option>
                    <option value="ocean">üåä Ocean</option>
                    <option value="forest">üå≤ Forest</option>
                    <option value="sunset">üåÖ Sunset</option>
                </select>
                <select class="density-selector" id="densitySelector" onchange="changeDensity(this.value)">
                    <option value="compact">Compact</option>
                    <option value="comfortable" selected>Comfortable</option>
                    <option value="spacious">Spacious</option>
                </select>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="controls">
            <input type="text" class="search-box" id="searchBox" placeholder="Search indicators (Press /)...">
            <div class="view-controls">
                <button class="card-size-btn" data-size="small" onclick="changeCardSize('small')">S</button>
                <button class="card-size-btn active" data-size="medium" onclick="changeCardSize('medium')">M</button>
                <button class="card-size-btn" data-size="large" onclick="changeCardSize('large')">L</button>
            </div>
            <div class="sort-controls">
                <select class="btn" id="sortBy">
                    <option value="name">Sort by Name</option>
                    <option value="value">Sort by Value</option>
                    <option value="week">Sort by Week %</option>
                    <option value="month">Sort by Month %</option>
                    <option value="quarter">Sort by Quarter %</option>
                    <option value="year">Sort by Year %</option>
                    <option value="custom">Custom Order</option>
                </select>
                <button class="btn" id="sortOrder" onclick="toggleSortOrder()">‚Üì</button>
            </div>
        </div>

        <div class="tabs" id="categoryTabs">
            <div class="tab active" data-category="all">All (72)</div>
            <div class="tab" data-category="favorites">‚≠ê Favorites</div>
            <div class="tab" data-category="oil">Oil & Energy</div>
            <div class="tab" data-category="volatility">Volatility</div>
            <div class="tab" data-category="employment">Employment</div>
            <div class="tab" data-category="exchange">Exchange Rates</div>
            <div class="tab" data-category="treasury">Treasury</div>
            <div class="tab" data-category="industrial">Industrial</div>
            <div class="tab" data-category="oecd">OECD</div>
        </div>

        <div id="content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading 72 indicators from EconomyAPI...</p>
            </div>
        </div>
    </div>

    <!-- Full Screen Modal -->
    <div class="fullscreen-modal" id="fullscreenModal">
        <div class="fullscreen-header">
            <h2 id="fullscreenTitle">Indicator Details</h2>
            <button class="btn" onclick="closeFullscreen()">‚úï Close</button>
        </div>
        <div class="fullscreen-content" id="fullscreenContent"></div>
    </div>

    <!-- Split Screen Comparison -->
    <div class="split-screen" id="splitScreen">
        <div class="split-header">
            <h2>Comparison View</h2>
            <div>
                <span id="comparisonCount">0 indicators selected</span>
                <button class="btn" onclick="closeSplitScreen()">‚úï Close</button>
            </div>
        </div>
        <div class="split-content" id="splitContent"></div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcutsModal">
        <h3 class="shortcuts-title">‚å®Ô∏è Keyboard Shortcuts</h3>
        <div class="shortcut-item">
            <span>Search</span>
            <span class="shortcut-key">/</span>
        </div>
        <div class="shortcut-item">
            <span>Navigate Down</span>
            <span class="shortcut-key">J</span>
        </div>
        <div class="shortcut-item">
            <span>Navigate Up</span>
            <span class="shortcut-key">K</span>
        </div>
        <div class="shortcut-item">
            <span>Select/Deselect</span>
            <span class="shortcut-key">Space</span>
        </div>
        <div class="shortcut-item">
            <span>Open Fullscreen</span>
            <span class="shortcut-key">Enter</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Favorite</span>
            <span class="shortcut-key">F</span>
        </div>
        <div class="shortcut-item">
            <span>Compare Mode</span>
            <span class="shortcut-key">C</span>
        </div>
        <div class="shortcut-item">
            <span>Export Data</span>
            <span class="shortcut-key">Ctrl+E</span>
        </div>
        <div class="shortcut-item">
            <span>Toggle Theme</span>
            <span class="shortcut-key">T</span>
        </div>
        <div class="shortcut-item">
            <span>Card Size (S/M/L)</span>
            <span class="shortcut-key">1/2/3</span>
        </div>
        <div class="shortcut-item">
            <span>Close Modal</span>
            <span class="shortcut-key">Esc</span>
        </div>
        <button class="btn" onclick="closeShortcuts()" style="width: 100%; margin-top: 1rem;">Close</button>
    </div>

    <div class="save-indicator" id="saveIndicator">‚úì Saved</div>
    <div class="nav-helper" id="navHelper">Use J/K to navigate ‚Ä¢ Space to select ‚Ä¢ Enter to view</div>

    <script>
        // API Configuration
        const API_URL = 'https://v3eyrgp4ih.execute-api.us-east-1.amazonaws.com';
        
        // Categories mapping
        const CATEGORIES = {
            oil: ['DCOILWTICO'],
            volatility: ['VXVCLS', 'VIXCLS'],
            employment: ['UNRATE', 'LNS14000006', 'LNU04000006', 'LNS14000031', 'LNU04000031', 
                        'LNS14000009', 'LNU04000009', 'LNU04000034', 'UNEMPLOY', 'LNS14000024',
                        'U5RATE', 'U6RATE', 'UEMPMEAN', 'LRHUTTTTUSM156S', 'LRUN64TTUSQ156S', 'LRUN24TTUSM156S'],
            exchange: ['DEXSFUS', 'DEXMXUS', 'DEXKOUS', 'DEXJPUS', 'DEXINUS', 'DEXUSUK',
                      'DEXUSEU', 'DEXCHUS', 'DEXSZUS', 'DEXCAUS', 'DEXBZUS', 'DEXUSAL'],
            treasury: ['TREAST', 'SWPT', 'TREAS10Y', 'TREAS1T5', 'TREAS1590', 'TREAS5T10',
                      'MBS10Y', 'TREAS911Y', 'TREAS15', 'RESPPALGUONNWW', 'TERMT', 'RESPPALGUOXCH1NWW',
                      'SWP1690', 'FEDD5T10', 'H41RESPPLLDENWW', 'OTHL1690', 'SWP15', 'OTHL15',
                      'OTHL1T5', 'RESPPALGUOXAWXCH52NWW', 'REP1690', 'RESPPALGUMD16T90XCH1NWW',
                      'OTHL91T1Y', 'RESPPALGUMXCH1NWW', 'RESH4FXAWXCH52NWW'],
            industrial: ['INDPRO', 'IPMAN', 'IPDMAN', 'IPG339S', 'MANEMP', 'TCU', 'IPB50001N', 'CAPB50001SQ'],
            oecd: ['USALOLITOAASTSAM', 'G7LOLITOAASTSAM', 'CHNLOLITOAASTSAM', 'GBRLOLITOAASTSAM',
                   'LRHUTTTTGBM156S', 'LRUNTTTTCAQ156S', 'LRHUTTTTGRM156S', 'LRUN64TTGRA156N']
        };

        // State management
        let allData = {};
        let originalNames = {};
        let customNames = JSON.parse(localStorage.getItem('economyCustomNames') || '{}');
        let favorites = JSON.parse(localStorage.getItem('economyFavorites') || '[]');
        let notes = JSON.parse(localStorage.getItem('economyNotes') || '{}');
        let customOrder = JSON.parse(localStorage.getItem('economyCustomOrder') || '[]');
        let currentCategory = 'all';
        let sortBy = 'name';
        let sortOrder = 'asc';
        let searchTerm = '';
        let cardSize = 'medium';
        let selectedIndicators = new Set();
        let currentNavigationIndex = -1;
        let draggedElement = null;

        // Initialize
        function init() {
            const savedTheme = localStorage.getItem('economyTheme') || 'light';
            const savedDensity = localStorage.getItem('economyDensity') || 'comfortable';
            const savedCardSize = localStorage.getItem('economyCardSize') || 'medium';
            
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.documentElement.setAttribute('data-density', savedDensity);
            document.getElementById('themeSelector').value = savedTheme;
            document.getElementById('densitySelector').value = savedDensity;
            cardSize = savedCardSize;
            
            updateCardSizeButtons();
            setupKeyboardShortcuts();
            setupEventListeners();
            fetchAllIndicators();
        }

        // Theme Management
        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('economyTheme', theme);
            showSaveIndicator('‚úì Theme changed');
        }

        // Density Management
        function changeDensity(density) {
            document.documentElement.setAttribute('data-density', density);
            localStorage.setItem('economyDensity', density);
            showSaveIndicator('‚úì Density changed');
        }

        // Card Size Management
        function changeCardSize(size) {
            cardSize = size;
            localStorage.setItem('economyCardSize', size);
            updateCardSizeButtons();
            updateDisplay();
            showSaveIndicator(`‚úì Card size: ${size}`);
        }

        function updateCardSizeButtons() {
            document.querySelectorAll('.card-size-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.size === cardSize);
            });
        }

        // Keyboard Shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    if (e.key === 'Escape') {
                        e.target.blur();
                    }
                    return;
                }

                // Search shortcut
                if (e.key === '/') {
                    e.preventDefault();
                    document.getElementById('searchBox').focus();
                }

                // Navigation shortcuts
                if (e.key === 'j' || e.key === 'J') {
                    e.preventDefault();
                    navigateCards(1);
                }

                if (e.key === 'k' || e.key === 'K') {
                    e.preventDefault();
                    navigateCards(-1);
                }

                // Selection
                if (e.key === ' ') {
                    e.preventDefault();
                    toggleSelection();
                }

                // Enter for fullscreen
                if (e.key === 'Enter' && currentNavigationIndex >= 0) {
                    e.preventDefault();
                    const cards = document.querySelectorAll('.indicator-card');
                    if (cards[currentNavigationIndex]) {
                        const series = cards[currentNavigationIndex].dataset.series;
                        openFullscreen(series);
                    }
                }

                // Favorite toggle
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    if (currentNavigationIndex >= 0) {
                        const cards = document.querySelectorAll('.indicator-card');
                        const series = cards[currentNavigationIndex]?.dataset.series;
                        if (series) toggleFavorite(series);
                    }
                }

                // Compare mode
                if (e.key === 'c' || e.key === 'C') {
                    e.preventDefault();
                    toggleSplitScreen();
                }

                // Export
                if (e.ctrlKey && e.key === 'e') {
                    e.preventDefault();
                    exportData();
                }

                // Theme toggle
                if (e.key === 't' || e.key === 'T') {
                    e.preventDefault();
                    toggleTheme();
                }

                // Card sizes
                if (e.key === '1') changeCardSize('small');
                if (e.key === '2') changeCardSize('medium');
                if (e.key === '3') changeCardSize('large');

                // Escape to close modals
                if (e.key === 'Escape') {
                    closeFullscreen();
                    closeSplitScreen();
                    closeShortcuts();
                }

                // Show shortcuts
                if (e.key === '?') {
                    e.preventDefault();
                    showShortcuts();
                }
            });
        }

        // Navigation Functions
        function navigateCards(direction) {
            const cards = document.querySelectorAll('.indicator-card');
            if (cards.length === 0) return;

            // Show helper on first navigation
            if (currentNavigationIndex === -1) {
                document.getElementById('navHelper').classList.add('active');
                setTimeout(() => {
                    document.getElementById('navHelper').classList.remove('active');
                }, 3000);
            }

            currentNavigationIndex += direction;
            if (currentNavigationIndex < 0) currentNavigationIndex = cards.length - 1;
            if (currentNavigationIndex >= cards.length) currentNavigationIndex = 0;

            cards.forEach((card, index) => {
                card.classList.toggle('selected', index === currentNavigationIndex);
                if (index === currentNavigationIndex) {
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            });
        }

        function toggleSelection() {
            if (currentNavigationIndex < 0) return;
            const cards = document.querySelectorAll('.indicator-card');
            const card = cards[currentNavigationIndex];
            if (!card) return;

            const series = card.dataset.series;
            if (selectedIndicators.has(series)) {
                selectedIndicators.delete(series);
            } else {
                selectedIndicators.add(series);
            }
            
            updateComparisonCount();
            showSaveIndicator(`${selectedIndicators.size} selected for comparison`);
        }

        // Drag and Drop
        function setupDragAndDrop() {
            const grid = document.querySelector('.indicators-grid');
            if (!grid) return;

            const cards = grid.querySelectorAll('.indicator-card');
            
            cards.forEach((card, index) => {
                card.draggable = true;
                card.dataset.order = customOrder.indexOf(card.dataset.series) !== -1 
                    ? customOrder.indexOf(card.dataset.series) 
                    : index;

                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.indicator-card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedSeries = draggedElement.dataset.series;
                const targetSeries = this.dataset.series;
                
                // Update custom order
                const allCards = Array.from(document.querySelectorAll('.indicator-card'));
                const draggedIndex = allCards.indexOf(draggedElement);
                const targetIndex = allCards.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
                
                // Save new order
                saveCustomOrder();
            }

            return false;
        }

        function saveCustomOrder() {
            const cards = document.querySelectorAll('.indicator-card');
            customOrder = Array.from(cards).map(card => card.dataset.series);
            localStorage.setItem('economyCustomOrder', JSON.stringify(customOrder));
            showSaveIndicator('‚úì Order saved');
        }

        // Full Screen Mode
        function openFullscreen(series) {
            const data = allData[series];
            if (!data) return;

            const modal = document.getElementById('fullscreenModal');
            const title = document.getElementById('fullscreenTitle');
            const content = document.getElementById('fullscreenContent');
            
            const latest = data.data[0];
            const customName = customNames[series] || originalNames[series] || data.description;
            
            title.textContent = `${series} - ${customName}`;
            
            content.innerHTML = `
                <div class="fullscreen-indicator">
                    <div>
                        <div class="comparison-card">
                            <h3>Current Value</h3>
                            <div style="font-size: 3rem; font-weight: bold; color: var(--accent);">
                                ${formatValue(latest.value, series)}
                            </div>
                            <div style="color: var(--text-secondary); margin-top: 1rem;">
                                As of ${latest.date}
                            </div>
                        </div>
                        
                        <div class="comparison-card" style="margin-top: 1rem;">
                            <h3>Percentage Changes</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-top: 1rem;">
                                ${renderFullscreenChange('Week', latest.percentage_changes?.week_change)}
                                ${renderFullscreenChange('Month', latest.percentage_changes?.month_change)}
                                ${renderFullscreenChange('Quarter', latest.percentage_changes?.quarter_change)}
                                ${renderFullscreenChange('Year', latest.percentage_changes?.year_change)}
                            </div>
                        </div>
                        
                        <div class="comparison-card" style="margin-top: 1rem;">
                            <h3>Notes</h3>
                            <textarea class="notes-textarea" style="min-height: 150px;"
                                      onchange="saveNote('${series}', this.value)">${notes[series] || ''}</textarea>
                        </div>
                    </div>
                    
                    <div>
                        <div class="fullscreen-chart">
                            <div>üìä Chart placeholder - Integrate with charting library</div>
                        </div>
                        
                        <div class="comparison-card" style="margin-top: 1rem;">
                            <h3>Historical Data</h3>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${data.data.slice(0, 10).map(d => `
                                    <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                                        <span>${d.date}</span>
                                        <span style="font-weight: 600;">${formatValue(d.value, series)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeFullscreen() {
            document.getElementById('fullscreenModal').classList.remove('active');
        }

        function renderFullscreenChange(label, value) {
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            const prefix = value > 0 ? '+' : '';
            const displayValue = value !== null && value !== undefined ? `${prefix}${value.toFixed(2)}%` : 'N/A';
            
            return `
                <div>
                    <div style="color: var(--text-secondary); font-size: 0.875rem;">${label}</div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: var(--${className});">
                        ${displayValue}
                    </div>
                </div>
            `;
        }

        // Split Screen Comparison
        function toggleSplitScreen() {
            const splitScreen = document.getElementById('splitScreen');
            if (splitScreen.classList.contains('active')) {
                closeSplitScreen();
            } else {
                openSplitScreen();
            }
        }

        function openSplitScreen() {
            const splitScreen = document.getElementById('splitScreen');
            const content = document.getElementById('splitContent');
            
            if (selectedIndicators.size === 0) {
                showSaveIndicator('‚ö†Ô∏è Select indicators first (use Space key)');
                return;
            }
            
            const indicators = Array.from(selectedIndicators);
            const panes = indicators.slice(0, 4).map(series => {
                const data = allData[series];
                if (!data) return '';
                
                const latest = data.data[0];
                const customName = customNames[series] || originalNames[series] || data.description;
                
                return `
                    <div class="split-pane">
                        <div class="comparison-card">
                            <h3>${series}</h3>
                            <div style="color: var(--text-secondary); margin-bottom: 1rem;">${customName}</div>
                            <div style="font-size: 2rem; font-weight: bold; margin-bottom: 1rem;">
                                ${formatValue(latest.value, series)}
                            </div>
                            <div style="display: grid; gap: 0.5rem;">
                                ${renderComparisonChange('Week', latest.percentage_changes?.week_change)}
                                ${renderComparisonChange('Month', latest.percentage_changes?.month_change)}
                                ${renderComparisonChange('Quarter', latest.percentage_changes?.quarter_change)}
                                ${renderComparisonChange('Year', latest.percentage_changes?.year_change)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = panes;
            updateComparisonCount();
            splitScreen.classList.add('active');
        }

        function closeSplitScreen() {
            document.getElementById('splitScreen').classList.remove('active');
            selectedIndicators.clear();
            updateComparisonCount();
            document.querySelectorAll('.indicator-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        function updateComparisonCount() {
            document.getElementById('comparisonCount').textContent = 
                `${selectedIndicators.size} indicator${selectedIndicators.size !== 1 ? 's' : ''} selected`;
        }

        function renderComparisonChange(label, value) {
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            const prefix = value > 0 ? '+' : '';
            const displayValue = value !== null && value !== undefined ? `${prefix}${value.toFixed(2)}%` : 'N/A';
            
            return `
                <div style="display: flex; justify-content: space-between; padding: 0.25rem 0;">
                    <span style="color: var(--text-secondary);">${label}:</span>
                    <span style="font-weight: 600; color: var(--${className});">${displayValue}</span>
                </div>
            `;
        }

        // Shortcuts Modal
        function showShortcuts() {
            document.getElementById('shortcutsModal').classList.add('active');
        }

        function closeShortcuts() {
            document.getElementById('shortcutsModal').classList.remove('active');
        }

        // Theme Toggle
        function toggleTheme() {
            const themes = ['light', 'dark', 'ocean', 'forest', 'sunset'];
            const current = document.documentElement.getAttribute('data-theme');
            const currentIndex = themes.indexOf(current);
            const nextIndex = (currentIndex + 1) % themes.length;
            changeTheme(themes[nextIndex]);
            document.getElementById('themeSelector').value = themes[nextIndex];
        }

        // Utility Functions
        function showSaveIndicator(message = '‚úì Saved') {
            const indicator = document.getElementById('saveIndicator');
            indicator.textContent = message;
            indicator.classList.add('show');
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        function formatValue(value, series) {
            if (value === null || value === undefined) return 'N/A';
            
            if (series.startsWith('DEX')) {
                return value.toFixed(4);
            }
            
            if (series.includes('RATE') || series === 'TCU') {
                return value.toFixed(2) + '%';
            }
            
            if (value > 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            }
            
            if (value > 1000) {
                return (value / 1000).toFixed(2) + 'K';
            }
            
            return value.toFixed(2);
        }

        function renderChange(label, value) {
            if (value === null || value === undefined) {
                return `
                    <div class="change-item">
                        <span class="change-label">${label}:</span>
                        <span class="change-value neutral">N/A</span>
                    </div>
                `;
            }
            
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
            const prefix = value > 0 ? '+' : '';
            
            return `
                <div class="change-item">
                    <span class="change-label">${label}:</span>
                    <span class="change-value ${className}">${prefix}${value.toFixed(2)}%</span>
                </div>
            `;
        }

        // Data Management
        async function fetchAllIndicators() {
            try {
                const indicatorsResponse = await fetch(`${API_URL}/indicators`);
                const indicatorsData = await indicatorsResponse.json();
                
                originalNames = indicatorsData.indicators;
                
                const promises = Object.keys(indicatorsData.indicators).map(async (series) => {
                    try {
                        const response = await fetch(`${API_URL}/economy?series=${series}`);
                        const data = await response.json();
                        return { series, data };
                    } catch (error) {
                        console.error(`Error fetching ${series}:`, error);
                        return null;
                    }
                });

                const results = await Promise.all(promises);
                
                allData = {};
                results.forEach(result => {
                    if (result && result.data && result.data.data && result.data.data.length > 0) {
                        allData[result.series] = result.data;
                    }
                });

                updateDisplay();
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleString()}`;
                
                localStorage.setItem('economyData', JSON.stringify(allData));
                localStorage.setItem('economyOriginalNames', JSON.stringify(originalNames));
                localStorage.setItem('economyLastUpdate', now.toISOString());
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('content').innerHTML = '<div class="error">Error loading data. Please try again later.</div>';
            }
        }

        function updateDisplay() {
            const container = document.getElementById('content');
            let indicators = Object.keys(allData);
            
            // Filter by search
            if (searchTerm) {
                indicators = indicators.filter(id => {
                    const customName = customNames[id] || '';
                    const originalName = originalNames[id] || '';
                    const note = notes[id] || '';
                    const searchLower = searchTerm.toLowerCase();
                    
                    return id.toLowerCase().includes(searchLower) ||
                           customName.toLowerCase().includes(searchLower) ||
                           originalName.toLowerCase().includes(searchLower) ||
                           note.toLowerCase().includes(searchLower);
                });
            }
            
            // Filter by category
            if (currentCategory === 'favorites') {
                indicators = indicators.filter(id => favorites.includes(id));
            } else if (currentCategory !== 'all') {
                indicators = indicators.filter(id => CATEGORIES[currentCategory]?.includes(id));
            }
            
            // Sort indicators
            if (sortBy === 'custom' && customOrder.length > 0) {
                indicators.sort((a, b) => {
                    const indexA = customOrder.indexOf(a);
                    const indexB = customOrder.indexOf(b);
                    if (indexA === -1 && indexB === -1) return 0;
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            } else {
                indicators.sort((a, b) => {
                    let compareA, compareB;
                    
                    if (sortBy === 'name') {
                        compareA = customNames[a] || originalNames[a] || a;
                        compareB = customNames[b] || originalNames[b] || b;
                    } else if (sortBy === 'value') {
                        compareA = allData[a]?.data?.[0]?.value || 0;
                        compareB = allData[b]?.data?.[0]?.value || 0;
                    } else {
                        const changeMap = {
                            'week': 'week_change',
                            'month': 'month_change',
                            'quarter': 'quarter_change',
                            'year': 'year_change'
                        };
                        const changeKey = changeMap[sortBy];
                        compareA = allData[a]?.data?.[0]?.percentage_changes?.[changeKey] || 0;
                        compareB = allData[b]?.data?.[0]?.percentage_changes?.[changeKey] || 0;
                    }
                    
                    if (typeof compareA === 'string') {
                        return sortOrder === 'asc' ? compareA.localeCompare(compareB) : compareB.localeCompare(compareA);
                    } else {
                        return sortOrder === 'asc' ? compareA - compareB : compareB - compareA;
                    }
                });
            }
            
            // Generate HTML
            if (indicators.length === 0) {
                container.innerHTML = '<div class="loading">No indicators found.</div>';
                return;
            }
            
            const html = indicators.map(series => {
                const data = allData[series];
                const latest = data?.data?.[0];
                if (!latest) return '';
                
                const isFavorite = favorites.includes(series);
                const note = notes[series] || '';
                const hasNote = note.trim() !== '';
                const customName = customNames[series] || originalNames[series] || data.description;
                const isSelected = selectedIndicators.has(series);
                
                return `
                    <div class="indicator-card ${cardSize} ${hasNote ? 'has-notes' : ''} ${isSelected ? 'selected' : ''}" 
                         data-series="${series}">
                        <div class="indicator-header">
                            <div class="indicator-title">
                                <div class="indicator-code">${series}</div>
                                <input type="text" 
                                       class="indicator-name-input" 
                                       value="${customName}"
                                       onchange="saveCustomName('${series}', this.value)">
                            </div>
                            <div class="indicator-actions">
                                <button class="action-btn" onclick="openFullscreen('${series}')" title="Fullscreen">
                                    üîç
                                </button>
                                <button class="action-btn favorite-btn ${isFavorite ? 'active' : ''}" 
                                        onclick="toggleFavorite('${series}')" title="Favorite">
                                    ${isFavorite ? '‚≠ê' : '‚òÜ'}
                                </button>
                            </div>
                        </div>
                        <div class="indicator-value">${formatValue(latest.value, series)}</div>
                        <div class="indicator-date">As of ${latest.date}</div>
                        <div class="changes-grid">
                            ${renderChange('Week', latest.percentage_changes?.week_change)}
                            ${renderChange('Month', latest.percentage_changes?.month_change)}
                            ${renderChange('Quarter', latest.percentage_changes?.quarter_change)}
                            ${renderChange('Year', latest.percentage_changes?.year_change)}
                        </div>
                        ${cardSize !== 'small' ? `
                            <div class="notes-section">
                                <textarea class="notes-textarea" 
                                          placeholder="Add notes..."
                                          onchange="saveNote('${series}', this.value)">${note}</textarea>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<div class="indicators-grid ${cardSize}">${html}</div>`;
            
            // Setup drag and drop after rendering
            setTimeout(setupDragAndDrop, 100);
        }

        function toggleFavorite(series) {
            const index = favorites.indexOf(series);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(series);
            }
            localStorage.setItem('economyFavorites', JSON.stringify(favorites));
            updateDisplay();
        }

        function saveCustomName(series, value) {
            if (value.trim() === '' || value === originalNames[series]) {
                delete customNames[series];
            } else {
                customNames[series] = value.trim();
            }
            localStorage.setItem('economyCustomNames', JSON.stringify(customNames));
        }

        function saveNote(series, value) {
            if (value.trim() === '') {
                delete notes[series];
            } else {
                notes[series] = value;
            }
            localStorage.setItem('economyNotes', JSON.stringify(notes));
            showSaveIndicator('‚úì Note saved');
        }

        function toggleSortOrder() {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            document.getElementById('sortOrder').textContent = sortOrder === 'asc' ? '‚Üë' : '‚Üì';
            updateDisplay();
        }

        function exportData() {
            const exportObj = {
                customNames,
                notes,
                favorites,
                customOrder,
                exportDate: new Date().toISOString(),
                indicators: {}
            };
            
            Object.keys(allData).forEach(series => {
                const latest = allData[series]?.data?.[0];
                if (latest) {
                    exportObj.indicators[series] = {
                        customName: customNames[series] || originalNames[series],
                        value: latest.value,
                        date: latest.date,
                        changes: latest.percentage_changes,
                        notes: notes[series] || ''
                    };
                }
            });
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `economy-dashboard-${new Date().toISOString().split('T')[0]}.json`);
            linkElement.click();
            
            showSaveIndicator('‚úì Data exported');
        }

        // Event Listeners
        function setupEventListeners() {
            // Category tabs
            document.getElementById('categoryTabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('tab')) {
                    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
                    e.target.classList.add('active');
                    currentCategory = e.target.dataset.category;
                    updateDisplay();
                }
            });
            
            // Sort dropdown
            document.getElementById('sortBy').addEventListener('change', (e) => {
                sortBy = e.target.value;
                updateDisplay();
            });
            
            // Search box
            document.getElementById('searchBox').addEventListener('input', (e) => {
                searchTerm = e.target.value;
                updateDisplay();
            });
            
            // Auto-update check
            setInterval(() => {
                const now = new Date();
                if (now.getDay() === 1 && now.getHours() === 9 && now.getMinutes() === 0) {
                    fetchAllIndicators();
                }
            }, 60000);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
