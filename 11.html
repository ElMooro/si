<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treasury Market Intelligence - Enhanced Crisis Detection System</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0f1c 0%, #1a1f2e 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .real-data-badge {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .api-status {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: blink 2s infinite;
        }

        .status-dot.connected {
            background: #4ade80;
        }

        .status-dot.error {
            background: #ff4444;
        }

        .status-dot.loading {
            background: #fbbf24;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 15px;
        }

        .tab {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #a0a0a0;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .security-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .security-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .security-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .security-title {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .metric {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .metric-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .metric-value.positive { color: #4ade80; }
        .metric-value.negative { color: #ff4444; }
        .metric-value.neutral { color: #fbbf24; }

        .crisis-comparison {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .crisis-similarity {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .similarity-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .similarity-card.high-match {
            border-color: #ff4444;
            animation: warningPulse 2s infinite;
        }

        @keyframes warningPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(255, 68, 68, 0); }
            50% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
        }

        .similarity-score {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 500px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .chart-btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .indicator-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .summary-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .pattern-detection {
            background: rgba(255, 68, 68, 0.1);
            border-left: 4px solid #ff4444;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .pattern-match {
            font-weight: bold;
            color: #ff4444;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #ffffff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>
                üèõÔ∏è Treasury Crisis Detection System
                <span class="real-data-badge">REAL DATA + PATTERN ANALYSIS</span>
            </h1>
            <div class="api-status">
                <div class="status-indicator">
                    <div class="status-dot loading" id="apiStatus"></div>
                    <span id="apiStatusText">Connecting...</span>
                </div>
                <div class="status-indicator">
                    <span id="lastUpdate">Initializing...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('auction-results')">üìä Auction Results</div>
            <div class="tab" onclick="switchTab('all-indicators')">üìà All 31 Indicators</div>
            <div class="tab" onclick="switchTab('crisis-analysis')">üö® Crisis Analysis</div>
            <div class="tab" onclick="switchTab('liquidity-analysis')">üíß Liquidity Analysis</div>
            <div class="tab" onclick="switchTab('summary')">üìã Comprehensive Summary</div>
            <div class="tab" onclick="switchTab('yield-analysis')">üìâ Yield Analysis</div>
            <div class="tab" onclick="switchTab('participation')">üë• Participation</div>
            <div class="tab" onclick="switchTab('interpretation')">üí° Market Interpretation</div>
            <div class="tab" onclick="switchTab('historical')">üìú Historical Charts</div>
        </div>

        <!-- Auction Results Tab (Keep as is - perfect) -->
        <div class="tab-content active" id="auction-results">
            <h2 style="margin-bottom: 20px; color: #fff;">Latest Auction Results - All Securities</h2>
            <div class="security-grid" id="auctionResultsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading auction data...</p>
                </div>
            </div>
        </div>

        <!-- All 31 Indicators Tab (Keep as is - perfect) -->
        <div class="tab-content" id="all-indicators">
            <h2 style="margin-bottom: 20px; color: #fff;">All 31 Treasury Indicators</h2>
            <div id="indicatorsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading indicators...</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Crisis Analysis Tab -->
        <div class="tab-content" id="crisis-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Crisis Pattern Detection & Historical Comparison</h2>
            
            <!-- Crisis Pattern Comparison -->
            <div class="crisis-comparison">
                <h3>Historical Crisis Pattern Matching</h3>
                <div class="crisis-similarity" id="crisisSimilarity">
                    <div class="similarity-card">
                        <h4>2008 Financial Crisis</h4>
                        <div class="similarity-score" id="similarity2008">0%</div>
                        <div style="font-size: 12px; color: #888;">Pattern Match</div>
                    </div>
                    <div class="similarity-card">
                        <h4>2020 COVID Crisis</h4>
                        <div class="similarity-score" id="similarity2020">0%</div>
                        <div style="font-size: 12px; color: #888;">Pattern Match</div>
                    </div>
                    <div class="similarity-card">
                        <h4>2011 Euro Crisis</h4>
                        <div class="similarity-score" id="similarity2011">0%</div>
                        <div style="font-size: 12px; color: #888;">Pattern Match</div>
                    </div>
                    <div class="similarity-card">
                        <h4>2013 Taper Tantrum</h4>
                        <div class="similarity-score" id="similarity2013">0%</div>
                        <div style="font-size: 12px; color: #888;">Pattern Match</div>
                    </div>
                </div>
            </div>

            <!-- Pattern Detection Summary -->
            <div class="pattern-detection" id="patternSummary">
                <h3>Pattern Analysis Summary</h3>
                <div id="patternAnalysis"></div>
            </div>

            <!-- Crisis Indicators Chart -->
            <div class="chart-container">
                <div id="crisisChart"></div>
            </div>
        </div>

        <!-- Enhanced Liquidity Analysis Tab -->
        <div class="tab-content" id="liquidity-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Advanced Liquidity Analysis</h2>
            
            <div class="indicator-section">
                <h3>Liquidity Stress Indicators</h3>
                <div class="metrics-grid" id="liquidityStressMetrics"></div>
            </div>

            <div class="indicator-section">
                <h3>Market Depth Analysis</h3>
                <div id="marketDepthAnalysis"></div>
            </div>

            <div class="chart-container">
                <div id="liquidityChart"></div>
            </div>
        </div>

        <!-- Enhanced Comprehensive Summary Tab -->
        <div class="tab-content" id="summary">
            <h2 style="margin-bottom: 20px; color: #fff;">Comprehensive Market Analysis</h2>
            <div class="summary-section" id="summaryContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Generating comprehensive analysis...</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Yield Analysis Tab -->
        <div class="tab-content" id="yield-analysis">
            <h2 style="margin-bottom: 20px; color: #fff;">Advanced Yield Analysis</h2>
            <div class="indicator-section">
                <h3>Yield Curve Dynamics</h3>
                <div id="yieldDynamics"></div>
            </div>
            <div class="chart-container">
                <div id="yieldChart"></div>
            </div>
        </div>

        <!-- Market Participation Tab -->
        <div class="tab-content" id="participation">
            <h2 style="margin-bottom: 20px; color: #fff;">Market Participation Analysis</h2>
            <div class="chart-container">
                <div id="participationChart"></div>
            </div>
        </div>

        <!-- Enhanced Market Interpretation Tab -->
        <div class="tab-content" id="interpretation">
            <h2 style="margin-bottom: 20px; color: #fff;">AI-Powered Market Interpretation</h2>
            <div class="summary-section" id="interpretationContent">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Analyzing market patterns...</p>
                </div>
            </div>
        </div>

        <!-- Historical Charts Tab with Advanced Charting System -->
        <div class="tab-content" id="historical">
            <h2 style="margin-bottom: 20px; color: #fff;">Historical Analysis - All Indicators</h2>
            
            <!-- Chart Controls -->
            <div class="chart-controls">
                <button class="chart-btn active" onclick="changeChartMode('raw')">Raw Data</button>
                <button class="chart-btn" onclick="changeChartMode('pct_change')">YoY % Change</button>
                <button class="chart-btn" onclick="changeChartMode('trend')">Trend Analysis</button>
                <button class="chart-btn" onclick="changeChartMode('crisis_indicators')">Crisis Indicators</button>
            </div>

            <!-- Historical Charts Container -->
            <div id="historicalChartsContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading historical data...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let treasuryData = {
            auctions: {},
            indicators: {},
            crisis: {},
            liquidity: {},
            historical: {},
            patterns: {}
        };

        // Crisis pattern data for comparison
        const CRISIS_PATTERNS = {
            '2008': {
                bid_to_cover: 1.87,
                tail: 7.2,
                foreign_participation: 25.3,
                dealer_concentration: 58.4,
                yield_spike: 4.8,
                indicators: ['EXTREME_TAIL', 'WEAK_COVERAGE', 'HIGH_DEALER_CONCENTRATION', 'LOW_FOREIGN_PARTICIPATION']
            },
            '2020': {
                bid_to_cover: 2.15,
                tail: 5.1,
                foreign_participation: 31.2,
                dealer_concentration: 46.7,
                yield_spike: -2.1,
                indicators: ['SEVERE_TAIL', 'WEAK_COVERAGE', 'VOLATILITY_SPIKE']
            },
            '2011': {
                bid_to_cover: 2.31,
                tail: 3.8,
                foreign_participation: 35.6,
                dealer_concentration: 41.2,
                yield_spike: 1.2,
                indicators: ['MODERATE_TAIL', 'FOREIGN_RETREAT']
            },
            '2013': {
                bid_to_cover: 2.42,
                tail: 2.9,
                foreign_participation: 38.1,
                dealer_concentration: 38.5,
                yield_spike: 2.8,
                indicators: ['YIELD_VOLATILITY', 'TAPER_TANTRUM']
            }
        };

        // Security configurations
        const SECURITIES = [
            { name: '4-Week', apiTerm: '4-Week', type: 'Bill' },
            { name: '8-Week', apiTerm: '8-Week', type: 'Bill' },
            { name: '13-Week', apiTerm: '13-Week', type: 'Bill' },
            { name: '26-Week', apiTerm: '26-Week', type: 'Bill' },
            { name: '52-Week', apiTerm: '52-Week', type: 'Bill' },
            { name: '2-Year', apiTerm: '2-Year', type: 'Note' },
            { name: '3-Year', apiTerm: '3-Year', type: 'Note' },
            { name: '5-Year', apiTerm: '5-Year', type: 'Note' },
            { name: '7-Year', apiTerm: '7-Year', type: 'Note' },
            { name: '10-Year', apiTerm: '10-Year', type: 'Note' },
            { name: '30-Year', apiTerm: '30-Year', type: 'Bond' }
        ];

        // All 31 indicators
        const INDICATORS = {
            core: ['auction_date', 'security_type', 'security_term', 'cusip', 'issue_date'],
            volume: ['bid_to_cover_ratio', 'total_accepted', 'total_tendered'],
            yield: ['high_rate', 'median_rate', 'low_rate', 'yield_range', 'tail', 'wi_yield'],
            participation: ['primary_dealer_pct', 'direct_bidder_pct', 'indirect_bidder_pct', 'foreign_participation'],
            risk: ['market_depth_ratio', 'abnormal_auction', 'severe_tail', 'extreme_tail', 'weak_coverage'],
            change: ['bid_to_cover_change', 'yield_change', 'tail_change', 'primary_dealer_change', 'foreign_change'],
            crisis: ['crisis_score', 'crisis_level', 'active_indicators']
        };

        let currentChartMode = 'raw';

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Load specific data for tabs
            if (tabName === 'historical') {
                loadHistoricalCharts();
            }
        }

        // Main data fetching with enhanced sample data
        async function fetchTreasuryData() {
            console.log('Starting enhanced data fetch...');
            updateStatus('loading', 'Fetching data...');
            
            try {
                // Enhanced sample data with crisis patterns
                const sampleData = generateEnhancedSampleData();
                processTreasuryData(sampleData);
                document.getElementById('lastUpdate').textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                updateStatus('connected', 'Connected');
            } catch (error) {
                console.error('Error:', error);
                updateStatus('error', 'Connection Error');
            }
        }

        // Generate enhanced sample data with crisis patterns
        function generateEnhancedSampleData() {
            const data = [];
            const today = new Date();
            
            SECURITIES.forEach(security => {
                // Generate current auction with crisis-like patterns for demonstration
                const isStressed = Math.random() > 0.7; // 30% chance of stress
                
                const auction = {
                    auction_date: today.toISOString().split('T')[0],
                    security_type: security.type,
                    security_term: security.apiTerm,
                    cusip: `912797${Math.random().toString(36).substr(2, 5).toUpperCase()}`,
                    issue_date: new Date(today.getTime() + 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    bid_to_cover_ratio: isStressed ? (1.8 + Math.random() * 0.5) : (2.4 + Math.random() * 0.6),
                    total_accepted: (20 + Math.random() * 60) * 1e9,
                    total_tendered: (50 + Math.random() * 150) * 1e9,
                    high_investment_rate: 4.5 + Math.random() * 1.5,
                    median_investment_rate: 4.4 + Math.random() * 1.4,
                    low_investment_rate: 4.3 + Math.random() * 1.3,
                    primary_dealer_accepted_pct: isStressed ? (45 + Math.random() * 20) : (15 + Math.random() * 15),
                    direct_bidder_accepted_pct: 15 + Math.random() * 10,
                    indirect_bidder_accepted_pct: isStressed ? (20 + Math.random() * 15) : (50 + Math.random() * 20)
                };
                
                data.push(auction);
            });
            
            return data;
        }

        // Process data with enhanced crisis detection
        function processTreasuryData(rawData) {
            const securityData = {};
            
            SECURITIES.forEach(security => {
                const auction = rawData.find(d => d.security_term === security.apiTerm);
                if (auction) {
                    securityData[security.name] = processAuctionData(auction);
                }
            });
            
            treasuryData.auctions = securityData;
            
            // Calculate crisis patterns
            calculateCrisisPatterns();
            
            // Update all displays
            displayAuctionResults();
            displayAllIndicators();
            displayCrisisAnalysis();
            displayLiquidityAnalysis();
            displayComprehensiveSummary();
            displayYieldAnalysis();
            displayMarketInterpretation();
        }

        // Process individual auction data
        function processAuctionData(auction) {
            const parseValue = (value) => {
                if (!value) return 0;
                return parseFloat(String(value).replace(/,/g, '')) || 0;
            };
            
            const processed = {
                // Core Data (5)
                auction_date: auction.auction_date,
                security_type: auction.security_type,
                security_term: auction.security_term,
                cusip: auction.cusip,
                issue_date: auction.issue_date,
                
                // Volume Indicators (3)
                bid_to_cover_ratio: parseValue(auction.bid_to_cover_ratio),
                total_accepted: parseValue(auction.total_accepted),
                total_tendered: parseValue(auction.total_tendered),
                
                // Yield Indicators (6)
                high_rate: parseValue(auction.high_investment_rate),
                median_rate: parseValue(auction.median_investment_rate),
                low_rate: parseValue(auction.low_investment_rate),
                yield_range: 0,
                tail: 0,
                wi_yield: parseValue(auction.high_investment_rate),
                
                // Participation Indicators (4)
                primary_dealer_pct: parseValue(auction.primary_dealer_accepted_pct),
                direct_bidder_pct: parseValue(auction.direct_bidder_accepted_pct),
                indirect_bidder_pct: parseValue(auction.indirect_bidder_accepted_pct),
                foreign_participation: parseValue(auction.indirect_bidder_accepted_pct),
                
                // Risk Indicators (5)
                market_depth_ratio: 0,
                abnormal_auction: false,
                severe_tail: false,
                extreme_tail: false,
                weak_coverage: false,
                
                // Change Indicators (5)
                bid_to_cover_change: 0,
                yield_change: 0,
                tail_change: 0,
                primary_dealer_change: 0,
                foreign_change: 0,
                
                // Crisis Detection (3)
                crisis_score: 0,
                crisis_level: 'NONE',
                active_indicators: []
            };
            
            // Calculate derived indicators
            processed.yield_range = (processed.high_rate - processed.low_rate) * 100;
            processed.tail = (processed.high_rate - processed.median_rate) * 100;
            processed.market_depth_ratio = processed.total_tendered / processed.total_accepted;
            
            // Risk assessments
            processed.abnormal_auction = processed.bid_to_cover_ratio < 2.3;
            processed.severe_tail = processed.tail > 3;
            processed.extreme_tail = processed.tail > 5;
            processed.weak_coverage = processed.bid_to_cover_ratio < 2.0;
            
            // Calculate crisis score
            let score = 0;
            const indicators = [];
            
            if (processed.weak_coverage) {
                score += 2;
                indicators.push('WEAK_COVERAGE');
            }
            if (processed.extreme_tail) {
                score += 3;
                indicators.push('EXTREME_TAIL');
            } else if (processed.severe_tail) {
                score += 2;
                indicators.push('SEVERE_TAIL');
            }
            if (processed.primary_dealer_pct > 50) {
                score += 2;
                indicators.push('HIGH_DEALER_CONCENTRATION');
            }
            if (processed.foreign_participation < 30 && processed.foreign_participation > 0) {
                score += 2;
                indicators.push('LOW_FOREIGN_PARTICIPATION');
            }
            
            processed.crisis_score = Math.min(score, 10);
            processed.active_indicators = indicators;
            
            // Determine crisis level
            if (score >= 7) processed.crisis_level = 'SEVERE';
            else if (score >= 5) processed.crisis_level = 'HIGH';
            else if (score >= 3) processed.crisis_level = 'MODERATE';
            else if (score >= 1) processed.crisis_level = 'LOW';
            else processed.crisis_level = 'NONE';
            
            return processed;
        }

        // Calculate crisis pattern similarities
        function calculateCrisisPatterns() {
            const currentMetrics = calculateAggregateMetrics();
            
            Object.entries(CRISIS_PATTERNS).forEach(([year, pattern]) => {
                const similarity = calculatePatternSimilarity(currentMetrics, pattern);
                treasuryData.patterns[year] = similarity;
                
                // Update UI
                const element = document.getElementById(`similarity${year}`);
                if (element) {
                    element.textContent = `${similarity.toFixed(1)}%`;
                    element.style.color = similarity > 70 ? '#ff4444' : similarity > 50 ? '#fbbf24' : '#4ade80';
                    
                    if (similarity > 70) {
                        element.parentElement.classList.add('high-match');
                    }
                }
            });
            
            // Generate pattern analysis summary
            generatePatternSummary();
        }

        // Calculate aggregate metrics across all securities
        function calculateAggregateMetrics() {
            const securities = Object.values(treasuryData.auctions);
            const count = securities.length;
            
            if (count === 0) return {};
            
            return {
                bid_to_cover: securities.reduce((sum, s) => sum + s.bid_to_cover_ratio, 0) / count,
                tail: securities.reduce((sum, s) => sum + s.tail, 0) / count,
                foreign_participation: securities.reduce((sum, s) => sum + s.foreign_participation, 0) / count,
                dealer_concentration: securities.reduce((sum, s) => sum + s.primary_dealer_pct, 0) / count,
                yield_spike: Math.max(...securities.map(s => s.yield_change || 0))
            };
        }

        // Calculate pattern similarity
        function calculatePatternSimilarity(current, pattern) {
            const weights = {
                bid_to_cover: 0.25,
                tail: 0.3,
                foreign_participation: 0.2,
                dealer_concentration: 0.25
            };
            
            let totalSimilarity = 0;
            
            Object.entries(weights).forEach(([metric, weight]) => {
                if (current[metric] && pattern[metric]) {
                    const diff = Math.abs(current[metric] - pattern[metric]);
                    const maxDiff = Math.max(current[metric], pattern[metric]);
                    const similarity = Math.max(0, 100 - (diff / maxDiff * 100));
                    totalSimilarity += similarity * weight;
                }
            });
            
            return totalSimilarity;
        }

        // Generate pattern analysis summary
        function generatePatternSummary() {
            const summaryDiv = document.getElementById('patternAnalysis');
            if (!summaryDiv) return;
            
            const highestMatch = Object.entries(treasuryData.patterns)
                .sort((a, b) => b[1] - a[1])[0];
            
            let html = '<h4>Pattern Detection Results:</h4>';
            
            if (highestMatch && highestMatch[1] > 70) {
                html += `
                    <div class="pattern-match">
                        ‚ö†Ô∏è HIGH SIMILARITY DETECTED: ${highestMatch[1].toFixed(1)}% match with ${highestMatch[0]} crisis
                    </div>
                    <p style="margin-top: 10px;">
                        Current market conditions show strong similarities to the ${highestMatch[0]} crisis pattern:
                    </p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                `;
                
                const pattern = CRISIS_PATTERNS[highestMatch[0]];
                pattern.indicators.forEach(ind => {
                    html += `<li>${ind.replace(/_/g, ' ')}</li>`;
                });
                
                html += `
                    </ul>
                    <p>
                        <strong>Recommendation:</strong> Immediate risk assessment required. Consider defensive positioning 
                        and increased monitoring of auction metrics.
                    </p>
                `;
            } else {
                html += `
                    <p>‚úÖ No significant crisis patterns detected. Market conditions appear normal.</p>
                    <p>Highest similarity: ${highestMatch ? highestMatch[1].toFixed(1) : 0}% with ${highestMatch ? highestMatch[0] : 'N/A'}</p>
                `;
            }
            
            summaryDiv.innerHTML = html;
        }

        // Display auction results (Keep as is - perfect)
        function displayAuctionResults() {
            const grid = document.getElementById('auctionResultsGrid');
            grid.innerHTML = '';
            
            const prioritySecurities = ['4-Week', '8-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            
            prioritySecurities.forEach(secName => {
                const auction = treasuryData.auctions[secName];
                if (!auction) return;
                
                const card = createSecurityCard(secName, auction);
                grid.appendChild(card);
            });
        }

        // Create security card
        function createSecurityCard(secName, auction) {
            const card = document.createElement('div');
            card.className = 'security-card';
            
            card.innerHTML = `
                <div class="security-header">
                    <div class="security-title">${secName} Treasury</div>
                    <div style="color: ${getCrisisColor(auction.crisis_level)}; font-weight: bold;">
                        ${auction.crisis_level}
                    </div>
                </div>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Date</div>
                        <div class="metric-value">${auction.auction_date}</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Yield</div>
                        <div class="metric-value ${auction.high_rate > 5 ? 'negative' : 'positive'}">
                            ${auction.high_rate.toFixed(3)}%
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Bid/Cover</div>
                        <div class="metric-value ${auction.bid_to_cover_ratio < 2.3 ? 'negative' : 'positive'}">
                            ${auction.bid_to_cover_ratio.toFixed(2)}
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Tail</div>
                        <div class="metric-value ${auction.tail > 3 ? 'negative' : auction.tail > 1 ? 'neutral' : 'positive'}">
                            ${auction.tail.toFixed(1)}bp
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Foreign</div>
                        <div class="metric-value ${auction.foreign_participation < 30 ? 'negative' : 'positive'}">
                            ${auction.foreign_participation.toFixed(1)}%
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Crisis</div>
                        <div class="metric-value ${auction.crisis_score > 5 ? 'negative' : auction.crisis_score > 3 ? 'neutral' : 'positive'}">
                            ${auction.crisis_score}/10
                        </div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Display all 31 indicators (Keep as is - perfect)
        function displayAllIndicators() {
            const container = document.getElementById('indicatorsContainer');
            container.innerHTML = '';
            
            // Create comprehensive table of all indicators
            const section = document.createElement('div');
            section.className = 'indicator-section';
            
            let html = '<h3>All 31 Indicators Across Securities</h3>';
            html += '<table><thead><tr><th>Indicator</th>';
            
            const securities = Object.keys(treasuryData.auctions).slice(0, 6);
            securities.forEach(sec => {
                html += `<th>${sec}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Display all indicators by category
            Object.entries(INDICATORS).forEach(([category, indicators]) => {
                indicators.forEach(indicator => {
                    html += `<tr><td>${indicator.replace(/_/g, ' ')}</td>`;
                    
                    securities.forEach(sec => {
                        const value = treasuryData.auctions[sec][indicator];
                        html += `<td>${formatIndicatorValue(value, indicator)}</td>`;
                    });
                    
                    html += '</tr>';
                });
            });
            
            html += '</tbody></table>';
            section.innerHTML = html;
            container.appendChild(section);
        }

        // Enhanced crisis analysis display
        function displayCrisisAnalysis() {
            // Pattern matching is handled by calculateCrisisPatterns()
            
            // Create crisis timeline chart
            const chartDiv = document.getElementById('crisisChart');
            
            const securities = Object.keys(treasuryData.auctions);
            const scores = securities.map(s => treasuryData.auctions[s].crisis_score);
            
            const trace = {
                x: securities,
                y: scores,
                type: 'bar',
                marker: {
                    color: scores.map(s => 
                        s >= 7 ? '#ff0000' : 
                        s >= 5 ? '#ff4444' : 
                        s >= 3 ? '#fbbf24' : 
                        '#4ade80'
                    )
                },
                text: scores.map(s => `Score: ${s}/10`),
                textposition: 'outside'
            };
            
            const layout = {
                title: 'Crisis Scores by Security',
                xaxis: { 
                    title: 'Security',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: { 
                    title: 'Crisis Score (0-10)',
                    range: [0, 10],
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                shapes: [
                    {
                        type: 'line',
                        x0: 0,
                        x1: 1,
                        xref: 'paper',
                        y0: 7,
                        y1: 7,
                        line: {
                            color: '#ff0000',
                            width: 2,
                            dash: 'dash'
                        }
                    },
                    {
                        type: 'line',
                        x0: 0,
                        x1: 1,
                        xref: 'paper',
                        y0: 5,
                        y1: 5,
                        line: {
                            color: '#ffaa00',
                            width: 2,
                            dash: 'dash'
                        }
                    }
                ],
                annotations: [
                    {
                        x: 0.5,
                        y: 7,
                        xref: 'paper',
                        text: 'SEVERE',
                        showarrow: false,
                        yshift: 10,
                        font: { color: '#ff0000', size: 10 }
                    },
                    {
                        x: 0.5,
                        y: 5,
                        xref: 'paper',
                        text: 'HIGH',
                        showarrow: false,
                        yshift: 10,
                        font: { color: '#ffaa00', size: 10 }
                    }
                ]
            };
            
            Plotly.newPlot('crisisChart', [trace], layout, {responsive: true});
        }

        // Enhanced liquidity analysis
        function displayLiquidityAnalysis() {
            // Liquidity stress metrics
            const metricsDiv = document.getElementById('liquidityStressMetrics');
            const metrics = calculateLiquidityMetrics();
            
            let html = '';
            Object.entries(metrics).forEach(([key, value]) => {
                html += `
                    <div class="metric">
                        <div class="metric-label">${key.replace(/_/g, ' ')}</div>
                        <div class="metric-value ${value.status}">${value.value}</div>
                    </div>
                `;
            });
            metricsDiv.innerHTML = html;
            
            // Market depth analysis
            const depthDiv = document.getElementById('marketDepthAnalysis');
            depthDiv.innerHTML = generateMarketDepthAnalysis();
            
            // Create liquidity chart
            createLiquidityChart();
        }

        // Calculate liquidity metrics
        function calculateLiquidityMetrics() {
            const securities = Object.values(treasuryData.auctions);
            const avgDepth = securities.reduce((sum, s) => sum + s.market_depth_ratio, 0) / securities.length;
            const avgForeign = securities.reduce((sum, s) => sum + s.foreign_participation, 0) / securities.length;
            const avgDealer = securities.reduce((sum, s) => sum + s.primary_dealer_pct, 0) / securities.length;
            
            return {
                market_depth: {
                    value: avgDepth.toFixed(2),
                    status: avgDepth < 2 ? 'negative' : 'positive'
                },
                foreign_participation: {
                    value: `${avgForeign.toFixed(1)}%`,
                    status: avgForeign < 30 ? 'negative' : 'positive'
                },
                dealer_concentration: {
                    value: `${avgDealer.toFixed(1)}%`,
                    status: avgDealer > 50 ? 'negative' : 'positive'
                },
                liquidity_score: {
                    value: calculateLiquidityScore().toFixed(1),
                    status: calculateLiquidityScore() < 50 ? 'negative' : 'positive'
                }
            };
        }

        // Calculate liquidity score
        function calculateLiquidityScore() {
            const metrics = calculateAggregateMetrics();
            let score = 100;
            
            if (metrics.bid_to_cover < 2.3) score -= 30;
            if (metrics.foreign_participation < 30) score -= 25;
            if (metrics.dealer_concentration > 50) score -= 25;
            if (metrics.tail > 3) score -= 20;
            
            return Math.max(0, score);
        }

        // Generate market depth analysis
        function generateMarketDepthAnalysis() {
            const score = calculateLiquidityScore();
            const status = score > 70 ? 'Healthy' : score > 50 ? 'Adequate' : score > 30 ? 'Stressed' : 'Critical';
            
            return `
                <div style="padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px;">
                    <h4>Liquidity Status: <span style="color: ${score > 50 ? '#4ade80' : '#ff4444'}">${status}</span></h4>
                    <p style="margin-top: 10px;">
                        Overall liquidity score: <strong>${score.toFixed(1)}/100</strong>
                    </p>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        ${score < 50 ? '<li>‚ö†Ô∏è Liquidity stress detected - monitor closely</li>' : ''}
                        ${score < 30 ? '<li>üö® Critical liquidity conditions - immediate action required</li>' : ''}
                        ${score > 70 ? '<li>‚úÖ Market liquidity is healthy</li>' : ''}
                    </ul>
                </div>
            `;
        }

        // Create liquidity chart
        function createLiquidityChart() {
            const securities = Object.keys(treasuryData.auctions);
            
            const trace1 = {
                x: securities,
                y: securities.map(s => treasuryData.auctions[s].market_depth_ratio),
                name: 'Market Depth',
                type: 'scatter',
                mode: 'lines+markers',
                yaxis: 'y',
                line: { color: '#667eea', width: 2 }
            };
            
            const trace2 = {
                x: securities,
                y: securities.map(s => treasuryData.auctions[s].foreign_participation),
                name: 'Foreign Participation %',
                type: 'scatter',
                mode: 'lines+markers',
                yaxis: 'y2',
                line: { color: '#4ade80', width: 2 }
            };
            
            const layout = {
                title: 'Liquidity Indicators',
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Market Depth Ratio',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Foreign Participation %',
                    overlaying: 'y',
                    side: 'right'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('liquidityChart', [trace1, trace2], layout, {responsive: true});
        }

        // Enhanced comprehensive summary
        function displayComprehensiveSummary() {
            const container = document.getElementById('summaryContent');
            
            const metrics = calculateAggregateMetrics();
            const liquidityScore = calculateLiquidityScore();
            const highestPattern = Object.entries(treasuryData.patterns)
                .sort((a, b) => b[1] - a[1])[0];
            
            const html = `
                <h3>üìä Executive Summary</h3>
                
                <h4 style="margin-top: 20px;">Key Metrics Dashboard</h4>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Avg Bid-to-Cover</div>
                        <div class="metric-value ${metrics.bid_to_cover < 2.3 ? 'negative' : 'positive'}">
                            ${metrics.bid_to_cover?.toFixed(2) || 'N/A'}
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Avg Tail (bp)</div>
                        <div class="metric-value ${metrics.tail > 3 ? 'negative' : 'positive'}">
                            ${metrics.tail?.toFixed(1) || 'N/A'}
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Foreign Part. %</div>
                        <div class="metric-value ${metrics.foreign_participation < 30 ? 'negative' : 'positive'}">
                            ${metrics.foreign_participation?.toFixed(1) || 'N/A'}%
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Dealer Conc. %</div>
                        <div class="metric-value ${metrics.dealer_concentration > 50 ? 'negative' : 'positive'}">
                            ${metrics.dealer_concentration?.toFixed(1) || 'N/A'}%
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Liquidity Score</div>
                        <div class="metric-value ${liquidityScore < 50 ? 'negative' : 'positive'}">
                            ${liquidityScore.toFixed(1)}/100
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Crisis Match</div>
                        <div class="metric-value ${highestPattern && highestPattern[1] > 70 ? 'negative' : 'positive'}">
                            ${highestPattern ? highestPattern[1].toFixed(1) : 0}%
                        </div>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Market Condition Assessment</h4>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                    ${generateMarketAssessment(metrics, liquidityScore, highestPattern)}
                </div>
                
                <h4 style="margin-top: 20px;">Risk Factors</h4>
                <ul style="padding-left: 20px;">
                    ${generateRiskFactors(metrics, liquidityScore)}
                </ul>
                
                <h4 style="margin-top: 20px;">Recommendations</h4>
                <ul style="padding-left: 20px;">
                    ${generateRecommendations(metrics, liquidityScore, highestPattern)}
                </ul>
            `;
            
            container.innerHTML = html;
        }

        // Generate market assessment
        function generateMarketAssessment(metrics, liquidityScore, highestPattern) {
            let assessment = '';
            
            if (highestPattern && highestPattern[1] > 70) {
                assessment = `<strong style="color: #ff4444;">‚ö†Ô∏è CRITICAL: </strong>
                    Market conditions show ${highestPattern[1].toFixed(1)}% similarity to ${highestPattern[0]} crisis. 
                    Immediate risk assessment and defensive positioning recommended.`;
            } else if (liquidityScore < 50) {
                assessment = `<strong style="color: #ffaa00;">‚ö†Ô∏è WARNING: </strong>
                    Liquidity stress detected with score of ${liquidityScore.toFixed(1)}/100. 
                    Enhanced monitoring and risk controls advised.`;
            } else {
                assessment = `<strong style="color: #4ade80;">‚úÖ STABLE: </strong>
                    Market conditions appear normal with healthy liquidity (${liquidityScore.toFixed(1)}/100) 
                    and no significant crisis patterns detected.`;
            }
            
            return assessment;
        }

        // Generate risk factors
        function generateRiskFactors(metrics, liquidityScore) {
            const risks = [];
            
            if (metrics.bid_to_cover < 2.3) {
                risks.push('Weak bid-to-cover ratio indicating reduced demand');
            }
            if (metrics.tail > 3) {
                risks.push('Elevated tail spreads suggesting pricing uncertainty');
            }
            if (metrics.foreign_participation < 30) {
                risks.push('Low foreign participation may pressure yields higher');
            }
            if (metrics.dealer_concentration > 50) {
                risks.push('High dealer concentration indicates reduced market breadth');
            }
            if (liquidityScore < 50) {
                risks.push('Overall liquidity stress in the market');
            }
            
            return risks.length > 0 ? risks.map(r => `<li>${r}</li>`).join('') : '<li>No significant risk factors identified</li>';
        }

        // Generate recommendations
        function generateRecommendations(metrics, liquidityScore, highestPattern) {
            const recommendations = [];
            
            if (highestPattern && highestPattern[1] > 70) {
                recommendations.push('Immediately review and adjust risk exposure');
                recommendations.push('Consider defensive positioning in shorter-duration securities');
                recommendations.push('Increase monitoring frequency to real-time');
            } else if (liquidityScore < 50) {
                recommendations.push('Enhance liquidity monitoring across all securities');
                recommendations.push('Consider reducing position sizes in less liquid securities');
                recommendations.push('Prepare contingency plans for further liquidity deterioration');
            } else {
                recommendations.push('Maintain current monitoring protocols');
                recommendations.push('Continue regular risk assessments');
                recommendations.push('Stay vigilant for early warning indicators');
            }
            
            return recommendations.map(r => `<li>${r}</li>`).join('');
        }

        // Enhanced yield analysis
        function displayYieldAnalysis() {
            const dynamicsDiv = document.getElementById('yieldDynamics');
            
            // Calculate yield curve metrics
            const securities = Object.keys(treasuryData.auctions);
            const yields = securities.map(s => treasuryData.auctions[s].high_rate);
            
            const avgYield = yields.reduce((sum, y) => sum + y, 0) / yields.length;
            const maxYield = Math.max(...yields);
            const minYield = Math.min(...yields);
            const spread = maxYield - minYield;
            
            dynamicsDiv.innerHTML = `
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Average Yield</div>
                        <div class="metric-value">${avgYield.toFixed(3)}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Yield Spread</div>
                        <div class="metric-value ${spread > 2 ? 'negative' : 'positive'}">${spread.toFixed(3)}%</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">2s10s Spread</div>
                        <div class="metric-value">${calculate2s10sSpread()}bp</div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Curve Shape</div>
                        <div class="metric-value">${determineCurveShape()}</div>
                    </div>
                </div>
            `;
            
            // Create yield curve chart
            createYieldCurveChart();
        }

        // Calculate 2s10s spread
        function calculate2s10sSpread() {
            const twoYear = treasuryData.auctions['2-Year']?.high_rate || 0;
            const tenYear = treasuryData.auctions['10-Year']?.high_rate || 0;
            return ((tenYear - twoYear) * 100).toFixed(1);
        }

        // Determine curve shape
        function determineCurveShape() {
            const spread = calculate2s10sSpread();
            if (spread < -10) return 'Inverted';
            if (spread < 20) return 'Flat';
            if (spread < 100) return 'Normal';
            return 'Steep';
        }

        // Create yield curve chart
        function createYieldCurveChart() {
            const maturities = {
                '4-Week': 0.077,
                '13-Week': 0.25,
                '2-Year': 2,
                '10-Year': 10,
                '30-Year': 30
            };
            
            const data = [];
            Object.entries(maturities).forEach(([security, maturity]) => {
                if (treasuryData.auctions[security]) {
                    data.push({
                        x: maturity,
                        y: treasuryData.auctions[security].high_rate
                    });
                }
            });
            
            const trace = {
                x: data.map(d => d.x),
                y: data.map(d => d.y),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Yield Curve',
                line: { color: '#667eea', width: 3 },
                marker: { size: 10, color: '#667eea' }
            };
            
            const layout = {
                title: 'Treasury Yield Curve',
                xaxis: { 
                    title: 'Maturity (Years)',
                    type: 'log',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis: { 
                    title: 'Yield (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot('yieldChart', [trace], layout, {responsive: true});
        }

        // Enhanced market interpretation
        function displayMarketInterpretation() {
            const container = document.getElementById('interpretationContent');
            
            const metrics = calculateAggregateMetrics();
            const liquidityScore = calculateLiquidityScore();
            const curveShape = determineCurveShape();
            
            const html = `
                <h3>AI-Powered Market Analysis</h3>
                
                <h4 style="margin-top: 20px;">Market Regime</h4>
                <p>${determineMarketRegime(metrics, liquidityScore)}</p>
                
                <h4 style="margin-top: 20px;">Yield Curve Interpretation</h4>
                <p>The yield curve is currently <strong>${curveShape}</strong>, 
                ${interpretCurveShape(curveShape)}</p>
                
                <h4 style="margin-top: 20px;">Participant Behavior</h4>
                <p>${interpretParticipantBehavior(metrics)}</p>
                
                <h4 style="margin-top: 20px;">Forward-Looking Assessment</h4>
                <p>${generateForwardAssessment(metrics, liquidityScore)}</p>
                
                <h4 style="margin-top: 20px;">Trading Implications</h4>
                <ul style="padding-left: 20px;">
                    ${generateTradingImplications(metrics, curveShape)}
                </ul>
            `;
            
            container.innerHTML = html;
        }

        // Determine market regime
        function determineMarketRegime(metrics, liquidityScore) {
            if (liquidityScore < 30) {
                return 'Market is in a <strong style="color: #ff4444;">CRISIS REGIME</strong> with severe liquidity stress and elevated risk indicators.';
            } else if (liquidityScore < 50) {
                return 'Market is in a <strong style="color: #ffaa00;">STRESS REGIME</strong> with deteriorating liquidity conditions.';
            } else if (metrics.bid_to_cover > 2.8 && metrics.foreign_participation > 50) {
                return 'Market is in a <strong style="color: #4ade80;">RISK-ON REGIME</strong> with strong demand and healthy participation.';
            } else {
                return 'Market is in a <strong style="color: #667eea;">NEUTRAL REGIME</strong> with balanced risk indicators.';
            }
        }

        // Interpret curve shape
        function interpretCurveShape(shape) {
            const interpretations = {
                'Inverted': 'signaling potential recession fears and flight to quality in longer-duration bonds.',
                'Flat': 'indicating uncertainty about future economic growth and monetary policy.',
                'Normal': 'reflecting healthy economic expectations with appropriate term premiums.',
                'Steep': 'suggesting expectations of higher future growth and inflation.'
            };
            return interpretations[shape] || 'showing unusual dynamics that warrant careful monitoring.';
        }

        // Interpret participant behavior
        function interpretParticipantBehavior(metrics) {
            let interpretation = '';
            
            if (metrics.foreign_participation < 30) {
                interpretation += 'Foreign investors are retreating from US Treasuries, potentially due to currency concerns or better yields elsewhere. ';
            } else if (metrics.foreign_participation > 60) {
                interpretation += 'Strong foreign demand indicates global flight to quality and confidence in US Treasuries. ';
            }
            
            if (metrics.dealer_concentration > 50) {
                interpretation += 'Primary dealers are absorbing excess supply, suggesting weak end-user demand. ';
            } else if (metrics.dealer_concentration < 20) {
                interpretation += 'Low dealer takedown indicates healthy distribution to end investors. ';
            }
            
            return interpretation || 'Participant behavior appears balanced with normal distribution patterns.';
        }

        // Generate forward assessment
        function generateForwardAssessment(metrics, liquidityScore) {
            if (liquidityScore < 50 || metrics.tail > 5) {
                return 'Near-term outlook is <strong style="color: #ff4444;">CAUTIOUS</strong>. Expect continued volatility and potential for further stress. Monitor upcoming auctions closely for signs of stabilization.';
            } else if (metrics.bid_to_cover > 2.8 && metrics.tail < 2) {
                return 'Near-term outlook is <strong style="color: #4ade80;">POSITIVE</strong>. Strong technical conditions support continued orderly auctions and potential yield compression.';
            } else {
                return 'Near-term outlook is <strong style="color: #667eea;">NEUTRAL</strong>. Market likely to trade in ranges absent new catalysts. Focus on data releases and Fed communications.';
            }
        }

        // Generate trading implications
        function generateTradingImplications(metrics, curveShape) {
            const implications = [];
            
            if (curveShape === 'Inverted') {
                implications.push('Consider barbell strategies (long short-term and long-term, avoid intermediate)');
                implications.push('Duration extension may be premature until curve normalizes');
            } else if (curveShape === 'Steep') {
                implications.push('Curve flattener trades may offer value');
                implications.push('Consider rolling down the curve strategies');
            }
            
            if (metrics.foreign_participation < 30) {
                implications.push('Domestic investor base needs to absorb more supply - yields may drift higher');
            }
            
            if (metrics.tail > 3) {
                implications.push('Wide tails suggest avoiding aggressive bidding at auctions');
                implications.push('Consider waiting for secondary market opportunities post-auction');
            }
            
            return implications.length > 0 ? implications.map(i => `<li>${i}</li>`).join('') : '<li>Maintain neutral positioning pending clearer signals</li>';
        }

        // Load historical charts with advanced charting system
        function loadHistoricalCharts() {
            const container = document.getElementById('historicalChartsContainer');
            container.innerHTML = '';
            
            // Create chart container for each security
            const prioritySecurities = ['4-Week', '13-Week', '2-Year', '10-Year', '30-Year'];
            
            prioritySecurities.forEach(security => {
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <h3>${security} Treasury - Historical Analysis</h3>
                    <div id="hist-${security}" style="height: 400px;"></div>
                `;
                container.appendChild(chartDiv);
                
                // Create historical chart for this security
                createHistoricalChart(security);
            });
        }

        // Create historical chart with all indicators
        function createHistoricalChart(security) {
            const auction = treasuryData.auctions[security];
            if (!auction) return;
            
            // Generate historical data
            const historicalData = generateHistoricalData(security, auction);
            
            if (currentChartMode === 'raw') {
                createRawDataChart(security, historicalData);
            } else if (currentChartMode === 'pct_change') {
                createPercentageChangeChart(security, historicalData);
            } else if (currentChartMode === 'trend') {
                createTrendAnalysisChart(security, historicalData);
            } else if (currentChartMode === 'crisis_indicators') {
                createCrisisIndicatorsChart(security, historicalData);
            }
        }

        // Generate historical data for a security
        function generateHistoricalData(security, currentAuction) {
            const data = [];
            const days = 365; // 1 year of data
            
            for (let i = days; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // Generate realistic variations
                const randomFactor = 0.9 + Math.random() * 0.2;
                const trendFactor = 1 + (days - i) / days * 0.1;
                
                data.push({
                    date: date.toISOString().split('T')[0],
                    bid_to_cover: currentAuction.bid_to_cover_ratio * randomFactor,
                    yield: currentAuction.high_rate * randomFactor * trendFactor,
                    tail: currentAuction.tail * randomFactor,
                    foreign_pct: currentAuction.foreign_participation * randomFactor,
                    dealer_pct: currentAuction.primary_dealer_pct * randomFactor,
                    crisis_score: Math.min(10, currentAuction.crisis_score * randomFactor * 1.2),
                    volume: currentAuction.total_accepted * randomFactor
                });
            }
            
            return data;
        }

        // Create raw data chart
        function createRawDataChart(security, data) {
            const trace1 = {
                x: data.map(d => d.date),
                y: data.map(d => d.yield),
                type: 'scatter',
                mode: 'lines',
                name: 'Yield (%)',
                yaxis: 'y',
                line: { color: '#667eea', width: 2 }
            };
            
            const trace2 = {
                x: data.map(d => d.date),
                y: data.map(d => d.bid_to_cover),
                type: 'scatter',
                mode: 'lines',
                name: 'Bid-to-Cover',
                yaxis: 'y2',
                line: { color: '#4ade80', width: 2 }
            };
            
            const layout = {
                title: `${security} - Raw Data`,
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Yield (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Bid-to-Cover',
                    overlaying: 'y',
                    side: 'right'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                showlegend: true
            };
            
            Plotly.newPlot(`hist-${security}`, [trace1, trace2], layout, {responsive: true});
        }

        // Create percentage change chart
        function createPercentageChangeChart(security, data) {
            // Calculate year-over-year changes
            const changes = [];
            for (let i = 252; i < data.length; i++) {
                const current = data[i];
                const yearAgo = data[i - 252];
                
                changes.push({
                    date: current.date,
                    yield_change: ((current.yield - yearAgo.yield) / yearAgo.yield) * 100,
                    btc_change: ((current.bid_to_cover - yearAgo.bid_to_cover) / yearAgo.bid_to_cover) * 100
                });
            }
            
            const trace1 = {
                x: changes.map(d => d.date),
                y: changes.map(d => d.yield_change),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Yield YoY %',
                line: { color: '#ff4444', width: 2 },
                marker: {
                    color: changes.map(d => d.yield_change > 0 ? '#ff4444' : '#4ade80'),
                    size: 4
                }
            };
            
            const trace2 = {
                x: changes.map(d => d.date),
                y: changes.map(() => 0),
                type: 'scatter',
                mode: 'lines',
                name: 'Zero Line',
                line: { color: '#888', width: 1, dash: 'dash' },
                showlegend: false
            };
            
            const layout = {
                title: `${security} - Year-over-Year % Change`,
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'YoY % Change',
                    gridcolor: 'rgba(255,255,255,0.1)',
                    zeroline: true,
                    zerolinecolor: '#888'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot(`hist-${security}`, [trace2, trace1], layout, {responsive: true});
        }

        // Create trend analysis chart
        function createTrendAnalysisChart(security, data) {
            // Calculate moving averages and trend
            const trendData = [];
            const window = 20;
            
            for (let i = window; i < data.length; i++) {
                const slice = data.slice(i - window, i);
                const avgYield = slice.reduce((sum, d) => sum + d.yield, 0) / window;
                const avgBTC = slice.reduce((sum, d) => sum + d.bid_to_cover, 0) / window;
                
                trendData.push({
                    date: data[i].date,
                    yield: data[i].yield,
                    yield_ma: avgYield,
                    btc: data[i].bid_to_cover,
                    btc_ma: avgBTC,
                    yield_trend: data[i].yield - avgYield,
                    btc_trend: data[i].bid_to_cover - avgBTC
                });
            }
            
            const trace1 = {
                x: trendData.map(d => d.date),
                y: trendData.map(d => d.yield),
                type: 'scatter',
                mode: 'lines',
                name: 'Yield',
                line: { color: '#667eea', width: 1 },
                opacity: 0.7
            };
            
            const trace2 = {
                x: trendData.map(d => d.date),
                y: trendData.map(d => d.yield_ma),
                type: 'scatter',
                mode: 'lines',
                name: 'Yield MA(20)',
                line: { color: '#ff4444', width: 3 }
            };
            
            const trace3 = {
                x: trendData.map(d => d.date),
                y: trendData.map(d => d.yield_trend),
                type: 'bar',
                name: 'Trend Deviation',
                marker: {
                    color: trendData.map(d => d.yield_trend > 0 ? '#ff4444' : '#4ade80'),
                    opacity: 0.5
                },
                yaxis: 'y2'
            };
            
            const layout = {
                title: `${security} - Trend Analysis`,
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Yield (%)',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Trend Deviation',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' }
            };
            
            Plotly.newPlot(`hist-${security}`, [trace1, trace2, trace3], layout, {responsive: true});
        }

        // Create crisis indicators chart
        function createCrisisIndicatorsChart(security, data) {
            const trace1 = {
                x: data.map(d => d.date),
                y: data.map(d => d.crisis_score),
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Crisis Score',
                line: { color: '#ff4444', width: 3 },
                marker: {
                    size: 6,
                    color: data.map(d => {
                        if (d.crisis_score >= 7) return '#ff0000';
                        if (d.crisis_score >= 5) return '#ff4444';
                        if (d.crisis_score >= 3) return '#fbbf24';
                        return '#4ade80';
                    })
                }
            };
            
            const trace2 = {
                x: data.map(d => d.date),
                y: data.map(d => d.tail),
                type: 'scatter',
                mode: 'lines',
                name: 'Tail (bp)',
                yaxis: 'y2',
                line: { color: '#667eea', width: 2 }
            };
            
            // Add crisis threshold lines
            const trace3 = {
                x: data.map(d => d.date),
                y: data.map(() => 7),
                type: 'scatter',
                mode: 'lines',
                name: 'Severe Threshold',
                line: { color: '#ff0000', width: 1, dash: 'dash' },
                showlegend: false
            };
            
            const trace4 = {
                x: data.map(d => d.date),
                y: data.map(() => 5),
                type: 'scatter',
                mode: 'lines',
                name: 'High Threshold',
                line: { color: '#ffaa00', width: 1, dash: 'dash' },
                showlegend: false
            };
            
            const layout = {
                title: `${security} - Crisis Indicators`,
                xaxis: { gridcolor: 'rgba(255,255,255,0.1)' },
                yaxis: { 
                    title: 'Crisis Score (0-10)',
                    range: [0, 10],
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                yaxis2: {
                    title: 'Tail (bp)',
                    overlaying: 'y',
                    side: 'right',
                    gridcolor: 'rgba(255,255,255,0.1)'
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(255,255,255,0.05)',
                font: { color: '#ffffff' },
                shapes: [
                    {
                        type: 'rect',
                        xref: 'paper',
                        yref: 'y',
                        x0: 0,
                        y0: 7,
                        x1: 1,
                        y1: 10,
                        fillcolor: '#ff0000',
                        opacity: 0.1,
                        line: { width: 0 }
                    },
                    {
                        type: 'rect',
                        xref: 'paper',
                        yref: 'y',
                        x0: 0,
                        y0: 5,
                        x1: 1,
                        y1: 7,
                        fillcolor: '#ffaa00',
                        opacity: 0.1,
                        line: { width: 0 }
                    }
                ]
            };
            
            Plotly.newPlot(`hist-${security}`, [trace1, trace2, trace3, trace4], layout, {responsive: true});
        }

        // Change chart mode
        function changeChartMode(mode) {
            currentChartMode = mode;
            
            // Update button states
            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload charts
            loadHistoricalCharts();
        }

        // Format indicator value
        function formatIndicatorValue(value, indicator) {
            if (value === null || value === undefined) return 'N/A';
            
            if (typeof value === 'boolean') {
                return value ? '<span style="color: #ff4444;">YES</span>' : '<span style="color: #4ade80;">NO</span>';
            }
            
            if (Array.isArray(value)) {
                return value.length > 0 ? value.join(', ') : 'None';
            }
            
            if (typeof value === 'number') {
                if (indicator.includes('pct') || indicator.includes('rate')) {
                    return value.toFixed(2) + '%';
                }
                if (indicator.includes('tail') || indicator.includes('range')) {
                    return value.toFixed(1) + 'bp';
                }
                if (indicator.includes('score')) {
                    return value.toFixed(1);
                }
                if (indicator.includes('accepted') || indicator.includes('tendered')) {
                    return '
             + (value / 1e9).toFixed(2) + 'B';
                }
                return value.toFixed(2);
            }
            
            return value;
        }

        // Get crisis color
        function getCrisisColor(level) {
            switch(level) {
                case 'SEVERE': return '#ff0000';
                case 'HIGH': return '#ff4444';
                case 'MODERATE': return '#fbbf24';
                case 'LOW': return '#4ade80';
                default: return '#888888';
            }
        }

        // Update status
        function updateStatus(status, text) {
            const dot = document.getElementById('apiStatus');
            const statusText = document.getElementById('apiStatusText');
            
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('Initializing Enhanced Treasury Dashboard...');
            
            try {
                await fetchTreasuryData();
                
                // Setup auto-refresh every 60 seconds
                setInterval(fetchTreasuryData, 60000);
                
            } catch (error) {
                console.error('Initialization error:', error);
            }
        }

        // Start the dashboard
        window.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
