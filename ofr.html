<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB OFR Financial Intelligence Platform - v8.0</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    
    <style>
        /* KEEP ALL THE ORIGINAL STYLES - No changes needed */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        /* Risk Level Indicator */
        .risk-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .risk-level {
            font-weight: bold;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
        }
        
        .risk-low {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        
        .risk-medium {
            background: rgba(255, 170, 0, 0.2);
            color: #ffaa00;
        }
        
        .risk-high {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
        }
        
        .risk-critical {
            background: rgba(255, 0, 0, 0.3);
            color: #ff0000;
            animation: criticalPulse 1s ease-in-out infinite;
        }
        
        @keyframes criticalPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* API Status Indicators */
        .api-status {
            display: flex;
            gap: 1rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .api-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected {
            background: #00ff88;
        }
        
        .status-dot.error {
            background: #ff4444;
        }
        
        .status-dot.loading {
            background: #ffaa00;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Key Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.1);
        }
        
        .metric-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .metric-change {
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Market Phase Banner */
        .market-phase-banner {
            background: linear-gradient(90deg, #00ff88, #00ccff);
            color: #000;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            animation: phaseGlow 2s ease-in-out infinite;
            position: sticky;
            top: 80px;
            z-index: 999;
        }
        
        @keyframes phaseGlow {
            0%, 100% { opacity: 0.9; }
            50% { opacity: 1; }
        }
        
        /* Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .data-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }
        
        .data-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .data-title {
            font-size: 1rem;
            font-weight: bold;
            color: #fff;
        }
        
        .data-source {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            background: rgba(0, 255, 136, 0.2);
            border-radius: 4px;
            color: #00ff88;
        }
        
        .data-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin: 0.75rem 0;
        }
        
        .data-change {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
        }
        
        #mainChart, #categoryChart {
            height: 500px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error/Success Messages */
        .message {
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }
        
        .error-message {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff6666;
        }
        
        .success-message {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid #00ff88;
            color: #00ff88;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .data-grid {
                grid-template-columns: 1fr;
            }
            
            .tabs-nav {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Market Phase Banner -->
    <div class="market-phase-banner" id="marketPhaseBanner">
        üè¶ OFR SYSTEMIC RISK STATUS: ANALYZING...
    </div>
    
    <header class="header">
        <div class="logo">
            üè¶ OpenBB OFR Platform
            <span style="font-size: 0.875rem; color: #888;">v8.0</span>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="activeIndicators">42</div>
                <div class="stat-label">OFR Indicators</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalCategories">8</div>
                <div class="stat-label">Categories</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastUpdate">--</div>
                <div class="stat-label">Last Update</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">$42</div>
                <div class="stat-label">Monthly Cost</div>
            </div>
        </div>
        
        <div class="risk-indicator">
            <span>Systemic Risk:</span>
            <span class="risk-level risk-low" id="riskLevel">LOADING...</span>
        </div>
        
        <div class="api-status">
            <div class="api-indicator">
                <div class="status-dot loading" id="ofrApiStatus"></div>
                <span>OFR API</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="lambdaStatus"></div>
                <span>Lambda</span>
            </div>
            <div class="api-indicator">
                <div class="status-dot loading" id="s3Status"></div>
                <span>S3 Storage</span>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">üìä Overview</button>
            <button class="tab-btn" data-tab="financial-stress">üíπ Financial Stress</button>
            <button class="tab-btn" data-tab="systemic-risk">‚ö†Ô∏è Systemic Risk</button>
            <button class="tab-btn" data-tab="leverage">üìà Leverage & Liquidity</button>
            <button class="tab-btn" data-tab="markets">üèõÔ∏è Market Monitors</button>
            <button class="tab-btn" data-tab="credit">üí≥ Credit Risk</button>
            <button class="tab-btn" data-tab="concentration">üéØ Market Concentration</button>
            <button class="tab-btn" data-tab="volatility">üìâ Volatility</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <!-- Key OFR Metrics -->
            <div class="metrics-grid" id="keyMetrics">
                <!-- Metrics will be added here dynamically -->
            </div>
            
            <!-- Main Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h2 class="chart-title">OFR Systemic Risk Overview</h2>
                </div>
                <div id="mainChart"></div>
            </div>
            
            <!-- All indicators grid -->
            <div class="data-grid" id="overviewGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Financial Stress Tab -->
        <div class="tab-content" id="financial-stress">
            <div class="data-grid" id="financialStressGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Systemic Risk Tab -->
        <div class="tab-content" id="systemic-risk">
            <div class="data-grid" id="systemicRiskGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Leverage Tab -->
        <div class="tab-content" id="leverage">
            <div class="data-grid" id="leverageGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Markets Tab -->
        <div class="tab-content" id="markets">
            <div class="data-grid" id="marketsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Credit Risk Tab -->
        <div class="tab-content" id="credit">
            <div class="data-grid" id="creditGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Market Concentration Tab -->
        <div class="tab-content" id="concentration">
            <div class="data-grid" id="concentrationGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Volatility Tab -->
        <div class="tab-content" id="volatility">
            <div class="data-grid" id="volatilityGrid">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // OFR API Configuration
        const OFR_CONFIG = {
            API: {
                baseUrl: 'https://6nl5fzfus7.execute-api.us-east-1.amazonaws.com/prod/ofr',
                endpoints: {
                    stats: '/stats',
                    search: '/search',
                    collect: '/collect'
                }
            }
        };
        
        // Global state
        let currentData = {
            allIndicators: [],
            categories: {},
            stats: {},
            lastUpdate: null
        };
        
        let activeTab = 'overview';
        let autoRefreshInterval = null;
        
        // Initialize the platform
        async function initializePlatform() {
            console.log('üöÄ Initializing OpenBB OFR Platform...');
            
            // Test API connections
            await testAPIConnections();
            
            // Load initial data
            await loadOFRData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize charts
            initializeCharts();
            
            // Start auto-refresh (60 seconds)
            startAutoRefresh();
            
            console.log('‚úÖ OFR Platform initialized successfully');
        }
        
        // Test OFR API connections
        async function testAPIConnections() {
            const ofrStatus = document.getElementById('ofrApiStatus');
            const lambdaStatus = document.getElementById('lambdaStatus');
            const s3Status = document.getElementById('s3Status');
            
            try {
                console.log('Testing OFR API connection...');
                const statsUrl = OFR_CONFIG.API.baseUrl + OFR_CONFIG.API.endpoints.stats;
                console.log('Stats URL:', statsUrl);
                
                const response = await fetch(statsUrl);
                console.log('Stats response status:', response.status);
                
                if (response.ok) {
                    const stats = await response.json();
                    console.log('Stats data:', stats);
                    
                    ofrStatus.className = 'status-dot connected';
                    lambdaStatus.className = 'status-dot connected';
                    s3Status.className = 'status-dot connected';
                    
                    // Update header stats
                    document.getElementById('activeIndicators').textContent = stats.total_indicators || 42;
                    document.getElementById('totalCategories').textContent = Object.keys(stats.categories || {}).length || 8;
                    
                    // Format last update time
                    if (stats.last_update) {
                        const lastUpdate = new Date(stats.last_update);
                        const timeAgo = getTimeAgo(lastUpdate);
                        document.getElementById('lastUpdate').textContent = timeAgo;
                    }
                    
                    currentData.stats = stats;
                    console.log(`OFR API connected: ${stats.total_indicators} indicators available`);
                } else {
                    console.error('Stats check failed:', response.status);
                    ofrStatus.className = 'status-dot error';
                    lambdaStatus.className = 'status-dot error';
                    s3Status.className = 'status-dot error';
                }
            } catch (error) {
                console.error('OFR API connection error:', error);
                ofrStatus.className = 'status-dot error';
                lambdaStatus.className = 'status-dot error';
                s3Status.className = 'status-dot error';
            }
        }
        
        // Load all OFR data
        async function loadOFRData() {
            try {
                console.log('Loading OFR data...');
                
                // Get all indicators via search with no query
                const searchUrl = `${OFR_CONFIG.API.baseUrl}${OFR_CONFIG.API.endpoints.search}?limit=100`;
                const response = await fetch(searchUrl);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log(`Loaded ${data.total_results} OFR indicators`);
                    
                    currentData.allIndicators = data.results || [];
                    
                    // Organize by category
                    currentData.categories = {};
                    currentData.allIndicators.forEach(indicator => {
                        const category = indicator.category || 'Other';
                        if (!currentData.categories[category]) {
                            currentData.categories[category] = [];
                        }
                        currentData.categories[category].push(indicator);
                    });
                    
                    // Update displays
                    updateKeyMetrics();
                    updateMainChart();
                    updateCategoryGrids();
                    detectMarketPhase();
                    updateRiskLevel();
                }
            } catch (error) {
                console.error('Error loading OFR data:', error);
            }
        }
        
        // Update key metrics display
        function updateKeyMetrics() {
            const metricsGrid = document.getElementById('keyMetrics');
            if (!metricsGrid) return;
            
            metricsGrid.innerHTML = '';
            
            // Display top indicators
            const keyIndicators = [
                'OFR_FSI',
                'OFR_SRISK',
                'OFR_LCR',
                'OFR_REPO_VOLUME',
                'OFR_CREDIT_SPREAD',
                'OFR_HHI_BANKING'
            ];
            
            keyIndicators.forEach(symbol => {
                const indicator = currentData.allIndicators.find(ind => ind.symbol === symbol);
                if (indicator) {
                    const card = createMetricCard(indicator);
                    metricsGrid.appendChild(card);
                }
            });
        }
        
        // Create metric card
        function createMetricCard(indicator) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            
            const value = indicator.current_value?.value || 0;
            const change1d = indicator.current_value?.change_1d || 0;
            const changeClass = change1d > 0 ? 'positive' : change1d < 0 ? 'negative' : 'neutral';
            
            card.innerHTML = `
                <div class="metric-title">${indicator.name}</div>
                <div class="metric-value ${changeClass}">${formatValue(value)}</div>
                <div class="metric-change ${changeClass}">
                    <span>${change1d > 0 ? '‚Üë' : change1d < 0 ? '‚Üì' : '‚Üí'} ${Math.abs(change1d).toFixed(2)}%</span>
                </div>
            `;
            
            return card;
        }
        
        // Update main chart
        function updateMainChart() {
            const chartDiv = document.getElementById('mainChart');
            if (!chartDiv) return;
            
            // Group indicators by category for visualization
            const traces = [];
            const categories = Object.keys(currentData.categories);
            const values = categories.map(cat => currentData.categories[cat].length);
            
            // Create bar chart showing indicator distribution
            const trace = {
                x: categories,
                y: values,
                type: 'bar',
                marker: {
                    color: categories.map(() => getRandomColor())
                },
                text: values.map(v => v + ' indicators'),
                textposition: 'outside'
            };
            
            const layout = {
                title: 'OFR Indicators by Category',
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' },
                xaxis: {
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                yaxis: {
                    title: 'Number of Indicators',
                    gridcolor: 'rgba(255, 255, 255, 0.1)',
                    tickfont: { color: '#888' }
                },
                showlegend: false
            };
            
            Plotly.newPlot('mainChart', [trace], layout, {responsive: true});
        }
        
        // Update category grids
        function updateCategoryGrids() {
            // Overview grid - show all indicators
            const overviewGrid = document.getElementById('overviewGrid');
            if (overviewGrid) {
                displayIndicatorGrid(overviewGrid, currentData.allIndicators);
            }
            
            // Financial Stress indicators
            const stressGrid = document.getElementById('financialStressGrid');
            if (stressGrid) {
                displayIndicatorGrid(stressGrid, currentData.categories['Financial Stress'] || []);
            }
            
            // Systemic Risk indicators
            const riskGrid = document.getElementById('systemicRiskGrid');
            if (riskGrid) {
                displayIndicatorGrid(riskGrid, currentData.categories['Systemic Risk'] || []);
            }
            
            // Leverage & Liquidity indicators
            const leverageGrid = document.getElementById('leverageGrid');
            if (leverageGrid) {
                displayIndicatorGrid(leverageGrid, currentData.categories['Leverage Liquidity'] || []);
            }
            
            // Market Monitors
            const marketsGrid = document.getElementById('marketsGrid');
            if (marketsGrid) {
                displayIndicatorGrid(marketsGrid, currentData.categories['Market Monitors'] || []);
            }
            
            // Credit Risk
            const creditGrid = document.getElementById('creditGrid');
            if (creditGrid) {
                displayIndicatorGrid(creditGrid, currentData.categories['Credit Risk'] || []);
            }
            
            // Market Concentration
            const concentrationGrid = document.getElementById('concentrationGrid');
            if (concentrationGrid) {
                displayIndicatorGrid(concentrationGrid, currentData.categories['Market Concentration'] || []);
            }
            
            // Volatility Indicators
            const volatilityGrid = document.getElementById('volatilityGrid');
            if (volatilityGrid) {
                displayIndicatorGrid(volatilityGrid, currentData.categories['Volatility Indicators'] || []);
            }
        }
        
        // Display indicator grid
        function displayIndicatorGrid(grid, indicators) {
            grid.innerHTML = '';
            
            if (!indicators || indicators.length === 0) {
                grid.innerHTML = '<div class="message">No indicators available for this category</div>';
                return;
            }
            
            indicators.forEach(indicator => {
                const card = document.createElement('div');
                card.className = 'data-card';
                
                const value = indicator.current_value?.value || 0;
                const change1d = indicator.current_value?.change_1d || 0;
                const changeClass = change1d > 0 ? 'positive' : change1d < 0 ? 'negative' : 'neutral';
                
                card.innerHTML = `
                    <div class="data-card-header">
                        <div class="data-title">${indicator.name}</div>
                        <div class="data-source">${indicator.category}</div>
                    </div>
                    <div class="data-value ${changeClass}">
                        ${formatValue(value)}
                    </div>
                    <div class="data-change">
                        <span class="${changeClass}">
                            ${change1d > 0 ? '‚Üë' : change1d < 0 ? '‚Üì' : '‚Üí'} ${Math.abs(change1d).toFixed(2)}% (1D)
                        </span>
                    </div>
                    <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">
                        ${indicator.description}
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Detect market phase based on OFR indicators
        function detectMarketPhase() {
            const banner = document.getElementById('marketPhaseBanner');
            if (!banner) return;
            
            // Find FSI indicator
            const fsi = currentData.allIndicators.find(ind => ind.symbol === 'OFR_FSI');
            const fsiValue = fsi?.current_value?.value || 0;
            
            let phase = '';
            let bannerClass = '';
            
            if (fsiValue < 20) {
                phase = 'üü¢ MARKETS STABLE - LOW SYSTEMIC RISK';
                bannerClass = 'bull-run';
            } else if (fsiValue < 40) {
                phase = 'üü° MARKETS NORMAL - MODERATE RISK';
                bannerClass = '';
            } else if (fsiValue < 60) {
                phase = 'üü† STRESS BUILDING - MONITOR CLOSELY';
                bannerClass = 'market-top';
            } else if (fsiValue < 80) {
                phase = 'üî¥ HIGH STRESS - CRISIS RISK ELEVATED';
                bannerClass = 'bear-phase';
            } else {
                phase = 'üö® CRISIS MODE - SYSTEMIC RISK CRITICAL';
                bannerClass = 'bear-phase';
            }
            
            banner.textContent = phase;
            banner.className = `market-phase-banner ${bannerClass}`;
        }
        
        // Update risk level
        function updateRiskLevel() {
            const riskElement = document.getElementById('riskLevel');
            
            // Calculate average risk based on key indicators
            const fsi = currentData.allIndicators.find(ind => ind.symbol === 'OFR_FSI');
            const srisk = currentData.allIndicators.find(ind => ind.symbol === 'OFR_SRISK');
            
            const fsiValue = fsi?.current_value?.value || 0;
            const sriskValue = srisk?.current_value?.value || 0;
            
            const avgRisk = (fsiValue + sriskValue) / 2;
            
            let level = 'UNKNOWN';
            let riskClass = '';
            
            if (avgRisk < 30) {
                level = 'LOW';
                riskClass = 'risk-low';
            } else if (avgRisk < 50) {
                level = 'MEDIUM';
                riskClass = 'risk-medium';
            } else if (avgRisk < 70) {
                level = 'HIGH';
                riskClass = 'risk-high';
            } else {
                level = 'CRITICAL';
                riskClass = 'risk-critical';
            }
            
            riskElement.textContent = level;
            riskElement.className = `risk-level ${riskClass}`;
        }
        
        // Initialize charts
        function initializeCharts() {
            const chartConfig = {
                paper_bgcolor: 'rgba(0, 0, 0, 0)',
                plot_bgcolor: 'rgba(0, 0, 0, 0.3)',
                font: { color: '#fff' }
            };
            
            Plotly.newPlot('mainChart', [], chartConfig, {responsive: true});
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = e.target.dataset.tab;
                    document.getElementById(tabId).classList.add('active');
                    
                    activeTab = tabId;
                });
            });
            
            // Trigger data collection button (optional)
            const collectBtn = document.createElement('button');
            collectBtn.textContent = 'üîÑ Refresh Data';
            collectBtn.style.cssText = 'position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background: #00ff88; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;';
            collectBtn.onclick = async () => {
                collectBtn.disabled = true;
                collectBtn.textContent = 'Collecting...';
                
                try {
                    const response = await fetch(OFR_CONFIG.API.baseUrl + OFR_CONFIG.API.endpoints.collect, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Collection result:', result);
                        
                        // Reload data after collection
                        setTimeout(() => {
                            loadOFRData();
                            collectBtn.textContent = '‚úÖ Updated!';
                            setTimeout(() => {
                                collectBtn.textContent = 'üîÑ Refresh Data';
                                collectBtn.disabled = false;
                            }, 2000);
                        }, 1000);
                    }
                } catch (error) {
                    console.error('Collection error:', error);
                    collectBtn.textContent = '‚ùå Error';
                    setTimeout(() => {
                        collectBtn.textContent = 'üîÑ Refresh Data';
                        collectBtn.disabled = false;
                    }, 2000);
                }
            };
            document.body.appendChild(collectBtn);
        }
        
        // Start auto-refresh
        function startAutoRefresh() {
            autoRefreshInterval = setInterval(() => {
                console.log('üîÑ Auto-refreshing OFR data...');
                testAPIConnections();
                loadOFRData();
            }, 60000); // 60 seconds
        }
        
        // Utility functions
        function formatValue(value) {
            if (typeof value !== 'number') return 'N/A';
            
            if (value >= 1000000) {
                return (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(2) + 'K';
            } else if (value < 1) {
                return (value * 100).toFixed(2) + '%';
            } else {
                return value.toFixed(2);
            }
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }
        
        function getRandomColor() {
            const colors = ['#00ff88', '#00ccff', '#ffaa00', '#ff4444', '#ff00ff', '#00ffff'];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializePlatform);
    </script>
</body>
</html>
