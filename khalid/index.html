<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JustHodl | Khalid Metrics Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg0:#06080d;--bg1:#0c1017;--bg2:#111827;--bg3:#1a2035;--bg4:#1e293b;--brd:#1e293b;--brd2:#2d3a4f;--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--t4:#475569;--green:#00e676;--green-bg:rgba(0,230,118,.08);--green-brd:rgba(0,230,118,.25);--red:#ff1744;--red-bg:rgba(255,23,68,.08);--red-brd:rgba(255,23,68,.25);--blue:#448aff;--yellow:#ffd740;--purple:#b388ff;--cyan:#18ffff;--orange:#ff9100;--gold:#ffd700}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg0);color:var(--t1);font-family:'DM Sans',sans-serif;overflow-x:hidden;padding-bottom:30px}.mono{font-family:'JetBrains Mono',monospace}
.topbar{background:linear-gradient(180deg,#0a0f1a,var(--bg0));border-bottom:1px solid var(--brd);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:200;backdrop-filter:blur(24px)}
.topbar-left{display:flex;align-items:center;gap:14px}.logo{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--gold),var(--orange));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.logo sub{font-size:10px;color:var(--t3);letter-spacing:1.5px;text-transform:uppercase;-webkit-text-fill-color:var(--t3)}
.topbar-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}.live{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--green);font-weight:600}.live-dot{width:7px;height:7px;background:var(--green);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,230,118,.4)}50%{opacity:.7;box-shadow:0 0 0 8px rgba(0,230,118,0)}}
.btn{padding:6px 14px;border-radius:6px;border:1px solid var(--brd2);background:var(--bg3);color:var(--t2);font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}.btn:hover{background:var(--bg4);border-color:var(--blue);color:var(--t1)}.btn-primary{background:linear-gradient(135deg,var(--blue),#2962ff);border:none;color:#fff}.btn-ai{background:linear-gradient(135deg,var(--purple),#7c4dff);border:none;color:#fff}.btn-danger{border-color:var(--red-brd);color:var(--red)}.btn-danger:hover{background:var(--red-bg)}
.back-link{color:var(--t3);text-decoration:none;font-size:12px;display:flex;align-items:center;gap:4px}.back-link:hover{color:var(--blue)}
.view-tabs{display:flex;border-bottom:1px solid var(--brd);padding:0 20px}.vtab{padding:10px 20px;font-size:12px;font-weight:600;color:var(--t3);cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}.vtab:hover{color:var(--t1)}.vtab.active{color:var(--blue);border-bottom-color:var(--blue)}
.view-panel{display:none}.view-panel.active{display:block}
.risk-hero{padding:28px 20px 20px;display:flex;gap:24px;align-items:stretch;flex-wrap:wrap}
.risk-gauge-wrap{background:var(--bg1);border:1px solid var(--brd);border-radius:12px;padding:24px 32px;display:flex;flex-direction:column;align-items:center;min-width:240px;position:relative;overflow:hidden}.risk-gauge-wrap::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,rgba(255,215,0,.03),transparent 70%);pointer-events:none}
.risk-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--t3);margin-bottom:8px;font-weight:600}.risk-gauge{position:relative;width:160px;height:160px}.risk-gauge svg{transform:rotate(-90deg)}.risk-gauge-bg{fill:none;stroke:var(--bg4);stroke-width:8}.risk-gauge-fill{fill:none;stroke-width:8;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease,stroke 1s ease}.risk-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:42px;font-weight:700;font-family:'JetBrains Mono',monospace}.risk-regime{margin-top:10px;padding:4px 14px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:1px;text-transform:uppercase}
.cat-risk-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}.cat-card{background:var(--bg1);border:1px solid var(--brd);border-radius:10px;padding:16px 18px}.cat-card:hover{border-color:var(--brd2)}.cat-name{font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:1.5px;font-weight:600;margin-bottom:8px}.cat-score{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace}.cat-bar{margin-top:10px;height:4px;background:var(--bg4);border-radius:4px;overflow:hidden}.cat-bar-fill{height:100%;border-radius:4px;transition:width 1.5s ease}
.toolbar{padding:12px 20px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;border-bottom:1px solid var(--brd)}.filter-btn{padding:5px 12px;border-radius:20px;border:1px solid var(--brd);background:transparent;color:var(--t3);font-size:11px;cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif;font-weight:500}.filter-btn:hover,.filter-btn.active{background:var(--bg3);border-color:var(--blue);color:var(--t1)}.search-wrap{margin-left:auto;position:relative}.search-wrap input{background:var(--bg2);border:1px solid var(--brd);border-radius:6px;padding:6px 12px;color:var(--t1);font-size:12px;width:200px;font-family:'DM Sans',sans-serif}.search-wrap input:focus{outline:none;border-color:var(--blue)}
.table-wrap{padding:0 20px 20px;overflow-x:auto}table{width:100%;border-collapse:collapse;font-size:12px}thead th{position:sticky;top:0;background:var(--bg1);border-bottom:2px solid var(--brd2);padding:10px 12px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--t3);font-weight:600;white-space:nowrap;z-index:10}thead th.sortable{cursor:pointer}thead th.sortable:hover{color:var(--blue)}thead th.right{text-align:right}tbody tr{border-bottom:1px solid var(--brd);transition:background .15s}tbody tr:hover{background:rgba(68,138,255,.04)}td{padding:10px 12px;white-space:nowrap;vertical-align:middle}td.right{text-align:right}
.name-input{background:transparent;border:1px solid transparent;color:var(--t1);font-size:12px;padding:2px 6px;border-radius:4px;width:100%;font-family:'DM Sans',sans-serif}.name-input:hover{border-color:var(--brd2)}.name-input:focus{outline:none;border-color:var(--blue);background:var(--bg2)}.series-id{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--t4);margin-top:2px}.current-val{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:13px}
.pct{font-family:'JetBrains Mono',monospace;font-weight:600;font-size:12px;padding:3px 8px;border-radius:4px;display:inline-block;min-width:70px;text-align:right}.pct-up{color:var(--green);background:var(--green-bg)}.pct-down{color:var(--red);background:var(--red-bg)}.pct-flat{color:var(--t3)}.pct-na{color:var(--t4);font-style:italic;font-weight:400}
.flash-green{animation:flashG 2s infinite}.flash-red{animation:flashR 2s infinite}@keyframes flashG{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 0 1px rgba(0,230,118,.3),0 0 12px rgba(0,230,118,.15)}}@keyframes flashR{0%,100%{box-shadow:none}50%{box-shadow:inset 0 0 0 1px rgba(255,23,68,.3),0 0 12px rgba(255,23,68,.15)}}
.weight-cell{display:flex;align-items:center;gap:6px}.weight-num{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--t2);min-width:18px;text-align:center}input[type=range]{-webkit-appearance:none;width:60px;height:4px;background:var(--bg4);border-radius:4px;outline:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--blue);border-radius:50%;cursor:pointer}
.flash-toggle{display:flex;gap:2px}.flash-opt{width:24px;height:24px;border-radius:4px;border:1px solid var(--brd);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:10px}.flash-opt.sel-green{background:var(--green-bg);border-color:var(--green-brd);color:var(--green)}.flash-opt.sel-red{background:var(--red-bg);border-color:var(--red-brd);color:var(--red)}
.cat-select{background:var(--bg2);border:1px solid var(--brd);color:var(--t2);font-size:11px;padding:3px 6px;border-radius:4px;font-family:'DM Sans',sans-serif;cursor:pointer}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(6px);z-index:500;display:none;align-items:center;justify-content:center}.modal-overlay.open{display:flex}.modal{background:var(--bg1);border:1px solid var(--brd2);border-radius:12px;padding:28px;width:480px;max-width:95vw;max-height:90vh;overflow-y:auto}.modal h3{font-size:16px;margin-bottom:16px}.form-row{margin-bottom:14px}.form-row label{display:block;font-size:11px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:600}.form-row input,.form-row select{width:100%;background:var(--bg2);border:1px solid var(--brd);color:var(--t1);padding:8px 12px;border-radius:6px;font-size:13px;font-family:'DM Sans',sans-serif}.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.statusbar{background:#060810;border-top:1px solid var(--brd);padding:5px 20px;font-size:10px;color:var(--t4);display:flex;justify-content:space-between;font-family:'JetBrains Mono',monospace;position:fixed;bottom:0;left:0;right:0;z-index:100}
.loading-bar{position:fixed;top:0;left:0;height:2px;background:linear-gradient(90deg,var(--blue),var(--cyan),var(--blue));z-index:999;animation:loadSlide 1.5s ease infinite;width:30%}@keyframes loadSlide{0%{left:-30%}100%{left:100%}}.spinner{width:20px;height:20px;border:2px solid var(--brd2);border-top-color:var(--blue);border-radius:50%;animation:spin .8s linear infinite;display:inline-block}@keyframes spin{to{transform:rotate(360deg)}}
@media(max-width:768px){.risk-hero{flex-direction:column}.cat-risk-grid{grid-template-columns:1fr}.toolbar{flex-direction:column;align-items:stretch}.search-wrap{margin-left:0}.search-wrap input{width:100%}}
.ai-wrap{padding:20px}.ai-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(340px,1fr));gap:16px}
.ai-card{background:var(--bg1);border:1px solid var(--brd);border-radius:10px;padding:20px;position:relative;overflow:hidden}.ai-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.ai-card.plumbing::before{background:linear-gradient(90deg,var(--green),var(--cyan))}.ai-card.cycle::before{background:linear-gradient(90deg,var(--blue),var(--purple))}.ai-card.risk::before{background:linear-gradient(90deg,var(--orange),var(--red))}.ai-card.portfolio::before{background:linear-gradient(90deg,var(--gold),var(--orange))}.ai-card.outlook::before{background:linear-gradient(90deg,var(--cyan),var(--blue))}.ai-card.trades::before{background:linear-gradient(90deg,var(--green),var(--gold))}
.ai-title{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}.ai-score{font-size:36px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:4px}.ai-grade{display:inline-block;padding:3px 10px;border-radius:4px;font-size:12px;font-weight:700;font-family:'JetBrains Mono',monospace}.ai-text{font-size:13px;color:var(--t2);line-height:1.7;margin:10px 0}
.ai-list{list-style:none;padding:0;margin:8px 0}.ai-list li{padding:6px 0;border-bottom:1px solid var(--brd);font-size:12px;color:var(--t2);line-height:1.5}.ai-list li:last-child{border-bottom:none}.ai-list li::before{content:'';display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:8px;vertical-align:middle}
.ai-list.green li::before{background:var(--green)}.ai-list.red li::before{background:var(--red)}.ai-list.blue li::before{background:var(--blue)}.ai-list.gold li::before{background:var(--gold)}.ai-list.purple li::before{background:var(--purple)}
.alloc-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--brd);font-size:12px}.alloc-name{color:var(--t2)}.alloc-pct{font-family:'JetBrains Mono',monospace;font-weight:700;font-size:14px}.alloc-detail{font-size:10px;color:var(--t4);margin-top:2px}.alloc-bar{height:6px;background:var(--bg4);border-radius:3px;margin-top:4px;overflow:hidden}.alloc-bar-fill{height:100%;border-radius:3px}
.trade-card{background:var(--bg2);border:1px solid var(--brd);border-radius:8px;padding:12px;margin-bottom:8px}.trade-name{font-weight:600;font-size:12px;margin-bottom:4px}.trade-detail{font-size:11px;color:var(--t3);line-height:1.5}
.outlook-row{display:flex;gap:12px;padding:8px 0;border-bottom:1px solid var(--brd);font-size:12px}.outlook-period{font-family:'JetBrains Mono',monospace;font-weight:600;color:var(--blue);min-width:50px;font-size:11px}.outlook-text{color:var(--t2);line-height:1.5}
.cycle-meter{height:8px;background:var(--bg4);border-radius:4px;margin:12px 0;position:relative;overflow:visible}.cycle-pos{position:absolute;top:-4px;width:16px;height:16px;background:var(--blue);border-radius:50%;border:2px solid var(--bg1);transition:left 1s ease}.cycle-labels{display:flex;justify-content:space-between;font-size:9px;color:var(--t4);margin-top:4px}
.ai-loading{text-align:center;padding:60px 20px;color:var(--t3)}
</style>
</head>
<body>
<div id="loadingBar" class="loading-bar"></div>
<div class="topbar">
  <div class="topbar-left">
    <a href="https://justhodl.ai" class="back-link">&#9666; JustHodl.AI</a>
    <div><div class="logo">KHALID METRICS <sub>Intelligence Engine</sub></div></div>
  </div>
  <div class="topbar-right">
    <div class="live"><span class="live-dot"></span> LIVE</div>
    <button class="btn" onclick="refreshData()">&#8635; Refresh</button>
    <button class="btn btn-ai" onclick="runAnalysis()">&#9733; AI Analysis</button>
    <button class="btn btn-primary" onclick="openAddModal()">+ Add Metric</button>
    <button class="btn" onclick="saveConfig()">Save</button>
  </div>
</div>
<div class="view-tabs">
  <div class="vtab active" onclick="switchView('metrics',this)">Metrics</div>
  <div class="vtab" onclick="switchView('ai',this)">AI Intelligence</div>
</div>
<div class="view-panel active" id="view-metrics">
<div class="risk-hero">
  <div class="risk-gauge-wrap"><div class="risk-label">Weighted Risk Index</div><div class="risk-gauge"><svg viewBox="0 0 140 140" width="160" height="160"><circle cx="70" cy="70" r="58" class="risk-gauge-bg"/><circle cx="70" cy="70" r="58" class="risk-gauge-fill" id="riskGaugeFill" stroke-dasharray="364.42" stroke-dashoffset="364.42"/></svg><div class="risk-num" id="riskNum">--</div></div><div class="risk-regime" id="riskRegime">LOADING</div><div style="margin-top:10px;font-size:10px;color:var(--t4)" id="riskTimestamp">--</div></div>
  <div class="cat-risk-grid" id="catRiskGrid"></div>
</div>
<div class="toolbar"><button class="filter-btn active" data-cat="all" onclick="filterCategory(this)">All</button><div id="catFilters" style="display:contents"></div><div class="search-wrap"><input type="text" placeholder="Search metrics..." id="searchInput" oninput="filterSearch()"></div></div>
<div class="table-wrap"><table><thead><tr><th style="width:30px"></th><th class="sortable" onclick="sortBy('name')">Metric</th><th>Category</th><th class="right sortable" onclick="sortBy('current')">Current</th><th class="right sortable" onclick="sortBy('1w')">1W</th><th class="right sortable" onclick="sortBy('1m')">1M</th><th class="right sortable" onclick="sortBy('3m')">3M</th><th class="right sortable" onclick="sortBy('6m')">6M</th><th class="right sortable" onclick="sortBy('1y')">1Y</th><th style="width:80px">Weight</th><th style="width:60px">Flash</th><th style="width:30px"></th></tr></thead><tbody id="metricsBody"><tr><td colspan="12" style="text-align:center;padding:40px;color:var(--t3)"><div class="spinner"></div><br>Loading...</td></tr></tbody></table></div>
</div>
<div class="view-panel" id="view-ai"><div class="ai-wrap" id="aiContent"><div class="ai-loading"><div class="spinner"></div><br>Loading AI analysis...</div></div></div>
<div class="modal-overlay" id="addModal"><div class="modal"><h3>Add New Metric</h3><div class="form-row"><label>Series ID or Ticker</label><input type="text" id="newId" placeholder="e.g. DGS10 or SPY"></div><div class="form-row"><label>Display Name</label><input type="text" id="newName"></div><div class="form-row"><label>Source</label><select id="newSource"><option value="fred">FRED</option><option value="polygon">Polygon</option></select></div><div class="form-row"><label>Category</label><select id="newCategory"></select></div><div class="form-row"><label>New Category</label><input type="text" id="newCatCustom"></div><div class="form-row"><label>Weight (1-10)</label><input type="number" id="newWeight" value="5" min="1" max="10"></div><div class="form-row"><label>Flash Rule</label><select id="newFlash"><option value="green_up">Green when UP</option><option value="red_up">Red when UP</option></select></div><div class="form-actions"><button class="btn" onclick="closeAddModal()">Cancel</button><button class="btn btn-primary" onclick="addMetric()">Add</button></div></div></div>
<div class="statusbar"><span id="statusLeft">Loading...</span><span id="statusRight">--</span></div>
<script>
var S3D='https://justhodl-dashboard-live.s3.amazonaws.com/data/khalid-metrics.json',S3C='https://justhodl-dashboard-live.s3.amazonaws.com/data/khalid-config.json',S3A='https://justhodl-dashboard-live.s3.amazonaws.com/data/khalid-analysis.json',API='https://2ijajv2pntkgj5yw5c3ukh5oq40xsyaf.lambda-url.us-east-1.on.aws/';
var CONFIG=null,DATA=null,AI=null,currentFilter='all',currentSort={col:null,dir:'asc'};
function switchView(v,el){document.querySelectorAll('.vtab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.view-panel').forEach(function(p){p.classList.remove('active')});el.classList.add('active');document.getElementById('view-'+v).classList.add('active');if(v==='ai')renderAI()}
async function loadAll(){document.getElementById('loadingBar').style.display='block';try{var r=await fetch(S3C+'?t='+Date.now());if(r.ok)CONFIG=await r.json();else CONFIG={metrics:[],categories:[]}}catch(e){CONFIG={metrics:[],categories:[]}}try{var r=await fetch(S3D+'?t='+Date.now());if(r.ok)DATA=await r.json();else DATA={metrics:{},risk_index:50,category_risks:{}}}catch(e){DATA={metrics:{},risk_index:50,category_risks:{}}}try{var r=await fetch(S3A+'?t='+Date.now());if(r.ok)AI=await r.json();else AI=null}catch(e){AI=null}render();document.getElementById('loadingBar').style.display='none'}
function render(){renderGauge();renderCats();renderFilters();renderTable();updateStatus()}
function renderGauge(){var ri=DATA.risk_index||50,el=document.getElementById('riskNum'),fill=document.getElementById('riskGaugeFill'),reg=document.getElementById('riskRegime');el.textContent=Math.round(ri);var c,rt,rb;if(ri<=25){c='#00e676';rt='LOW RISK';rb='rgba(0,230,118,.15)'}else if(ri<=40){c='#69f0ae';rt='MODERATE';rb='rgba(105,240,174,.12)'}else if(ri<=55){c='#ffd740';rt='NEUTRAL';rb='rgba(255,215,64,.12)'}else if(ri<=70){c='#ff9100';rt='ELEVATED';rb='rgba(255,145,0,.12)'}else if(ri<=85){c='#ff5252';rt='HIGH RISK';rb='rgba(255,82,82,.12)'}else{c='#ff1744';rt='EXTREME';rb='rgba(255,23,68,.15)'}el.style.color=c;fill.style.stroke=c;fill.style.strokeDashoffset=364.42-(ri/100)*364.42;reg.textContent=rt;reg.style.background=rb;reg.style.color=c;document.getElementById('riskTimestamp').textContent='Updated: '+(DATA.generated?new Date(DATA.generated).toLocaleString():'--')}
function renderCats(){var g=document.getElementById('catRiskGrid'),cats=CONFIG.categories||[],cr=DATA.category_risks||{};g.innerHTML=cats.map(function(cat){var s=cr[cat]!=null?Math.round(cr[cat]):'--',n=typeof s==='number'?s:50;var c;if(n<=30)c='var(--green)';else if(n<=55)c='var(--yellow)';else if(n<=75)c='var(--orange)';else c='var(--red)';var cnt=(CONFIG.metrics||[]).filter(function(m){return m.category===cat&&m.enabled!==false}).length;return'<div class="cat-card"><div class="cat-name">'+cat+'</div><div class="cat-score" style="color:'+c+'">'+s+'</div><div style="font-size:10px;color:var(--t4);margin-top:4px">'+cnt+' metrics</div><div class="cat-bar"><div class="cat-bar-fill" style="width:'+n+'%;background:'+c+'"></div></div></div>'}).join('')}
function renderFilters(){document.getElementById('catFilters').innerHTML=(CONFIG.categories||[]).map(function(c){return'<button class="filter-btn'+(currentFilter===c?' active':'')+'" data-cat="'+c+'" onclick="filterCategory(this)">'+c+'</button>'}).join('')}
function filterCategory(b){document.querySelectorAll('.filter-btn').forEach(function(x){x.classList.remove('active')});b.classList.add('active');currentFilter=b.dataset.cat;renderTable()}
function filterSearch(){renderTable()}
function sortBy(col){if(currentSort.col===col)currentSort.dir=currentSort.dir==='asc'?'desc':'asc';else{currentSort.col=col;currentSort.dir='desc'}renderTable()}
function renderTable(){var tb=document.getElementById('metricsBody'),q=(document.getElementById('searchInput').value||'').toLowerCase();var ms=(CONFIG.metrics||[]).map(function(m,i){return Object.assign({},m,{_i:i})});if(currentFilter!=='all')ms=ms.filter(function(m){return m.category===currentFilter});if(q)ms=ms.filter(function(m){return(m.name+' '+m.id).toLowerCase().indexOf(q)>=0});if(currentSort.col){ms.sort(function(a,b){var va,vb;if(currentSort.col==='name'){va=a.name;vb=b.name}else if(currentSort.col==='current'){va=(DATA.metrics[a.id]||{}).current||0;vb=(DATA.metrics[b.id]||{}).current||0}else{va=(DATA.metrics[a.id]||{})[currentSort.col]||0;vb=(DATA.metrics[b.id]||{})[currentSort.col]||0}if(typeof va==='string')return currentSort.dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);return currentSort.dir==='asc'?va-vb:vb-va})}if(!ms.length){tb.innerHTML='<tr><td colspan="12" style="text-align:center;padding:40px;color:var(--t3)">No metrics.</td></tr>';return}
tb.innerHTML=ms.map(function(m){var d=DATA.metrics[m.id]||{},fl=m.flash||'red_up',en=m.enabled!==false;var c3=d['3m'];var fc='';if(c3!=null&&en){if(fl==='red_up'&&c3>2)fc='flash-red';else if(fl==='red_up'&&c3<-2)fc='flash-green';else if(fl==='green_up'&&c3>2)fc='flash-green';else if(fl==='green_up'&&c3<-2)fc='flash-red'}var cats=(CONFIG.categories||[]).map(function(c){return'<option value="'+c+'"'+(c===m.category?' selected':'')+'>'+c+'</option>'}).join('');return'<tr class="'+fc+'" style="opacity:'+(en?1:.4)+'"><td><input type="checkbox" '+(en?'checked':'')+' onchange="togM('+m._i+',this.checked)" style="cursor:pointer"></td><td><input class="name-input" value="'+esc(m.name)+'" onchange="updN('+m._i+',this.value)"><div class="series-id">'+(m.source==='polygon'?'&#x1f4ca;':'&#x1f4c9;')+' '+m.id+'</div></td><td><select class="cat-select" onchange="updC('+m._i+',this.value)">'+cats+'</select></td><td class="right"><span class="current-val">'+fmtV(d.current)+'</span></td><td class="right">'+pctC(d['1w'],fl)+'</td><td class="right">'+pctC(d['1m'],fl)+'</td><td class="right">'+pctC(d['3m'],fl)+'</td><td class="right">'+pctC(d['6m'],fl)+'</td><td class="right">'+pctC(d['1y'],fl)+'</td><td><div class="weight-cell"><span class="weight-num">'+m.weight+'</span><input type="range" min="1" max="10" value="'+m.weight+'" oninput="updW('+m._i+',this.value,this)"></div></td><td><div class="flash-toggle"><div class="flash-opt'+(fl==='green_up'?' sel-green':'')+'" onclick="setF('+m._i+',\'green_up\')">&#9650;</div><div class="flash-opt'+(fl==='red_up'?' sel-red':'')+'" onclick="setF('+m._i+',\'red_up\')">&#9650;</div></div></td><td><button class="btn btn-danger" onclick="remM('+m._i+')" style="padding:3px 6px;font-size:10px">&#10005;</button></td></tr>'}).join('')}
function fmtV(v){if(v==null)return'--';if(Math.abs(v)>=1e9)return(v/1e9).toFixed(2)+'B';if(Math.abs(v)>=1e6)return(v/1e6).toFixed(2)+'M';if(Math.abs(v)>=1e3)return v.toLocaleString(undefined,{maximumFractionDigits:2});return v.toFixed(2)}
function pctC(v,fl){if(v==null)return'<span class="pct pct-na">N/A</span>';var s=v>0?'+':'';var c='pct-flat';if(fl==='green_up'){if(v>0.1)c='pct-up';else if(v<-0.1)c='pct-down'}else{if(v>0.1)c='pct-down';else if(v<-0.1)c='pct-up'}return'<span class="pct '+c+'">'+s+v.toFixed(2)+'%</span>'}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function updN(i,n){CONFIG.metrics[i].name=n}function updC(i,c){CONFIG.metrics[i].category=c;render()}function updW(i,w,el){CONFIG.metrics[i].weight=parseInt(w);el.parentElement.querySelector('.weight-num').textContent=w;recalc()}function setF(i,r){CONFIG.metrics[i].flash=r;renderTable()}function togM(i,e){CONFIG.metrics[i].enabled=e;render()}function remM(i){if(confirm('Remove?')){CONFIG.metrics.splice(i,1);render()}}
function openAddModal(){document.getElementById('newCategory').innerHTML=(CONFIG.categories||[]).map(function(c){return'<option>'+c+'</option>'}).join('');document.getElementById('newId').value='';document.getElementById('newName').value='';document.getElementById('newCatCustom').value='';document.getElementById('newWeight').value='5';document.getElementById('addModal').classList.add('open')}
function closeAddModal(){document.getElementById('addModal').classList.remove('open')}
function addMetric(){var id=document.getElementById('newId').value.trim().toUpperCase(),nm=document.getElementById('newName').value.trim(),src=document.getElementById('newSource').value;var cat=document.getElementById('newCategory').value;var cc=document.getElementById('newCatCustom').value.trim(),w=parseInt(document.getElementById('newWeight').value)||5,fl=document.getElementById('newFlash').value;if(!id||!nm)return alert('ID and Name required');if(CONFIG.metrics.some(function(m){return m.id===id}))return alert(id+' exists');if(cc){cat=cc;if(CONFIG.categories.indexOf(cat)<0)CONFIG.categories.push(cat)}CONFIG.metrics.push({id:id,name:nm,source:src,category:cat,weight:w,flash:fl,enabled:true});closeAddModal();render()}
function recalc(){var tw=0,rs=0;CONFIG.metrics.forEach(function(m){if(!m.enabled)return;var d=DATA.metrics[m.id];if(!d)return;var c=d['3m']!=null?d['3m']:d['1m'];if(c==null)return;var n;if(m.flash==='red_up')n=Math.min(Math.max((c+5)/10*50,0),100);else n=Math.min(Math.max((-c+5)/10*50,0),100);rs+=n*m.weight;tw+=m.weight});if(tw>0)DATA.risk_index=Math.round(rs/tw*10)/10;DATA.category_risks={};CONFIG.categories.forEach(function(cat){var t=0,r=0;CONFIG.metrics.forEach(function(m){if(m.category!==cat||!m.enabled)return;var d=DATA.metrics[m.id];if(!d)return;var c=d['3m']!=null?d['3m']:d['1m'];if(c==null)return;var n;if(m.flash==='red_up')n=Math.min(Math.max((c+5)/10*50,0),100);else n=Math.min(Math.max((-c+5)/10*50,0),100);r+=n*m.weight;t+=m.weight});if(t>0)DATA.category_risks[cat]=Math.round(r/t*10)/10});renderGauge();renderCats()}
function saveConfig(){document.getElementById('loadingBar').style.display='block';fetch(API,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(CONFIG)}).then(function(r){return r.json()}).then(function(d){if(d.data){DATA=d.data;render()}document.getElementById('loadingBar').style.display='none';document.getElementById('statusRight').textContent='Saved!'}).catch(function(e){document.getElementById('loadingBar').style.display='none';alert('Error: '+e.message)})}
function refreshData(){document.getElementById('loadingBar').style.display='block';fetch(API+'/refresh').then(function(r){return r.json()}).then(function(d){DATA=d;render();document.getElementById('loadingBar').style.display='none'}).catch(function(e){document.getElementById('loadingBar').style.display='none';loadAll()})}
function runAnalysis(){document.getElementById('loadingBar').style.display='block';document.getElementById('aiContent').innerHTML='<div class="ai-loading"><div class="spinner"></div><br>Running AI analysis on 44 metrics...</div>';document.querySelectorAll('.vtab')[1].click();fetch(API+'/analyze').then(function(r){return r.json()}).then(function(d){AI=d;renderAI();document.getElementById('loadingBar').style.display='none'}).catch(function(e){document.getElementById('aiContent').innerHTML='<div class="ai-loading" style="color:var(--red)">Error: '+e.message+'</div>';document.getElementById('loadingBar').style.display='none'})}
function gc(g){if(!g)return'var(--t3)';var l=g.charAt(0);if(l==='A')return'var(--green)';if(l==='B')return'var(--cyan)';if(l==='C')return'var(--yellow)';if(l==='D')return'var(--orange)';return'var(--red)'}
function rc(r){if(!r)return'var(--t3)';r=r.toUpperCase();if(r==='LOW')return'var(--green)';if(r==='MODERATE')return'var(--yellow)';if(r==='ELEVATED')return'var(--orange)';return'var(--red)'}
function ac(p){if(p>=30)return'var(--blue)';if(p>=15)return'var(--cyan)';return'var(--t3)'}
function renderAI(){var el=document.getElementById('aiContent');if(!AI||AI.error){el.innerHTML='<div class="ai-loading">No AI analysis yet. Click &#9733; AI Analysis to generate.</div>';return}var p=AI.plumbing_health||{},cy=AI.boom_bust_cycle||{},ri=AI.risk_analysis||{},pf=AI.portfolio_recommendation||{},ol=AI.outlook||{},al=pf.allocations||{};var h='<div class="ai-grid">';
h+='<div class="ai-card plumbing"><div class="ai-title">Financial Plumbing Health</div><div class="ai-score" style="color:'+gc(p.grade)+'">'+(p.score||'--')+'<span style="font-size:16px">/100</span></div><span class="ai-grade" style="background:'+gc(p.grade)+';color:var(--bg0)">'+(p.grade||'--')+'</span><div class="ai-text">'+(p.summary||'')+'</div>';
if(p.key_signals){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:12px;font-weight:600">Key Signals</div><ul class="ai-list blue">';p.key_signals.forEach(function(s){h+='<li>'+s+'</li>'});h+='</ul>'}
if(p.stress_points&&p.stress_points.length){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:8px;font-weight:600">Stress Points</div><ul class="ai-list red">';p.stress_points.forEach(function(s){h+='<li>'+s+'</li>'});h+='</ul>'}
if(p.positive_signs&&p.positive_signs.length){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:8px;font-weight:600">Positive Signs</div><ul class="ai-list green">';p.positive_signs.forEach(function(s){h+='<li>'+s+'</li>'});h+='</ul>'}h+='</div>';
h+='<div class="ai-card cycle"><div class="ai-title">Boom/Bust Cycle</div><div class="ai-score" style="color:var(--blue)">'+(cy.phase||'--')+'</div><span class="ai-grade" style="background:var(--blue);color:var(--bg0)">'+(cy.confidence||'--')+'% confidence</span>';var cp=cy.position_in_cycle||50;h+='<div class="cycle-meter"><div style="position:absolute;top:0;left:0;height:100%;width:100%;border-radius:4px;background:linear-gradient(90deg,var(--green),var(--cyan),var(--blue),var(--yellow),var(--orange),var(--red),var(--orange),var(--yellow))"></div><div class="cycle-pos" style="left:calc('+cp+'% - 8px)"></div></div><div class="cycle-labels"><span>Trough</span><span>Expansion</span><span>Peak</span><span>Contraction</span></div><div class="ai-text">'+(cy.summary||'')+'</div>';
if(cy.leading_indicators){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:8px;font-weight:600">Leading Indicators</div><ul class="ai-list purple">';cy.leading_indicators.forEach(function(s){h+='<li>'+s+'</li>'});h+='</ul>'}h+='</div>';
h+='<div class="ai-card risk"><div class="ai-title">Risk Analysis</div><div class="ai-score" style="color:'+rc(ri.overall_risk)+'">'+(ri.risk_score||'--')+'<span style="font-size:16px">/100</span></div><span class="ai-grade" style="background:'+rc(ri.overall_risk)+';color:var(--bg0)">'+(ri.overall_risk||'--')+' - '+(ri.risk_trajectory||'')+'</span><div class="ai-text" style="margin-top:12px"><strong>Systemic:</strong> '+(ri.systemic_risk||'N/A')+'</div><div class="ai-text"><strong>Liquidity:</strong> '+(ri.liquidity_risk||'N/A')+'</div><div class="ai-text"><strong>Credit:</strong> '+(ri.credit_risk||'N/A')+'</div><div class="ai-text"><strong>Dollar:</strong> '+(ri.dollar_risk||'N/A')+'</div>';
if(ri.tail_risks){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:8px;font-weight:600">Tail Risks</div><ul class="ai-list red">';ri.tail_risks.forEach(function(s){h+='<li>'+s+'</li>'});h+='</ul>'}h+='</div>';
h+='<div class="ai-card portfolio"><div class="ai-title">Portfolio Recommendation</div><div class="ai-score" style="color:var(--gold)">'+(pf.regime||'--')+'</div><span class="ai-grade" style="background:var(--gold);color:var(--bg0)">'+(pf.conviction||'--')+' conviction</span><div class="ai-text">'+(pf.summary||'')+'</div>';
var akeys=['us_equities','international_equities','us_treasuries','credit','gold_commodities','cash'],anames={us_equities:'US Equities',international_equities:'Intl Equities',us_treasuries:'US Treasuries',credit:'Credit',gold_commodities:'Gold/Commodities',cash:'Cash'};akeys.forEach(function(k){var a=al[k]||{};var w=a.weight||0;var det=a.bias||a.duration||a.quality||'';if(det)det=' ('+det+')';h+='<div class="alloc-row"><div><div class="alloc-name">'+anames[k]+det+'</div><div class="alloc-detail">'+(a.reasoning||'')+'</div></div><div class="alloc-pct" style="color:'+ac(w)+'">'+w+'%</div></div><div class="alloc-bar"><div class="alloc-bar-fill" style="width:'+w+'%;background:'+ac(w)+'"></div></div>'});
if(al.dollar_position){h+='<div class="alloc-row"><div><div class="alloc-name">Dollar Position</div><div class="alloc-detail">'+(al.dollar_position.reasoning||'')+'</div></div><div class="alloc-pct" style="color:var(--gold)">'+((al.dollar_position.stance||'--').toUpperCase())+'</div></div>'}h+='</div>';
h+='<div class="ai-card trades"><div class="ai-title">Top Trades</div>';(pf.top_trades||[]).forEach(function(t){h+='<div class="trade-card"><div class="trade-name">'+(t.trade||'')+'</div><div class="trade-detail">'+(t.rationale||'')+'</div><div class="trade-detail" style="color:var(--red);margin-top:4px">Risk: '+(t.risk||'')+'</div></div>'});
if(pf.hedges){h+='<div style="font-size:10px;color:var(--t3);text-transform:uppercase;letter-spacing:1px;margin-top:12px;font-weight:600">Hedges</div><ul class="ai-list gold">';pf.hedges.forEach(function(x){h+='<li>'+x+'</li>'});h+='</ul>'}h+='</div>';
h+='<div class="ai-card outlook"><div class="ai-title">Outlook</div>';[['1_month','1M'],['3_month','3M'],['6_month','6M'],['12_month','12M']].forEach(function(pr){h+='<div class="outlook-row"><div class="outlook-period">'+pr[1]+'</div><div class="outlook-text">'+(ol[pr[0]]||'N/A')+'</div></div>'});
h+='<div style="margin-top:12px;padding:12px;background:var(--bg2);border-radius:8px"><div style="font-size:10px;color:var(--red);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px">Biggest Risk</div><div style="font-size:12px;color:var(--t2)">'+(ol.biggest_risk||'N/A')+'</div></div>';
h+='<div style="margin-top:8px;padding:12px;background:var(--bg2);border-radius:8px"><div style="font-size:10px;color:var(--green);text-transform:uppercase;letter-spacing:1px;font-weight:600;margin-bottom:4px">Biggest Opportunity</div><div style="font-size:12px;color:var(--t2)">'+(ol.biggest_opportunity||'N/A')+'</div></div></div>';
h+='</div><div style="text-align:center;padding:16px;font-size:10px;color:var(--t4)">Generated: '+(AI.generated?new Date(AI.generated).toLocaleString():'--')+' | Powered by Claude</div>';el.innerHTML=h}
function updateStatus(){var c=(CONFIG.metrics||[]).filter(function(m){return m.enabled!==false}).length;document.getElementById('statusLeft').textContent='Khalid Metrics v2.0 | '+c+' metrics | '+(CONFIG.categories||[]).length+' categories | Risk: '+(DATA.risk_index||'--');document.getElementById('statusRight').textContent=DATA.generated?'Updated: '+new Date(DATA.generated).toLocaleString():'No data'}
document.addEventListener('keydown',function(e){if(e.key==='Escape')closeAddModal()});
loadAll();setInterval(loadAll,300000);
</script>
</body>
</html>
