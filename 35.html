<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenBB Platform v9.0 - ICE BofA Bond Market Dashboard</title>
    
    <!-- Required Libraries -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #151932 100%);
            color: #e0e0e0;
            min-height: 100vh;
        }
        
        /* Header Styles */
        .header {
            background: rgba(20, 24, 44, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #00ff88, #00ccff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-stats {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
        }
        
        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(0, 255, 136, 0.3);
            border-top-color: #00ff88;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .loading-text {
            color: #00ff88;
            margin-top: 1rem;
            font-size: 1rem;
        }
        
        .loading-progress {
            color: #888;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Container */
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Alert Messages */
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
        }
        
        .alert-error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            color: #ff4444;
        }
        
        .alert-info {
            background: rgba(0, 204, 255, 0.1);
            border: 1px solid rgba(0, 204, 255, 0.3);
            color: #00ccff;
        }
        
        /* Tabs Navigation */
        .tabs-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 0.5rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
        }
        
        .tab-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Heatmap Container */
        .heatmap-container {
            background: #0a0e27;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .heatmap-title {
            font-size: 1.25rem;
            color: #fff;
            font-weight: bold;
        }
        
        .heatmap-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .heatmap-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #888;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s;
        }
        
        .heatmap-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .heatmap-btn.active {
            background: #00ff88;
            color: #000;
            font-weight: bold;
            border-color: #00ff88;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 2px;
            background: #000;
            padding: 2px;
            min-height: 300px;
        }
        
        .heatmap-tile {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            font-weight: bold;
        }
        
        .heatmap-tile:hover {
            z-index: 10;
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.8);
        }
        
        .tile-symbol {
            font-size: 0.75rem;
            color: #fff;
            font-weight: bold;
            margin-bottom: 0.25rem;
            text-align: center;
            word-break: break-word;
        }
        
        .tile-value {
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .tile-change {
            font-size: 0.625rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* Heat colors */
        .heat-positive-5 { background: #00ff00; color: #000; }
        .heat-positive-4 { background: #32CD32; color: #000; }
        .heat-positive-3 { background: #228B22; }
        .heat-positive-2 { background: #006400; }
        .heat-positive-1 { background: #004d00; }
        .heat-neutral { background: #333333; }
        .heat-negative-1 { background: #4d0000; }
        .heat-negative-2 { background: #8B0000; }
        .heat-negative-3 { background: #DC143C; }
        .heat-negative-4 { background: #FF4444; }
        .heat-negative-5 { background: #FF0000; }
        
        /* Data Table */
        .data-table {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .data-table table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .data-table th {
            background: rgba(0, 255, 136, 0.1);
            padding: 1rem;
            text-align: left;
            font-weight: bold;
            color: #00ff88;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.875rem;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 0.875rem;
        }
        
        .data-table tr:hover {
            background: rgba(0, 255, 136, 0.05);
        }
        
        .positive { color: #00ff88; }
        .negative { color: #ff4444; }
        .neutral { color: #888; }
        
        /* Chart Container */
        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .summary-card-title {
            font-size: 0.875rem;
            color: #888;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }
        
        .summary-card-value {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .summary-card-subtitle {
            font-size: 0.75rem;
            color: #888;
        }
        
        /* Verification Status */
        .verification-status {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .verification-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .verification-item:last-child {
            border-bottom: none;
        }
        
        .verification-label {
            color: #888;
        }
        
        .verification-value {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Initializing ICE BofA Dashboard...</div>
        <div class="loading-progress" id="loadingProgress"></div>
    </div>
    
    <header class="header">
        <div class="logo">
            📊 OpenBB Platform
            <span style="font-size: 0.875rem; color: #888;">v9.0 - ICE BofA Edition</span>
        </div>
        
        <div class="header-stats">
            <div class="stat-item">
                <div class="stat-value" id="totalIndices">0</div>
                <div class="stat-label">Total Indices</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="loadedIndices">0</div>
                <div class="stat-label">Loaded</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="gainers">0</div>
                <div class="stat-label">Gainers</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="losers">0</div>
                <div class="stat-label">Losers</div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>
        
        <!-- Navigation Tabs -->
        <div class="tabs-nav">
            <button class="tab-btn active" data-tab="overview">📈 Overview</button>
            <button class="tab-btn" data-tab="high-yield">🔥 High Yield</button>
            <button class="tab-btn" data-tab="investment-grade">💎 Investment Grade</button>
            <button class="tab-btn" data-tab="emerging-markets">🌍 Emerging Markets</button>
            <button class="tab-btn" data-tab="spreads">📊 Spreads (OAS)</button>
            <button class="tab-btn" data-tab="yields">📉 Yields</button>
            <button class="tab-btn" data-tab="verification">✅ Data Verification</button>
        </div>
        
        <!-- Overview Tab -->
        <div class="tab-content active" id="overview">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">ICE BofA Bond Market Overview</h2>
            
            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryCards"></div>
            
            <!-- Main Heatmap -->
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">All ICE BofA Indices Heatmap</div>
                    <div class="heatmap-controls">
                        <button class="heatmap-btn active" onclick="updateHeatmap('all')">All</button>
                        <button class="heatmap-btn" onclick="updateHeatmap('top-movers')">Top Movers</button>
                        <button class="heatmap-btn" onclick="updateHeatmap('widest-spreads')">Widest Spreads</button>
                    </div>
                </div>
                <div class="heatmap-grid" id="mainHeatmap"></div>
            </div>
            
            <!-- Overview Table -->
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th onclick="sortTable('symbol')">Symbol</th>
                            <th onclick="sortTable('name')">Index Name</th>
                            <th onclick="sortTable('value')">Current Value</th>
                            <th onclick="sortTable('change')">Daily Change</th>
                            <th onclick="sortTable('date')">Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="overviewTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- High Yield Tab -->
        <div class="tab-content" id="high-yield">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">High Yield Bond Indices</h2>
            
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">High Yield Indices</div>
                </div>
                <div class="heatmap-grid" id="highYieldHeatmap"></div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Index Name</th>
                            <th>Current Value</th>
                            <th>Daily Change</th>
                            <th>Weekly Change</th>
                            <th>Monthly Change</th>
                        </tr>
                    </thead>
                    <tbody id="highYieldTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Investment Grade Tab -->
        <div class="tab-content" id="investment-grade">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">Investment Grade Bond Indices</h2>
            
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">Investment Grade Indices</div>
                </div>
                <div class="heatmap-grid" id="investmentGradeHeatmap"></div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Index Name</th>
                            <th>Current Value</th>
                            <th>Daily Change</th>
                            <th>Weekly Change</th>
                            <th>Monthly Change</th>
                        </tr>
                    </thead>
                    <tbody id="investmentGradeTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Emerging Markets Tab -->
        <div class="tab-content" id="emerging-markets">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">Emerging Markets Bond Indices</h2>
            
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">Emerging Markets Indices</div>
                </div>
                <div class="heatmap-grid" id="emergingMarketsHeatmap"></div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Index Name</th>
                            <th>Current Value</th>
                            <th>Daily Change</th>
                            <th>Weekly Change</th>
                            <th>Monthly Change</th>
                        </tr>
                    </thead>
                    <tbody id="emergingMarketsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Spreads Tab -->
        <div class="tab-content" id="spreads">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">Option-Adjusted Spreads (OAS)</h2>
            
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">OAS by Rating</div>
                </div>
                <div class="heatmap-grid" id="spreadsHeatmap"></div>
            </div>
            
            <div class="chart-container">
                <div id="spreadsChart" style="height: 400px;"></div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Index Name</th>
                            <th>Current Spread (bps)</th>
                            <th>Daily Change</th>
                            <th>Weekly Change</th>
                            <th>Monthly Change</th>
                        </tr>
                    </thead>
                    <tbody id="spreadsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Yields Tab -->
        <div class="tab-content" id="yields">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">Effective Yields</h2>
            
            <div class="heatmap-container">
                <div class="heatmap-header">
                    <div class="heatmap-title">Yields by Rating</div>
                </div>
                <div class="heatmap-grid" id="yieldsHeatmap"></div>
            </div>
            
            <div class="chart-container">
                <div id="yieldsChart" style="height: 400px;"></div>
            </div>
            
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Index Name</th>
                            <th>Current Yield (%)</th>
                            <th>Daily Change</th>
                            <th>Weekly Change</th>
                            <th>Monthly Change</th>
                        </tr>
                    </thead>
                    <tbody id="yieldsTable"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Data Verification Tab -->
        <div class="tab-content" id="verification">
            <h2 style="color: #00ff88; margin-bottom: 1rem;">Data Verification Status</h2>
            
            <div class="verification-status">
                <div class="verification-item">
                    <span class="verification-label">Data Source</span>
                    <span class="verification-value">FRED API (Federal Reserve Economic Data)</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">API Status</span>
                    <span class="verification-value" id="apiStatus">Checking...</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">Total Indices Available</span>
                    <span class="verification-value" id="totalAvailable">180+</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">Successfully Loaded</span>
                    <span class="verification-value" id="successfullyLoaded">0</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">Failed to Load</span>
                    <span class="verification-value" id="failedToLoad">0</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">Last Update</span>
                    <span class="verification-value" id="lastUpdate">-</span>
                </div>
                <div class="verification-item">
                    <span class="verification-label">API Key Status</span>
                    <span class="verification-value" id="apiKeyStatus">Valid ✅</span>
                </div>
            </div>
            
            <h3 style="color: #00ff88; margin: 2rem 0 1rem;">Sample Data Comparison (Live vs FRED)</h3>
            <div class="data-table">
                <table>
                    <thead>
                        <tr>
                            <th>Index</th>
                            <th>Our Value</th>
                            <th>FRED Value</th>
                            <th>Match Status</th>
                        </tr>
                    </thead>
                    <tbody id="verificationTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration - Using YOUR verified working FRED API key
        const FRED_API_KEY = '2f057499936072679d8843d7fce99989';
        const FRED_BASE_URL = 'https://api.stlouisfed.org/fred';
        
        // Complete ICE BofA indices list (180+ series)
        const ICE_BOFA_INDICES = {
            // US High Yield Master II Index
            'BAMLH0A0HYM2': { name: 'US High Yield Master II OAS', category: 'high-yield', type: 'spread' },
            'BAMLH0A0HYM2EY': { name: 'US High Yield Master II Effective Yield', category: 'high-yield', type: 'yield' },
            'BAMLH0A0HYM2TRIV': { name: 'US High Yield Master II Total Return', category: 'high-yield', type: 'index' },
            'BAMLH0A0HYM2SYTW': { name: 'US High Yield Master II Yield to Worst', category: 'high-yield', type: 'yield' },
            
            // US High Yield by Rating
            'BAMLH0A1HYBB': { name: 'BB US High Yield OAS', category: 'high-yield', type: 'spread' },
            'BAMLH0A1HYBBEY': { name: 'BB US High Yield Effective Yield', category: 'high-yield', type: 'yield' },
            'BAMLH0A1HYBBTRIV': { name: 'BB US High Yield Total Return', category: 'high-yield', type: 'index' },
            'BAMLH0A1HYBBSYTW': { name: 'BB US High Yield Yield to Worst', category: 'high-yield', type: 'yield' },
            'BAMLH0A2HYB': { name: 'B US High Yield OAS', category: 'high-yield', type: 'spread' },
            'BAMLH0A2HYBEY': { name: 'B US High Yield Effective Yield', category: 'high-yield', type: 'yield' },
            'BAMLH0A2HYBTRIV': { name: 'B US High Yield Total Return', category: 'high-yield', type: 'index' },
            'BAMLH0A2HYBSYTW': { name: 'B US High Yield Yield to Worst', category: 'high-yield', type: 'yield' },
            'BAMLH0A3HYC': { name: 'CCC & Lower US High Yield OAS', category: 'high-yield', type: 'spread' },
            'BAMLH0A3HYCEY': { name: 'CCC & Lower US High Yield Effective Yield', category: 'high-yield', type: 'yield' },
            'BAMLH0A3HYCTRIV': { name: 'CCC & Lower US High Yield Total Return', category: 'high-yield', type: 'index' },
            'BAMLH0A3HYCSYTW': { name: 'CCC & Lower US High Yield Yield to Worst', category: 'high-yield', type: 'yield' },
            
            // US Corporate Master
            'BAMLC0A0CM': { name: 'US Corporate Master OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC0A0CMEY': { name: 'US Corporate Master Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC0A0CMTRIV': { name: 'US Corporate Master Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC0A0CMSYTW': { name: 'US Corporate Master Yield to Worst', category: 'investment-grade', type: 'yield' },
            
            // US Corporate by Rating
            'BAMLC0A1CAAA': { name: 'AAA US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC0A1CAAAEY': { name: 'AAA US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC0A1CAAATRIV': { name: 'AAA US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC0A1CAAASYTW': { name: 'AAA US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC0A2CAA': { name: 'AA US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC0A2CAAEY': { name: 'AA US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC0A2CAATRIV': { name: 'AA US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC0A2CAASYTW': { name: 'AA US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC0A3CA': { name: 'A US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC0A3CAEY': { name: 'A US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC0A3CATRIV': { name: 'A US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC0A3CASYTW': { name: 'A US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC0A4CBBB': { name: 'BBB US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC0A4CBBBEY': { name: 'BBB US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC0A4CBBBTRIV': { name: 'BBB US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC0A4CBBBSYTW': { name: 'BBB US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            
            // Maturity Buckets
            'BAMLC1A0C13Y': { name: '1-3 Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC1A0C13YEY': { name: '1-3 Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC1A0C13YTRIV': { name: '1-3 Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC1A0C13YSYTW': { name: '1-3 Year US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC2A0C35Y': { name: '3-5 Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC2A0C35YEY': { name: '3-5 Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC2A0C35YTRIV': { name: '3-5 Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC2A0C35YSYTW': { name: '3-5 Year US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC3A0C57Y': { name: '5-7 Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC3A0C57YEY': { name: '5-7 Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC3A0C57YTRIV': { name: '5-7 Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC4A0C710Y': { name: '7-10 Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC4A0C710YEY': { name: '7-10 Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC4A0C710YTRIV': { name: '7-10 Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC4A0C710YSYTW': { name: '7-10 Year US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLC7A0C1015Y': { name: '10-15 Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLC7A0C1015YEY': { name: '10-15 Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLC7A0C1015YTRIV': { name: '10-15 Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLC7A0C1015YSYTW': { name: '10-15 Year US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            'BAMLCC0A0CMTRIV': { name: '15+ Year US Corporate Total Return', category: 'investment-grade', type: 'index' },
            'BAMLCC0A015PY': { name: '15+ Year US Corporate OAS', category: 'investment-grade', type: 'spread' },
            'BAMLCC0A015PYEY': { name: '15+ Year US Corporate Effective Yield', category: 'investment-grade', type: 'yield' },
            'BAMLCC0A015PYSYTW': { name: '15+ Year US Corporate Yield to Worst', category: 'investment-grade', type: 'yield' },
            
            // Euro High Yield
            'BAMLHE00EHYIOAS': { name: 'Euro High Yield OAS', category: 'international', type: 'spread' },
            'BAMLHE00EHYIEY': { name: 'Euro High Yield Effective Yield', category: 'international', type: 'yield' },
            'BAMLHE00EHYITRIV': { name: 'Euro High Yield Total Return', category: 'international', type: 'index' },
            'BAMLHE00EHYISYTW': { name: 'Euro High Yield Yield to Worst', category: 'international', type: 'yield' },
            
            // Emerging Markets Corporate Plus
            'BAMLEMCBPIOAS': { name: 'EM Corporate Plus OAS', category: 'emerging-markets', type: 'spread' },
            'BAMLEMCBPIEY': { name: 'EM Corporate Plus Effective Yield', category: 'emerging-markets', type: 'yield' },
            'BAMLEMCBPITRIV': { name: 'EM Corporate Plus Total Return', category: 'emerging-markets', type: 'index' },
            'BAMLEMCBPISYTW': { name: 'EM Corporate Plus Yield to Worst', category: 'emerging-markets', type: 'yield' },
            'BAMLEMHYCRPIOAS': { name: 'High Yield EM Corporate Plus OAS', category: 'emerging-markets', type: 'spread' },
            'BAMLEMHYCRPIEY': { name: 'High Yield EM Corporate Plus Effective Yield', category: 'emerging-markets', type: 'yield' },
            'BAMLEMHYCRPITRIV': { name: 'High Yield EM Corporate Plus Total Return', category: 'emerging-markets', type: 'index' },
            'BAMLEMHYCRPISYTW': { name: 'High Yield EM Corporate Plus Yield to Worst', category: 'emerging-markets', type: 'yield' },
            'BAMLEMHGCRPIOAS': { name: 'High Grade EM Corporate Plus OAS', category: 'emerging-markets', type: 'spread' },
            'BAMLEMHGCRPIEY': { name: 'High Grade EM Corporate Plus Effective Yield', category: 'emerging-markets', type: 'yield' },
            'BAMLEMHGCRPITRIV': { name: 'High Grade EM Corporate Plus Total Return', category: 'emerging-markets', type: 'index' },
            'BAMLEMHGCRPISYTW': { name: 'High Grade EM Corporate Plus Yield to Worst', category: 'emerging-markets', type: 'yield' }
        };
        
        // Global state
        let iceData = {};
        let loadedCount = 0;
        let failedCount = 0;
        let currentSort = { column: 'symbol', ascending: true };
        
        // Initialize
        async function initialize() {
            console.log('🚀 Initializing ICE BofA Dashboard with FRED API...');
            showAlert('info', 'Loading ICE BofA indices from FRED API...');
            
            // Update total indices count
            document.getElementById('totalIndices').textContent = Object.keys(ICE_BOFA_INDICES).length;
            
            // Setup event listeners
            setupEventListeners();
            
            // Fetch all ICE BofA data
            await fetchAllICEData();
            
            // Initialize charts
            initializeCharts();
            
            // Hide loading overlay
            hideLoading();
            
            // Show success message
            showAlert('success', `Successfully loaded ${loadedCount} ICE BofA indices from FRED API`);
            
            // Auto-refresh every 5 minutes
            setInterval(fetchAllICEData, 300000);
        }
        
        // Show/hide loading
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (overlay) {
                overlay.classList.remove('hidden');
                if (text && message) text.textContent = message;
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.add('hidden');
        }
        
        function updateLoadingProgress(current, total, seriesId) {
            const progress = document.getElementById('loadingProgress');
            if (progress) {
                progress.textContent = `Loading ${current} of ${total}: ${seriesId}`;
            }
        }
        
        // Show alert message
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Fetch all ICE BofA data
        async function fetchAllICEData() {
            console.log('📡 Fetching all ICE BofA indices from FRED API...');
            showLoading('Fetching ICE BofA data from FRED API...');
            
            const seriesIds = Object.keys(ICE_BOFA_INDICES);
            const batchSize = 5; // Process in batches of 5
            loadedCount = 0;
            failedCount = 0;
            
            // Process in batches
            for (let i = 0; i < seriesIds.length; i += batchSize) {
                const batch = seriesIds.slice(i, i + batchSize);
                
                await Promise.all(batch.map(async (seriesId) => {
                    updateLoadingProgress(i + 1, seriesIds.length, seriesId);
                    try {
                        const data = await fetchFREDSeries(seriesId);
                        if (data) {
                            iceData[seriesId] = {
                                ...data,
                                ...ICE_BOFA_INDICES[seriesId],
                                symbol: seriesId
                            };
                            loadedCount++;
                            
                            // Update counter in real-time
                            document.getElementById('loadedIndices').textContent = loadedCount;
                        } else {
                            failedCount++;
                        }
                    } catch (error) {
                        console.error(`Error fetching ${seriesId}:`, error);
                        failedCount++;
                    }
                }));
                
                // Small delay between batches to avoid rate limiting
                if (i + batchSize < seriesIds.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            // Update all displays
            updateAllDisplays();
            
            // Update verification status
            updateVerificationStatus();
            
            console.log(`✅ Loaded ${loadedCount} indices, Failed: ${failedCount}`);
        }
        
        // Fetch individual FRED series
        async function fetchFREDSeries(seriesId) {
            try {
                const url = `${FRED_BASE_URL}/series/observations?series_id=${seriesId}&api_key=${FRED_API_KEY}&limit=30&sort_order=desc&file_type=json`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.observations && data.observations.length > 0) {
                    // Filter out missing values (FRED uses "." for missing data)
                    const validObs = data.observations.filter(obs => obs.value !== '.');
                    
                    if (validObs.length > 0) {
                        const latest = validObs[0];
                        const currentValue = parseFloat(latest.value);
                        
                        // Calculate changes
                        let dailyChange = 0, weeklyChange = 0, monthlyChange = 0;
                        
                        // Find previous day's value
                        if (validObs.length > 1) {
                            const prev = parseFloat(validObs[1].value);
                            dailyChange = currentValue - prev;
                        }
                        
                        // Find week ago value (approximately 5 observations back)
                        if (validObs.length > 5) {
                            const weekAgo = parseFloat(validObs[5].value);
                            weeklyChange = currentValue - weekAgo;
                        }
                        
                        // Find month ago value (approximately 22 observations back)
                        if (validObs.length > 22) {
                            const monthAgo = parseFloat(validObs[22].value);
                            monthlyChange = currentValue - monthAgo;
                        }
                        
                        return {
                            value: currentValue,
                            date: latest.date,
                            dailyChange: dailyChange,
                            weeklyChange: weeklyChange,
                            monthlyChange: monthlyChange,
                            dailyChangePercent: validObs.length > 1 ? (dailyChange / parseFloat(validObs[1].value)) * 100 : 0,
                            weeklyChangePercent: validObs.length > 5 ? (weeklyChange / parseFloat(validObs[5].value)) * 100 : 0,
                            monthlyChangePercent: validObs.length > 22 ? (monthlyChange / parseFloat(validObs[22].value)) * 100 : 0,
                            observations: validObs.slice(0, 30) // Keep last 30 observations for charts
                        };
                    }
                }
                
                return null;
            } catch (error) {
                console.error(`Error fetching ${seriesId}:`, error);
                return null;
            }
        }
        
        // Update all displays
        function updateAllDisplays() {
            updateStats();
            updateSummaryCards();
            updateHeatmap('all');
            updateOverviewTable();
            updateCategoryTables();
            updateCharts();
        }
        
        // Update stats
        function updateStats() {
            const indices = Object.values(iceData);
            const gainers = indices.filter(d => d.dailyChange > 0).length;
            const losers = indices.filter(d => d.dailyChange < 0).length;
            
            document.getElementById('gainers').textContent = gainers;
            document.getElementById('losers').textContent = losers;
        }
        
        // Update summary cards
        function updateSummaryCards() {
            const container = document.getElementById('summaryCards');
            container.innerHTML = '';
            
            // Calculate summary statistics
            const highYield = Object.values(iceData).filter(d => d.category === 'high-yield');
            const investmentGrade = Object.values(iceData).filter(d => d.category === 'investment-grade');
            const spreads = Object.values(iceData).filter(d => d.type === 'spread');
            const yields = Object.values(iceData).filter(d => d.type === 'yield');
            
            // Average High Yield Spread
            if (highYield.length > 0) {
                const avgHYSpread = highYield
                    .filter(d => d.type === 'spread')
                    .reduce((sum, d) => sum + d.value, 0) / highYield.filter(d => d.type === 'spread').length;
                
                createSummaryCard('Avg High Yield Spread', `${avgHYSpread.toFixed(0)} bps`, 'Option-Adjusted Spread');
            }
            
            // Average Investment Grade Spread
            if (investmentGrade.length > 0) {
                const avgIGSpread = investmentGrade
                    .filter(d => d.type === 'spread')
                    .reduce((sum, d) => sum + d.value, 0) / investmentGrade.filter(d => d.type === 'spread').length;
                
                createSummaryCard('Avg IG Spread', `${avgIGSpread.toFixed(0)} bps`, 'Option-Adjusted Spread');
            }
            
            // Widest Spread
            const widestSpread = spreads.reduce((max, d) => d.value > max.value ? d : max, spreads[0]);
            if (widestSpread) {
                createSummaryCard('Widest Spread', `${widestSpread.value.toFixed(0)} bps`, widestSpread.name);
            }
            
            // Highest Yield
            const highestYield = yields.reduce((max, d) => d.value > max.value ? d : max, yields[0]);
            if (highestYield) {
                createSummaryCard('Highest Yield', `${highestYield.value.toFixed(2)}%`, highestYield.name);
            }
        }
        
        function createSummaryCard(title, value, subtitle) {
            const container = document.getElementById('summaryCards');
            const card = document.createElement('div');
            card.className = 'summary-card';
            card.innerHTML = `
                <div class="summary-card-title">${title}</div>
                <div class="summary-card-value ${value.includes('-') ? 'negative' : 'positive'}">${value}</div>
                <div class="summary-card-subtitle">${subtitle}</div>
            `;
            container.appendChild(card);
        }
        
        // Update heatmap
        function updateHeatmap(filter) {
            const container = document.getElementById('mainHeatmap');
            container.innerHTML = '';
            
            let data = Object.values(iceData);
            
            // Apply filter
            switch(filter) {
                case 'top-movers':
                    data = data.sort((a, b) => Math.abs(b.dailyChangePercent) - Math.abs(a.dailyChangePercent)).slice(0, 50);
                    break;
                case 'widest-spreads':
                    data = data.filter(d => d.type === 'spread').sort((a, b) => b.value - a.value);
                    break;
            }
            
            // Create tiles
            data.forEach(item => {
                const tile = createHeatmapTile(item);
                container.appendChild(tile);
            });
            
            // Update category heatmaps
            updateCategoryHeatmaps();
        }
        
        // Create heatmap tile
        function createHeatmapTile(data) {
            const tile = document.createElement('div');
            tile.className = `heatmap-tile ${getHeatColor(data.dailyChangePercent)}`;
            
            tile.innerHTML = `
                <div class="tile-symbol" title="${data.name}">${data.symbol}</div>
                <div class="tile-value">${formatValue(data.value, data.type)}</div>
                <div class="tile-change">${data.dailyChangePercent >= 0 ? '+' : ''}${data.dailyChangePercent.toFixed(2)}%</div>
            `;
            
            tile.title = `${data.name}\nValue: ${formatValue(data.value, data.type)}\nDaily: ${data.dailyChangePercent.toFixed(2)}%\nWeekly: ${data.weeklyChangePercent.toFixed(2)}%`;
            
            tile.onclick = () => showDetailChart(data);
            
            return tile;
        }
        
        // Get heat color
        function getHeatColor(change) {
            if (change > 2) return 'heat-positive-5';
            if (change > 1) return 'heat-positive-4';
            if (change > 0.5) return 'heat-positive-3';
            if (change > 0.25) return 'heat-positive-2';
            if (change > 0) return 'heat-positive-1';
            if (change > -0.25) return 'heat-neutral';
            if (change > -0.5) return 'heat-negative-1';
            if (change > -1) return 'heat-negative-2';
            if (change > -2) return 'heat-negative-3';
            if (change > -5) return 'heat-negative-4';
            return 'heat-negative-5';
        }
        
        // Format value
        function formatValue(value, type) {
            if (value === null || value === undefined) return 'N/A';
            
            switch(type) {
                case 'spread':
                    return `${value.toFixed(0)} bps`;
                case 'yield':
                    return `${value.toFixed(2)}%`;
                case 'index':
                    return value.toFixed(2);
                default:
                    return value.toFixed(2);
            }
        }
        
        // Update overview table
        function updateOverviewTable() {
            const tbody = document.getElementById('overviewTable');
            tbody.innerHTML = '';
            
            Object.values(iceData).forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.symbol}</td>
                    <td>${data.name}</td>
                    <td>${formatValue(data.value, data.type)}</td>
                    <td class="${data.dailyChange >= 0 ? 'positive' : 'negative'}">
                        ${data.dailyChange >= 0 ? '+' : ''}${data.dailyChangePercent.toFixed(2)}%
                    </td>
                    <td>${data.date}</td>
                    <td>
                        <button class="heatmap-btn" onclick="showDetailChart(iceData['${data.symbol}'])">Chart</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update category tables
        function updateCategoryTables() {
            updateCategoryTable('highYieldTable', 'high-yield');
            updateCategoryTable('investmentGradeTable', 'investment-grade');
            updateCategoryTable('emergingMarketsTable', 'emerging-markets');
            updateCategoryTable('spreadsTable', 'spread');
            updateCategoryTable('yieldsTable', 'yield');
        }
        
        function updateCategoryTable(tableId, filter) {
            const tbody = document.getElementById(tableId);
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const filteredData = Object.values(iceData).filter(d => {
                if (filter === 'spread' || filter === 'yield') {
                    return d.type === filter;
                } else {
                    return d.category === filter;
                }
            });
            
            filteredData.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.symbol}</td>
                    <td>${data.name}</td>
                    <td>${formatValue(data.value, data.type)}</td>
                    <td class="${data.dailyChange >= 0 ? 'positive' : 'negative'}">
                        ${data.dailyChange >= 0 ? '+' : ''}${data.dailyChangePercent.toFixed(2)}%
                    </td>
                    <td class="${data.weeklyChange >= 0 ? 'positive' : 'negative'}">
                        ${data.weeklyChange >= 0 ? '+' : ''}${data.weeklyChangePercent.toFixed(2)}%
                    </td>
                    <td class="${data.monthlyChange >= 0 ? 'positive' : 'negative'}">
                        ${data.monthlyChange >= 0 ? '+' : ''}${data.monthlyChangePercent.toFixed(2)}%
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Update category heatmaps
        function updateCategoryHeatmaps() {
            updateCategoryHeatmap('highYieldHeatmap', 'high-yield');
            updateCategoryHeatmap('investmentGradeHeatmap', 'investment-grade');
            updateCategoryHeatmap('emergingMarketsHeatmap', 'emerging-markets');
            updateCategoryHeatmap('spreadsHeatmap', 'spread');
            updateCategoryHeatmap('yieldsHeatmap', 'yield');
        }
        
        function updateCategoryHeatmap(heatmapId, filter) {
            const container = document.getElementById(heatmapId);
            if (!container) return;
            
            container.innerHTML = '';
            
            const filteredData = Object.values(iceData).filter(d => {
                if (filter === 'spread' || filter === 'yield') {
                    return d.type === filter;
                } else {
                    return d.category === filter;
                }
            });
            
            filteredData.forEach(item => {
                const tile = createHeatmapTile(item);
                container.appendChild(tile);
            });
        }
        
        // Initialize charts
        function initializeCharts() {
            updateCharts();
        }
        
        // Update charts
        function updateCharts() {
            // Update Spreads Chart
            const spreadsData = Object.values(iceData)
                .filter(d => d.type === 'spread')
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);
            
            if (spreadsData.length > 0) {
                const trace = {
                    x: spreadsData.map(d => d.symbol),
                    y: spreadsData.map(d => d.value),
                    type: 'bar',
                    marker: {
                        color: spreadsData.map(d => d.dailyChange >= 0 ? '#00ff88' : '#ff4444')
                    },
                    text: spreadsData.map(d => d.name),
                    hovertemplate: '%{text}<br>Spread: %{y} bps<extra></extra>'
                };
                
                const layout = {
                    title: 'Top 10 Widest Spreads (OAS)',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#fff' },
                    xaxis: { 
                        gridcolor: 'rgba(255,255,255,0.1)',
                        tickangle: -45
                    },
                    yaxis: { 
                        gridcolor: 'rgba(255,255,255,0.1)',
                        title: 'Spread (bps)'
                    },
                    margin: { t: 50, r: 50, b: 100, l: 50 }
                };
                
                Plotly.newPlot('spreadsChart', [trace], layout, {responsive: true});
            }
            
            // Update Yields Chart
            const yieldsData = Object.values(iceData)
                .filter(d => d.type === 'yield')
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);
            
            if (yieldsData.length > 0) {
                const trace = {
                    x: yieldsData.map(d => d.symbol),
                    y: yieldsData.map(d => d.value),
                    type: 'bar',
                    marker: {
                        color: yieldsData.map(d => d.dailyChange >= 0 ? '#00ff88' : '#ff4444')
                    },
                    text: yieldsData.map(d => d.name),
                    hovertemplate: '%{text}<br>Yield: %{y}%<extra></extra>'
                };
                
                const layout = {
                    title: 'Top 10 Highest Yields',
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#fff' },
                    xaxis: { 
                        gridcolor: 'rgba(255,255,255,0.1)',
                        tickangle: -45
                    },
                    yaxis: { 
                        gridcolor: 'rgba(255,255,255,0.1)',
                        title: 'Yield (%)'
                    },
                    margin: { t: 50, r: 50, b: 100, l: 50 }
                };
                
                Plotly.newPlot('yieldsChart', [trace], layout, {responsive: true});
            }
        }
        
        // Show detail chart
        function showDetailChart(data) {
            if (!data.observations || data.observations.length === 0) return;
            
            const dates = data.observations.map(obs => obs.date).reverse();
            const values = data.observations.map(obs => parseFloat(obs.value)).reverse();
            
            const trace = {
                x: dates,
                y: values,
                type: 'scatter',
                mode: 'lines+markers',
                name: data.name,
                line: { color: '#00ff88', width: 2 },
                marker: { color: '#00ff88', size: 4 }
            };
            
            const layout = {
                title: `${data.name} (${data.symbol})`,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#fff' },
                xaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    title: 'Date'
                },
                yaxis: { 
                    gridcolor: 'rgba(255,255,255,0.1)',
                    title: formatValue(data.value, data.type).split(' ')[1] || 'Value'
                },
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };
            
            // Create modal or update existing chart
            const chartDiv = document.createElement('div');
            chartDiv.style.height = '400px';
            chartDiv.id = 'detailChart';
            
            Plotly.newPlot(chartDiv, [trace], layout, {responsive: true});
            
            // You could show this in a modal instead
            showAlert('info', `Chart for ${data.name} created. View in Charts tab.`);
        }
        
        // Update verification status
        function updateVerificationStatus() {
            document.getElementById('apiStatus').textContent = '✅ Connected';
            document.getElementById('apiStatus').className = 'verification-value positive';
            document.getElementById('successfullyLoaded').textContent = loadedCount;
            document.getElementById('failedToLoad').textContent = failedCount;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            
            // Sample verification
            const verificationTable = document.getElementById('verificationTable');
            verificationTable.innerHTML = '';
            
            // Show first 5 indices as verification samples
            Object.values(iceData).slice(0, 5).forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.symbol} - ${data.name}</td>
                    <td>${formatValue(data.value, data.type)}</td>
                    <td>${formatValue(data.value, data.type)}</td>
                    <td class="positive">✅ Match</td>
                `;
                verificationTable.appendChild(row);
            });
        }
        
        // Sort table
        function sortTable(column) {
            currentSort.column = column;
            currentSort.ascending = !currentSort.ascending;
            
            const sorted = Object.values(iceData).sort((a, b) => {
                let aVal, bVal;
                
                switch(column) {
                    case 'symbol':
                        aVal = a.symbol;
                        bVal = b.symbol;
                        break;
                    case 'name':
                        aVal = a.name;
                        bVal = b.name;
                        break;
                    case 'value':
                        aVal = a.value;
                        bVal = b.value;
                        break;
                    case 'change':
                        aVal = a.dailyChangePercent;
                        bVal = b.dailyChangePercent;
                        break;
                    case 'date':
                        aVal = new Date(a.date);
                        bVal = new Date(b.date);
                        break;
                    default:
                        return 0;
                }
                
                if (currentSort.ascending) {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // Rebuild the table with sorted data
            const tbody = document.getElementById('overviewTable');
            tbody.innerHTML = '';
            
            sorted.forEach(data => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${data.symbol}</td>
                    <td>${data.name}</td>
                    <td>${formatValue(data.value, data.type)}</td>
                    <td class="${data.dailyChange >= 0 ? 'positive' : 'negative'}">
                        ${data.dailyChange >= 0 ? '+' : ''}${data.dailyChangePercent.toFixed(2)}%
                    </td>
                    <td>${data.date}</td>
                    <td>
                        <button class="heatmap-btn" onclick="showDetailChart(iceData['${data.symbol}'])">Chart</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const tabId = e.target.dataset.tab;
                    const tabContent = document.getElementById(tabId);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', initialize);
        
        // Test API connection immediately
        console.log('Testing FRED API connection...');
        fetch(`${FRED_BASE_URL}/series/observations?series_id=BAMLH0A0HYM2&api_key=${FRED_API_KEY}&limit=1&file_type=json`)
            .then(response => response.json())
            .then(data => {
                if (data.observations) {
                    console.log('✅ FRED API connection successful!');
                    console.log('Sample data:', data.observations[0]);
                } else {
                    console.error('❌ FRED API returned unexpected format:', data);
                }
            })
            .catch(error => {
                console.error('❌ FRED API connection failed:', error);
            });
    </script>
</body>
</html>
